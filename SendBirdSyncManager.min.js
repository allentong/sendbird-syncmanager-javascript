!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.SendBirdSyncManager=t():e.SendBirdSyncManager=t()}(window,function(){return function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=12)}([function(e,t,n){"use strict";function s(e,t){const n=typeof e,r=typeof t;return!e||!t||"object"!==n||n!==r||e instanceof Date?e instanceof Date?e.getTime()===t.getTime():"function"===n&&"function"===r||e===t:Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>s(e[n],t[n]))}function r(e){return null!=e}function i(e,t,n=!1){if(r(e)){if(!r(t))return n?-1:1;if(typeof e==typeof t&&e!==t){const n=typeof e;if("boolean"===n)return e?1:-1;if("number"===n)return e>t?1:-1;if("string"===n)return e.localeCompare(t);if(e instanceof Date&&t instanceof Date&&e.getTime()!==t.getTime())return e.getTime()>t.getTime()?1:-1}}else if(r(t))return n?1:-1;return 0}function a(e,t,n){if(!t)return new Promise((t,s)=>{e((e,r)=>{n&&"function"==typeof n&&n(),e?s(e):t(r)})});e((e,s)=>{n&&"function"==typeof n&&n(),t(e,s)})}n.d(t,"b",function(){return s}),n.d(t,"a",function(){return i}),n.d(t,"c",function(){return a})},function(e,t,n){"use strict";n.d(t,"a",function(){return l});var s=n(4),r=n(3),i=n(7);let a=null;const o=new WeakMap,c=new WeakMap;class l{static get Query(){return r.a}static get Storage(){return a}static set Storage(e){a=e}constructor(e,t={}){this.name=e,this.config=new s.a(t),o.set(this,{}),c.set(this,{})}schema(e,t){return o.get(this)[e]=t,this}build(){const e=o.get(this),t=c.get(this);return new Promise((n,s)=>{const r=[];for(let n in e)if(!t[n]){const s=e[n].key||"_id",a=t[n]=new i.a(n,s);r.push(a.init())}Promise.all(r).then(()=>{const r=[];for(let n in t)if(e[n].index&&e[n].index.length>0){const s=t[n];for(let t in e[n].index)r.push(s.ensureIndex(e[n].index[t]))}r.length>0?Promise.all(r).then(()=>{n()}).catch(e=>s(e)):n()}).catch(e=>s(e))})}close(){}drop(){o.set(this,{}),_db.set(this,null),c.set(this,{}),a.clear()}collection(e){const t=c.get(this);return t[e]&&t[e]instanceof i.a?t[e]:null}}},function(e,t,n){"use strict";(function(e){function s({offset:t,condition:n,progress:s},r=((e,t)=>t(null,!0)),i=(()=>{})){let a=t;!function t(){n(a)?e(()=>{r(a,(e,n)=>{e?i(e):n?(a=s(a),t()):i(null)})}):i(null)}()}n.d(t,"a",function(){return s})}).call(this,n(8).setImmediate)},function(e,t,n){"use strict";var s=n(0);const r=1/0,i=(e,t)=>{let n=!0;if(e)for(let r in t){switch(r){case"/and":n=n&&t[r].reduce((t,n)=>t&&i(e,n),!0);break;case"/or":n=n&&t[r].reduce((t,n)=>t||i(e,n),!1);break;default:{const i=t[r];if("object"==typeof i)for(let t in i)switch(t){case">":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]>i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])>0);break;case">=":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]>=i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])>=0);break;case"<":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]<i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])<0);break;case"<=":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]<=i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])<=0);break;case"=":n=n&&e[r]===i[t];break;case"!=":n=n&&e[r]!==i[t];break;case"/in":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[r])>=0;break;case"/nin":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[r])<0;break;case"/like":n=n&&"string"==typeof i[t]&&"string"==typeof e[r]&&e[r].indexOf(i[t])>=0;break;case"/regex":n=n&&i[t]instanceof RegExp&&i[t].test(e[r]);break;case"/where":n=n&&i[t](e[r]);break;default:n=n&&Object(s.b)(e[r],i)}else n=n&&e[r]===i}}if(!n)break}else n=!1;return n};class a{static and(...e){return e.length>0?new a({"/and":e}):new a({})}static or(...e){return e.length>0?new a({"/or":e}):new a({})}static get Order(){return{ASC:1,DESC:-1}}constructor(e){this.condition=e,this.offset=0,this.limit=r,this.index=null,this.desc=!1}match(e){return i(e,this.condition)}}t.a=a},function(e,t,n){"use strict";n.d(t,"a",function(){return c});const s=64,r=200,i=128,a=32;let o=null;class c{constructor(e={}){return o||(o=this),this.batchSize=s,this.batchInterval=r,this.cachedBlockLimit=i,this.cachedBlockFlush=a,this.encryption={encrypt:(e,t)=>t(null,e),decrypt:(e,t)=>t(null,e)},"number"==typeof e.batchSize&&e.batchSize>1&&(this.batchSize=e.batchSize),"number"==typeof e.batchInterval&&e.batchInterval>10&&(this.batchInterval=e.batchInterval),"number"==typeof e.cachedBlockLimit&&e.cachedBlockLimit>0&&(this.cachedBlockLimit=e.cachedBlockLimit),"number"==typeof e.cachedBlockFlush&&e.cachedBlockFlush<this.cachedBlockLimit&&(this.cachedBlockFlush=e.cachedBlockFlush),e.encryption&&e.encryption.hasOwnProperty("encrypt")&&e.encryption.hasOwnProperty("decrypt")&&"function"==typeof e.encryption.encrypt&&"function"==typeof e.encryption.decrypt&&(this.encryption=e.encryption),o}static getInstance(){return o}}},function(e,t,n){"use strict";var s=n(1),r=n(4);class i{constructor(e){this.blockKey=e,this.data=[]}static createKey(e,t=0){return`${e.toLowerCase()}-blk-${t}`}get count(){return this.data.length}get(e){const t=this.indexOf(e);return t>=0?this.data[t].value:null}indexOf(e){for(let t in this.data)if(this.data[t].key===e)return parseInt(t);return-1}add(e,t){const n=this.indexOf(e);n<0?this.data.push({key:e,value:t}):this.data[n]={key:e,value:t}}remove(e){const t=this.indexOf(e);return t>=0&&(this.data.splice(t,1),!0)}static buildFromSerializedData(e,t){const n=new i(e);try{return n.data=JSON.parse(t),n}catch(e){return null}}getSerializedData(){return JSON.stringify(this.data)}}const a=1e4,o=200;class c{constructor(){this.locked=!1,this.lockedAt=0}lock(e){this.locked?setTimeout(()=>{(new Date).getTime()-this.lockedAt>a&&this.unlock(),this.lock(e)},o):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(()=>this.unlock()))}unlock(){this.locked=!1,this.lockedAt=0}}const l="adb-trns-";class h{constructor(e,t={}){const n=r.a.getInstance();this.name=e,this.initialized=!1,this.queue={},this.batchInterval=t.batchInterval||n.batchInterval,this.batchUpdateTimer=null,this.transactionMutex=new c,this.transactionState=h.State.IDLE,this.transactionCount=0,this.encryption=n.encryption,t.encryption&&t.encryption.hasOwnProperty("encrypt")&&t.encryption.hasOwnProperty("decrypt")&&"function"==typeof t.encryption.encrypt&&"function"==typeof t.encryption.decrypt&&(this.encryption=t.encryption)}static get Action(){return{SET:"set",REMOVE:"remove"}}static get State(){return{IDLE:"idle",RUNNING:"running"}}init(e=(()=>{})){this.initialized?e(null):(this.initialized=!0,0===Object.keys(this.queue).length?s.a.Storage.getItem(l+this.name,(t,n)=>{n?this.encryption.decrypt(n,(t,n)=>{t||(this.queue=JSON.parse(n)),e(t)}):e(null)}):e(null))}flush(){this.transactionMutex.lock(e=>{s.a.Storage.setItem(l+this.name,JSON.stringify(this.queue),t=>{if(t)throw e(),t;{const t=[];for(let e in this.queue){const n=this.queue[e];switch(n.action){case h.Action.SET:t.push(new Promise((t,r)=>{this.encryption.encrypt(JSON.stringify(n.data),(n,i)=>{n?r(n):s.a.Storage.setItem(e,i).then(t).catch(r)})}));break;case h.Action.REMOVE:t.push(s.a.Storage.removeItem(e))}}this.batchUpdateTimer=null,Promise.all(t).then(()=>{this.queue={},s.a.Storage.removeItem(l+this.name,()=>{e()})}).catch(t=>{throw e(),t})}})})}startTransaction(){this.transactionState=h.State.RUNNING,this.transactionCount++}endTransaction(){this.transactionState===h.State.RUNNING&&(this.transactionCount--,0===this.transactionCount&&(this.flush(),this.transactionState=h.State.IDLE))}addJob(e,t,n){this.queue[t]={action:e,data:n},this.transactionState===h.State.IDLE&&(this.batchUpdateTimer||(this.batchUpdateTimer=setTimeout(()=>{this.transactionState===h.State.IDLE&&this.flush(),this.batchUpdateTimer=null},this.batchInterval)))}}n.d(t,"a",function(){return d});const u="adb-info-";class d{constructor(e,t={}){const n=r.a.getInstance();this.cachedBlockLimit=t.cachedBlockLimit||n.cachedBlockLimit,this.cachedBlockFlush=t.cachedBlockFlush||n.cachedBlockFlush,this.cacheMutex=new c,this.encryption=n.encryption,t.encryption&&t.encryption.hasOwnProperty("encrypt")&&t.encryption.hasOwnProperty("decrypt")&&"function"==typeof t.encryption.encrypt&&"function"==typeof t.encryption.decrypt&&(this.encryption=t.encryption),this.batchSize=t.batchSize||n.batchSize,this.batchQueue=t.sharedBatchQueue||new h(e,t),this.transaction=null,this.name=e,this.info={},this.blockCache={},this.blockCacheCursor=0,this.currentBlock=null}_findBlockKey(e){return this.info.blockMap[e]}_getBlockFromCache(e){return this.blockCache[e]?this.blockCache[e].block:null}_putBlockToCache(e){this.blockCache[e.blockKey]={seq:this.blockCacheCursor++,block:e};const t=Object.keys(this.blockCache);if(t.length>=this.cachedBlockLimit){t.sort((e,t)=>this.blockCache[e].seq-this.blockCache[t].seq);for(let e in t)this._removeBlockFromCache(t[e])}}_removeBlockFromCache(e){this.blockCache.hasOwnProperty(e)&&delete this.blockCache[e]}_getBlock(e,t){const n=this._getBlockFromCache(e);n?t(null,n):s.a.Storage.getItem(e).then(n=>{n?this.encryption.decrypt(n,(n,s)=>{if(n)t(n);else{const n=i.buildFromSerializedData(e,s);this._putBlockToCache(n),t(null,n)}}):t(null)}).catch(e=>t(e))}_assignNewBlock(e){this.info.cursor++;const t=i.createKey(this.name,this.info.cursor),n=new i(t);this._putBlockToCache(n),this.currentBlock=n,e&&e.key&&(n.add(e.key,e.value),this.info.blockMap[e.key]=t,this.info.count++),this.batchQueue.addJob(h.Action.SET,n.blockKey,n.data),this.batchQueue.addJob(h.Action.SET,u+this.name,this.info)}init(e=(()=>{})){this.batchQueue.init(t=>{t?e(t):s.a.Storage.getItem(u+this.name,(t,n)=>{t?e(t):n?this.encryption.decrypt(n,(t,n)=>{if(t)e(t);else{this.info=JSON.parse(n);const t=i.createKey(this.name,this.info.cursor);this._getBlock(t,(n,s)=>{n||(this.currentBlock=s||new i(t)),e(n,this.info,!1)})}}):(this.info={blockMap:{},cursor:0,count:0},this.info.cursor=-1,this._assignNewBlock(),e(null,this.info,!0))})})}get keys(){return Object.keys(this.info.blockMap)}get count(){return this.info.count}startTransaction(){this.batchQueue.startTransaction()}endTransaction(){this.batchQueue.endTransaction()}getItem(e,t=(()=>{})){const n=this._findBlockKey(e);n?this._getBlock(n,(n,s)=>{!n&&s?t(null,s.get(e)):t(n||new Error("Broken integrity - data not found."))}):t(null,null)}setItem(e,t,n=(()=>{})){const s=this._findBlockKey(e);if(s)this._getBlock(s,(s,r)=>{!s&&r?(r.add(e,t),this.batchQueue.addJob(h.Action.SET,r.blockKey,r.data),n(null)):n(s||new Error("Broken integrity - data not found."))});else{const s=this.currentBlock;s&&s.count<this.batchSize?(s.add(e,t),this.batchQueue.addJob(h.Action.SET,s.blockKey,s.data),this.info.count++,this.info.blockMap[e]=s.blockKey,this.batchQueue.addJob(h.Action.SET,u+this.name,this.info)):this._assignNewBlock({key:e,value:t}),n(null)}}removeItem(e,t=(()=>{})){const n=this._findBlockKey(e);n?this._getBlock(n,(s,r)=>{if(s)t(s);else if(r){r.remove(e)&&(this.info.blockMap.hasOwnProperty(e)&&delete this.info.blockMap[e],this.info.count--),r.data.length>0?this.batchQueue.addJob(h.Action.SET,n,r.data):(this._removeBlockFromCache(n),this.batchQueue.addJob(h.Action.REMOVE,n)),this.batchQueue.addJob(h.Action.SET,u+this.name,this.info),t(null)}else t(new Error("Failed to remove item - data not found."))}):t(new Error("Failed to remove item - data not found."))}clear(e=(()=>{})){for(let e=0;e<=this.info.cursor;e++)this.batchQueue.addJob(h.Action.REMOVE,i.createKey(this.name,e));this.blockCacheCursor=0,this.blockCache={},this.info={blockMap:{},cursor:-1,count:0},this._assignNewBlock(),e(null)}drop(e=(()=>{})){this.clear(()=>{this.batchQueue.addJob(h.Action.REMOVE,u+this.name),e(null)})}}},function(e,t,n){"use strict";n.d(t,"a",function(){return o});var s=n(5),r=n(2),i=n(0);const a="idx-";class o{constructor({collection:e,columns:t={},options:n={}}){this.collection=e,this.columns=t,this.key=o.createKey(this.columns);for(let e in this.columns)this.columns[e]=1;this.store=new s.a(e.name+"-index-"+this.key,n),this.table=[]}static createKey(e){return Object.keys(e).map(t=>`${t}_${e[t]}`).join("__")}get columnNames(){return Object.keys(this.columns)}columnValues(e){return this.columnNames.map(t=>e?e[t]:null)}compareColumnValues(e,t,n=!0){const s=this.columnNames;for(let r=0;r<s.length;r++){const a=s[r],o=this.columns[a],c=Object(i.a)(e[r],t[r],n);if(0!==c)return o*c}return 0}init(e=(()=>{})){this.store.init((t,n,s)=>{t?e(t):s?this.save(e):this.store.getItem(`${a}${this.key}`,(t,n)=>{n&&(this.table=n),e(t)})})}each(e,t=null,n=1){const s=n>0;let i=s?0:this.table.length-1;if(t&&this.table.length>0){const e={start:0,end:this.table.length};let n=i;for(;e.start<e.end;){const r=this.compareColumnValues(this.table[n].key,t,s);if(0===r)break;r>0?e.end=n-1:e.start=n+1,n=parseInt((e.start+e.end)/2)}i=n}let a=!0;Object(r.a)({offset:i,condition:e=>s?e<this.table.length:e>=0,progress:e=>s?e+1:e-1},(t,n)=>{const i=this.table[t];if(i){const t=i.key,o=i.value;Object(r.a)({offset:s?0:o.length-1,condition:e=>s?e<o.length:e>=0,progress:e=>s?e+1:e-1},(n,s)=>{e({key:t,value:o[n]},(e,t)=>{s(e,a=e||t)})},e=>n(e,a))}else n(null,!1)},()=>{e(null,()=>{})})}put(e,t){let n=!1;const s=this.columnValues(t);Object(r.a)({offset:0,condition:e=>e<this.table.length,progress:e=>e+1},(t,r)=>{const i=this.table[t];if(i){const a=this.compareColumnValues(i.key,s);a>0?(this.table.splice(t,0,{key:s,value:[e]}),n=!0,this.save(e=>r(e,!1))):0===a?i.value.indexOf(e)<0?(i.value.push(e),n=!0,this.save(e=>r(e,!1))):r(null,!1):r(null,!0)}else r(null,!1)},()=>{n||(this.table.push({key:s,value:[e]}),this.save())})}update(e,t,n){const s=this.columnValues(t),r=this.columnValues(n);0!==this.compareColumnValues(s,r)&&(this.remove(e,t),this.put(e,n))}remove(e,t){const n=this.columnValues(t);Object(r.a)({offset:0,condition:e=>e<this.table.length,progress:e=>e+1},(t,s)=>{const r=this.table[t];if(r){if(0===this.compareColumnValues(r.key,n)){const n=r.value.indexOf(e);n>=0?(r.value.splice(n,1),0===r.value.length&&this.table.splice(t,1),this.save(e=>s(e,!1))):s(null,!1)}else s(null,!0)}else s(null,!1)},()=>{})}save(e=(()=>{})){this.store.setItem(`${a}${this.key}`,this.table,e)}clear(){this.table=[],this.store.clear()}drop(){this.table=[],this.store.drop()}}},function(e,t,n){"use strict";(function(e){var s=n(5),r=n(0),i=n(6),a=n(3),o=n(2);const c=new WeakMap,l=new WeakMap;t.a=class{constructor(e,t){this.name=e,this.pk=t,c.set(this,new s.a(e)),l.set(this,[])}init(e){const t=c.get(this);return Object(r.c)(e=>{t.init(t=>{e(t)})},e)}_findProperIndexer(e){if(e.index){const t=l.get(this);for(let n=0;n<t.length;n++)if(Object(r.b)(t[n].columns,e.index))return t[n]}return null}_addItemToIndex(e,t){const n=l.get(this);for(let s=0;s<n.length;s++)n[s].put(e,t)}_updateItemToIndex(e,t,n){const s=l.get(this);for(let r=0;r<s.length;r++)s[r].update(e,t,n)}_removeItemFromIndex(e,t){const n=l.get(this);for(let s=0;s<n.length;s++)n[s].remove(e,t)}ensureIndex(e,t){const n=c.get(this),s=l.get(this),a=i.a.createKey(e);return Object(r.c)(t=>{for(let e=0;e<s.length;e++)if(a===s[e].key)return void t(null);const r=new i.a({collection:this,columns:e,options:{sharedBatchQueue:n.batchQueue}});r.init((e,i,a)=>{if(e)t(e);else if(s.push(r),a){const e=n.keys;let s=0;for(let i=0;i<e.length;i++){const a=e[i];n.getItem(a,(n,i)=>{!n&&i?r.put(a,i,()=>{++s===e.length&&t(null)}):++s===e.length&&t(null)})}}else t(null)})},t)}removeIndex(e,t){const n=l.get(this),s=i.a.createKey(e);return Object(r.c)(e=>{for(let t=0;t<n.length;t++)if(s===n[t].key)return void n[t].drop(s=>{s||n.splice(t,1),e(s)});e(null)},t)}findById(e,t){const n=c.get(this);return Object(r.c)(t=>{e?n.getItem(e,(e,n)=>{t(e,n)}):t(new Error("Invalid type: 'id' should not be empty."))},t)}findOne(e,t){return e.limit=1,this.find(e,(e,n)=>{t(e,n.length>0?n[0]:null)})}find(t,n){const s=c.get(this);return Object(r.c)(n=>{if(t instanceof a.a){const r=[],i=this._findProperIndexer(t);if(i){const e=[];for(let n=0;n<i.columnNames.length;n++){const s=i.columnNames[n];if(!t.condition[s])break;if("object"==typeof t.condition[s]){const n=Object.keys(t.condition[s]),r=["="],i=n.filter(e=>r.includes(e));if(!(i.length>0))break;{const r=n.indexOf(i[0]);e.push(t.condition[s][n[r]])}}else{if("function"==typeof t.condition[s]||void 0===t.condition[s]||Array.isArray(t.condition[s]))break;e.push(t.condition[s])}}i.each((e,i)=>{e?s.getItem(e.value,(e,n)=>{e?i(e):(t.match(n)&&r.push(n),i(null,r.length<t.limit))}):n(null,r)},e.length>0?e:null,t.desc?a.a.Order.DESC:a.a.Order.ASC)}else{const i=!t.desc,a=s.keys;Object(o.a)({offset:t.offset<a.length?i?t.offset:a.length-t.offset-1:i?a.length:0,condition:e=>i?r.length<t.limit&&e<a.length:r.length<t.limit&&e>=0,progress:e=>i?e+1:e-1},(n,i)=>{s.getItem(a[n],(n,s)=>{n?i(n):(t.match(s)&&r.push(s),e(()=>i(null,!0)))})},e=>{n(e,r)})}}else n(new Error("Invalid type: 'query' should be Query type."))},n)}count(t,n){const s=c.get(this);return Object(r.c)(n=>{if(!t||t instanceof a.a)if(t){const r=s.keys;let i=0;Object(o.a)({offset:0,condition:e=>e<r.length,progress:e=>e+1},(n,a)=>{s.getItem(r[n],(n,s)=>{n?a(n):(t.match(s)&&i++,e(()=>a(null,!0)))})},e=>{n(e,i)})}else n(null,s.count);else n(new Error("Invalid type: 'query' should be Query type."))},n)}insert(e,t){const n=c.get(this);return n.startTransaction(),Object(r.c)(t=>{if(Array.isArray(e)){const n=[];for(let t=0;t<e.length;t++)e[t]&&"object"==typeof e[t]&&n.push(this.insert(e[t]));e.length===n.length?Promise.all(n).then(()=>t(null,e)).catch(e=>t(e)):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"==typeof e)if(e[this.pk]){const s=`${e[this.pk]}`;n.getItem(s,(r,i)=>{r?t(r):i?t(new Error("Duplicated item: item already exists.")):(this._addItemToIndex(s,e),n.setItem(s,e,n=>{t(n,e)}))})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},t,()=>n.endTransaction())}upsert(e,t){const n=c.get(this);return n.startTransaction(),Object(r.c)(t=>{if(Array.isArray(e)){const n=[];for(let t=0;t<e.length;t++)e[t]&&"object"==typeof e[t]&&n.push(this.upsert(e[t]));e.length===n.length?Promise.all(n).then(()=>t(null,e)).catch(e=>t(e)):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"==typeof e)if(e[this.pk]){const s=`${e[this.pk]}`;n.getItem(s,(r,i)=>{r?t(r):(i?this._updateItemToIndex(s,i,e):this._addItemToIndex(s,e),n.setItem(s,e,n=>{t(n,e)}))})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},t,()=>n.endTransaction())}update(e,t){const n=c.get(this);return n.startTransaction(),Object(r.c)(t=>{if(Array.isArray(e)){const n=[];for(let t=0;t<e.length;t++)e[t]&&"object"==typeof e[t]&&n.push(this.update(e[t]));e.length===n.length?Promise.all(n).then(()=>t(null,e)).catch(e=>t(e)):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"==typeof e)if(e[this.pk]){const s=`${e[this.pk]}`;n.getItem(s,(r,i)=>{r?t(r):i?(this._updateItemToIndex(s,i,e),n.setItem(s,e,n=>{t(n,e)})):t(null)})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},t,()=>n.endTransaction())}updateIf(t,n,s){const i=c.get(this);return i.startTransaction(),Object(r.c)(s=>{if(t instanceof a.a){const a=[],c=i.keys;Object(o.a)({offset:0,condition:e=>e<c.length,progress:e=>e+1},(s,o)=>{i.getItem(c[s],(s,c)=>{if(s)o(s);else if(c&&t.match(c)){const t=JSON.parse(JSON.stringify(c));let s=!1;for(let e in n){const t=n[e];Object(r.b)(c[e],t)||(s=!0,c[e]=t)}if(s){const n=`${c[this.pk]}`;this._updateItemToIndex(n,t,c),i.setItem(n,c,t=>{t?o(t):(a.push(c),e(()=>o(null,!0)))})}else e(()=>o(null,!0))}else e(()=>o(null,!0))})},e=>{s(e,a)})}else s(new Error("Invalid type: 'query' should be Query type."))},s,()=>i.endTransaction())}remove(e,t){const n=c.get(this);return n.startTransaction(),Object(r.c)(t=>{e?(e=`${e}`,n.getItem(e,(s,r)=>{s?t(s):r?(this._removeItemFromIndex(e,r),n.removeItem(e,e=>{t(e)})):t(null)})):t(new Error("Invalid type: 'id' should be string type."))},t,()=>n.endTransaction())}removeIf(t,n){const s=c.get(this);return s.startTransaction(),Object(r.c)(n=>{if(t instanceof a.a){const r=[],i=s.keys;Object(o.a)({offset:0,condition:e=>e<i.length,progress:e=>e+1},(n,a)=>{s.getItem(i[n],(n,i)=>{if(n)a(n);else if(i&&t.match(i)){const t=`${i[this.pk]}`;this._removeItemFromIndex(t,i),s.removeItem(t,t=>{t?a(t):(r.push(i),e(()=>a(null,!0)))})}else e(()=>a(null,!0))})},e=>{n(e,r)})}else n(new Error("Invalid type: 'query' should be Query type."))},n,()=>s.endTransaction())}clear(e){const t=l.get(this),n=c.get(this);return n.startTransaction(),Object(r.c)(e=>{for(let e=0;e<t.length;e++)t[e].clear();n.clear(t=>{e(t)})},e,()=>n.endTransaction())}}}).call(this,n(8).setImmediate)},function(e,t,n){(function(e){var s=void 0!==e&&e||"undefined"!=typeof self&&self||window,r=Function.prototype.apply;function i(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new i(r.call(setTimeout,s,arguments),clearTimeout)},t.setInterval=function(){return new i(r.call(setInterval,s,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},i.prototype.unref=i.prototype.ref=function(){},i.prototype.close=function(){this._clearFn.call(s,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},n(10),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(9))},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){(function(e,t){!function(e,n){"use strict";if(!e.setImmediate){var s,r,i,a,o,c=1,l={},h=!1,u=e.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(e);d=d&&d.setTimeout?d:e,"[object process]"==={}.toString.call(e.process)?s=function(e){t.nextTick(function(){m(e)})}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?e.MessageChannel?((i=new MessageChannel).port1.onmessage=function(e){m(e.data)},s=function(e){i.port2.postMessage(e)}):u&&"onreadystatechange"in u.createElement("script")?(r=u.documentElement,s=function(e){var t=u.createElement("script");t.onreadystatechange=function(){m(e),t.onreadystatechange=null,r.removeChild(t),t=null},r.appendChild(t)}):s=function(e){setTimeout(m,0,e)}:(a="setImmediate$"+Math.random()+"$",o=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(a)&&m(+t.data.slice(a.length))},e.addEventListener?e.addEventListener("message",o,!1):e.attachEvent("onmessage",o),s=function(t){e.postMessage(a+t,"*")}),d.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var r={callback:e,args:t};return l[c]=r,s(c),c++},d.clearImmediate=g}function g(e){delete l[e]}function m(e){if(h)setTimeout(m,0,e);else{var t=l[e];if(t){h=!0;try{!function(e){var t=e.callback,s=e.args;switch(s.length){case 0:t();break;case 1:t(s[0]);break;case 2:t(s[0],s[1]);break;case 3:t(s[0],s[1],s[2]);break;default:t.apply(n,s)}}(t)}finally{g(e),h=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(9),n(11))},function(e,t){var n,s,r=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function o(e){if(n===setTimeout)return setTimeout(e,0);if((n===i||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:i}catch(e){n=i}try{s="function"==typeof clearTimeout?clearTimeout:a}catch(e){s=a}}();var c,l=[],h=!1,u=-1;function d(){h&&c&&(h=!1,c.length?l=c.concat(l):u=-1,l.length&&g())}function g(){if(!h){var e=o(d);h=!0;for(var t=l.length;t;){for(c=l,l=[];++u<t;)c&&c[u].run();u=-1,t=l.length}c=null,h=!1,function(e){if(s===clearTimeout)return clearTimeout(e);if((s===a||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(e);try{s(e)}catch(t){try{return s.call(null,e)}catch(t){return s.call(this,e)}}}(e)}}function m(e,t){this.fun=e,this.array=t}function p(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new m(e,t)),1!==l.length||h||o(g)},m.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=p,r.addListener=p,r.once=p,r.off=p,r.removeListener=p,r.removeAllListeners=p,r.emit=p,r.prependListener=p,r.prependOnceListener=p,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,n){"use strict";n.r(t);var s=n(1);const r=(e,t)=>{const n=typeof e,s=typeof t;return!e||!t||"object"!==n||n!==s||e instanceof Date?e instanceof Date?e.getTime()===t.getTime():"function"===n&&"function"===s||e===t:Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>r(e[n],t[n]))},i=e=>{let t=null;return e&&(Array.isArray(e)?t=e.join("_"):"object"==typeof e?t=Object.keys(e).join("_"):"string"==typeof e&&(t=e)),t},a=(e,t,n)=>{if(!t)return new Promise((t,s)=>{e((e,r)=>{n&&"function"==typeof n&&n(),e?s(e):t(r)})});e(t)},o=new WeakMap;var c=class{constructor(e,t,n){this.name=t,this.keyPath=n,o.set(this,e)}findById(e,t){const n=o.get(this);return a(t=>{const s=n.transaction(this.name,"readonly").objectStore(this.name).get(e);s.onsuccess=(()=>t(null,s.result||null)),s.onerror=(()=>t(s.error))},t)}find(e,t){const n=o.get(this);return a(t=>{if(e instanceof y.Query){const s=i(e.index),r=[],a=n.transaction(this.name,"readonly").objectStore(this.name),o=s?a.index(s).openCursor(null,e.desc?"prev":"next"):a.openCursor();let c=e.offset;o.onsuccess=(n=>{const s=n.target.result;if(s)if(!c||c<0){const n=s.value;e.match(n)?(r.push(n),r.length<e.limit?s.continue():t(null,r)):s.continue()}else c--,s.continue();else t(null,r)}),o.onerror=(()=>{t(o.error)})}else t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},t)}count(e,t){const n=o.get(this);return a(t=>{if(!e||e instanceof y.Query){const s=n.transaction(this.name,"readonly").objectStore(this.name);if(e){let n=0;const r=s.openCursor();r.onsuccess=(()=>{const s=event.target.result;s?(e.match(s.value)&&n++,s.continue()):t(null,n)}),r.onerror=(()=>{t(r.error)})}else{const e=s.count();e.onsuccess=(()=>t(null,e.result)),e.onerror=(()=>t(e.error))}}else t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},t)}insert(e,t){const n=o.get(this);return a(t=>{const s=n.transaction(this.name,"readwrite").objectStore(this.name);if(Array.isArray(e)){const n=[];for(let r in e){const i=e[r],a=s.add(i);a.onsuccess=(()=>{n.push(i),n.length===e.length&&t(null,n)}),a.onerror=(()=>{t(a.error)})}}else if(e&&"object"==typeof e){const n=s.add(e);n.onsuccess=(()=>t(null,e)),n.onerror=(()=>t(n.error))}else t(new Error("Invalid type: 'item' should be an object or an object array."))},t)}upsert(e,t){const n=o.get(this);return a(t=>{const s=n.transaction(this.name,"readwrite").objectStore(this.name);if(e&&"object"==typeof e){const n=s.get(e[this.keyPath]);n.onsuccess=(()=>{if(n.result){const n=s.put(e);n.onsuccess=(()=>t(null,e)),n.onerror=(()=>t(n.error))}else{const n=s.add(e);n.onsuccess=(()=>t(null,e)),n.onerror=(()=>t(n.error))}}),n.onerror=(()=>{t(n.error)})}else t(new Error("Invalid type: 'item' should be an object or an object array."))},t)}update(e,t){const n=o.get(this);return a(t=>{const s=n.transaction(this.name,"readwrite").objectStore(this.name).put(e);s.onsuccess=(()=>t(null,e)),s.onerror=(()=>t(s.error))},t)}updateIf(e,t,n){const s=o.get(this);return a(n=>{if(e instanceof y.Query){const i=[],a=s.transaction(this.name,"readwrite").objectStore(this.name),o=a.openCursor();o.onsuccess=(s=>{const o=s.target.result;if(o){const s=o.value;if(e.match(s)){let e=!1;for(let n in t){const i=t[n];r(s[n],i)||(e=!0,s[n]=i)}if(e){const e=a.put(s);e.onsuccess=(()=>{i.push(s),o.continue()}),e.onerror=(()=>{n(e.error)})}else o.continue()}else o.continue()}else n(null,i)}),o.onerror=(()=>{n(o.error)})}else n(new Error("Invalid type: 'query' should be LocalDB.Query type."))},n)}remove(e,t){const n=o.get(this);return a(t=>{const s=n.transaction(this.name,"readwrite").objectStore(this.name).delete(e);s.onsuccess=(()=>t(null)),s.onerror=(()=>t(s.error))},t)}removeIf(e,t){const n=o.get(this);return a(t=>{if(e instanceof y.Query){const s=[],r=n.transaction(this.name,"readwrite").objectStore(this.name),i=r.openCursor();i.onsuccess=(n=>{const i=n.target.result;if(i){const n=i.value;if(e.match(n)){const e=r.delete(n[this.keyPath]);e.onsuccess=(()=>{s.push(n),i.continue()}),e.onerror=(()=>{t(e.error)})}else i.continue()}else t(null,s)}),i.onerror=(()=>{t(i.error)})}else t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},t)}clear(e){const t=o.get(this);return a(e=>{const n=t.transaction(this.name,"readwrite").objectStore(this.name).clear();n.onsuccess=(()=>e(null)),n.onerror=(()=>e(n.error))},e)}};const l=1/0,h=(e,t)=>{let n=!0;for(let s in t){switch(s){case"/and":n=n&&t[s].reduce((t,n)=>t&&h(e,n),!0);break;case"/or":n=n&&t[s].reduce((t,n)=>t||h(e,n),!1);break;default:{const i=t[s];if("object"==typeof i)for(let t in i)switch(t){case">":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]>i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])>0);break;case">=":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]>=i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])>=0);break;case"<":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]<i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])<0);break;case"<=":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]<=i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])<=0);break;case"=":n=n&&e[s]===i[t];break;case"!=":n=n&&e[s]!==i[t];break;case"/in":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[s])>=0;break;case"/nin":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[s])<0;break;case"/like":n=n&&"string"==typeof i[t]&&"string"==typeof e[s]&&e[s].indexOf(i[t])>=0;break;case"/regex":n=n&&i[t]instanceof RegExp&&i[t].test(e[s]);break;case"/where":n=n&&i[t](e[s]);break;default:n=n&&r(e[s],i)}else n=n&&e[s]===i}}if(!n)break}return n};class u{static and(...e){return e.length>0?new u({"/and":e}):new u({})}static or(...e){return e.length>0?new u({"/or":e}):new u({})}static get Order(){return{ASC:1,DESC:-1}}constructor(e){this.condition=e,this.offset=0,this.limit=l,this.index=null,this.desc=!1}match(e){return h(e,this.condition)}}var d=u;const g=new WeakMap,m=new WeakMap,p=new WeakMap,f=window?window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB:null;class y{static get Query(){return d}constructor(e,t){if(!f)throw new Error("IndexedDB is not supported in this environment. Check if you're in web browser which supports IndexedDB.");this.name=e,this.version=t,g.set(this,{}),m.set(this,null),p.set(this,{})}schema(e,t={}){return g.get(this)[e]=t,this}build(){const e=g.get(this),t=p.get(this);return new Promise((n,s)=>{const r=f.open(this.name,this.version);r.onerror=(e=>{s(new Error(`IndexedDB is not available: ${e.target.errorCode}`))}),r.onupgradeneeded=(n=>{const s=n.target.result,r=n.target.transaction,a=r.objectStoreNames;for(let n in e){const a=e[n].key||"id";let o=null;try{o=r.objectStore(n)}catch(e){"NotFoundError"===e.name&&(o=s.createObjectStore(n,{keyPath:a}))}if(o){const r=o.indexNames,l=new c(s,n,a);if(e[n].index&&e[n].index.length>0)for(let t in e[n].index){const s=i(e[n].index[t]);if(s){let i=!1;for(let e in r)if(r[e]===s){i=!0;break}i||o.createIndex(s,Object.keys(e[n].index[t]),{unique:!1})}}const h=[];if(e[n].index)for(let t in e[n].index){const s=i(e[n].index[t]);s&&h.push(s)}for(let e=0;e<r.length;e++)h.indexOf(r[e])<0&&o.deleteIndex(r[e]);t[n]=l}}for(let t=0;t<a.length;t++)Object.keys(e).indexOf(a.item(t))<0&&s.deleteObjectStore(a.item(t));m.set(this,s)}),r.onsuccess=(s=>{const r=s.target.result;for(let n in e)if(!t[n]){const s=e[n].key||"id";t[n]=new c(r,n,s)}m.set(this,r),n()})})}close(){const e=m.get(this);e&&(e.close(),m.set(this,null))}drop(){f.deleteDatabase(this.name)}collection(e){const t=p.get(this);return t[e]&&t[e]instanceof c?t[e]:null}}let b=null,I=!1;class C{static init(){b||(b=window?window.localStorage:null)}static useReactNative(e){b=e,I=!0}static getKeys(){return I?b.getAllKeys():new Promise(e=>{const t=[];for(let e in b)t.push(e);e(t)})}static get(e){return I?b.getItem(e):new Promise(t=>{const n=b.getItem(e);t(void 0!==n?n:null)})}static set(e,t){return I?b.setItem(e,t):new Promise(n=>{b.setItem(e,t),n()})}static remove(e){return I?b.removeItem(e):new Promise(t=>{b.removeItem(e),t()})}static clear(){return I?b.clear():new Promise(e=>{b.clear(),e()})}}const w=!1,k=[];class v{static put(e,...t){w&&(0===k.length||k.indexOf(e)>=0)&&console.log(`[${e}]`,...t)}static call(...e){v.put("CALL",...e)}static cache(...e){v.put("CACHE",...e)}static sync(...e){v.put("SYNC",...e)}static event(...e){v.put("EVENT",...e)}static view(...e){v.put("VIEW",...e)}static warning(...e){v.put("WARNING",...e)}static error(...e){v.put("ERROR",...e)}static message(...e){v.put("MESSAGE",...e)}}class E extends Error{constructor(e,t){super(e),this.name="SyncManagerException",this.code=t||0}static create(e=E.Type.ERROR_UNKNOWN){return new E(e.message,e.code)}static get Type(){return{ERROR_UNKNOWN:{code:81e4,message:"Unknown error occurred."},ERROR_DATABASE_IO:{code:810001,message:"Database I/O operation failed."},ERROR_SETUP_MISSING:{code:810100,message:"SendBirdSyncManager.setup() is not called."},ERROR_SENDBIRD_MISSING:{code:810101,message:"SendBird instance should be set before init()."},ERROR_DUPLICATED_FETCH:{code:810200,message:"Fetch is in progress."},ERROR_DUPLICATED_CHANGELOG_SYNC:{code:810210,message:"Sync is in progress."},ERROR_INVALID_PARAMETER:{code:810300,message:"Invalid parameter."}}}static throw(e){if(v.error(e),e instanceof E)throw e}}const A=function(e,t){const n=e.collection("GroupChannel"),s=(e,t)=>{const s=Ge.getInstance();s.currentUserId?(e.ownerUserId=s.currentUserId,e.lastMessageUpdatedAt=e.lastMessage?e.lastMessage.createdAt:e.createdAt,v.cache("upsert channel","url="+e.url,"name="+e.name,"createdAt="+e.createdAt,"lastMessageUpdatedAt="+e.lastMessageUpdatedAt),n.upsert(e.serialize(),t)):t(E.create(E.Type.ERROR_SETUP_MISSING))},r=e=>{if(e){const n=t.GroupChannel.buildFromSerializedData(e);return n.lastMessageUpdatedAt=n.lastMessage?n.lastMessage.createdAt:n.createdAt,n}return null};return this.query=((e,t,s)=>{const i=Ge.getInstance();if(i.currentUserId){e.ownerUserId=i.currentUserId;const a=new Ge.LocalDB.Query(e);t&&(a.offset=t.offset||0,a.limit=t.limit||20,a.index=t.index,a.desc=t.desc),n.find(a,(e,t)=>{if(e)s(e);else{const e=[];for(let n=0;n<t.length;n++){const s=r(t[n]);e.push(s)}s(null,e)}})}else s(E.create(E.Type.ERROR_SETUP_MISSING))}),this.insert=((e,t)=>{this.getItem(e.url,(n,r)=>{n?t(n):r?t(null,e):s(e,n=>{n?t(n):t(null,e)})})}),this.upsert=((e,t)=>{s(e,(e,n)=>{e?t(e):t(null,r(n))})}),this.remove=((t,s)=>{((t,s)=>{const r=Ge.getInstance();r.currentUserId?(v.cache("remove channel",t.url),n.remove(t.url,(n,i)=>{if(n)s(n);else{const n=new Ge.LocalDB.Query({ownerUserId:r.currentUserId,channelUrl:t.url});e.collection("MessageChunk").removeIf(n,t=>{t?s(t):e.collection("Message").removeIf(n,e=>{e?s(e):s(null,i)})})}})):s(E.create(E.Type.ERROR_SETUP_MISSING))})(t,(e,t)=>{e?s(e):s(null,r(t))})}),this.getItem=((e,t)=>{n.findById(e,(e,n)=>{e?t(e):t(null,r(n))})}),this.clear=(t=>(t=>{v.cache("clear channel"),n.clear(n=>{n?t(n):e.collection("MessageChunk").clear(n=>{n?t(n):e.collection("Message").clear(t)})})})(t)),this};let T={};const S=function(e,t){const n=e.collection("GroupChannelListQuery"),s=(e,t)=>{e.filterKey=this.createFilterKey(e);const s=Ge.getInstance();if(s.currentUserId){v.cache("upsert channel list query",e.filterKey),e.ownerUserId=s.currentUserId,e.updatedAt=(new Date).getTime(),e.savepoint||(e.savepoint="");const i=e.serialize();n.upsert(i,(n,s)=>{if(n)t(n);else{if(T[e.filterKey])for(let t in e)T[e.filterKey].hasOwnProperty(t)&&(T[e.filterKey][t]=e[t]);else T[e.filterKey]=e;t(null,r(s))}})}else t(E.create(E.Type.ERROR_SETUP_MISSING))},r=e=>{if(e){const n=t.GroupChannelListQuery.buildFromSerializedData(e);return n.filterKey=e.filterKey,n.ownerUserId=e.currentUserId,n.updatedAt=e.updatedAt,n.savepoint=e.savepoint,n}return null};return this.createFilterKey=(e=>{const t=[];return t.push(`order=${e.order}`),t.push(`includeEmpty=${e.includeEmpty}`),t.push(`customTypesFilter=${e.customTypesFilter.sort().join(",")}`),t.join("&")}),this.upsert=((e,t)=>{s(e,(e,n)=>{e?t(e):t(null,r(n))})}),this.remove=((e,t)=>{((e,t)=>{Ge.getInstance().currentUserId?(v.cache("remove channel list query",e.filterKey),n.remove(e.filterKey,(n,s)=>{n?t(n):(T[e.filterKey]&&delete T[e.filterKey],t(null,s))})):t(E.create(E.Type.ERROR_SETUP_MISSING))})(e,(e,n)=>{e?t(e):t(null,r(n))})}),this.getItem=((e,t)=>{T[e]?t(null,T[e]):n.findById(e,(e,n)=>{e?t(e):t(null,r(n))})}),this.clear=(e=>(e=>{v.cache("clear channel list query"),T={},n.clear(t=>e(t))})(e)),this};function O(e,t){const n=N.getInstance().sb;let s=!0;if(e.isGroupChannel()&&!e.isSuper){if(!t.includeEmpty&&!e.lastMessage)return!1;if(t.nicknameContainsFilter){let n=!1;for(let s in e.members)if(e.members[s].nickname.indexOf(t.nicknameContainsFilter)>=0){n=!0;break}if(!n)return!1}if(t.userIdsFilter.length>0){let n=!1;const s=e.members.map(e=>e.userId),r=t.userIdsFilterExactMatch,i=t.queryType;if(r?n=s.length===t.userIdsFilter.length&&t.userIdsFilter.every(e=>s.indexOf(e)>=0):"AND"===i?n=t.userIdsFilter.every(e=>s.indexOf(e)>=0):"OR"===i&&(n=t.userIdsFilter.reduce((e,t)=>e=e||s.indexOf(t)>=0,!1)),!n)return!1}}if(t.channelNameContainsFilter&&(s=s&&e.name.indexOf(t.channelNameContainsFilter)>=0),t.channelUrlsFilter.length>0&&(s=s&&t.channelUrlsFilter.indexOf(e.url)>=0),t.memberStateFilter!==n.GroupChannel.memberStateFilter.ALL)switch(t.memberStateFilter){case n.GroupChannel.memberStateFilter.JOINED:s=s&&e.myMemberState===n.GroupChannel.memberStateFilter.JOINED;break;case n.GroupChannel.memberStateFilter.INVITED:case n.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case n.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:s=s&&e.myMemberState===n.GroupChannel.memberStateFilter.INVITED}if(t.customTypesFilter.length>0&&(s=s&&t.customTypesFilter.indexOf(e.customType)>=0),t.customTypeStartsWithFilter&&(s=s&&e.customType.startsWith(t.customTypeStartsWithFilter)),t.superChannelFilter!==n.GroupChannel.superChannelFilter.ALL)switch(t.superChannelFilter){case n.GroupChannel.superChannelFilter.SUPER:s=s&&e.isSuper;break;case n.GroupChannel.superChannelFilter.NONSUPER:s=s&&!e.isSuper}if(t.publicChannelFilter!==n.GroupChannel.publicChannelFilter.ALL)switch(t.publicChannelFilter){case n.GroupChannel.publicChannelFilter.PUBLIC:s=s&&e.isPublic;break;case n.GroupChannel.publicChannelFilter.PRIVATE:s=s&&!e.isPublic}if(t.unreadChannelFilter!=n.GroupChannel.UnreadChannelFilter.ALL)switch(t.unreadChannelFilter){case n.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:s=s&&e.unreadMessageCount>0}return s}const M=function(){let e=[];return this.addCollection=((t,n)=>{e.indexOf(t)<0&&e.push({controller:t,view:n})}),this.removeCollection=(t=>{const n=e.map(e=>e.controller).indexOf(t);n>=0&&(e[n].controller._pause(),e.splice(n,1))}),this.clearCollection=(()=>{for(let t in e)e[t].controller._pause();e=[]}),this.pause=(()=>{for(let t in e)e[t].controller._pause()}),this.resume=(()=>{for(let t in e)e[t].controller._resume()}),this.upsert=((t,n,s={})=>{for(let r in e){const i=e[r];if(i.controller!==n){const e=[];for(let n in t){const s=t[n];O(s,i.controller.query)&&e.push(s)}e.length>0&&(s.isEventChannel=!0,i.view.addViewItems(e,s))}}}),this.update=((t,n,s={})=>{for(let r in e){const i=e[r];if(i.controller!==n){const e=[];for(let n in t){const s=t[n];O(s,i.controller.query)&&i.view.channels.map(e=>e.url).indexOf(s.url)>=0&&e.push(s)}e.length>0&&(s.isEventChannel=!0,i.view.addViewItems(e,s))}}}),this.remove=((t,n)=>{for(let s in e){const r=e[s];if(r.controller!==n){const e=[];for(let n in t){const s=t[n];r.view.channels.map(e=>e.url).indexOf(s.url)>=0&&e.push(s)}e.length>0&&r.view.removeViewItems(e)}}}),this.hide=((t,n,s={})=>{const r=N.getInstance().sb;for(let i in e){const a=e[i];if(a.controller!==n){const e=[];for(let n in t){const s=t[n];O(s,a.controller.query)&&e.push(s)}if(e.length>0)switch(a.controller.query.hiddenChannelFilter){case r.GroupChannel.HiddenChannelFilter.UNHIDDEN:a.view.removeViewItems(e);break;case r.GroupChannel.HiddenChannelFilter.HIDDEN:case r.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case r.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:s.isEventChannel=!0,a.view.addViewItems(e,s)}}}}),this.unhide=((t,n,s={})=>{const r=N.getInstance().sb;for(let i in e){const a=e[i];if(a.controller!==n){const e=[];for(let n in t){const s=t[n];O(s,a.controller.query)&&e.push(s)}if(e.length>0)switch(a.controller.query.hiddenChannelFilter){case r.GroupChannel.HiddenChannelFilter.UNHIDDEN:s.isEventChannel=!0,a.view.addViewItems(e,s);break;case r.GroupChannel.HiddenChannelFilter.HIDDEN:case r.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case r.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:a.view.removeViewItems(e)}}}}),this.clear=(()=>{for(let t in e){e[t].view.clearViewItem()}}),this},U="channel-changeLog-token",D="syncManager_channelManager_channelHandler_"+(new Date).getTime(),x=100;let _=null;class N{constructor({sendBird:e,db:t}){if(!_){v.call("ChannelManager()"),_=this;const n=this.sb=e,s=Ge.getInstance();this.channelContainer=new A(t,n),this.queryContainer=new S(t,n),this.broadcast=new M,this.isFetchingChangeLog=!1,this.channelSyncByFilter={},this.changeLogSync=null;const r=new n.ChannelHandler;Object.keys(r).forEach(e=>{r[e]=((...t)=>{switch(e){case"onChannelChanged":{const s=t[0];v.event(e,s.url),_.channelContainer.getItem(s.url,(e,t)=>{e?E.throw(e):_.channelContainer.upsert(s,(e,r)=>{e?E.throw(e):t?t.hiddenState!==n.GroupChannel.HiddenState.UNHIDDEN&&s.hiddenState===n.GroupChannel.HiddenState.UNHIDDEN?_.broadcast.unhide([r]):_.broadcast.update([r]):_.broadcast.upsert([r])})});break}case"onUserMuted":case"onUserUnmuted":case"onUserUnbanned":case"onChannelFrozen":case"onChannelUnfrozen":case"onMetaDataCreated":case"onMetaDataUpdated":case"onMetaDataDeleted":case"onMetaCountersCreated":case"onMetaCountersUpdated":case"onMetaCountersDeleted":v.event(e,t[0].url),_.channelContainer.upsert(t[0],(e,t)=>{e?E.throw(e):_.broadcast.update([t])});break;case"onUserReceivedInvitation":case"onUserJoined":v.event(e,t[0].url),_.channelContainer.upsert(t[0],(e,n)=>{if(e)E.throw(e);else{t[1].userId===s.currentUserId?_.broadcast.upsert([n]):_.broadcast.update([n])}});break;case"onReadReceiptUpdated":_.channelContainer.upsert(t[0],e=>{e&&E.throw(e)});break;case"onMessageReceived":t[0].lastMessage&&t[0].lastMessage.messageId!==t[1].messageId||_.channelContainer.upsert(t[0],(e,t)=>{e?E.throw(e):_.broadcast.upsert([t])});break;case"onChannelHidden":{v.event(e,t[0].url);const n=t[0];_.channelContainer.upsert(n,e=>{e?E.throw(e):_.broadcast.hide([n])});break}case"onUserLeft":case"onUserBanned":{v.event(e,t[0].url);const n=t[0];t[1].userId===s.currentUserId?_.channelContainer.remove(n,e=>{e?E.throw(e):_.broadcast.remove([n])}):_.channelContainer.upsert(n,(e,t)=>{e?E.throw(e):_.broadcast.update([t])});break}case"onUserDeclinedInvitation":{v.event(e,t[0].url);const n=t[0];t[2].userId===s.currentUserId?_.channelContainer.remove(n,e=>{e?E.throw(e):_.broadcast.remove([n])}):_.channelContainer.upsert(n,(e,t)=>{e?E.throw(e):_.broadcast.update([t])});break}case"onChannelDeleted":v.event(e,t[0]),_.channelContainer.getItem(t[0],(e,t)=>{e?E.throw(e):t&&_.channelContainer.remove(t,e=>{e?E.throw(e):_.broadcast.remove([t])})})}})}),n.addChannelHandler(D,r)}return _}static getInstance(){return _}static clear(){_&&_.sb&&(v.message("ChannelManager is cleared"),_.channelSyncByFilter={},_.changeLogSync=null,_.broadcast.clearCollection(),_.sb.removeChannelHandler(D),_=null)}syncChangeLog(e,t){if(this.isFetchingChangeLog)t(E.create(E.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLog=!0,v.call("channel syncChangeLog()");const n=`${U}`;C.get(n).then(s=>{let r="getMyGroupChannelChangeLogsByToken";const i=[];i.push([]),i.push(!0),s?(r="getMyGroupChannelChangeLogsByToken",i.unshift(s)):(r="getMyGroupChannelChangeLogsByTimestamp",i.unshift((new Date).getTime()-x)),v.call(r),this.sb[r](...i,(s,r)=>{if(this.sb.getErrorFirstCallback()){const e=s;s=r,r=e}if(r)this.isFetchingChangeLog=!1;else{v.sync("updated",s.updatedChannels&&s.updatedChannels.length>0?"\n"+s.updatedChannels.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"):[]),v.sync("deleted",s.deletedChannelUrls);const r=[];s.updatedChannels.forEach(e=>{r.push(new Promise((t,n)=>{_.channelContainer.getItem(e.url,(s,r)=>{s?n(s):_.channelContainer.upsert(e,(e,s)=>{if(e)n(e);else{const e=!r||!r.isEqual(s),n=(!r||r.hiddenState===this.sb.GroupChannel.HiddenState.UNHIDDEN)&&s.hiddenState!==this.sb.GroupChannel.HiddenState.UNHIDDEN,i=(!r||r.hiddenState!==this.sb.GroupChannel.HiddenState.UNHIDDEN)&&s.hiddenState===this.sb.GroupChannel.HiddenState.UNHIDDEN;let a=e?"update":"noop";n?a="hide":i&&(a="unhide"),t({action:a,channel:s})}})})}))}),s.deletedChannelUrls.forEach(e=>{r.push(new Promise((t,n)=>{_.channelContainer.getItem(e,(e,s)=>{e?n(e):s&&_.channelContainer.remove(s,e=>{if(e)n(e);else{t({action:"remove",channel:s})}})})}))}),Promise.all(r).then(r=>{const i=[],a=[],o=[],c=[];for(let e=0;e<r.length;e++)switch(r[e].action){case"update":i.push(r[e].channel);break;case"remove":a.push(r[e].channel);break;case"hide":o.push(r[e].channel);break;case"unhide":c.push(r[e].channel)}i.length>0&&_.broadcast.upsert(i,null,{isChangeLogChannel:!0}),a.length>0&&_.broadcast.remove(a),o.length>0&&_.broadcast.hide(o,null,{isChangeLogChannel:!0}),c.length>0&&_.broadcast.unhide(c,null,{isChangeLogChannel:!0}),C.set(n,s.token).then(()=>{s.hasMore?this.syncChangeLog(e,t):(this.isFetchingChangeLog=!1,t())}).catch(e=>{this.isFetchingChangeLog=!1,t(e)})}).catch(e=>t(e))}})}).catch(e=>{this.isFetchingChangeLog=!1,t(e)})}}start(){_.broadcast.resume()}stop(){_.broadcast.pause()}clearCache(e){_.channelSyncByFilter={},_.changeLogSync=null,_.channelContainer.clear(()=>{_.queryContainer.clear(()=>{C.getKeys().then(t=>{const n=[];t.forEach(e=>{e.startsWith(U)&&n.push(C.remove(e))}),Promise.all(n).then(()=>e()).catch(t=>{v.error(t),e(t)})}).catch(t=>e(t))})})}reset(e){_?(_.broadcast.clear(),_.clearCache(e)):e(null)}}const R=function(e,t){const n=e.collection("Message"),s=(e,t)=>{const s=Ge.getInstance();e.messageId?s.currentUserId?(e.hasOwnProperty("isVisible")||(e.isVisible=!0),e.hasOwnProperty("isDeleted")||(e.isDeleted=!1),e.ownerUserId=s.currentUserId,v.cache("upsert message",e.messageId,e.createdAt,"owner="+e.ownerUserId,"visible="+e.isVisible,"deleted="+e.isDeleted),n.findById(e.messageId,(s,r)=>{s?t(s):r?r.isDeleted?resolve(r):(e.isVisible=e.isVisible||r.isVisible,n.upsert(e.serialize(),(e,n)=>{e?t(e):t(null,n)})):n.upsert(e.serialize(),(e,n)=>{e?t(e):t(null,n)})})):t(E.create(E.Type.ERROR_SETUP_MISSING)):t(null,e)},r=e=>{let n=null;return e&&("user"===e.messageType?n=t.UserMessage.buildFromSerializedData(e):"file"===e.messageType?n=t.FileMessage.buildFromSerializedData(e):"admin"===e.messageType&&(n=t.AdminMessage.buildFromSerializedData(e))),n};return this.query=((e,t,s)=>{e.isVisible=!0,e.isDeleted=!1;const i=Ge.getInstance();if(i.currentUserId){e.ownerUserId=i.currentUserId;const a=new Ge.LocalDB.Query(e);t&&(a.offset=t.offset||0,a.limit=t.limit||50,a.desc=t.desc),a.index={ownerUserId:Ge.LocalDB.Query.Order.ASC,channelUrl:Ge.LocalDB.Query.Order.ASC,createdAt:Ge.LocalDB.Query.Order.DESC},n.find(a,(e,t)=>{if(e)s(e);else{const e=[];for(let n=0;n<t.length;n++){const s=r(t[n]);e.push(s)}s(null,e)}})}else s(E.create(E.Type.ERROR_SETUP_MISSING))}),this.upsert=((e,t)=>{s(e,(e,n)=>{e?t(e):t(null,r(n))})}),this.remove=((e,t)=>{this.getItem(e,(n,r)=>{const i=Ge.getInstance().sendBird,a={serialize:()=>({messageId:e,ownerUserId:r?r.ownerUserId:i.currentUser.userId,channelUrl:r?r.channelUrl:"",createdAt:r?r.createdAt:0,isVisible:!1,isDeleted:!0})};s(a,n=>{n?t(n):t(null,e)})})}),this.getItemWithVisibility=((e,t)=>{n.findById(e,(e,n)=>{e?t(e):t(null,{item:r(n),isVisible:!!n&&n.isVisible})})}),this.getItem=((e,t)=>{n.findById(e,(e,n)=>{e?t(e):t(null,r(n))})}),this.clear=(e=>(e=>{v.cache("clear messages"),n.clear(t=>e(t))})(e)),this.loadPreviousMessages=((e,t={},n=(new Date).getTime(),s={},r)=>{const i={channelUrl:e,createdAt:{"<=":n}};t.messageType&&(i.messageType=t.messageType),t.customType&&(i.customType=t.customType),t.senderUserIds&&t.senderUserIds.length>0&&(i["sender.userId"]={"/in":t.senderUserIds}),s.desc=!0,this.query(i,s,r)}),this.loadNextMessages=((e,t={},n=0,s={},r)=>{const i={channelUrl:e,createdAt:{">=":n}};t.messageType&&(i.messageType=t.messageType),t.customType&&(i.customType=t.customType),t.senderUserIds&&t.senderUserIds.length>0&&(i["sender.userId"]={"/in":t.senderUserIds}),s.desc=!1,this.query(i,s,r)}),this};function F(e,t=[]){return t.map(e=>e.url).indexOf(e.url)}function L(e,t,n=[]){let s=null,r=(e,t)=>e>t;switch(t.order){case"latest_last_message":s="lastMessageUpdatedAt";break;case"chronological":s="createdAt";break;case"channel_name_alphabetical":s="name",r=((e,t)=>e.localeCompare(t)<0);break;default:s="lastMessageUpdatedAt"}let i=n.length;for(let t=0;t<n.length;t++){const a=n[t];if(e[s]===a[s]&&e.url===a.url){i=t;break}if(r(e[s],a[s])){i=t;break}}return i}function B(e,t=[]){for(let n=0;n<t.length;n++)if(e.isIdentical(t[n]))return n;return-1}function P(e,t=[]){let n=t.length;for(let s=0;s<t.length;s++)if(t[s].createdAt>=e.createdAt){n=s;break}return n}const j=(e,t)=>{const n=typeof e,s=typeof t;return!e||!t||"object"!==n||n!==s||e instanceof Date?e instanceof Date?e.getTime()===t.getTime():"function"===n&&"function"===s||e===t:Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>j(e[n],t[n]))},q=()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})},V=(e,t)=>{if(!t)return new Promise((t,n)=>{e(e=>e?n(e):t())});e(t)};let G={};const H=function(e){const t=[];for(let n in e)t.push(`${n}=${e[n]}`);return t.join("&")};class Q{constructor(e,t){this.chunkId=q(),this.channelUrl=e,this.filterKey=H(t),this.filter=t,this.startAt=(new Date).getTime(),this.endAt=0}static createFromJson(e){const t=new Q(e.channelUrl,e.filter);return t.chunkId=e.chunkId,t.startAt=e.startAt,t.endAt=e.endAt,t}static getDefaultFilter(){return{messageTypeFilter:null,customTypeFilter:null,senderUserIdsFilter:[],includeMetaArray:!1}}hasDefaultFilter(){const e=Q.getDefaultFilter();return j(this.filter,e)}isOverlap(e){return e.startAt<=this.startAt&&this.startAt<=e.endAt||e.startAt<=this.endAt&&this.endAt<=e.endAt}isSame(e){return e.startAt===this.startAt&&this.endAt===e.endAt}contains(e){return this.startAt<=e&&e<=this.endAt}containsMessage(e){return this.contains(e.createdAt)}serialize(){const e=JSON.parse(JSON.stringify(this));return Object.freeze(e)}extendForward(e){this.endAt=Math.max(this.endAt,e)}extendBackward(e){this.startAt=Math.min(this.startAt,e)}extendWithChunk(e){return this.extendForwardWithChunk(e),this.extendBackwardWithChunk(e),this}extendForwardWithChunk(e){return this.extendForward(e.endAt),this}extendBackwardWithChunk(e){return this.extendBackward(e.startAt),this}extendWithMessage(e){return this.extendForwardWithMessage(e),this.extendBackwardWithMessage(e),this}extendForwardWithMessage(e){return this.extendForward(e.createdAt),this}extendBackwardWithMessage(e){return this.extendBackward(e.createdAt),this}}const W=function(e){const t=e.collection("MessageChunk");return this.reload=((e,n)=>t.findById(e.chunkId,n)),this.upsert=((e,n)=>{((e,n)=>{const s=Ge.getInstance();s.currentUserId?(e.ownerUserId=s.currentUserId,G[e.chunkId]=e,t.upsert(G[e.chunkId].serialize(),(e,t)=>{e?n(e):n(null,t)})):n(E.create(E.Type.ERROR_SETUP_MISSING))})(e,(e,t)=>{e?n(e):n(null,Q.createFromJson(t))})}),this.remove=((e,n)=>{((e,n)=>{Ge.getInstance().currentUserId?(G[e]&&delete G[e],t.remove(e,(e,t)=>{e?n(e):n(null,t)})):n(E.create(E.Type.ERROR_SETUP_MISSING))})(e,t=>{t?n(t):n(null,e)})}),this.clear=(e=>(e=>{G={},t.clear(t=>e(t))})(e)),this.getChunkByTimestamp=((e,n,s,r)=>{const i=Ge.getInstance();if(i.currentUserId){const a=new Ge.LocalDB.Query({ownerUserId:i.currentUserId,channelUrl:e,filterKey:H(n),startAt:{"<=":s},endAt:{">=":s}});a.limit=1,a.index={ownerUserId:Ge.LocalDB.Query.Order.ASC,channelUrl:Ge.LocalDB.Query.Order.ASC,filterKey:Ge.LocalDB.Query.Order.ASC,endAt:Ge.LocalDB.Query.Order.DESC},t.find(a,(n,i)=>{if(n)r(n);else{const n=i.length>0?Q.createFromJson(i[0]):null;if(n)if(n.hasDefaultFilter())r(null,n);else{const i=new Ge.LocalDB.Query({channelUrl:e,filterKey:H(Q.getDefaultFilter()),startAt:{"<=":s}});i.limit=1,i.index={ownerUserId:Ge.LocalDB.Query.Order.ASC,channelUrl:Ge.LocalDB.Query.Order.ASC,filterKey:Ge.LocalDB.Query.Order.ASC,endAt:Ge.LocalDB.Query.Order.DESC},t.find(i,(e,t)=>{if(e)r(e);else{const e=t.length>0?Q.createFromJson(t[0]):null;if(e)if(e.endAt>n.endAt)if(e.isOverlap(n))n.extendWithChunk(e),this.upsert(n,r);else{const t=new Q(n.channelUrl,n.filter);t.startAt=e.startAt,t.endAt=e.endAt,this.upsert(t,r)}else r(null,n);else r(null,n)}})}else r(null)}})}else r(E.create(E.Type.ERROR_SETUP_MISSING))}),this.mergePreviousChunkOverlap=((e,n)=>{const s=Ge.getInstance();if(s.currentUserId){const r=new Ge.LocalDB.Query({ownerUserId:s.currentUserId,chunkId:{"!=":e.chunkId},channelUrl:e.channelUrl,filterKey:e.filterKey,endAt:{">=":e.startAt}});r.limit=1/0,t.find(r,(s,r)=>{if(s)n(s);else if(r.length>0){const s=new Ge.LocalDB.Query({chunkId:{"/in":r.map(e=>e.chunkId)}});t.removeIf(s,t=>{if(t)n(t);else{for(let t=0;t<r.length;t++)e.extendWithChunk(r[t]);this.upsert(e,n)}})}else this.upsert(e,n)})}else n(E.create(E.Type.ERROR_SETUP_MISSING))}),this};function K(e,t,n){return n?t.channelUrl===e.url&&((!n.messageType||n.messageType===t.messageType)&&((!n.customType||n.customType===t.customType)&&!(Array.isArray(n.senderUserIds)&&n.senderUserIds.length>0&&t.sender&&n.senderUserIds.indexOf(t.sender.userId)<0))):t.channelUrl===e.url}const z=function(){let e=[];return this.addCollection=((t,n)=>{e.push({controller:t,view:n})}),this.removeCollection=(t=>{const n=e.map(e=>e.controller).indexOf(t);n>=0&&(e[n].controller._pause(),e.splice(n,1))}),this.clearCollection=(()=>{for(let t in e)e[t].controller._pause();e=[]}),this.pause=(()=>{for(let t in e)e[t].controller._pause()}),this.resume=(()=>{for(let t in e)e[t].controller._resume()}),this.upsert=((t,n)=>{for(let s in e){const r=e[s];if(r.controller!==n){const e=[];for(let n in t){const s=t[n];K(r.controller.channel,s,r.controller.filter)&&e.push(s)}e.length>0&&r.view.addViewItems(e,{isEventMessage:!0})}}}),this.update=((t,n)=>{for(let s in e){const r=e[s];if(r.controller!==n){const e=[];for(let n in t){const s=t[n];K(r.controller.channel,s,r.controller.filter)&&r.view.messages.map(e=>e.messageId).indexOf(s.messageId)>=0&&e.push(s)}e.length>0&&r.view.addViewItems(e,{isEventMessage:!0})}}}),this.read=((t,n)=>{for(let s in e){const r=e[s];r.controller!==n&&r.controller.channel.url===t.url&&(r.controller.channel=t,r.view.addViewItems(r.view.messages))}}),this.remove=((t,n)=>{for(let s in e){const r=e[s];r.controller!==n&&r.view.removeViewItems(t)}}),this.clear=(()=>{for(let t in e){e[t].view.clearViewItem()}}),this},$="last-changeLog-token-",J="syncManager_messageManager_channelHandler_"+(new Date).getTime(),Y=100;let X=null;class Z{constructor({sendBird:e,db:t}){if(!X){v.call("MessageManager()"),X=this;const n=this.sb=e;this.messageContainer=new R(t,n),this.chunkContainer=new W(t),this.broadcast=new z,this.isFetchingChangeLogByChannelUrl={};const s=new n.ChannelHandler;Object.keys(s).forEach(e=>{s[e]=((...t)=>{switch(e){case"onMessageReceived":v.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!0,X.messageContainer.upsert(t[1],(e,t)=>{e?E.throw(e):X.broadcast.upsert([t])});break;case"onReadReceiptUpdated":{v.event(e,t[0].url);const n=t[0];X.broadcast.read(n);break}case"onMessageUpdated":v.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!1,X.messageContainer.upsert(t[1],(e,t)=>{e?E.throw(e):X.broadcast.update([t])});break;case"onMessageDeleted":{v.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message);const n=parseInt(t[1]);X.messageContainer.remove(n,(e,t)=>{e?E.throw(e):X.broadcast.remove([t])});break}}})}),n.addChannelHandler(J,s)}return X}static getInstance(){return X}static clear(){X&&X.sb&&(v.message("MessageManager is cleared"),X.broadcast.clearCollection(),X.sb.removeChannelHandler(J),X=null)}syncChangeLog(e,t=(()=>{})){if(this.isFetchingChangeLogByChannelUrl[e.url])t(E.create(E.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLogByChannelUrl[e.url]=!0,v.call("message syncChangeLog()",e.url);const n=`${$}${e.url}`;C.get(n).then(s=>{let r="getMessageChangeLogsByToken";const i=[];s?(r="getMessageChangeLogsByToken",i.unshift(s)):(r="getMessageChangeLogsByTimestamp",i.unshift((new Date).getTime()-Y)),v.call(r),e[r](...i,(s,r)=>{if(this.sb.getErrorFirstCallback()){const e=s;s=r,r=e}r?this.isFetchingChangeLogByChannelUrl[e.url]=!1:(v.sync("updated",s.updatedMessages.map(e=>e.messageId)),v.sync("deleted",s.deletedMessageIds),s.updatedMessages.forEach(e=>{X.messageContainer.getItemWithVisibility(e.messageId,(t,n)=>{if(!t){const t=n.item;e.isVisible=n.isVisible||!1,X.messageContainer.upsert(e,(e,n)=>{if(e)E.throw(e);else{(!t||!t.isEqual(n))&&X.broadcast.update([n])}})}})}),s.deletedMessageIds.forEach(e=>{X.messageContainer.remove(e,t=>{t?E.throw(t):X.broadcast.remove([e])})}),C.set(n,s.token).then(()=>{s.hasMore?this.syncChangeLog(e,t):(this.isFetchingChangeLogByChannelUrl[e.url]=!1,t())}).catch(n=>{this.isFetchingChangeLogByChannelUrl[e.url]=!1,t(n)}))})}).catch(n=>{this.isFetchingChangeLogByChannelUrl[e.url]=!1,t(n)})}}start(){X.broadcast.resume()}stop(){X.broadcast.pause()}clearCache(e){X.messageContainer.clear(()=>{X.chunkContainer.clear(()=>{C.getKeys().then(t=>{const n=[];t.forEach(e=>{e.startsWith($)&&n.push(C.remove(e))}),Promise.all(n).then(()=>e()).catch(t=>{v.error(t),e(t)})}).catch(t=>e(t))})})}reset(e){X?(X.broadcast.clear(),X.clearCache(e)):e(null)}}const ee=6e4,te=200;class ne{constructor(){this.locked=!1,this.lockedAt=(new Date).getTime()+ee}isLocked(){return this.locked}lock(e){this.locked?setTimeout(()=>{(new Date).getTime()-this.lockedAt<ee&&this.lock(e)},te):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(()=>this.unlock()))}unlock(){this.locked=!1,this.lockedAt=(new Date).getTime()+ee}}const se=100,re=500;class ie{constructor(e){this.worker=e,this.state=ie.State.PAUSED,this.isLoading=!1,this.shared=0,this.retry=0,this.retryLimit=3,this.subscribes={}}static get State(){return{RUNNING:"running",PAUSED:"paused",END:"end"}}start(e,t=!1){(t||this.state!==ie.State.END)&&(this.isLoading||(this.isLoading=!0,this.state=ie.State.RUNNING,this.worker(e,(t,n)=>{v.sync("background sync result: err=",t,"res=",n),t?(this.isLoading=!1,this.retry<this.retryLimit?(this.retry++,setTimeout(()=>this.start(e),re)):this.state=ie.State.PAUSED):(this.retry=0,this.flush(t,n),this.state===ie.State.RUNNING&&(n.hasMore?setTimeout(()=>{this.state===ie.State.RUNNING&&this.start(n.nextTs)},se):this.state=ie.State.END),this.isLoading=!1)})))}pause(){this.isLoading=!1,this.state=ie.State.PAUSED}end(){this.isLoading=!1,this.state=ie.State.END}flush(e=null,t){v.sync("background sync flush:",Object.keys(this.subscribes).length+" subscribes");for(let n in this.subscribes)this.subscribes[n](e,t);this.subscribes={}}subscribe(e,t){return!this.subscribes[e]&&(this.subscribes[e]=t,!0)}}function ae(){this.onChannelEvent=((e,t)=>{})}function oe(){this.onMessageEvent=((e,t)=>{})}const ce={INSERT:"insert",UPDATE:"update",MOVE:"move",REMOVE:"remove",CLEAR:"clear"},le={INSERT:"insert",UPDATE:"update",REMOVE:"remove",CLEAR:"clear"},he="channel-collection-handler",ue=new WeakMap,de=new WeakMap,ge=new WeakMap,me=new WeakMap,pe=new WeakMap,fe=e=>{const t=N.getInstance();if(t){const n=e.query,s=n.filterKey;return t.channelSyncByFilter[s]||(t.channelSyncByFilter[s]=new ie((s,r)=>{v.call("channel syncChannel()",n.filterKey,n.hasNext,n._token),n.hasNext?(n.limit=100,n.next((s,i)=>{if(t.sb.getErrorFirstCallback()&&([i,s]=[s,i]),v.sync("channel",i,s&&s.length>0?"\n"+s.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"):""),i)r(i);else{const i=de.get(e);let a=0,o=null;for(let e=0;e<s.length;e++)t.channelContainer.insert(s[e],e=>{if(o=o||e,++a===s.length)if(o)r(o);else{const e=i.findChannelEdges(s);e.end&&(n.savepoint=e.end+""),t.queryContainer.upsert(n,e=>{e?r(e):r(null,{count:s.length,nextTs:0,hasNext:n.hasNext})})}})}})):r(null,{count:0,nextTs:0,hasNext:!1})})),t.channelSyncByFilter[s]}return null},ye=e=>{const t=N.getInstance();if(t){if(!t.changeLogSync){const n=e.query;t.changeLogSync=new ie((e,s)=>{t.syncChangeLog(n,e=>{s(e,{count:0,nextTs:0,hasNext:!1})})})}return t.changeLogSync}return null};class be{constructor(){this.collection=null,this.channels=[],this.mutex=new ne,this.viewOffset=null}attachCollection(e){this.collection=e}compareWithChannel(e,t){let n="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":n="createdAt";break;case"channel_name_alphabetical":n="name"}return this.compareWithOffset(e,t[n])}compareWithOffset(e,t){switch(this.collection.query.order){case"latest_last_message":return e.lastMessageUpdatedAt-t;case"chronological":return e.createdAt-t;case"channel_name_alphabetical":return t.localeCompare(e.name);default:return e.lastMessageUpdatedAt-t}}isAbove(e,t){return this.compareWithOffset(e,t)>0}isBelow(e,t){return this.compareWithOffset(e,t)<0}findChannelEdges(e){let t="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":t="createdAt";break;case"channel_name_alphabetical":t="name"}const n={start:null,end:null};for(let s in e)n.start&&!this.isAbove(e[s],n.start)||(n.start=e[s][t]),n.end&&!this.isBelow(e[s],n.end)||(n.end=e[s][t]);return n}refreshViewOffset(){const e=this.findChannelEdges(this.channels);this.viewOffset=e.end}addViewItems(e,t={}){const n=[],s=[],r=[],i=[],a=pe.get(this.collection);this.mutex.lock(o=>{for(let a in e){const o=e[a],c=F(o,this.channels),l=L(o,this.collection.query,this.channels);let h=!1;t.isEventChannel&&(this.viewOffset?this.isBelow(o,this.viewOffset)&&(h=!0):t.isChangeLogEvent||(this.collection.query.hasNext||this.collection.query.savepoint)&&(h=!0));let u=c<0?ce.INSERT:ce.UPDATE;switch(c<0?h||(l<this.channels.length?this.channels.splice(l,0,o):this.channels.push(o)):c!==l?l<this.channels.length?(u=ce.MOVE,this.channels.splice(c,1),l>c?this.channels.splice(l-1,0,o):this.channels.splice(l,0,o)):(u=ce.REMOVE,this.channels.splice(c,1)):this.channels[c]=o,u){case ce.INSERT:h||n.push(o);break;case ce.UPDATE:s.push(o);break;case ce.MOVE:r.push(o);break;case ce.REMOVE:i.push(o)}}if(this.refreshViewOffset(),n.length>0){v.view("channel",ce.INSERT,"\n"+n.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"));for(const e in a)a[e].onChannelEvent(ce.INSERT,n)}if(s.length>0){v.view("channel",ce.UPDATE,"\n"+s.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"));for(const e in a)a[e].onChannelEvent(ce.UPDATE,s)}if(r.length>0){v.view("channel",ce.MOVE,"\n"+r.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"));for(const e in a)a[e].onChannelEvent(ce.MOVE,r)}if(i.length>0){v.view("channel",ce.REMOVE,"\n"+i.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"));for(const e in a)a[e].onChannelEvent(ce.REMOVE,i)}o()})}removeViewItems(e){const t=pe.get(this.collection);this.mutex.lock(n=>{const s=[];for(let t in e){const n=e[t],r=this.channels.map(e=>e.url).indexOf(n.url);r>=0&&(this.channels.splice(r,1),s.push(n))}if(s.length>0){v.view("channel",ce.REMOVE,"\n"+s.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"));for(const e in t)t[e].onChannelEvent(ce.REMOVE,s)}n()})}clearViewItem(){this.channels=[];const e=pe.get(this.collection);this.mutex.lock(t=>{const n=ce.CLEAR;v.view("channel",n);for(const t in e)e[t].onChannelEvent(n);t()})}}class Ie{constructor(e){const t=new be,n=N.getInstance();if(!n)return null;this.collectionId=q(),this.sendBird=n.sb,this.type="MyGroupChannelListQuery",this.limit=e.limit,this.query=e,this.query.filterKey=n.queryContainer.createFilterKey(this.query),this._isLoading=!1,t.attachCollection(this),n.broadcast.addCollection(this,t),de.set(this,t),ue.set(this,n.broadcast),ge.set(this,n.channelContainer),me.set(this,n.queryContainer),pe.set(this,{}),fe(this).shared++,ye(this).shared++,n.queryContainer.getItem(this.query.filterKey,(t,s)=>{t?E.throw(t):(s&&(this.query._token=s._token,this.query.hasNext=s.hasNext,this.query.savepoint=s.savepoint,this.query.updatedAt=s.updatedAt),n.queryContainer.upsert(e,(e,t)=>{e?E.throw(e):(this.query=t,this._resume(),v.message(`channel collection ${this.collectionId} is created.`))}))})}static get CollectionHandler(){return ae}static get Action(){return ce}get channels(){return de.get(this).channels}_pause(){v.call("channel sync pause",this.collectionId);const e=fe(this),t=ye(this);e&&e.pause(),t&&t.pause()}_resume(){v.call("channel sync resume",this.collectionId);const e=fe(this),t=ye(this);e&&e.start(),t&&t.start()}fetch(e){if(!this._isLoading)return this._isLoading=!0,V(e=>{v.call("fetch()");const t=de.get(this),n=ge.get(this),s=this.sendBird,r={ownerUserId:Ge.getInstance().currentUserId};if(this.query.includeEmpty||(r.lastMessage={"!=":null}),this.query.nicknameContainsFilter&&(r.members={"/where":e=>{for(let t in e)if(e[t].nickname.indexOf(this.query.nicknameContainsFilter)>=0)return!0;return!1}}),this.query.userIdsFilter.length>0&&(r.members={"/where":e=>{const t=e.map(e=>e.userId);return this.query.userIdsFilterExactMatch?t.length===this.query.userIdsFilter.length&&this.query.userIdsFilter.every(e=>t.indexOf(e)>=0):"AND"===this.query.queryType?this.query.userIdsFilter.every(e=>t.indexOf(e)>=0):"OR"===this.query.queryType&&this.query.userIdsFilter.reduce((e,n)=>e=e||t.indexOf(n)>=0,!1)}}),this.query.channelNameContainsFilter&&(r.name={"/regex":new RegExp(this.query.channelNameContainsFilter)}),this.query.channelUrlsFilter.length>0&&(r.url={"/in":this.query.channelUrlsFilter}),this.query.memberStateFilter!==s.GroupChannel.memberStateFilter.ALL)switch(this.query.memberStateFilter){case s.GroupChannel.memberStateFilter.JOINED:r.myMemberState=s.GroupChannel.memberStateFilter.JOINED;break;case s.GroupChannel.memberStateFilter.INVITED:case s.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case s.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:r.myMemberState={"/in":[s.GroupChannel.memberStateFilter.INVITED,s.GroupChannel.memberStateFilter.INVITED_BY_FRIEND,s.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND]}}if("string"==typeof this.query.customTypeFilter&&this.query.customTypeFilter&&(r.customType=this.query.customTypeFilter),Array.isArray(this.query.customTypesFilter)&&this.query.customTypesFilter.length>0&&(r.customType={"/in":this.query.customTypesFilter}),"string"==typeof this.query.customTypeStartsWithFilter&&this.query.customTypeStartsWithFilter&&(r.customType={"/regex":new RegExp(`^${this.query.customTypeStartsWithFilter}`)}),this.query.superChannelFilter!==s.GroupChannel.superChannelFilter.ALL)switch(this.query.superChannelFilter){case s.GroupChannel.superChannelFilter.SUPER:r.isSuper=!0;break;case s.GroupChannel.superChannelFilter.NONSUPER:r.isSuper=!1}if(this.query.publicChannelFilter!==s.GroupChannel.publicChannelFilter.ALL)switch(this.query.publicChannelFilter){case s.GroupChannel.publicChannelFilter.PUBLIC:r.isPublic=!0;break;case s.GroupChannel.publicChannelFilter.PRIVATE:r.isPublic=!1}if(this.query.unreadChannelFilter!==s.GroupChannel.UnreadChannelFilter.ALL)switch(this.query.unreadChannelFilter){case s.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:r.unreadMessageCount={">":0}}if("all"!=this.query.hiddenChannelFilter)switch(this.query.hiddenChannelFilter){case s.GroupChannel.HiddenChannelFilter.UNHIDDEN:r.hiddenState=s.GroupChannel.HiddenState.UNHIDDEN;break;case s.GroupChannel.HiddenChannelFilter.HIDDEN:r.hiddenState={"/in":[s.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE,s.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE]};break;case s.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:r.hiddenState=s.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE;break;case s.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:r.hiddenState=s.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE}let i=null,a=!0;switch(this.query.order){case"latest_last_message":!this.query.hasNext&&this.query.savepoint&&(r.lastMessageUpdatedAt={">=":parseInt(this.query.savepoint)}),i={ownerUserId:1,lastMessageUpdatedAt:-1};break;case"chronological":!this.query.hasNext&&this.query.savepoint&&(r.createdAt={">=":parseInt(this.query.savepoint)}),i={ownerUserId:1,createdAt:-1};break;case"channel_name_alphabetical":!this.query.hasNext&&this.query.savepoint&&(r.name={"<=":this.query.savepoint}),i={ownerUserId:1,name:1},a=!1;break;default:!this.query.hasNext&&this.query.savepoint&&(r.lastMessageUpdatedAt={">=":parseInt(this.query.savepoint)}),i={ownerUserId:1,lastMessageUpdatedAt:-1}}const o=fe(this),c=(e,s)=>{n.query(r,{offset:t.channels.length,limit:e,index:i,desc:a},(n,r)=>{n?(this._isLoading=!1,s(n)):(this._isLoading=!1,r.sort((e,n)=>t.compareWithChannel(e,n)>0),r.length>0&&t.addViewItems(r),r.length<e&&l(e-r.length),s(null,r))})},l=e=>{o.state!==ie.State.END&&(v.sync("subscribe channel",this.collectionId),o.subscribe(this.collectionId,t=>{t?v.error(t):(v.sync("flush channel"),c(e,e=>{e&&v.error(e)}))}))};c(this.limit,(t,n)=>{v.cache("fetch channel",t,n.map(e=>e.url)),e(t)}),o.state===ie.State.PAUSED&&this._resume()},e);v.error("fetch() is loading"),e(E.create(E.Type.ERROR_DUPLICATED_FETCH))}remove(){ue.get(this).removeCollection(this);const e=fe(this),t=ye(this);e&&(e.shared--,0===e.shared&&e.pause()),t&&(t.shared--,0===t.shared&&t.pause())}setCollectionHandler(e){const t=pe.get(this);e instanceof ae&&(t[he]=e)}removeCollectionHandler(){const e=pe.get(this);e[he]&&delete e[he]}}const Ce=new WeakMap,we=new WeakMap,ke=new WeakMap,ve=new WeakMap,Ee=new WeakMap,Ae=new WeakMap,Te=new WeakMap,Se=new WeakMap,Oe="message-collection-handler",Me=300,Ue=50,De=100,xe=100,_e=50;class Ne{constructor(){this.collection=null,this.messages=[],this.prevTempMessages=[],this.nextTempMessages=[],Ce.set(this,{}),this.currentChunk=null,this.viewRange={start:0,end:0}}attachCollection(e){this.collection=e}addViewItems(e,t={}){const n=Se.get(this.collection),s=Ce.get(this),r=Te.get(this.collection),i=[],a=[],o=[];for(let n in e){const c=e[n];let l=!0,h=!0;if(t.isEventMessage){const e=r.state===ie.State.END,t=!this.currentChunk||this.currentChunk.endAt<=this.viewRange.end,n=0===this.viewRange.end;l=e&&t||!this.currentChunk||n}const u=this.collection.sendBird.currentUser?this.collection.channel.getReadReceipt(c):s[c.messageId]||0;if(s[c.messageId]||(s[c.messageId]=u),l){const e=B(c,this.messages),t=P(c,this.messages);if(e>=0&&this.messages[e].isEqual(c)&&s[c.messageId]===u)continue;s[c.messageId]=u,c.messageId&&(this.viewRange.start=this.viewRange.start>0?Math.min(this.viewRange.start,c.createdAt):c.createdAt,this.viewRange.end=this.viewRange.end>0?Math.max(this.viewRange.end,c.createdAt):c.createdAt);let n=null;if(e<0)n=le.INSERT,this.messages.splice(t,0,c),h&&this.nextTempMessages.push(c);else if(c.messageId){const s=this.messages[e];if(s.messageId)this.messages[e]=c,n=le.UPDATE;else{this.messages.splice(e,1),o.push(s);const r=e<t?1:0;this.messages.splice(t-r,0,c),n=le.INSERT}}switch(n){case le.INSERT:i.push(c);break;case le.UPDATE:a.push(c)}}}if(o.length>0){v.view("message",le.REMOVE,o.map(e=>e.messageId+" "+e.createdAt));for(const e in n)n[e].onMessageEvent(le.REMOVE,o)}if(i.length>0){v.view("message",le.INSERT,i.map(e=>e.messageId+" "+e.createdAt));for(const e in n)n[e].onMessageEvent(le.INSERT,i)}if(a.length>0){v.view("message",le.UPDATE,a.map(e=>e.messageId+" "+e.createdAt));for(const e in n)n[e].onMessageEvent(le.UPDATE,a)}}removeViewItems(e,t=!1){const n=Se.get(this.collection),s=Ce.get(this),r=[];for(let n in e){const i=e[n];for(let e in this.messages)if(i===this.messages[e].messageId||t&&i===this.messages[e].reqId){"number"==typeof s[i]&&delete s[i];const t=this.messages.splice(e,1);r.push(...t);break}}if(this.viewRange.start=this.messages.length>0?this.messages[0].createdAt:0,this.viewRange.end=this.messages.length>0?this.messages[this.messages.length-1].createdAt:0,r.length>0){v.view("message",le.REMOVE,r.map(e=>e.messageId));for(const e in n)n[e].onMessageEvent(le.REMOVE,r)}}clearPreviewItem(){const e=Se.get(this.collection),t=[];for(let e in this.messages)0===this.messages[e].messageId&&t.push({index:parseInt(e),item:this.messages[e]});for(let e=t.length-1;e>=0;e--){const n=t[e];this.messages.splice(n.index,1)}v.view("message",le.REMOVE,"preview message");for(const n in e)e[n].onMessageEvent(le.REMOVE,t.map(e=>e.item))}clearViewItem(){this.currentChunk=null,this.messages=[],Ce.set(this,{}),this.viewRange.start=0,this.viewRange.end=0;const e=Se.get(this.collection),t=le.CLEAR;v.view("message",t);for(const n in e)e[n].onMessageEvent(t)}}class Re{constructor(e,t,n=(new Date).getTime()){const s=Z.getInstance();if(!s)return null;{if(this.collectionId=q(),this.sendBird=s.sb,this.channel=e,this.limit=_e,this.filter=Q.getDefaultFilter(),t&&Object.keys(t).length>0)for(let e in t)this.filter.hasOwnProperty(e)&&(this.filter[e]=t[e]);this.viewpoint=n,this._isLoading={prev:!1,next:!1};const r=new Ne;r.attachCollection(this),ke.set(this,r),s.broadcast.addCollection(this,r),we.set(this,s.broadcast),ve.set(this,s.messageContainer),Ee.set(this,s.chunkContainer),Se.set(this,{}),Ae.set(this,null),Te.set(this,null);const i=new ne,a=(t,n,a)=>{v.sync("message synchronize() begin",t,n);let o=null,c=0,l=[n];switch(t){case"prev":o="getPreviousMessagesByTimestamp",c=De,l.push(!0),l.push(De);break;case"next":o="getNextMessagesByTimestamp",c=xe,l.push(!0),l.push(xe);break;case"prevnext":o="getPreviousAndNextMessagesByTimestamp",c=2*Ue,l.push(Ue),l.push(Ue)}l.push(!1),l.push(this.filter.messageType||""),l.push(this.filter.customType||""),l.push(this.filter.senderUserIds||[]),l.push(this.filter.includeMetaArray||!1),e[o](...l,(e,o)=>{s.sb.getErrorFirstCallback()&&([o,e]=[e,o]),o?(this._pause(),a(o)):(v.sync("message synchronize() end",t,n,e.map(e=>e.messageId)),i.lock(n=>{const i=[],o={startAt:1/0,endAt:0};if(e.length>0){for(let t in e)e[t].isVisible=!0,i.push(new Promise((n,r)=>{s.messageContainer.upsert(e[t],e=>e?r(e):n())})),o.startAt=Math.min(o.startAt,e[t].createdAt),o.endAt=Math.max(o.endAt,e[t].createdAt);r.currentChunk&&r.currentChunk.isOverlap(o)||(r.currentChunk=new Q(this.channel.url,this.filter),v.message("chunk is created",r.currentChunk.startAt,r.currentChunk.endAt));const l=r.currentChunk;l.extendWithChunk(o),v.message("currentChunk is extended",l.startAt,l.endAt),s.chunkContainer.mergePreviousChunkOverlap(l,s=>{s?(n(),a(s)):(v.message("currentChunk merged previous chunks",l.startAt,l.endAt),Promise.all(i).then(()=>{n(),a(null,{count:e.length,nextTs:"prev"===t?l.startAt:l.endAt,hasMore:e.length>=c})}).catch(e=>{n(),a(e)}))})}else n(),a(null,{count:0,nextTs:0,hasMore:!1})}))})},o=new ie((e,t)=>a("prev",e,t));o.shared++,Ae.set(this,o);const c=new ie((e,t)=>a("next",e,t));o.shared++,Te.set(this,c),s.chunkContainer.getChunkByTimestamp(this.channel.url,this.filter,this.viewpoint,(e,t)=>{e||(t&&(r.currentChunk=t),r.currentChunk?this._resume():a("prevnext",this.viewpoint,(e,t)=>{e||setTimeout(()=>{o.flush(e,t),c.flush(e,t),t.count<Ue?(o.end(),c.end()):this._resume()},Me)}),v.message(`message collection ${this.collectionId} is created.`))})}}static get CollectionHandler(){return oe}static get Action(){return le}static create(e,t,n,s){"function"==typeof n&&(s=n,n=(new Date).getTime());const r=N.getInstance();return V(s=>{r.channelContainer.getItem(e,(r,i)=>{if(r)s(r);else if(i)s(null,new Re(i,t,n));else{const r=N.getInstance();r.sb.GroupChannel.getChannel(e,(e,i)=>{r.sb.getErrorFirstCallback()&&([i,e]=[e,i]),i?s(i):s(null,new Re(e,t,n))})}})},s)}get messages(){return ke.get(this).messages}_pause(){v.call("message sync pause",this.collectionId);const e=ke.get(this),t=Ae.get(this),n=Te.get(this);t&&t.pause(),n&&n.pause(),e.currentChunk=null}_resume(){v.call("message sync resume",this.collectionId),Z.getInstance().syncChangeLog(this.channel,()=>{const e=ke.get(this),t=Ae.get(this),n=Te.get(this);if(t){const n=e.currentChunk?e.currentChunk.startAt:this.viewpoint;t.start(n)}if(n){const t=e.currentChunk?e.currentChunk.endAt:this.viewpoint;n.start(t,!0)}})}fetch(e,t){const n=ke.get(this),s=ve.get(this),r=Ee.get(this);return this._isLoading[e]?V(e=>e(E.create(E.Type.ERROR_DUPLICATED_FETCH)),t):(this._isLoading[e]=!0,V(t=>{v.call("fetch()",e);let i=null,a=this.viewpoint,o=this.limit,c=!1,l=a,h=null,u=null;switch(e){case"prev":i=Ae.get(this),n.viewRange.start>0&&(a=n.viewRange.start),n.currentChunk&&(l=Math.max(n.currentChunk.startAt,a)),h=n.prevTempMessages,u=s.loadPreviousMessages,c=!0;break;case"next":i=Te.get(this),n.viewRange.end>0&&(a=n.viewRange.end),n.currentChunk&&(l=Math.min(n.currentChunk.endAt,a)),h=n.nextTempMessages,u=s.loadNextMessages;break;default:return void t(E.create(E.Type.ERROR_INVALID_PARAMETER))}const d=(t,s)=>{v.message("waiting for synchronization..."),u(this.channel.url,this.filter,t,{limit:o,desc:c},(t,r)=>{t?(this._isLoading[e]=!1,s(t)):(v.cache("temp message",e,r.map(e=>e.messageId)),h.push(...r),n.addViewItems(r),this._isLoading[e]=!1,s(null))});const a=l;v.sync("subscribe message",this.collectionId,e,t),i.subscribe(this.collectionId,s=>{s?v.error(s):(v.sync("flush message",e,t),r.getChunkByTimestamp(this.channel.url,this.filter,t,(t,s)=>{if(!t)if(s&&(n.currentChunk=s),n.currentChunk){const t=n.currentChunk;u(this.channel.url,this.filter,a,{limit:o,desc:c},(s,r)=>{if(s)v.error(s);else{v.cache("flush message",e,a,r.map(e=>e.messageId)),n.clearPreviewItem();const s=[],i=[];for(let e in r)if(t.containsMessage(r[e])){const t=n.messages.map(e=>e.messageId).indexOf(r[e].messageId);(t<0||!n.messages[t].isEqual(r[e]))&&s.push(r[e])}for(let e in h)n.messages.map(e=>e.messageId).indexOf(h[e].messageId)<0&&i.push(h[e]);for(;h.length>0;)h.pop();i.length>0&&n.removeViewItems(i.map(e=>e.messageId)),s.length>0&&n.addViewItems(s)}})}else v.error(t)}))})};r.getChunkByTimestamp(this.channel.url,this.filter,a,(s,r)=>{if(s)this._isLoading[e]=!1,t(s);else if(r&&(n.currentChunk=r),n.currentChunk){const s=n.currentChunk;v.message("chunk is selected",s),u(this.channel.url,this.filter,a,{limit:o,desc:c},(r,i)=>{if(r)this._isLoading[e]=!1,t(r);else{const r=[],c=[];v.cache("fetch message",e,a,i.map(e=>e.messageId));let l=!1;for(let e in i)if(s.containsMessage(i[e])){l=!0;const t=n.messages.map(e=>e.messageId).indexOf(i[e].messageId);(t<0||!n.messages[t].isEqual(i[e]))&&r.push(i[e])}if(!l){for(let e in h)n.messages.map(e=>e.messageId).indexOf(h[e].messageId)<0&&c.push(h[e]);for(;h.length>0;)h.pop()}r.length>0&&n.addViewItems(r),c.length>0&&n.removeViewItems(c.map(e=>e.me)),i.length<o?(o-=i.length,d(a,t)):(this._isLoading[e]=!1,t(null))}})}else d(a,t)}),i.state===ie.State.PAUSED&&this._resume()},t))}resetViewpointTimestamp(e=(new Date).getTime()){if("number"==typeof e&&e>=0){v.call("resetViewpointTimestamp()",e);const t=ke.get(this);t.viewRange.start<=e&&e<=t.viewRange.end?t.currentChunk&&!t.currentChunk.contains(e)&&(t.currentChunk=null):(t.currentChunk=null,t.clearViewItem()),this.viewpoint=e,this._resume()}else v.error("resetViewpointTimestamp()","ts should be number type and greater than or equal to 0."),E.throw(E.create(E.Type.ERROR_INVALID_PARAMETER))}remove(){const e=ke.get(this);we.get(this).removeCollection(this),e.currentChunk=null;const t=Ae.get(this),n=Te.get(this);t&&(t.shared--,0===t.shared&&t.pause()),n&&(n.shared--,0===n.shared&&n.pause())}appendMessage(e){if(e){v.call("appendMessage()",e.messageId);const t=Ge.getInstance(),n=ke.get(this);if(e.sender&&e.sender.userId===t.currentUserId)if(e.messageId){const t=we.get(this),n=ve.get(this);e.isVisible=!0,n.upsert(e,(e,n)=>{e||t.upsert([n])});const s=N.getInstance();s.channelContainer.getItem(e.channelUrl,(t,n)=>{t?E.throw(t):n&&(!n.lastMessage||n.lastMessage.createdAt<=e.createdAt)&&(n.lastMessage=e,s.channelContainer.upsert(n,(e,t)=>{e?E.throw(e):s.broadcast.upsert([t])}))})}else n.addViewItems([e],{isEventMessage:!0})}else v.error("appendMessage()",`Message is expected but ${e} is given.`),E.throw(E.create(E.Type.ERROR_INVALID_PARAMETER))}updateMessage(e){if(e){v.call("updateMessage()",e.messageId);const t=Ge.getInstance(),n=ke.get(this);if(e.sender&&e.sender.userId===t.currentUserId)if(e.messageId){const t=we.get(this),n=ve.get(this);e.isVisible=!0,n.upsert(e,(e,n)=>{e||t.update([n])});const s=N.getInstance();s.channelContainer.getItem(e.channelUrl,(t,n)=>{t?E.throw(t):n&&n.lastMessage&&n.lastMessage.messageId===e.messageId&&(n.lastMessage=e,s.channelContainer.upsert(n,(e,t)=>{e?E.throw(e):s.broadcast.update([t])}))})}else n.addViewItems([e])}else v.error("updateMessage()",`Message is expected but ${e} is given.`),E.throw(E.create(E.Type.ERROR_INVALID_PARAMETER))}deleteMessage(e){if(e){v.call("deleteMessage()",e.messageId);const t=Ge.getInstance(),n=ke.get(this);e.sender&&e.sender.userId===t.currentUserId&&(e.messageId||n.removeViewItems([e.reqId],!0))}else v.error("deleteMessage()",`Message is expected but ${e} is given.`),E.throw(E.create(E.Type.ERROR_INVALID_PARAMETER))}setCollectionHandler(e){const t=Se.get(this);e instanceof oe&&(t[Oe]=e)}removeCollectionHandler(){const e=Se.get(this);e[Oe]&&delete e[Oe]}}n.d(t,"default",function(){return Ge});let Fe=null,Le=null,Be=null,Pe=y,je=null,qe=null,Ve=null;class Ge{constructor(){return Le||(Le=this),Le}static get sendBird(){return Fe}static set sendBird(e){Fe=e}static get LocalDB(){return Pe}static setup(e,t){return v.call("init()"),V(t=>{if(C.init(),Fe)if(Le=new Ge,Fe.currentUser&&e!==Fe.currentUser.userId&&(v.warning("Different user ID: clear cache"),Le.clearCache()),Be=e,N.clear(),qe=null,Z.clear(),Ve=null,je)v.cache("Database is open"),qe=new N({sendBird:Fe,db:je}),Ve=new Z({sendBird:Fe,db:je}),Ge.ChannelCollection=Ie,Ge.MessageCollection=Re,t(null);else{const e=new Pe("sbsync.db",3);e.schema("GroupChannel",{key:"url",index:[{ownerUserId:Pe.Query.Order.ASC,lastMessageUpdatedAt:Pe.Query.Order.DESC},{ownerUserId:Pe.Query.Order.ASC,createdAt:Pe.Query.Order.DESC},{ownerUserId:Pe.Query.Order.ASC,name:Pe.Query.Order.ASC}]}).schema("GroupChannelListQuery",{key:"filterKey",index:[{ownerUserId:Pe.Query.Order.ASC,updatedAt:Pe.Query.Order.DESC}]}).schema("MessageChunk",{key:"chunkId",index:[{ownerUserId:Pe.Query.Order.ASC,channelUrl:Pe.Query.Order.ASC,filterKey:Pe.Query.Order.ASC,endAt:Pe.Query.Order.DESC}]}).schema("Message",{key:"messageId",index:[{ownerUserId:Pe.Query.Order.ASC,channelUrl:Pe.Query.Order.ASC,createdAt:Pe.Query.Order.DESC}]}).build().then(()=>{v.cache("Database is created"),qe=new N({sendBird:Fe,db:e}),Ve=new Z({sendBird:Fe,db:e}),je=e,Ge.ChannelCollection=Ie,Ge.MessageCollection=Re,t(null)}).catch(e=>t(e))}else t(E.create(E.Type.ERROR_SETUP_MISSING))},t)}static getInstance(){return Le}static useReactNative(e){C.useReactNative(e),s.a.Storage=e,Pe=s.a}get currentUserId(){return Fe&&Fe.currentUser?Fe.currentUser.userId:Be}resumeSync(){v.call("resumeSync()"),qe&&qe.start(),Ve&&Ve.start()}pauseSync(){v.call("pauseSync()"),qe&&qe.stop(),Ve&&Ve.stop()}clearCache(e){return v.call("clearCache()"),V(e=>{const t=[];qe&&t.push(new Promise((e,t)=>{qe.reset(n=>n?t(n):e())})),Ve&&t.push(new Promise((e,t)=>{Ve.reset(n=>n?t(n):e())})),t.length>0?Promise.all(t).then(()=>e(null)).catch(t=>e(t)):e(null)},e)}reset(e){return v.call("reset()"),V(e=>{this.clearCache(t=>{t||(N.clear(()=>{qe=null}),Z.clear(()=>{Ve=null})),e(t)})},e)}}}]).default});