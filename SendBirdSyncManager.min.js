!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.SendBirdSyncManager=n():e.SendBirdSyncManager=n()}(window,function(){return function(e){var n={};function t(r){if(n[r])return n[r].exports;var a=n[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,t),a.l=!0,a.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var a in e)t.d(r,a,function(n){return e[n]}.bind(null,a));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=2)}([function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e)}return r(e,null,[{key:"put",value:function(e){}},{key:"call",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["CALL"].concat(t))}},{key:"cache",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["CACHE"].concat(t))}},{key:"sync",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["SYNC"].concat(t))}},{key:"event",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["EVENT"].concat(t))}},{key:"view",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["VIEW"].concat(t))}},{key:"warning",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["WARNING"].concat(t))}},{key:"error",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["ERROR"].concat(t))}},{key:"message",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["MESSAGE"].concat(t))}}]),e}();n.default=a},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r,a=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),i=t(0),s=(r=i)&&r.__esModule?r:{default:r};var u=function(e){function n(e,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,n);var r=function(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return r.name="SyncManagerException",r.code=t||0,r}return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}(n,Error),a(n,null,[{key:"create",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.Type.ERROR_UNKNOWN;return new n(e.message,e.code)}},{key:"throw",value:function(e){if(s.default.error(e),e instanceof n)throw e}},{key:"Type",get:function(){return{ERROR_UNKNOWN:{code:81e4,message:"Unknown error occurred."},ERROR_DATABASE_IO:{code:810001,message:"Database I/O operation failed."},ERROR_SETUP_MISSING:{code:810100,message:"SendBirdSyncManager.setup() is not called."},ERROR_SENDBIRD_MISSING:{code:810101,message:"SendBird instance should be set before init()."},ERROR_DUPLICATED_FETCH:{code:810200,message:"Fetch is in progress."},ERROR_DUPLICATED_CHANGELOG_SYNC:{code:810210,message:"Sync is in progress."},ERROR_INVALID_PARAMETER:{code:810300,message:"Invalid parameter."}}}}]),n}();n.default=u},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=f(t(3)),i=f(t(4)),s=f(t(8)),u=t(20),o=t(21),c=f(t(0)),l=f(t(1)),h=t(5);function f(e){return e&&e.__esModule?e:{default:e}}var d=null,v=null,g=null,p=null,y=null,m=null,C=function(){function e(){return function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),v||(v=this),v}return r(e,[{key:"resumeSync",value:function(){c.default.call("resumeSync()"),y&&y.start(),m&&m.start()}},{key:"pauseSync",value:function(){c.default.call("pauseSync()"),y&&y.stop(),m&&m.stop()}},{key:"clearCache",value:function(e){return c.default.call("clearCache()"),(0,h.promisify)(function(e){var n=[];y&&n.push(y.reset()),m&&n.push(m.reset()),n.length>0?Promise.all(n).then(function(){return e(null)}).catch(function(n){return e(n)}):e(null)},e)}},{key:"reset",value:function(e){var n=this;return c.default.call("reset()"),(0,h.promisify)(function(e){n.clearCache().then(function(){i.default.clear(),y=null,s.default.clear(),m=null,e(null)}).catch(function(n){return e(n)})},e)}},{key:"currentUserId",get:function(){return d&&d.currentUser?d.currentUser.userId:g}}],[{key:"setup",value:function(n,t){return c.default.call("init()"),(0,h.promisify)(function(t){if(d)if(v=new e,d.currentUser&&n!==d.currentUser.userId&&(c.default.warning("Different user ID: clear cache"),v.clearCache()),g=n,i.default.clear(),y=null,s.default.clear(),m=null,p)c.default.cache("Database is open"),y=new i.default({sendBird:d,db:p}),m=new s.default({sendBird:d,db:p}),t(null);else{var r=new a.default("sbsync.db",2);r.schema("GroupChannel",{key:"url",index:[["ownerUserId","lastMessageUpdatedAt"],["ownerUserId","createdAt"],["ownerUserId","name"]]}).schema("GroupChannelListQuery",{key:"filterKey",index:[["ownerUserId","updatedAt"]]}).schema("MessageChunk",{key:"chunkId",index:[["ownerUserId","channelUrl","filterKey","endAt"]]}).schema("Message",{key:"messageId",index:[["ownerUserId","channelUrl","createdAt"]]}).build().then(function(){c.default.cache("Database is created"),y=new i.default({sendBird:d,db:r}),m=new s.default({sendBird:d,db:r}),p=r,e.ChannelCollection=u.ChannelCollection,e.MessageCollection=o.MessageCollection,t(null)})}else t(l.default.create(l.default.Type.ERROR_SETUP_MISSING))},t)}},{key:"getInstance",value:function(){return v}},{key:"sendBird",get:function(){return d},set:function(e){d=e}},{key:"LocalDB",get:function(){return a.default}}]),e}();n.default=C},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=s(t(13)),i=s(t(14));function s(e){return e&&e.__esModule?e:{default:e}}var u=new WeakMap,o=new WeakMap,c=new WeakMap,l=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,h=function(){function e(n,t){if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),!l)throw new Error("IndexedDB is not supported in this environment. Check if you're in web browser which supports IndexedDB.");this.name=n,this.version=t,u.set(this,{}),o.set(this,null),c.set(this,{})}return r(e,null,[{key:"Query",get:function(){return i.default}}]),r(e,[{key:"schema",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=u.get(this);return t[e]=n,this}},{key:"build",value:function(){var e=this,n=u.get(this),t=c.get(this);return new Promise(function(r,i){var s=l.open(e.name,e.version);s.onerror=function(e){i(new Error("IndexedDB is not available: "+e.target.errorCode))},s.onupgradeneeded=function(r){var i=r.target.result,s=r.target.transaction,u=s.objectStoreNames;for(var c in n){var l=n[c].key||"id",h=null;try{h=s.objectStore(c)}catch(e){"NotFoundError"===e.name&&(h=i.createObjectStore(c,{keyPath:l}))}if(h){var f=h.indexNames,d=new a.default(i,c,l);if(n[c].index&&n[c].index.length>0)for(var v in n[c].index){var g=null;if("string"==typeof n[c].index[v]?g=n[c].index[v]:Array.isArray(n[c].index[v])&&(g=n[c].index[v].join("_")),g){var p=!1;for(var y in f)if(f[y]===g){p=!0;break}p||h.createIndex(g,n[c].index[v],{unique:!1})}}var m=[];if(n[c].index)for(var C in n[c].index){var b=null;"string"==typeof n[c].index[C]?b=n[c].index[C]:Array.isArray(n[c].index[C])&&(b=n[c].index[C].join("_")),b&&m.push(b)}for(var I=0;I<f.length;I++)m.indexOf(f[I])<0&&h.deleteIndex(f[I]);t[c]=d}}for(var w=0;w<u.length;w++)Object.keys(n).indexOf(u.item(w))<0&&i.deleteObjectStore(u.item(w));o.set(e,i)},s.onsuccess=function(i){var s=i.target.result;for(var u in n)if(!t[u]){var c=n[u].key||"id";t[u]=new a.default(s,u,c)}o.set(e,s),r()}})}},{key:"close",value:function(){var e=o.get(this);e&&(e.close(),o.set(this,null))}},{key:"drop",value:function(){l.deleteDatabase(this.name)}},{key:"collection",value:function(e){var n=c.get(this);return n[e]&&n[e]instanceof a.default?n[e]:null}}]),e}();n.default=h},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=t(15),i=t(16),s=t(7),u=t(17),o=h(t(2)),c=h(t(1)),l=h(t(0));function h(e){return e&&e.__esModule?e:{default:e}}var f="syncManager_channelManager_channelHandler_"+(new Date).getTime(),d=null,v=function(){function e(n){var t=n.sendBird,r=n.db;if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),!d){l.default.call("ChannelManager()"),d=this;var s=this.sb=t,h=o.default.getInstance();this.channelContainer=new a.ChannelContainer(r,s),this.queryContainer=new i.ChannelListQueryContainer(r,s),this.broadcast=new u.ChannelBroadcast,this.isFetchingChangeLog=!1,this.channelSyncByFilter={},this.changeLogSync=null;var v=new s.ChannelHandler;Object.keys(v).forEach(function(e){v[e]=function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];switch(e){case"onChannelChanged":var a=t[0];l.default.event(e,a.url),d.channelContainer.getItem(a.url).then(function(e){d.channelContainer.upsert(a).then(function(n){e?e.hiddenState!==s.GroupChannel.HiddenState.UNHIDDEN&&a.hiddenState===s.GroupChannel.HiddenState.UNHIDDEN?d.broadcast.unhide([n]):d.broadcast.update([n]):d.broadcast.upsert([n])}).catch(function(e){return c.default.throw(e)})}).catch(function(e){return c.default.throw(e)});break;case"onUserMuted":case"onUserUnmuted":case"onUserUnbanned":case"onChannelFrozen":case"onChannelUnfrozen":case"onTypingStatusUpdated":case"onMetaDataCreated":case"onMetaDataUpdated":case"onMetaDataDeleted":case"onMetaCountersCreated":case"onMetaCountersUpdated":case"onMetaCountersDeleted":l.default.event(e,t[0].url),d.channelContainer.upsert(t[0]).then(function(e){return d.broadcast.update([e])}).catch(function(e){return c.default.throw(e)});break;case"onUserReceivedInvitation":case"onUserJoined":l.default.event(e,t[0].url),d.channelContainer.upsert(t[0]).then(function(e){t[1].userId===h.currentUserId?d.broadcast.upsert([e]):d.broadcast.update([e])}).catch(function(e){return c.default.throw(e)});break;case"onReadReceiptUpdated":d.channelContainer.upsert(t[0]).then(function(){}).catch(function(e){return c.default.throw(e)});break;case"onMessageReceived":t[0].lastMessage&&t[0].lastMessage.messageId!==t[1].messageId||d.channelContainer.upsert(t[0]).then(function(e){return d.broadcast.upsert([e])}).catch(function(e){return c.default.throw(e)});break;case"onChannelHidden":l.default.event(e,t[0].url);var i=t[0];d.channelContainer.upsert(i).then(function(){return d.broadcast.hide([i])}).catch(function(e){return c.default.throw(e)});break;case"onUserLeft":case"onUserBanned":l.default.event(e,t[0].url);var u=t[0];t[1].userId===h.currentUserId?d.channelContainer.remove(u).then(function(){return d.broadcast.remove([u])}).catch(function(e){return c.default.throw(e)}):d.channelContainer.upsert(u).then(function(e){return d.broadcast.update([e])}).catch(function(e){return c.default.throw(e)});break;case"onUserDeclinedInvitation":l.default.event(e,t[0].url);var o=t[0];t[2].userId===h.currentUserId?d.channelContainer.remove(o).then(function(){return d.broadcast.remove([o])}).catch(function(e){return c.default.throw(e)}):d.channelContainer.upsert(o).then(function(e){return d.broadcast.update([e])}).catch(function(e){return c.default.throw(e)});break;case"onChannelDeleted":l.default.event(e,t[0]),d.channelContainer.getItem(t[0]).then(function(e){e&&d.channelContainer.remove(e).then(function(){return d.broadcast.remove([e])}).catch(function(e){return c.default.throw(e)})}).catch(function(e){return c.default.throw(e)})}}}),s.addChannelHandler(f,v)}return d}return r(e,[{key:"syncChangeLog",value:function(e,n){var t=this;if(this.isFetchingChangeLog)n(c.default.create(c.default.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLog=!0,l.default.call("channel syncChangeLog()");s.UserPreference.get("channel-changeLog-token").then(function(r){var a,i="getMyGroupChannelChangeLogsByToken",u=[];u.push([]),u.push(!0),r?(i="getMyGroupChannelChangeLogsByToken",u.unshift(r)):(i="getMyGroupChannelChangeLogsByTimestamp",u.unshift((new Date).getTime()-100)),l.default.call(i),(a=t.sb)[i].apply(a,u.concat([function(r,a){if(t.sb.getErrorFirstCallback()){var i=r;r=a,a=i}if(a)t.isFetchingChangeLog=!1;else{l.default.sync("updated",r.updatedChannels&&r.updatedChannels.length>0?"\n"+r.updatedChannels.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n"):[]),l.default.sync("deleted",r.deletedChannelUrls);var u=[];r.updatedChannels.forEach(function(e){u.push(new Promise(function(n,r){d.channelContainer.getItem(e.url).then(function(a){d.channelContainer.upsert(e).then(function(e){var r=!a||!a.isEqual(e),i=(!a||a.hiddenState===t.sb.GroupChannel.HiddenState.UNHIDDEN)&&e.hiddenState!==t.sb.GroupChannel.HiddenState.UNHIDDEN,s=(!a||a.hiddenState!==t.sb.GroupChannel.HiddenState.UNHIDDEN)&&e.hiddenState===t.sb.GroupChannel.HiddenState.UNHIDDEN,u=r?"update":"noop";i?u="hide":s&&(u="unhide"),n({action:u,channel:e})}).catch(r)}).catch(r)}))}),r.deletedChannelUrls.forEach(function(e){u.push(new Promise(function(n,t){d.channelContainer.getItem(e).then(function(e){e&&d.channelContainer.remove(e).then(function(){n({action:"remove",channel:e})}).catch(t)}).catch(t)}))}),Promise.all(u).then(function(a){var i=[],u=[],o=[],c=[];for(var l in a)switch(a[l].action){case"update":i.push(a[l].channel);break;case"remove":u.push(a[l].channel);break;case"hide":o.push(a[l].channel);break;case"unhide":c.push(a[l].channel)}i.length>0&&d.broadcast.upsert(i,null,{isChangeLogChannel:!0}),u.length>0&&d.broadcast.remove(u),o.length>0&&d.broadcast.hide(o,null,{isChangeLogChannel:!0}),c.length>0&&d.broadcast.unhide(c,null,{isChangeLogChannel:!0}),s.UserPreference.set("channel-changeLog-token",r.token).then(function(){r.hasMore?t.syncChangeLog(e,n):(t.isFetchingChangeLog=!1,n())}).catch(function(e){t.isFetchingChangeLog=!1,n(e)})}).catch(function(e){return n(e)})}}]))}).catch(function(e){t.isFetchingChangeLog=!1,n(e)})}}},{key:"start",value:function(){d.broadcast.resume()}},{key:"stop",value:function(){d.broadcast.pause()}},{key:"clearCache",value:function(){return new Promise(function(e,n){d.channelSyncByFilter={},d.changeLogSync=null;var t=[];t.push(d.channelContainer.clear()),t.push(d.queryContainer.clear()),s.UserPreference.keys.forEach(function(e){e.startsWith("channel-changeLog-token")&&t.push(s.UserPreference.remove(e))}),Promise.all(t).then(function(){return e()}).catch(function(e){l.default.error(e),n(e)})})}},{key:"reset",value:function(){return d.broadcast.clear(),d.clearCache()}}],[{key:"getInstance",value:function(){return d}},{key:"clear",value:function(){d&&d.sb&&(l.default.message("ChannelManager is cleared"),d.channelSyncByFilter={},d.changeLogSync=null,d.broadcast.clearCollection(),d.sb.removeChannelHandler(f),d=null)}}]),e}();n.default=v},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.getChannelIndex=function(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]).map(function(e){return e.url}).indexOf(e.url)},n.findChannelIndex=function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=null,a=function(e,n){return e>n};switch(n.order){case"latest_last_message":r="lastMessageUpdatedAt";break;case"chronological":r="createdAt";break;case"channel_name_alphabetical":r="name",a=function(e,n){return e.localeCompare(n)<0};break;default:r="lastMessageUpdatedAt"}for(var i=t.length,s=0;s<t.length;s++){var u=t[s];if(e[r]===u[r]&&e.url===u.url){i=s;break}if(a(e[r],u[r])){i=s;break}}return i},n.getMessageIndex=function(e){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],t=0;t<n.length;t++)if(e.isIdentical(n[t]))return t;return-1},n.findMessageIndex=function(e){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],t=n.length,r=0;r<n.length;r++)if(n[r].createdAt>=e.createdAt){t=r;break}return t};n.deepEqual=function e(n,t){var a=void 0===n?"undefined":r(n),i=void 0===t?"undefined":r(t);return!n||!t||"object"!==a||a!==i||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===a&&"function"===i||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(r){return e(n[r],t[r])})},n.createUUID=function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?t:3&t|8).toString(16)})},n.promisify=function(e,n){if(!n)return new Promise(function(n,t){e(function(e){return e?t(e):n()})});e(n)}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.deepEqual=function e(n,t){var a=void 0===n?"undefined":r(n),i=void 0===t?"undefined":r(t);return!n||!t||"object"!==a||a!==i||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===a&&"function"===i||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(r){return e(n[r],t[r])})}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=window.localStorage;n.UserPreference=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e)}return r(e,null,[{key:"get",value:function(e){return new Promise(function(n){var t=a.getItem(e);n(void 0!==t?t:null)})}},{key:"set",value:function(e,n){return new Promise(function(t){a.setItem(e,n),t()})}},{key:"remove",value:function(e){return new Promise(function(n){a.removeItem(e),n()})}},{key:"clear",value:function(){return new Promise(function(e){a.clear(),e()})}},{key:"keys",get:function(){var e=[];for(var n in a)e.push(n);return e}}]),e}()},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=t(18),i=t(9),s=t(7),u=t(19),o=l(t(1)),c=l(t(0));function l(e){return e&&e.__esModule?e:{default:e}}var h="syncManager_messageManager_channelHandler_"+(new Date).getTime(),f=null,d=function(){function e(n){var t=n.sendBird,r=n.db;if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),!f){c.default.call("MessageManager()"),f=this;var s=this.sb=t;this.messageContainer=new a.MessageContainer(r,s),this.chunkContainer=new i.MessageChunkContainer(r),this.broadcast=new u.MessageBroadcast,this.isFetchingChangeLogByChannelUrl={};var l=new s.ChannelHandler;Object.keys(l).forEach(function(e){l[e]=function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];switch(e){case"onMessageReceived":c.default.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!0,f.messageContainer.upsert(t[1]).then(function(e){return f.broadcast.upsert([e])}).catch(function(e){return o.default.throw(e)});break;case"onReadReceiptUpdated":c.default.event(e,t[0].url);var a=t[0];f.broadcast.read(a);break;case"onMessageUpdated":c.default.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!1,f.messageContainer.upsert(t[1]).then(function(e){return f.broadcast.update([e])}).catch(function(e){return o.default.throw(e)});break;case"onMessageDeleted":c.default.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message);var i=parseInt(t[1]);f.messageContainer.remove(i).then(function(){return f.broadcast.remove([i])}).catch(function(e){return o.default.throw(e)})}}}),s.addChannelHandler(h,l)}return f}return r(e,[{key:"syncChangeLog",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};if(this.isFetchingChangeLogByChannelUrl[e.url])t(o.default.create(o.default.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLogByChannelUrl[e.url]=!0,c.default.call("message syncChangeLog()",e.url);var r="last-changeLog-token-"+e.url;s.UserPreference.get(r).then(function(a){var i="getMessageChangeLogsByToken",u=[];a?(i="getMessageChangeLogsByToken",u.unshift(a)):(i="getMessageChangeLogsByTimestamp",u.unshift((new Date).getTime()-100)),c.default.call(i),e[i].apply(e,u.concat([function(a,i){if(n.sb.getErrorFirstCallback()){var u=a;a=i,i=u}i?n.isFetchingChangeLogByChannelUrl[e.url]=!1:(c.default.sync("updated",a.updatedMessages.map(function(e){return e.messageId})),c.default.sync("deleted",a.deletedMessageIds),a.updatedMessages.forEach(function(e){f.messageContainer.getItemWithVisibility(e.messageId).then(function(n){var t=n.item;e.isVisible=n.isVisible||!1,f.messageContainer.upsert(e).then(function(e){(!t||!t.isEqual(e))&&f.broadcast.update([e])}).catch(function(e){return o.default.throw(e)})})}),a.deletedMessageIds.forEach(function(e){f.messageContainer.remove(e).then(function(){return f.broadcast.remove([e])}).catch(function(e){return o.default.throw(e)})}),s.UserPreference.set(r,a.token).then(function(){a.hasMore?n.syncChangeLog(e,t):(n.isFetchingChangeLogByChannelUrl[e.url]=!1,t())}).catch(function(r){n.isFetchingChangeLogByChannelUrl[e.url]=!1,t(r)}))}]))}).catch(function(r){n.isFetchingChangeLogByChannelUrl[e.url]=!1,t(r)})}}},{key:"start",value:function(){f.broadcast.resume()}},{key:"stop",value:function(){f.broadcast.pause()}},{key:"clearCache",value:function(){return new Promise(function(e,n){var t=[];t.push(f.messageContainer.clear()),t.push(f.chunkContainer.clear()),s.UserPreference.keys.forEach(function(e){e.startsWith("last-changeLog-token-")&&t.push(s.UserPreference.remove(e))}),Promise.all(t).then(function(){return e()}).catch(function(e){c.default.error(e),n(e)})})}},{key:"reset",value:function(){return f.broadcast.clear(),f.clearCache()}}],[{key:"getInstance",value:function(){return f}},{key:"clear",value:function(){f&&f.sb&&(c.default.message("MessageManager is cleared"),f.broadcast.clearCollection(),f.sb.removeChannelHandler(h),f=null)}}]),e}();n.default=d},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.MessageChunkContainer=n.MessageChunk=void 0;var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=o(t(3)),i=o(t(2)),s=o(t(1)),u=t(5);function o(e){return e&&e.__esModule?e:{default:e}}var c={},l=function(e){var n=[];for(var t in e)n.push(t+"="+e[t]);return n.join("&")},h=n.MessageChunk=function(){function e(n,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.chunkId=(0,u.createUUID)(),this.channelUrl=n,this.filterKey=l(t),this.filter=t,this.startAt=(new Date).getTime(),this.endAt=0}return r(e,[{key:"hasDefaultFilter",value:function(){var n=e.getDefaultFilter();return(0,u.deepEqual)(this.filter,n)}},{key:"isOverlap",value:function(e){return e.startAt<=this.startAt&&this.startAt<=e.endAt||e.startAt<=this.endAt&&this.endAt<=e.endAt}},{key:"isSame",value:function(e){return e.startAt===this.startAt&&this.endAt===e.endAt}},{key:"contains",value:function(e){return this.startAt<=e&&e<=this.endAt}},{key:"containsMessage",value:function(e){return this.contains(e.createdAt)}},{key:"serialize",value:function(){var e=JSON.parse(JSON.stringify(this));return Object.freeze(e)}},{key:"extendForward",value:function(e){this.endAt=Math.max(this.endAt,e)}},{key:"extendBackward",value:function(e){this.startAt=Math.min(this.startAt,e)}},{key:"extendWithChunk",value:function(e){return this.extendForwardWithChunk(e),this.extendBackwardWithChunk(e),this}},{key:"extendForwardWithChunk",value:function(e){return this.extendForward(e.endAt),this}},{key:"extendBackwardWithChunk",value:function(e){return this.extendBackward(e.startAt),this}},{key:"extendWithMessage",value:function(e){return this.extendForwardWithMessage(e),this.extendBackwardWithMessage(e),this}},{key:"extendForwardWithMessage",value:function(e){return this.extendForward(e.createdAt),this}},{key:"extendBackwardWithMessage",value:function(e){return this.extendBackward(e.createdAt),this}}],[{key:"createFromJson",value:function(n){var t=new e(n.channelUrl,n.filter);return t.chunkId=n.chunkId,t.startAt=n.startAt,t.endAt=n.endAt,t}},{key:"getDefaultFilter",value:function(){return{messageTypeFilter:null,customTypeFilter:null,senderUserIdsFilter:[],includeMetaArray:!1}}}]),e}();n.MessageChunkContainer=function(e){var n=this,t=e.collection("MessageChunk");return this.reload=function(e){return t.findById(e.chunkId)},this.upsert=function(e){return new Promise(function(n,r){(function(e){return new Promise(function(n,r){var a=i.default.getInstance();a.currentUserId?(e.ownerUserId=a.currentUserId,c[e.chunkId]=e,t.upsert(c[e.chunkId].serialize()).then(n).catch(r)):r(s.default.create(s.default.Type.ERROR_SETUP_MISSING))})})(e).then(function(e){return n(h.createFromJson(e))}).catch(r)})},this.remove=function(e){return new Promise(function(n,r){(function(e){return new Promise(function(n,r){i.default.getInstance().currentUserId?(c[e]&&delete c[e],t.remove(e).then(n).catch(r)):r(s.default.create(s.default.Type.ERROR_SETUP_MISSING))})})(e).then(function(){return n(e)}).catch(r)})},this.clear=function(){return c={},t.clear()},this.getChunkByTimestamp=function(e,r,u){return new Promise(function(o,c){var f=i.default.getInstance();if(f.currentUserId){var d=new a.default.Query({ownerUserId:f.currentUserId,channelUrl:e,filterKey:l(r),startAt:{"<=":u},endAt:{">=":u}});d.limit=1,d.orderBy=["ownerUserId","channelUrl","filterKey","endAt"],d.desc=!0,t.find(d).then(function(r){var i=r.length>0?h.createFromJson(r[0]):null;if(i)if(i.hasDefaultFilter())o(i);else{var s=new a.default.Query({channelUrl:e,filterKey:l(h.getDefaultFilter()),startAt:{"<=":u}});s.limit=1,s.orderBy=["ownerUserId","channelUrl","filterKey","endAt"],s.desc=!0,t.find(s).then(function(e){var t=e.length>0?h.createFromJson(e[0]):null;if(t)if(t.endAt>i.endAt)if(t.isOverlap(i))i.extendWithChunk(t),n.upsert(i).then(o).catch(c);else{var r=new h(i.channelUrl,i.filter);r.startAt=t.startAt,r.endAt=t.endAt,n.upsert(r).then(o).catch(c)}else o(i);else o(i)}).catch(c)}else o(null)}).catch(c)}else c(s.default.create(s.default.Type.ERROR_SETUP_MISSING))})},this.mergePreviousChunkOverlap=function(e){return new Promise(function(r,u){var o=i.default.getInstance();if(o.currentUserId){var c=new a.default.Query({ownerUserId:o.currentUserId,chunkId:{"!=":e.chunkId},channelUrl:e.channelUrl,filterKey:e.filterKey,endAt:{">=":e.startAt}});c.limit=1/0,t.find(c).then(function(i){if(i.length>0){var s=new a.default.Query({chunkId:{"/in":i.map(function(e){return e.chunkId})}});t.removeIf(s).then(function(){for(var t in i)e.extendWithChunk(i[t]);n.upsert(e).then(r).catch(u)}).catch(u)}else n.upsert(e).then(r).catch(u)}).catch(u)}else u(s.default.create(s.default.Type.ERROR_SETUP_MISSING))})},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=6e4,i=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.locked=!1,this.lockedAt=(new Date).getTime()+a}return r(e,[{key:"isLocked",value:function(){return this.locked}},{key:"lock",value:function(e){var n=this;this.locked?setTimeout(function(){(new Date).getTime()-n.lockedAt<a&&n.lock(e)},200):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(function(){return n.unlock()}))}},{key:"unlock",value:function(){this.locked=!1,this.lockedAt=(new Date).getTime()+a}}]),e}();n.default=i},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.BackgroundSync=void 0;var r,a=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),i=t(0),s=(r=i)&&r.__esModule?r:{default:r};n.BackgroundSync=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.worker=n,this.state=e.State.PAUSED,this.isLoading=!1,this.shared=0,this.retry=0,this.retryLimit=3,this.subscribes={}}return a(e,[{key:"start",value:function(n){var t=this;(arguments.length>1&&void 0!==arguments[1]&&arguments[1]||this.state!==e.State.END)&&(this.isLoading||(this.isLoading=!0,this.state=e.State.RUNNING,this.worker(n,function(r,a){s.default.sync("background sync result: err=",r,"res=",a),r?(t.isLoading=!1,t.retry<t.retryLimit?(t.retry++,t.start(n)):t.state=e.State.PAUSED):(t.retry=0,t.isLoading=!1,t.flush(r,a),t.state===e.State.RUNNING&&(a.hasMore?t.start(a.nextTs):t.state=e.State.END))})))}},{key:"pause",value:function(){this.isLoading=!1,this.state=e.State.PAUSED}},{key:"end",value:function(){this.isLoading=!1,this.state=e.State.END}},{key:"flush",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments[1];for(var t in s.default.sync("background sync flush:",Object.keys(this.subscribes).length+" subscribes"),this.subscribes)this.subscribes[t](e,n);this.subscribes={}}},{key:"subscribe",value:function(e,n){return!this.subscribes[e]&&(this.subscribes[e]=n,!0)}}],[{key:"State",get:function(){return{RUNNING:"running",PAUSED:"paused",END:"end"}}}]),e}()},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.ChannelCollectionHandler=function(){this.onChannelEvent=function(e,n){}},n.MessageCollectionHandler=function(){this.onMessageEvent=function(e,n){}},n.ChannelEventAction={INSERT:"insert",UPDATE:"update",MOVE:"move",REMOVE:"remove",CLEAR:"clear"},n.MessageEventAction={INSERT:"insert",UPDATE:"update",REMOVE:"remove",CLEAR:"clear"}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r,a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),s=t(3),u=(r=s)&&r.__esModule?r:{default:r},o=t(6);var c=new WeakMap,l=function(){function e(n,t,r){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=t,this.keyPath=r,c.set(this,n)}return i(e,[{key:"findById",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){var i=t.transaction(n.name,"readonly").objectStore(n.name).get(e);i.onsuccess=function(){r(i.result||null)},i.onerror=function(){a(i.error)}})}},{key:"find",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){if(e instanceof u.default.Query){var i=null;"string"==typeof e.orderBy?i=e.orderBy:Array.isArray(e.orderBy)&&(i=e.orderBy.join("_"));var s=[],o=t.transaction(n.name,"readonly").objectStore(n.name),c=i?o.index(i).openCursor(null,e.desc?"prev":"next"):o.openCursor(),l=e.offset;c.onsuccess=function(n){var t=n.target.result;if(t)if(!l||l<0){var a=t.value;e.match(a)?(s.push(a),s.length<e.limit?t.continue():r(s)):t.continue()}else l--,t.continue();else r(s)},c.onerror=function(){a(c.error)}}else a(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"count",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){if(!e||e instanceof u.default.Query){var i=t.transaction(n.name,"readonly").objectStore(n.name);if(e){var s=0,o=i.openCursor();o.onsuccess=function(){var n=event.target.result;n?(e.match(n.value)&&s++,n.continue()):r(s)},o.onerror=function(){a(o.error)}}else{var c=i.count();c.onsuccess=function(){r(c.result)},c.onerror=function(){a(c.error)}}}else a(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"insert",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,i){var s=t.transaction(n.name,"readwrite").objectStore(n.name);if(Array.isArray(e))!function(){var n=[],t=function(t){var a=e[t],u=s.add(a);u.onsuccess=function(){n.push(a),n.length===e.length&&r(n)},u.onerror=function(){i(u.error)}};for(var a in e)t(a)}();else if(e&&"object"===(void 0===e?"undefined":a(e))){var u=s.add(e);u.onsuccess=function(){r(e)},u.onerror=function(){i(u.error)}}else i(new Error("Invalid type: 'item' should be an object or an object array."))})}},{key:"upsert",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,i){var s=t.transaction(n.name,"readwrite").objectStore(n.name);if(e&&"object"===(void 0===e?"undefined":a(e))){var u=s.get(e[n.keyPath]);u.onsuccess=function(){if(u.result){var n=s.put(e);n.onsuccess=function(){return r(e)},n.onerror=function(){return i(n.error)}}else{var t=s.add(e);t.onsuccess=function(){return r(e)},t.onerror=function(){return i(t.error)}}},u.onerror=function(){i(u.error)}}else i(new Error("Invalid type: 'item' should be an object or an object array."))})}},{key:"update",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){var i=t.transaction(n.name,"readwrite").objectStore(n.name).put(e);i.onsuccess=function(){r(e)},i.onerror=function(){a(i.error)}})}},{key:"updateIf",value:function(e,n){var t=this,r=c.get(this);return new Promise(function(a,i){if(e instanceof u.default.Query){var s=[],c=r.transaction(t.name,"readwrite").objectStore(t.name),l=c.openCursor();l.onsuccess=function(t){var r=t.target.result;if(r){var u=r.value;if(e.match(u)){var l=!1;for(var h in n){var f=n[h];(0,o.deepEqual)(u[h],f)||(l=!0,u[h]=f)}if(l){var d=c.put(u);d.onsuccess=function(){s.push(u),r.continue()},d.onerror=function(){i(d.error)}}else r.continue()}else r.continue()}else a(s)},l.onerror=function(){i(l.error)}}else i(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"remove",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){var i=t.transaction(n.name,"readwrite").objectStore(n.name).delete(e);i.onsuccess=function(){r()},i.onerror=function(){a(i.error)}})}},{key:"removeIf",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){if(e instanceof u.default.Query){var i=[],s=t.transaction(n.name,"readwrite").objectStore(n.name),o=s.openCursor();o.onsuccess=function(t){var u=t.target.result;if(u){var o=u.value;if(e.match(o)){var c=s.delete(o[n.keyPath]);c.onsuccess=function(){i.push(o),u.continue()},c.onerror=function(){a(c.error)}}else u.continue()}else r(i)},o.onerror=function(){a(o.error)}}else a(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"clear",value:function(){var e=this,n=c.get(this);return new Promise(function(t,r){var a=n.transaction(e.name,"readwrite").objectStore(e.name).clear();a.onsuccess=function(){t()},a.onerror=function(){r(a.error)}})}}]),e}();n.default=l},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=t(6);var s=1/0,u=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.condition=n,this.offset=0,this.limit=s,this.orderBy=null,this.desc=!1}return r(e,null,[{key:"and",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];return t.length>0?new e({"/and":t}):new e({})}},{key:"or",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];return t.length>0?new e({"/or":t}):new e({})}}]),r(e,[{key:"match",value:function(e){return function e(n,t){var r=!0;for(var s in t){switch(s){case"/and":r=r&&t[s].reduce(function(t,r){return t&&e(n,r)},!0);break;case"/or":r=r&&t[s].reduce(function(t,r){return t||e(n,r)},!1);break;default:var u=t[s];if("object"===(void 0===u?"undefined":a(u)))for(var o in u)switch(o){case">":r="number"==typeof n[s]&&"number"==typeof u[o]?r&&n[s]>u[o]:"string"==typeof n[s]&&"string"==typeof u[o]&&r&&n[s].localeCompare(u[o])>0;break;case">=":r="number"==typeof n[s]&&"number"==typeof u[o]?r&&n[s]>=u[o]:"string"==typeof n[s]&&"string"==typeof u[o]&&r&&n[s].localeCompare(u[o])>=0;break;case"<":r="number"==typeof n[s]&&"number"==typeof u[o]?r&&n[s]<u[o]:"string"==typeof n[s]&&"string"==typeof u[o]&&r&&n[s].localeCompare(u[o])<0;break;case"<=":r="number"==typeof n[s]&&"number"==typeof u[o]?r&&n[s]<=u[o]:"string"==typeof n[s]&&"string"==typeof u[o]&&r&&n[s].localeCompare(u[o])<=0;break;case"=":r=r&&n[s]===u[o];break;case"!=":r=r&&n[s]!==u[o];break;case"/in":r=r&&Array.isArray(u[o])&&u[o].indexOf(n[s])>=0;break;case"/nin":r=r&&Array.isArray(u[o])&&u[o].indexOf(n[s])<0;break;case"/like":r=r&&"string"==typeof u[o]&&"string"==typeof n[s]&&n[s].indexOf(u[o])>=0;break;case"/regex":r=r&&u[o]instanceof RegExp&&u[o].test(n[s]);break;case"/where":r=r&&u[o](n[s]);break;default:r=r&&(0,i.deepEqual)(n[s],u)}else r=r&&n[s]===u}if(!r)break}return r}(e,this.condition)}}]),e}();n.default=u},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelContainer=void 0;var r=u(t(3)),a=u(t(2)),i=u(t(1)),s=u(t(0));function u(e){return e&&e.__esModule?e:{default:e}}n.ChannelContainer=function(e,n){var t=this,u=e.collection("GroupChannel"),o=function(e){return new Promise(function(n,t){var r=a.default.getInstance();r.currentUserId?(e.ownerUserId=r.currentUserId,e.lastMessageUpdatedAt=e.lastMessage?e.lastMessage.createdAt:e.createdAt,s.default.cache("upsert channel","url="+e.url,"name="+e.name,"createdAt="+e.createdAt,"lastMessageUpdatedAt="+e.lastMessageUpdatedAt),u.upsert(e.serialize()).then(n).catch(t)):t(i.default.create(i.default.Type.ERROR_SETUP_MISSING))})},c=function(e){if(e){var t=n.GroupChannel.buildFromSerializedData(e);return t.lastMessageUpdatedAt=t.lastMessage?t.lastMessage.createdAt:t.createdAt,t}return null};return this.query=function(e,n){return new Promise(function(t,s){var o=a.default.getInstance();if(o.currentUserId){e.ownerUserId=o.currentUserId;var l=new r.default.Query(e);n&&(l.offset=n.offset||0,l.limit=n.limit||20,l.orderBy=["ownerUserId",n.orderBy||"lastMessageUpdatedAt"],l.desc=!n.hasOwnProperty("desc")||n.desc),u.find(l).then(function(e){var n=[];for(var r in e){var a=c(e[r]);n.push(a)}t(n)}).catch(s)}else s(i.default.create(i.default.Type.ERROR_SETUP_MISSING))})},this.insert=function(e){return new Promise(function(n,r){t.getItem(e.url).then(function(t){t?n(e):o(e).then(function(){return n(e)}).catch(r)}).catch(r)})},this.upsert=function(e){return new Promise(function(n,t){o(e).then(function(e){return n(c(e))}).catch(t)})},this.remove=function(n){return new Promise(function(t,o){(function(n){return new Promise(function(t,o){var c=a.default.getInstance();c.currentUserId?(s.default.cache("remove channel",n.url),u.remove(n.url).then(function(a){var i=new r.default.Query({ownerUserId:c.currentUserId,channelUrl:n.url});e.collection("MessageChunk").removeIf(i).then(function(){e.collection("Message").removeIf(i).then(function(){t(a)}).catch(o)}).catch(o)}).catch(o)):o(i.default.create(i.default.Type.ERROR_SETUP_MISSING))})})(n).then(function(e){return t(c(e))}).catch(o)})},this.getItem=function(e){return new Promise(function(n,t){u.findById(e).then(function(e){return n(c(e))}).catch(t)})},this.clear=function(){return new Promise(function(n,t){s.default.cache("clear channel"),u.clear().then(function(){e.collection("MessageChunk").clear().then(function(){e.collection("Message").clear().then(n).catch(t)}).catch(t)}).catch(t)})},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelListQueryContainer=void 0;var r=s(t(2)),a=s(t(1)),i=s(t(0));function s(e){return e&&e.__esModule?e:{default:e}}var u={};n.ChannelListQueryContainer=function(e,n){var t=this,s=e.collection("GroupChannelListQuery"),o=function(e){if(e){var t=n.GroupChannel.createMyGroupChannelListQuery();for(var r in e)t.hasOwnProperty(r)&&(t[r]=e[r]);return t.filterKey=e.filterKey,t.ownerUserId=e.currentUserId,t.updatedAt=e.updatedAt,t.savepoint=e.savepoint,t}return null};return this.createFilterKey=function(e){var n=[];return n.push("order="+e.order),n.push("includeEmpty="+e.includeEmpty),n.push("customTypesFilter="+e.customTypesFilter.sort().join(",")),n.join("&")},this.upsert=function(e){return new Promise(function(n,c){(function(e){return e.filterKey=t.createFilterKey(e),new Promise(function(n,t){var o=r.default.getInstance();if(o.currentUserId){i.default.cache("upsert channel list query",e.filterKey),e.ownerUserId=o.currentUserId,e.updatedAt=(new Date).getTime(),e.savepoint||(e.savepoint="");var c=JSON.parse(JSON.stringify(e));s.upsert(c).then(function(t){if(u[e.filterKey])for(var r in e)u[e.filterKey].hasOwnProperty(r)&&(u[e.filterKey][r]=e[r]);else u[e.filterKey]=e;n(t)}).catch(t)}else t(a.default.create(a.default.Type.ERROR_SETUP_MISSING))})})(e).then(function(e){return n(o(e))}).catch(c)})},this.remove=function(e){return new Promise(function(n,t){(function(e){return new Promise(function(n,t){r.default.getInstance().currentUserId?(i.default.cache("remove channel list query",e.filterKey),s.remove(e.filterKey).then(function(t){u[e.filterKey]&&delete u[e.filterKey],n(t)}).catch(t)):t(a.default.create(a.default.Type.ERROR_SETUP_MISSING))})})(e).then(function(e){return n(o(e))}).catch(t)})},this.getItem=function(e){return new Promise(function(n,t){u[e]?n(u[e]):s.findById(e).then(function(e){return n(o(e))}).catch(t)})},this.clear=function(){return new Promise(function(e,n){i.default.cache("clear channel list query"),u={},s.clear().then(e).catch(n)})},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelBroadcast=void 0;var r,a=t(4),i=(r=a)&&r.__esModule?r:{default:r};function s(e,n){var t=i.default.getInstance().sb,r=!0;if(e.isGroupChannel()&&!e.isSuper){if(!n.includeEmpty&&!e.lastMessage)return!1;if(n.nicknameContainsFilter){var a=!1;for(var s in e.members)if(e.members[s].nickname.indexOf(n.nicknameContainsFilter)>=0){a=!0;break}if(!a)return!1}if(n.userIdsFilter.length>0){var u=!1,o=e.members.map(function(e){return e.userId}),c=n.userIdsFilterExactMatch,l=n.queryType;if(c?u=o.length===n.userIdsFilter.length&&n.userIdsFilter.every(function(e){return o.indexOf(e)>=0}):"AND"===l?u=n.userIdsFilter.every(function(e){return o.indexOf(e)>=0}):"OR"===l&&(u=n.userIdsFilter.reduce(function(e,n){return e||o.indexOf(n)>=0},!1)),!u)return!1}}if(n.channelNameContainsFilter&&(r=r&&e.name.indexOf(n.channelNameContainsFilter)>=0),n.channelUrlsFilter.length>0&&(r=r&&n.channelUrlsFilter.indexOf(e.url)>=0),n.memberStateFilter!==t.GroupChannel.memberStateFilter.ALL)switch(n.memberStateFilter){case t.GroupChannel.memberStateFilter.JOINED:r=r&&e.myMemberState===t.GroupChannel.memberStateFilter.JOINED;break;case t.GroupChannel.memberStateFilter.INVITED:case t.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case t.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:r=r&&e.myMemberState===t.GroupChannel.memberStateFilter.INVITED}if(n.customTypesFilter.length>0&&(r=r&&n.customTypesFilter.indexOf(e.customType)>=0),n.customTypeStartsWithFilter&&(r=r&&e.customType.startsWith(n.customTypeStartsWithFilter)),n.superChannelFilter!==t.GroupChannel.superChannelFilter.ALL)switch(n.superChannelFilter){case t.GroupChannel.superChannelFilter.SUPER:r=r&&e.isSuper;break;case t.GroupChannel.superChannelFilter.NONSUPER:r=r&&!e.isSuper}if(n.publicChannelFilter!==t.GroupChannel.publicChannelFilter.ALL)switch(n.publicChannelFilter){case t.GroupChannel.publicChannelFilter.PUBLIC:r=r&&e.isPublic;break;case t.GroupChannel.publicChannelFilter.PRIVATE:r=r&&!e.isPublic}if(n.unreadChannelFilter!=t.GroupChannel.UnreadChannelFilter.ALL)switch(n.unreadChannelFilter){case t.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:r=r&&e.unreadMessageCount>0}return r}n.ChannelBroadcast=function(){var e=[];return this.addCollection=function(n,t){e.indexOf(n)<0&&e.push({controller:n,view:t})},this.removeCollection=function(n){var t=e.map(function(e){return e.controller}).indexOf(n);t>=0&&(e[t].controller._pause(),e.splice(t,1))},this.clearCollection=function(){for(var n in e)e[n].controller._pause();e=[]},this.pause=function(){for(var n in e)e[n].controller._pause()},this.resume=function(){for(var n in e)e[n].controller._resume()},this.upsert=function(n,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};for(var a in e){var i=e[a];if(i.controller!==t){var u=[];for(var o in n){var c=n[o];s(c,i.controller.query)&&u.push(c)}u.length>0&&(r.isEventChannel=!0,i.view.addViewItems(u,r))}}},this.update=function(n,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};for(var a in e){var i=e[a];if(i.controller!==t){var u=[];for(var o in n){var c=n[o];s(c,i.controller.query)&&i.view.channels.map(function(e){return e.url}).indexOf(c.url)>=0&&u.push(c)}u.length>0&&(r.isEventChannel=!0,i.view.addViewItems(u,r))}}},this.remove=function(n,t){for(var r in e){var a=e[r];if(a.controller!==t){var i=[];for(var s in n){var u=n[s];a.view.channels.map(function(e){return e.url}).indexOf(u.url)>=0&&i.push(u)}i.length>0&&a.view.removeViewItems(i)}}},this.hide=function(n,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=i.default.getInstance().sb;for(var u in e){var o=e[u];if(o.controller!==t){var c=[];for(var l in n){var h=n[l];s(h,o.controller.query)&&c.push(h)}if(c.length>0)switch(o.controller.query.hiddenChannelFilter){case a.GroupChannel.HiddenChannelFilter.UNHIDDEN:o.view.removeViewItems(c);break;case a.GroupChannel.HiddenChannelFilter.HIDDEN:case a.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case a.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:r.isEventChannel=!0,o.view.addViewItems(c,r)}}}},this.unhide=function(n,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=i.default.getInstance().sb;for(var u in e){var o=e[u];if(o.controller!==t){var c=[];for(var l in n){var h=n[l];s(h,o.controller.query)&&c.push(h)}if(c.length>0)switch(o.controller.query.hiddenChannelFilter){case a.GroupChannel.HiddenChannelFilter.UNHIDDEN:r.isEventChannel=!0,o.view.addViewItems(c,r);break;case a.GroupChannel.HiddenChannelFilter.HIDDEN:case a.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case a.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:o.view.removeViewItems(c)}}}},this.clear=function(){for(var n in e){e[n].view.clearViewItem()}},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.MessageContainer=void 0;var r=u(t(3)),a=u(t(2)),i=u(t(1)),s=u(t(0));function u(e){return e&&e.__esModule?e:{default:e}}n.MessageContainer=function(e,n){var t=this,u=e.collection("Message"),o=function(e){return new Promise(function(n,t){var r=a.default.getInstance();e.messageId?r.currentUserId?(e.hasOwnProperty("isVisible")||(e.isVisible=!0),e.hasOwnProperty("isDeleted")||(e.isDeleted=!1),e.ownerUserId=r.currentUserId,s.default.cache("upsert message",e.messageId,e.createdAt,"owner="+e.ownerUserId,"visible="+e.isVisible,"deleted="+e.isDeleted),u.findById(e.messageId).then(function(r){r?r.isDeleted?n(r):(e.isVisible=e.isVisible||r.isVisible,u.upsert(e.serialize()).then(n).catch(t)):u.upsert(e.serialize()).then(n).catch(t)}).catch(function(e){return t(e)})):t(i.default.create(i.default.Type.ERROR_SETUP_MISSING)):n(e)})},c=function(e){var t=null;return e&&("user"===e.messageType?t=n.UserMessage.buildFromSerializedData(e):"file"===e.messageType?t=n.FileMessage.buildFromSerializedData(e):"admin"===e.messageType&&(t=n.AdminMessage.buildFromSerializedData(e))),t};return this.query=function(e,n){return e.isVisible=!0,e.isDeleted=!1,new Promise(function(t,s){var o=a.default.getInstance();if(o.currentUserId){e.ownerUserId=o.currentUserId;var l=new r.default.Query(e);n&&(l.offset=n.offset||0,l.limit=n.limit||1/0,l.orderBy=["ownerUserId","channelUrl",n.orderBy||"createdAt"],l.desc=!n.hasOwnProperty("desc")||n.desc),u.find(l).then(function(e){var n=[];for(var r in e){var a=c(e[r]);n.push(a)}t(n)}).catch(s)}else s(i.default.create(i.default.Type.ERROR_SETUP_MISSING))})},this.upsert=function(e){return new Promise(function(n,t){o(e).then(function(e){return n(c(e))}).catch(t)})},this.remove=function(e){var n={messageId:e,isVisible:!1,isDeleted:!0,serialize:function(){return{messageId:e,isVisible:!1,isDeleted:!0}}};return new Promise(function(t,r){o(n).then(function(){return t(e)}).catch(r)})},this.getItemWithVisibility=function(e){return new Promise(function(n,t){u.findById(e).then(function(e){return n({item:c(e),isVisible:!!e&&e.isVisible})}).catch(t)})},this.getItem=function(e){return new Promise(function(n,t){u.findById(e).then(function(e){return n(c(e))}).catch(t)})},this.clear=function(){return s.default.cache("clear messages"),u.clear()},this.loadChunkMessages=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={channelUrl:e.channelUrl,createdAt:{">=":e.startAt,"<=":e.endAt}};return e.filter.messageType&&(r.messageType=e.filter.messageType),e.filter.customType&&(r.customType=e.filter.customType),e.filter.senderUserIds&&e.filter.senderUserIds.length>0&&(r["sender.userId"]={"/in":e.filter.senderUserIds}),t.query(r,n)},this.loadRangeMessages=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2],a=arguments[3],i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(r>a){var s=r;r=a,a=s}var u={channelUrl:e,createdAt:{">=":r,"<=":a}};return n.messageType&&(u.messageType=n.messageType),n.customType&&(u.customType=n.customType),n.senderUserIds&&n.senderUserIds.length>0&&(u["sender.userId"]={"/in":n.senderUserIds}),t.query(u,i)},this.loadPreviousMessages=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(new Date).getTime(),a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i={channelUrl:e,createdAt:{"<=":r}};return n.messageType&&(i.messageType=n.messageType),n.customType&&(i.customType=n.customType),n.senderUserIds&&n.senderUserIds.length>0&&(i["sender.userId"]={"/in":n.senderUserIds}),a.desc=!0,t.query(i,a)},this.loadNextMessages=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i={channelUrl:e,createdAt:{">=":r}};return n.messageType&&(i.messageType=n.messageType),n.customType&&(i.customType=n.customType),n.senderUserIds&&n.senderUserIds.length>0&&(i["sender.userId"]={"/in":n.senderUserIds}),a.desc=!1,t.query(i,a)},this}},function(e,n,t){"use strict";function r(e,n,t){return t?n.channelUrl===e.url&&((!t.messageType||t.messageType===n.messageType)&&((!t.customType||t.customType===n.customType)&&!(Array.isArray(t.senderUserIds)&&t.senderUserIds.length>0&&n.sender&&t.senderUserIds.indexOf(n.sender.userId)<0))):n.channelUrl===e.url}Object.defineProperty(n,"__esModule",{value:!0});n.MessageBroadcast=function(){var e=[];return this.addCollection=function(n,t){e.push({controller:n,view:t})},this.removeCollection=function(n){var t=e.map(function(e){return e.controller}).indexOf(n);t>=0&&(e[t].controller._pause(),e.splice(t,1))},this.clearCollection=function(){for(var n in e)e[n].controller._pause();e=[]},this.pause=function(){for(var n in e)e[n].controller._pause()},this.resume=function(){for(var n in e)e[n].controller._resume()},this.upsert=function(n,t){for(var a in e){var i=e[a];if(i.controller!==t){var s=[];for(var u in n){var o=n[u];r(i.controller.channel,o,i.controller.filter)&&s.push(o)}s.length>0&&i.view.addViewItems(s,{isEventMessage:!0})}}},this.update=function(n,t){for(var a in e){var i=e[a];if(i.controller!==t){var s=[];for(var u in n){var o=n[u];r(i.controller.channel,o,i.controller.filter)&&i.view.messages.map(function(e){return e.messageId}).indexOf(o.messageId)>=0&&s.push(o)}s.length>0&&i.view.addViewItems(s,{isEventMessage:!0})}}},this.read=function(n,t){for(var r in e){var a=e[r];a.controller!==t&&a.controller.channel.url===n.url&&(a.controller.channel=n,a.view.addViewItems(a.view.messages))}},this.remove=function(n,t){for(var r in e){var a=e[r];a.controller!==t&&a.view.removeViewItems(n)}},this.clear=function(){for(var n in e){e[n].view.clearViewItem()}},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelCollection=n.ChannelCollectionViewAdapter=void 0;var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=f(t(10)),i=f(t(4)),s=t(11),u=t(12),o=t(5),c=f(t(1)),l=f(t(0)),h=f(t(2));function f(e){return e&&e.__esModule?e:{default:e}}function d(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var v=new WeakMap,g=new WeakMap,p=new WeakMap,y=new WeakMap,m=new WeakMap,C=function(e){var n=i.default.getInstance();if(n){var t=e.query,r=t.filterKey;return n.channelSyncByFilter[r]||(n.channelSyncByFilter[r]=new s.BackgroundSync(function(r,a){l.default.call("channel syncChannel()",t.filterKey,t.hasNext,t._token),t.hasNext?(t.limit=100,t.next(function(r,i){if(l.default.sync("channel",i,r&&r.length>0?"\n"+r.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n"):""),i)a(i);else{var s=g.get(e),u=[];for(var o in r)u.push(n.channelContainer.insert(r[o]));Promise.all(u).then(function(e){var r=s.findChannelEdges(e);t.savepoint=r.end+"",n.queryContainer.upsert(t).then(function(){a(null,{count:e.length,nextTs:0,hasNext:t.hasNext})}).catch(function(e){a(e)})}).catch(function(e){a(e)})}})):a(null,{count:0,nextTs:0,hasNext:!1})})),n.channelSyncByFilter[r]}return null},b=function(e){var n=i.default.getInstance();if(n){if(!n.changeLogSync){var t=e.query;n.changeLogSync=new s.BackgroundSync(function(e,r){n.syncChangeLog(t,function(e){r(e,{count:0,nextTs:0,hasNext:!1})})})}return n.changeLogSync}return null},I=n.ChannelCollectionViewAdapter=function(){function e(){d(this,e),this.collection=null,this.channels=[],this.mutex=new a.default,this.viewOffset=null}return r(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"compareWithChannel",value:function(e,n){var t="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":t="createdAt";break;case"channel_name_alphabetical":t="name"}return this.compareWithOffset(e,n[t])}},{key:"compareWithOffset",value:function(e,n){switch(this.collection.query.order){case"latest_last_message":return e.lastMessageUpdatedAt-n;case"chronological":return e.createdAt-n;case"channel_name_alphabetical":return n.localeCompare(e.name);default:return e.lastMessageUpdatedAt-n}}},{key:"isAbove",value:function(e,n){return this.compareWithOffset(e,n)>0}},{key:"isBelow",value:function(e,n){return this.compareWithOffset(e,n)<0}},{key:"findChannelEdges",value:function(e){var n="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":n="createdAt";break;case"channel_name_alphabetical":n="name"}var t={start:null,end:null};for(var r in e)t.start&&!this.isAbove(e[r],t.start)||(t.start=e[r][n]),t.end&&!this.isBelow(e[r],t.end)||(t.end=e[r][n]);return t}},{key:"refreshViewOffset",value:function(){var e=this.findChannelEdges(this.channels);this.viewOffset=e.end}},{key:"addViewItems",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=[],a=[],i=[],s=[],c=m.get(this.collection);this.mutex.lock(function(h){for(var f in e){var d=e[f],v=(0,o.getChannelIndex)(d,n.channels),g=(0,o.findChannelIndex)(d,n.collection.query,n.channels),p=!1;t.isEventChannel&&(n.viewOffset?n.isBelow(d,n.viewOffset)&&(p=!0):t.isChangeLogEvent||(n.collection.query.hasNext||n.collection.query.savepoint)&&(p=!0));var y=v<0?u.ChannelEventAction.INSERT:u.ChannelEventAction.UPDATE;switch(v<0?p||(g<n.channels.length?n.channels.splice(g,0,d):n.channels.push(d)):v!==g?g<n.channels.length?(y=u.ChannelEventAction.MOVE,n.channels.splice(v,1),g>v?n.channels.splice(g-1,0,d):n.channels.splice(g,0,d)):(y=u.ChannelEventAction.REMOVE,n.channels.splice(v,1)):n.channels[v]=d,y){case u.ChannelEventAction.INSERT:p||r.push(d);break;case u.ChannelEventAction.UPDATE:a.push(d);break;case u.ChannelEventAction.MOVE:i.push(d);break;case u.ChannelEventAction.REMOVE:s.push(d)}}if(n.refreshViewOffset(),r.length>0)for(var m in l.default.view("channel",u.ChannelEventAction.INSERT,"\n"+r.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n")),c)c[m].onChannelEvent(u.ChannelEventAction.INSERT,r);if(a.length>0)for(var C in l.default.view("channel",u.ChannelEventAction.UPDATE,"\n"+a.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n")),c)c[C].onChannelEvent(u.ChannelEventAction.UPDATE,a);if(i.length>0)for(var b in l.default.view("channel",u.ChannelEventAction.MOVE,"\n"+i.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n")),c)c[b].onChannelEvent(u.ChannelEventAction.MOVE,i);if(s.length>0)for(var I in l.default.view("channel",u.ChannelEventAction.REMOVE,"\n"+s.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n")),c)c[I].onChannelEvent(u.ChannelEventAction.REMOVE,s);h()})}},{key:"removeViewItems",value:function(e){var n=this,t=m.get(this.collection);this.mutex.lock(function(r){var a=[];for(var i in e){var s=e[i],o=n.channels.map(function(e){return e.url}).indexOf(s.url);o>=0&&(n.channels.splice(o,1),a.push(s))}if(a.length>0)for(var c in l.default.view("channel",u.ChannelEventAction.REMOVE,"\n"+a.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n")),t)t[c].onChannelEvent(u.ChannelEventAction.REMOVE,a);r()})}},{key:"clearViewItem",value:function(){this.channels=[];var e=m.get(this.collection);this.mutex.lock(function(n){var t=u.ChannelEventAction.CLEAR;for(var r in l.default.view("channel",t),e)e[r].onChannelEvent(t);n()})}}]),e}();n.ChannelCollection=function(){function e(n){var t=this;d(this,e);var r=new I,a=i.default.getInstance();if(!a)return null;this.collectionId=(0,o.createUUID)(),this.sendBird=a.sb,this.type="MyGroupChannelListQuery",this.limit=n.limit,this.query=n,this.query.filterKey=a.queryContainer.createFilterKey(this.query),this._isLoading=!1,r.attachCollection(this),a.broadcast.addCollection(this,r),g.set(this,r),v.set(this,a.broadcast),p.set(this,a.channelContainer),y.set(this,a.queryContainer),m.set(this,{}),C(this).shared++,b(this).shared++,a.queryContainer.getItem(this.query.filterKey).then(function(e){e&&(t.query._token=e._token,t.query.hasNext=e.hasNext,t.query.savepoint=e.savepoint,t.query.updatedAt=e.updatedAt),a.queryContainer.upsert(n).then(function(e){t.query=e,t._resume(),l.default.message("channel collection "+t.collectionId+" is created.")}).catch(function(e){return c.default.throw(e)})}).catch(function(e){return c.default.throw(e)})}return r(e,[{key:"_pause",value:function(){l.default.call("channel sync pause",this.collectionId);var e=C(this),n=b(this);e&&e.pause(),n&&n.pause()}},{key:"_resume",value:function(){l.default.call("channel sync resume",this.collectionId);var e=C(this),n=b(this);e&&e.start(),n&&n.start()}},{key:"fetch",value:function(e){var n=this;return(0,o.promisify)(function(e){if(n._isLoading)l.default.error("fetch() is loading"),e(c.default.create(c.default.Type.ERROR_DUPLICATED_FETCH));else{n._isLoading=!0,l.default.call("fetch()");var t=g.get(n),r=p.get(n),a=n.sendBird,i={ownerUserId:h.default.getInstance().currentUserId};if(n.query.includeEmpty||(i.lastMessage={"!=":null}),n.query.nicknameContainsFilter&&(i.members={"/where":function(e){for(var t in e)if(e[t].nickname.indexOf(n.query.nicknameContainsFilter)>=0)return!0;return!1}}),n.query.userIdsFilter.length>0&&(i.members={"/where":function(e){var t=e.map(function(e){return e.userId});return n.query.userIdsFilterExactMatch?t.length===n.query.userIdsFilter.length&&n.query.userIdsFilter.every(function(e){return t.indexOf(e)>=0}):"AND"===n.query.queryType?n.query.userIdsFilter.every(function(e){return t.indexOf(e)>=0}):"OR"===n.query.queryType&&n.query.userIdsFilter.reduce(function(e,n){return e||t.indexOf(n)>=0},!1)}}),n.query.channelNameContainsFilter&&(i.name={"/regex":new RegExp(n.query.channelNameContainsFilter)}),n.query.channelUrlsFilter.length>0&&(i.url={"/in":n.query.channelUrlsFilter}),n.query.memberStateFilter!==a.GroupChannel.memberStateFilter.ALL)switch(n.query.memberStateFilter){case a.GroupChannel.memberStateFilter.JOINED:i.myMemberState=a.GroupChannel.memberStateFilter.JOINED;break;case a.GroupChannel.memberStateFilter.INVITED:case a.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case a.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:i.myMemberState={"/in":[a.GroupChannel.memberStateFilter.INVITED,a.GroupChannel.memberStateFilter.INVITED_BY_FRIEND,a.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND]}}if("string"==typeof n.query.customTypeFilter&&n.query.customTypeFilter&&(i.customType=n.query.customTypeFilter),Array.isArray(n.query.customTypesFilter)&&n.query.customTypesFilter.length>0&&(i.customType={"/in":n.query.customTypesFilter}),"string"==typeof n.query.customTypeStartsWithFilter&&n.query.customTypeStartsWithFilter&&(i.customType={"/regex":new RegExp("^"+n.query.customTypeStartsWithFilter)}),n.query.superChannelFilter!==a.GroupChannel.superChannelFilter.ALL)switch(n.query.superChannelFilter){case a.GroupChannel.superChannelFilter.SUPER:i.isSuper=!0;break;case a.GroupChannel.superChannelFilter.NONSUPER:i.isSuper=!1}if(n.query.publicChannelFilter!==a.GroupChannel.publicChannelFilter.ALL)switch(n.query.publicChannelFilter){case a.GroupChannel.publicChannelFilter.PUBLIC:i.isPublic=!0;break;case a.GroupChannel.publicChannelFilter.PRIVATE:i.isPublic=!1}if(n.query.unreadChannelFilter!==a.GroupChannel.UnreadChannelFilter.ALL)switch(n.query.unreadChannelFilter){case a.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:i.unreadMessageCount={">":0}}if("all"!=n.query.hiddenChannelFilter)switch(n.query.hiddenChannelFilter){case a.GroupChannel.HiddenChannelFilter.UNHIDDEN:i.hiddenState=a.GroupChannel.HiddenState.UNHIDDEN;break;case a.GroupChannel.HiddenChannelFilter.HIDDEN:i.hiddenState={"/in":[a.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE,a.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE]};break;case a.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:i.hiddenState=a.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE;break;case a.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:i.hiddenState=a.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE}var u=null,o=!1;switch(n.query.order){case"latest_last_message":!n.query.hasNext&&n.query.savepoint&&(i.lastMessageUpdatedAt={">=":parseInt(n.query.savepoint)}),u="lastMessageUpdatedAt",o=!0;break;case"chronological":!n.query.hasNext&&n.query.savepoint&&(i.createdAt={">=":parseInt(n.query.savepoint)}),u="createdAt",o=!0;break;case"channel_name_alphabetical":!n.query.hasNext&&n.query.savepoint&&(i.name={"<=":n.query.savepoint}),u="name";break;default:!n.query.hasNext&&n.query.savepoint&&(i.lastMessageUpdatedAt={">=":parseInt(n.query.savepoint)}),u="lastMessageUpdatedAt",o=!0}var f=C(n),d=function(e,a){r.query(i,{orderBy:u,desc:o,offset:t.channels.length,limit:e}).then(function(r){n._isLoading=!1,r.sort(function(e,n){return t.compareWithChannel(e,n)>0}),r.length>0&&t.addViewItems(r),r.length<e&&v(e-r.length),a(null,r)}).catch(function(e){n._isLoading=!1,a(e)})},v=function(e){f.state!==s.BackgroundSync.State.END&&(l.default.sync("subscribe channel",n.collectionId),f.subscribe(n.collectionId,function(n){n?l.default.error(n):(l.default.sync("flush channel"),d(e,function(e){e&&l.default.error(e)}))}))};d(n.limit,function(n,t){l.default.cache("fetch channel",n,t.map(function(e){return e.url})),e(n)}),f.state===s.BackgroundSync.State.PAUSED&&n._resume()}},e)}},{key:"remove",value:function(){v.get(this).removeCollection(this);var e=C(this),n=b(this);e&&(e.shared--,0===e.shared&&e.pause()),n&&(n.shared--,0===n.shared&&n.pause())}},{key:"setCollectionHandler",value:function(e){var n=m.get(this);e instanceof u.ChannelCollectionHandler&&(n["channel-collection-handler"]=e)}},{key:"removeCollectionHandler",value:function(){var e=m.get(this);e["channel-collection-handler"]&&delete e["channel-collection-handler"]}},{key:"channels",get:function(){return g.get(this).channels}}],[{key:"CollectionHandler",get:function(){return u.ChannelCollectionHandler}},{key:"Action",get:function(){return u.ChannelEventAction}}]),e}()},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.MessageCollection=n.MessageCollectionViewAdapter=void 0;var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=v(t(2)),i=v(t(4)),s=v(t(8)),u=t(11),o=t(9),c=t(12),l=v(t(10)),h=v(t(1)),f=v(t(0)),d=t(5);function v(e){return e&&e.__esModule?e:{default:e}}function g(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)}function p(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var y=new WeakMap,m=new WeakMap,C=new WeakMap,b=new WeakMap,I=new WeakMap,w=new WeakMap,k=new WeakMap,E=new WeakMap,A=50,M=100,U=100,_=50,S=n.MessageCollectionViewAdapter=function(){function e(){p(this,e),this.collection=null,this.messages=[],this.prevTempMessages=[],this.nextTempMessages=[],y.set(this,{}),this.currentChunk=null,this.viewRange={start:0,end:0}}return r(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"addViewItems",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=E.get(this.collection),r=y.get(this),a=k.get(this.collection),i=[],s=[],o=[];for(var l in e){var h=e[l],v=!0;if(n.isEventMessage){var g=a.state===u.BackgroundSync.State.END,p=!this.currentChunk||this.currentChunk.endAt<=this.viewRange.end,m=0===this.viewRange.end;v=g&&p||!this.currentChunk||m}var C=this.collection.sendBird.currentUser?this.collection.channel.getReadReceipt(h):r[h.messageId]||0;if(r[h.messageId]||(r[h.messageId]=C),v){var b=(0,d.getMessageIndex)(h,this.messages),I=(0,d.findMessageIndex)(h,this.messages);if(b>=0&&this.messages[b].isEqual(h)&&r[h.messageId]===C)continue;r[h.messageId]=C,h.messageId&&(this.viewRange.start=this.viewRange.start>0?Math.min(this.viewRange.start,h.createdAt):h.createdAt,this.viewRange.end=this.viewRange.end>0?Math.max(this.viewRange.end,h.createdAt):h.createdAt);var w=null;if(b<0)w=c.MessageEventAction.INSERT,this.messages.splice(I,0,h),this.nextTempMessages.push(h);else if(h.messageId){var A=this.messages[b];if(A.messageId)this.messages[b]=h,w=c.MessageEventAction.UPDATE;else{this.messages.splice(b,1),o.push(A);var M=b<I?1:0;this.messages.splice(I-M,0,h),w=c.MessageEventAction.INSERT}}switch(w){case c.MessageEventAction.INSERT:i.push(h);break;case c.MessageEventAction.UPDATE:s.push(h)}}}if(o.length>0)for(var U in f.default.view("message",c.MessageEventAction.REMOVE,o.map(function(e){return e.messageId+" "+e.createdAt})),t)t[U].onMessageEvent(c.MessageEventAction.REMOVE,o);if(i.length>0)for(var _ in f.default.view("message",c.MessageEventAction.INSERT,i.map(function(e){return e.messageId+" "+e.createdAt})),t)t[_].onMessageEvent(c.MessageEventAction.INSERT,i);if(s.length>0)for(var S in f.default.view("message",c.MessageEventAction.UPDATE,s.map(function(e){return e.messageId+" "+e.createdAt})),t)t[S].onMessageEvent(c.MessageEventAction.UPDATE,s)}},{key:"removeViewItems",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=E.get(this.collection),r=y.get(this),a=[];for(var i in e){var s=e[i];for(var u in this.messages)if(s===this.messages[u].messageId||n&&s===this.messages[u].reqId){"number"==typeof r[s]&&delete r[s];var o=this.messages.splice(u,1);a.push.apply(a,g(o));break}}if(this.viewRange.start=this.messages.length>0?this.messages[0].createdAt:0,this.viewRange.end=this.messages.length>0?this.messages[this.messages.length-1].createdAt:0,a.length>0)for(var l in f.default.view("message",c.MessageEventAction.REMOVE,a.map(function(e){return e.messageId})),t)t[l].onMessageEvent(c.MessageEventAction.REMOVE,a)}},{key:"clearPreviewItem",value:function(){var e=E.get(this.collection),n=[];for(var t in this.messages)0===this.messages[t].messageId&&n.push({index:parseInt(t),item:this.messages[t]});for(var r=n.length-1;r>=0;r--){var a=n[r];this.messages.splice(a.index,1)}for(var i in f.default.view("message",c.MessageEventAction.REMOVE,"preview message"),e)e[i].onMessageEvent(c.MessageEventAction.REMOVE,n.map(function(e){return e.item}))}},{key:"clearViewItem",value:function(){this.currentChunk=null,this.messages=[],y.set(this,{}),this.viewRange.start=0,this.viewRange.end=0;var e=E.get(this.collection),n=c.MessageEventAction.CLEAR;for(var t in f.default.view("message",n),e)e[t].onMessageEvent(n)}}]),e}();n.MessageCollection=function(){function e(n,t){var r=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(new Date).getTime();p(this,e);var i=s.default.getInstance();if(!i)return null;if(this.collectionId=(0,d.createUUID)(),this.sendBird=i.sb,this.channel=n,this.limit=_,this.filter=o.MessageChunk.getDefaultFilter(),t&&Object.keys(t).length>0)for(var c in t)this.filter.hasOwnProperty(c)&&(this.filter[c]=t[c]);this.viewpoint=a,this._isLoading={prev:!1,next:!1};var h=new S;h.attachCollection(this),C.set(this,h),i.broadcast.addCollection(this,h),m.set(this,i.broadcast),b.set(this,i.messageContainer),I.set(this,i.chunkContainer),E.set(this,{}),w.set(this,null),k.set(this,null);var v=new l.default,g=function(e,t,a){f.default.sync("message synchronize() begin",e,t);var s=null,u=0,c=[t];switch(e){case"prev":s="getPreviousMessagesByTimestamp",u=M,c.push(!0),c.push(M);break;case"next":s="getNextMessagesByTimestamp",u=U,c.push(!0),c.push(U);break;case"prevnext":s="getPreviousAndNextMessagesByTimestamp",u=2*A,c.push(A),c.push(A)}c.push(!1),c.push(r.filter.messageType||""),c.push(r.filter.customType||""),c.push(r.filter.senderUserIds||[]),c.push(r.filter.includeMetaArray||!1),n[s].apply(n,c.concat([function(n,s){s?(r._pause(),a(s)):(f.default.sync("message synchronize() end",e,t,n.map(function(e){return e.messageId})),v.lock(function(t){var s=[],c={startAt:1/0,endAt:0};if(n.length>0){for(var l in n)n[l].isVisible=!0,s.push(i.messageContainer.upsert(n[l])),c.startAt=Math.min(c.startAt,n[l].createdAt),c.endAt=Math.max(c.endAt,n[l].createdAt);h.currentChunk&&h.currentChunk.isOverlap(c)||(h.currentChunk=new o.MessageChunk(r.channel.url,r.filter),f.default.message("chunk is created",h.currentChunk)),h.currentChunk.extendWithChunk(c),f.default.message("currentChunk is extended",h.currentChunk),i.chunkContainer.mergePreviousChunkOverlap(h.currentChunk).then(function(){f.default.message("currentChunk merged previous chunks",h.currentChunk),Promise.all(s).then(function(){t(),a(null,{count:n.length,nextTs:"prev"===e?h.currentChunk.startAt:h.currentChunk.endAt,hasMore:n.length>=u})}).catch(function(e){t(),a(e)})}).catch(function(e){t(),a(e)})}else t(),a(null,{count:0,nextTs:0,hasMore:!1})}))}]))},y=new u.BackgroundSync(function(e,n){return g("prev",e,n)});y.shared++,w.set(this,y);var T=new u.BackgroundSync(function(e,n){return g("next",e,n)});y.shared++,k.set(this,T),i.chunkContainer.getChunkByTimestamp(this.channel.url,this.filter,this.viewpoint).then(function(e){e&&(h.currentChunk=e),h.currentChunk?r._resume():g("prevnext",r.viewpoint,function(e,n){e||(n.count<A?(y.end(),T.end()):(y.flush(e,n),T.flush(e,n),r._resume()))}),f.default.message("message collection "+r.collectionId+" is created.")}).catch(function(){})}return r(e,[{key:"_pause",value:function(){f.default.call("message sync pause",this.collectionId);var e=C.get(this),n=w.get(this),t=k.get(this);n&&n.pause(),t&&t.pause(),e.currentChunk=null}},{key:"_resume",value:function(){var e=this;f.default.call("message sync resume",this.collectionId),s.default.getInstance().syncChangeLog(this.channel,function(){var n=C.get(e),t=w.get(e),r=k.get(e);if(t){var a=n.currentChunk?n.currentChunk.startAt:e.viewpoint;t.start(a)}if(r){var i=n.currentChunk?n.currentChunk.endAt:e.viewpoint;r.start(i,!0)}})}},{key:"fetch",value:function(e,n){var t=this,r=C.get(this),a=b.get(this),i=I.get(this);return(0,d.promisify)(function(n){if(t._isLoading[e])f.default.error("fetch() is loading"),n(h.default.create(h.default.Type.ERROR_DUPLICATED_FETCH));else{t._isLoading[e]=!0,f.default.call("fetch()",e);var s=null,o=t.viewpoint,c=t.limit,l=!1,d=o,v=null,p=null;switch(e){case"prev":s=w.get(t),r.viewRange.start>0&&(o=r.viewRange.start),r.currentChunk&&(d=Math.max(r.currentChunk.startAt,o)),v=r.prevTempMessages,p=a.loadPreviousMessages,l=!0;break;case"next":s=k.get(t),r.viewRange.end>0&&(o=r.viewRange.end),r.currentChunk&&(d=Math.min(r.currentChunk.endAt,o)),v=r.nextTempMessages,p=a.loadNextMessages;break;default:return void n(h.default.create(h.default.Type.ERROR_INVALID_PARAMETER))}var y=function(n,a){f.default.message("waiting for synchronization..."),p(t.channel.url,t.filter,n,{limit:c,desc:l}).then(function(n){var i;f.default.cache("temp message",e,n.map(function(e){return e.messageId})),(i=v).push.apply(i,g(n)),r.addViewItems(n),t._isLoading[e]=!1,a(null)}).catch(function(n){t._isLoading[e]=!1,a(n)});var u=d;f.default.sync("subscribe message",t.collectionId,e,n),s.subscribe(t.collectionId,function(a){a?f.default.error(a):(f.default.sync("flush message",e,n),i.getChunkByTimestamp(t.channel.url,t.filter,n).then(function(n){n&&(r.currentChunk=n),r.currentChunk&&p(t.channel.url,t.filter,u,{limit:c,desc:l}).then(function(n){f.default.cache("flush message",e,u,n.map(function(e){return e.messageId})),r.clearPreviewItem();var t=[],a=[],i=!1;for(var s in n)if(r.currentChunk.containsMessage(n[s])){i=!0;var o=r.messages.map(function(e){return e.messageId}).indexOf(n[s].messageId);(o<0||!r.messages[o].isEqual(n[s]))&&t.push(n[s])}if(!i){for(var c in v)r.messages.map(function(e){return e.messageId}).indexOf(v[c].messageId)<0&&a.push(v[c]);for(;v.length>0;)v.pop()}t.length>0&&r.addViewItems(t),a.length>0&&r.removeViewItems(a.map(function(e){return e.messageId}))}).catch(function(e){return f.default.error(e)})}).catch(function(e){return f.default.error(e)}))})};i.getChunkByTimestamp(t.channel.url,t.filter,o).then(function(a){a&&(r.currentChunk=a),r.currentChunk?(f.default.message("chunk is selected",r.currentChunk),p(t.channel.url,t.filter,o,{limit:c,desc:l}).then(function(a){var i=[],s=[];f.default.cache("fetch message",e,o,a.map(function(e){return e.messageId}));var u=!1;for(var l in a)if(r.currentChunk.containsMessage(a[l])){u=!0;var h=r.messages.map(function(e){return e.messageId}).indexOf(a[l].messageId);(h<0||!r.messages[h].isEqual(a[l]))&&i.push(a[l])}if(!u){for(var d in v)r.messages.map(function(e){return e.messageId}).indexOf(v[d].messageId)<0&&s.push(v[d]);for(;v.length>0;)v.pop()}i.length>0&&r.addViewItems(i),s.length>0&&r.removeViewItems(s.map(function(e){return e.me})),a.length<c?(c-=a.length,y(o,n)):(t._isLoading[e]=!1,n(null))}).catch(function(r){t._isLoading[e]=!1,n(r)})):y(o,n)}).catch(function(r){t._isLoading[e]=!1,n(r)}),s.state===u.BackgroundSync.State.PAUSED&&t._resume()}},n)}},{key:"resetViewpointTimestamp",value:function(e){f.default.call("resetViewpointTimestamp()",e);var n=C.get(this);n.viewRange.start<=e&&e<=n.viewRange.end?n.currentChunk&&!n.currentChunk.contains(e)&&(n.currentChunk=null):(n.currentChunk=null,n.clearViewItem()),this.viewpoint=e,this._resume()}},{key:"remove",value:function(){var e=C.get(this);m.get(this).removeCollection(this),e.currentChunk=null;var n=w.get(this),t=k.get(this);n&&(n.shared--,0===n.shared&&n.pause()),t&&(t.shared--,0===t.shared&&t.pause())}},{key:"appendMessage",value:function(e){f.default.call("appendMessage()",e.messageId);var n=a.default.getInstance(),t=C.get(this);if(e.sender&&e.sender.userId===n.currentUserId)if(e.messageId){var r=m.get(this),s=b.get(this);e.isVisible=!0,s.upsert(e).then(function(e){return r.upsert([e])});var u=i.default.getInstance();u.channelContainer.getItem(e.channelUrl).then(function(n){n&&(!n.lastMessage||n.lastMessage.createdAt<=e.createdAt)&&(n.lastMessage=e,u.channelContainer.upsert(n).then(function(e){return u.broadcast.upsert([e])}).catch(function(e){return h.default.throw(e)}))}).catch(function(e){return h.default.throw(e)})}else t.addViewItems([e],{isEventMessage:!0})}},{key:"updateMessage",value:function(e){f.default.call("updateMessage()",e.messageId);var n=a.default.getInstance(),t=C.get(this);if(e.sender&&e.sender.userId===n.currentUserId)if(e.messageId){var r=m.get(this),s=b.get(this);e.isVisible=!0,s.upsert(e).then(function(e){return r.update([e])});var u=i.default.getInstance();u.channelContainer.getItem(e.channelUrl).then(function(n){n&&n.lastMessage&&n.lastMessage.messageId===e.messageId&&(n.lastMessage=e,u.channelContainer.upsert(n).then(function(e){return u.broadcast.update([e])}).catch(function(e){return h.default.throw(e)}))}).catch(function(e){return h.default.throw(e)})}else t.addViewItems([e])}},{key:"deleteMessage",value:function(e){f.default.call("deleteMessage()",e.messageId);var n=a.default.getInstance(),t=C.get(this);e.sender&&e.sender.userId===n.currentUserId&&(e.messageId||t.removeViewItems([e.reqId],!0))}},{key:"setCollectionHandler",value:function(e){var n=E.get(this);e instanceof c.MessageCollectionHandler&&(n["message-collection-handler"]=e)}},{key:"removeCollectionHandler",value:function(){var e=E.get(this);e["message-collection-handler"]&&delete e["message-collection-handler"]}},{key:"messages",get:function(){return C.get(this).messages}}],[{key:"CollectionHandler",get:function(){return c.MessageCollectionHandler}},{key:"Action",get:function(){return c.MessageEventAction}}]),e}()}]).default});