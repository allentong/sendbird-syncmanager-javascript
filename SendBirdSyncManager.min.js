/**
 * Copyright(c) 2016 SendBird, Inc.
 * SendBird SyncManager JavaScript SDK v1.1.10
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).SendBirdSyncManager=t()}(this,function(){"use strict";function p(e){try{return!!e()}catch(e){return!0}}function i(e){return t.call(e).slice(8,-1)}function u(e){if(null==e)throw TypeError("Can't call method on "+e);return e}function c(e){return b(u(e))}var t={}.toString,n="".split,b=p(function(){return!Object("z").propertyIsEnumerable(0)})?function(e){return"String"==i(e)?n.call(e,""):Object(e)}:Object,e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e,t){return e(t={exports:{}},t.exports),t.exports}function a(e){return e&&e.Math==Math&&e}function y(e){return"object"==typeof e?null!==e:"function"==typeof e}function s(e){return x?_.createElement(e):{}}function w(e){if(!y(e))throw TypeError(String(e)+" is not an object");return e}function l(e,t){if(!y(e))return e;var n,r;if(t&&"function"==typeof(n=e.toString)&&!y(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!y(r=n.call(e)))return r;if(!t&&"function"==typeof(n=e.toString)&&!y(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")}function m(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}function f(t,n){try{F(T,t,n)}catch(e){T[t]=n}return n}function o(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++P+q).toString(36)}function h(e){return V[e]||(V[e]=j&&B[e]||(j?B:o)("Symbol."+e))}function d(e,t){return G.call(e,t)}function M(e){return isNaN(e=+e)?0:(0<e?H:Q)(e)}function A(e){return 0<e?z(M(e),9007199254740991):0}function g(e,t){var n=M(e);return n<0?K(n+t,0):W(n,t)}function v(o){return function(e,t,n){var r,i=c(e),a=A(i.length),s=g(n,a);if(o&&t!=t){for(;s<a;)if((r=i[s++])!=r)return!0}else for(;s<a;s++)if((o||s in i)&&i[s]===t)return o||s||0;return!o&&-1}}function I(e,t){var n,r=c(e),i=0,a=[];for(n in r)!d(X,n)&&d(r,n)&&a.push(n);for(;t.length>i;)d(r,n=t[i++])&&(~Y(a,n)||a.push(n));return a}function k(e){return"function"==typeof e?e:void 0}function E(e,t){return arguments.length<2?k(te[e])||k(T[e]):te[e]&&te[e][t]||T[e]&&T[e][t]}function C(e){return re[e]||(re[e]=o(e))}function S(){}var O="object",T=a(typeof globalThis==O&&globalThis)||a(typeof window==O&&window)||a(typeof self==O&&self)||a(typeof e==O&&e)||Function("return this")(),R=!p(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}),_=T.document,x=y(_)&&y(_.createElement),U=!R&&!p(function(){return 7!=Object.defineProperty(s("div"),"a",{get:function(){return 7}}).a}),N=Object.defineProperty,D={f:R?N:function(e,t,n){if(w(e),t=l(t,!0),w(n),U)try{return N(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported");return"value"in n&&(e[t]=n.value),e}},F=R?function(e,t,n){return D.f(e,t,m(1,n))}:function(e,t,n){return e[t]=n,e},L=r(function(e){var t="__core-js_shared__",n=T[t]||f(t,{});(e.exports=function(e,t){return n[e]||(n[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.2.1",mode:"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})}),P=0,q=Math.random(),j=!!Object.getOwnPropertySymbols&&!p(function(){return!String(Symbol())}),B=T.Symbol,V=L("wks"),G={}.hasOwnProperty,Q=Math.ceil,H=Math.floor,z=Math.min,K=Math.max,W=Math.min,J={includes:v(!0),indexOf:v(!1)},X={},Y=J.indexOf,$=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Z=Object.keys||function(e){return I(e,$)},ee=R?Object.defineProperties:function(e,t){w(e);for(var n,r=Z(t),i=r.length,a=0;a<i;)D.f(e,n=r[a++],t[n]);return e},te=T,ne=E("document","documentElement"),re=L("keys"),ie=C("IE_PROTO"),ae="prototype",se=function(){var e,t=s("iframe"),n=$.length,r="script";for(t.style.display="none",ne.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write("<script>document.F=Object</"+r+">"),e.close(),se=e.F;n--;)delete se[ae][$[n]];return se()},oe=Object.create||function(e,t){var n;return null!==e?(S[ae]=w(e),n=new S,S[ae]=null,n[ie]=e):n=se(),void 0===t?n:ee(n,t)};X[ie]=!0;var ue=h("unscopables"),ce=Array.prototype;null==ce[ue]&&F(ce,ue,oe(null));function le(e){ce[ue][e]=!0}var fe,he,de,ge={},ve=L("native-function-to-string",Function.toString),pe=T.WeakMap,ye="function"==typeof pe&&/native code/.test(ve.call(pe)),me=T.WeakMap;if(ye){var Ie=new me,be=Ie.get,ke=Ie.has,Ee=Ie.set;fe=function(e,t){return Ee.call(Ie,e,t),t},he=function(e){return be.call(Ie,e)||{}},de=function(e){return ke.call(Ie,e)}}else{var Ce=C("state");X[Ce]=!0,fe=function(e,t){return F(e,Ce,t),t},he=function(e){return d(e,Ce)?e[Ce]:{}},de=function(e){return d(e,Ce)}}function we(e,t){for(var n=Be(t),r=D.f,i=Fe.f,a=0;a<n.length;a++){var s=n[a];d(e,s)||r(e,s,i(t,s))}}function Me(e,t){var n=Qe[Ge(e)];return n==ze||n!=He&&("function"==typeof t?p(t):!!t)}function Ae(e,t){var n,r,i,a,s,o=e.target,u=e.global,c=e.stat;if(n=u?T:c?T[o]||f(o,{}):(T[o]||{}).prototype)for(r in t){if(a=t[r],i=e.noTargetGet?(s=We(n,r))&&s.value:n[r],!Ke(u?r:o+(c?".":"#")+r,e.forced)&&void 0!==i){if(typeof a==typeof i)continue;we(a,i)}(e.sham||i&&i.sham)&&F(a,"sham",!0),Le(n,r,a,e)}}function Se(e){return Object(u(e))}var Oe,Te,Re,_e={set:fe,get:he,has:de,enforce:function(e){return de(e)?he(e):fe(e,{})},getterFor:function(n){return function(e){var t;if(!y(e)||(t=he(e)).type!==n)throw TypeError("Incompatible receiver, "+n+" required");return t}}},xe={}.propertyIsEnumerable,Ue=Object.getOwnPropertyDescriptor,Ne={f:Ue&&!xe.call({1:2},1)?function(e){var t=Ue(this,e);return!!t&&t.enumerable}:xe},De=Object.getOwnPropertyDescriptor,Fe={f:R?De:function(e,t){if(e=c(e),t=l(t,!0),U)try{return De(e,t)}catch(e){}if(d(e,t))return m(!Ne.f.call(e,t),e[t])}},Le=r(function(e){var t=_e.get,o=_e.enforce,u=String(ve).split("toString");L("inspectSource",function(e){return ve.call(e)}),(e.exports=function(e,t,n,r){var i=!!r&&!!r.unsafe,a=!!r&&!!r.enumerable,s=!!r&&!!r.noTargetGet;"function"==typeof n&&("string"!=typeof t||d(n,"name")||F(n,"name",t),o(n).source=u.join("string"==typeof t?t:"")),e!==T?(i?!s&&e[t]&&(a=!0):delete e[t],a?e[t]=n:F(e,t,n)):a?e[t]=n:f(t,n)})(Function.prototype,"toString",function(){return"function"==typeof this&&t(this).source||ve.call(this)})}),Pe=$.concat("length","prototype"),qe={f:Object.getOwnPropertyNames||function(e){return I(e,Pe)}},je={f:Object.getOwnPropertySymbols},Be=E("Reflect","ownKeys")||function(e){var t=qe.f(w(e)),n=je.f;return n?t.concat(n(e)):t},Ve=/#|\.prototype\./,Ge=Me.normalize=function(e){return String(e).replace(Ve,".").toLowerCase()},Qe=Me.data={},He=Me.NATIVE="N",ze=Me.POLYFILL="P",Ke=Me,We=Fe.f,Je=!p(function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}),Xe=C("IE_PROTO"),Ye=Object.prototype,$e=Je?Object.getPrototypeOf:function(e){return e=Se(e),d(e,Xe)?e[Xe]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?Ye:null},Ze=h("iterator"),et=!1;[].keys&&("next"in(Re=[].keys())?(Te=$e($e(Re)))!==Object.prototype&&(Oe=Te):et=!0),null==Oe&&(Oe={}),d(Oe,Ze)||F(Oe,Ze,function(){return this});function tt(e,t,n){e&&!d(e=n?e:e.prototype,ot)&&st(e,ot,{configurable:!0,value:t})}function nt(){return this}function rt(){return this}function it(e,t,n,r,i,a,s){function o(e){if(e===i&&v)return v;if(!ft&&e in d)return d[e];switch(e){case"keys":case dt:case gt:return function(){return new n(this,e)}}return function(){return new n(this)}}!function(e,t,n){var r=t+" Iterator";e.prototype=oe(ut,{next:m(1,n)}),tt(e,r,!1),ge[r]=nt}(n,t,r);var u,c,l,f=t+" Iterator",h=!1,d=e.prototype,g=d[ht]||d["@@iterator"]||i&&d[i],v=!ft&&g||o(i),p="Array"==t&&d.entries||g;if(p&&(u=$e(p.call(new e)),lt!==Object.prototype&&u.next&&($e(u)!==lt&&(ct?ct(u,lt):"function"!=typeof u[ht]&&F(u,ht,rt)),tt(u,f,!0))),i==dt&&g&&g.name!==dt&&(h=!0,v=function(){return g.call(this)}),d[ht]!==v&&F(d,ht,v),ge[t]=v,i)if(c={values:o(dt),keys:a?v:o("keys"),entries:o(gt)},s)for(l in c)!ft&&!h&&l in d||Le(d,l,c[l]);else Ae({target:t,proto:!0,forced:ft||h},c);return c}var at={IteratorPrototype:Oe,BUGGY_SAFARI_ITERATORS:et},st=D.f,ot=h("toStringTag"),ut=at.IteratorPrototype,ct=Object.setPrototypeOf||("__proto__"in{}?function(){var n,r=!1,e={};try{(n=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(e,[]),r=e instanceof Array}catch(e){}return function(e,t){return w(e),function(e){if(!y(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype")}(t),r?n.call(e,t):e.__proto__=t,e}}():void 0),lt=at.IteratorPrototype,ft=at.BUGGY_SAFARI_ITERATORS,ht=h("iterator"),dt="values",gt="entries",vt="Array Iterator",pt=_e.set,yt=_e.getterFor(vt),mt=it(Array,"Array",function(e,t){pt(this,{type:vt,target:c(e),index:0,kind:t})},function(){var e=yt(this),t=e.target,n=e.kind,r=e.index++;return!t||r>=t.length?{value:e.target=void 0,done:!0}:"keys"==n?{value:r,done:!1}:"values"==n?{value:t[r],done:!1}:{value:[r,t[r]],done:!1}},"values");ge.Arguments=ge.Array,le("keys"),le("values"),le("entries");function It(e,t,n){var r,i;return ct&&"function"==typeof(r=t.constructor)&&r!==n&&y(i=r.prototype)&&i!==n.prototype&&ct(e,i),e}function bt(n){return function(e){var t=String(u(e));return 1&n&&(t=t.replace(Ct,"")),2&n&&(t=t.replace(wt,"")),t}}function kt(e){var t,n,r,i,a,s,o,u,c=l(e,!1);if("string"==typeof c&&2<c.length)if(43===(t=(c=Tt(c)).charCodeAt(0))||45===t){if(88===(n=c.charCodeAt(2))||120===n)return NaN}else if(48===t){switch(c.charCodeAt(1)){case 66:case 98:r=2,i=49;break;case 79:case 111:r=8,i=55;break;default:return+c}for(s=(a=c.slice(2)).length,o=0;o<s;o++)if((u=a.charCodeAt(o))<48||i<u)return NaN;return parseInt(a,r)}return+c}var Et="[\t\n\v\f\r                　\u2028\u2029\ufeff]",Ct=RegExp("^"+Et+Et+"*"),wt=RegExp(Et+Et+"*$"),Mt={start:bt(1),end:bt(2),trim:bt(3)},At=qe.f,St=Fe.f,Ot=D.f,Tt=Mt.trim,Rt="Number",_t=T[Rt],xt=_t.prototype,Ut=i(oe(xt))==Rt;if(Ke(Rt,!_t(" 0o1")||!_t("0b1")||_t("+0x1"))){for(var Nt,Dt=function(e){var t=arguments.length<1?0:e,n=this;return n instanceof Dt&&(Ut?p(function(){xt.valueOf.call(n)}):i(n)!=Rt)?It(new _t(kt(t)),n,Dt):kt(t)},Ft=R?At(_t):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),Lt=0;Ft.length>Lt;Lt++)d(_t,Nt=Ft[Lt])&&!d(Dt,Nt)&&Ot(Dt,Nt,St(_t,Nt));(Dt.prototype=xt).constructor=Dt,Le(T,Rt,Dt)}Ae({target:"Number",stat:!0},{MAX_SAFE_INTEGER:9007199254740991});function Pt(e){var t,n,r;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),qt))?n:jt?i(t):"Object"==(r=i(t))&&"function"==typeof t.callee?"Arguments":r}var qt=h("toStringTag"),jt="Arguments"==i(function(){return arguments}()),Bt={};Bt[h("toStringTag")]="z";var Vt="[object z]"!==String(Bt)?function(){return"[object "+Pt(this)+"]"}:Bt.toString,Gt=Object.prototype;Vt!==Gt.toString&&Le(Gt,"toString",Vt,{unsafe:!0});function Qt(o){return function(e){for(var t,n=c(e),r=Z(n),i=r.length,a=0,s=[];a<i;)t=r[a++],R&&!Ht.call(n,t)||s.push(o?[t,n[t]]:n[t]);return s}}var Ht=Ne.f,zt={entries:Qt(!0),values:Qt(!1)}.values;Ae({target:"Object",stat:!0},{values:function(e){return zt(e)}});function Kt(e,t,n){for(var r in t)Le(e,r,t[r],n);return e}function Wt(e){var t=E(e),n=D.f;R&&t&&!t[en]&&n(t,en,{configurable:!0,get:function(){return this}})}function Jt(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e}function Xt(e,t,n){if(!(e instanceof t))throw TypeError("Incorrect "+(n?n+" ":"")+"invocation");return e}function Yt(r,i,e){if(Jt(r),void 0===i)return r;switch(e){case 0:return function(){return r.call(i)};case 1:return function(e){return r.call(i,e)};case 2:return function(e,t){return r.call(i,e,t)};case 3:return function(e,t,n){return r.call(i,e,t,n)}}return function(){return r.apply(i,arguments)}}function $t(t,e,n,r){try{return r?e(w(n)[0],n[1]):e(n)}catch(e){var i=t.return;throw void 0!==i&&w(i.call(t)),e}}var Zt=T.Promise,en=h("species"),tn=h("iterator"),nn=Array.prototype,rn=h("iterator"),an=r(function(e){function h(e,t){this.stopped=e,this.result=t}(e.exports=function(e,t,n,r,i){var a,s,o,u,c,l,f=Yt(t,n,r?2:1);if(i)a=e;else{if("function"!=typeof(s=function(e){if(null!=e)return e[rn]||e["@@iterator"]||ge[Pt(e)]}(e)))throw TypeError("Target is not iterable");if(function(e){return void 0!==e&&(ge.Array===e||nn[tn]===e)}(s)){for(o=0,u=A(e.length);o<u;o++)if((c=r?f(w(l=e[o])[0],l[1]):f(e[o]))&&c instanceof h)return c;return new h(!1)}a=s.call(e)}for(;!(l=a.next()).done;)if((c=$t(a,f,l.value,r))&&c instanceof h)return c;return new h(!1)}).stop=function(e){return new h(!0,e)}}),sn=h("iterator"),on=!1;try{var un=0,cn={next:function(){return{done:!!un++}},return:function(){on=!0}};cn[sn]=function(){return this},Array.from(cn,function(){throw 2})}catch(e){}function ln(e,t){if(!t&&!on)return!1;var n=!1;try{var r={};r[sn]=function(){return{next:function(){return{done:n=!0}}}},e(r)}catch(e){}return n}function fn(e){if(An.hasOwnProperty(e)){var t=An[e];delete An[e],t()}}function hn(e){return function(){fn(e)}}function dn(e){fn(e.data)}function gn(e){T.postMessage(e+"",In.protocol+"//"+In.host)}var vn,pn,yn,mn=h("species"),In=T.location,bn=T.setImmediate,kn=T.clearImmediate,En=T.process,Cn=T.MessageChannel,wn=T.Dispatch,Mn=0,An={},Sn="onreadystatechange";bn&&kn||(bn=function(e){for(var t=[],n=1;n<arguments.length;)t.push(arguments[n++]);return An[++Mn]=function(){("function"==typeof e?e:Function(e)).apply(void 0,t)},vn(Mn),Mn},kn=function(e){delete An[e]},"process"==i(En)?vn=function(e){En.nextTick(hn(e))}:wn&&wn.now?vn=function(e){wn.now(hn(e))}:Cn?(yn=(pn=new Cn).port2,pn.port1.onmessage=dn,vn=Yt(yn.postMessage,yn,1)):!T.addEventListener||"function"!=typeof postMessage||T.importScripts||p(gn)?vn=Sn in s("script")?function(e){ne.appendChild(s("script"))[Sn]=function(){ne.removeChild(this),fn(e)}}:function(e){setTimeout(hn(e),0)}:(vn=gn,T.addEventListener("message",dn,!1)));var On,Tn,Rn,_n,xn,Un,Nn,Dn,Fn={set:bn,clear:kn},Ln=E("navigator","userAgent")||"",Pn=Fe.f,qn=Fn.set,jn=T.MutationObserver||T.WebKitMutationObserver,Bn=T.process,Vn=T.Promise,Gn="process"==i(Bn),Qn=Pn(T,"queueMicrotask"),Hn=Qn&&Qn.value;Hn||(On=function(){var e,t;for(Gn&&(e=Bn.domain)&&e.exit();Tn;){t=Tn.fn,Tn=Tn.next;try{t()}catch(e){throw Tn?_n():Rn=void 0,e}}Rn=void 0,e&&e.enter()},_n=Gn?function(){Bn.nextTick(On)}:jn&&!/(iphone|ipod|ipad).*applewebkit/i.test(Ln)?(xn=!0,Un=document.createTextNode(""),new jn(On).observe(Un,{characterData:!0}),function(){Un.data=xn=!xn}):Vn&&Vn.resolve?(Nn=Vn.resolve(void 0),Dn=Nn.then,function(){Dn.call(Nn,On)}):function(){qn.call(T,On)});function zn(e){var n,r;this.promise=new e(function(e,t){if(void 0!==n||void 0!==r)throw TypeError("Bad Promise constructor");n=e,r=t}),this.resolve=Jt(n),this.reject=Jt(r)}function Kn(e,t){if(w(e),y(t)&&t.constructor===e)return t;var n=ar.f(e);return(0,n.resolve)(t),n.promise}function Wn(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}}function Jn(e){var t;return!(!y(e)||"function"!=typeof(t=e.then))&&t}function Xn(f,h,d){if(!h.notified){h.notified=!0;var g=h.reactions;ir(function(){for(var e=h.value,t=1==h.state,n=0;g.length>n;){var r,i,a,s=g[n++],o=t?s.ok:s.fail,u=s.resolve,c=s.reject,l=s.domain;try{o?(t||(2===h.rejection&&Or(f,h),h.rejection=1),!0===o?r=e:(l&&l.enter(),r=o(e),l&&(l.exit(),a=!0)),r===s.promise?c(dr("Promise-chain cycle")):(i=Jn(r))?i.call(r,u,c):u(r)):c(e)}catch(e){l&&!a&&l.exit(),c(e)}}h.reactions=[],h.notified=!1,d&&!h.rejection&&Ar(f,h)})}}function Yn(e,t,n){var r,i;Er?((r=gr.createEvent("Event")).promise=t,r.reason=n,r.initEvent(e,!1,!0),T.dispatchEvent(r)):r={promise:t,reason:n},(i=T["on"+e])?i(r):e===Cr&&function(e,t){var n=T.console;n&&n.error&&(1===arguments.length?n.error(e):n.error(e,t))}("Unhandled promise rejection",n)}function $n(t,n,r,i){return function(e){t(n,r,e,i)}}function Zn(e,t,n,r){t.done||(t.done=!0,r&&(t=r),t.value=n,t.state=2,Xn(e,t,!0))}var er,tr,nr,rr,ir=Hn||function(e){var t={fn:e,next:void 0};Rn&&(Rn.next=t),Tn||(Tn=t,_n()),Rn=t},ar={f:function(e){return new zn(e)}},sr=Fn.set,or=h("species"),ur="Promise",cr=_e.get,lr=_e.set,fr=_e.getterFor(ur),hr=Zt,dr=T.TypeError,gr=T.document,vr=T.process,pr=T.fetch,yr=vr&&vr.versions,mr=yr&&yr.v8||"",Ir=ar.f,br=Ir,kr="process"==i(vr),Er=!!(gr&&gr.createEvent&&T.dispatchEvent),Cr="unhandledrejection",wr=Ke(ur,function(){function t(){}var e=hr.resolve(1),n=(e.constructor={})[or]=function(e){e(t,t)};return!((kr||"function"==typeof PromiseRejectionEvent)&&e.then(t)instanceof n&&0!==mr.indexOf("6.6")&&-1===Ln.indexOf("Chrome/66"))}),Mr=wr||!ln(function(e){hr.all(e).catch(function(){})}),Ar=function(n,r){sr.call(T,function(){var e,t=r.value;if(Sr(r)&&(e=Wn(function(){kr?vr.emit("unhandledRejection",t,n):Yn(Cr,n,t)}),r.rejection=kr||Sr(r)?2:1,e.error))throw e.value})},Sr=function(e){return 1!==e.rejection&&!e.parent},Or=function(e,t){sr.call(T,function(){kr?vr.emit("rejectionHandled",e):Yn("rejectionhandled",e,t.value)})},Tr=function(n,r,e,t){if(!r.done){r.done=!0,t&&(r=t);try{if(n===e)throw dr("Promise can't be resolved itself");var i=Jn(e);i?ir(function(){var t={done:!1};try{i.call(e,$n(Tr,n,t,r),$n(Zn,n,t,r))}catch(e){Zn(n,t,e,r)}}):(r.value=e,r.state=1,Xn(n,r,!1))}catch(e){Zn(n,{done:!1},e,r)}}};wr&&(hr=function(e){Xt(this,hr,ur),Jt(e),er.call(this);var t=cr(this);try{e($n(Tr,this,t),$n(Zn,this,t))}catch(e){Zn(this,t,e)}},(er=function(e){lr(this,{type:ur,done:!1,notified:!1,parent:!1,reactions:[],rejection:!1,state:0,value:void 0})}).prototype=Kt(hr.prototype,{then:function(e,t){var n=fr(this),r=Ir(function(e,t){var n,r=w(e).constructor;return void 0===r||null==(n=w(r)[mn])?t:Jt(n)}(this,hr));return r.ok="function"!=typeof e||e,r.fail="function"==typeof t&&t,r.domain=kr?vr.domain:void 0,n.parent=!0,n.reactions.push(r),0!=n.state&&Xn(this,n,!1),r.promise},catch:function(e){return this.then(void 0,e)}}),tr=function(){var e=new er,t=cr(e);this.promise=e,this.resolve=$n(Tr,e,t),this.reject=$n(Zn,e,t)},ar.f=Ir=function(e){return e===hr||e===nr?new tr(e):br(e)},"function"==typeof Zt&&(rr=Zt.prototype.then,Le(Zt.prototype,"then",function(e,t){var n=this;return new hr(function(e,t){rr.call(n,e,t)}).then(e,t)}),"function"==typeof pr&&Ae({global:!0,enumerable:!0,forced:!0},{fetch:function(e){return Kn(hr,pr.apply(T,arguments))}}))),Ae({global:!0,wrap:!0,forced:wr},{Promise:hr}),tt(hr,ur,!1),Wt(ur),nr=te[ur],Ae({target:ur,stat:!0,forced:wr},{reject:function(e){var t=Ir(this);return t.reject.call(void 0,e),t.promise}}),Ae({target:ur,stat:!0,forced:wr},{resolve:function(e){return Kn(this,e)}}),Ae({target:ur,stat:!0,forced:Mr},{all:function(e){var o=this,t=Ir(o),u=t.resolve,c=t.reject,n=Wn(function(){var r=Jt(o.resolve),i=[],a=0,s=1;an(e,function(e){var t=a++,n=!1;i.push(void 0),s++,r.call(o,e).then(function(e){n||(n=!0,i[t]=e,--s||u(i))},c)}),--s||u(i)});return n.error&&c(n.value),t.promise},race:function(e){var n=this,r=Ir(n),i=r.reject,t=Wn(function(){var t=Jt(n.resolve);an(e,function(e){t.call(n,e).then(r.resolve,i)})});return t.error&&i(t.value),r.promise}});function Rr(o){return function(e,t){var n,r,i=String(u(e)),a=M(t),s=i.length;return a<0||s<=a?o?"":void 0:(n=i.charCodeAt(a))<55296||56319<n||a+1===s||(r=i.charCodeAt(a+1))<56320||57343<r?o?i.charAt(a):n:o?i.slice(a,a+2):r-56320+(n-55296<<10)+65536}}var _r={codeAt:Rr(!1),charAt:Rr(!0)},xr=_r.charAt,Ur="String Iterator",Nr=_e.set,Dr=_e.getterFor(Ur);it(String,"String",function(e){Nr(this,{type:Ur,string:String(e),index:0})},function(){var e,t=Dr(this),n=t.string,r=t.index;return r>=n.length?{value:void 0,done:!0}:(e=xr(n,r),t.index+=e.length,{value:e,done:!1})});var Fr={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Lr=h("iterator"),Pr=h("toStringTag"),qr=mt.values;for(var jr in Fr){var Br=T[jr],Vr=Br&&Br.prototype;if(Vr){if(Vr[Lr]!==qr)try{F(Vr,Lr,qr)}catch(e){Vr[Lr]=qr}if(Vr[Pr]||F(Vr,Pr,jr),Fr[jr])for(var Gr in mt)if(Vr[Gr]!==mt[Gr])try{F(Vr,Gr,mt[Gr])}catch(e){Vr[Gr]=mt[Gr]}}}function Qr(e){return(Qr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Hr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function zr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Kr(e,t,n){return t&&zr(e.prototype,t),n&&zr(e,n),e}function Wr(e){return(Wr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Jr(e,t){return(Jr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Xr(e,t,n){return(Xr=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&Jr(i,n.prototype),i}).apply(null,arguments)}function Yr(e){var n="function"==typeof Map?new Map:void 0;return(Yr=function(e){if(null===e||!function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,t)}function t(){return Xr(e,arguments,Wr(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),Jr(t,e)})(e)}function $r(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Zr(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var ei=D.f,ti=Function.prototype,ni=ti.toString,ri=/^\s*function ([^ (]*)/;!R||"name"in ti||ei(ti,"name",{configurable:!0,get:function(){try{return ni.call(this).match(ri)[1]}catch(e){return""}}});function ii(e){var t;return y(e)&&(void 0!==(t=e[ui])?!!t:"RegExp"==i(e))}function ai(){var e=w(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t}var si=null,oi=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return Hr(this,t),si=si||this,this.batchSize=64,this.batchInterval=200,this.cachedBlockLimit=128,this.cachedBlockFlush=32,this.encryption={encrypt:function(e,t){return t(null,e)},decrypt:function(e,t){return t(null,e)}},"number"==typeof e.batchSize&&1<e.batchSize&&(this.batchSize=e.batchSize),"number"==typeof e.batchInterval&&10<e.batchInterval&&(this.batchInterval=e.batchInterval),"number"==typeof e.cachedBlockLimit&&0<e.cachedBlockLimit&&(this.cachedBlockLimit=e.cachedBlockLimit),"number"==typeof e.cachedBlockFlush&&e.cachedBlockFlush<this.cachedBlockLimit&&(this.cachedBlockFlush=e.cachedBlockFlush),e.encryption&&e.encryption.hasOwnProperty("encrypt")&&e.encryption.hasOwnProperty("decrypt")&&"function"==typeof e.encryption.encrypt&&"function"==typeof e.encryption.decrypt&&(this.encryption=e.encryption),si}return Kr(t,null,[{key:"getInstance",value:function(){return si}}]),t}(),ui=h("match"),ci=D.f,li=qe.f,fi=h("match"),hi=T.RegExp,di=hi.prototype,gi=/a/g,vi=/a/g,pi=new hi(gi)!==gi;if(R&&Ke("RegExp",!pi||p(function(){return vi[fi]=!1,hi(gi)!=gi||hi(vi)==vi||"/a/i"!=hi(gi,"i")}))){for(var yi=function(e,t){var n=this instanceof yi,r=ii(e),i=void 0===t;return!n&&r&&e.constructor===yi&&i?e:It(pi?new hi(r&&!i?e.source:e,t):hi((r=e instanceof yi)?e.source:e,r&&i?ai.call(e):t),n?this:di,yi)},mi=function(t){t in yi||ci(yi,t,{configurable:!0,get:function(){return hi[t]},set:function(e){hi[t]=e}})},Ii=li(hi),bi=0;Ii.length>bi;)mi(Ii[bi++]);(di.constructor=yi).prototype=di,Le(T,"RegExp",yi)}Wt("RegExp");var ki="toString",Ei=RegExp.prototype,Ci=Ei[ki],wi=p(function(){return"/a/b"!=Ci.call({source:"a",flags:"b"})}),Mi=Ci.name!=ki;(wi||Mi)&&Le(RegExp.prototype,ki,function(){var e=w(this),t=String(e.source),n=e.flags;return"/"+t+"/"+String(void 0===n&&e instanceof RegExp&&!("flags"in Ei)?ai.call(e):n)},{unsafe:!0});var Ai=p(function(){Z(1)});function Si(t,n){var e=Qr(t),r=Qr(n);return!t||!n||"object"!==e||e!==r||t instanceof Date?t instanceof Date?t.getTime()===n.getTime():"function"===e&&"function"===r||t===n:Object.keys(t).length===Object.keys(n).length&&Object.keys(t).every(function(e){return Si(t[e],n[e])})}function Oi(e){return null!=e}function Ti(e,t,n){var r=2<arguments.length&&void 0!==n&&n;if(Oi(e)){if(!Oi(t))return r?-1:1;if(Qr(e)===Qr(t)&&e!==t){var i=Qr(e);if("boolean"===i)return e?1:-1;if("number"===i)return t<e?1:-1;if("string"===i)return e.localeCompare(t);if(e instanceof Date&&t instanceof Date&&e.getTime()!==t.getTime())return e.getTime()>t.getTime()?1:-1}}else if(Oi(t))return r?1:-1;return 0}function Ri(e,n,i){if(!n)return new Promise(function(n,r){e(function(e,t){i&&"function"==typeof i&&i(),e?r(e):n(t)})});e(function(e,t){i&&"function"==typeof i&&i(),n(e,t)})}Ae({target:"Object",stat:!0,forced:Ai},{keys:function(e){return Z(Se(e))}});function _i(e,t){var n;return Di(e)&&("function"!=typeof(n=e.constructor)||n!==Array&&!Di(n.prototype)?y(n)&&null===(n=n[Fi])&&(n=void 0):n=void 0),new(void 0===n?Array:n)(0===t?0:t)}function xi(d){var g=1==d,v=2==d,p=3==d,y=4==d,m=6==d,I=5==d||m;return function(e,t,n,r){for(var i,a,s=Se(e),o=b(s),u=Yt(t,n,3),c=A(o.length),l=0,f=r||_i,h=g?f(e,c):v?f(e,0):void 0;l<c;l++)if((I||l in o)&&(a=u(i=o[l],l,s),d))if(g)h[l]=a;else if(a)switch(d){case 3:return!0;case 5:return i;case 6:return l;case 2:Li.call(h,i)}else if(y)return!1;return m?-1:p||y?y:h}}function Ui(t){return!p(function(){var e=[];return(e.constructor={})[qi]=function(){return{foo:1}},1!==e[t](Boolean).foo})}var Ni=function(){function r(e){Hr(this,r),this.condition=e,this.offset=0,this.limit=1/0,this.index=null,this.desc=!1}return Kr(r,null,[{key:"and",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return 0<t.length?new r({"/and":t}):new r({})}},{key:"or",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return 0<t.length?new r({"/or":t}):new r({})}},{key:"Order",get:function(){return{ASC:1,DESC:-1}}}]),Kr(r,[{key:"match",value:function(e){return function n(r,e){var t=!0;if(r)for(var i in e){switch(i){case"/and":t=t&&e[i].reduce(function(e,t){return e&&n(r,t)},!0);break;case"/or":t=t&&e[i].reduce(function(e,t){return e||n(r,t)},!1);break;default:var a=e[i];if("object"===Qr(a))for(var s in a)switch(s){case">":t="number"==typeof r[i]&&"number"==typeof a[s]?t&&r[i]>a[s]:"string"==typeof r[i]&&"string"==typeof a[s]&&(t&&0<r[i].localeCompare(a[s]));break;case">=":t="number"==typeof r[i]&&"number"==typeof a[s]?t&&r[i]>=a[s]:"string"==typeof r[i]&&"string"==typeof a[s]&&(t&&0<=r[i].localeCompare(a[s]));break;case"<":t="number"==typeof r[i]&&"number"==typeof a[s]?t&&r[i]<a[s]:"string"==typeof r[i]&&"string"==typeof a[s]&&(t&&r[i].localeCompare(a[s])<0);break;case"<=":t="number"==typeof r[i]&&"number"==typeof a[s]?t&&r[i]<=a[s]:"string"==typeof r[i]&&"string"==typeof a[s]&&(t&&r[i].localeCompare(a[s])<=0);break;case"=":t=t&&r[i]===a[s];break;case"!=":t=t&&r[i]!==a[s];break;case"/in":t=t&&Array.isArray(a[s])&&0<=a[s].indexOf(r[i]);break;case"/nin":t=t&&Array.isArray(a[s])&&a[s].indexOf(r[i])<0;break;case"/like":t=t&&"string"==typeof a[s]&&"string"==typeof r[i]&&0<=r[i].indexOf(a[s]);break;case"/nlike":t=t&&"string"==typeof a[s]&&"string"==typeof r[i]&&r[i].indexOf(a[s])<0;break;case"/regex":t=t&&a[s]instanceof RegExp&&a[s].test(r[i]);break;case"/where":t=t&&a[s](r[i]);break;default:t=t&&Si(r[i],a)}else t=t&&r[i]===a}if(!t)break}else t=!1;return t}(e,this.condition)}}]),r}(),Di=Array.isArray||function(e){return"Array"==i(e)},Fi=h("species"),Li=[].push,Pi={forEach:xi(0),map:xi(1),filter:xi(2),some:xi(3),every:xi(4),find:xi(5),findIndex:xi(6)},qi=h("species"),ji=Pi.filter;Ae({target:"Array",proto:!0,forced:!Ui("filter")},{filter:function(e,t){return ji(this,e,1<arguments.length?t:void 0)}});var Bi=Pi.find,Vi="find",Gi=!0;Vi in[]&&Array(1)[Vi](function(){Gi=!1}),Ae({target:"Array",proto:!0,forced:Gi},{find:function(e,t){return Bi(this,e,1<arguments.length?t:void 0)}}),le(Vi);var Qi=J.includes;Ae({target:"Array",proto:!0},{includes:function(e,t){return Qi(this,e,1<arguments.length?t:void 0)}}),le("includes");function Hi(e,t,n){var r=l(t);r in e?D.f(e,r,m(0,n)):e[r]=n}var zi=Math.max,Ki=Math.min;Ae({target:"Array",proto:!0,forced:!Ui("splice")},{splice:function(e,t){var n,r,i,a,s,o,u=Se(this),c=A(u.length),l=g(e,c),f=arguments.length;if(0===f?n=r=0:r=1===f?(n=0,c-l):(n=f-2,Ki(zi(M(t),0),c-l)),9007199254740991<c+n-r)throw TypeError("Maximum allowed length exceeded");for(i=_i(u,r),a=0;a<r;a++)(s=l+a)in u&&Hi(i,a,u[s]);if(n<(i.length=r)){for(a=l;a<c-r;a++)o=a+n,(s=a+r)in u?u[o]=u[s]:delete u[o];for(a=c;c-r+n<a;a--)delete u[a-1]}else if(r<n)for(a=c-r;l<a;a--)o=a+n-1,(s=a+r-1)in u?u[o]=u[s]:delete u[o];for(a=0;a<n;a++)u[a+l]=arguments[a+2];return u.length=c-r+n,i}});var Wi,Ji,Xi=RegExp.prototype.exec,Yi=String.prototype.replace,$i=Xi,Zi=(Wi=/a/,Ji=/b*/g,Xi.call(Wi,"a"),Xi.call(Ji,"a"),0!==Wi.lastIndex||0!==Ji.lastIndex),ea=void 0!==/()??/.exec("")[1];(Zi||ea)&&($i=function(e){var t,n,r,i,a=this;return ea&&(n=new RegExp("^"+a.source+"$(?!\\s)",ai.call(a))),Zi&&(t=a.lastIndex),r=Xi.call(a,e),Zi&&r&&(a.lastIndex=a.global?r.index+r[0].length:t),ea&&r&&1<r.length&&Yi.call(r[0],n,function(){for(i=1;i<arguments.length-2;i++)void 0===arguments[i]&&(r[i]=void 0)}),r});function ta(n,e,t,r){var i=h(n),a=!p(function(){var e={};return e[i]=function(){return 7},7!=""[n](e)}),s=a&&!p(function(){var e=!1,t=/a/;return t.exec=function(){return e=!0,null},"split"===n&&(t.constructor={},t.constructor[aa]=function(){return t}),t[i](""),!e});if(!a||!s||"replace"===n&&!sa||"split"===n&&!oa){var o=/./[i],u=t(i,""[n],function(e,t,n,r,i){return t.exec===ia?a&&!i?{done:!0,value:o.call(t,n,r)}:{done:!0,value:e.call(n,t,r)}:{done:!1}}),c=u[0],l=u[1];Le(String.prototype,n,c),Le(RegExp.prototype,i,2==e?function(e,t){return l.call(e,this,t)}:function(e){return l.call(e,this)}),r&&F(RegExp.prototype[i],"sham",!0)}}function na(e,t,n){return t+(n?ua(e,t).length:1)}function ra(e,t){var n=e.exec;if("function"==typeof n){var r=n.call(e,t);if("object"!=typeof r)throw TypeError("RegExp exec method returned something other than an Object or null");return r}if("RegExp"!==i(e))throw TypeError("RegExp#exec called on incompatible receiver");return ia.call(e,t)}var ia=$i,aa=h("species"),sa=!p(function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")}),oa=!p(function(){var e=/(?:)/,t=e.exec;e.exec=function(){return t.apply(this,arguments)};var n="ab".split(e);return 2!==n.length||"a"!==n[0]||"b"!==n[1]}),ua=_r.charAt;ta("match",1,function(r,c,l){return[function(e){var t=u(this),n=null==e?void 0:e[r];return void 0!==n?n.call(e,t):new RegExp(e)[r](String(t))},function(e){var t=l(c,e,this);if(t.done)return t.value;var n=w(e),r=String(this);if(!n.global)return ra(n,r);for(var i,a=n.unicode,s=[],o=n.lastIndex=0;null!==(i=ra(n,r));){var u=String(i[0]);""===(s[o]=u)&&(n.lastIndex=na(r,A(n.lastIndex),a)),o++}return 0===o?null:s}]});var ca=!T.setImmediate||!T.clearImmediate;Ae({global:!0,bind:!0,enumerable:!0,forced:ca},{setImmediate:Fn.set,clearImmediate:Fn.clear});function la(e,t){var n=[][e];return!n||!p(function(){n.call(null,t||function(){throw 1},1)})}var fa=[].sort,ha=[1,2,3],da=p(function(){ha.sort(void 0)}),ga=p(function(){ha.sort(null)}),va=la("sort");Ae({target:"Array",proto:!0,forced:da||!ga||va},{sort:function(e){return void 0===e?fa.call(Se(this)):fa.call(Se(this),Jt(e))}});function pa(e){if(!y(e))return!1;var t=e[ya];return void 0!==t?!!t:Di(e)}var ya=h("isConcatSpreadable"),ma=9007199254740991,Ia="Maximum allowed index exceeded",ba=!p(function(){var e=[];return e[ya]=!1,e.concat()[0]!==e}),ka=Ui("concat");Ae({target:"Array",proto:!0,forced:!ba||!ka},{concat:function(e){var t,n,r,i,a,s=Se(this),o=_i(s,0),u=0;for(t=-1,r=arguments.length;t<r;t++)if(pa(a=-1===t?s:arguments[t])){if(i=A(a.length),ma<u+i)throw TypeError(Ia);for(n=0;n<i;n++,u++)n in a&&Hi(o,u,a[n])}else{if(ma<=u)throw TypeError(Ia);Hi(o,u++,a)}return o.length=u,o}});var Ea=function(){function r(e){Hr(this,r),this.blockKey=e,this.data=[]}return Kr(r,[{key:"get",value:function(e){var t=this.indexOf(e);return 0<=t?this.data[t].value:null}},{key:"indexOf",value:function(e){for(var t in this.data)if(this.data[t].key===e)return parseInt(t);return-1}},{key:"add",value:function(e,t){var n=this.indexOf(e);n<0?this.data.push({key:e,value:t}):this.data[n]={key:e,value:t}}},{key:"remove",value:function(e){var t=this.indexOf(e);return 0<=t&&(this.data.splice(t,1),!0)}},{key:"getSerializedData",value:function(){return JSON.stringify(this.data)}},{key:"count",get:function(){return this.data.length}}],[{key:"createKey",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:0;return"".concat(e.toLowerCase(),"-blk-").concat(n)}},{key:"buildFromSerializedData",value:function(e,t){var n=new r(e);try{return n.data=JSON.parse(t),n}catch(e){return null}}}]),r}(),Ca=function(){function e(){Hr(this,e),this.locked=!1,this.lockedAt=0}return Kr(e,[{key:"lock",value:function(e){var t=this;this.locked?setTimeout(function(){1e4<(new Date).getTime()-t.lockedAt&&t.unlock(),t.lock(e)},200):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(function(){return t.unlock()}))}},{key:"unlock",value:function(){this.locked=!1,this.lockedAt=0}}]),e}(),wa="adb-trns-",Ma=function(){function s(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};Hr(this,s);var n=oi.getInstance();this.name=e,this.initialized=!1,this.queue={},this.batchInterval=t.batchInterval||n.batchInterval,this.batchUpdateTimer=null,this.transactionMutex=new Ca,this.transactionState=s.State.IDLE,this.transactionCount=0,this.encryption=n.encryption,t.encryption&&t.encryption.hasOwnProperty("encrypt")&&t.encryption.hasOwnProperty("decrypt")&&"function"==typeof t.encryption.encrypt&&"function"==typeof t.encryption.decrypt&&(this.encryption=t.encryption)}return Kr(s,[{key:"init",value:function(e){var n=this,r=0<arguments.length&&void 0!==e?e:function(){};this.initialized?r(null):(this.initialized=!0,0===Object.keys(this.queue).length?ns.Storage.getItem(wa+this.name,function(e,t){t?n.encryption.decrypt(t,function(e,t){e||(n.queue=JSON.parse(t)),r(e)}):r(null)}):r(null))}},{key:"flush",value:function(){var a=this;this.transactionMutex.lock(function(i){ns.Storage.setItem(wa+a.name,JSON.stringify(a.queue),function(e){if(e)throw i(),e;function t(i){var e=a.queue[i];switch(e.action){case s.Action.SET:n.push(new Promise(function(n,r){a.encryption.encrypt(JSON.stringify(e.data),function(e,t){e?r(e):ns.Storage.setItem(i,t).then(n).catch(r)})}));break;case s.Action.REMOVE:n.push(ns.Storage.removeItem(i))}}var n=[];for(var r in a.queue)t(r);a.batchUpdateTimer=null,Promise.all(n).then(function(){a.queue={},ns.Storage.removeItem(wa+a.name,function(){i()})}).catch(function(e){throw i(),e})})})}},{key:"startTransaction",value:function(){this.transactionState=s.State.RUNNING,this.transactionCount++}},{key:"endTransaction",value:function(){this.transactionState===s.State.RUNNING&&(this.transactionCount--,0===this.transactionCount&&(this.flush(),this.transactionState=s.State.IDLE))}},{key:"addJob",value:function(e,t,n){var r=this;this.queue[t]={action:e,data:n},this.transactionState===s.State.IDLE&&(this.batchUpdateTimer||(this.batchUpdateTimer=setTimeout(function(){r.transactionState===s.State.IDLE&&r.flush(),r.batchUpdateTimer=null},this.batchInterval)))}}],[{key:"Action",get:function(){return{SET:"set",REMOVE:"remove"}}},{key:"State",get:function(){return{IDLE:"idle",RUNNING:"running"}}}]),s}(),Aa="adb-info-",Sa=function(){function r(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};Hr(this,r);var n=oi.getInstance();this.cachedBlockLimit=t.cachedBlockLimit||n.cachedBlockLimit,this.cachedBlockFlush=t.cachedBlockFlush||n.cachedBlockFlush,this.cacheMutex=new Ca,this.encryption=n.encryption,t.encryption&&t.encryption.hasOwnProperty("encrypt")&&t.encryption.hasOwnProperty("decrypt")&&"function"==typeof t.encryption.encrypt&&"function"==typeof t.encryption.decrypt&&(this.encryption=t.encryption),this.batchSize=t.batchSize||n.batchSize,this.batchQueue=t.sharedBatchQueue||new Ma(e,t),this.transaction=null,this.name=e,this.info={},this.blockCache={},this.blockCacheCursor=0,this.currentBlock=null}return Kr(r,[{key:"_findBlockKey",value:function(e){return this.info.blockMap[e]}},{key:"_getBlockFromCache",value:function(e){return this.blockCache[e]?this.blockCache[e].block:null}},{key:"_putBlockToCache",value:function(e){var n=this;this.blockCache[e.blockKey]={seq:this.blockCacheCursor++,block:e};var t=Object.keys(this.blockCache);if(t.length>=this.cachedBlockLimit)for(var r in t.sort(function(e,t){return n.blockCache[e].seq-n.blockCache[t].seq}),t)this._removeBlockFromCache(t[r])}},{key:"_removeBlockFromCache",value:function(e){this.blockCache.hasOwnProperty(e)&&delete this.blockCache[e]}},{key:"_getBlock",value:function(r,i){var a=this,e=this._getBlockFromCache(r);e?i(null,e):ns.Storage.getItem(r).then(function(e){e?a.encryption.decrypt(e,function(e,t){if(e)i(e);else{var n=Ea.buildFromSerializedData(r,t);a._putBlockToCache(n),i(null,n)}}):i(null)}).catch(function(e){return i(e)})}},{key:"_assignNewBlock",value:function(e){this.info.cursor++;var t=Ea.createKey(this.name,this.info.cursor),n=new Ea(t);this._putBlockToCache(n),this.currentBlock=n,e&&e.key&&(n.add(e.key,e.value),this.info.blockMap[e.key]=t,this.info.count++),this.batchQueue.addJob(Ma.Action.SET,n.blockKey,n.data),this.batchQueue.addJob(Ma.Action.SET,Aa+this.name,this.info)}},{key:"init",value:function(e){var r=this,i=0<arguments.length&&void 0!==e?e:function(){};this.batchQueue.init(function(e){e?i(e):ns.Storage.getItem(Aa+r.name,function(e,t){e?i(e):t?r.encryption.decrypt(t,function(e,t){if(e)i(e);else{r.info=JSON.parse(t);var n=Ea.createKey(r.name,r.info.cursor);r._getBlock(n,function(e,t){e||(r.currentBlock=t||new Ea(n)),i(e,r.info,!1)})}}):(r.info={blockMap:{},cursor:0,count:0},r.info.cursor=-1,r._assignNewBlock(),i(null,r.info,!0))})})}},{key:"startTransaction",value:function(){this.batchQueue.startTransaction()}},{key:"endTransaction",value:function(){this.batchQueue.endTransaction()}},{key:"getItem",value:function(n,e){var r=1<arguments.length&&void 0!==e?e:function(){},t=this._findBlockKey(n);t?this._getBlock(t,function(e,t){!e&&t?r(null,t.get(n)):r(e||new Error("Broken integrity - data not found."))}):r(null,null)}},{key:"setItem",value:function(n,r,e){var i=this,a=2<arguments.length&&void 0!==e?e:function(){},t=this._findBlockKey(n);if(t)this._getBlock(t,function(e,t){!e&&t?(t.add(n,r),i.batchQueue.addJob(Ma.Action.SET,t.blockKey,t.data),a(null)):a(e||new Error("Broken integrity - data not found."))});else{var s=this.currentBlock;s&&s.count<this.batchSize?(s.add(n,r),this.batchQueue.addJob(Ma.Action.SET,s.blockKey,s.data),this.info.count++,this.info.blockMap[n]=s.blockKey,this.batchQueue.addJob(Ma.Action.SET,Aa+this.name,this.info)):this._assignNewBlock({key:n,value:r}),a(null)}}},{key:"removeItem",value:function(n,e){var r=this,i=1<arguments.length&&void 0!==e?e:function(){},a=this._findBlockKey(n);a?this._getBlock(a,function(e,t){e?i(e):t?(t.remove(n)&&(r.info.blockMap.hasOwnProperty(n)&&delete r.info.blockMap[n],r.info.count--),0<t.data.length?r.batchQueue.addJob(Ma.Action.SET,a,t.data):(r._removeBlockFromCache(a),r.batchQueue.addJob(Ma.Action.REMOVE,a)),r.batchQueue.addJob(Ma.Action.SET,Aa+r.name,r.info),i(null)):i(new Error("Failed to remove item - data not found."))}):i(new Error("Failed to remove item - data not found."))}},{key:"clear",value:function(e){for(var t=0<arguments.length&&void 0!==e?e:function(){},n=0;n<=this.info.cursor;n++)this.batchQueue.addJob(Ma.Action.REMOVE,Ea.createKey(this.name,n));this.blockCacheCursor=0,this.blockCache={},this.info={blockMap:{},cursor:-1,count:0},this._assignNewBlock(),t(null)}},{key:"drop",value:function(e){var t=this,n=0<arguments.length&&void 0!==e?e:function(){};this.clear(function(){t.batchQueue.addJob(Ma.Action.REMOVE,Aa+t.name),n(null)})}},{key:"keys",get:function(){return Object.keys(this.info.blockMap)}},{key:"count",get:function(){return this.info.count}}]),r}(),Oa=[].join,Ta=b!=Object,Ra=la("join",",");Ae({target:"Array",proto:!0,forced:Ta||Ra},{join:function(e){return Oa.call(c(this),void 0===e?",":e)}});var _a=Pi.map;function xa(e,t,n){var r=e.offset,i=e.condition,a=e.progress,s=1<arguments.length&&void 0!==t?t:function(e,t){return t(null,!0)},o=2<arguments.length&&void 0!==n?n:function(){},u=r;!function n(){i(u)?setImmediate(function(){s(u,function(e,t){e?o(e):t?(u=a(u),n()):o(null)})}):o(null)}()}Ae({target:"Array",proto:!0,forced:!Ui("map")},{map:function(e,t){return _a(this,e,1<arguments.length?t:void 0)}});function Ua(e){return e.frozen||(e.frozen=new Qa)}function Na(e,t){return Ba(e.entries,function(e){return e[0]===t})}var Da=function(){function o(e){var t=e.collection,n=e.columns,r=void 0===n?{}:n,i=e.options,a=void 0===i?{}:i;for(var s in Hr(this,o),this.collection=t,this.columns=r,this.key=o.createKey(this.columns),this.columns)this.columns[s]=1;this.store=new Sa(t.name+"-index-"+this.key,a),this.table=[]}return Kr(o,[{key:"columnValues",value:function(t){return this.columnNames.map(function(e){return t?t[e]:null})}},{key:"compareColumnValues",value:function(e,t,n){for(var r=!(2<arguments.length&&void 0!==n)||n,i=this.columnNames,a=0;a<i.length;a++){var s=i[a],o=this.columns[s],u=Ti(e[a],t[a],r);if(0!==u)return o*u}return 0}},{key:"init",value:function(e){var r=this,i=0<arguments.length&&void 0!==e?e:function(){};this.store.init(function(e,t,n){e?i(e):n?r.save(i):r.store.getItem("".concat("idx-").concat(r.key),function(e,t){t&&(r.table=t),i(e)})})}},{key:"each",value:function(a,e,t){var s=this,n=1<arguments.length&&void 0!==e?e:null,o=0<(2<arguments.length&&void 0!==t?t:1),r=o?0:this.table.length-1;if(n&&0<this.table.length){for(var i={start:0,end:this.table.length},u=r;i.start<i.end;){var c=this.compareColumnValues(this.table[u].key,n,o);if(0===c)break;0<c?i.end=u-1:i.start=u+1,u=parseInt((i.start+i.end)/2)}r=u}var l=!0;xa({offset:r,condition:function(e){return o?e<s.table.length:0<=e},progress:function(e){return o?e+1:e-1}},function(e,t){var n=s.table[e];if(n){var r=n.key,i=n.value;xa({offset:o?0:i.length-1,condition:function(e){return o?e<i.length:0<=e},progress:function(e){return o?e+1:e-1}},function(e,n){a({key:r,value:i[e]},function(e,t){n(e,l=e||t)})},function(e){return t(e,l)})}else t(null,!1)},function(){a(null,function(){})})}},{key:"put",value:function(i,e){var a=this,s=!1,o=this.columnValues(e);xa({offset:0,condition:function(e){return e<a.table.length},progress:function(e){return e+1}},function(e,t){var n=a.table[e];if(n){var r=a.compareColumnValues(n.key,o);0<r?(a.table.splice(e,0,{key:o,value:[i]}),s=!0,a.save(function(e){return t(e,!1)})):0===r?n.value.indexOf(i)<0?(n.value.push(i),s=!0,a.save(function(e){return t(e,!1)})):t(null,!1):t(null,!0)}else t(null,!1)},function(){s||(a.table.push({key:o,value:[i]}),a.save())})}},{key:"update",value:function(e,t,n){var r=this.columnValues(t),i=this.columnValues(n);0!==this.compareColumnValues(r,i)&&(this.remove(e,t),this.put(e,n))}},{key:"remove",value:function(i,e){var a=this,s=this.columnValues(e);xa({offset:0,condition:function(e){return e<a.table.length},progress:function(e){return e+1}},function(e,t){var n=a.table[e];if(n)if(0===a.compareColumnValues(n.key,s)){var r=n.value.indexOf(i);0<=r?(n.value.splice(r,1),0===n.value.length&&a.table.splice(e,1),a.save(function(e){return t(e,!1)})):t(null,!1)}else t(null,!0);else t(null,!1)},function(){})}},{key:"save",value:function(e){var t=0<arguments.length&&void 0!==e?e:function(){};this.store.setItem("".concat("idx-").concat(this.key),this.table,t)}},{key:"clear",value:function(){this.table=[],this.store.clear()}},{key:"drop",value:function(){this.table=[],this.store.drop()}},{key:"columnNames",get:function(){return Object.keys(this.columns)}}],[{key:"createKey",value:function(t){return Object.keys(t).map(function(e){return"".concat(e,"_").concat(t[e])}).join("__")}}]),o}(),Fa=!p(function(){return Object.isExtensible(Object.preventExtensions({}))}),La=r(function(e){function n(e){t(e,r,{value:{objectID:"O"+ ++i,weakData:{}}})}var t=D.f,r=o("meta"),i=0,a=Object.isExtensible||function(){return!0},s=e.exports={REQUIRED:!1,fastKey:function(e,t){if(!y(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!d(e,r)){if(!a(e))return"F";if(!t)return"E";n(e)}return e[r].objectID},getWeakData:function(e,t){if(!d(e,r)){if(!a(e))return!0;if(!t)return!1;n(e)}return e[r].weakData},onFreeze:function(e){return Fa&&s.REQUIRED&&a(e)&&!d(e,r)&&n(e),e}};X[r]=!0}),Pa=(La.REQUIRED,La.fastKey,La.getWeakData,La.onFreeze,La.getWeakData),qa=_e.set,ja=_e.getterFor,Ba=Pi.find,Va=Pi.findIndex,Ga=0,Qa=function(){this.entries=[]};Qa.prototype={get:function(e){var t=Na(this,e);if(t)return t[1]},has:function(e){return!!Na(this,e)},set:function(e,t){var n=Na(this,e);n?n[1]=t:this.entries.push([e,t])},delete:function(t){var e=Va(this.entries,function(e){return e[0]===t});return~e&&this.entries.splice(e,1),!!~e}};function Ha(t,n){var e=Qr(t),r=Qr(n);return!t||!n||"object"!==e||e!==r||t instanceof Date?t instanceof Date?t.getTime()===n.getTime():"function"===e&&"function"===r||t===n:Object.keys(t).length===Object.keys(n).length&&Object.keys(t).every(function(e){return Ha(t[e],n[e])})}function za(e){var t=null;return e&&(Array.isArray(e)?t=e.join("_"):"object"===Qr(e)?t=Object.keys(e).join("_"):"string"==typeof e&&(t=e)),t}function Ka(e,t,i){if(!t)return new Promise(function(n,r){e(function(e,t){i&&"function"==typeof i&&i(),e?r(e):n(t)})});e(t)}var Wa={getConstructor:function(e,n,r,i){function a(e,t,n){var r=o(e),i=Pa(w(t),!0);return!0===i?Ua(r).set(t,n):i[r.id]=n,e}var s=e(function(e,t){Xt(e,s,n),qa(e,{type:n,id:Ga++,frozen:void 0}),null!=t&&an(t,e[i],e,r)}),o=ja(n);return Kt(s.prototype,{delete:function(e){var t=o(this);if(!y(e))return!1;var n=Pa(e);return!0===n?Ua(t).delete(e):n&&d(n,t.id)&&delete n[t.id]},has:function(e){var t=o(this);if(!y(e))return!1;var n=Pa(e);return!0===n?Ua(t).has(e):n&&d(n,t.id)}}),Kt(s.prototype,r?{get:function(e){var t=o(this);if(y(e)){var n=Pa(e);return!0===n?Ua(t).get(e):n?n[t.id]:void 0}},set:function(e,t){return a(this,e,t)}}:{add:function(e){return a(this,e,!0)}}),s}},Ja=(r(function(e){function t(t){return function(e){return t(this,arguments.length?e:void 0)}}var r,i=_e.enforce,n=!T.ActiveXObject&&"ActiveXObject"in T,a=Object.isExtensible,s=e.exports=function(r,e,t,i,a){function n(e){var n=o[e];Le(o,e,"add"==e?function(e){return n.call(this,0===e?0:e),this}:"delete"==e?function(e){return!(a&&!y(e))&&n.call(this,0===e?0:e)}:"get"==e?function(e){return a&&!y(e)?void 0:n.call(this,0===e?0:e)}:"has"==e?function(e){return!(a&&!y(e))&&n.call(this,0===e?0:e)}:function(e,t){return n.call(this,0===e?0:e,t),this})}var s=T[r],o=s&&s.prototype,u=s,c=i?"set":"add",l={};if(Ke(r,"function"!=typeof s||!(a||o.forEach&&!p(function(){(new s).entries().next()}))))u=t.getConstructor(e,r,i,c),La.REQUIRED=!0;else if(Ke(r,!0)){var f=new u,h=f[c](a?{}:-0,1)!=f,d=p(function(){f.has(1)}),g=ln(function(e){new s(e)}),v=!a&&p(function(){for(var e=new s,t=5;t--;)e[c](t,t);return!e.has(-0)});g||(((u=e(function(e,t){Xt(e,u,r);var n=It(new s,e,u);return null!=t&&an(t,n[c],n,i),n})).prototype=o).constructor=u),(d||v)&&(n("delete"),n("has"),i&&n("get")),(v||h)&&n(c),a&&o.clear&&delete o.clear}return l[r]=u,Ae({global:!0,forced:u!=s},l),tt(u,r),a||t.setStrong(u,r,i),u}("WeakMap",t,Wa,!0,!0);if(ye&&n){r=Wa.getConstructor(t,"WeakMap",!0),La.REQUIRED=!0;var o=s.prototype,u=o.delete,c=o.has,l=o.get,f=o.set;Kt(o,{delete:function(e){if(!y(e)||a(e))return u.call(this,e);var t=i(this);return t.frozen||(t.frozen=new r),u.call(this,e)||t.frozen.delete(e)},has:function(e){if(!y(e)||a(e))return c.call(this,e);var t=i(this);return t.frozen||(t.frozen=new r),c.call(this,e)||t.frozen.has(e)},get:function(e){if(!y(e)||a(e))return l.call(this,e);var t=i(this);return t.frozen||(t.frozen=new r),c.call(this,e)?l.call(this,e):t.frozen.get(e)},set:function(e,t){if(y(e)&&!a(e)){var n=i(this);n.frozen||(n.frozen=new r),c.call(this,e)?f.call(this,e,t):n.frozen.set(e,t)}else f.call(this,e,t);return this}})}}),te.WeakMap),Xa=new Ja,Ya=new Ja,$a=function(){function n(e,t){Hr(this,n),this.name=e,this.pk=t,Xa.set(this,new Sa(e)),Ya.set(this,[])}return Kr(n,[{key:"init",value:function(e){var n=Xa.get(this);return Ri(function(t){n.init(function(e){t(e)})},e)}},{key:"_findProperIndexer",value:function(e){if(e.index)for(var t=Ya.get(this),n=0;n<t.length;n++)if(Si(t[n].columns,e.index))return t[n];return null}},{key:"_addItemToIndex",value:function(e,t){for(var n=Ya.get(this),r=0;r<n.length;r++)n[r].put(e,t)}},{key:"_updateItemToIndex",value:function(e,t,n){for(var r=Ya.get(this),i=0;i<r.length;i++)r[i].update(e,t,n)}},{key:"_removeItemFromIndex",value:function(e,t){for(var n=Ya.get(this),r=0;r<n.length;r++)n[r].remove(e,t)}},{key:"ensureIndex",value:function(t,e){var n=this,o=Xa.get(this),r=Ya.get(this),i=Da.createKey(t);return Ri(function(a){for(var e=0;e<r.length;e++)if(i===r[e].key)return void a(null);var s=new Da({collection:n,columns:t,options:{sharedBatchQueue:o.batchQueue}});s.init(function(e,t,n){e?a(e):(r.push(s),n?function(){for(var r=o.keys,i=0,e=function(e){var n=r[e];o.getItem(n,function(e,t){!e&&t?s.put(n,t,function(){++i===r.length&&a(null)}):++i===r.length&&a(null)})},t=0;t<r.length;t++)e(t)}():a(null))})},e)}},{key:"removeIndex",value:function(e,t){var i=Ya.get(this),a=Da.createKey(e);return Ri(function(n){for(var e=function(t){if(a===i[t].key)return i[t].drop(function(e){e||i.splice(t,1),n(e)}),{v:void 0}},t=0;t<i.length;t++){var r=e(t);if("object"===Qr(r))return r.v}n(null)},t)}},{key:"findById",value:function(e,t){var r=Xa.get(this);return Ri(function(n){e?("string"!=typeof e&&(e=JSON.stringify(e)),r.getItem(e,function(e,t){n(e,t)})):n(new Error("Invalid type: 'id' should not be empty."))},t)}},{key:"findOne",value:function(e,n){return e.limit=1,this.find(e,function(e,t){n(e,0<t.length?t[0]:null)})}},{key:"find",value:function(c,e){var l=this,f=Xa.get(this);return Ri(function(t){if(c instanceof Ni){var r=[],e=l._findProperIndexer(c);if(e){for(var i=[],n=0;n<e.columnNames.length;n++){var a=e.columnNames[n];if(!c.condition[a])break;if("object"===Qr(c.condition[a])){if("break"===function(){var e=Object.keys(c.condition[a]),t=["="],n=e.filter(function(e){return t.includes(e)});if(!(0<n.length))return"break";var r=e.indexOf(n[0]);i.push(c.condition[a][e[r]])}())break}else{if("function"==typeof c.condition[a]||void 0===c.condition[a]||Array.isArray(c.condition[a]))break;i.push(c.condition[a])}}var s=c.offset||0;e.each(function(e,n){e?f.getItem(e.value,function(e,t){e?n(e):(c.match(t)&&(s<=0?r.push(t):s--),n(null,r.length<c.limit))}):t(null,r)},0<i.length?i:null,c.desc?Ni.Order.DESC:Ni.Order.ASC)}else{var o=!c.desc,u=f.keys;xa({offset:c.offset<u.length?o?c.offset:u.length-c.offset-1:o?u.length:0,condition:function(e){return o?r.length<c.limit&&e<u.length:r.length<c.limit&&0<=e},progress:function(e){return o?e+1:e-1}},function(e,n){f.getItem(u[e],function(e,t){e?n(e):(c.match(t)&&r.push(t),setImmediate(function(){return n(null,!0)}))})},function(e){t(e,r)})}}else t(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"count",value:function(a,e){var s=Xa.get(this);return Ri(function(t){if(!a||a instanceof Ni)if(a){var r=s.keys,i=0;xa({offset:0,condition:function(e){return e<r.length},progress:function(e){return e+1}},function(e,n){s.getItem(r[e],function(e,t){e?n(e):(a.match(t)&&i++,setImmediate(function(){return n(null,!0)}))})},function(e){t(e,i)})}else t(null,s.count);else t(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"insert",value:function(i,e){var a=this,s=Xa.get(this);return s.startTransaction(),Ri(function(n){if(Array.isArray(i)){for(var e=[],t=0;t<i.length;t++)i[t]&&"object"===Qr(i[t])&&e.push(a.insert(i[t]));i.length===e.length?Promise.all(e).then(function(){return n(null,i)}).catch(function(e){return n(e)}):n(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(i&&"object"===Qr(i))if(i[a.pk]){var r="".concat(i[a.pk]);s.getItem(r,function(e,t){e?n(e):t?n(new Error("Duplicated item: item already exists.")):(a._addItemToIndex(r,i),s.setItem(r,i,function(e){n(e,i)}))})}else n(new Error("Invalid key: item should have key."));else n(new Error("Invalid type: 'item' should be an object or an object array."))},e,function(){return s.endTransaction()})}},{key:"upsert",value:function(i,e){var a=this,s=Xa.get(this);return s.startTransaction(),Ri(function(n){if(Array.isArray(i)){for(var e=[],t=0;t<i.length;t++)i[t]&&"object"===Qr(i[t])&&e.push(a.upsert(i[t]));i.length===e.length?Promise.all(e).then(function(){return n(null,i)}).catch(function(e){return n(e)}):n(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(i&&"object"===Qr(i))if(i[a.pk]){var r="".concat(i[a.pk]);s.getItem(r,function(e,t){e?n(e):(t?a._updateItemToIndex(r,t,i):a._addItemToIndex(r,i),s.setItem(r,i,function(e){n(e,i)}))})}else n(new Error("Invalid key: item should have key."));else n(new Error("Invalid type: 'item' should be an object or an object array."))},e,function(){return s.endTransaction()})}},{key:"update",value:function(i,e){var a=this,s=Xa.get(this);return s.startTransaction(),Ri(function(n){if(Array.isArray(i)){for(var e=[],t=0;t<i.length;t++)i[t]&&"object"===Qr(i[t])&&e.push(a.update(i[t]));i.length===e.length?Promise.all(e).then(function(){return n(null,i)}).catch(function(e){return n(e)}):n(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(i&&"object"===Qr(i))if(i[a.pk]){var r="".concat(i[a.pk]);s.getItem(r,function(e,t){e?n(e):t?(a._updateItemToIndex(r,t,i),s.setItem(r,i,function(e){n(e,i)})):n(null)})}else n(new Error("Invalid key: item should have key."));else n(new Error("Invalid type: 'item' should be an object or an object array."))},e,function(){return s.endTransaction()})}},{key:"updateIf",value:function(c,l,e){var f=this,h=Xa.get(this);return h.startTransaction(),Ri(function(t){if(c instanceof Ni){var u=[],n=h.keys;xa({offset:0,condition:function(e){return e<n.length},progress:function(e){return e+1}},function(e,o){h.getItem(n[e],function(e,t){if(e)o(e);else if(t&&c.match(t)){var n=JSON.parse(JSON.stringify(t)),r=!1;for(var i in l){var a=l[i];Si(t[i],a)||(r=!0,t[i]=a)}if(r){var s="".concat(t[f.pk]);f._updateItemToIndex(s,n,t),h.setItem(s,t,function(e){e?o(e):(u.push(t),setImmediate(function(){return o(null,!0)}))})}else setImmediate(function(){return o(null,!0)})}else setImmediate(function(){return o(null,!0)})})},function(e){t(e,u)})}else t(new Error("Invalid type: 'query' should be Query type."))},e,function(){return h.endTransaction()})}},{key:"remove",value:function(r,e){var i=this,a=Xa.get(this);return a.startTransaction(),Ri(function(n){r?(r="".concat(r),a.getItem(r,function(e,t){e?n(e):t?(i._removeItemFromIndex(r,t),a.removeItem(r,function(e){n(e)})):n(null)})):n(new Error("Invalid type: 'id' should be string type."))},e,function(){return a.endTransaction()})}},{key:"removeIf",value:function(a,e){var s=this,o=Xa.get(this);return o.startTransaction(),Ri(function(t){if(a instanceof Ni){var i=[],n=o.keys;xa({offset:0,condition:function(e){return e<n.length},progress:function(e){return e+1}},function(e,r){o.getItem(n[e],function(e,t){if(e)r(e);else if(t&&a.match(t)){var n="".concat(t[s.pk]);s._removeItemFromIndex(n,t),o.removeItem(n,function(e){e?r(e):(i.push(t),setImmediate(function(){return r(null,!0)}))})}else setImmediate(function(){return r(null,!0)})})},function(e){t(e,i)})}else t(new Error("Invalid type: 'query' should be Query type."))},e,function(){return o.endTransaction()})}},{key:"clear",value:function(e){var n=Ya.get(this),r=Xa.get(this);return r.startTransaction(),Ri(function(t){for(var e=0;e<n.length;e++)n[e].clear();r.clear(function(e){t(e)})},e,function(){return r.endTransaction()})}}]),n}(),Za=null,es=new Ja,ts=new Ja,ns=function(){function n(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};Hr(this,n),this.name=e,this.config=new oi(t),es.set(this,{}),ts.set(this,{})}return Kr(n,null,[{key:"Query",get:function(){return Ni}},{key:"Storage",get:function(){return Za},set:function(e){Za=e}}]),Kr(n,[{key:"schema",value:function(e,t){var n=es.get(this);return n[e]=t,this}},{key:"build",value:function(){var s=es.get(this),o=ts.get(this);return new Promise(function(i,a){var e=[];for(var t in s)if(!o[t]){var n=s[t].key||"_id",r=o[t]=new $a(t,n);e.push(r.init())}Promise.all(e).then(function(){var e=[];for(var t in o)if(s[t].index&&0<s[t].index.length){var n=o[t];for(var r in s[t].index)e.push(n.ensureIndex(s[t].index[r]))}0<e.length?Promise.all(e).then(function(){i()}).catch(function(e){return a(e)}):i()}).catch(function(e){return a(e)})})}},{key:"close",value:function(){}},{key:"drop",value:function(){es.set(this,{}),_db.set(this,null),ts.set(this,{}),Za.clear()}},{key:"collection",value:function(e){var t=ts.get(this);return t[e]&&t[e]instanceof $a?t[e]:null}}]),n}(),rs=new Ja,is=function(){function r(e,t,n){Hr(this,r),this.name=t,this.keyPath=n,rs.set(this,e)}return Kr(r,[{key:"findById",value:function(n,e){var r=this,i=rs.get(this);return Ka(function(e){var t=i.transaction(r.name,"readonly").objectStore(r.name).get(n);t.onsuccess=function(){return e(null,t.result||null)},t.onerror=function(){return e(t.error)}},e)}},{key:"find",value:function(s,e){var o=this,u=rs.get(this);return Ka(function(r){if(s instanceof ls.Query){var e=za(s.index),i=[],t=u.transaction(o.name,"readonly").objectStore(o.name),n=e?t.index(e).openCursor(null,s.desc?"prev":"next"):t.openCursor(),a=s.offset;n.onsuccess=function(e){var t=e.target.result;if(t)if(!a||a<0){var n=t.value;s.match(n)?(i.push(n),i.length<s.limit?t.continue():r(null,i)):t.continue()}else a--,t.continue();else r(null,i)},n.onerror=function(){r(n.error)}}else r(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"count",value:function(a,e){var s=this,o=rs.get(this);return Ka(function(t){if(!a||a instanceof ls.Query){var e=o.transaction(s.name,"readonly").objectStore(s.name);if(a){var n=0,r=e.openCursor();r.onsuccess=function(){var e=event.target.result;e?(a.match(e.value)&&n++,e.continue()):t(null,n)},r.onerror=function(){t(r.error)}}else{var i=e.count();i.onsuccess=function(){return t(null,i.result)},i.onerror=function(){return t(i.error)}}}else t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"insert",value:function(s,e){var t=this,n=rs.get(this);return Ka(function(i){var a=n.transaction(t.name,"readwrite").objectStore(t.name);if(Array.isArray(s))!function(){function e(e){var t=s[e],n=a.add(t);n.onsuccess=function(){r.push(t),r.length===s.length&&i(null,r)},n.onerror=function(){i(n.error)}}var r=[];for(var t in s)e(t)}();else if(s&&"object"===Qr(s)){var e=a.add(s);e.onsuccess=function(){return i(null,s)},e.onerror=function(){return i(e.error)}}else i(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"upsert",value:function(a,e){var t=this,s=rs.get(this);return Ka(function(n){var r=s.transaction(t.name,"readwrite").objectStore(t.name);if(a&&"object"===Qr(a)){var i=r.get(a[t.keyPath]);i.onsuccess=function(){if(i.result){var e=r.put(a);e.onsuccess=function(){return n(null,a)},e.onerror=function(){return n(e.error)}}else{var t=r.add(a);t.onsuccess=function(){return n(null,a)},t.onerror=function(){return n(t.error)}}},i.onerror=function(){n(i.error)}}else n(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"update",value:function(n,e){var r=this,i=rs.get(this);return Ka(function(e){var t=i.transaction(r.name,"readwrite").objectStore(r.name).put(n);t.onsuccess=function(){return e(null,n)},t.onerror=function(){return e(t.error)}},e)}},{key:"updateIf",value:function(l,f,e){var t=this,n=rs.get(this);return Ka(function(o){if(l instanceof ls.Query){var u=[],c=n.transaction(t.name,"readwrite").objectStore(t.name),e=c.openCursor();e.onsuccess=function(e){var t=e.target.result;if(t){var n=t.value;if(l.match(n)){var r=!1;for(var i in f){var a=f[i];Ha(n[i],a)||(r=!0,n[i]=a)}if(r){var s=c.put(n);s.onsuccess=function(){u.push(n),t.continue()},s.onerror=function(){o(s.error)}}else t.continue()}else t.continue()}else o(null,u)},e.onerror=function(){o(e.error)}}else o(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"remove",value:function(n,e){var r=this,i=rs.get(this);return Ka(function(e){var t=i.transaction(r.name,"readwrite").objectStore(r.name).delete(n);t.onsuccess=function(){return e(null)},t.onerror=function(){return e(t.error)}},e)}},{key:"removeIf",value:function(o,e){var u=this,t=rs.get(this);return Ka(function(i){if(o instanceof ls.Query){var a=[],s=t.transaction(u.name,"readwrite").objectStore(u.name),e=s.openCursor();e.onsuccess=function(e){var t=e.target.result;if(t){var n=t.value;if(o.match(n)){var r=s.delete(n[u.keyPath]);r.onsuccess=function(){a.push(n),t.continue()},r.onerror=function(){i(r.error)}}else t.continue()}else i(null,a)},e.onerror=function(){i(e.error)}}else i(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"clear",value:function(e){var n=this,r=rs.get(this);return Ka(function(e){var t=r.transaction(n.name,"readwrite").objectStore(n.name).clear();t.onsuccess=function(){return e(null)},t.onerror=function(){return e(t.error)}},e)}}]),r}(),as=function(){function r(e){Hr(this,r),this.condition=e,this.offset=0,this.limit=1/0,this.index=null,this.desc=!1}return Kr(r,null,[{key:"and",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return 0<t.length?new r({"/and":t}):new r({})}},{key:"or",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return 0<t.length?new r({"/or":t}):new r({})}},{key:"Order",get:function(){return{ASC:1,DESC:-1}}}]),Kr(r,[{key:"match",value:function(e){return function n(r,e){var t=!0;for(var i in e){switch(i){case"/and":t=t&&e[i].reduce(function(e,t){return e&&n(r,t)},!0);break;case"/or":t=t&&e[i].reduce(function(e,t){return e||n(r,t)},!1);break;default:var a=e[i];if("object"===Qr(a))for(var s in a)switch(s){case">":t="number"==typeof r[i]&&"number"==typeof a[s]?t&&r[i]>a[s]:"string"==typeof r[i]&&"string"==typeof a[s]&&(t&&0<r[i].localeCompare(a[s]));break;case">=":t="number"==typeof r[i]&&"number"==typeof a[s]?t&&r[i]>=a[s]:"string"==typeof r[i]&&"string"==typeof a[s]&&(t&&0<=r[i].localeCompare(a[s]));break;case"<":t="number"==typeof r[i]&&"number"==typeof a[s]?t&&r[i]<a[s]:"string"==typeof r[i]&&"string"==typeof a[s]&&(t&&r[i].localeCompare(a[s])<0);break;case"<=":t="number"==typeof r[i]&&"number"==typeof a[s]?t&&r[i]<=a[s]:"string"==typeof r[i]&&"string"==typeof a[s]&&(t&&r[i].localeCompare(a[s])<=0);break;case"=":t=t&&r[i]===a[s];break;case"!=":t=t&&r[i]!==a[s];break;case"/in":t=t&&Array.isArray(a[s])&&0<=a[s].indexOf(r[i]);break;case"/nin":t=t&&Array.isArray(a[s])&&a[s].indexOf(r[i])<0;break;case"/like":t=t&&"string"==typeof a[s]&&"string"==typeof r[i]&&0<=r[i].indexOf(a[s]);break;case"/nlike":t=t&&"string"==typeof a[s]&&"string"==typeof r[i]&&r[i].indexOf(a[s])<0;break;case"/regex":t=t&&a[s]instanceof RegExp&&a[s].test(r[i]);break;case"/where":t=t&&a[s](r[i]);break;default:t=t&&Ha(r[i],a)}else t=t&&r[i]===a}if(!t)break}return t}(e,this.condition)}}]),r}(),ss=new Ja,os=new Ja,us=new Ja,cs=window?window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB:null,ls=function(){function n(e,t){if(Hr(this,n),!cs)throw new Error("IndexedDB is not supported in this environment. Check if you're in web browser which supports IndexedDB.");this.name=e,this.version=t,ss.set(this,{}),os.set(this,null),us.set(this,{})}return Kr(n,null,[{key:"Query",get:function(){return as}}]),Kr(n,[{key:"schema",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=ss.get(this);return n[e]=t,this}},{key:"build",value:function(){var m=this,I=ss.get(this),b=us.get(this);return new Promise(function(i,t){var e=cs.open(m.name,m.version);e.onerror=function(e){t(new Error("IndexedDB is not available: ".concat(e.target.errorCode)))},e.onupgradeneeded=function(e){var t=e.target.result,n=e.target.transaction,r=t.objectStoreNames;for(var i in I){var a=I[i].key||"id",s=null;try{s=n.objectStore(i)}catch(e){"NotFoundError"===e.name&&(s=t.createObjectStore(i,{keyPath:a}))}if(s){var o=s.indexNames,u=new is(t,i,a);if(I[i].index&&0<I[i].index.length)for(var c in I[i].index){var l=za(I[i].index[c]);if(l){var f=!1;for(var h in o)if(o[h]===l){f=!0;break}f||s.createIndex(l,Object.keys(I[i].index[c]),{unique:!1})}}var d=[];if(I[i].index)for(var g in I[i].index){var v=za(I[i].index[g]);v&&d.push(v)}for(var p=0;p<o.length;p++)d.indexOf(o[p])<0&&s.deleteIndex(o[p]);b[i]=u}}for(var y=0;y<r.length;y++)Object.keys(I).indexOf(r.item(y))<0&&t.deleteObjectStore(r.item(y));os.set(m,t)},e.onsuccess=function(e){var t=e.target.result;for(var n in I)if(!b[n]){var r=I[n].key||"id";b[n]=new is(t,n,r)}os.set(m,t),i()}})}},{key:"close",value:function(){var e=os.get(this);e&&(e.close(),os.set(this,null))}},{key:"drop",value:function(){cs.deleteDatabase(this.name)}},{key:"collection",value:function(e){var t=us.get(this);return t[e]&&t[e]instanceof is?t[e]:null}}]),n}(),fs=null,hs=!1,ds=function(){function e(){Hr(this,e)}return Kr(e,null,[{key:"init",value:function(){fs=fs||(window?window.localStorage:null)}},{key:"useReactNative",value:function(e){fs=e,hs=!0}},{key:"getKeys",value:function(){return hs?fs.getAllKeys():new Promise(function(e){var t=[];for(var n in fs)t.push(n);e(t)})}},{key:"get",value:function(n){return hs?fs.getItem(n):new Promise(function(e){var t=fs.getItem(n);e(void 0!==t?t:null)})}},{key:"set",value:function(t,n){return hs?fs.setItem(t,n):new Promise(function(e){fs.setItem(t,n),e()})}},{key:"remove",value:function(t){return hs?fs.removeItem(t):new Promise(function(e){fs.removeItem(t),e()})}},{key:"clear",value:function(){return hs?fs.clear():new Promise(function(e){fs.clear(),e()})}}]),e}(),gs=h("match"),vs="".startsWith,ps=Math.min;Ae({target:"String",proto:!0,forced:!function(t){var n=/./;try{"/./"[t](n)}catch(e){try{return n[gs]=!1,"/./"[t](n)}catch(e){}}return!1}("startsWith")},{startsWith:function(e,t){var n=String(u(this));!function(e){if(ii(e))throw TypeError("The method doesn't accept regular expressions")}(e);var r=A(ps(1<arguments.length?t:void 0,n.length)),i=String(e);return vs?vs.call(n,i,r):n.slice(r,r+i.length)===i}});var ys=Pi.forEach,ms=la("forEach")?function(e,t){return ys(this,e,1<arguments.length?t:void 0)}:[].forEach;for(var Is in Fr){var bs=T[Is],ks=bs&&bs.prototype;if(ks&&ks.forEach!==ms)try{F(ks,"forEach",ms)}catch(e){ks.forEach=ms}}function Es(s,n){function i(e,t){var n=Ho.getInstance();n.currentUserId?(e.ownerUserId=n.currentUserId,e.lastMessageUpdatedAt=e.lastMessage?e.lastMessage.createdAt:e.createdAt,Ss.cache("upsert channel","url="+e.url,"name="+e.name,"createdAt="+e.createdAt,"lastMessageUpdatedAt="+e.lastMessageUpdatedAt),u.upsert(e.serialize(),t)):t(Os.create(Os.Type.ERROR_SETUP_MISSING))}function o(e){if(e){var t=n.GroupChannel.buildFromSerializedData(e);return t.lastMessageUpdatedAt=t.lastMessage?t.lastMessage.createdAt:t.createdAt,t}return null}var e=this,u=s.collection("GroupChannel");return this.query=function(e,t,a){var n=Ho.getInstance();if(n.currentUserId){e.ownerUserId=n.currentUserId;var r=new Ho.LocalDB.Query(e);t&&(r.offset=t.offset||0,r.limit=t.limit||20,r.index=t.index,r.desc=t.desc),u.find(r,function(e,t){if(e)a(e);else{for(var n=[],r=0;r<t.length;r++){var i=o(t[r]);n.push(i)}a(null,n)}})}else a(Os.create(Os.Type.ERROR_SETUP_MISSING))},this.insert=function(n,r){e.getItem(n.url,function(e,t){e?r(e):t?r(null,n):i(n,function(e){e?r(e):r(null,n)})})},this.upsert=function(e,n){i(e,function(e,t){e?n(e):n(null,o(t))})},this.remove=function(e,n){!function(r,i){var a=Ho.getInstance();a.currentUserId?(Ss.cache("remove channel",r.url),u.remove(r.url,function(e,t){if(e)i(e);else{var n=new Ho.LocalDB.Query({ownerUserId:a.currentUserId,channelUrl:r.url});s.collection("MessageChunk").removeIf(n,function(e){e?i(e):s.collection("Message").removeIf(n,function(e){e?i(e):i(null,t)})})}})):i(Os.create(Os.Type.ERROR_SETUP_MISSING))}(e,function(e,t){e?n(e):n(null,o(t))})},this.getItem=function(e,n){u.findById(e,function(e,t){e?n(e):n(null,o(t))})},this.clear=function(e){return function(t){Ss.cache("clear channel"),u.clear(function(e){e?t(e):s.collection("MessageChunk").clear(function(e){e?t(e):s.collection("Message").clear(t)})})}(e)},this}function Cs(e,n){var a=this,s=e.collection("GroupChannelListQuery"),o=function(e){if(e){var t=n.GroupChannelListQuery.buildFromSerializedData(e);return t.filterKey=e.filterKey,t.ownerUserId=e.currentUserId,t.updatedAt=e.updatedAt,t.savepoint=e.savepoint,t}return null};return this.createFilterKey=function(e){var t=[];return t.push("order=".concat(e.order)),t.push("includeEmpty=".concat(e.includeEmpty)),t.push("customTypesFilter=".concat(e.customTypesFilter.sort().join(","))),t.join("&")},this.upsert=function(e,n){!function(r,i){r.filterKey=a.createFilterKey(r);var e=Ho.getInstance();if(e.currentUserId){Ss.cache("upsert channel list query",r.filterKey),r.ownerUserId=e.currentUserId,r.updatedAt=(new Date).getTime(),r.savepoint||(r.savepoint="");var t=r.serialize();s.upsert(t,function(e,t){if(e)i(e);else{if(Ts[r.filterKey])for(var n in r)Ts[r.filterKey].hasOwnProperty(n)&&(Ts[r.filterKey][n]=r[n]);else Ts[r.filterKey]=r;i(null,o(t))}})}else i(Os.create(Os.Type.ERROR_SETUP_MISSING))}(e,function(e,t){e?n(e):n(null,o(t))})},this.remove=function(e,n){!function(n,r){Ho.getInstance().currentUserId?(Ss.cache("remove channel list query",n.filterKey),s.remove(n.filterKey,function(e,t){e?r(e):(Ts[n.filterKey]&&delete Ts[n.filterKey],r(null,t))})):r(Os.create(Os.Type.ERROR_SETUP_MISSING))}(e,function(e,t){e?n(e):n(null,o(t))})},this.getItem=function(e,n){Ts[e]?n(null,Ts[e]):s.findById(e,function(e,t){e?n(e):n(null,o(t))})},this.clear=function(e){return function(t){Ss.cache("clear channel list query"),Ts={},s.clear(function(e){return t(e)})}(e)},this}var ws={NONE:0,ERROR:1},Ms=ws.NONE,As="",Ss=function(){function r(){Hr(this,r)}return Kr(r,null,[{key:"_permit",value:function(e,t){if(e<=Ms){var n="";switch(e){case 1:n="error";break;case 2:n="warning";break;case 3:case 98765:n="log";break;default:n=""}if(console&&console[n]){for(var r,i,a="".concat(As," ").concat(t||""," "),s=arguments.length,o=new Array(2<s?s-2:0),u=2;u<s;u++)o[u-2]=arguments[u];if("string"==typeof o[0])o[0]=a+o[0],(r=console)[n].apply(r,o);else(i=console)[n].apply(i,[a].concat(o))}}}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r._permit.apply(r,[ws.ERROR,"[ERROR]"].concat(t))}},{key:"warning",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r._permit.apply(r,[2,"[WARNING]"].concat(t))}},{key:"call",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r._permit.apply(r,[3,"[CALL]"].concat(t))}},{key:"event",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r._permit.apply(r,[3,"[EVENT]"].concat(t))}},{key:"view",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r._permit.apply(r,[3,"[VIEW]"].concat(t))}},{key:"message",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r._permit.apply(r,[3,"[MESSAGE]"].concat(t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r._permit.apply(r,[3,"[INFO]"].concat(t))}},{key:"cache",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r._permit.apply(r,[98765,"[CACHE]"].concat(t))}},{key:"sync",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r._permit.apply(r,[98765,"[SYNC]"].concat(t))}},{key:"level",set:function(e){var t=Object.values(ws);t.push(98765),-1<t.indexOf(e)&&(Ms=e)},get:function(){return Ms}},{key:"prefix",set:function(e){"string"==typeof e&&(As=e)}}]),r}(),Os=function(){function r(e,t){var n;return Hr(this,r),(n=$r(this,Wr(r).call(this,e))).name="SyncManagerException",n.code=t||0,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Jr(e,t)}(r,Yr(Error)),Kr(r,null,[{key:"create",value:function(e){var t=0<arguments.length&&void 0!==e?e:r.Type.ERROR_UNKNOWN;return new r(t.message,t.code)}},{key:"throw",value:function(e){Ss.error(e)}},{key:"Type",get:function(){return{ERROR_UNKNOWN:{code:81e4,message:"Unknown error occurred."},ERROR_DATABASE_IO:{code:810001,message:"Database I/O operation failed."},ERROR_SETUP_MISSING:{code:810100,message:"SendBirdSyncManager.setup() is not called."},ERROR_SENDBIRD_MISSING:{code:810101,message:"SendBird instance should be set before init()."},ERROR_DUPLICATED_FETCH:{code:810200,message:"Fetch is in progress."},ERROR_DUPLICATED_CHANGELOG_SYNC:{code:810210,message:"Sync is in progress."},ERROR_INVALID_PARAMETER:{code:810300,message:"Invalid parameter."}}}}]),r}(),Ts={};function Rs(e,t){var n=Ds.getInstance().sb,r=!0;if(e.isGroupChannel()&&!e.isSuper){if(!t.includeEmpty&&!e.lastMessage)return!1;if(t.nicknameContainsFilter){var i=!1;for(var a in e.members)if(0<=e.members[a].nickname.indexOf(t.nicknameContainsFilter)){i=!0;break}if(!i)return!1}if(0<t.userIdsFilter.length){var s=!1,o=e.members.map(function(e){return e.userId}),u=t.userIdsFilterExactMatch,c=t.queryType;if(u?s=o.length===t.userIdsFilter.length&&t.userIdsFilter.every(function(e){return 0<=o.indexOf(e)}):"AND"===c?s=t.userIdsFilter.every(function(e){return 0<=o.indexOf(e)}):"OR"===c&&(s=t.userIdsFilter.reduce(function(e,t){return e||0<=o.indexOf(t)},!1)),!s)return!1}}if(t.channelNameContainsFilter&&(r=r&&0<=e.name.indexOf(t.channelNameContainsFilter)),0<t.channelUrlsFilter.length&&(r=r&&0<=t.channelUrlsFilter.indexOf(e.url)),t.memberStateFilter!==n.GroupChannel.memberStateFilter.ALL)switch(t.memberStateFilter){case n.GroupChannel.memberStateFilter.JOINED:r=r&&e.myMemberState===n.GroupChannel.memberStateFilter.JOINED;break;case n.GroupChannel.memberStateFilter.INVITED:case n.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case n.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:r=r&&e.myMemberState===n.GroupChannel.memberStateFilter.INVITED}if(0<t.customTypesFilter.length&&(r=r&&0<=t.customTypesFilter.indexOf(e.customType)),t.customTypeStartsWithFilter&&(r=r&&e.customType.startsWith(t.customTypeStartsWithFilter)),t.superChannelFilter!==n.GroupChannel.superChannelFilter.ALL)switch(t.superChannelFilter){case n.GroupChannel.superChannelFilter.SUPER:r=r&&e.isSuper;break;case n.GroupChannel.superChannelFilter.NONSUPER:r=r&&!e.isSuper}if(t.publicChannelFilter!==n.GroupChannel.publicChannelFilter.ALL)switch(t.publicChannelFilter){case n.GroupChannel.publicChannelFilter.PUBLIC:r=r&&e.isPublic;break;case n.GroupChannel.publicChannelFilter.PRIVATE:r=r&&!e.isPublic}if(t.unreadChannelFilter!=n.GroupChannel.UnreadChannelFilter.ALL)switch(t.unreadChannelFilter){case n.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:r=r&&0<e.unreadMessageCount}return r}function _s(){var c=[];return this.addCollection=function(e,t){c.indexOf(e)<0&&c.push({controller:e,view:t})},this.removeCollection=function(e){var t=c.map(function(e){return e.controller}).indexOf(e);0<=t&&(c[t].controller._pause(),c.splice(t,1))},this.clearCollection=function(){for(var e in c)c[e].controller._pause();c=[]},this.pause=function(){for(var e in c)c[e].controller._pause()},this.resume=function(){for(var e in c)c[e].controller._resume()},this.upsert=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(0<e.length)for(var r in c){var i=c[r];if(i.controller!==t){var a=[];for(var s in e){var o=e[s];Rs(o,i.controller.query)&&a.push(o)}0<a.length&&(n.isEventChannel=!0,i.view.addViewItems(a,n))}}},this.update=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(0<e.length)for(var r in c){var i=c[r];if(i.controller!==t){var a=[];for(var s in e){var o=e[s];Rs(o,i.controller.query)&&0<=i.view.channels.map(function(e){return e.url}).indexOf(o.url)&&a.push(o)}0<a.length&&(n.isEventChannel=!0,i.view.addViewItems(a,n))}}},this.remove=function(e,t){if(0<e.length)for(var n in c){var r=c[n];if(r.controller!==t){var i=[];for(var a in e){var s=e[a];0<=r.view.channels.map(function(e){return e.url}).indexOf(s.url)&&i.push(s)}0<i.length&&r.view.removeViewItems(i)}}},this.hide=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(0<e.length){var r=Ds.getInstance().sb;for(var i in c){var a=c[i];if(a.controller!==t){var s=[];for(var o in e){var u=e[o];Rs(u,a.controller.query)&&s.push(u)}if(0<s.length)switch(a.controller.query.hiddenChannelFilter){case r.GroupChannel.HiddenChannelFilter.UNHIDDEN:a.view.removeViewItems(s);break;case r.GroupChannel.HiddenChannelFilter.HIDDEN:case r.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case r.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:n.isEventChannel=!0,a.view.addViewItems(s,n)}}}}},this.unhide=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(0<e.length){var r=Ds.getInstance().sb;for(var i in c){var a=c[i];if(a.controller!==t){var s=[];for(var o in e){var u=e[o];Rs(u,a.controller.query)&&s.push(u)}if(0<s.length)switch(a.controller.query.hiddenChannelFilter){case r.GroupChannel.HiddenChannelFilter.UNHIDDEN:n.isEventChannel=!0,a.view.addViewItems(s,n);break;case r.GroupChannel.HiddenChannelFilter.HIDDEN:case r.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case r.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:a.view.removeViewItems(s)}}}}},this.clear=function(){for(var e in c){c[e].view.clearViewItem()}},this}var xs="channel-changeLog-token",Us="syncManager_channelManager_channelHandler_"+(new Date).getTime(),Ns=null,Ds=function(){function i(e){var t=e.sendBird,n=e.db;if(Hr(this,i),!Ns){Ss.call("ChannelManager()");var u=(Ns=this).sb=t,c=Ho.getInstance();this.channelContainer=new Es(n,u),this.queryContainer=new Cs(n,u),this.broadcast=new _s,this.isFetchingChangeLog=!1,this.channelSyncByFilter={},this.changeLogSync=null;var r=new u.ChannelHandler;Object.keys(r).forEach(function(o){r[o]=function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];switch(o){case"onChannelChanged":var r=n[0];Ss.event(o,r.url),Ns.channelContainer.getItem(r.url,function(e,n){e?Os.throw(e):Ns.channelContainer.upsert(r,function(e,t){e?Os.throw(e):n?n.hiddenState!==u.GroupChannel.HiddenState.UNHIDDEN&&r.hiddenState===u.GroupChannel.HiddenState.UNHIDDEN?Ns.broadcast.unhide([t]):Ns.broadcast.update([t]):Ns.broadcast.upsert([t])})});break;case"onUserMuted":case"onUserUnmuted":case"onUserUnbanned":case"onChannelFrozen":case"onChannelUnfrozen":case"onMetaDataCreated":case"onMetaDataUpdated":case"onMetaDataDeleted":case"onMetaCountersCreated":case"onMetaCountersUpdated":case"onMetaCountersDeleted":Ss.event(o,n[0].url),Ns.channelContainer.upsert(n[0],function(e,t){e?Os.throw(e):Ns.broadcast.update([t])});break;case"onUserReceivedInvitation":case"onUserJoined":Ss.event(o,n[0].url),Ns.channelContainer.upsert(n[0],function(e,t){e?Os.throw(e):n[1].userId===c.currentUserId?Ns.broadcast.upsert([t]):Ns.broadcast.update([t])});break;case"onReadReceiptUpdated":Ns.channelContainer.upsert(n[0],function(e){e&&Os.throw(e)});break;case"onMessageReceived":n[0].lastMessage&&n[0].lastMessage.messageId!==n[1].messageId||Ns.channelContainer.upsert(n[0],function(e,t){e?Os.throw(e):Ns.broadcast.upsert([t])});break;case"onChannelHidden":Ss.event(o,n[0].url);var i=n[0];Ns.channelContainer.upsert(i,function(e){e?Os.throw(e):Ns.broadcast.hide([i])});break;case"onUserLeft":case"onUserBanned":Ss.event(o,n[0].url);var a=n[0];n[1].userId===c.currentUserId?Ns.channelContainer.remove(a,function(e){e?Os.throw(e):Ns.broadcast.remove([a])}):Ns.channelContainer.upsert(a,function(e,t){e?Os.throw(e):Ns.broadcast.update([t])});break;case"onUserDeclinedInvitation":Ss.event(o,n[0].url);var s=n[0];n[2].userId===c.currentUserId?Ns.channelContainer.remove(s,function(e){e?Os.throw(e):Ns.broadcast.remove([s])}):Ns.channelContainer.upsert(s,function(e,t){e?Os.throw(e):Ns.broadcast.update([t])});break;case"onChannelDeleted":Ss.event(o,n[0]),Ns.channelContainer.getItem(n[0],function(e,t){e?Os.throw(e):t&&Ns.channelContainer.remove(t,function(e){e?Os.throw(e):Ns.broadcast.remove([t])})})}}}),u.addChannelHandler(Us,r)}return Ns}return Kr(i,[{key:"syncChangeLog",value:function(o,u){var c=this;if(this.isFetchingChangeLog)u(Os.create(Os.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLog=!0,Ss.call("channel syncChangeLog()");var l="".concat(xs);ds.get(l).then(function(e){var t,n="getMyGroupChannelChangeLogsByToken",r=[];r.push([]),r.push(!0),e?(n="getMyGroupChannelChangeLogsByToken",r.unshift(e)):(n="getMyGroupChannelChangeLogsByTimestamp",r.unshift((new Date).getTime()-100)),Ss.call(n),(t=c.sb)[n].apply(t,r.concat([function(s,e){if(c.sb.getErrorFirstCallback()){var t=s;s=e,e=t}if(e)c.isFetchingChangeLog=!1;else{Ss.sync("updated",s.updatedChannels&&0<s.updatedChannels.length?"\n"+s.updatedChannels.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n"):[]),Ss.sync("deleted",s.deletedChannelUrls);var n=[];s.updatedChannels.forEach(function(t){n.push(new Promise(function(o,u){Ns.channelContainer.getItem(t.url,function(e,s){e?u(e):Ns.channelContainer.upsert(t,function(e,t){if(e)u(e);else{var n=!s||!s.isEqual(t),r=(!s||s.hiddenState===c.sb.GroupChannel.HiddenState.UNHIDDEN)&&t.hiddenState!==c.sb.GroupChannel.HiddenState.UNHIDDEN,i=(!s||s.hiddenState!==c.sb.GroupChannel.HiddenState.UNHIDDEN)&&t.hiddenState===c.sb.GroupChannel.HiddenState.UNHIDDEN,a=n?"update":"noop";r?a="hide":i&&(a="unhide"),o({action:a,channel:t})}})})}))}),s.deletedChannelUrls.forEach(function(e){n.push(new Promise(function(n,r){Ns.channelContainer.getItem(e,function(e,t){e?r(e):t&&Ns.channelContainer.remove(t,function(e){if(e)r(e);else{n({action:"remove",channel:t})}})})}))}),Promise.all(n).then(function(e){for(var t=[],n=[],r=[],i=[],a=0;a<e.length;a++)switch(e[a].action){case"update":t.push(e[a].channel);break;case"remove":n.push(e[a].channel);break;case"hide":r.push(e[a].channel);break;case"unhide":i.push(e[a].channel)}0<t.length&&Ns.broadcast.upsert(t,null,{isChangeLogChannel:!0}),0<n.length&&Ns.broadcast.remove(n),0<r.length&&Ns.broadcast.hide(r,null,{isChangeLogChannel:!0}),0<i.length&&Ns.broadcast.unhide(i,null,{isChangeLogChannel:!0}),ds.set(l,s.token).then(function(){s.hasMore?c.syncChangeLog(o,u):(c.isFetchingChangeLog=!1,u())}).catch(function(e){c.isFetchingChangeLog=!1,u(e)})}).catch(function(e){return u(e)})}}]))}).catch(function(e){c.isFetchingChangeLog=!1,u(e)})}}},{key:"start",value:function(){Ns.broadcast.resume()}},{key:"stop",value:function(){Ns.broadcast.pause()}},{key:"clearCache",value:function(n){Ns.channelSyncByFilter={},Ns.changeLogSync=null,Ns.channelContainer.clear(function(){Ns.queryContainer.clear(function(){ds.getKeys().then(function(e){var t=[];e.forEach(function(e){e.startsWith(xs)&&t.push(ds.remove(e))}),Promise.all(t).then(function(){return n()}).catch(function(e){Ss.error(e),n(e)})}).catch(function(e){return n(e)})})})}},{key:"reset",value:function(e){Ns?(Ns.broadcast.clear(),Ns.clearCache(e)):e(null)}}],[{key:"getInstance",value:function(){return Ns}},{key:"clear",value:function(){Ns&&Ns.sb&&(Ss.message("ChannelManager is cleared"),Ns.channelSyncByFilter={},Ns.changeLogSync=null,Ns.broadcast.clearCollection(),Ns.sb.removeChannelHandler(Us),Ns=null)}}]),i}(),Fs=Math.max,Ls=Math.min,Ps=Math.floor,qs=/\$([$&'`]|\d\d?|<[^>]*>)/g,js=/\$([$&'`]|\d\d?)/g;function Bs(e,t){return(1<arguments.length&&void 0!==t?t:[]).map(function(e){return e.url}).indexOf(e.url)}function Vs(e,t,n){var r=2<arguments.length&&void 0!==n?n:[],i=null,a=function(e,t){return t<e};switch(t.order){case"latest_last_message":i="lastMessageUpdatedAt";break;case"chronological":i="createdAt";break;case"channel_name_alphabetical":i="name",a=function(e,t){return e.localeCompare(t)<0};break;default:i="lastMessageUpdatedAt"}var s=Bs(e,r);s<0&&(s=r.length);for(var o=0;o<r.length;o++){var u=r[o];if(e[i]===u[i]&&e.url===u.url){s=o;break}if(a(e[i],u[i])){s=o;break}}return s}function Gs(e,t){for(var n=1<arguments.length&&void 0!==t?t:[],r=0;r<n.length;r++)if(e.isIdentical(n[r]))return r;return-1}function Qs(e,t){for(var n=1<arguments.length&&void 0!==t?t:[],r=n.length,i=0;i<n.length;i++)if(n[i].createdAt>=e.createdAt){r=i;break}return r}ta("replace",2,function(i,k,E){return[function(e,t){var n=u(this),r=null==e?void 0:e[i];return void 0!==r?r.call(e,n,t):k.call(String(n),e,t)},function(e,t){var n=E(k,e,this,t);if(n.done)return n.value;var r=w(e),i=String(this),a="function"==typeof t;a||(t=String(t));var s=r.global;if(s){var o=r.unicode;r.lastIndex=0}for(var u=[];;){var c=ra(r,i);if(null===c)break;if(u.push(c),!s)break;""===String(c[0])&&(r.lastIndex=na(i,A(r.lastIndex),o))}for(var l,f="",h=0,d=0;d<u.length;d++){c=u[d];for(var g=String(c[0]),v=Fs(Ls(M(c.index),i.length),0),p=[],y=1;y<c.length;y++)p.push(void 0===(l=c[y])?l:String(l));var m=c.groups;if(a){var I=[g].concat(p,v,i);void 0!==m&&I.push(m);var b=String(t.apply(void 0,I))}else b=C(g,i,v,p,m,t);h<=v&&(f+=i.slice(h,v)+b,h=v+g.length)}return f+i.slice(h)}];function C(a,s,o,u,c,e){var l=o+a.length,f=u.length,t=js;return void 0!==c&&(c=Se(c),t=qs),k.call(e,t,function(e,t){var n;switch(t.charAt(0)){case"$":return"$";case"&":return a;case"`":return s.slice(0,o);case"'":return s.slice(l);case"<":n=c[t.slice(1,-1)];break;default:var r=+t;if(0==r)return e;if(f<r){var i=Ps(r/10);return 0===i?e:i<=f?void 0===u[i-1]?t.charAt(1):u[i-1]+t.charAt(1):e}n=u[r-1]}return void 0===n?"":n})}});function Hs(){var n=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(n+16*Math.random())%16|0;return n=Math.floor(n/16),("x"===e?t:3&t|8).toString(16)})}function zs(e,t){if(!t)return new Promise(function(t,n){e(function(e){return e?n(e):t()})});e(t)}var Ks="unsent";function Ws(e){return"".concat(Ks,"-").concat(e)}function Js(e){if(e)if(e.requestState&&"succeeded"!==e.requestState){if(!e.reqId)throw Os.throw(Os.create(Os.Type.ERROR_INVALID_PARAMETER));e.messageId=Ws(e.reqId)}else e.messageId="".concat(e.messageId)}function Xs(e,n){function s(e,n){var t=Ho.getInstance(),r=e.isDeleted?e:c(e.serialize());Js(r),r.messageId?t.currentUserId?(r.hasOwnProperty("isVisible")||(r.isVisible=!0),r.hasOwnProperty("isDeleted")||(r.isDeleted=!1),r.ownerUserId=t.currentUserId,Ss.cache("upsert message",r.messageId,r.createdAt,r.reqId,"owner="+r.ownerUserId,"visible="+r.isVisible,"deleted="+r.isDeleted),i.findById(r.messageId,function(e,t){e?n(e):t?t.isDeleted?n(null,t):(r.isVisible=r.isVisible||t.isVisible,i.upsert(r.serialize(),function(e,t){e?n(e):n(null,t)})):i.upsert(r.serialize(),function(e,t){e?n(e):n(null,t)})})):n(Os.create(Os.Type.ERROR_SETUP_MISSING)):n(null,e)}function o(e,t){return t.messageType&&(e.messageType=t.messageType),t.customType&&(e.customType=t.customType),t.senderUserIdsFilter&&0<t.senderUserIdsFilter.length&&(e["sender.userId"]={"/in":t.senderUserIdsFilter}),e}var u=this,i=e.collection("Message"),c=function(e){var t=null;return e&&("user"===e.messageType?t=n.UserMessage.buildFromSerializedData(e):"file"===e.messageType?t=n.FileMessage.buildFromSerializedData(e):"admin"===e.messageType&&(t=n.AdminMessage.buildFromSerializedData(e))),t&&function(e){e&&(e.requestState&&"succeeded"!==e.requestState?e.messageId=0:e.messageId=parseInt(e.messageId))}(t),t};return this.query=function(e,t,a){e.isVisible=!0,e.isDeleted=!1;var n=Ho.getInstance();if(n.currentUserId){e.ownerUserId=n.currentUserId;var r=new Ho.LocalDB.Query(e);t&&(r.offset=t.offset||0,r.limit=t.limit||50,r.desc=t.desc),r.index={ownerUserId:Ho.LocalDB.Query.Order.ASC,channelUrl:Ho.LocalDB.Query.Order.ASC,createdAt:Ho.LocalDB.Query.Order.DESC},i.find(r,function(e,t){if(e)a(e);else{for(var n=[],r=0;r<t.length;r++){var i=c(t[r]);n.push(i)}a(null,n)}})}else a(Os.create(Os.Type.ERROR_SETUP_MISSING))},this.find=function(e,t){i.find(e,t)},this.count=function(e,t){i.count(e,t)},this.upsert=function(e,n){e?s(e,function(e,t){e?n(e):n(null,c(t))}):n(null)},this.remove=function(i,a){u.getItem(i,function(e,t){var n=Ho.getInstance(),r={messageId:i,isDeleted:!0,serialize:function(){return{messageId:"".concat(i),ownerUserId:t?t.ownerUserId:n.currentUserId,channelUrl:t?t.channelUrl:"",createdAt:t?t.createdAt:0,requestState:t?t.requestState:"succeeded",isVisible:!1,isDeleted:!0}}};s(r,function(e){e?a(e):a(null,i)})})},this.removeUnsent=function(e,n){var t=Ws(e);u.getItem(t,function(e,t){e?n(e):t?function(e,t){Ho.getInstance().currentUserId?(Ss.cache("remove message",e.messageId),Js(e),i.remove(e.messageId,t)):t(Os.create(Os.Type.ERROR_SETUP_MISSING))}(t,n):n(null)})},this.removeExpiredMessages=function(e,t){var n=(new Date).getTime()-864e5*e,r=new Ho.LocalDB.Query({ownerUserId:Ho.getInstance().currentUserId,requestState:"failed",createdAt:{"<":n}});r.limit=Number.MAX_SAFE_INTEGER,r.index={ownerUserId:Ho.LocalDB.Query.Order.ASC,createdAt:Ho.LocalDB.Query.Order.ASC},i.removeIf(r,t)},this.getItemWithVisibility=function(e,n){i.findById(e,function(e,t){e?n(e):n(null,{item:c(t),isVisible:!!t&&t.isVisible})})},this.getItem=function(e,n){i.findById(e,function(e,t){e?n(e):n(null,c(t))})},this.clear=function(e){return function(t){Ss.cache("clear messages"),i.clear(function(e){return t(e)})}(e)},this.loadPreviousSucceededMessages=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:(new Date).getTime(),r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},i=4<arguments.length?arguments[4]:void 0,a={channelUrl:e,requestState:{"!=":"failed"},createdAt:{"<=":n}};o(a,t),r.desc=!0,u.query(a,r,i)},this.loadNextSucceededMessages=function(e){var t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},n=4<arguments.length?arguments[4]:void 0,r={channelUrl:e,requestState:{"!=":"failed"},createdAt:{">=":2<arguments.length&&void 0!==arguments[2]?arguments[2]:0}};o(r,1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}),t.desc=!1,u.query(r,t,n)},this.loadFailedMessages=function(e){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=3<arguments.length?arguments[3]:void 0,r={channelUrl:e,requestState:"failed"};o(r,1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}),t.limit=Number.MAX_SAFE_INTEGER,t.desc=!0,u.query(r,t,n)},this.loadOldestFailedMessages=function(e){var t={requestState:"failed"};o(t,{});var n={limit:Number.MAX_SAFE_INTEGER,desc:!1};u.query(t,n,e)},this}var Ys=La.onFreeze,$s=Object.freeze,Zs=p(function(){$s(1)});Ae({target:"Object",stat:!0,forced:Zs,sham:!Fa},{freeze:function(e){return $s&&y(e)?$s(Ys(e)):e}});function eo(e){var t=[];for(var n in e)t.push("".concat(n,"=").concat(e[n]));return t.join("&")}function to(e){var o=this,u=e.collection("MessageChunk");return this.reload=function(e,t){return u.findById(e.chunkId,t)},this.upsert=function(e,n){!function(e,n){var t=Ho.getInstance();t.currentUserId?(e.ownerUserId=t.currentUserId,no[e.chunkId]=e,u.upsert(no[e.chunkId].serialize(),function(e,t){e?n(e):n(null,t)})):n(Os.create(Os.Type.ERROR_SETUP_MISSING))}(e,function(e,t){e?n(e):n(null,ro.createFromJson(t))})},this.remove=function(t,n){!function(e,n){Ho.getInstance().currentUserId?(no[e]&&delete no[e],u.remove(e,function(e,t){e?n(e):n(null,t)})):n(Os.create(Os.Type.ERROR_SETUP_MISSING))}(t,function(e){e?n(e):n(null,t)})},this.clear=function(e){return function(t){no={},u.clear(function(e){return t(e)})}(e)},this.getChunkByTimestamp=function(r,e,a,s){var t=Ho.getInstance();if(t.currentUserId){var n=new Ho.LocalDB.Query({ownerUserId:t.currentUserId,channelUrl:r,filterKey:eo(e),startAt:{"<=":a},endAt:{">=":a}});n.limit=1,n.index={ownerUserId:Ho.LocalDB.Query.Order.ASC,channelUrl:Ho.LocalDB.Query.Order.ASC,filterKey:Ho.LocalDB.Query.Order.ASC,endAt:Ho.LocalDB.Query.Order.DESC},u.find(n,function(e,t){if(e)s(e);else{var i=0<t.length?ro.createFromJson(t[0]):null;if(i)if(i.hasDefaultFilter())s(null,i);else{var n=new Ho.LocalDB.Query({channelUrl:r,filterKey:eo(ro.getDefaultFilter()),startAt:{"<=":a}});n.limit=1,n.index={ownerUserId:Ho.LocalDB.Query.Order.ASC,channelUrl:Ho.LocalDB.Query.Order.ASC,filterKey:Ho.LocalDB.Query.Order.ASC,endAt:Ho.LocalDB.Query.Order.DESC},u.find(n,function(e,t){if(e)s(e);else{var n=0<t.length?ro.createFromJson(t[0]):null;if(n)if(n.endAt>i.endAt)if(n.isOverlap(i))i.extendWithChunk(n),o.upsert(i,s);else{var r=new ro(i.channelUrl,i.filter);r.startAt=n.startAt,r.endAt=n.endAt,o.upsert(r,s)}else s(null,i);else s(null,i)}})}else s(null)}})}else s(Os.create(Os.Type.ERROR_SETUP_MISSING))},this.mergePreviousChunkOverlap=function(r,i){var e=Ho.getInstance();if(e.currentUserId){var t=new Ho.LocalDB.Query({ownerUserId:e.currentUserId,chunkId:{"!=":r.chunkId},channelUrl:r.channelUrl,filterKey:r.filterKey,endAt:{">=":r.startAt}});t.limit=1/0,u.find(t,function(e,n){if(e)i(e);else if(0<n.length){var t=new Ho.LocalDB.Query({chunkId:{"/in":n.map(function(e){return e.chunkId})}});u.removeIf(t,function(e){if(e)i(e);else{for(var t=0;t<n.length;t++)r.extendWithChunk(n[t]);o.upsert(r,i)}})}else o.upsert(r,i)})}else i(Os.create(Os.Type.ERROR_SETUP_MISSING))},this}var no={},ro=function(){function n(e,t){Hr(this,n),this.chunkId=Hs(),this.channelUrl=e,this.filterKey=eo(t),this.filter=t,this.startAt=(new Date).getTime(),this.endAt=0}return Kr(n,[{key:"hasDefaultFilter",value:function(){var e=n.getDefaultFilter();return function t(n,r){var e=Qr(n),i=Qr(r);return!n||!r||"object"!==e||e!==i||n instanceof Date?n instanceof Date?n.getTime()===r.getTime():"function"===e&&"function"===i||n===r:Object.keys(n).length===Object.keys(r).length&&Object.keys(n).every(function(e){return t(n[e],r[e])})}(this.filter,e)}},{key:"isOverlap",value:function(e){return e.startAt<=this.startAt&&this.startAt<=e.endAt||e.startAt<=this.endAt&&this.endAt<=e.endAt}},{key:"isSame",value:function(e){return!!e&&(e.startAt===this.startAt&&this.endAt===e.endAt)}},{key:"contains",value:function(e){return this.startAt<=e&&e<=this.endAt}},{key:"containsMessage",value:function(e){return this.contains(e.createdAt)}},{key:"serialize",value:function(){var e=JSON.parse(JSON.stringify(this));return Object.freeze(e)}},{key:"extendForward",value:function(e){this.endAt=Math.max(this.endAt,e)}},{key:"extendBackward",value:function(e){this.startAt=Math.min(this.startAt,e)}},{key:"extendWithChunk",value:function(e){return this.extendForwardWithChunk(e),this.extendBackwardWithChunk(e),this}},{key:"extendForwardWithChunk",value:function(e){return this.extendForward(e.endAt),this}},{key:"extendBackwardWithChunk",value:function(e){return this.extendBackward(e.startAt),this}},{key:"extendWithMessage",value:function(e){return this.extendForwardWithMessage(e),this.extendBackwardWithMessage(e),this}},{key:"extendForwardWithMessage",value:function(e){return this.extendForward(e.createdAt),this}},{key:"extendBackwardWithMessage",value:function(e){return this.extendBackward(e.createdAt),this}}],[{key:"createFromJson",value:function(e){var t=new n(e.channelUrl,e.filter);return t.chunkId=e.chunkId,t.startAt=e.startAt,t.endAt=e.endAt,t}},{key:"getDefaultFilter",value:function(){return{messageTypeFilter:null,customTypeFilter:null,senderUserIdsFilter:[],includeMetaArray:!0}}},{key:"MessageTypeFilterRealValue",get:function(){return["","user","file","admin"]}}]),n}();function io(e,t,n){return n?t.channelUrl===e.url&&((!n.messageType||n.messageType===t.messageType)&&((!n.customType||n.customType===t.customType)&&!(Array.isArray(n.senderUserIdsFilter)&&0<n.senderUserIdsFilter.length&&t.sender&&n.senderUserIdsFilter.indexOf(t.sender.userId)<0))):t.channelUrl===e.url}function ao(){var o=[];return this.addCollection=function(e,t){o.push({controller:e,view:t})},this.removeCollection=function(e){var t=o.map(function(e){return e.controller}).indexOf(e);0<=t&&(o[t].controller._pause(),o.splice(t,1))},this.clearCollection=function(){for(var e in o)o[e].controller._pause();o=[]},this.pause=function(){for(var e in o)o[e].controller._pause()},this.resume=function(){for(var e in o)o[e].controller._resume()},this.upsert=function(e,t){if(0<e.length)for(var n in o){var r=o[n];if(r.controller!==t){var i=[];for(var a in e){var s=e[a];io(r.controller.channel,s,r.controller.filter)&&i.push(s)}0<i.length&&r.view.addViewItems(i,{isEventMessage:!0,direction:"next"})}}},this.update=function(e,t){if(0<e.length)for(var n in o){var r=o[n];if(r.controller!==t){var i=[];for(var a in e){var s=e[a];io(r.controller.channel,s,r.controller.filter)&&0<=r.view.messages.map(function(e){return e.messageId}).indexOf(s.messageId)&&i.push(s)}0<i.length&&r.view.addViewItems(i,{isEventMessage:!0,direction:"next"})}}},this.read=function(e,t){for(var n in o){var r=o[n];r.controller!==t&&r.controller.channel.url===e.url&&(r.controller.channel=e,r.view.addViewItems(r.view.messages))}},this.remove=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(0<e.length)for(var r in o){var i=o[r];i.controller!==t&&i.view.removeViewItems(e,n)}},this.clear=function(){for(var e in o){o[e].view.clearViewItem()}},this.updateCurrentChunk=function(e){for(var t in o){o[t].view.updateCurrentChunk(e)}},this}function so(){this.onChannelEvent=function(e,t){}}function oo(){this.onPendingMessageEvent=function(e,t){},this.onFailedMessageEvent=function(e,t,n){},this.onSucceededMessageEvent=function(e,t){},this.onNewMessage=function(e){},this.onMessageEvent=function(e,t){}}function uo(o){var u=Ds.getInstance();if(u){var c=o.query,e=c.filterKey;return u.channelSyncByFilter[e]||(u.channelSyncByFilter[e]=new Co(function(e,s){Ss.call("channel syncChannel()",c.filterKey,c.hasNext,c._token),c.hasNext?(c.limit=100,c.next(function(a,e){if(u.sb.getErrorFirstCallback()){var t=[a,e];e=t[0],a=t[1]}Ss.sync("channel",e,a&&0<a.length?"\n"+a.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n"):""),e?s(e):function(){for(var n=Mo.get(o),r=0,i=null,e=0;e<a.length;e++)u.channelContainer.insert(a[e],function(e){if(i=i||e,++r===a.length)if(i)s(i);else{var t=n.findChannelEdges(a);t.end&&(c.savepoint=t.end+""),u.queryContainer.upsert(c,function(e){e?s(e):s(null,{count:a.length,nextTs:0,hasNext:c.hasNext})})}})}()})):s(null,{count:0,nextTs:0,hasNext:!1})})),u.channelSyncByFilter[e]}return null}function co(e){var n=Ds.getInstance();if(n){if(!n.changeLogSync){var r=e.query;n.changeLogSync=new Co(function(e,t){n.syncChangeLog(r,function(e){t(e,{count:0,nextTs:0,hasNext:!1})})})}return n.changeLogSync}return null}var lo={INSERT:"insert",UPDATE:"update",MOVE:"move",REMOVE:"remove",CLEAR:"clear"},fo={INSERT:"insert",UPDATE:"update",REMOVE:"remove",CLEAR:"clear"},ho={NONE:"none",UPDATE_RESEND_FAILED:"update_resend_failed",REMOVE_RESEND_SUCCEEDED:"remove_resend_succeeded",REMOVE_RETENTION_EXPIRED:"remove_retention_expired",REMOVE_EXCEEDED_MAX_COUNT:"remove_exceeded_max_count",REMOVE_MANUAL_ACTION:"remove_manual_action",REMOVE_UNKNOWN:"remove_unknown"},go=function(){function i(e){var t=this,n=e.channelUrl;Hr(this,i),this._resendingTimer=null;var r=!1;Object.defineProperty(this,"_isRunning",{get:function(){return r},set:function(e){r!==(r=e)&&t._toggleResendingInterval()}}),this._clear(),this.collectionReferenceCount=1,this._channelUrl=n}return Kr(i,[{key:"_clear",value:function(e){var t=0<arguments.length&&void 0!==e?e:{noManualMessages:!1};this._retryCount=0,this._delayTime=0,this._isRunning=!1,t.noManualMessages||(this.manualMessages=[]),this.automaticMessages=[],clearTimeout(this._resendingTimer),this._resendingTimer=null}},{key:"_appendMessagesWithOrder",value:function(e,t){var a=this,n=1<arguments.length&&void 0!==t?t:{},s=n.hasOwnProperty("isAutomatic")?n.isAutomatic:Ho.syncManagerOptions.messageResendPolicy===Ho.Options.MessageResendPolicy.AUTOMATIC;e.forEach(function(e){for(var t=s?a.automaticMessages.length:a.manualMessages.length,n=t,r=0;r<t;r++){var i=s?a.automaticMessages[r]:a.manualMessages[r];if(e.createdAt<i.createdAt){n=r;break}}s?a.automaticMessages.splice(n,0,e):a.manualMessages.splice(n,0,e)})}},{key:"appendMessages",value:function(r){for(var i=this,e=0===this.automaticMessages.length,a=Ho.syncManagerOptions.messageResendPolicy===Ho.Options.MessageResendPolicy.AUTOMATIC,t=r.length,s=[],n=function(e){var t=r[e];!1;var n=[];a&&(n=i.automaticMessages),0<[].concat(Zr(n),Zr(i.manualMessages)).filter(function(e){return e.reqId===t.reqId}).length||s.push(t)},o=0;o<t;o++)n(o);this._appendMessagesWithOrder(s),e&&0<this.automaticMessages.length&&this._resendUserMessage()}},{key:"removeMessages",value:function(n){for(var r=this,i=Ho.syncManagerOptions.messageResendPolicy===Ho.Options.MessageResendPolicy.AUTOMATIC,e=n.length,a=!1,t=function(e){var t=n[e];a=!1,i&&(r.automaticMessages=r.automaticMessages.filter(function(e){return e.reqId!==t.reqId||!(a=!0)})),a||(r.manualMessages=r.manualMessages.filter(function(e){return e.reqId!==t.reqId}))},s=0;s<e;s++)t(s)}},{key:"_resendUserMessage",value:function(){var u=this;if(this._retryCount++,Ho.syncManagerOptions.automaticMessageResendRetryCount!==Ho.Options.INFINITY&&this._retryCount>Ho.syncManagerOptions.automaticMessageResendRetryCount)return this._appendMessagesWithOrder(this.automaticMessages,{isAutomatic:!1}),this.automaticMessages=[],yo.getInstance().upsertMessages(this._channelUrl,this.manualMessages),void this._clear({noManualMessages:!0});this._resendingTimer=setTimeout(function(){var a=u.automaticMessages[0];if(a&&u._isRunning){var s=ko.getInstance(),e=s.sb,o=e.getErrorFirstCallback();e.GroupChannel.getChannel(u._channelUrl,function(e,t){if(o){var n=t;t=e,e=n}t?(u._increaseDelayTime(),u._resendUserMessage()):e.resendUserMessage(a,function(e,t){if(o){var n=t;t=e,e=n}if(t){if(800110===t.code){var r={reason:ho.REMOVE_UNKNOWN};yo.getInstance().removeMessages(u._channelUrl,[a],r),u.removeMessages([a])}else u._increaseDelayTime();u._resendUserMessage()}else{u.removeMessages([a]),u._retryCount=0,u._delayTime=0;var i={reason:ho.REMOVE_RESEND_SUCCEEDED};yo.getInstance().removeMessages(u._channelUrl,[a],i),s.messageContainer.upsert(e,function(e,t){e||s.broadcast.upsert([t]),u._resendUserMessage()})}})})}else u._retryCount=0,u._delayTime=0},this._delayTime)}},{key:"_increaseDelayTime",value:function(){this._delayTime=1e4===this._delayTime?this._delayTime:this._delayTime+2e3}},{key:"_toggleResendingInterval",value:function(){this._isRunning?this._resendUserMessage():(clearTimeout(this._resendingTimer),this._resendingTimer=null,this._retryCount=0,this._delayTime=0)}},{key:"resumeResending",value:function(){Ss.call("FailedMessageQueue resumeResending()"),this._retryCount=0,this._delayTime=0,this._isRunning=!0}},{key:"pauseResending",value:function(){Ss.call("FailedMessageQueue pauseResending()"),this._isRunning=!1}},{key:"increaseCount",value:function(){++this.collectionReferenceCount}},{key:"decreaseCount",value:function(){--this.collectionReferenceCount,0===this.collectionReferenceCount&&this._clear()}}]),i}(),vo=function(){function o(e){var t=e.msec,n=void 0===t?0:t,r=e.isEternal,i=void 0===r||r,a=e.timeoutFn,s=void 0===a?function(){}:a;Hr(this,o),this.time=n,this.isEternal=i,this.timeoutFn=s,this.checker=null}return Kr(o,[{key:"reset",value:function(){this.stop(),this.time=0,this.timeoutFn=function(){}}},{key:"start",value:function(){var e=this;if(null===this.checker){var t=(new Date).getTime();this.checker=setTimeout(function(){(new Date).getTime()-t>=e.time&&(e.isEternal?e.start():e.stop(),e.timeoutFn&&"function"==typeof e.timeoutFn&&e.timeoutFn())},432e5)}}},{key:"stop",value:function(){clearTimeout(this.checker),this.checker=null}}]),o}(),po=null,yo=function(){function e(){if(Hr(this,e),po)return po;this.queueMap={},this.expirationTimer=new vo({msec:864e5*Ho.syncManagerOptions.failedMessageRetentionDays,isEternal:!0,timeoutFn:this.removeExpiredMessages}),this.oldestFailedMessageTs=0,po=this}return Kr(e,[{key:"getMessages",value:function(e){return this.queueMap[e]?this.queueMap[e].messages:[]}},{key:"loadFailedMessages",value:function(i,a,s){var o=this;ko.getInstance().messageContainer.loadFailedMessages(i,{},{},function(e,t){var n=t;if(!e){Ss.cache("fetch failed message",t.map(function(e){return e.reqId}));var r=o.queueMap[i];r&&(r.appendMessages(t),r.resumeResending()),n=t.filter(function(e){var t=!0,n=!0,r=!0;if(a.messageTypeFilter&&(t=e.messageType===ro.MessageTypeFilterRealValue[a.messageTypeFilter]),a.customTypeFilter&&(n=e.customType===a.customTypeFilter),a.senderUserIdsFilter&&Array.isArray(a.senderUserIdsFilter)&&0<a.senderUserIdsFilter.length&&(r=e.sender&&-1<a.senderUserIdsFilter.indexOf(e.sender.userId)),t&&n&&r)return e})}s(e,n)})}},{key:"removeExpiredMessages",value:function(n){var i=this;this.expirationTimer.stop();var e=Math.floor(((new Date).getTime()-this.oldestFailedMessageTs)/864e5);if(0!==this.oldestFailedMessageTs&&e<Ho.syncManagerOptions.failedMessageRetentionDays)return this.expirationTimer.start(),void(n&&n());var a=ko.getInstance(),t=Ho.syncManagerOptions.failedMessageRetentionDays;a.messageContainer.removeExpiredMessages(t,function(e,t){if(e)return Ss.error("Fail remove expired failedMessage by failedMessageRetentionDays:",e),i.expirationTimer.start(),void(n&&n());var r={};t.forEach(function(e){var t=e.channelUrl;r[t]&&Array.isArray(r[t])||(r[t]=[]),r[t].push(e)}),Object.keys(r).forEach(function(e){var t=r[e].map(function(e){return e.reqId}),n={isRequestId:!0,reason:ho.REMOVE_RETENTION_EXPIRED};a.broadcast.remove(t,{},n),i.queueMap.hasOwnProperty(e)&&i.queueMap[e].removeMessages(r[e])}),a.messageContainer.loadOldestFailedMessages(function(e,t){e?(Ss.error("Fail get oldestFailedMessage from DB: ",e),i.oldestFailedMessageTs=0):i.oldestFailedMessageTs=0<t.length?t[0].createdAt:(new Date).getTime(),i.expirationTimer.start(),n&&n()})})}},{key:"removeExceedingMaxCount",value:function(e){var i=this,a=ko.getInstance(),r=new Ho.LocalDB.Query({ownerUserId:Ho.getInstance().currentUserId,channelUrl:e,requestState:"failed"});r.limit=Number.MAX_SAFE_INTEGER,r.index={ownerUserId:Ho.LocalDB.Query.Order.ASC,createdAt:Ho.LocalDB.Query.Order.ASC},a.messageContainer.count(r,function(e,t){if(e)Ss.error("Get count about failedMessage by maxFailedMessageCountPerChannel:",e);else{var n=Ho.syncManagerOptions.maxFailedMessageCountPerChannel;n<t&&(r.limit=t-n,a.messageContainer.find(r,function(e,t){var r={isRequestId:!0,reason:ho.REMOVE_EXCEEDED_MAX_COUNT};t.forEach(function(t){var n=t.reqId;a.messageContainer.removeUnsent(n,function(e){e&&Ss.error("Fail remove count failedMessage by maxFailedMessageCountPerChannel:",e),a.broadcast.remove([n],{},r),i.queueMap[t.channelUrl].removeMessages([t])})})}))}})}},{key:"upsertMessages",value:function(r,e){var i=this,a=ko.getInstance(),s=this.queueMap[r];e.forEach(function(n){a.messageContainer.upsert(n,function(e,t){e||a.broadcast.upsert([t]),s&&s.appendMessages([n]),i.removeExceedingMaxCount(r)})})}},{key:"removeMessages",value:function(e,t,n){var r=ko.getInstance(),i=this.queueMap[e];t.forEach(function(t){t.reqId&&r.messageContainer.removeUnsent(t.reqId,function(e){e?Ss.error("deleteMessage()","Failed to delete message from cache: ".concat(t)):(n.isRequestId=!0,r.broadcast.remove([t.reqId],{},n),i&&i.removeMessages([t]))})})}},{key:"resume",value:function(){var e=this;Ss.call("FailedMessageDispatcher resume()"),this.removeExpiredMessages(function(){e.resumeAllQueues()})}},{key:"pause",value:function(){Ss.call("FailedMessageDispatcher pause()"),this.pauseAllQueues(),this.expirationTimer.stop()}},{key:"resumeAllQueues",value:function(){var n=this;Object.keys(this.queueMap).forEach(function(e){var t=n.queueMap[e];t&&t.resumeResending()})}},{key:"pauseAllQueues",value:function(){var n=this;Object.keys(this.queueMap).forEach(function(e){var t=n.queueMap[e];t&&t.pauseResending()})}},{key:"createQueue",value:function(e){var t=this.queueMap[e];t?t.increaseCount():this.queueMap[e]=new go({channelUrl:e}),this.queueMap[e].resumeResending()}},{key:"removeQueue",value:function(e){var t=this.queueMap[e];t&&(t.decreaseCount(),0===t.collectionReferenceCount&&delete this.queueMap[e])}}],[{key:"getInstance",value:function(){return new e}}]),e}(),mo="last-changeLog-token-",Io="syncManager_messageManager_channelHandler_"+(new Date).getTime(),bo=null,ko=function(){function a(e){var t=e.sendBird,n=e.db;if(Hr(this,a),!bo){Ss.call("MessageManager()"),(bo=this).sb=t;var r=this.sb;this.messageContainer=new Xs(n,r),this.chunkContainer=new to(n),this.broadcast=new ao,this.isFetchingChangeLogByChannelUrl={};var i=new r.ChannelHandler;Object.keys(i).forEach(function(s){i[s]=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];switch(s){case"onMessageReceived":Ss.event(s,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!0,bo.messageContainer.upsert(t[1],function(e,t){e?Os.throw(e):bo.broadcast.upsert([t])});break;case"onReadReceiptUpdated":Ss.event(s,t[0].url);var r=t[0];bo.broadcast.read(r);break;case"onMessageUpdated":Ss.event(s,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!1,bo.messageContainer.upsert(t[1],function(e,t){e?Os.throw(e):bo.broadcast.update([t])});break;case"onMessageDeleted":var i=t[0],a=t[1];bo.messageContainer.getItem(a,function(e,r){e?Os.throw(e):(Ss.event(s,i.url,r.messageId,r.createdAt),bo.messageContainer.remove(a,function(e,t){if(e)Os.throw(e);else{var n=ro.getDefaultFilter();bo.chunkContainer.getChunkByTimestamp(i.url,n,r.createdAt,function(e,n){if(!e&&n){var t=new Ho.LocalDB.Query({ownerUserId:Ho.getInstance().currentUserId,channelUrl:i.url,requestState:"succeeded",createdAt:{"<":r.createdAt}});t.index={ownerUserId:Ho.LocalDB.Query.Order.ASC,createdAt:Ho.LocalDB.Query.Order.ASC},t.desc=!0,t.limit=1,bo.messageContainer.find(t,function(e,t){e||(t&&0!==t.length?(n.endAt=t[0].createdAt,bo.chunkContainer.upsert(n,function(e,t){e||bo.broadcast.updateCurrentChunk(t)})):bo.chunkContainer.remove(n.chunkId,function(e){e||bo.broadcast.updateCurrentChunk(null)}))})}}),bo.broadcast.remove([parseInt(t)])}}))})}}}),r.addChannelHandler(Io,i)}return bo}return Kr(a,[{key:"syncChangeLog",value:function(r,e){var i=this,a=1<arguments.length&&void 0!==e?e:function(){};if(this.isFetchingChangeLogByChannelUrl[r.url])a(Os.create(Os.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLogByChannelUrl[r.url]=!0,Ss.call("message syncChangeLog()",r.url);var s="".concat(mo).concat(r.url);ds.get(s).then(function(e){var t="getMessageChangeLogsByToken",n=[];e?(t="getMessageChangeLogsByToken",n.unshift(e)):(t="getMessageChangeLogsByTimestamp",n.unshift((new Date).getTime()-100)),Ss.call(t),r[t].apply(r,n.concat([function(e,t){if(i.sb.getErrorFirstCallback()){var n=e;e=t,t=n}t?i.isFetchingChangeLogByChannelUrl[r.url]=!1:(Ss.sync("updated",e.updatedMessages.map(function(e){return e.messageId})),Ss.sync("deleted",e.deletedMessageIds),e.updatedMessages.forEach(function(r){bo.messageContainer.getItemWithVisibility(r.messageId,function(e,t){if(!e){var n=t.item;r.isVisible=t.isVisible||!1,bo.messageContainer.upsert(r,function(e,t){e?Os.throw(e):n&&n.isEqual(t)||bo.broadcast.update([t])})}})}),e.deletedMessageIds.forEach(function(t){bo.messageContainer.remove(t,function(e){e?Os.throw(e):bo.broadcast.remove([t])})}),ds.set(s,e.token).then(function(){e.hasMore?i.syncChangeLog(r,a):(i.isFetchingChangeLogByChannelUrl[r.url]=!1,a())}).catch(function(e){i.isFetchingChangeLogByChannelUrl[r.url]=!1,a(e)}))}]))}).catch(function(e){i.isFetchingChangeLogByChannelUrl[r.url]=!1,a(e)})}}},{key:"start",value:function(){bo.broadcast.resume(),yo.getInstance().resume()}},{key:"stop",value:function(){bo.broadcast.pause(),yo.getInstance().pause()}},{key:"clearCache",value:function(n){bo.messageContainer.clear(function(){bo.chunkContainer.clear(function(){ds.getKeys().then(function(e){var t=[];e.forEach(function(e){e.startsWith(mo)&&t.push(ds.remove(e))}),Promise.all(t).then(function(){return n()}).catch(function(e){Ss.error(e),n(e)})}).catch(function(e){return n(e)})})})}},{key:"reset",value:function(e){bo?(bo.broadcast.clear(),bo.clearCache(e)):e(null)}}],[{key:"getInstance",value:function(){return bo}},{key:"clear",value:function(){bo&&bo.sb&&(Ss.message("MessageManager is cleared"),bo.broadcast.clearCollection(),bo.sb.removeChannelHandler(Io),bo=null)}}]),a}(),Eo=function(){function e(){Hr(this,e),this.locked=!1,this.lockedAt=(new Date).getTime()+6e4}return Kr(e,[{key:"isLocked",value:function(){return this.locked}},{key:"lock",value:function(e){var t=this;this.locked?setTimeout(function(){(new Date).getTime()-t.lockedAt<6e4&&t.lock(e)},200):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(function(){return t.unlock()}))}},{key:"unlock",value:function(){this.locked=!1,this.lockedAt=(new Date).getTime()+6e4}}]),e}(),Co=function(){function i(e){Hr(this,i),this.worker=e,this.state=i.State.PAUSED,this.isLoading=!1,this.shared=0,this.retry=0,this.retryLimit=3,this.subscribes={}}return Kr(i,[{key:"start",value:function(n,e){var r=this;!(1<arguments.length&&void 0!==e&&e)&&this.state===i.State.END||this.isLoading||(this.isLoading=!0,this.state=i.State.RUNNING,this.worker(n,function(e,t){Ss.sync("background sync result: err=",e,"res=",t),r.isRunning&&(e?r.retry<r.retryLimit?(r.retry++,setTimeout(function(){return r.start(n)},500)):r.state=i.State.PAUSED:(r.retry=0,r.flush(e,t),t.hasMore?setTimeout(function(){r.isRunning&&r.start(t.nextTs)},100):r.state=i.State.END)),r.isLoading=!1}))}},{key:"pause",value:function(){this.isLoading=!1,this.state=i.State.PAUSED}},{key:"end",value:function(){this.isLoading=!1,this.state=i.State.END}},{key:"flush",value:function(e,t){var n=0<arguments.length&&void 0!==e?e:null,r=1<arguments.length?t:void 0;for(var i in Ss.sync("background sync flush: ".concat(Object.keys(this.subscribes).length," subscribes")),this.subscribes)this.subscribes[i](n,r);this.subscribes={}}},{key:"subscribe",value:function(e,t){return!this.subscribes[e]&&(this.subscribes[e]=t,!0)}},{key:"unsubscribeAll",value:function(){this.subscribes={}}},{key:"isRunning",get:function(){return this.state===i.State.RUNNING}}],[{key:"State",get:function(){return{RUNNING:"running",PAUSED:"paused",END:"end"}}}]),i}(),wo="channel-collection-handler",Mo=new Ja,Ao=new Ja,So=function(){function e(){Hr(this,e),this.collection=null,this.channels=[],this.mutex=new Eo,this.viewOffset=null}return Kr(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"compareWithChannel",value:function(e,t){var n="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":n="createdAt";break;case"channel_name_alphabetical":n="name"}return this.compareWithOffset(e,t[n])}},{key:"compareWithOffset",value:function(e,t){switch(this.collection.query.order){case"latest_last_message":return e.lastMessageUpdatedAt-t;case"chronological":return e.createdAt-t;case"channel_name_alphabetical":return t.localeCompare(e.name);default:return e.lastMessageUpdatedAt-t}}},{key:"isAbove",value:function(e,t){return 0<this.compareWithOffset(e,t)}},{key:"isBelow",value:function(e,t){return this.compareWithOffset(e,t)<0}},{key:"findChannelEdges",value:function(e){var t="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":t="createdAt";break;case"channel_name_alphabetical":t="name"}var n={start:null,end:null};for(var r in e)n.start&&!this.isAbove(e[r],n.start)||(n.start=e[r][t]),n.end&&!this.isBelow(e[r],n.end)||(n.end=e[r][t]);return n}},{key:"refreshViewOffset",value:function(){var e=this.findChannelEdges(this.channels);this.viewOffset=e.end}},{key:"addViewItems",value:function(f,e){var h=this,d=1<arguments.length&&void 0!==e?e:{},g=[],v=[],p=[],y=[],m=Ao.get(this.collection);this.mutex.lock(function(e){for(var t in f){var n=f[t],r=Bs(n,h.channels),i=Vs(n,h.collection.query,h.channels),a=!1;d.isEventChannel&&(h.viewOffset?h.isBelow(n,h.viewOffset)&&(a=!0):d.isChangeLogEvent||(h.collection.query.hasNext||h.collection.query.savepoint)&&(a=!0));var s=r<0?lo.INSERT:lo.UPDATE;switch(r<0?a||(i<h.channels.length?h.channels.splice(i,0,n):h.channels.push(n)):r!==i?i<h.channels.length?(s=lo.MOVE,h.channels.splice(r,1),r<i?h.channels.splice(i-1,0,n):h.channels.splice(i,0,n)):(s=lo.REMOVE,h.channels.splice(r,1)):h.channels[r]=n,s){case lo.INSERT:a||g.push(n);break;case lo.UPDATE:v.push(n);break;case lo.MOVE:p.push(n);break;case lo.REMOVE:y.push(n)}}if(h.refreshViewOffset(),0<g.length)for(var o in Ss.view("channel",lo.INSERT,"\n"+g.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),m)m[o].onChannelEvent(lo.INSERT,g);if(0<v.length)for(var u in Ss.view("channel",lo.UPDATE,"\n"+v.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),m)m[u].onChannelEvent(lo.UPDATE,v);if(0<p.length)for(var c in Ss.view("channel",lo.MOVE,"\n"+p.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),m)m[c].onChannelEvent(lo.MOVE,p);if(0<y.length)for(var l in Ss.view("channel",lo.REMOVE,"\n"+y.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),m)m[l].onChannelEvent(lo.REMOVE,y);e()})}},{key:"removeViewItems",value:function(s){var o=this,u=Ao.get(this.collection);this.mutex.lock(function(e){var t=[];for(var n in s){var r=s[n],i=o.channels.map(function(e){return e.url}).indexOf(r.url);0<=i&&(o.channels.splice(i,1),t.push(r))}if(0<t.length)for(var a in Ss.view("channel",lo.REMOVE,"\n"+t.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),u)u[a].onChannelEvent(lo.REMOVE,t);e()})}},{key:"clearViewItem",value:function(){this.channels=[];var r=Ao.get(this.collection);this.mutex.lock(function(e){var t=lo.CLEAR;for(var n in Ss.view("channel",t),r)r[n].onChannelEvent(t);e()})}}]),e}(),Oo=function(){function t(n){var r=this;Hr(this,t);var e=new So,i=Ds.getInstance();if(!i)return null;this.collectionId=Hs(),this.sendBird=i.sb,this.type="MyGroupChannelListQuery",this.limit=n.limit,this.query=n,this.query.filterKey=i.queryContainer.createFilterKey(this.query),this._isLoading=!1,e.attachCollection(this),i.broadcast.addCollection(this,e),Mo.set(this,e),Ao.set(this,{}),uo(this).shared++,co(this).shared++,i.queryContainer.getItem(this.query.filterKey,function(e,t){e?Os.throw(e):(t&&(r.query._token=t._token,r.query.hasNext=t.hasNext,r.query.savepoint=t.savepoint,r.query.updatedAt=t.updatedAt),i.queryContainer.upsert(n,function(e,t){e?Os.throw(e):(r.query=t,r._resume(),Ss.message("channel collection ".concat(r.collectionId," is created.")))}))})}return Kr(t,[{key:"_pause",value:function(){Ss.call("channel sync pause",this.collectionId);var e=uo(this),t=co(this);e&&e.pause(),t&&t.pause()}},{key:"_resume",value:function(){Ss.call("channel sync resume",this.collectionId);var e=uo(this),t=co(this);e&&e.start(),t&&t.start()}},{key:"fetch",value:function(e){var f=this;if(!this._isLoading)return this._isLoading=!0,zs(function(n){Ss.call("fetch()");var i=Mo.get(f),e=f.sendBird,t=Ho.getInstance(),a=Ds.getInstance(),s={ownerUserId:t.currentUserId};if(f.query.includeEmpty||(s.lastMessage={"!=":null}),f.query.nicknameContainsFilter&&(s.members={"/where":function(e){for(var t in e)if(0<=e[t].nickname.indexOf(f.query.nicknameContainsFilter))return!0;return!1}}),0<f.query.userIdsFilter.length&&(s.members={"/where":function(e){var n=e.map(function(e){return e.userId});return f.query.userIdsFilterExactMatch?n.length===f.query.userIdsFilter.length&&f.query.userIdsFilter.every(function(e){return 0<=n.indexOf(e)}):"AND"===f.query.queryType?f.query.userIdsFilter.every(function(e){return 0<=n.indexOf(e)}):"OR"===f.query.queryType&&f.query.userIdsFilter.reduce(function(e,t){return e||0<=n.indexOf(t)},!1)}}),f.query.channelNameContainsFilter&&(s.name={"/regex":new RegExp(f.query.channelNameContainsFilter)}),0<f.query.channelUrlsFilter.length&&(s.url={"/in":f.query.channelUrlsFilter}),f.query.memberStateFilter!==e.GroupChannel.memberStateFilter.ALL)switch(f.query.memberStateFilter){case e.GroupChannel.memberStateFilter.JOINED:s.myMemberState="joined";break;case e.GroupChannel.memberStateFilter.INVITED:case e.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case e.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:s.myMemberState="invited"}if("string"==typeof f.query.customTypeFilter&&f.query.customTypeFilter&&(s.customType=f.query.customTypeFilter),Array.isArray(f.query.customTypesFilter)&&0<f.query.customTypesFilter.length&&(s.customType={"/in":f.query.customTypesFilter}),"string"==typeof f.query.customTypeStartsWithFilter&&f.query.customTypeStartsWithFilter&&(s.customType={"/regex":new RegExp("^".concat(f.query.customTypeStartsWithFilter))}),f.query.superChannelFilter!==e.GroupChannel.superChannelFilter.ALL)switch(f.query.superChannelFilter){case e.GroupChannel.superChannelFilter.SUPER:s.isSuper=!0;break;case e.GroupChannel.superChannelFilter.NONSUPER:s.isSuper=!1}if(f.query.publicChannelFilter!==e.GroupChannel.publicChannelFilter.ALL)switch(f.query.publicChannelFilter){case e.GroupChannel.publicChannelFilter.PUBLIC:s.isPublic=!0;break;case e.GroupChannel.publicChannelFilter.PRIVATE:s.isPublic=!1}if(f.query.unreadChannelFilter!==e.GroupChannel.UnreadChannelFilter.ALL)switch(f.query.unreadChannelFilter){case e.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:s.unreadMessageCount={">":0}}if("all"!=f.query.hiddenChannelFilter)switch(f.query.hiddenChannelFilter){case e.GroupChannel.HiddenChannelFilter.UNHIDDEN:s.hiddenState=e.GroupChannel.HiddenState.UNHIDDEN;break;case e.GroupChannel.HiddenChannelFilter.HIDDEN:s.hiddenState={"/in":[e.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE,e.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE]};break;case e.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:s.hiddenState=e.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE;break;case e.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:s.hiddenState=e.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE}var o=null,u=!0;switch(f.query.order){case"latest_last_message":!f.query.hasNext&&f.query.savepoint&&(s.lastMessageUpdatedAt={">=":parseInt(f.query.savepoint)}),o={ownerUserId:1,lastMessageUpdatedAt:-1};break;case"chronological":!f.query.hasNext&&f.query.savepoint&&(s.createdAt={">=":parseInt(f.query.savepoint)}),o={ownerUserId:1,createdAt:-1};break;case"channel_name_alphabetical":!f.query.hasNext&&f.query.savepoint&&(s.name={"<=":f.query.savepoint}),u=!(o={ownerUserId:1,name:1});break;default:!f.query.hasNext&&f.query.savepoint&&(s.lastMessageUpdatedAt={">=":parseInt(f.query.savepoint)}),o={ownerUserId:1,lastMessageUpdatedAt:-1}}function r(n,r){a.channelContainer.query(s,{offset:i.channels.length,limit:n,index:o,desc:u},function(e,t){e?(f._isLoading=!1,r(e)):(f._isLoading=!1,t.sort(function(e,t){return 0<i.compareWithChannel(e,t)}),0<t.length&&i.addViewItems(t),t.length<n&&l(n-t.length),r(null,t))})}var c=uo(f),l=function(t){c.state!==Co.State.END&&(Ss.sync("subscribe channel",f.collectionId),c.subscribe(f.collectionId,function(e){e?Ss.error(e):(Ss.sync("flush channel"),r(t,function(e){e&&Ss.error(e)}))}))};r(f.limit,function(e,t){Ss.cache("fetch channel",e,t.map(function(e){return e.url})),n(e)}),c.state===Co.State.PAUSED&&f._resume()},e);Ss.error("fetch() is loading"),e(Os.create(Os.Type.ERROR_DUPLICATED_FETCH))}},{key:"remove",value:function(){Ds.getInstance().broadcast.removeCollection(this);var e=uo(this),t=co(this);e&&(e.shared--,0===e.shared&&e.pause()),t&&(t.shared--,0===t.shared&&t.pause())}},{key:"setCollectionHandler",value:function(e){var t=Ao.get(this);e instanceof so&&(t[wo]=e)}},{key:"removeCollectionHandler",value:function(){var e=Ao.get(this);e[wo]&&delete e[wo]}},{key:"channels",get:function(){return Mo.get(this).channels}}],[{key:"CollectionHandler",get:function(){return so}},{key:"Action",get:function(){return lo}}]),t}(),To=new Ja,Ro=new Ja,_o=new Ja,xo=new Ja,Uo=new Ja,No="message-collection-handler",Do=function(){function e(){Hr(this,e),this.collection=null,this.messages=[],this.prevTempMessages=[],this.nextTempMessages=[],this.unsentMessages=[],To.set(this,{}),this.currentChunk=null,this.viewRange={start:0,end:0}}return Kr(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"addViewItems",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:{},r=Uo.get(this.collection),i=To.get(this),a=xo.get(this.collection),s=[],o=[],u=[],c=[],l=[],f=[],h=[],d=[],g=[];for(var v in e){var p=e[v];if(p.messageId){var y=!0,m=!1;if(n.isEventMessage){var I=a.state===Co.State.END,b=!this.currentChunk||this.currentChunk.endAt<=this.viewRange.end,k=0===this.viewRange.end;m=!0,y=I&&b||!this.currentChunk||k}var E=this.collection.sendBird.currentUser?this.collection.channel.getReadReceipt(p):i[p.messageId]||0;if(i[p.messageId]||(i[p.messageId]=E),y){var C=Gs(p,this.messages),w=Qs(p,this.messages);if(0<=C&&this.messages[C].isEqual(p)&&i[p.messageId]===E)continue;if(i[p.messageId]=E,this.viewRange.start=0<this.viewRange.start?Math.min(this.viewRange.start,p.createdAt):p.createdAt,this.viewRange.end=0<this.viewRange.end?Math.max(this.viewRange.end,p.createdAt):p.createdAt,C<0){var M=Gs(p,this.unsentMessages);if(0<=M){var A=this.unsentMessages[M],S=!A.isUserMessage()||"pending"===A.requestState;this.unsentMessages.splice(M,1),S?f.push(A):g.push(A)}this.messages.splice(w,0,p),m&&this.nextTempMessages.push(p),s.push(p),n.isEventMessage&&p.sender&&p.sender.userId!==Ho.getInstance().currentUserId&&c.push(p)}else this.messages[C]=p,o.push(p)}else p.sender&&p.sender.userId!==Ho.getInstance().currentUserId&&c.push(p);var O=this.messages.length,T=[];if(O>Ho.syncManagerOptions.messageCollectionCapacity){if("next"===n.direction){var R=O-Ho.syncManagerOptions.messageCollectionCapacity;T=this.messages.splice(0,R)}else T=this.messages.splice(Ho.syncManagerOptions.messageCollectionCapacity);u.push.apply(u,Zr(T))}}else{var _=!p.isUserMessage()||"pending"===p.requestState,x=Gs(p,this.unsentMessages);if(x<0){Gs(p,this.messages)<0&&(_?l.push(p):h.push(p),this.unsentMessages.push(p))}else{var U=this.unsentMessages[x];U.isUserMessage()?"pending"===U.requestState?_||(f.push(U),h.push(p),this.unsentMessages[x]=p):(d.push(p),this.unsentMessages[x]=p):this.unsentMessages[x]=p}}}if(0<u.length)for(var N in Ss.view("message",fo.REMOVE,u.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),r)r[N].onSucceededMessageEvent(u,fo.REMOVE),r[N].onMessageEvent(fo.REMOVE,u);if(0<s.length)for(var D in Ss.view("message",fo.INSERT,s.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),r)r[D].onSucceededMessageEvent(s,fo.INSERT),r[D].onMessageEvent(fo.INSERT,s);if(0<o.length)for(var F in Ss.view("message",fo.UPDATE,o.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),r)r[F].onSucceededMessageEvent(o,fo.UPDATE),r[F].onMessageEvent(fo.UPDATE,o);if(0<f.length)for(var L in Ss.view("pending message",fo.REMOVE,f.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),r)r[L].onPendingMessageEvent(f,fo.REMOVE),r[L].onMessageEvent(fo.REMOVE,f);if(0<l.length)for(var P in Ss.view("pending message",fo.INSERT,l.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),r)r[P].onPendingMessageEvent(l,fo.INSERT),r[P].onMessageEvent(fo.INSERT,l);if(0<g.length){Ss.view("failed message",fo.REMOVE,g.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt}));var q=ho.REMOVE_RESEND_SUCCEEDED;for(var j in r)r[j].onFailedMessageEvent(g,fo.REMOVE,q)}if(0<d.length){Ss.view("failed message",fo.UPDATE,d.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt}));var B=ho.UPDATE_RESEND_FAILED;for(var V in r)r[V].onFailedMessageEvent(d,fo.UPDATE,B)}if(0<h.length){Ss.view("failed message",fo.INSERT,h.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt}));var G=ho.NONE;for(var Q in r)r[Q].onFailedMessageEvent(h,fo.INSERT,G)}if(0<c.length)for(var H=0;H<c.length;H++){var z=c[H];for(var K in Ss.view("new message",z.reqId,z.messageId,z.createdAt),r)r[K].onNewMessage(z)}}},{key:"removeViewItems",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:{isRequestId:!1},r=!!n.hasOwnProperty("isRequestId")&&n.isRequestId,i=Uo.get(this.collection);if(r){for(var a=[],s=[],o=0;o<e.length;o++)for(var u=e[o],c=0;c<this.unsentMessages.length;c++)if(u===this.unsentMessages[c].reqId){var l=this.unsentMessages[c];if(l.isUserMessage())switch(l.requestState){case"pending":a.push(l);break;case"failed":s.push(l)}else l.isFileMessage()&&a.push(l);this.unsentMessages.splice(c,1);break}if(0<a.length)for(var f in Ss.view("pending message",fo.REMOVE,a.map(function(e){return e.reqId})),i)i[f].onPendingMessageEvent(a,fo.REMOVE),i[f].onMessageEvent(fo.REMOVE,a);if(0<s.length){Ss.view("failed message",fo.REMOVE,s.map(function(e){return e.reqId}));var h=n.hasOwnProperty("reason")?n.reason:ho.REMOVE_UNKNOWN;for(var d in i)i[d].onFailedMessageEvent(s,fo.REMOVE,h)}}else{for(var g=To.get(this),v=[],p=0;p<e.length;p++)for(var y=e[p],m=0;m<this.messages.length;m++)if(y===this.messages[m].messageId){"number"==typeof g[y]&&delete g[y];var I=this.messages.splice(m,1);v.push.apply(v,Zr(I));break}if(this.viewRange.start=0<this.messages.length?this.messages[0].createdAt:0,this.viewRange.end=0<this.messages.length?this.messages[this.messages.length-1].createdAt:0,0<v.length)for(var b in Ss.view("message",fo.REMOVE,v.map(function(e){return e.messageId})),i)i[b].onSucceededMessageEvent(v,fo.REMOVE),i[b].onMessageEvent(fo.REMOVE,v)}}},{key:"clearUnsentMessages",value:function(){var e=this.unsentMessages,t=Uo.get(this.collection);for(var n in this.unsentMessages=[],Ss.view("message",fo.REMOVE,"unsent messages"),t){t[n].onPendingMessageEvent([],fo.CLEAR);var r=ho.NONE;t[n].onFailedMessageEvent([],fo.CLEAR,r),t[n].onMessageEvent(fo.REMOVE,e)}}},{key:"clearViewItem",value:function(){this.currentChunk=null,this.messages=[],To.set(this,{}),this.viewRange.start=0,this.viewRange.end=0;var e=Uo.get(this.collection);for(var t in Ss.view("message",fo.CLEAR),e)e[t].onSucceededMessageEvent([],fo.CLEAR),e[t].onMessageEvent(fo.CLEAR)}},{key:"updateCurrentChunk",value:function(e){e?this.currentChunk&&this.currentChunk.isSame(e)||(this.currentChunk=ro.createFromJson(e)):this.currentChunk=e}}]),e}(),Fo=function(){function u(r){var l=this,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:(new Date).getTime();Hr(this,u);var f=ko.getInstance();if(!f)return null;if(this.collectionId=Hs(),this.sendBird=f.sb,this.channel=r,this.limit=50,this.filter=ro.getDefaultFilter(),e&&"object"===Qr(e)&&0<Object.keys(e).length)for(var n in e)this.filter.hasOwnProperty(n)&&(this.filter[n]=e[n]);this.viewpoint=t,this._isLoading={prev:!1,next:!1},yo.getInstance().createQueue(this.channel.url);var h=new Do;h.attachCollection(this),Ro.set(this,h),_o.set(this,null),xo.set(this,null),Uo.set(this,{}),f.broadcast.addCollection(this,h);function i(o,n,u){Ss.sync("message synchronize() begin",o,n);var e=null,c=0,t=[n];switch(o){case"prev":e="getPreviousMessagesByTimestamp",c=100,t.push(!0),t.push(100);break;case"next":e="getNextMessagesByTimestamp",c=100,t.push(!0),t.push(100);break;case"prevnext":e="getPreviousAndNextMessagesByTimestamp",c=100,t.push(50),t.push(50)}t.push(!1),t.push(l.filter.messageType||""),t.push(l.filter.customType||""),t.push(l.filter.senderUserIdsFilter||[]),t.push(l.filter.includeMetaArray||!0),r[e].apply(r,t.concat([function(s,e){if(f.sb.getErrorFirstCallback()){var t=[s,e];e=t[0],s=t[1]}e?(l._pause(),u(e)):(Ss.sync("message synchronize() end",o,n,s.map(function(e){return e.messageId})),a.lock(function(t){var n=[],r={startAt:1/0,endAt:0};if(0<s.length){var e=function(e){s[e].isVisible=!0,n.push(new Promise(function(t,n){f.messageContainer.upsert(s[e],function(e){return e?n(e):t()})})),r.startAt=Math.min(r.startAt,s[e].createdAt),r.endAt=Math.max(r.endAt,s[e].createdAt)};for(var i in s)e(i);h.currentChunk&&h.currentChunk.isOverlap(r)||(h.currentChunk=new ro(l.channel.url,l.filter),Ss.message("chunk is created",h.currentChunk.startAt,h.currentChunk.endAt));var a=h.currentChunk;a.extendWithChunk(r),Ss.message("currentChunk is extended",a.startAt,a.endAt),f.chunkContainer.mergePreviousChunkOverlap(a,function(e){e?(t(),u(e)):(Ss.message("currentChunk merged previous chunks",a.startAt,a.endAt),Promise.all(n).then(function(){t(),u(null,{count:s.length,nextTs:"prev"===o?a.startAt:a.endAt,hasMore:s.length>=c})}).catch(function(e){t(),u(e)}))})}else t(),u(null,{count:0,nextTs:0,hasMore:!1})}))}]))}var a=new Eo,s=new Co(function(e,t){return i("prev",e,t)});s.shared++,_o.set(this,s);var o=new Co(function(e,t){return i("next",e,t)});o.shared++,xo.set(this,o),f.chunkContainer.getChunkByTimestamp(this.channel.url,this.filter,this.viewpoint,function(e,t){e||(t&&(h.currentChunk=t),h.currentChunk?l._resume():i("prevnext",l.viewpoint,function(e,t){e||setTimeout(function(){s.flush(e,t),o.flush(e,t),t.count<50?(s.end(),o.end()):l._resume()},300)}),Ss.message("message collection ".concat(l.collectionId," is created.")))}),Object.defineProperty(this,"messageCount",{get:function(){try{return h.messages.length}catch(e){return 0}}})}return Kr(u,[{key:"_pause",value:function(){Ss.call("message sync pause",this.collectionId);var e=Ro.get(this),t=_o.get(this),n=xo.get(this);t&&t.pause(),n&&n.pause(),e.currentChunk=null}},{key:"_resume",value:function(){var r=this;Ss.call("message sync resume",this.collectionId);var e=ko.getInstance(),i=_o.get(this),a=xo.get(this);i&&i.isRunning&&(i.pause(),i.unsubscribeAll()),a&&a.isRunning&&(a.pause(),a.unsubscribeAll()),e.syncChangeLog(this.channel,function(){var e=Ro.get(r);if(i){var t=e.currentChunk?e.currentChunk.startAt:r.viewpoint;i.start(t)}if(a){var n=e.currentChunk?e.currentChunk.endAt:r.viewpoint;a.start(n,!0)}})}},{key:"fetch",value:function(e,t){return this.fetchSucceededMessages(e,t)}},{key:"fetchSucceededMessages",value:function(g,e){var v=this,s=ko.getInstance(),p=Ro.get(this);return this._isLoading[g]?zs(function(e){return e(Os.create(Os.Type.ERROR_DUPLICATED_FETCH))},e):(this._isLoading[g]=!0,zs(function(c){Ss.call("fetchSucceededMessages()",g);var e=null,l=v.viewpoint,f=v.limit,n=!1,i=l,h=null,a=null;switch(g){case"prev":e=_o.get(v),0<p.viewRange.start&&(l=p.viewRange.start),p.currentChunk&&(i=Math.max(p.currentChunk.startAt,l)),h=p.prevTempMessages,a=s.messageContainer.loadPreviousSucceededMessages,n=!0;break;case"next":e=xo.get(v),0<p.viewRange.end&&(l=p.viewRange.end),p.currentChunk&&(i=Math.min(p.currentChunk.endAt,l)),h=p.nextTempMessages,a=s.messageContainer.loadNextSucceededMessages;break;default:return void c(Os.create(Os.Type.ERROR_INVALID_PARAMETER))}function d(t,r){Ss.message("waiting for synchronization..."),a(v.channel.url,v.filter,t,{limit:f,desc:n},function(e,t){var n;e?(v._isLoading[g]=!1,r(e)):(Ss.cache("temp message",g,t.map(function(e){return e.messageId})),(n=h).push.apply(n,Zr(t)),p.addViewItems(t,{direction:g}),v._isLoading[g]=!1,r(null))});var u=i;Ss.sync("subscribe message",v.collectionId,g,t),e.subscribe(v.collectionId,function(e){e?Ss.error(e):(Ss.sync("flush message",g,t),s.chunkContainer.getChunkByTimestamp(v.channel.url,v.filter,t,function(e,t){if(!e)if(t&&(p.currentChunk=t),p.currentChunk){var o=p.currentChunk;a(v.channel.url,v.filter,u,{limit:f,desc:n},function(e,t){if(e)Ss.error(e);else{Ss.cache("flush message",g,u,t.map(function(e){return e.messageId}));var n=[],r=[];for(var i in t)if(o.containsMessage(t[i])){var a=p.messages.map(function(e){return e.messageId}).indexOf(t[i].messageId);(a<0||!p.messages[a].isEqual(t[i]))&&n.push(t[i])}for(var s in h)p.messages.map(function(e){return e.messageId}).indexOf(h[s].messageId)<0&&r.push(h[s]);for(;0<h.length;)h.pop();0<r.length&&p.removeViewItems(r.map(function(e){return e.messageId})),0<n.length&&p.addViewItems(n,{direction:g})}})}else Ss.error(e)}))})}s.chunkContainer.getChunkByTimestamp(v.channel.url,v.filter,l,function(e,t){if(e)v._isLoading[g]=!1,c(e);else if(t&&(p.currentChunk=t),p.currentChunk){var u=p.currentChunk;Ss.message("chunk is selected",u),a(v.channel.url,v.filter,l,{limit:f,desc:n},function(e,t){if(e)v._isLoading[g]=!1,c(e);else{var n=[],r=[];Ss.cache("fetch message",g,l,t.map(function(e){return e.messageId}));var i=!1;for(var a in t)if(u.containsMessage(t[a])){i=!0;var s=p.messages.map(function(e){return e.messageId}).indexOf(t[a].messageId);(s<0||!p.messages[s].isEqual(t[a]))&&n.push(t[a])}if(!i){for(var o in h)p.messages.map(function(e){return e.messageId}).indexOf(h[o].messageId)<0&&r.push(h[o]);for(;0<h.length;)h.pop()}0<n.length&&p.addViewItems(n,{direction:g}),0<r.length&&p.removeViewItems(r.map(function(e){return e.messageId})),t.length<f?(f-=t.length,d(l,c)):(v._isLoading[g]=!1,c(null))}})}else d(l,c)}),e.state===Co.State.PAUSED&&v._resume()},e))}},{key:"fetchFailedMessages",value:function(e){var r=this;return zs(function(n){Ss.call("fetchFailedMessages()"),yo.getInstance().loadFailedMessages(r.channel.url,r.filter,function(e,t){e||(Ss.cache("fetch failed message",t.map(function(e){return e.reqId})),Ro.get(r).addViewItems(t));n(e)})},e)}},{key:"resetViewpointTimestamp",value:function(e){var t=0<arguments.length&&void 0!==e?e:(new Date).getTime();if("number"==typeof t&&0<=t){Ss.call("resetViewpointTimestamp()",t);var n=Ro.get(this);n.viewRange.start<=t&&t<=n.viewRange.end?n.currentChunk&&!n.currentChunk.contains(t)&&(n.currentChunk=null):(n.currentChunk=null,n.clearViewItem()),this.viewpoint=t,this._resume()}else Ss.error("resetViewpointTimestamp()","ts should be number type and greater than or equal to 0."),Os.throw(Os.create(Os.Type.ERROR_INVALID_PARAMETER))}},{key:"remove",value:function(){yo.getInstance().removeQueue(this.channel.url),ko.getInstance().broadcast.removeCollection(this),Ro.get(this).currentChunk=null;var e=_o.get(this),t=xo.get(this);e&&(e.shared--,0===e.shared&&e.pause()),t&&(t.shared--,0===t.shared&&t.pause())}},{key:"handleSendMessageResponse",value:function(e,t){if(Ss.call("handleSendMessageResponse()",e,t),e){if(t)switch(Ho.syncManagerOptions.messageResendPolicy){case Ho.Options.MessageResendPolicy.NONE:this.deleteMessage(t);break;case Ho.Options.MessageResendPolicy.MANUAL:case Ho.Options.MessageResendPolicy.AUTOMATIC:if(t.isUserMessage()&&800110!==e.code)this.appendMessage(t);else{var n={reason:ho.REMOVE_UNKNOWN};this.deleteMessage(t,n)}break;default:this.deleteMessage(t)}else this.deleteMessage(t),Ss.error(e)}else{var r=Ro.get(this),i={reason:ho.REMOVE_RESEND_SUCCEEDED};for(var a in r.unsentMessages)if(r.unsentMessages[a].isIdentical(t)){this.deleteMessage(r.unsentMessages[a],i);break}this.appendMessage(t)}}},{key:"hasMessage",value:function(e){if(e)for(var t=Ro.get(this),n=0;n<t.succeededMessages.length;n++)if(t.succeededMessages[n].isIdentical(e))return!0;return!1}},{key:"appendMessage",value:function(n){if(n){Ss.call("appendMessage()",n.messageId);var e=Ho.getInstance(),r=ko.getInstance(),t=Ro.get(this);if(n.messageId)if(n.sender&&n.sender.userId===e.currentUserId){n.isVisible=!0,r.messageContainer.upsert(n,function(e,t){e||r.broadcast.upsert([t])});var i=Ds.getInstance();i.channelContainer.getItem(n.channelUrl,function(e,t){e?Os.throw(e):t&&(!t.lastMessage||t.lastMessage.createdAt<=n.createdAt)&&(t.lastMessage=n,i.channelContainer.upsert(t,function(e,t){e?Os.throw(e):i.broadcast.upsert([t])}))})}else Ss.warning("Cannot append message sent by other member.");else{var a=Ho.syncManagerOptions;"failed"===n.requestState&&a.messageResendPolicy!==Ho.Options.MessageResendPolicy.NONE?yo.getInstance().upsertMessages(this.channel.url,[n]):t.addViewItems([n])}}else Ss.error("appendMessage()","Message is expected but ".concat(n," is given.")),Os.throw(Os.create(Os.Type.ERROR_INVALID_PARAMETER))}},{key:"updateMessage",value:function(n){if(n){Ss.call("updateMessage()",n.messageId);var e=Ho.getInstance(),r=ko.getInstance(),t=Ro.get(this);if(n.sender&&n.sender.userId===e.currentUserId)if(n.messageId){n.isVisible=!0,r.messageContainer.upsert(n,function(e,t){e||r.broadcast.update([t])});var i=Ds.getInstance();i.channelContainer.getItem(n.channelUrl,function(e,t){e?Os.throw(e):t&&t.lastMessage&&t.lastMessage.messageId===n.messageId&&(t.lastMessage=n,i.channelContainer.upsert(t,function(e,t){e?Os.throw(e):i.broadcast.update([t])}))})}else t.addViewItems([n])}else Ss.error("updateMessage()","Message is expected but ".concat(n," is given.")),Os.throw(Os.create(Os.Type.ERROR_INVALID_PARAMETER))}},{key:"deleteMessage",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:{};if(e){Ss.call("deleteMessage()",e.messageId);var r=Ho.getInstance(),i=Ro.get(this);if(e.sender&&e.sender.userId===r.currentUserId)if(e.messageId);else if(e.isUserMessage()){for(var a=0;a<i.unsentMessages.length;a++)if(i.unsentMessages[a].isIdentical(e)){switch(e.requestState){case"pending":i.removeViewItems([e.reqId],!0);break;case"failed":yo.getInstance().removeMessages(this.channel.url,[e],n)}break}}else i.removeViewItems([e.reqId],!0)}else Ss.error("deleteMessage()","Message is expected but ".concat(e," is given.")),Os.throw(Os.create(Os.Type.ERROR_INVALID_PARAMETER))}},{key:"setCollectionHandler",value:function(e){var t=Uo.get(this);e instanceof oo&&(t[No]=e)}},{key:"removeCollectionHandler",value:function(){var e=Uo.get(this);e[No]&&delete e[No]}},{key:"messages",get:function(){return this.succeededMessages}},{key:"succeededMessages",get:function(){return Ro.get(this).messages}},{key:"unsentMessages",get:function(){return Ro.get(this).unsentMessages}}],[{key:"create",value:function(n,a,s,e){"function"==typeof s&&(e=s,s=(new Date).getTime());var t=Ds.getInstance();return zs(function(i){t.channelContainer.getItem(n,function(e,t){if(e)i(e);else if(t)i(null,new u(t,a,s));else{var r=Ds.getInstance();r.sb.GroupChannel.getChannel(n,function(e,t){if(r.sb.getErrorFirstCallback()){var n=[e,t];t=n[0],e=n[1]}t?i(t):i(null,new u(e,a,s))})}})},e)}},{key:"CollectionHandler",get:function(){return oo}},{key:"Action",get:function(){return fo}},{key:"FailedMessageEventActionReason",get:function(){return ho}}]),u}(),Lo=null,Po=null,qo=null,jo=ls,Bo=null,Vo=null,Go=null,Qo=null,Ho=function(){function a(){return Hr(this,a),Po=Po||this}return Kr(a,[{key:"resumeSync",value:function(){Ss.call("resumeSync()"),Vo&&Vo.start(),Go&&Go.start()}},{key:"pauseSync",value:function(){Ss.call("pauseSync()"),Vo&&Vo.stop(),Go&&Go.stop()}},{key:"clearCache",value:function(e){return Ss.call("clearCache()"),zs(function(t){var e=[];Vo&&e.push(new Promise(function(t,n){Vo.reset(function(e){return e?n(e):t()})})),Go&&e.push(new Promise(function(t,n){Go.reset(function(e){return e?n(e):t()})})),0<e.length?Promise.all(e).then(function(){return t(null)}).catch(function(e){return t(e)}):t(null)},e)}},{key:"reset",value:function(e){var n=this;return Ss.call("reset()"),zs(function(t){n.clearCache(function(e){e||(Ds.clear(function(){Vo=null}),ko.clear(function(){Go=null})),t(e)})},e)}},{key:"currentUserId",get:function(){return Lo&&Lo.currentUser?Lo.currentUser.userId:qo}}],[{key:"setup",value:function(e,t,n){Ss.call("init()"),Qo=new a.Options;var r=arguments.length<=0?void 0:e,i=arguments.length<=1?void 0:t;return i&&"function"!=typeof i&&(i instanceof a.Options?(Qo=i,i=arguments.length<=2?void 0:n):Ss.error("Type of the second parameter is not valid: ",arguments.length<=1?void 0:t)),Ss.prefix="[SyncManager]",zs(function(t){if(ds.init(),Lo)if(Po=new a,Lo.currentUser&&r!==Lo.currentUser.userId&&(Ss.warning("Different user ID: clear cache"),Po.clearCache()),qo=r,Ds.clear(),Vo=null,ko.clear(),Go=null,Bo)Ss.cache("Database is open"),Vo=new Ds({sendBird:Lo,db:Bo}),Go=new ko({sendBird:Lo,db:Bo}),a.ChannelCollection=Oo,a.MessageCollection=Fo,yo.getInstance().removeExpiredMessages(function(){t(null)});else{var e=new jo("sbsync.db",4);e.schema("GroupChannel",{key:"url",index:[{ownerUserId:jo.Query.Order.ASC,lastMessageUpdatedAt:jo.Query.Order.DESC},{ownerUserId:jo.Query.Order.ASC,createdAt:jo.Query.Order.DESC},{ownerUserId:jo.Query.Order.ASC,name:jo.Query.Order.ASC}]}).schema("GroupChannelListQuery",{key:"filterKey",index:[{ownerUserId:jo.Query.Order.ASC,updatedAt:jo.Query.Order.DESC}]}).schema("MessageChunk",{key:"chunkId",index:[{ownerUserId:jo.Query.Order.ASC,channelUrl:jo.Query.Order.ASC,filterKey:jo.Query.Order.ASC,endAt:jo.Query.Order.DESC}]}).schema("Message",{key:"messageId",index:[{ownerUserId:jo.Query.Order.ASC,channelUrl:jo.Query.Order.ASC,createdAt:jo.Query.Order.DESC},{ownerUserId:jo.Query.Order.ASC,createdAt:jo.Query.Order.ASC}]}).build().then(function(){Ss.cache("Database is created"),Vo=new Ds({sendBird:Lo,db:e}),Go=new ko({sendBird:Lo,db:e}),Bo=e,a.ChannelCollection=Oo,a.MessageCollection=Fo,yo.getInstance().removeExpiredMessages(function(){t(null)})}).catch(function(e){return t(e)})}else t(Os.create(Os.Type.ERROR_SETUP_MISSING))},i)}},{key:"useReactNative",value:function(e){ds.useReactNative(e),ns.Storage=e,jo=ns}},{key:"getInstance",value:function(){return Po}},{key:"sendBird",get:function(){return Lo},set:function(e){Lo=e}},{key:"LocalDB",get:function(){return jo}},{key:"syncManagerOptions",get:function(){return Qo||new a.Options}},{key:"LogLevel",get:function(){return ws}},{key:"loggerLevel",set:function(e){Ss.level=e},get:function(){return Ss.level}}]),a}();return Ho.Options=function(){return function e(){Hr(this,e);var t=1e3;Object.defineProperty(this,"messageCollectionCapacity",{get:function(){return t},set:function(e){"number"==typeof e&&e>=(-1<Object.values(ws).indexOf(Ss.level)?200:0)&&e<=Number.MAX_SAFE_INTEGER&&(t=e)}});var n=Ho.Options.MessageResendPolicy.NONE;Object.defineProperty(this,"messageResendPolicy",{get:function(){return n},set:function(e){-1<Object.values(Ho.Options.MessageResendPolicy).indexOf(e)&&(n=e)}});var r=Ho.Options.INFINITY;Object.defineProperty(this,"automaticMessageResendRetryCount",{get:function(){return r},set:function(e){"number"==typeof e&&(0<e&&e<=Number.MAX_SAFE_INTEGER||e===Ho.Options.INFINITY)&&(r=e)}});var i=20;Object.defineProperty(this,"maxFailedMessageCountPerChannel",{get:function(){return i},set:function(e){"number"==typeof e&&0<e&&e<=Number.MAX_SAFE_INTEGER&&(i=e)}});var a=7;Object.defineProperty(this,"failedMessageRetentionDays",{get:function(){return a},set:function(e){"number"==typeof e&&(e>(-1<Object.values(ws).indexOf(Ss.level)?0:-2)&&e<=Number.MAX_SAFE_INTEGER||e===Ho.Options.INFINITY)&&(a=e)}})}}(),Ho.Options.MessageResendPolicy={NONE:"none",MANUAL:"manual",AUTOMATIC:"automatic"},Ho.Options.INFINITY=Number.MAX_SAFE_INTEGER,Ho});