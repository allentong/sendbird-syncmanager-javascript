/**
 * Copyright(c) 2016 SendBird, Inc.
 * SendBird SyncManager JavaScript SDK v1.1.16
 */

!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).SendBirdSyncManager=n()}(this,function(){"use strict";function d(e){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function g(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function r(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,n){return(i=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function s(e,n,t){return(s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,n,t){var r=[null];r.push.apply(r,n);var a=new(Function.bind.apply(e,r));return t&&i(a,t.prototype),a}).apply(null,arguments)}function n(e){var r="function"==typeof Map?new Map:void 0;return(n=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return s(e,arguments,a(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i(t,e)})(e)}function o(e,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):n}function z(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var t=null,u=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return g(this,n),t=t||this,this.batchSize=64,this.batchInterval=200,this.cachedBlockLimit=128,this.cachedBlockFlush=32,this.encryption={encrypt:function(e,n){return n(null,e)},decrypt:function(e,n){return n(null,e)}},"number"==typeof e.batchSize&&1<e.batchSize&&(this.batchSize=e.batchSize),"number"==typeof e.batchInterval&&10<e.batchInterval&&(this.batchInterval=e.batchInterval),"number"==typeof e.cachedBlockLimit&&0<e.cachedBlockLimit&&(this.cachedBlockLimit=e.cachedBlockLimit),"number"==typeof e.cachedBlockFlush&&e.cachedBlockFlush<this.cachedBlockLimit&&(this.cachedBlockFlush=e.cachedBlockFlush),e.encryption&&e.encryption.hasOwnProperty("encrypt")&&e.encryption.hasOwnProperty("decrypt")&&"function"==typeof e.encryption.encrypt&&"function"==typeof e.encryption.decrypt&&(this.encryption=e.encryption),t}return c(n,null,[{key:"getInstance",value:function(){return t}}]),n}(),l=0,h=1,f=2,e=function(){function u(e){var n=this;g(this,u),this.state=l,this._value=null,this._reason=null;if("function"!=typeof e)throw"Promise resolver ".concat(e," is not a function");e(function(e){n.state===l&&(n.state=h,n._value=e)},function(e){n.state===l&&(n.state=f,n._reason=e)})}return c(u,[{key:"then",value:function(e,n){var t=this,r=this;switch(this.state){case l:setTimeout(function(){return t.then(e,n)},100);break;case h:e&&"function"==typeof e&&(r=e(this._value));break;case f:n&&"function"==typeof n&&(r=n(this._reason))}return r instanceof u?r:this}},{key:"catch",value:function(e){var n=this,t=this;switch(this.state){case l:setTimeout(function(){return n.catch(e)},100);break;case h:break;case f:t=e(this._reason)}return t instanceof u?t:this}},{key:"finally",value:function(e){var n=this,t=this;switch(this.state){case l:setTimeout(function(){return n.finally(e)},100);break;case h:case f:t=e()}return t instanceof u?t:this}},{key:"length",get:function(){return 1}}],[{key:"all",value:function(o){return new u(function(r,a){if(Array.isArray(o)||"string"==typeof o)if(0<o.length){var e=[];for(var n in o)o[n]instanceof u?e.push(o[n]):e.push(u.resolve(o[n]));var i=new Array(e.length).fill(null),s=e.length,t=function(e,n,t){n?a(n):(s--,i[e]=t,s<=0&&r(i))};e.forEach(function(e,n){e.then(function(e){t(n,null,e)}).catch(function(e){t(n,e,null)})})}else r([]);else a(new Error("Uncaught (in promise) TypeError: ".concat(d(o)," ").concat(o," is not iterable")))})}},{key:"resolve",value:function(n){return new u(function(e){e(n)})}},{key:"reject",value:function(t){return new u(function(e,n){n(t)})}}]),u}();function v(n,t){var e=d(n),r=d(t);return!n||!t||"object"!==e||e!==r||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===e&&"function"===r||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(e){return v(n[e],t[e])})}function y(e){return null!=e}function m(e,n,t){var r=2<arguments.length&&void 0!==t&&t;if(y(e)){if(!y(n))return r?-1:1;if(d(e)===d(n)&&e!==n){var a=d(e);if("boolean"===a)return e?1:-1;if("number"===a)return n<e?1:-1;if("string"===a)return e.localeCompare(n);if(e instanceof Date&&n instanceof Date&&e.getTime()!==n.getTime())return e.getTime()>n.getTime()?1:-1}}else if(y(n))return r?1:-1;return 0}function p(e,t,a){if(!t)return new Promise(function(t,r){e(function(e,n){a&&"function"==typeof a&&a(),e?r(e):t(n)})});e(function(e,n){a&&"function"==typeof a&&a(),t(e,n)})}"undefined"==typeof Promise&&(Promise=e);var k=function(){function r(e){g(this,r),this.condition=e,this.offset=0,this.limit=1/0,this.index=null,this.desc=!1}return c(r,null,[{key:"and",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/and":n}):new r({})}},{key:"or",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/or":n}):new r({})}},{key:"Order",get:function(){return{ASC:1,DESC:-1}}}]),c(r,[{key:"match",value:function(e){return function t(r,e){var n=!0;if(r)for(var a in e){switch(a){case"/and":n=n&&e[a].reduce(function(e,n){return e&&t(r,n)},!0);break;case"/or":n=n&&e[a].reduce(function(e,n){return e||t(r,n)},!1);break;default:var i=e[a];if("object"===d(i))for(var s in i)switch(s){case">":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]>i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&0<r[a].localeCompare(i[s]));break;case">=":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]>=i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&0<=r[a].localeCompare(i[s]));break;case"<":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]<i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&r[a].localeCompare(i[s])<0);break;case"<=":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]<=i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&r[a].localeCompare(i[s])<=0);break;case"=":n=n&&r[a]===i[s];break;case"!=":n=n&&r[a]!==i[s];break;case"/in":n=n&&Array.isArray(i[s])&&0<=i[s].indexOf(r[a]);break;case"/nin":n=n&&Array.isArray(i[s])&&i[s].indexOf(r[a])<0;break;case"/like":n=n&&"string"==typeof i[s]&&"string"==typeof r[a]&&0<=r[a].indexOf(i[s]);break;case"/nlike":n=n&&"string"==typeof i[s]&&"string"==typeof r[a]&&r[a].indexOf(i[s])<0;break;case"/regex":n=n&&i[s]instanceof RegExp&&i[s].test(r[a]);break;case"/where":n=n&&i[s](r[a]);break;default:n=n&&v(r[a],i)}else n=n&&r[a]===i}if(!n)break}else n=!1;return n}(e,this.condition)}}]),r}(),I=function(){function r(e){g(this,r),this.blockKey=e,this.data=[]}return c(r,[{key:"get",value:function(e){var n=this.indexOf(e);return 0<=n?this.data[n].value:null}},{key:"indexOf",value:function(e){for(var n in this.data)if(this.data[n].key===e)return parseInt(n);return-1}},{key:"add",value:function(e,n){var t=this.indexOf(e);t<0?this.data.push({key:e,value:n}):this.data[t]={key:e,value:n}}},{key:"remove",value:function(e){var n=this.indexOf(e);return 0<=n&&(this.data.splice(n,1),!0)}},{key:"getSerializedData",value:function(){return JSON.stringify(this.data)}},{key:"count",get:function(){return this.data.length}}],[{key:"createKey",value:function(e,n){var t=1<arguments.length&&void 0!==n?n:0;return"".concat(e.toLowerCase(),"-blk-").concat(t)}},{key:"buildFromSerializedData",value:function(e,n){var t=new r(e);try{return t.data=JSON.parse(n),t}catch(e){return null}}}]),r}(),b=function(){function e(){g(this,e),this.locked=!1,this.lockedAt=0}return c(e,[{key:"lock",value:function(e){var n=this;this.locked?setTimeout(function(){1e4<(new Date).getTime()-n.lockedAt&&n.unlock(),n.lock(e)},200):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(function(){return n.unlock()}))}},{key:"unlock",value:function(){this.locked=!1,this.lockedAt=0}}]),e}();"undefined"==typeof Promise&&(Promise=e);var C="adb-trns-",w=function(){function s(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};g(this,s);var t=u.getInstance();this.name=e,this.initialized=!1,this.queue={},this.batchInterval=n.batchInterval||t.batchInterval,this.batchUpdateTimer=null,this.transactionMutex=new b,this.transactionState=s.State.IDLE,this.transactionCount=0,this.encryption=t.encryption,n.encryption&&n.encryption.hasOwnProperty("encrypt")&&n.encryption.hasOwnProperty("decrypt")&&"function"==typeof n.encryption.encrypt&&"function"==typeof n.encryption.decrypt&&(this.encryption=n.encryption)}return c(s,[{key:"init",value:function(e){var t=this,r=0<arguments.length&&void 0!==e?e:function(){};this.initialized?r(null):(this.initialized=!0,0===Object.keys(this.queue).length?L.Storage.getItem(C+this.name,function(e,n){n?t.encryption.decrypt(n,function(e,n){e||(t.queue=JSON.parse(n)),r(e)}):r(null)}):r(null))}},{key:"flush",value:function(){var i=this;this.transactionMutex.lock(function(a){L.Storage.setItem(C+i.name,JSON.stringify(i.queue),function(e){if(e)throw a(),e;function n(a){var e=i.queue[a];switch(e.action){case s.Action.SET:t.push(new Promise(function(t,r){i.encryption.encrypt(JSON.stringify(e.data),function(e,n){e?r(e):L.Storage.setItem(a,n).then(t).catch(r)})}));break;case s.Action.REMOVE:t.push(L.Storage.removeItem(a))}}var t=[];for(var r in i.queue)n(r);i.batchUpdateTimer=null,Promise.all(t).then(function(){i.queue={},L.Storage.removeItem(C+i.name,function(){a()})}).catch(function(e){throw a(),e})})})}},{key:"startTransaction",value:function(){this.transactionState=s.State.RUNNING,this.transactionCount++}},{key:"endTransaction",value:function(){this.transactionState===s.State.RUNNING&&(this.transactionCount--,0===this.transactionCount&&(this.flush(),this.transactionState=s.State.IDLE))}},{key:"addJob",value:function(e,n,t){var r=this;this.queue[n]={action:e,data:t},this.transactionState===s.State.IDLE&&(this.batchUpdateTimer||(this.batchUpdateTimer=setTimeout(function(){r.transactionState===s.State.IDLE&&r.flush(),r.batchUpdateTimer=null},this.batchInterval)))}}],[{key:"Action",get:function(){return{SET:"set",REMOVE:"remove"}}},{key:"State",get:function(){return{IDLE:"idle",RUNNING:"running"}}}]),s}(),E="adb-info-",M=function(){function r(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};g(this,r);var t=u.getInstance();this.cachedBlockLimit=n.cachedBlockLimit||t.cachedBlockLimit,this.cachedBlockFlush=n.cachedBlockFlush||t.cachedBlockFlush,this.cacheMutex=new b,this.encryption=t.encryption,n.encryption&&n.encryption.hasOwnProperty("encrypt")&&n.encryption.hasOwnProperty("decrypt")&&"function"==typeof n.encryption.encrypt&&"function"==typeof n.encryption.decrypt&&(this.encryption=n.encryption),this.batchSize=n.batchSize||t.batchSize,this.batchQueue=n.sharedBatchQueue||new w(e,n),this.transaction=null,this.name=e,this.info={},this.blockCache={},this.blockCacheCursor=0,this.currentBlock=null}return c(r,[{key:"_findBlockKey",value:function(e){return this.info.blockMap[e]}},{key:"_getBlockFromCache",value:function(e){return this.blockCache[e]?this.blockCache[e].block:null}},{key:"_putBlockToCache",value:function(e){var t=this;this.blockCache[e.blockKey]={seq:this.blockCacheCursor++,block:e};var n=Object.keys(this.blockCache);if(n.length>=this.cachedBlockLimit)for(var r in n.sort(function(e,n){return t.blockCache[e].seq-t.blockCache[n].seq}),n)this._removeBlockFromCache(n[r])}},{key:"_removeBlockFromCache",value:function(e){this.blockCache.hasOwnProperty(e)&&delete this.blockCache[e]}},{key:"_getBlock",value:function(r,a){var i=this,e=this._getBlockFromCache(r);e?a(null,e):L.Storage.getItem(r).then(function(e){e?i.encryption.decrypt(e,function(e,n){if(e)a(e);else{var t=I.buildFromSerializedData(r,n);i._putBlockToCache(t),a(null,t)}}):a(null)}).catch(function(e){return a(e)})}},{key:"_assignNewBlock",value:function(e){this.info.cursor++;var n=I.createKey(this.name,this.info.cursor),t=new I(n);this._putBlockToCache(t),this.currentBlock=t,e&&e.key&&(t.add(e.key,e.value),this.info.blockMap[e.key]=n,this.info.count++),this.batchQueue.addJob(w.Action.SET,t.blockKey,t.data),this.batchQueue.addJob(w.Action.SET,E+this.name,this.info)}},{key:"init",value:function(e){var r=this,a=0<arguments.length&&void 0!==e?e:function(){};this.batchQueue.init(function(e){e?a(e):L.Storage.getItem(E+r.name,function(e,n){e?a(e):n?r.encryption.decrypt(n,function(e,n){if(e)a(e);else{r.info=JSON.parse(n);var t=I.createKey(r.name,r.info.cursor);r._getBlock(t,function(e,n){e||(r.currentBlock=n||new I(t)),a(e,r.info,!1)})}}):(r.info={blockMap:{},cursor:0,count:0},r.info.cursor=-1,r._assignNewBlock(),a(null,r.info,!0))})})}},{key:"startTransaction",value:function(){this.batchQueue.startTransaction()}},{key:"endTransaction",value:function(){this.batchQueue.endTransaction()}},{key:"getItem",value:function(t,e){var r=1<arguments.length&&void 0!==e?e:function(){},n=this._findBlockKey(t);n?this._getBlock(n,function(e,n){!e&&n?r(null,n.get(t)):r(e||new Error("Broken integrity - data not found."))}):r(null,null)}},{key:"setItem",value:function(t,r,e){var a=this,i=2<arguments.length&&void 0!==e?e:function(){},n=this._findBlockKey(t);if(n)this._getBlock(n,function(e,n){!e&&n?(n.add(t,r),a.batchQueue.addJob(w.Action.SET,n.blockKey,n.data),i(null)):i(e||new Error("Broken integrity - data not found."))});else{var s=this.currentBlock;s&&s.count<this.batchSize?(s.add(t,r),this.batchQueue.addJob(w.Action.SET,s.blockKey,s.data),this.info.count++,this.info.blockMap[t]=s.blockKey,this.batchQueue.addJob(w.Action.SET,E+this.name,this.info)):this._assignNewBlock({key:t,value:r}),i(null)}}},{key:"removeItem",value:function(t,e){var r=this,a=1<arguments.length&&void 0!==e?e:function(){},i=this._findBlockKey(t);i?this._getBlock(i,function(e,n){e?a(e):n?(n.remove(t)&&(r.info.blockMap.hasOwnProperty(t)&&delete r.info.blockMap[t],r.info.count--),0<n.data.length?r.batchQueue.addJob(w.Action.SET,i,n.data):(r._removeBlockFromCache(i),r.batchQueue.addJob(w.Action.REMOVE,i)),r.batchQueue.addJob(w.Action.SET,E+r.name,r.info),a(null)):a(new Error("Failed to remove item - data not found."))}):a(new Error("Failed to remove item - data not found."))}},{key:"clear",value:function(e){for(var n=0<arguments.length&&void 0!==e?e:function(){},t=0;t<=this.info.cursor;t++)this.batchQueue.addJob(w.Action.REMOVE,I.createKey(this.name,t));this.blockCacheCursor=0,this.blockCache={},this.info={blockMap:{},cursor:-1,count:0},this._assignNewBlock(),n(null)}},{key:"drop",value:function(e){var n=this,t=0<arguments.length&&void 0!==e?e:function(){};this.clear(function(){n.batchQueue.addJob(w.Action.REMOVE,E+n.name),t(null)})}},{key:"keys",get:function(){return Object.keys(this.info.blockMap)}},{key:"count",get:function(){return this.info.count}}]),r}();function A(e,n,t){var r=e.offset,a=e.condition,i=e.progress,s=1<arguments.length&&void 0!==n?n:function(e,n){return n(null,!0)},o=2<arguments.length&&void 0!==t?t:function(){},u=r;!function t(){a(u)?setImmediate(function(){s(u,function(e,n){e?o(e):n?(u=i(u),t()):o(null)})}):o(null)}()}var O="idx-",_=function(){function o(e){var n=e.collection,t=e.columns,r=void 0===t?{}:t,a=e.options,i=void 0===a?{}:a;for(var s in g(this,o),this.collection=n,this.columns=r,this.key=o.createKey(this.columns),this.columns)this.columns[s]=1;this.store=new M(n.name+"-index-"+this.key,i),this.table=[]}return c(o,[{key:"columnValues",value:function(n){return this.columnNames.map(function(e){return n?n[e]:null})}},{key:"compareColumnValues",value:function(e,n,t){for(var r=!(2<arguments.length&&void 0!==t)||t,a=this.columnNames,i=0;i<a.length;i++){var s=a[i],o=this.columns[s],u=m(e[i],n[i],r);if(0!==u)return o*u}return 0}},{key:"init",value:function(e){var r=this,a=0<arguments.length&&void 0!==e?e:function(){};this.store.init(function(e,n,t){e?a(e):t?r.save(a):r.store.getItem("".concat(O).concat(r.key),function(e,n){n&&(r.table=n),a(e)})})}},{key:"each",value:function(i,e,n){var s=this,t=1<arguments.length&&void 0!==e?e:null,o=0<(2<arguments.length&&void 0!==n?n:1),r=o?0:this.table.length-1;if(t&&0<this.table.length){for(var a={start:0,end:this.table.length},u=r;a.start<a.end;){var c=this.compareColumnValues(this.table[u].key,t,o);if(0===c)break;0<c?a.end=u-1:a.start=u+1,u=parseInt((a.start+a.end)/2)}r=u}var l=!0;A({offset:r,condition:function(e){return o?e<s.table.length:0<=e},progress:function(e){return o?e+1:e-1}},function(e,n){var t=s.table[e];if(t){var r=t.key,a=t.value;A({offset:o?0:a.length-1,condition:function(e){return o?e<a.length:0<=e},progress:function(e){return o?e+1:e-1}},function(e,t){i({key:r,value:a[e]},function(e,n){t(e,l=e||n)})},function(e){return n(e,l)})}else n(null,!1)},function(){i(null,function(){})})}},{key:"put",value:function(a,e){var i=this,s=!1,o=this.columnValues(e);A({offset:0,condition:function(e){return e<i.table.length},progress:function(e){return e+1}},function(e,n){var t=i.table[e];if(t){var r=i.compareColumnValues(t.key,o);0<r?(i.table.splice(e,0,{key:o,value:[a]}),s=!0,i.save(function(e){return n(e,!1)})):0===r?t.value.indexOf(a)<0?(t.value.push(a),s=!0,i.save(function(e){return n(e,!1)})):n(null,!1):n(null,!0)}else n(null,!1)},function(){s||(i.table.push({key:o,value:[a]}),i.save())})}},{key:"update",value:function(e,n,t){var r=this.columnValues(n),a=this.columnValues(t);0!==this.compareColumnValues(r,a)&&(this.remove(e,n),this.put(e,t))}},{key:"remove",value:function(a,e){var i=this,s=this.columnValues(e);A({offset:0,condition:function(e){return e<i.table.length},progress:function(e){return e+1}},function(e,n){var t=i.table[e];if(t)if(0===i.compareColumnValues(t.key,s)){var r=t.value.indexOf(a);0<=r?(t.value.splice(r,1),0===t.value.length&&i.table.splice(e,1),i.save(function(e){return n(e,!1)})):n(null,!1)}else n(null,!0);else n(null,!1)},function(){})}},{key:"save",value:function(e){var n=0<arguments.length&&void 0!==e?e:function(){};this.store.setItem("".concat(O).concat(this.key),this.table,n)}},{key:"clear",value:function(){this.table=[],this.store.clear()}},{key:"drop",value:function(){this.table=[],this.store.drop()}},{key:"columnNames",get:function(){return Object.keys(this.columns)}}],[{key:"createKey",value:function(n){return Object.keys(n).map(function(e){return"".concat(e,"_").concat(n[e])}).join("__")}}]),o}();function S(){if("undefined"==typeof document&&"undefined"!=typeof navigator&&"ReactNative"==navigator.product)return Promise.resolve(!1);var r=window?window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB:null,a="undefined"!=typeof InstallTrigger||window._isTestingFirefox,i=!!!document.documentMode&&!!window.StyleMedia;return new Promise(function(e,n){try{if(a){if(!r)return void e(!0);var t=r.open("_testMozilla");t.onerror=function(){e(!0)},t.onsuccess=function(){e(!1)}}else i?window.indexedDB||!window.PointerEvent&&!window.MSPointerEvent?e(!1):e(!0):e(!1)}catch(e){n(e)}})}function T(e){return"object"===d(e)&&!!e}var R=function(){function e(){g(this,e),this._field={}}return c(e,[{key:"has",value:function(e){if(T(e))return e.__wk&&"string"==typeof e.__wk&&this._field.hasOwnProperty(e.__wk);throw new Error("Invalid value used as weak map key")}},{key:"get",value:function(e){if(T(e))return e.__wk&&"string"==typeof e.__wk?this._field[e.__wk]:null;throw new Error("Invalid value used as weak map key")}},{key:"set",value:function(e,n){if(!T(e))throw new Error("Invalid value used as weak map key");e.__wk&&"string"==typeof e.__wk||(e.__wk="__".concat((new Date).getTime(),"-").concat(parseInt(1e8*Math.random()))),this._field[e.__wk]=n}},{key:"delete",value:function(e){if(!T(e))throw new Error("Invalid value used as weak map key");this.has(e)&&delete this._field[e.__wk]}},{key:"length",get:function(){return 0}}]),e}(),U=function(){try{return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent&&-1<navigator.userAgent.indexOf("MSIE 10")}catch(e){return!1}}()||function(){try{return document&&9===document.documentMode}catch(e){return!1}}()||function(){try{return document&&document.documentMode<=8}catch(e){return!1}}()||"undefined"==typeof window&&"undefined"!=typeof process?R:WeakMap;"undefined"==typeof Promise&&(Promise=e);var D=new U,N=new U,x=function(){function t(e,n){g(this,t),this.name=e,this.pk=n,D.set(this,new M(e)),N.set(this,[])}return c(t,[{key:"init",value:function(e){var t=D.get(this);return p(function(n){t.init(function(e){n(e)})},e)}},{key:"_findProperIndexer",value:function(e){if(e.index)for(var n=N.get(this),t=0;t<n.length;t++)if(v(n[t].columns,e.index))return n[t];return null}},{key:"_addItemToIndex",value:function(e,n){for(var t=N.get(this),r=0;r<t.length;r++)t[r].put(e,n)}},{key:"_updateItemToIndex",value:function(e,n,t){for(var r=N.get(this),a=0;a<r.length;a++)r[a].update(e,n,t)}},{key:"_removeItemFromIndex",value:function(e,n){for(var t=N.get(this),r=0;r<t.length;r++)t[r].remove(e,n)}},{key:"ensureIndex",value:function(n,e){var t=this,o=D.get(this),r=N.get(this),a=_.createKey(n);return p(function(i){for(var e=0;e<r.length;e++)if(a===r[e].key)return void i(null);var s=new _({collection:t,columns:n,options:{sharedBatchQueue:o.batchQueue}});s.init(function(e,n,t){e?i(e):(r.push(s),t?function(){for(var r=o.keys,a=0,e=function(e){var t=r[e];o.getItem(t,function(e,n){!e&&n?s.put(t,n,function(){++a===r.length&&i(null)}):++a===r.length&&i(null)})},n=0;n<r.length;n++)e(n)}():i(null))})},e)}},{key:"removeIndex",value:function(e,n){var a=N.get(this),i=_.createKey(e);return p(function(t){for(var e=function(n){if(i===a[n].key)return a[n].drop(function(e){e||a.splice(n,1),t(e)}),{v:void 0}},n=0;n<a.length;n++){var r=e(n);if("object"===d(r))return r.v}t(null)},n)}},{key:"findById",value:function(e,n){var r=D.get(this);return p(function(t){e?("string"!=typeof e&&(e=JSON.stringify(e)),r.getItem(e,function(e,n){t(e,n)})):t(new Error("Invalid type: 'id' should not be empty."))},n)}},{key:"findOne",value:function(e,t){return e.limit=1,this.find(e,function(e,n){t(e,0<n.length?n[0]:null)})}},{key:"find",value:function(c,e){var l=this,h=D.get(this);return p(function(n){if(c instanceof k){var r=[],e=l._findProperIndexer(c);if(e){for(var a=[],t=0;t<e.columnNames.length;t++){var i=e.columnNames[t];if(!c.condition[i])break;if("object"===d(c.condition[i])){if("break"===function(){var e=Object.keys(c.condition[i]),n=["="],t=e.filter(function(e){return n.includes(e)});if(!(0<t.length))return"break";var r=e.indexOf(t[0]);a.push(c.condition[i][e[r]])}())break}else{if("function"==typeof c.condition[i]||void 0===c.condition[i]||Array.isArray(c.condition[i]))break;a.push(c.condition[i])}}var s=c.offset||0;e.each(function(e,t){e?h.getItem(e.value,function(e,n){e?t(e):(c.match(n)&&(s<=0?r.push(n):s--),t(null,r.length<c.limit))}):n(null,r)},0<a.length?a:null,c.desc?k.Order.DESC:k.Order.ASC)}else{var o=!c.desc,u=h.keys;A({offset:c.offset<u.length?o?c.offset:u.length-c.offset-1:o?u.length:-1,condition:function(e){return o?r.length<c.limit&&e<u.length:r.length<c.limit&&0<=e},progress:function(e){return o?e+1:e-1}},function(e,t){h.getItem(u[e],function(e,n){e?t(e):(c.match(n)&&r.push(n),setImmediate(function(){return t(null,!0)}))})},function(e){n(e,r)})}}else n(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"count",value:function(i,e){var s=D.get(this);return p(function(n){if(!i||i instanceof k)if(i){var r=s.keys,a=0;A({offset:0,condition:function(e){return e<r.length},progress:function(e){return e+1}},function(e,t){s.getItem(r[e],function(e,n){e?t(e):(i.match(n)&&a++,setImmediate(function(){return t(null,!0)}))})},function(e){n(e,a)})}else n(null,s.count);else n(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"insert",value:function(a,e){var i=this,s=D.get(this);return s.startTransaction(),p(function(t){if(Array.isArray(a)){for(var e=[],n=0;n<a.length;n++)a[n]&&"object"===d(a[n])&&e.push(i.insert(a[n]));a.length===e.length?Promise.all(e).then(function(){return t(null,a)}).catch(function(e){return t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(a&&"object"===d(a))if(a[i.pk]){var r="".concat(a[i.pk]);s.getItem(r,function(e,n){e?t(e):n?t(new Error("Duplicated item: item already exists.")):(i._addItemToIndex(r,a),s.setItem(r,a,function(e){t(e,a)}))})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},e,function(){return s.endTransaction()})}},{key:"upsert",value:function(a,e){var i=this,s=D.get(this);return s.startTransaction(),p(function(t){if(Array.isArray(a)){for(var e=[],n=0;n<a.length;n++)a[n]&&"object"===d(a[n])&&e.push(i.upsert(a[n]));a.length===e.length?Promise.all(e).then(function(){return t(null,a)}).catch(function(e){return t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(a&&"object"===d(a))if(a[i.pk]){var r="".concat(a[i.pk]);s.getItem(r,function(e,n){e?t(e):(n?i._updateItemToIndex(r,n,a):i._addItemToIndex(r,a),s.setItem(r,a,function(e){t(e,a)}))})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},e,function(){return s.endTransaction()})}},{key:"update",value:function(a,e){var i=this,s=D.get(this);return s.startTransaction(),p(function(t){if(Array.isArray(a)){for(var e=[],n=0;n<a.length;n++)a[n]&&"object"===d(a[n])&&e.push(i.update(a[n]));a.length===e.length?Promise.all(e).then(function(){return t(null,a)}).catch(function(e){return t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(a&&"object"===d(a))if(a[i.pk]){var r="".concat(a[i.pk]);s.getItem(r,function(e,n){e?t(e):n?(i._updateItemToIndex(r,n,a),s.setItem(r,a,function(e){t(e,a)})):t(null)})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},e,function(){return s.endTransaction()})}},{key:"updateIf",value:function(c,l,e){var h=this,f=D.get(this);return f.startTransaction(),p(function(n){if(c instanceof k){var u=[],t=f.keys;A({offset:0,condition:function(e){return e<t.length},progress:function(e){return e+1}},function(e,o){f.getItem(t[e],function(e,n){if(e)o(e);else if(n&&c.match(n)){var t=JSON.parse(JSON.stringify(n)),r=!1;for(var a in l){var i=l[a];v(n[a],i)||(r=!0,n[a]=i)}if(r){var s="".concat(n[h.pk]);h._updateItemToIndex(s,t,n),f.setItem(s,n,function(e){e?o(e):(u.push(n),setImmediate(function(){return o(null,!0)}))})}else setImmediate(function(){return o(null,!0)})}else setImmediate(function(){return o(null,!0)})})},function(e){n(e,u)})}else n(new Error("Invalid type: 'query' should be Query type."))},e,function(){return f.endTransaction()})}},{key:"remove",value:function(r,e){var a=this,i=D.get(this);return i.startTransaction(),p(function(t){r?(r="".concat(r),i.getItem(r,function(e,n){e?t(e):n?(a._removeItemFromIndex(r,n),i.removeItem(r,function(e){t(e)})):t(null)})):t(new Error("Invalid type: 'id' should be string type."))},e,function(){return i.endTransaction()})}},{key:"removeIf",value:function(i,e){var s=this,o=D.get(this);return o.startTransaction(),p(function(n){if(i instanceof k){var a=[],t=o.keys;A({offset:0,condition:function(e){return e<t.length},progress:function(e){return e+1}},function(e,r){o.getItem(t[e],function(e,n){if(e)r(e);else if(n&&i.match(n)){var t="".concat(n[s.pk]);s._removeItemFromIndex(t,n),o.removeItem(t,function(e){e?r(e):(a.push(n),setImmediate(function(){return r(null,!0)}))})}else setImmediate(function(){return r(null,!0)})})},function(e){n(e,a)})}else n(new Error("Invalid type: 'query' should be Query type."))},e,function(){return o.endTransaction()})}},{key:"clear",value:function(e){var t=N.get(this),r=D.get(this);return r.startTransaction(),p(function(n){for(var e=0;e<t.length;e++)t[e].clear();r.clear(function(e){n(e)})},e,function(){return r.endTransaction()})}}]),t}();"undefined"==typeof Promise&&(Promise=e);var F=null,q=new U,P=new U,L=function(){function t(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};g(this,t),this.name=e,this.config=new u(n),q.set(this,{}),P.set(this,{})}return c(t,null,[{key:"Query",get:function(){return k}},{key:"Storage",get:function(){return F},set:function(e){F=e}}]),c(t,[{key:"schema",value:function(e,n){var t=q.get(this);return t[e]=n,this}},{key:"build",value:function(){var s=q.get(this),o=P.get(this);return new Promise(function(a,i){var e=[];for(var n in s)if(!o[n]){var t=s[n].key||"_id",r=o[n]=new x(n,t);e.push(r.init())}Promise.all(e).then(function(){var e=[];for(var n in o)if(s[n].index&&0<s[n].index.length){var t=o[n];for(var r in s[n].index)e.push(t.ensureIndex(s[n].index[r]))}0<e.length?Promise.all(e).then(function(){a()}).catch(function(e){return i(e)}):a()}).catch(function(e){return i(e)})})}},{key:"close",value:function(){}},{key:"drop",value:function(){q.set(this,{}),_db.set(this,null),P.set(this,{}),F.clear()}},{key:"collection",value:function(e){var n=P.get(this);return n[e]&&n[e]instanceof x?n[e]:null}}]),t}();"undefined"==typeof Promise&&(Promise=e);function B(){var e=!!document.documentMode,n=!e&&!!window.StyleMedia;return!e&&!n}function V(n,t){var e=d(n),r=d(t);return!n||!t||"object"!==e||e!==r||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===e&&"function"===r||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(e){return V(n[e],t[e])})}function j(e){var n=null;return e&&(Array.isArray(e)?n=B()?e.join("_"):e[e.length-1]:"object"===d(e)?n=j(Object.keys(e)):"string"==typeof e&&(n=e)),n}function G(e,n,a){if(!n)return new Promise(function(t,r){e(function(e,n){a&&"function"==typeof a&&a(),e?r(e):t(n)})});e(n)}var Q=new U,H=function(){function r(e,n,t){g(this,r),this.name=n,this.keyPath=t,Q.set(this,e)}return c(r,[{key:"findById",value:function(t,e){var r=this,a=Q.get(this);return G(function(e){var n=a.transaction(r.name,"readonly").objectStore(r.name).get(t);n.onsuccess=function(){return e(null,n.result||null)},n.onerror=function(){return e(n.error)}},e)}},{key:"find",value:function(s,e){var o=this,u=Q.get(this);return G(function(r){if(s instanceof Z.Query){var e=j(s.index),a=[],n=u.transaction(o.name,"readonly").objectStore(o.name),t=e?n.index(e).openCursor(null,s.desc?"prev":"next"):n.openCursor(),i=s.offset;t.onsuccess=function(e){var n=e.target.result;if(n){var t=n.value;s.match(t)?!i||i<0?(a.push(t),a.length<s.limit?n.continue():r(null,a)):(i--,n.continue()):n.continue()}else r(null,a)},t.onerror=function(){r(t.error)}}else r(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"count",value:function(i,e){var s=this,o=Q.get(this);return G(function(n){if(!i||i instanceof Z.Query){var e=o.transaction(s.name,"readonly").objectStore(s.name);if(i){var t=0,r=e.openCursor();r.onsuccess=function(){var e=event.target.result;e?(i.match(e.value)&&t++,e.continue()):n(null,t)},r.onerror=function(){n(r.error)}}else{var a=e.count();a.onsuccess=function(){return n(null,a.result)},a.onerror=function(){return n(a.error)}}}else n(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"insert",value:function(s,e){var n=this,t=Q.get(this);return G(function(a){var i=t.transaction(n.name,"readwrite").objectStore(n.name);if(Array.isArray(s))!function(){function e(e){var n=s[e],t=i.add(n);t.onsuccess=function(){r.push(n),r.length===s.length&&a(null,r)},t.onerror=function(){a(t.error)}}var r=[];for(var n in s)e(n)}();else if(s&&"object"===d(s)){var e=i.add(s);e.onsuccess=function(){return a(null,s)},e.onerror=function(){return a(e.error)}}else a(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"upsert",value:function(i,e){var n=this,s=Q.get(this);return G(function(t){var r=s.transaction(n.name,"readwrite").objectStore(n.name);if(i&&"object"===d(i)){var a=r.get(i[n.keyPath]);a.onsuccess=function(){if(a.result){var e=r.put(i);e.onsuccess=function(){return t(null,i)},e.onerror=function(){return t(e.error)}}else{var n=r.add(i);n.onsuccess=function(){return t(null,i)},n.onerror=function(){return t(n.error)}}},a.onerror=function(){t(a.error)}}else t(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"update",value:function(t,e){var r=this,a=Q.get(this);return G(function(e){var n=a.transaction(r.name,"readwrite").objectStore(r.name).put(t);n.onsuccess=function(){return e(null,t)},n.onerror=function(){return e(n.error)}},e)}},{key:"updateIf",value:function(l,h,e){var n=this,t=Q.get(this);return G(function(o){if(l instanceof Z.Query){var u=[],c=t.transaction(n.name,"readwrite").objectStore(n.name),e=c.openCursor();e.onsuccess=function(e){var n=e.target.result;if(n){var t=n.value;if(l.match(t)){var r=!1;for(var a in h){var i=h[a];V(t[a],i)||(r=!0,t[a]=i)}if(r){var s=c.put(t);s.onsuccess=function(){u.push(t),n.continue()},s.onerror=function(){o(s.error)}}else n.continue()}else n.continue()}else o(null,u)},e.onerror=function(){o(e.error)}}else o(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"remove",value:function(t,e){var r=this,a=Q.get(this);return G(function(e){var n=a.transaction(r.name,"readwrite").objectStore(r.name).delete(t);n.onsuccess=function(){return e(null)},n.onerror=function(){return e(n.error)}},e)}},{key:"removeIf",value:function(o,e){var u=this,n=Q.get(this);return G(function(a){if(o instanceof Z.Query){var i=[],s=n.transaction(u.name,"readwrite").objectStore(u.name),e=s.openCursor();e.onsuccess=function(e){var n=e.target.result;if(n){var t=n.value;if(o.match(t)){var r=s.delete(t[u.keyPath]);r.onsuccess=function(){i.push(t),n.continue()},r.onerror=function(){a(r.error)}}else n.continue()}else a(null,i)},e.onerror=function(){a(e.error)}}else a(new Error("Invalid type: 'query' should be LocalDB.Query type."))},e)}},{key:"clear",value:function(e){var t=this,r=Q.get(this);return G(function(e){var n=r.transaction(t.name,"readwrite").objectStore(t.name).clear();n.onsuccess=function(){return e(null)},n.onerror=function(){return e(n.error)}},e)}}]),r}(),K=function(){function r(e){g(this,r),this.condition=e,this.offset=0,this.limit=1/0,this.index=null,this.desc=!1}return c(r,null,[{key:"and",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/and":n}):new r({})}},{key:"or",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/or":n}):new r({})}},{key:"Order",get:function(){return{ASC:1,DESC:-1}}}]),c(r,[{key:"match",value:function(e){return function t(r,e){var n=!0;for(var a in e){switch(a){case"/and":n=n&&e[a].reduce(function(e,n){return e&&t(r,n)},!0);break;case"/or":n=n&&e[a].reduce(function(e,n){return e||t(r,n)},!1);break;default:var i=e[a];if("object"===d(i))for(var s in i)switch(s){case">":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]>i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&0<r[a].localeCompare(i[s]));break;case">=":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]>=i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&0<=r[a].localeCompare(i[s]));break;case"<":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]<i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&r[a].localeCompare(i[s])<0);break;case"<=":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]<=i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&r[a].localeCompare(i[s])<=0);break;case"=":n=n&&r[a]===i[s];break;case"!=":n=n&&r[a]!==i[s];break;case"/in":n=n&&Array.isArray(i[s])&&0<=i[s].indexOf(r[a]);break;case"/nin":n=n&&Array.isArray(i[s])&&i[s].indexOf(r[a])<0;break;case"/like":n=n&&"string"==typeof i[s]&&"string"==typeof r[a]&&0<=r[a].indexOf(i[s]);break;case"/nlike":n=n&&"string"==typeof i[s]&&"string"==typeof r[a]&&r[a].indexOf(i[s])<0;break;case"/regex":n=n&&i[s]instanceof RegExp&&i[s].test(r[a]);break;case"/where":n=n&&i[s](r[a]);break;default:n=n&&V(r[a],i)}else n=n&&r[a]===i}if(!n)break}return n}(e,this.condition)}}]),r}();"undefined"==typeof Promise&&(Promise=e);var W=new U,J=new U,X=new U,Y=window?window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB:null,Z=function(){function t(e,n){if(g(this,t),!Y)throw new Error("IndexedDB is not supported in this environment. Check if you're in web browser which supports IndexedDB.");this.name=e,this.version=n,W.set(this,{}),J.set(this,null),X.set(this,{})}return c(t,null,[{key:"Query",get:function(){return K}}]),c(t,[{key:"schema",value:function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},t=W.get(this);return t[e]=n,this}},{key:"build",value:function(){var I=this,b=W.get(this),C=X.get(this);return new Promise(function(a,n){var e=Y.open(I.name,I.version);e.onerror=function(e){n(new Error("IndexedDB is not available: ".concat(e.target.errorCode)))},e.onupgradeneeded=function(e){var n=e.target.result,t=e.target.transaction,r=n.objectStoreNames;for(var a in b){var i=b[a].key||"id",s=null;try{s=t.objectStore(a)}catch(e){"NotFoundError"===e.name&&(s=n.createObjectStore(a,{keyPath:i}))}if(s){for(var o=[],u=0;u<s.indexNames.length;u++)o.push(s.indexNames[u]);var c=new H(n,a,i);if(b[a].index&&0<b[a].index.length)for(var l in b[a].index){var h=j(b[a].index[l]);if(h){var f=!1;for(var d in o)if(o[d]===h){f=!0;break}if(!f){var g=Object.keys(b[a].index[l]);s.createIndex(h,B()?g:g[g.length-1],{unique:!1}),o.push(h)}}}var v=[];if(b[a].index)for(var y in b[a].index){var m=j(b[a].index[y]);m&&v.push(m)}for(var p=0;p<o.length;p++)v.indexOf(o[p])<0&&s.deleteIndex(o[p]);C[a]=c}}for(var k=0;k<r.length;k++)Object.keys(b).indexOf(r.item(k))<0&&n.deleteObjectStore(r.item(k));J.set(I,n)},e.onsuccess=function(e){var n=e.target.result;for(var t in b)if(!C[t]){var r=b[t].key||"id";C[t]=new H(n,t,r)}J.set(I,n),a()}})}},{key:"close",value:function(){var e=J.get(this);e&&(e.close(),J.set(this,null))}},{key:"drop",value:function(){Y.deleteDatabase(this.name)}},{key:"collection",value:function(e){var n=X.get(this);return n[e]&&n[e]instanceof H?n[e]:null}}]),t}();function $(n,t){var e=d(n),r=d(t);return!n||!t||"object"!==e||e!==r||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===e&&"function"===r||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(e){return $(n[e],t[e])})}function ee(e,t,a){if(!t)return new Promise(function(t,r){e(function(e,n){a&&"function"==typeof a&&a(),e?r(e):t(n)})});e(function(e,n){a&&"function"==typeof a&&a(),t(e,n)})}"undefined"==typeof Promise&&(Promise=e);var ne=function(){function r(e){g(this,r),this.condition=e,this.offset=0,this.limit=1/0,this.index=null,this.desc=!1}return c(r,null,[{key:"and",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/and":n}):new r({})}},{key:"or",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return 0<n.length?new r({"/or":n}):new r({})}},{key:"Order",get:function(){return{ASC:1,DESC:-1}}}]),c(r,[{key:"match",value:function(e){return function t(r,e){var n=!0;for(var a in e){switch(a){case"/and":n=n&&e[a].reduce(function(e,n){return e&&t(r,n)},!0);break;case"/or":n=n&&e[a].reduce(function(e,n){return e||t(r,n)},!1);break;default:var i=e[a];if("object"===d(i))for(var s in i)switch(s){case">":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]>i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&0<r[a].localeCompare(i[s]));break;case">=":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]>=i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&0<=r[a].localeCompare(i[s]));break;case"<":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]<i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&r[a].localeCompare(i[s])<0);break;case"<=":n="number"==typeof r[a]&&"number"==typeof i[s]?n&&r[a]<=i[s]:"string"==typeof r[a]&&"string"==typeof i[s]&&(n&&r[a].localeCompare(i[s])<=0);break;case"=":n=n&&r[a]===i[s];break;case"!=":n=n&&r[a]!==i[s];break;case"/in":n=n&&Array.isArray(i[s])&&0<=i[s].indexOf(r[a]);break;case"/nin":n=n&&Array.isArray(i[s])&&i[s].indexOf(r[a])<0;break;case"/like":n=n&&"string"==typeof i[s]&&"string"==typeof r[a]&&0<=r[a].indexOf(i[s]);break;case"/nlike":n=n&&"string"==typeof i[s]&&"string"==typeof r[a]&&r[a].indexOf(i[s])<0;break;case"/regex":n=n&&i[s]instanceof RegExp&&i[s].test(r[a]);break;case"/where":n=n&&i[s](r[a]);break;default:n=n&&$(r[a],i)}else n=n&&r[a]===i}if(!n)break}return n}(e,this.condition)}}]),r}();"undefined"==typeof Promise&&(Promise=e);var te=null,re=function(){function e(){if(g(this,e),te)return te;(te=this).queries=[],this.executing=!1,this.intervalID=null}return c(e,[{key:"addTask",value:function(t,r){var a=this;return new Promise(function(e,n){a.queries.push({task:t,cb:r,resolve:e,reject:n}),a._delay(),a.executeTask()})}},{key:"executeTask",value:function(){var e=this;if(0<this.queries.length&&!this.executing){this.executing=!0;var n=this.queries[0].task,t=this.queries[0].cb,r=this.queries[0];return new Promise(function(t,r){n(function(e,n){e?r(e):t(n)})}).then(function(e){r.resolve(e),t&&t(null,e)}).catch(function(e){r.reject(e),t&&t(e)}).finally(function(){e._executeNext()})}return Promise.resolve(!0)}},{key:"_delay",value:function(){}},{key:"_executeNext",value:function(){var t=this;if(this.executing=!1,0<this.queries.length)return this.queries=this.queries.slice(1),new Promise(function(e,n){t._delay(),e(t.executeTask())})}},{key:"start",value:function(){}},{key:"stop",value:function(){}}],[{key:"getInstance",value:function(){return new e}}]),e}();"undefined"==typeof Promise&&(Promise=e);var ae=function(){function t(e,n){g(this,t),this.name=e,this.pk=n,this.store={},this.columns=[],this.queue=re.getInstance(),this.queue.start()}return c(t,[{key:"findById",value:function(n,e){var t=this;return this.queue.addTask(function(e){n?("string"!=typeof n&&(n=JSON.stringify(n)),t.store.hasOwnProperty(n)?e(null,t.store[n]):e(null,null)):e(new Error("Invalid type: 'id' should not be empty."))},e)}},{key:"findOne",value:function(e,n){return e.limit=1,this.find(e,n)}},{key:"find",value:function(s,e){var o=this;return this.queue.addTask(function(e){if(s instanceof ne){var n=[],t=Object.keys(o.store).map(function(e){return o.store[e]});for(var r in t){var a=t[r];s.match(a)&&n.push(a)}s.index&&"Message"!==o.name&&n.sort(function(e,n){for(var t in s.index){if(e[t]>n[t])return s.index[t];if(e[t]<n[t])return-1*s.index[t]}return 0}),s.desc&&n.reverse();var i=s.offset||0;e(null,0<=s.limit&&n.length>=s.limit?n.slice(i,s.limit+i):n.slice(i))}else e(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"count",value:function(i,e){var s=this;return this.queue.addTask(function(e){if(!i||i instanceof ne)if(i){var n=0,t=i.offset||0;for(var r in s.store){if(n>=i.limit)break;var a=s.store[r];i.match(a)&&(t<=0?n+=1:t--)}e(null,n)}else e(null,Object.keys(s.store).length);else e(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"_insertSingle",value:function(t,e){var r=this;return ee(function(e){if(t[r.pk]){var n="".concat(t[r.pk]);r.store.hasOwnProperty(n)?e(new Error("Duplicated item: item already exists.")):e(null,r.store[n]=t)}else e(new Error("Invalid key: item should have key."))},e)}},{key:"insert",value:function(r,e){var a=this;return this.queue.addTask(function(t){if(Array.isArray(r)){for(var e=[],n=0;n<r.length;n++)r[n]&&"object"===d(r[n])&&e.push(a._insertSingle(r[n]));r.length===e.length?Promise.all(e).then(function(){t(null,r)}).catch(function(e){t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else r&&"object"===d(r)?a._insertSingle(r,function(e,n){t(e,n)}):t(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"_upsertSingle",value:function(t,e){var r=this;return ee(function(e){if(t[r.pk]){var n="".concat(t[r.pk]);e(null,r.store[n]=t)}else e(new Error("Invalid key: item should have key."))},e)}},{key:"upsert",value:function(r,e){var a=this;return this.queue.addTask(function(t){if(Array.isArray(r)){for(var e=[],n=0;n<r.length;n++)r[n]&&"object"===d(r[n])&&e.push(a._upsertSingle(r[n]));r.length===e.length?Promise.all(e).then(function(){t(null,r)}).catch(function(e){t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else r&&"object"===d(r)?a._upsertSingle(r,function(e,n){t(e,n)}):t(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"_updateSingle",value:function(t,e){var r=this;return ee(function(e){if(t[r.pk]){var n="".concat(t[r.pk]);r.store.hasOwnProperty(n)?e(null,r.store[n]=t):e(new Error("Invalid key: no item with such key was found"))}else e(new Error("Invalid key: item should have key."))},e)}},{key:"update",value:function(r,e){var a=this;return this.queue.addTask(function(t){if(Array.isArray(r)){for(var e=[],n=0;n<r.length;n++)r[n]&&"object"===d(r[n])&&e.push(a._updateSingle(r[n]));r.length===e.length?Promise.all(e).then(function(){t(null,r)}).catch(function(e){t(e)}):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else r&&"object"===d(r)?a._updateSingle(r,function(e,n){t(e,n)}):t(new Error("Invalid type: 'item' should be an object or an object array."))},e)}},{key:"updateIf",value:function(s,o,e){var u=this;return this.queue.addTask(function(e){if(s instanceof ne){var n=[];for(var t in u.store){var r=u.store[t];if(s.match(r))for(var a in o){var i=o[a];$(r[a],i)||(r[a]=i,n.push(r))}}e(null,n)}else e(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"remove",value:function(n,e){var t=this;return this.queue.addTask(function(e){n?(n="".concat(n),t.store.hasOwnProperty(n)?(delete t.store[n],e(null)):e(new Error("Invalid key: no item with such key was found"))):e(new Error("Invalid type: 'id' should be string type."))},e)}},{key:"removeIf",value:function(a,e){var i=this;return this.queue.addTask(function(e){if(a instanceof ne){var n=[];for(var t in i.store){var r=i.store[t];a.match(r)&&(n.push(r),delete i.store[t])}e(null,n)}else e(new Error("Invalid type: 'query' should be Query type."))},e)}},{key:"clear",value:function(e){var n=this;return this.queue.addTask(function(e){n.store={},e(null)},e)}}]),t}();"undefined"==typeof Promise&&(Promise=e);var ie=new U,se=new U,oe=function(){function t(e,n){g(this,t),this.name=e,this.version=n,ie.set(this,{}),se.set(this,{}),re.getInstance().start()}return c(t,null,[{key:"Query",get:function(){return ne}}]),c(t,[{key:"schema",value:function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},t=ie.get(this);return t[e]=n,this}},{key:"build",value:function(){var a=ie.get(this),i=se.get(this);return new Promise(function(e,n){for(var t in a)if(!i[t]){var r=a[t].key||"_id";i[t]=new ae(t,r)}e()})}},{key:"close",value:function(){}},{key:"drop",value:function(){ie.set(this,{});var e=se.get(this);for(var n in e)e[n].clear();se.set(this,{})}},{key:"collection",value:function(e){var n=se.get(this);return n[e]&&n[e]instanceof ae?n[e]:null}}]),t}();"undefined"==typeof Promise&&(Promise=e);function ue(s,t){function a(e,n){var t=On.getInstance();t.currentUserId?(e.ownerUserId=t.currentUserId,e.lastMessageUpdatedAt=e.lastMessage?e.lastMessage.createdAt:e.createdAt,me.cache("upsert channel","url="+e.url,"name="+e.name,"createdAt="+e.createdAt,"lastMessageUpdatedAt="+e.lastMessageUpdatedAt),u.upsert(e.serialize(),n)):n(pe.create(pe.Type.ERROR_SETUP_MISSING))}function o(e){if(e){var n=t.GroupChannel.buildFromSerializedData(e);return n.lastMessageUpdatedAt=n.lastMessage?n.lastMessage.createdAt:n.createdAt,n}return null}var e=this,u=s.collection("GroupChannel");return this.query=function(e,n,i){var t=On.getInstance();if(t.currentUserId){e.ownerUserId=t.currentUserId;var r=new On.LocalDB.Query(e);n&&(r.offset=n.offset||0,r.limit=n.limit||20,r.index=n.index,r.desc=n.desc),u.find(r,function(e,n){if(e)i(e);else{for(var t=[],r=0;r<n.length;r++){var a=o(n[r]);t.push(a)}i(null,t)}})}else i(pe.create(pe.Type.ERROR_SETUP_MISSING))},this.insert=function(t,r){e.getItem(t.url,function(e,n){e?r(e):n?r(null,t):a(t,function(e){e?r(e):r(null,t)})})},this.upsert=function(e,t){a(e,function(e,n){e?t(e):t(null,o(n))})},this.remove=function(e,t){var r,a,i;r=e,a=function(e,n){e?t(e):t(null,o(n))},(i=On.getInstance()).currentUserId?(me.cache("remove channel",r.url),u.remove(r.url,function(e,n){if(e)a(e);else{var t=new On.LocalDB.Query({ownerUserId:i.currentUserId,channelUrl:r.url});s.collection("MessageChunk").removeIf(t,function(e){e?a(e):s.collection("Message").removeIf(t,function(e){e?a(e):a(null,n)})})}})):a(pe.create(pe.Type.ERROR_SETUP_MISSING))},this.getItem=function(e,t){u.findById(e,function(e,n){e?t(e):t(null,o(n))})},this.clear=function(e){return n=e,me.cache("clear channel"),void u.clear(function(e){e?n(e):s.collection("MessageChunk").clear(function(e){e?n(e):s.collection("Message").clear(n)})});var n},this}function ce(e,t){var i=this,s=e.collection("GroupChannelListQuery"),o=function(e){if(e){var n=t.GroupChannelListQuery.buildFromSerializedData(e);return n.filterKey=e.filterKey,n.ownerUserId=e.currentUserId,n.updatedAt=e.updatedAt,n.savepoint=e.savepoint,n}return null};return this.createFilterKey=function(e){var n=[];return n.push("order=".concat(e.order)),n.push("includeEmpty=".concat(e.includeEmpty)),n.push("customTypesFilter=".concat(e.customTypesFilter.sort().join(","))),n.join("&")},this.upsert=function(e,t){!function(r,a){r.filterKey=i.createFilterKey(r);var e=On.getInstance();if(e.currentUserId){me.cache("upsert channel list query",r.filterKey),r.ownerUserId=e.currentUserId,r.updatedAt=(new Date).getTime(),r.savepoint||(r.savepoint="");var n=r.serialize();s.upsert(n,function(e,n){if(e)a(e);else{if(ke[r.filterKey])for(var t in r)ke[r.filterKey].hasOwnProperty(t)&&(ke[r.filterKey][t]=r[t]);else ke[r.filterKey]=r;a(null,o(n))}})}else a(pe.create(pe.Type.ERROR_SETUP_MISSING))}(e,function(e,n){e?t(e):t(null,o(n))})},this.remove=function(e,t){var r,a;r=e,a=function(e,n){e?t(e):t(null,o(n))},On.getInstance().currentUserId?(me.cache("remove channel list query",r.filterKey),s.remove(r.filterKey,function(e,n){e?a(e):(ke[r.filterKey]&&delete ke[r.filterKey],a(null,n))})):a(pe.create(pe.Type.ERROR_SETUP_MISSING))},this.getItem=function(e,t){ke[e]?t(null,ke[e]):s.findById(e,function(e,n){e?t(e):t(null,o(n))})},this.clear=function(e){return n=e,me.cache("clear channel list query"),ke={},void s.clear(function(e){return n(e)});var n},this}var le=null,he=!1,fe=function(){function e(){g(this,e)}return c(e,null,[{key:"init",value:function(){le=le||(window?window.localStorage:null)}},{key:"useReactNative",value:function(e){le=e,he=!0}},{key:"getKeys",value:function(){return he?le.getAllKeys():new Promise(function(e){var n=[];for(var t in le)n.push(t);e(n)})}},{key:"get",value:function(t){return he?le.getItem(t):new Promise(function(e){var n=le.getItem(t);e(void 0!==n?n:null)})}},{key:"set",value:function(n,t){return he?le.setItem(n,t):new Promise(function(e){le.setItem(n,t),e()})}},{key:"remove",value:function(n){return he?le.removeItem(n):new Promise(function(e){le.removeItem(n),e()})}},{key:"clear",value:function(){return he?le.clear():new Promise(function(e){le.clear(),e()})}}]),e}(),de=98765,ge={NONE:0,ERROR:1,WARNING:2,INFO:3},ve=ge.NONE,ye="",me=function(){function r(){g(this,r)}return c(r,null,[{key:"isValidLevel",value:function(e){return-1<Object.keys(ge).map(function(e){return ge[e]}).indexOf(e)}},{key:"_permit",value:function(e,n){if(e<=ve){var t="";switch(e){case ge.ERROR:t="error";break;case ge.WARNING:t="warning";break;case ge.INFO:case de:t="log";break;default:t=""}if(console&&console[t]){for(var r,a,i="".concat(ye," ").concat(n||""," "),s=arguments.length,o=new Array(2<s?s-2:0),u=2;u<s;u++)o[u-2]=arguments[u];if("string"==typeof o[0])o[0]=i+o[0],(r=console)[t].apply(r,o);else(a=console)[t].apply(a,[i].concat(o))}}}},{key:"error",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[ge.ERROR,"[ERROR]"].concat(n))}},{key:"warning",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[ge.WARNING,"[WARNING]"].concat(n))}},{key:"info",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[ge.INFO,"[INFO]"].concat(n))}},{key:"call",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[de,"[CALL]"].concat(n))}},{key:"event",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[de,"[EVENT]"].concat(n))}},{key:"view",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[de,"[VIEW]"].concat(n))}},{key:"message",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[de,"[MESSAGE]"].concat(n))}},{key:"cache",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[de,"[CACHE]"].concat(n))}},{key:"sync",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];r._permit.apply(r,[de,"[SYNC]"].concat(n))}},{key:"level",set:function(e){var n=Object.keys(ge).map(function(e){return ge[e]});n.push(de),-1<n.indexOf(e)&&(ve=e)},get:function(){return ve}},{key:"prefix",set:function(e){"string"==typeof e&&(ye=e)}}]),r}(),pe=function(){function r(e,n){var t;return g(this,r),(t=o(this,a(r).call(this,e))).name="SyncManagerException",t.code=n||0,t}return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&i(e,n)}(r,n(Error)),c(r,null,[{key:"create",value:function(e){var n=0<arguments.length&&void 0!==e?e:r.Type.ERROR_UNKNOWN;return new r(n.message,n.code)}},{key:"throw",value:function(e){me.error(e)}},{key:"Type",get:function(){return{ERROR_UNKNOWN:{code:81e4,message:"Unknown error occurred."},ERROR_DATABASE_IO:{code:810001,message:"Database I/O operation failed."},ERROR_SETUP_MISSING:{code:810100,message:"SendBirdSyncManager.setup() is not called."},ERROR_SENDBIRD_MISSING:{code:810101,message:"SendBird instance should be set before init()."},ERROR_DUPLICATED_FETCH:{code:810200,message:"Fetch is in progress."},ERROR_DUPLICATED_CHANGELOG_SYNC:{code:810210,message:"Sync is in progress."},ERROR_INVALID_PARAMETER:{code:810300,message:"Invalid parameter."}}}}]),r}(),ke={};function Ie(e,n){return(1<arguments.length&&void 0!==n?n:[]).map(function(e){return e.url}).indexOf(e.url)}function be(e,n,t){var r=2<arguments.length&&void 0!==t?t:[],a=null,i=function(e,n){return n<e};switch(n.order){case"latest_last_message":a="lastMessageUpdatedAt";break;case"chronological":a="createdAt";break;case"channel_name_alphabetical":a="name",i=function(e,n){return e.localeCompare(n)<0};break;default:a="lastMessageUpdatedAt"}var s=Ie(e,r);s<0&&(s=r.length);for(var o=0;o<r.length;o++){var u=r[o];if(e[a]===u[a]&&e.url===u.url){s=o;break}if(i(e[a],u[a])){s=o;break}}return s}function Ce(e,n){for(var t=1<arguments.length&&void 0!==n?n:[],r=0;r<t.length;r++)if(e.isIdentical(t[r]))return r;return-1}function we(e,n){for(var t=1<arguments.length&&void 0!==n?n:[],r=t.length,a=0;a<t.length;a++)if(t[a].createdAt>=e.createdAt){r=a;break}return r}"undefined"==typeof Promise&&(Promise=e);function Ee(){var t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:3&n|8).toString(16)})}function Me(e,n){if(!n)return new Promise(function(n,t){e(function(e){return e?t(e):n()})});e(n)}var Ae="unsent";function Oe(e){return"".concat(Ae,"-").concat(e)}function _e(e){if(e)if(e.requestState&&"succeeded"!==e.requestState){if(!e.reqId)throw pe.throw(pe.create(pe.Type.ERROR_INVALID_PARAMETER));e.messageId=Oe(e.reqId)}else e.messageId="".concat(e.messageId)}function Se(e,r){function s(e,t){var n=On.getInstance(),r=e.isDeleted?e:l(e.serialize());_e(r),r.messageId?n.currentUserId?(r.hasOwnProperty("isVisible")||(r.isVisible=!0),r.hasOwnProperty("isDeleted")||(r.isDeleted=!1),r.ownerUserId=n.currentUserId,me.cache("upsert message",r.messageId,r.createdAt,r.reqId,"owner="+r.ownerUserId,"visible="+r.isVisible,"deleted="+r.isDeleted),c.findById(r.messageId,function(e,n){e?t(e):n?n.isDeleted?t(null,n):(r.isVisible=r.isVisible||n.isVisible,c.upsert(r.serialize(),function(e,n){e?t(e):t(null,n)})):c.upsert(r.serialize(),function(e,n){e?t(e):t(null,n)})})):t(pe.create(pe.Type.ERROR_SETUP_MISSING)):t(null,e)}function o(e,n){return n.messageType&&(e.messageType=n.messageType),n.customType&&(e.customType=n.customType),n.senderUserIdsFilter&&0<n.senderUserIdsFilter.length&&(e["sender.userId"]={"/in":n.senderUserIdsFilter}),e}var u=this,c=e.collection("Message"),l=function(e){var n,t=null;return e&&("user"===e.messageType?t=r.UserMessage.buildFromSerializedData(e):"file"===e.messageType?t=r.FileMessage.buildFromSerializedData(e):"admin"===e.messageType&&(t=r.AdminMessage.buildFromSerializedData(e))),t&&(n=t)&&(n.requestState&&"succeeded"!==n.requestState?n.messageId=0:n.messageId=parseInt(n.messageId)),t};return this.query=function(e,n,i){e.isVisible=!0,e.isDeleted=!1;var t=On.getInstance();if(t.currentUserId){e.ownerUserId=t.currentUserId;var r=new On.LocalDB.Query(e);n&&(r.offset=n.offset||0,r.limit=n.limit||50,r.desc=n.desc),r.index={ownerUserId:On.LocalDB.Query.Order.ASC,channelUrl:On.LocalDB.Query.Order.ASC,createdAt:On.LocalDB.Query.Order.DESC},c.find(r,function(e,n){if(e)i(e);else{for(var t=[],r=0;r<n.length;r++){var a=l(n[r]);t.push(a)}i(null,t)}})}else i(pe.create(pe.Type.ERROR_SETUP_MISSING))},this.find=function(e,n){c.find(e,n)},this.count=function(e,n){c.count(e,n)},this.upsert=function(e,t){e?s(e,function(e,n){e?t(e):t(null,l(n))}):t(null)},this.remove=function(a,i){u.getItem(a,function(e,n){var t=On.getInstance(),r={messageId:a,isDeleted:!0,serialize:function(){return{messageId:"".concat(a),ownerUserId:n?n.ownerUserId:t.currentUserId,channelUrl:n?n.channelUrl:"",createdAt:n?n.createdAt:0,requestState:n?n.requestState:"succeeded",isVisible:!1,isDeleted:!0}}};s(r,function(e){e?i(e):i(null,a)})})},this.removeUnsent=function(e,a){var n=Oe(e);u.getItem(n,function(e,n){var t,r;e?a(e):n?(t=n,r=a,On.getInstance().currentUserId?(me.cache("remove message",t.messageId),_e(t),c.remove(t.messageId,r)):r(pe.create(pe.Type.ERROR_SETUP_MISSING))):a(null)})},this.removeExpiredMessages=function(e,n){var t=(new Date).getTime()-864e5*e,r=new On.LocalDB.Query({ownerUserId:On.getInstance().currentUserId,requestState:"failed",createdAt:{"<":t}});r.limit=Number.MAX_SAFE_INTEGER,r.index={ownerUserId:On.LocalDB.Query.Order.ASC,createdAt:On.LocalDB.Query.Order.ASC},c.removeIf(r,n)},this.loadMessagesByHistoryOffset=function(e,n,t){var r={channelUrl:n,createdAt:{"<":e},ownerUserId:On.getInstance().currentUserId},a={};a.limit=Number.MAX_SAFE_INTEGER,a.desc=!0,u.query(r,a,t)},this.clearMessagesByHistoryOffset=function(e,n,t){var r=new On.LocalDB.Query({channelUrl:n,ownerUserId:On.getInstance().currentUserId,createdAt:{"<":e}});r.limit=Number.MAX_SAFE_INTEGER,r.index={ownerUserId:On.LocalDB.Query.Order.ASC,channelUrl:On.LocalDB.Query.Order.ASC,createdAt:On.LocalDB.Query.Order.DESC},c.removeIf(r,t)},this.getItemWithVisibility=function(e,t){c.findById(e,function(e,n){e?t(e):t(null,{item:l(n),isVisible:!!n&&n.isVisible})})},this.getItem=function(e,t){c.findById(e,function(e,n){e?t(e):t(null,l(n))})},this.clear=function(e){return n=e,me.cache("clear messages"),void c.clear(function(e){return n(e)});var n},this.loadPreviousSucceededMessages=function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:(new Date).getTime(),r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},a=4<arguments.length?arguments[4]:void 0,i={channelUrl:e,requestState:{"!=":"failed"},createdAt:{"<=":t}};o(i,n),r.desc=!0,u.query(i,r,a)},this.loadNextSucceededMessages=function(e){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},t=4<arguments.length?arguments[4]:void 0,r={channelUrl:e,requestState:{"!=":"failed"},createdAt:{">=":2<arguments.length&&void 0!==arguments[2]?arguments[2]:0}};o(r,1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}),n.desc=!1,u.query(r,n,t)},this.loadFailedMessages=function(e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},t=3<arguments.length?arguments[3]:void 0,r={channelUrl:e,requestState:"failed"};o(r,1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}),n.limit=Number.MAX_SAFE_INTEGER,n.desc=!0,u.query(r,n,t)},this.loadOldestFailedMessages=function(e){var n={requestState:"failed"};o(n,{});var t={limit:Number.MAX_SAFE_INTEGER,desc:!1};u.query(n,t,e)},this}function Te(e){var n=[];for(var t in e)n.push("".concat(t,"=").concat(e[t]));return n.join("&")}function Re(e){var o=this,u=e.collection("MessageChunk");return this.reload=function(e,n){return u.findById(e.chunkId,n)},this.upsert=function(e,t){var n,r,a;n=e,r=function(e,n){e?t(e):t(null,De.createFromJson(n))},(a=On.getInstance()).currentUserId?(n.ownerUserId=a.currentUserId,Ue[n.chunkId]=n,u.upsert(Ue[n.chunkId].serialize(),function(e,n){e?r(e):r(null,n)})):r(pe.create(pe.Type.ERROR_SETUP_MISSING))},this.remove=function(n,t){var e,r;e=n,r=function(e){e?t(e):t(null,n)},On.getInstance().currentUserId?(Ue[e]&&delete Ue[e],u.remove(e,function(e,n){e?r(e):r(null,n)})):r(pe.create(pe.Type.ERROR_SETUP_MISSING))},this.clear=function(e){return n=e,Ue={},void u.clear(function(e){return n(e)});var n},this.getChunksByHistoryOffset=function(e,n,t){var r=On.getInstance(),a=De.getDefaultFilter();if(r.currentUserId){var i=new On.LocalDB.Query({ownerUserId:r.currentUserId,channelUrl:n,filterKey:Te(a),endAt:{"<=":e}});i.limit=Number.MAX_SAFE_INTEGER,i.index={ownerUserId:On.LocalDB.Query.Order.ASC,channelUrl:On.LocalDB.Query.Order.ASC,filterKey:On.LocalDB.Query.Order.ASC,endAt:On.LocalDB.Query.Order.DESC},u.find(i,t)}},this.clearChunkByHistoryOffset=function(a,n,t){var i=On.getInstance(),s=De.getDefaultFilter();if(i.currentUserId){var e=new Promise(function(t,r){var e=new On.LocalDB.Query({ownerUserId:i.currentUserId,channelUrl:n,filterKey:Te(s),endAt:{"<=":a}});e.limit=Number.MAX_SAFE_INTEGER,e.index={ownerUserId:On.LocalDB.Query.Order.ASC,channelUrl:On.LocalDB.Query.Order.ASC,filterKey:On.LocalDB.Query.Order.ASC,endAt:On.LocalDB.Query.Order.DESC},u.removeIf(e,function(e,n){return e?r(e):t(n)})}),r=new Promise(function(t,r){o.getChunkByTimestamp(n,s,a,function(e,n){if(e)return r(e);n&&(n.extendBackward(a),o.upsert(n,function(e,n){if(e)return r(e);t(n)})),t(n)})});Promise.all([e,r]).then(function(e){t(null)}).catch(function(e){t(e)})}},this.getChunkByTimestamp=function(r,e,i,s){var n=On.getInstance();if(n.currentUserId){var t=new On.LocalDB.Query({ownerUserId:n.currentUserId,channelUrl:r,filterKey:Te(e),startAt:{"<=":i},endAt:{">=":i}});t.limit=1,t.index={ownerUserId:On.LocalDB.Query.Order.ASC,channelUrl:On.LocalDB.Query.Order.ASC,filterKey:On.LocalDB.Query.Order.ASC,endAt:On.LocalDB.Query.Order.DESC},u.find(t,function(e,n){if(e)s(e);else{var a=0<n.length?De.createFromJson(n[0]):null;if(a)if(a.hasDefaultFilter())s(null,a);else{var t=new On.LocalDB.Query({channelUrl:r,filterKey:Te(De.getDefaultFilter()),startAt:{"<=":i}});t.limit=1,t.index={ownerUserId:On.LocalDB.Query.Order.ASC,channelUrl:On.LocalDB.Query.Order.ASC,filterKey:On.LocalDB.Query.Order.ASC,endAt:On.LocalDB.Query.Order.DESC},u.find(t,function(e,n){if(e)s(e);else{var t=0<n.length?De.createFromJson(n[0]):null;if(t)if(t.endAt>a.endAt)if(t.isOverlap(a))a.extendWithChunk(t),o.upsert(a,s);else{var r=new De(a.channelUrl,a.filter);r.startAt=t.startAt,r.endAt=t.endAt,o.upsert(r,s)}else s(null,a);else s(null,a)}})}else s(null)}})}else s(pe.create(pe.Type.ERROR_SETUP_MISSING))},this.mergePreviousChunkOverlap=function(r,a){var e=On.getInstance();if(e.currentUserId){var n=new On.LocalDB.Query({ownerUserId:e.currentUserId,chunkId:{"!=":r.chunkId},channelUrl:r.channelUrl,filterKey:r.filterKey,endAt:{">=":r.startAt}});n.limit=1/0,u.find(n,function(e,t){if(e)a(e);else if(0<t.length){var n=new On.LocalDB.Query({chunkId:{"/in":t.map(function(e){return e.chunkId})}});u.removeIf(n,function(e){if(e)a(e);else{for(var n=0;n<t.length;n++)r.extendWithChunk(t[n]);o.upsert(r,a)}})}else o.upsert(r,a)})}else a(pe.create(pe.Type.ERROR_SETUP_MISSING))},this}var Ue={},De=function(){function t(e,n){g(this,t),this.chunkId=Ee(),this.channelUrl=e,this.filterKey=Te(n),this.filter=n,this.startAt=(new Date).getTime(),this.endAt=0}return c(t,[{key:"hasDefaultFilter",value:function(){var e=t.getDefaultFilter();return function n(t,r){var e=d(t),a=d(r);return!t||!r||"object"!==e||e!==a||t instanceof Date?t instanceof Date?t.getTime()===r.getTime():"function"===e&&"function"===a||t===r:Object.keys(t).length===Object.keys(r).length&&Object.keys(t).every(function(e){return n(t[e],r[e])})}(this.filter,e)}},{key:"isOverlap",value:function(e){return e.startAt<=this.startAt&&this.startAt<=e.endAt||e.startAt<=this.endAt&&this.endAt<=e.endAt}},{key:"isSame",value:function(e){return!!e&&(e.startAt===this.startAt&&this.endAt===e.endAt)}},{key:"contains",value:function(e){return this.startAt<=e&&e<=this.endAt}},{key:"containsMessage",value:function(e){return this.contains(e.createdAt)}},{key:"serialize",value:function(){var e=JSON.parse(JSON.stringify(this));return Object.freeze(e)}},{key:"extendForward",value:function(e){this.endAt=Math.max(this.endAt,e)}},{key:"extendBackward",value:function(e){this.startAt=Math.min(this.startAt,e)}},{key:"extendWithChunk",value:function(e){return this.extendForwardWithChunk(e),this.extendBackwardWithChunk(e),this}},{key:"extendForwardWithChunk",value:function(e){return this.extendForward(e.endAt),this}},{key:"extendBackwardWithChunk",value:function(e){return this.extendBackward(e.startAt),this}},{key:"extendWithMessage",value:function(e){return this.extendForwardWithMessage(e),this.extendBackwardWithMessage(e),this}},{key:"extendForwardWithMessage",value:function(e){return this.extendForward(e.createdAt),this}},{key:"extendBackwardWithMessage",value:function(e){return this.extendBackward(e.createdAt),this}}],[{key:"createFromJson",value:function(e){var n=new t(e.channelUrl,e.filter);return n.chunkId=e.chunkId,n.startAt=e.startAt,n.endAt=e.endAt,n}},{key:"getDefaultFilter",value:function(){return{messageTypeFilter:null,customTypeFilter:null,senderUserIdsFilter:[],includeMetaArray:!0}}},{key:"MessageTypeFilterRealValue",get:function(){return["","user","file","admin"]}}]),t}();function Ne(e,n,t){return t?n.channelUrl===e.url&&((!t.messageType||t.messageType===n.messageType)&&((!t.customType||t.customType===n.customType)&&!(Array.isArray(t.senderUserIdsFilter)&&0<t.senderUserIdsFilter.length&&n.sender&&t.senderUserIdsFilter.indexOf(n.sender.userId)<0))):n.channelUrl===e.url}function xe(){var t={},o=[];return this.removeChannel=function(e){for(var n in o){var t=o[n];t.controller.channel.url===e.url&&t.view.channelWasRemoved(e)}},this.updateChannel=function(s){for(var e in o){var n=o[e];n.controller.channel.url===s.url&&n.view.channelWasUpdated(s)}(!t.hasOwnProperty(s.url)||s.messageOffsetTimestamp>t[s.url])&&(t[s.url]=s.messageOffsetTimestamp,t[s.url]&&(ze.getInstance().chunkContainer.clearChunkByHistoryOffset(s.messageOffsetTimestamp,s.url,function(e){e&&me.error("Error while clearing message chunk history",e)}),ze.getInstance().messageContainer.loadMessagesByHistoryOffset(s.messageOffsetTimestamp,s.url,function(e,n){if(!e){ze.getInstance().messageContainer.clearMessagesByHistoryOffset(s.messageOffsetTimestamp,s.url,function(e,n){e&&me.error("Error while clearing chat history",e)});var t=n.filter(function(e){return e.hasOwnProperty("requestState")&&"failed"===e.requestState}).map(function(e){return e.reqId}),r=n.filter(function(e){return e.hasOwnProperty("requestState")&&"succeeded"===e.requestState}).map(function(e){return e.messageId});if(0<r.length||0<t.length)for(var a in o){var i=o[a];i.controller.channel.url===s.url&&(0<r.length&&i.view.removeViewItems(r),0<t.length&&i.view.removeViewItems(t,{isRequestId:!0}))}}})))},this.addCollection=function(e,n){o.push({controller:e,view:n}),e.hasOwnProperty("channel")&&e.channel.hasOwnProperty("url")&&(!t.hasOwnProperty(e.channel.url)||e.channel.messageOffsetTimestamp>t[e.channel.url])&&(t[e.channel.url]=e.channel.messageOffsetTimestamp)},this.removeCollection=function(e){var n=o.map(function(e){return e.controller}).indexOf(e);0<=n&&(o[n].controller._pause(),o.splice(n,1))},this.clearCollection=function(){for(var e in o)o[e].controller._pause();o=[]},this.pause=function(){for(var e in o)o[e].controller._pause()},this.resume=function(n){var t=o.length,r=null;for(var e in o)o[e].controller._resume(function(e){r=e||r,--t<=0&&n(r)})},this.upsert=function(e,n){if(0<e.length)for(var t in o){var r=o[t];if(r.controller!==n){var a=[];for(var i in e){var s=e[i];Ne(r.controller.channel,s,r.controller.filter)&&a.push(s)}0<a.length&&r.view.addViewItems(a,{isEventMessage:!0,direction:"next"})}}},this.update=function(e,n){if(0<e.length)for(var t in o){var r=o[t];if(r.controller!==n){var a=[];for(var i in e){var s=e[i];Ne(r.controller.channel,s,r.controller.filter)&&0<=r.view.messages.map(function(e){return e.messageId}).indexOf(s.messageId)&&a.push(s)}0<a.length&&r.view.addViewItems(a,{isEventMessage:!0,direction:"next"})}}},this.read=function(e,n){for(var t in o){var r=o[t];r.controller!==n&&r.controller.channel.url===e.url&&(r.controller.channel=e,r.view.addViewItems(r.view.messages))}},this.remove=function(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(0<e.length)for(var r in o){var a=o[r];a.controller!==n&&a.view.removeViewItems(e,t)}},this.clear=function(){for(var e in t={},o){o[e].view.clearViewItem()}},this.updateCurrentChunk=function(e){for(var n in o){o[n].view.updateCurrentChunk(e)}},this}function Fe(){this.onChannelEvent=function(e,n){}}function qe(){this.onPendingMessageEvent=function(e,n){},this.onFailedMessageEvent=function(e,n,t){},this.onSucceededMessageEvent=function(e,n){},this.onNewMessage=function(e){},this.onMessageEvent=function(e,n){},this.onChannelRemoved=function(e){},this.onChannelUpdated=function(e){}}var Pe={INSERT:"insert",UPDATE:"update",MOVE:"move",REMOVE:"remove",CLEAR:"clear"},Le={INSERT:"insert",UPDATE:"update",REMOVE:"remove",CLEAR:"clear"},Be={NONE:"none",UPDATE_RESEND_FAILED:"update_resend_failed",REMOVE_RESEND_SUCCEEDED:"remove_resend_succeeded",REMOVE_RETENTION_EXPIRED:"remove_retention_expired",REMOVE_EXCEEDED_MAX_COUNT:"remove_exceeded_max_count",REMOVE_MANUAL_ACTION:"remove_manual_action",REMOVE_UNKNOWN:"remove_unknown"},Ve=function(){function a(e){var n=this,t=e.channelUrl;g(this,a),this._resendingTimer=null;var r=!1;Object.defineProperty(this,"_isRunning",{get:function(){return r},set:function(e){r!==(r=e)&&n._toggleResendingInterval()}}),this._clear(),this.collectionReferenceCount=1,this._channelUrl=t}return c(a,[{key:"_clear",value:function(e){var n=0<arguments.length&&void 0!==e?e:{noManualMessages:!1};this._retryCount=0,this._delayTime=0,this._isRunning=!1,n.noManualMessages||(this.manualMessages=[]),this.automaticMessages=[],clearTimeout(this._resendingTimer),this._resendingTimer=null}},{key:"_appendMessagesWithOrder",value:function(e,n){var i=this,t=1<arguments.length&&void 0!==n?n:{},s=t.hasOwnProperty("isAutomatic")?t.isAutomatic:On.syncManagerOptions.messageResendPolicy===On.Options.MessageResendPolicy.AUTOMATIC;e.forEach(function(e){for(var n=s?i.automaticMessages.length:i.manualMessages.length,t=n,r=0;r<n;r++){var a=s?i.automaticMessages[r]:i.manualMessages[r];if(e.createdAt<a.createdAt){t=r;break}}s?i.automaticMessages.splice(t,0,e):i.manualMessages.splice(t,0,e)})}},{key:"appendMessages",value:function(r){for(var a=this,e=0===this.automaticMessages.length,i=On.syncManagerOptions.messageResendPolicy===On.Options.MessageResendPolicy.AUTOMATIC,n=r.length,s=[],t=function(e){var n=r[e];!1;var t=[];i&&(t=a.automaticMessages),0<[].concat(z(t),z(a.manualMessages)).filter(function(e){return e.reqId===n.reqId}).length||s.push(n)},o=0;o<n;o++)t(o);this._appendMessagesWithOrder(s),e&&0<this.automaticMessages.length&&this._resendUserMessage()}},{key:"removeMessages",value:function(t){for(var r=this,a=On.syncManagerOptions.messageResendPolicy===On.Options.MessageResendPolicy.AUTOMATIC,e=t.length,i=!1,n=function(e){var n=t[e];i=!1,a&&(r.automaticMessages=r.automaticMessages.filter(function(e){return e.reqId!==n.reqId||!(i=!0)})),i||(r.manualMessages=r.manualMessages.filter(function(e){return e.reqId!==n.reqId}))},s=0;s<e;s++)n(s)}},{key:"_resendUserMessage",value:function(){var u=this;if(this._retryCount++,On.syncManagerOptions.automaticMessageResendRetryCount!==On.Options.INFINITY&&this._retryCount>On.syncManagerOptions.automaticMessageResendRetryCount)return this._appendMessagesWithOrder(this.automaticMessages,{isAutomatic:!1}),this.automaticMessages=[],Qe.getInstance().upsertMessages(this._channelUrl,this.manualMessages),void this._clear({noManualMessages:!0});this._resendingTimer=setTimeout(function(){var i=u.automaticMessages[0];if(i&&u._isRunning){var s=ze.getInstance(),e=s.sb,o=e.getErrorFirstCallback();e.GroupChannel.getChannel(u._channelUrl,function(e,n){if(o){var t=n;n=e,e=t}n?(u._increaseDelayTime(),u._resendUserMessage()):e.resendUserMessage(i,function(e,n){if(o){var t=n;n=e,e=t}if(n){if(800110===n.code){var r={reason:Be.REMOVE_UNKNOWN};Qe.getInstance().removeMessages(u._channelUrl,[i],r),u.removeMessages([i])}else u._increaseDelayTime();u._resendUserMessage()}else{u.removeMessages([i]),u._retryCount=0,u._delayTime=0;var a={reason:Be.REMOVE_RESEND_SUCCEEDED};Qe.getInstance().removeMessages(u._channelUrl,[i],a),s.messageContainer.upsert(e,function(e,n){e||s.broadcast.upsert([n]),u._resendUserMessage()})}})})}else u._retryCount=0,u._delayTime=0},this._delayTime)}},{key:"_increaseDelayTime",value:function(){this._delayTime=1e4===this._delayTime?this._delayTime:this._delayTime+2e3}},{key:"_toggleResendingInterval",value:function(){this._isRunning?this._resendUserMessage():(clearTimeout(this._resendingTimer),this._resendingTimer=null,this._retryCount=0,this._delayTime=0)}},{key:"resumeResending",value:function(){me.call("FailedMessageQueue resumeResending()"),this._retryCount=0,this._delayTime=0,this._isRunning=!0}},{key:"pauseResending",value:function(){me.call("FailedMessageQueue pauseResending()"),this._isRunning=!1}},{key:"increaseCount",value:function(){++this.collectionReferenceCount}},{key:"decreaseCount",value:function(){--this.collectionReferenceCount,0===this.collectionReferenceCount&&this._clear()}}]),a}(),je=function(){function o(e){var n=e.msec,t=void 0===n?0:n,r=e.isEternal,a=void 0===r||r,i=e.timeoutFn,s=void 0===i?function(){}:i;g(this,o),this.time=t,this.isEternal=a,this.timeoutFn=s,this.checker=null}return c(o,[{key:"reset",value:function(){this.stop(),this.time=0,this.timeoutFn=function(){}}},{key:"start",value:function(){var e=this;if(null===this.checker){var n=(new Date).getTime();this.checker=setTimeout(function(){(new Date).getTime()-n>=e.time&&(e.isEternal?e.start():e.stop(),e.timeoutFn&&"function"==typeof e.timeoutFn&&e.timeoutFn())},432e5)}}},{key:"stop",value:function(){clearTimeout(this.checker),this.checker=null}}]),o}(),Ge=null,Qe=function(){function e(){if(g(this,e),Ge)return Ge;this.queueMap={},this.expirationTimer=new je({msec:864e5*On.syncManagerOptions.failedMessageRetentionDays,isEternal:!0,timeoutFn:this.removeExpiredMessages}),this.oldestFailedMessageTs=0,Ge=this}return c(e,[{key:"getMessages",value:function(e){return this.queueMap[e]?this.queueMap[e].messages:[]}},{key:"loadFailedMessages",value:function(a,i,s){var o=this;ze.getInstance().messageContainer.loadFailedMessages(a,{},{},function(e,n){var t=n;if(!e){me.cache("fetch failed message",n.map(function(e){return e.reqId}));var r=o.queueMap[a];r&&(r.appendMessages(n),r.resumeResending()),t=n.filter(function(e){var n=!0,t=!0,r=!0;if(i.messageTypeFilter&&(n=e.messageType===De.MessageTypeFilterRealValue[i.messageTypeFilter]),i.customTypeFilter&&(t=e.customType===i.customTypeFilter),i.senderUserIdsFilter&&Array.isArray(i.senderUserIdsFilter)&&0<i.senderUserIdsFilter.length&&(r=e.sender&&-1<i.senderUserIdsFilter.indexOf(e.sender.userId)),n&&t&&r)return e})}s(e,t)})}},{key:"removeExpiredMessages",value:function(t){var a=this;this.expirationTimer.stop();var e=Math.floor(((new Date).getTime()-this.oldestFailedMessageTs)/864e5);if(0!==this.oldestFailedMessageTs&&e<On.syncManagerOptions.failedMessageRetentionDays)return this.expirationTimer.start(),void(t&&t());var i=ze.getInstance(),n=On.syncManagerOptions.failedMessageRetentionDays;i.messageContainer.removeExpiredMessages(n,function(e,n){if(e)return me.error("Fail remove expired failedMessage by failedMessageRetentionDays:",e),a.expirationTimer.start(),void(t&&t());var r={};n.forEach(function(e){var n=e.channelUrl;r[n]&&Array.isArray(r[n])||(r[n]=[]),r[n].push(e)}),Object.keys(r).forEach(function(e){var n=r[e].map(function(e){return e.reqId}),t={isRequestId:!0,reason:Be.REMOVE_RETENTION_EXPIRED};i.broadcast.remove(n,{},t),a.queueMap.hasOwnProperty(e)&&a.queueMap[e].removeMessages(r[e])}),i.messageContainer.loadOldestFailedMessages(function(e,n){e?(me.error("Fail get oldestFailedMessage from DB: ",e),a.oldestFailedMessageTs=0):a.oldestFailedMessageTs=0<n.length?n[0].createdAt:(new Date).getTime(),a.expirationTimer.start(),t&&t()})})}},{key:"removeExceedingMaxCount",value:function(e){var a=this,i=ze.getInstance(),r=new On.LocalDB.Query({ownerUserId:On.getInstance().currentUserId,channelUrl:e,requestState:"failed"});r.limit=Number.MAX_SAFE_INTEGER,r.index={ownerUserId:On.LocalDB.Query.Order.ASC,createdAt:On.LocalDB.Query.Order.ASC},i.messageContainer.count(r,function(e,n){if(e)me.error("Get count about failedMessage by maxFailedMessageCountPerChannel:",e);else{var t=On.syncManagerOptions.maxFailedMessageCountPerChannel;t<n&&(r.limit=n-t,i.messageContainer.find(r,function(e,n){var r={isRequestId:!0,reason:Be.REMOVE_EXCEEDED_MAX_COUNT};n.forEach(function(n){var t=n.reqId;i.messageContainer.removeUnsent(t,function(e){e&&me.error("Fail remove count failedMessage by maxFailedMessageCountPerChannel:",e),i.broadcast.remove([t],{},r),a.queueMap[n.channelUrl].removeMessages([n])})})}))}})}},{key:"upsertMessages",value:function(r,e){var a=this,i=ze.getInstance(),s=this.queueMap[r];e.forEach(function(t){i.messageContainer.upsert(t,function(e,n){e||i.broadcast.upsert([n]),s&&s.appendMessages([t]),a.removeExceedingMaxCount(r)})})}},{key:"removeMessages",value:function(e,n,t){var r=ze.getInstance(),a=this.queueMap[e];n.forEach(function(n){n.reqId&&r.messageContainer.removeUnsent(n.reqId,function(e){e?me.error("deleteMessage()","Failed to delete message from cache: ".concat(n)):(t.isRequestId=!0,r.broadcast.remove([n.reqId],{},t),a&&a.removeMessages([n]))})})}},{key:"resume",value:function(){var e=this;me.call("FailedMessageDispatcher resume()"),this.removeExpiredMessages(function(){e.resumeAllQueues()})}},{key:"pause",value:function(){me.call("FailedMessageDispatcher pause()"),this.pauseAllQueues(),this.expirationTimer.stop()}},{key:"resumeAllQueues",value:function(){var t=this;Object.keys(this.queueMap).forEach(function(e){var n=t.queueMap[e];n&&n.resumeResending()})}},{key:"pauseAllQueues",value:function(){var t=this;Object.keys(this.queueMap).forEach(function(e){var n=t.queueMap[e];n&&n.pauseResending()})}},{key:"createQueue",value:function(e){var n=this.queueMap[e];n?n.increaseCount():this.queueMap[e]=new Ve({channelUrl:e}),this.queueMap[e].resumeResending()}},{key:"removeQueue",value:function(e){var n=this.queueMap[e];n&&(n.decreaseCount(),0===n.collectionReferenceCount&&delete this.queueMap[e])}}],[{key:"getInstance",value:function(){return new e}}]),e}();"undefined"==typeof Promise&&(Promise=e);var He="last-changeLog-token-",Ke="syncManager_messageManager_channelHandler_"+(new Date).getTime(),We=null,ze=function(){function i(e){var n=e.sendBird,t=e.db;if(g(this,i),!We){me.call("MessageManager()"),(We=this).sb=n;var r=this.sb;this.messageContainer=new Se(t,r),this.chunkContainer=new Re(t),this.broadcast=new xe,this.isFetchingChangeLogByChannelUrl={};var a=new r.ChannelHandler;Object.keys(a).forEach(function(s){a[s]=function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];switch(s){case"onMessageReceived":me.event(s,n[0].url,n[1].messageId,n[1].createdAt,n[1].message),n[1].isVisible=!0,We.messageContainer.upsert(n[1],function(e,n){e?pe.throw(e):We.broadcast.upsert([n])});break;case"onReadReceiptUpdated":me.event(s,n[0].url);var r=n[0];We.broadcast.read(r);break;case"onMessageUpdated":me.event(s,n[0].url,n[1].messageId,n[1].createdAt,n[1].message),n[1].isVisible=!1,We.messageContainer.upsert(n[1],function(e,n){e?pe.throw(e):We.broadcast.update([n])});break;case"onMessageDeleted":var a=n[0],i=n[1];We.messageContainer.getItem(i,function(e,r){e?pe.throw(e):(me.event(s,a.url,r.messageId,r.createdAt),We.messageContainer.remove(i,function(e,n){if(e)pe.throw(e);else{var t=De.getDefaultFilter();We.chunkContainer.getChunkByTimestamp(a.url,t,r.createdAt,function(e,t){if(!e&&t){var n=new On.LocalDB.Query({ownerUserId:On.getInstance().currentUserId,channelUrl:a.url,requestState:"succeeded",createdAt:{"<":r.createdAt}});n.index={ownerUserId:On.LocalDB.Query.Order.ASC,createdAt:On.LocalDB.Query.Order.ASC},n.desc=!0,n.limit=1,We.messageContainer.find(n,function(e,n){e||(n&&0!==n.length?(t.endAt=n[0].createdAt,We.chunkContainer.upsert(t,function(e,n){e||We.broadcast.updateCurrentChunk(n)})):We.chunkContainer.remove(t.chunkId,function(e){e||We.broadcast.updateCurrentChunk(null)}))})}}),We.broadcast.remove([parseInt(n)])}}))})}}}),r.addChannelHandler(Ke,a)}return We}return c(i,[{key:"syncChangeLog",value:function(r,e){var a=this,i=1<arguments.length&&void 0!==e?e:function(){};if(this.isFetchingChangeLogByChannelUrl[r.url])i(pe.create(pe.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLogByChannelUrl[r.url]=!0,me.call("message syncChangeLog()",r.url);var s="".concat(He).concat(r.url);fe.get(s).then(function(e){var n="getMessageChangeLogsByToken",t=[];e?(n="getMessageChangeLogsByToken",t.unshift(e)):(n="getMessageChangeLogsByTimestamp",t.unshift((new Date).getTime()-100)),me.call(n),r[n].apply(r,t.concat([function(e,n){if(a.sb.getErrorFirstCallback()){var t=e;e=n,n=t}n?a.isFetchingChangeLogByChannelUrl[r.url]=!1:(me.sync("updated",e.updatedMessages.map(function(e){return e.messageId})),me.sync("deleted",e.deletedMessageIds),e.updatedMessages.forEach(function(r){We.messageContainer.getItemWithVisibility(r.messageId,function(e,n){if(!e){var t=n.item;r.isVisible=n.isVisible||!1,We.messageContainer.upsert(r,function(e,n){e?pe.throw(e):t&&t.isEqual(n)||We.broadcast.update([n])})}})}),e.deletedMessageIds.forEach(function(n){We.messageContainer.remove(n,function(e){e?pe.throw(e):We.broadcast.remove([n])})}),fe.set(s,e.token).then(function(){e.hasMore?a.syncChangeLog(r,i):(a.isFetchingChangeLogByChannelUrl[r.url]=!1,i())}).catch(function(e){a.isFetchingChangeLogByChannelUrl[r.url]=!1,i(e)}))}]))}).catch(function(e){a.isFetchingChangeLogByChannelUrl[r.url]=!1,i(e)})}}},{key:"start",value:function(){We.broadcast.resume(function(e){e||Qe.getInstance().resume()})}},{key:"stop",value:function(){We.broadcast.pause(),Qe.getInstance().pause()}},{key:"clearCache",value:function(t){We.messageContainer.clear(function(){We.chunkContainer.clear(function(){fe.getKeys().then(function(e){var n=[];e.forEach(function(e){e.startsWith(He)&&n.push(fe.remove(e))}),Promise.all(n).then(function(){return t()}).catch(function(e){me.error(e),t(e)})}).catch(function(e){return t(e)})})})}},{key:"reset",value:function(e){We?(We.broadcast.clear(),We.clearCache(e)):e(null)}}],[{key:"getInstance",value:function(){return We}},{key:"clear",value:function(){We&&We.sb&&(me.message("MessageManager is cleared"),We.broadcast.clearCollection(),We.sb.removeChannelHandler(Ke),We=null)}}]),i}();function Je(e,n){var t=tn.getInstance().sb,r=!0;if(e.isGroupChannel()&&!e.isSuper){if(!n.includeEmpty&&!e.lastMessage)return!1;if(n.nicknameContainsFilter){var a=!1;for(var i in e.members)if(0<=e.members[i].nickname.indexOf(n.nicknameContainsFilter)){a=!0;break}if(!a)return!1}if(n.userIdsFilter&&Array.isArray(n.userIdsFilter)&&0<n.userIdsFilter.length){var s=!1,o=e.members.map(function(e){return e.userId}),u=n.userIdsFilterExactMatch,c=n.queryType;if(u?s=o.length===n.userIdsFilter.length&&n.userIdsFilter.every(function(e){return 0<=o.indexOf(e)}):"AND"===c?s=n.userIdsFilter.every(function(e){return 0<=o.indexOf(e)}):"OR"===c&&(s=n.userIdsFilter.reduce(function(e,n){return e||0<=o.indexOf(n)},!1)),!s)return!1}}if(n.channelNameContainsFilter&&(r=r&&0<=e.name.indexOf(n.channelNameContainsFilter)),0<n.channelUrlsFilter.length&&(r=r&&0<=n.channelUrlsFilter.indexOf(e.url)),n.memberStateFilter!==t.GroupChannel.MemberStateFilter.ALL)switch(n.memberStateFilter){case t.GroupChannel.MemberStateFilter.JOINED:r=r&&"joined"===e.myMemberState&&"joined_only"===t.GroupChannel.MemberStateFilter.JOINED;break;case t.GroupChannel.MemberStateFilter.INVITED:case t.GroupChannel.MemberStateFilter.INVITED_BY_FRIEND:case t.GroupChannel.MemberStateFilter.INVITED_BY_NON_FRIEND:r=r&&"invited"===e.myMemberState&&("invited_only"===t.GroupChannel.MemberStateFilter.INVITED||"invited_by_friend"===t.GroupChannel.MemberStateFilter.INVITED||"invited_by_non_friend"===t.GroupChannel.MemberStateFilter.INVITED)}if(0<n.customTypesFilter.length&&(r=r&&0<=n.customTypesFilter.indexOf(e.customType)),n.customTypeStartsWithFilter&&(r=r&&e.customType.startsWith(n.customTypeStartsWithFilter)),n.superChannelFilter!==t.GroupChannel.SuperChannelFilter.ALL)switch(n.superChannelFilter){case t.GroupChannel.SuperChannelFilter.SUPER:r=r&&e.isSuper;break;case t.GroupChannel.SuperChannelFilter.NONSUPER:r=r&&!e.isSuper}if(n.publicChannelFilter!==t.GroupChannel.PublicChannelFilter.ALL)switch(n.publicChannelFilter){case t.GroupChannel.PublicChannelFilter.PUBLIC:r=r&&e.isPublic;break;case t.GroupChannel.PublicChannelFilter.PRIVATE:r=r&&!e.isPublic}if(n.unreadChannelFilter!=t.GroupChannel.UnreadChannelFilter.ALL)switch(n.unreadChannelFilter){case t.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:r=r&&0<e.unreadMessageCount}return r}function Xe(){var h=[];return this.addCollection=function(e,n){h.indexOf(e)<0&&h.push({controller:e,view:n})},this.removeCollection=function(e){var n=h.map(function(e){return e.controller}).indexOf(e);0<=n&&(h[n].controller._pause(),h.splice(n,1))},this.clearCollection=function(){for(var e in h)h[e].controller._pause();h=[]},this.pause=function(){for(var e in h)h[e].controller._pause()},this.resume=function(){for(var e in h)h[e].controller._resume()},this.upsert=function(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(0<e.length)for(var r in h){var a=h[r];if(a.controller!==n){var i=[];for(var s in e){var o=e[s];Je(o,a.controller.query)&&i.push(o)}0<i.length&&(t.isEventChannel=!0,a.view.addViewItems(i,t))}}},this.update=function(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(0<e.length){for(var r in e){var a=e[r];ze.getInstance().broadcast.updateChannel(a)}for(var i in h){var s=h[i];if(s.controller!==n){var o=[];for(var u in e){var c=e[u];Je(c,s.controller.query)&&0<=s.view.channels.map(function(e){return e.url}).indexOf(c.url)&&o.push(c)}0<o.length&&(t.isEventChannel=!0,s.view.addViewItems(o,t))}}}},this.remove=function(e,n){if(0<e.length){for(var t in e){var r=e[t];ze.getInstance().broadcast.removeChannel(r)}for(var a in h){var i=h[a];if(i.controller!==n){var s=[];for(var o in e){var u=e[o];0<=i.view.channels.map(function(e){return e.url}).indexOf(u.url)&&s.push(u)}0<s.length&&i.view.removeViewItems(s)}}}},this.hide=function(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};for(var r in e){var a=e[r];ze.getInstance().broadcast.updateChannel(a)}if(0<e.length){var i=tn.getInstance().sb;for(var s in h){var o=h[s];if(o.controller!==n){var u=[];for(var c in e){var l=e[c];Je(l,o.controller.query)&&u.push(l)}if(0<u.length)switch(o.controller.query.hiddenChannelFilter){case i.GroupChannel.HiddenChannelFilter.UNHIDDEN:o.view.removeViewItems(u);break;case i.GroupChannel.HiddenChannelFilter.HIDDEN:case i.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case i.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:t.isEventChannel=!0,o.view.addViewItems(u,t)}}}}},this.unhide=function(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};for(var r in e){var a=e[r];ze.getInstance().broadcast.updateChannel(a)}if(0<e.length){var i=tn.getInstance().sb;for(var s in h){var o=h[s];if(o.controller!==n){var u=[];for(var c in e){var l=e[c];Je(l,o.controller.query)&&u.push(l)}if(0<u.length)switch(o.controller.query.hiddenChannelFilter){case i.GroupChannel.HiddenChannelFilter.UNHIDDEN:t.isEventChannel=!0,o.view.addViewItems(u,t);break;case i.GroupChannel.HiddenChannelFilter.HIDDEN:case i.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case i.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:o.view.removeViewItems(u)}}}}},this.clear=function(){for(var e in h){h[e].view.clearViewItem()}},this}"undefined"==typeof Promise&&(Promise=e);function Ye(o){var u=tn.getInstance();if(u){var c=o.query,e=c.filterKey;return u.channelSyncByFilter[e]||(u.channelSyncByFilter[e]=new an(function(e,s){me.call("channel syncChannel()",c.filterKey,c.hasNext,c._token),c.hasNext?(c.limit=100,c.next(function(i,e){if(u.sb.getErrorFirstCallback()){var n=[i,e];e=n[0],i=n[1]}me.sync("channel",e,i&&0<i.length?"\n"+i.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n"):""),e?s(e):function(){for(var t=on.get(o),r=0,a=null,e=0;e<i.length;e++)u.channelContainer.insert(i[e],function(e){if(a=a||e,++r===i.length)if(a)s(a);else{var n=t.findChannelEdges(i);n.end&&(c.savepoint=n.end+""),u.queryContainer.upsert(c,function(e){e?s(e):s(null,{count:i.length,nextTs:0,hasMore:c.hasNext})})}});0===i.length&&s(null,{count:0,nextTs:0,hasMore:!1})}()})):s(null,{count:0,nextTs:0,hasMore:!1})})),u.channelSyncByFilter[e]}return null}function Ze(e){var t=tn.getInstance();if(t){if(!t.changeLogSync){var r=e.query;t.changeLogSync=new an(function(e,n){t.syncChangeLog(r,function(e){n(e,{count:0,nextTs:0,hasMore:!1})})})}return t.changeLogSync}return null}var $e="channel-changeLog-token",en="syncManager_channelManager_channelHandler_"+(new Date).getTime(),nn=null,tn=function(){function a(e){var n=e.sendBird,t=e.db;if(g(this,a),!nn){me.call("ChannelManager()");var u=(nn=this).sb=n,c=On.getInstance();this.channelContainer=new ue(t,u),this.queryContainer=new ce(t,u),this.broadcast=new Xe,this.isFetchingChangeLog=!1,this.channelSyncByFilter={},this.changeLogSync=null;var r=new u.ChannelHandler;Object.keys(r).forEach(function(o){r[o]=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];switch(o){case"onChannelChanged":var r=t[0];me.event(o,r.url),nn.channelContainer.getItem(r.url,function(e,t){e?pe.throw(e):nn.channelContainer.upsert(r,function(e,n){e?pe.throw(e):t?t.hiddenState!==u.GroupChannel.HiddenState.UNHIDDEN&&r.hiddenState===u.GroupChannel.HiddenState.UNHIDDEN?nn.broadcast.unhide([n]):nn.broadcast.update([n]):nn.broadcast.upsert([n])})});break;case"onUserMuted":case"onUserUnmuted":case"onUserUnbanned":case"onChannelFrozen":case"onChannelUnfrozen":case"onMetaDataCreated":case"onMetaDataUpdated":case"onMetaDataDeleted":case"onMetaCountersCreated":case"onMetaCountersUpdated":case"onMetaCountersDeleted":me.event(o,t[0].url),nn.channelContainer.upsert(t[0],function(e,n){e?pe.throw(e):nn.broadcast.update([n])});break;case"onUserReceivedInvitation":case"onUserJoined":me.event(o,t[0].url),nn.channelContainer.upsert(t[0],function(e,n){e?pe.throw(e):t[1].userId===c.currentUserId?nn.broadcast.upsert([n]):nn.broadcast.update([n])});break;case"onReadReceiptUpdated":nn.channelContainer.upsert(t[0],function(e){e&&pe.throw(e)});break;case"onMessageReceived":t[0].lastMessage&&t[0].lastMessage.messageId!==t[1].messageId||nn.channelContainer.upsert(t[0],function(e,n){e?pe.throw(e):nn.broadcast.upsert([n])});break;case"onChannelHidden":me.event(o,t[0].url);var a=t[0];nn.channelContainer.upsert(a,function(e){e?pe.throw(e):nn.broadcast.hide([a])});break;case"onUserLeft":case"onUserBanned":me.event(o,t[0].url);var i=t[0];t[1].userId===c.currentUserId?nn.channelContainer.remove(i,function(e){e?pe.throw(e):nn.broadcast.remove([i])}):nn.channelContainer.upsert(i,function(e,n){e?pe.throw(e):nn.broadcast.update([n])});break;case"onUserDeclinedInvitation":me.event(o,t[0].url);var s=t[0];t[2].userId===c.currentUserId?nn.channelContainer.remove(s,function(e){e?pe.throw(e):nn.broadcast.remove([s])}):nn.channelContainer.upsert(s,function(e,n){e?pe.throw(e):nn.broadcast.update([n])});break;case"onChannelDeleted":me.event(o,t[0]),nn.channelContainer.getItem(t[0],function(e,n){e?pe.throw(e):n&&nn.channelContainer.remove(n,function(e){e?pe.throw(e):nn.broadcast.remove([n])})})}}}),u.addChannelHandler(en,r)}return nn}return c(a,[{key:"syncChangeLog",value:function(o,u){var c=this;if(this.isFetchingChangeLog)u(pe.create(pe.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLog=!0,me.call("channel syncChangeLog()");var l="".concat($e);fe.get(l).then(function(e){var n,t="getMyGroupChannelChangeLogsByToken",r=[];r.push([]),r.push(!0),e?(t="getMyGroupChannelChangeLogsByToken",r.unshift(e)):(t="getMyGroupChannelChangeLogsByTimestamp",r.unshift((new Date).getTime()-100)),me.call(t),(n=c.sb)[t].apply(n,r.concat([function(s,e){if(c.sb.getErrorFirstCallback()){var n=s;s=e,e=n}if(e)c.isFetchingChangeLog=!1;else{me.sync("updated",s.updatedChannels&&0<s.updatedChannels.length?"\n"+s.updatedChannels.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n"):[]),me.sync("deleted",s.deletedChannelUrls);var t=[];s.updatedChannels.forEach(function(n){t.push(new Promise(function(o,u){nn.channelContainer.getItem(n.url,function(e,s){e?u(e):nn.channelContainer.upsert(n,function(e,n){if(e)u(e);else{var t=!s||!s.isEqual(n),r=(!s||s.hiddenState===c.sb.GroupChannel.HiddenState.UNHIDDEN)&&n.hiddenState!==c.sb.GroupChannel.HiddenState.UNHIDDEN,a=(!s||s.hiddenState!==c.sb.GroupChannel.HiddenState.UNHIDDEN)&&n.hiddenState===c.sb.GroupChannel.HiddenState.UNHIDDEN,i=t?"update":"noop";r?i="hide":a&&(i="unhide"),o({action:i,channel:n})}})})}))}),s.deletedChannelUrls.forEach(function(e){t.push(new Promise(function(t,r){nn.channelContainer.getItem(e,function(e,n){e?r(e):n&&nn.channelContainer.remove(n,function(e){if(e)r(e);else{t({action:"remove",channel:n})}})})}))}),Promise.all(t).then(function(e){for(var n=[],t=[],r=[],a=[],i=0;i<e.length;i++)switch(e[i].action){case"update":n.push(e[i].channel);break;case"remove":t.push(e[i].channel);break;case"hide":r.push(e[i].channel);break;case"unhide":a.push(e[i].channel)}0<n.length&&nn.broadcast.upsert(n,null,{isChangeLogChannel:!0}),0<t.length&&nn.broadcast.remove(t),0<r.length&&nn.broadcast.hide(r,null,{isChangeLogChannel:!0}),0<a.length&&nn.broadcast.unhide(a,null,{isChangeLogChannel:!0}),fe.set(l,s.token).then(function(){s.hasMore?c.syncChangeLog(o,u):(c.isFetchingChangeLog=!1,u())}).catch(function(e){c.isFetchingChangeLog=!1,u(e)})}).catch(function(e){return u(e)})}}]))}).catch(function(e){c.isFetchingChangeLog=!1,u(e)})}}},{key:"start",value:function(){nn.broadcast.resume()}},{key:"stop",value:function(){nn.broadcast.pause()}},{key:"clearCache",value:function(t){nn.channelSyncByFilter={},nn.changeLogSync=null,nn.channelContainer.clear(function(){nn.queryContainer.clear(function(){fe.getKeys().then(function(e){var n=[];e.forEach(function(e){e.startsWith($e)&&n.push(fe.remove(e))}),Promise.all(n).then(function(){return t()}).catch(function(e){me.error(e),t(e)})}).catch(function(e){return t(e)})})})}},{key:"reset",value:function(e){nn?(nn.broadcast.clear(),nn.clearCache(e)):e(null)}}],[{key:"getInstance",value:function(){return nn}},{key:"clear",value:function(){nn&&nn.sb&&(me.message("ChannelManager is cleared"),nn.channelSyncByFilter={},nn.changeLogSync=null,nn.broadcast.clearCollection(),nn.sb.removeChannelHandler(en),nn=null)}}]),a}(),rn=function(){function e(){g(this,e),this._queue=[],this.locked=!1}return c(e,[{key:"lock",value:function(e){var n=this;this.locked?this._queue.push(e):(this.locked=!0,e(function(){return n.unlock()}))}},{key:"unlock",value:function(){if(this.locked=!1,0<this._queue.length){var e=this._queue.shift();this.lock(e)}}}]),e}(),an=function(){function a(e){g(this,a),this.worker=e,this.state=a.State.PAUSED,this.isLoading=!1,this.shared=0,this.retry=0,this.retryLimit=3,this.subscribes={}}return c(a,[{key:"start",value:function(t,e){var r=this;!(1<arguments.length&&void 0!==e&&e)&&this.state===a.State.END||this.isLoading||(this.isLoading=!0,this.state=a.State.RUNNING,this.worker(t,function(e,n){me.sync("background sync result: err=",e,"res=",n),r.isRunning&&(e?r.retry<r.retryLimit?(r.retry++,setTimeout(function(){return r.start(t)},500)):r.state=a.State.PAUSED:(r.retry=0,r.flush(e,n),n.hasMore?setTimeout(function(){r.isRunning&&r.start(n.nextTs)},100):r.state=a.State.END)),r.isLoading=!1}))}},{key:"pause",value:function(){this.isLoading=!1,this.state=a.State.PAUSED}},{key:"end",value:function(){this.isLoading=!1,this.state=a.State.END}},{key:"flush",value:function(e,n){var t=0<arguments.length&&void 0!==e?e:null,r=1<arguments.length?n:void 0;for(var a in me.sync("background sync flush: ".concat(Object.keys(this.subscribes).length," subscribes")),this.subscribes)this.subscribes[a](t,r);this.subscribes={}}},{key:"subscribe",value:function(e,n){return!this.subscribes[e]&&(this.subscribes[e]=n,!0)}},{key:"unsubscribeAll",value:function(){this.subscribes={}}},{key:"isRunning",get:function(){return this.state===a.State.RUNNING}}],[{key:"State",get:function(){return{RUNNING:"running",PAUSED:"paused",END:"end"}}}]),a}(),sn="channel-collection-handler",on=new U,un=new U,cn=function(){function e(){g(this,e),this.collection=null,this.channels=[],this.mutex=new rn,this.viewOffset=null}return c(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"compareWithChannel",value:function(e,n){var t="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":t="createdAt";break;case"channel_name_alphabetical":t="name"}return this.compareWithOffset(e,n[t])}},{key:"compareWithOffset",value:function(e,n){switch(this.collection.query.order){case"latest_last_message":return e.lastMessageUpdatedAt-n;case"chronological":return e.createdAt-n;case"channel_name_alphabetical":return n.localeCompare(e.name);default:return e.lastMessageUpdatedAt-n}}},{key:"isAbove",value:function(e,n){return 0<this.compareWithOffset(e,n)}},{key:"isBelow",value:function(e,n){return this.compareWithOffset(e,n)<0}},{key:"findChannelEdges",value:function(e){var n="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":n="createdAt";break;case"channel_name_alphabetical":n="name"}var t={start:null,end:null};for(var r in e)t.start&&!this.isAbove(e[r],t.start)||(t.start=e[r][n]),t.end&&!this.isBelow(e[r],t.end)||(t.end=e[r][n]);return t}},{key:"refreshViewOffset",value:function(){var e=this.findChannelEdges(this.channels);this.viewOffset=e.end}},{key:"addViewItems",value:function(d,e){var g=this,v=1<arguments.length&&void 0!==e?e:{},y=[],m=[],p=[],k=[],I=un.get(this.collection);this.mutex.lock(function(e){for(var n in d){var t=d[n],r=Ie(t,g.channels),a=be(t,g.collection.query,g.channels),i=!1;if(v.isEventChannel)if(g.viewOffset)g.isBelow(t,g.viewOffset)&&(i=!0);else{var s=Ye(g.collection),o=Ze(g.collection);s.state!==an.State.RUNNING&&o.state!==an.State.RUNNING||!g.collection.query.hasNext||(i=!0)}var u=r<0?Pe.INSERT:Pe.UPDATE;switch(r<0?i||(a<g.channels.length?g.channels.splice(a,0,t):g.channels.push(t)):r!==a?a<g.channels.length?(u=Pe.MOVE,g.channels.splice(r,1),r<a?g.channels.splice(a-1,0,t):g.channels.splice(a,0,t)):(u=Pe.REMOVE,g.channels.splice(r,1)):g.channels[r]=t,u){case Pe.INSERT:i||y.push(t);break;case Pe.UPDATE:m.push(t);break;case Pe.MOVE:p.push(t);break;case Pe.REMOVE:k.push(t)}}if(g.refreshViewOffset(),0<y.length)for(var c in me.view("channel",Pe.INSERT,"\n"+y.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),I)I[c].onChannelEvent(Pe.INSERT,y);if(0<m.length)for(var l in me.view("channel",Pe.UPDATE,"\n"+m.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),I)I[l].onChannelEvent(Pe.UPDATE,m);if(0<p.length)for(var h in me.view("channel",Pe.MOVE,"\n"+p.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),I)I[h].onChannelEvent(Pe.MOVE,p);if(0<k.length)for(var f in me.view("channel",Pe.REMOVE,"\n"+k.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),I)I[f].onChannelEvent(Pe.REMOVE,k);e()})}},{key:"removeViewItems",value:function(s){var o=this,u=un.get(this.collection);this.mutex.lock(function(e){var n=[];for(var t in s){var r=s[t],a=o.channels.map(function(e){return e.url}).indexOf(r.url);0<=a&&(o.channels.splice(a,1),n.push(r))}if(0<n.length)for(var i in me.view("channel",Pe.REMOVE,"\n"+n.map(function(e){return"\turl=".concat(e.url," name=").concat(e.name," createdAt=").concat(e.createdAt," lastMessageUpdatedAt=").concat(e.lastMessageUpdatedAt)}).join("\n")),u)u[i].onChannelEvent(Pe.REMOVE,n);e()})}},{key:"clearViewItem",value:function(){this.channels=[];var r=un.get(this.collection);this.mutex.lock(function(e){var n=Pe.CLEAR;for(var t in me.view("channel",n),r)r[t].onChannelEvent(n);e()})}}]),e}(),ln=function(){function n(t){var r=this;g(this,n);var e=new cn,a=tn.getInstance();if(!a)return null;this.collectionId=Ee(),this.sendBird=a.sb,this.type="MyGroupChannelListQuery",this.limit=t.limit,this.query=t,this.query.filterKey=a.queryContainer.createFilterKey(this.query),this._isLoading=!1,e.attachCollection(this),a.broadcast.addCollection(this,e),on.set(this,e),un.set(this,{}),Ye(this).shared++,Ze(this).shared++,a.queryContainer.getItem(this.query.filterKey,function(e,n){e?pe.throw(e):(n&&(r.query._token=n._token,r.query.hasNext=n.hasNext,r.query.savepoint=n.savepoint,r.query.updatedAt=n.updatedAt),a.queryContainer.upsert(t,function(e,n){e?pe.throw(e):(r.query=n,r._resume(),me.message("channel collection ".concat(r.collectionId," is created.")))}))})}return c(n,[{key:"_pause",value:function(){me.call("channel sync pause",this.collectionId);var e=Ye(this),n=Ze(this);e&&e.pause(),n&&n.pause()}},{key:"_resume",value:function(){me.call("channel sync resume",this.collectionId);var e=Ye(this),n=Ze(this);e&&e.start(),n&&n.start()}},{key:"fetch",value:function(e){var h=this;if(!this._isLoading)return this._isLoading=!0,Me(function(t){me.call("fetch()");var a=on.get(h),e=h.sendBird,n=On.getInstance(),i=tn.getInstance(),s={ownerUserId:n.currentUserId};if(h.query.includeEmpty||(s.lastMessage={"!=":null}),h.query.nicknameContainsFilter&&(s.members={"/where":function(e){for(var n in e)if(0<=e[n].nickname.indexOf(h.query.nicknameContainsFilter))return!0;return!1}}),h.query.userIdsFilter&&Array.isArray(h.query.userIdsFilter)&&0<h.query.userIdsFilter.length&&(s.members={"/where":function(e){var t=e.map(function(e){return e.userId});return h.query.userIdsFilterExactMatch?t.length===h.query.userIdsFilter.length&&h.query.userIdsFilter.every(function(e){return 0<=t.indexOf(e)}):"AND"===h.query.queryType?h.query.userIdsFilter.every(function(e){return 0<=t.indexOf(e)}):"OR"===h.query.queryType&&h.query.userIdsFilter.reduce(function(e,n){return e||0<=t.indexOf(n)},!1)}}),h.query.channelNameContainsFilter&&(s.name={"/regex":new RegExp(h.query.channelNameContainsFilter)}),0<h.query.channelUrlsFilter.length&&(s.url={"/in":h.query.channelUrlsFilter}),h.query.memberStateFilter!==e.GroupChannel.MemberStateFilter.ALL)switch(h.query.memberStateFilter){case e.GroupChannel.MemberStateFilter.JOINED:s.myMemberState="joined";break;case e.GroupChannel.MemberStateFilter.INVITED:case e.GroupChannel.MemberStateFilter.INVITED_BY_FRIEND:case e.GroupChannel.MemberStateFilter.INVITED_BY_NON_FRIEND:s.myMemberState="invited"}if("string"==typeof h.query.customTypeFilter&&h.query.customTypeFilter&&(s.customType=h.query.customTypeFilter),Array.isArray(h.query.customTypesFilter)&&0<h.query.customTypesFilter.length&&(s.customType={"/in":h.query.customTypesFilter}),"string"==typeof h.query.customTypeStartsWithFilter&&h.query.customTypeStartsWithFilter&&(s.customType={"/regex":new RegExp("^".concat(h.query.customTypeStartsWithFilter))}),h.query.superChannelFilter!==e.GroupChannel.SuperChannelFilter.ALL)switch(h.query.superChannelFilter){case e.GroupChannel.SuperChannelFilter.SUPER:s.isSuper=!0;break;case e.GroupChannel.SuperChannelFilter.NONSUPER:s.isSuper=!1}if(h.query.publicChannelFilter!==e.GroupChannel.PublicChannelFilter.ALL)switch(h.query.publicChannelFilter){case e.GroupChannel.PublicChannelFilter.PUBLIC:s.isPublic=!0;break;case e.GroupChannel.PublicChannelFilter.PRIVATE:s.isPublic=!1}if(h.query.unreadChannelFilter!==e.GroupChannel.UnreadChannelFilter.ALL)switch(h.query.unreadChannelFilter){case e.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:s.unreadMessageCount={">":0}}if("all"!=h.query.hiddenChannelFilter)switch(h.query.hiddenChannelFilter){case e.GroupChannel.HiddenChannelFilter.UNHIDDEN:s.hiddenState=e.GroupChannel.HiddenState.UNHIDDEN;break;case e.GroupChannel.HiddenChannelFilter.HIDDEN:s.hiddenState={"/in":[e.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE,e.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE]};break;case e.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:s.hiddenState=e.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE;break;case e.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:s.hiddenState=e.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE}var o=null,u=!0;switch(h.query.order){case"latest_last_message":!h.query.hasNext&&h.query.savepoint&&(s.lastMessageUpdatedAt={">=":parseInt(h.query.savepoint)}),o={ownerUserId:1,lastMessageUpdatedAt:-1};break;case"chronological":!h.query.hasNext&&h.query.savepoint&&(s.createdAt={">=":parseInt(h.query.savepoint)}),o={ownerUserId:1,createdAt:-1};break;case"channel_name_alphabetical":!h.query.hasNext&&h.query.savepoint&&(s.name={"<=":h.query.savepoint}),u=!(o={ownerUserId:1,name:1});break;default:!h.query.hasNext&&h.query.savepoint&&(s.lastMessageUpdatedAt={">=":parseInt(h.query.savepoint)}),o={ownerUserId:1,lastMessageUpdatedAt:-1}}function r(t,r){i.channelContainer.query(s,{offset:a.channels.length,limit:t,index:o,desc:u},function(e,n){e?(h._isLoading=!1,r(e)):(h._isLoading=!1,n.sort(function(e,n){return 0<a.compareWithChannel(e,n)}),0<n.length&&a.addViewItems(n),n.length<t&&l(t-n.length),r(null,n))})}var c=Ye(h),l=function(n){c.state!==an.State.END&&(me.sync("subscribe channel",h.collectionId),c.subscribe(h.collectionId,function(e){e?me.error(e):(me.sync("flush channel"),r(n,function(e){e&&me.error(e)}))}))};r(h.limit,function(e,n){me.cache("fetch channel",e,n.map(function(e){return e.url})),t(e)}),c.state===an.State.PAUSED&&h._resume()},e);me.error("fetch() is loading"),e(pe.create(pe.Type.ERROR_DUPLICATED_FETCH))}},{key:"remove",value:function(){tn.getInstance().broadcast.removeCollection(this);var e=Ye(this),n=Ze(this);e&&(e.shared--,0===e.shared&&e.pause()),n&&(n.shared--,0===n.shared&&n.pause())}},{key:"setCollectionHandler",value:function(e){var n=un.get(this);e instanceof Fe&&(n[sn]=e)}},{key:"removeCollectionHandler",value:function(){var e=un.get(this);e[sn]&&delete e[sn]}},{key:"channels",get:function(){return on.get(this).channels}}],[{key:"CollectionHandler",get:function(){return Fe}},{key:"Action",get:function(){return Pe}}]),n}();"undefined"==typeof Promise&&(Promise=e);var hn=new U,fn=new U,dn=new U,gn=new U,vn=new U,yn="message-collection-handler",mn=function(){function e(){g(this,e),this.collection=null,this.messages=[],this.prevTempMessages=[],this.nextTempMessages=[],this.unsentMessages=[],hn.set(this,{}),this.currentChunk=null,this.viewRange={start:0,end:0}}return c(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"channelWasRemoved",value:function(e){var n=vn.get(this.collection);for(var t in n)n[t].onChannelRemoved(e)}},{key:"channelWasUpdated",value:function(e){var n=vn.get(this.collection);for(var t in n)n[t].onChannelUpdated(e)}},{key:"addViewItems",value:function(e,n){var t=1<arguments.length&&void 0!==n?n:{},r=vn.get(this.collection),a=hn.get(this),i=gn.get(this.collection),s=[],o=[],u=[],c=[],l=[],h=[],f=[],d=[],g=[];for(var v in e){var y=e[v];if(y.messageId){var m=!0,p=!1;if(t.isEventMessage){var k=i.state===an.State.END,I=!this.currentChunk||this.currentChunk.endAt<=this.viewRange.end,b=0===this.viewRange.end;p=!0,m=k&&I||!this.currentChunk||b}var C=this.collection.sendBird.currentUser?this.collection.channel.getReadReceipt(y):a[y.messageId]||0;if(a[y.messageId]||(a[y.messageId]=C),m){var w=Ce(y,this.messages),E=we(y,this.messages);if(0<=w&&this.messages[w].isEqual(y)&&a[y.messageId]===C)continue;if(a[y.messageId]=C,this.viewRange.start=0<this.viewRange.start?Math.min(this.viewRange.start,y.createdAt):y.createdAt,this.viewRange.end=0<this.viewRange.end?Math.max(this.viewRange.end,y.createdAt):y.createdAt,w<0){var M=Ce(y,this.unsentMessages);if(0<=M){var A=this.unsentMessages[M],O=!A.isUserMessage()||"pending"===A.requestState;this.unsentMessages.splice(M,1),O?h.push(A):g.push(A)}this.messages.splice(E,0,y),p&&this.nextTempMessages.push(y),s.push(y)}else this.messages[w]=y,o.push(y)}t.isEventMessage&&y.sender&&y.sender.userId!==On.getInstance().currentUserId&&c.push(y);var _=this.messages.length,S=[];if(_>On.syncManagerOptions.messageCollectionCapacity){if("next"===t.direction){var T=_-On.syncManagerOptions.messageCollectionCapacity;S=this.messages.splice(0,T)}else S=this.messages.splice(On.syncManagerOptions.messageCollectionCapacity);u.push.apply(u,z(S))}}else{var R=!y.isUserMessage()||"pending"===y.requestState,U=Ce(y,this.unsentMessages);if(U<0){Ce(y,this.messages)<0&&(R?l.push(y):f.push(y),this.unsentMessages.push(y))}else{var D=this.unsentMessages[U];D.isUserMessage()?"pending"===D.requestState?R||(h.push(D),f.push(y),this.unsentMessages[U]=y):(d.push(y),this.unsentMessages[U]=y):this.unsentMessages[U]=y}}}if(0<u.length)for(var N in me.view("message",Le.REMOVE,u.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),r)r[N].onSucceededMessageEvent(u,Le.REMOVE),r[N].onMessageEvent(Le.REMOVE,u);if(0<s.length)for(var x in me.view("message",Le.INSERT,s.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),r)r[x].onSucceededMessageEvent(s,Le.INSERT),r[x].onMessageEvent(Le.INSERT,s);if(0<o.length)for(var F in me.view("message",Le.UPDATE,o.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),r)r[F].onSucceededMessageEvent(o,Le.UPDATE),r[F].onMessageEvent(Le.UPDATE,o);if(0<h.length)for(var q in me.view("pending message",Le.REMOVE,h.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),r)r[q].onPendingMessageEvent(h,Le.REMOVE),r[q].onMessageEvent(Le.REMOVE,h);if(0<l.length)for(var P in me.view("pending message",Le.INSERT,l.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt})),r)r[P].onPendingMessageEvent(l,Le.INSERT),r[P].onMessageEvent(Le.INSERT,l);if(0<g.length){me.view("failed message",Le.REMOVE,g.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt}));var L=Be.REMOVE_RESEND_SUCCEEDED;for(var B in r)r[B].onFailedMessageEvent(g,Le.REMOVE,L)}if(0<d.length){me.view("failed message",Le.UPDATE,d.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt}));var V=Be.UPDATE_RESEND_FAILED;for(var j in r)r[j].onFailedMessageEvent(d,Le.UPDATE,V)}if(0<f.length){me.view("failed message",Le.INSERT,f.map(function(e){return e.reqId+" "+e.messageId+" "+e.createdAt}));var G=Be.NONE;for(var Q in r)r[Q].onFailedMessageEvent(f,Le.INSERT,G)}if(0<c.length)for(var H=0;H<c.length;H++){var K=c[H];for(var W in me.view("new message",K.reqId,K.messageId,K.createdAt),r)r[W].onNewMessage(K)}}},{key:"removeViewItems",value:function(e,n){var t=1<arguments.length&&void 0!==n?n:{isRequestId:!1},r=!!t.hasOwnProperty("isRequestId")&&t.isRequestId,a=vn.get(this.collection);if(r){for(var i=[],s=[],o=0;o<e.length;o++)for(var u=e[o],c=0;c<this.unsentMessages.length;c++)if(u===this.unsentMessages[c].reqId){var l=this.unsentMessages[c];if(l.isUserMessage())switch(l.requestState){case"pending":i.push(l);break;case"failed":s.push(l)}else l.isFileMessage()&&i.push(l);this.unsentMessages.splice(c,1);break}if(0<i.length)for(var h in me.view("pending message",Le.REMOVE,i.map(function(e){return e.reqId})),a)a[h].onPendingMessageEvent(i,Le.REMOVE),a[h].onMessageEvent(Le.REMOVE,i);if(0<s.length){me.view("failed message",Le.REMOVE,s.map(function(e){return e.reqId}));var f=t.hasOwnProperty("reason")?t.reason:Be.REMOVE_UNKNOWN;for(var d in a)a[d].onFailedMessageEvent(s,Le.REMOVE,f)}}else{for(var g=hn.get(this),v=[],y=0;y<e.length;y++)for(var m=e[y],p=0;p<this.messages.length;p++)if(m===this.messages[p].messageId){"number"==typeof g[m]&&delete g[m];var k=this.messages.splice(p,1);v.push.apply(v,z(k));break}if(this.viewRange.start=0<this.messages.length?this.messages[0].createdAt:0,this.viewRange.end=0<this.messages.length?this.messages[this.messages.length-1].createdAt:0,0<v.length)for(var I in me.view("message",Le.REMOVE,v.map(function(e){return e.messageId})),a)a[I].onSucceededMessageEvent(v,Le.REMOVE),a[I].onMessageEvent(Le.REMOVE,v)}}},{key:"clearUnsentMessages",value:function(){var e=this.unsentMessages,n=vn.get(this.collection);for(var t in this.unsentMessages=[],me.view("message",Le.REMOVE,"unsent messages"),n){n[t].onPendingMessageEvent([],Le.CLEAR);var r=Be.NONE;n[t].onFailedMessageEvent([],Le.CLEAR,r),n[t].onMessageEvent(Le.REMOVE,e)}}},{key:"clearViewItem",value:function(){this.currentChunk=null,this.messages=[],hn.set(this,{}),this.viewRange.start=0,this.viewRange.end=0;var e=vn.get(this.collection);for(var n in me.view("message",Le.CLEAR),e)e[n].onSucceededMessageEvent([],Le.CLEAR),e[n].onMessageEvent(Le.CLEAR)}},{key:"updateCurrentChunk",value:function(e){e?this.currentChunk&&this.currentChunk.isSame(e)||(this.currentChunk=De.createFromJson(e)):this.currentChunk=e}}]),e}(),pn=function(){function u(r){var l=this,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:(new Date).getTime();g(this,u);var h=ze.getInstance();if(!h)return null;if(this.collectionId=Ee(),this.sendBird=h.sb,this.channel=r,this.limit=50,this.filter=De.getDefaultFilter(),e&&"object"===d(e)&&0<Object.keys(e).length)for(var t in e)this.filter.hasOwnProperty(t)&&(this.filter[t]=e[t]);this.viewpoint=n,this._isLoading={prev:!1,next:!1},Qe.getInstance().createQueue(this.channel.url);var f=new mn;f.attachCollection(this),fn.set(this,f),dn.set(this,null),gn.set(this,null),vn.set(this,{}),h.broadcast.addCollection(this,f);function a(o,t,u){me.sync("message synchronize() begin",o,t);var e=null,c=0,n=[t];switch(o){case"prev":e="getPreviousMessagesByTimestamp",c=100,n.push(!0),n.push(100);break;case"next":e="getNextMessagesByTimestamp",c=100,n.push(!0),n.push(100);break;case"prevnext":e="getPreviousAndNextMessagesByTimestamp",c=100,n.push(50),n.push(50)}n.push(!1),n.push(l.filter.messageType||""),n.push(l.filter.customType||""),n.push(l.filter.senderUserIdsFilter||[]),n.push(l.filter.includeMetaArray||!0),r[e].apply(r,n.concat([function(s,e){if(h.sb.getErrorFirstCallback()){var n=[s,e];e=n[0],s=n[1]}e?(l._pause(),u(e)):(me.sync("message synchronize() end",o,t,s.map(function(e){return e.messageId})),i.lock(function(n){var t=[],r={startAt:1/0,endAt:0};if(0<s.length){var e=function(e){s[e].isVisible=!0,t.push(new Promise(function(n,t){h.messageContainer.upsert(s[e],function(e){return e?t(e):n()})})),r.startAt=Math.min(r.startAt,s[e].createdAt),r.endAt=Math.max(r.endAt,s[e].createdAt)};for(var a in s)e(a);f.currentChunk&&f.currentChunk.isOverlap(r)||(f.currentChunk=new De(l.channel.url,l.filter),me.message("chunk is created",f.currentChunk.startAt,f.currentChunk.endAt));var i=f.currentChunk;i.extendWithChunk(r),me.message("currentChunk is extended",i.startAt,i.endAt),h.chunkContainer.mergePreviousChunkOverlap(i,function(e){e?(n(),u(e)):(me.message("currentChunk merged previous chunks",i.startAt,i.endAt),Promise.all(t).then(function(){n(),u(null,{count:s.length,nextTs:"prev"===o?i.startAt:i.endAt,hasMore:s.length>=c})}).catch(function(e){n(),u(e)}))})}else n(),u(null,{count:0,nextTs:0,hasMore:!1})}))}]))}var i=new rn,s=new an(function(e,n){return a("prev",e,n)});s.shared++,dn.set(this,s);var o=new an(function(e,n){return a("next",e,n)});o.shared++,gn.set(this,o),h.chunkContainer.getChunkByTimestamp(this.channel.url,this.filter,this.viewpoint,function(e,n){e||(n&&(f.currentChunk=n),f.currentChunk?l._resume():a("prevnext",l.viewpoint,function(e,n){e||setTimeout(function(){s.flush(e,n),o.flush(e,n),n.count<50?(s.end(),o.end()):l._resume()},300)}),me.message("message collection ".concat(l.collectionId," is created.")))}),Object.defineProperty(this,"messageCount",{get:function(){try{return f.messages.length}catch(e){return 0}}})}return c(u,[{key:"_pause",value:function(){me.call("message sync pause",this.collectionId);var e=fn.get(this),n=dn.get(this),t=gn.get(this);n&&n.pause(),t&&t.pause(),e.currentChunk=null}},{key:"_resume",value:function(r){var a=this;me.call("message sync resume",this.collectionId);var e=ze.getInstance(),i=dn.get(this),s=gn.get(this);i&&i.isRunning&&(i.pause(),i.unsubscribeAll()),s&&s.isRunning&&(s.pause(),s.unsubscribeAll()),e.syncChangeLog(this.channel,function(){var e=fn.get(a);if(i){var n=e.currentChunk?e.currentChunk.startAt:a.viewpoint;i.start(n)}if(s){var t=e.currentChunk?e.currentChunk.endAt:a.viewpoint;s.start(t,!0),r&&s.subscribe(a.collectionId+"_autoresendqueue",r)}})}},{key:"fetch",value:function(e,n){return this.fetchSucceededMessages(e,n)}},{key:"fetchSucceededMessages",value:function(g,e){var v=this,i=ze.getInstance(),y=fn.get(this);return this._isLoading[g]?Me(function(e){return e(pe.create(pe.Type.ERROR_DUPLICATED_FETCH))},e):(this._isLoading[g]=!0,Me(function(c){me.call("fetchSucceededMessages()",g);var t=null,l=v.viewpoint,h=v.limit,r=!1,e=l,f=null,a=null;switch(g){case"prev":t=dn.get(v),0<y.viewRange.start&&(l=y.viewRange.start),y.currentChunk&&(e=Math.max(y.currentChunk.startAt,l)),f=y.prevTempMessages,a=i.messageContainer.loadPreviousSucceededMessages,r=!0;break;case"next":t=gn.get(v),0<y.viewRange.end&&(l=y.viewRange.end),y.currentChunk&&(e=Math.min(y.currentChunk.endAt,l)),f=y.nextTempMessages,a=i.messageContainer.loadNextSucceededMessages;break;default:return void c(pe.create(pe.Type.ERROR_INVALID_PARAMETER))}function d(n,u){me.message("waiting for synchronization...");var c=!1;a(v.channel.url,v.filter,n,{limit:h,desc:r},function(e,n){e?(c=!0,v._isLoading[g]=!1,u(e)):(me.cache("temp message",g,n.map(function(e){return e.messageId})),(0<n.length||t.state===an.State.END)&&(c=!0,f.push.apply(f,z(n)),y.addViewItems(n,{direction:g}),v._isLoading[g]=!1,u(null)))});var l=e;me.sync("subscribe message",v.collectionId,g,n),t.subscribe(v.collectionId,function(e){e?(me.error(e),c||(v._isLoading[g]=!1,u(e))):(me.sync("flush message",g,n),i.chunkContainer.getChunkByTimestamp(v.channel.url,v.filter,n,function(e,n){if(e)me.error(e),c||(v._isLoading[g]=!1,u(e));else if(n&&(y.currentChunk=n),y.currentChunk){var o=y.currentChunk;a(v.channel.url,v.filter,l,{limit:h,desc:r},function(e,n){if(e)me.error(e),c||(v._isLoading[g]=!1,u(e));else{me.cache("flush message",g,l,n.map(function(e){return e.messageId}));var t=[],r=[];for(var a in n)if(o.containsMessage(n[a])){var i=y.messages.map(function(e){return e.messageId}).indexOf(n[a].messageId);(i<0||!y.messages[i].isEqual(n[a]))&&t.push(n[a])}for(var s in f)y.messages.map(function(e){return e.messageId}).indexOf(f[s].messageId)<0&&r.push(f[s]);for(;0<f.length;)f.pop();0<r.length&&y.removeViewItems(r.map(function(e){return e.messageId})),0<t.length&&y.addViewItems(t,{direction:g}),c||(v._isLoading[g]=!1,u(null))}})}else me.error(e),c||(v._isLoading[g]=!1,u(e))}))})}i.chunkContainer.getChunkByTimestamp(v.channel.url,v.filter,l,function(e,n){if(e)v._isLoading[g]=!1,c(e);else if(n&&(y.currentChunk=n),y.currentChunk){var u=y.currentChunk;me.message("chunk is selected",u),a(v.channel.url,v.filter,l,{limit:h,desc:r},function(e,n){if(e)v._isLoading[g]=!1,c(e);else{var t=[],r=[];me.cache("fetch message",g,l,n.map(function(e){return e.messageId}));var a=!1;for(var i in n)if(u.containsMessage(n[i])){a=!0;var s=y.messages.map(function(e){return e.messageId}).indexOf(n[i].messageId);(s<0||!y.messages[s].isEqual(n[i]))&&t.push(n[i])}if(!a){for(var o in f)y.messages.map(function(e){return e.messageId}).indexOf(f[o].messageId)<0&&r.push(f[o]);for(;0<f.length;)f.pop()}0<t.length&&y.addViewItems(t,{direction:g}),0<r.length&&y.removeViewItems(r.map(function(e){return e.messageId})),n.length<h?(h-=n.length,d(l,c)):(v._isLoading[g]=!1,c(null))}})}else d(l,c)}),t.state===an.State.PAUSED&&v._resume()},e))}},{key:"fetchFailedMessages",value:function(e){var r=this;return Me(function(t){me.call("fetchFailedMessages()"),Qe.getInstance().loadFailedMessages(r.channel.url,r.filter,function(e,n){e||(me.cache("fetch failed message",n.map(function(e){return e.reqId})),fn.get(r).addViewItems(n));t(e)})},e)}},{key:"resetViewpointTimestamp",value:function(e){var n=0<arguments.length&&void 0!==e?e:(new Date).getTime();if("number"==typeof n&&0<=n){me.call("resetViewpointTimestamp()",n);var t=fn.get(this);t.viewRange.start<=n&&n<=t.viewRange.end?t.currentChunk&&!t.currentChunk.contains(n)&&(t.currentChunk=null):(t.currentChunk=null,t.clearViewItem()),this.viewpoint=n,this._resume()}else me.error("resetViewpointTimestamp()","ts should be number type and greater than or equal to 0."),pe.throw(pe.create(pe.Type.ERROR_INVALID_PARAMETER))}},{key:"remove",value:function(){Qe.getInstance().removeQueue(this.channel.url),ze.getInstance().broadcast.removeCollection(this),fn.get(this).currentChunk=null;var e=dn.get(this),n=gn.get(this);e&&(e.shared--,0===e.shared&&e.pause()),n&&(n.shared--,0===n.shared&&n.pause())}},{key:"handleSendMessageResponse",value:function(e,n){if(me.call("handleSendMessageResponse()",e,n),e){if(n)switch(On.syncManagerOptions.messageResendPolicy){case On.Options.MessageResendPolicy.NONE:this.deleteMessage(n);break;case On.Options.MessageResendPolicy.MANUAL:case On.Options.MessageResendPolicy.AUTOMATIC:if(n.isUserMessage()&&800110!==e.code)this.appendMessage(n);else{var t={reason:Be.REMOVE_UNKNOWN};this.deleteMessage(n,t)}break;default:this.deleteMessage(n)}else this.deleteMessage(n),me.error(e)}else{var r=fn.get(this),a={reason:Be.REMOVE_RESEND_SUCCEEDED};for(var i in r.unsentMessages)if(r.unsentMessages[i].isIdentical(n)){this.deleteMessage(r.unsentMessages[i],a);break}this.appendMessage(n)}}},{key:"hasMessage",value:function(e){if(e)for(var n=fn.get(this),t=0;t<n.succeededMessages.length;t++)if(n.succeededMessages[t].isIdentical(e))return!0;return!1}},{key:"appendMessage",value:function(t){if(t){me.call("appendMessage()",t.messageId);var e=On.getInstance(),r=ze.getInstance(),n=fn.get(this);if(t.messageId)if(t.sender&&t.sender.userId===e.currentUserId){t.isVisible=!0,r.messageContainer.upsert(t,function(e,n){e||r.broadcast.upsert([n])});var a=tn.getInstance();a.channelContainer.getItem(t.channelUrl,function(e,n){e?pe.throw(e):n&&(!n.lastMessage||n.lastMessage.createdAt<=t.createdAt)&&(n.lastMessage=t,a.channelContainer.upsert(n,function(e,n){e?pe.throw(e):a.broadcast.upsert([n])}))})}else me.warning("Cannot append message sent by other member.");else{var i=On.syncManagerOptions;"failed"===t.requestState&&i.messageResendPolicy!==On.Options.MessageResendPolicy.NONE?Qe.getInstance().upsertMessages(this.channel.url,[t]):n.addViewItems([t])}}else me.error("appendMessage()","Message is expected but ".concat(t," is given.")),pe.throw(pe.create(pe.Type.ERROR_INVALID_PARAMETER))}},{key:"updateMessage",value:function(t){if(t){me.call("updateMessage()",t.messageId);var e=On.getInstance(),r=ze.getInstance(),n=fn.get(this);if(t.sender&&t.sender.userId===e.currentUserId)if(t.messageId){t.isVisible=!0,r.messageContainer.upsert(t,function(e,n){e||r.broadcast.update([n])});var a=tn.getInstance();a.channelContainer.getItem(t.channelUrl,function(e,n){e?pe.throw(e):n&&n.lastMessage&&n.lastMessage.messageId===t.messageId&&(n.lastMessage=t,a.channelContainer.upsert(n,function(e,n){e?pe.throw(e):a.broadcast.update([n])}))})}else n.addViewItems([t])}else me.error("updateMessage()","Message is expected but ".concat(t," is given.")),pe.throw(pe.create(pe.Type.ERROR_INVALID_PARAMETER))}},{key:"deleteMessage",value:function(e,n){var t=1<arguments.length&&void 0!==n?n:{};if(e){me.call("deleteMessage()",e.messageId);var r=On.getInstance(),a=fn.get(this);if(e.sender&&e.sender.userId===r.currentUserId&&!e.messageId)if(e.isUserMessage()){for(var i=0;i<a.unsentMessages.length;i++)if(a.unsentMessages[i].isIdentical(e)){switch(e.requestState){case"pending":a.removeViewItems([e.reqId],!0);break;case"failed":Qe.getInstance().removeMessages(this.channel.url,[e],t)}break}}else a.removeViewItems([e.reqId],!0)}else me.error("deleteMessage()","Message is expected but ".concat(e," is given.")),pe.throw(pe.create(pe.Type.ERROR_INVALID_PARAMETER))}},{key:"setCollectionHandler",value:function(e){var n=vn.get(this);e instanceof qe&&(n[yn]=e)}},{key:"removeCollectionHandler",value:function(){var e=vn.get(this);e[yn]&&delete e[yn]}},{key:"messages",get:function(){return this.succeededMessages}},{key:"succeededMessages",get:function(){return fn.get(this).messages}},{key:"unsentMessages",get:function(){return fn.get(this).unsentMessages}}],[{key:"create",value:function(t,i,s,e){"function"==typeof s&&(e=s,s=(new Date).getTime());var n=tn.getInstance();return Me(function(a){n.channelContainer.getItem(t,function(e,n){if(e)a(e);else if(n)a(null,new u(n,i,s));else{var r=tn.getInstance();r.sb.GroupChannel.getChannel(t,function(e,n){if(r.sb.getErrorFirstCallback()){var t=[e,n];n=t[0],e=t[1]}n?a(n):a(null,new u(e,i,s))})}})},e)}},{key:"CollectionHandler",get:function(){return qe}},{key:"Action",get:function(){return Le}},{key:"FailedMessageEventActionReason",get:function(){return Be}}]),u}();"undefined"==typeof Promise&&(Promise=e);var kn=null,In=null,bn=null,Cn=Z,wn=null,En=null,Mn=null,An=null,On=function(){function i(){return g(this,i),In=In||this}return c(i,[{key:"resumeSync",value:function(){me.call("resumeSync()"),En&&En.start(),Mn&&Mn.start()}},{key:"pauseSync",value:function(){me.call("pauseSync()"),En&&En.stop(),Mn&&Mn.stop()}},{key:"clearCache",value:function(e){return me.call("clearCache()"),Me(function(n){var e=[];En&&e.push(new Promise(function(n,t){En.reset(function(e){return e?t(e):n()})})),Mn&&e.push(new Promise(function(n,t){Mn.reset(function(e){return e?t(e):n()})})),0<e.length?Promise.all(e).then(function(){return n(null)}).catch(function(e){return n(e)}):n(null)},e)}},{key:"reset",value:function(e){var t=this;return me.call("reset()"),Me(function(n){t.clearCache(function(e){e||(tn.clear(function(){En=null}),ze.clear(function(){Mn=null})),n(e)})},e)}},{key:"currentUserId",get:function(){return kn&&kn.currentUser?kn.currentUser.userId:bn}}],[{key:"setup",value:function(e,n,t){me.call("init()"),An=new i.Options;var a=arguments.length<=0?void 0:e,r=arguments.length<=1?void 0:n;return r&&"function"!=typeof r&&(r instanceof i.Options?(An=r,r=arguments.length<=2?void 0:t):me.error("Type of the second parameter is not valid: ",arguments.length<=1?void 0:n)),me.prefix="[SyncManager]",Me(function(r){fe.init(),kn?(In=new i,fe.get("lastUserId").then(function(t){bn=a,tn.clear(),En=null,ze.clear(),Mn=null,wn?(me.cache("Database is open"),fe.set("lastUserId",a).then(function(){En=new tn({sendBird:kn,db:wn}),Mn=new ze({sendBird:kn,db:wn}),i.ChannelCollection=ln,i.MessageCollection=pn,t&&t!==a&&(me.warning("Different user ID: clear cache"),In.clearCache(function(){})),Qe.getInstance().removeExpiredMessages(function(){r(null)})}).catch(function(e){r(e)})):S().then(function(e){e&&(me.info("IndexedDB is not supported in private browsing mode in Edge/Firefox. Using in-memory database."),Cn=oe);var n=new Cn("sbsync.db",5);n.schema("GroupChannel",{key:"url",index:[{ownerUserId:Cn.Query.Order.ASC,lastMessageUpdatedAt:Cn.Query.Order.DESC},{ownerUserId:Cn.Query.Order.ASC,createdAt:Cn.Query.Order.DESC},{ownerUserId:Cn.Query.Order.ASC,name:Cn.Query.Order.ASC}]}).schema("GroupChannelListQuery",{key:"filterKey",index:[{ownerUserId:Cn.Query.Order.ASC,updatedAt:Cn.Query.Order.DESC}]}).schema("MessageChunk",{key:"chunkId",index:[{ownerUserId:Cn.Query.Order.ASC,channelUrl:Cn.Query.Order.ASC,filterKey:Cn.Query.Order.ASC,endAt:Cn.Query.Order.DESC}]}).schema("Message",{key:"messageId",index:[{ownerUserId:Cn.Query.Order.ASC,channelUrl:Cn.Query.Order.ASC,createdAt:Cn.Query.Order.DESC},{ownerUserId:Cn.Query.Order.ASC,createdAt:Cn.Query.Order.ASC}]}).build().then(function(){me.cache("Database is open"),wn=n,fe.set("lastUserId",a).then(function(){En=new tn({sendBird:kn,db:wn}),Mn=new ze({sendBird:kn,db:wn}),i.ChannelCollection=ln,i.MessageCollection=pn,t&&t!==a&&(me.warning("Different user ID: clear cache"),In.clearCache(function(){})),Qe.getInstance().removeExpiredMessages(function(){r(null)})}).catch(function(e){r(e)})}).catch(function(e){return r(e)})})}).catch(function(e){r(e)})):r(pe.create(pe.Type.ERROR_SETUP_MISSING))},r)}},{key:"useReactNative",value:function(e){fe.useReactNative(e),L.Storage=e,Cn=L}},{key:"getInstance",value:function(){return In}},{key:"sendBird",get:function(){return kn},set:function(e){kn=e}},{key:"LocalDB",get:function(){return Cn}},{key:"_messageContainer",get:function(){return ze.getInstance().messageContainer}},{key:"_chunkContainer",get:function(){return ze.getInstance().chunkContainer}},{key:"syncManagerOptions",get:function(){return An||new i.Options}},{key:"LogLevel",get:function(){return ge}},{key:"loggerLevel",set:function(e){me.level=e},get:function(){return me.level}}]),i}();return On.Options=function(){return function e(){g(this,e);var n=1e3;Object.defineProperty(this,"messageCollectionCapacity",{get:function(){return n},set:function(e){"number"==typeof e&&e>=(me.isValidLevel(me.level)?200:0)&&e<=Number.MAX_SAFE_INTEGER&&(n=e)}});var t=On.Options.MessageResendPolicy.NONE;Object.defineProperty(this,"messageResendPolicy",{get:function(){return t},set:function(e){-1<Object.keys(On.Options.MessageResendPolicy).map(function(e){return On.Options.MessageResendPolicy[e]}).indexOf(e)&&(t=e)}});var r=On.Options.INFINITY;Object.defineProperty(this,"automaticMessageResendRetryCount",{get:function(){return r},set:function(e){"number"==typeof e&&(0<e&&e<=Number.MAX_SAFE_INTEGER||e===On.Options.INFINITY)&&(r=e)}});var a=20;Object.defineProperty(this,"maxFailedMessageCountPerChannel",{get:function(){return a},set:function(e){"number"==typeof e&&0<e&&e<=Number.MAX_SAFE_INTEGER&&(a=e)}});var i=7;Object.defineProperty(this,"failedMessageRetentionDays",{get:function(){return i},set:function(e){"number"==typeof e&&(e>(me.isValidLevel(me.level)?0:-2)&&e<=Number.MAX_SAFE_INTEGER||e===On.Options.INFINITY)&&(i=e)}})}}(),On.Options.MessageResendPolicy={NONE:"none",MANUAL:"manual",AUTOMATIC:"automatic"},On.Options.INFINITY=Number.MAX_SAFE_INTEGER,On});