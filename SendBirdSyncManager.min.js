!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.SendBirdSyncManager=t():e.SendBirdSyncManager=t()}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=95)}([function(e,t,n){n(60),n(63),n(84),e.exports=n(94).WeakMap},function(e,t,n){"use strict";function r(e,t){const n=typeof e,s=typeof t;return!e||!t||"object"!==n||n!==s||e instanceof Date?e instanceof Date?e.getTime()===t.getTime():"function"===n&&"function"===s||e===t:Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>r(e[n],t[n]))}function s(e){return null!=e}function i(e,t,n=!1){if(s(e)){if(!s(t))return n?-1:1;if(typeof e==typeof t&&e!==t){const n=typeof e;if("boolean"===n)return e?1:-1;if("number"===n)return e>t?1:-1;if("string"===n)return e.localeCompare(t);if(e instanceof Date&&t instanceof Date&&e.getTime()!==t.getTime())return e.getTime()>t.getTime()?1:-1}}else if(s(t))return n?1:-1;return 0}function a(e,t,n){if(!t)return new Promise((t,r)=>{e((e,s)=>{n&&"function"==typeof n&&n(),e?r(e):t(s)})});e((e,r)=>{n&&"function"==typeof n&&n(),t(e,r)})}n.d(t,"b",function(){return r}),n.d(t,"a",function(){return i}),n.d(t,"c",function(){return a})},function(e,t,n){(function(t){var n="object",r=function(e){return e&&e.Math==Math&&e};e.exports=r(typeof globalThis==n&&globalThis)||r(typeof window==n&&window)||r(typeof self==n&&self)||r(typeof t==n&&t)||Function("return this")()}).call(this,n(23))},function(e,t,n){"use strict";n.d(t,"a",function(){return h});var r=n(12),s=n(8),i=n(34),a=n(0),o=n.n(a);let c=null;const l=new o.a,u=new o.a;class h{static get Query(){return s.a}static get Storage(){return c}static set Storage(e){c=e}constructor(e,t={}){this.name=e,this.config=new r.a(t),l.set(this,{}),u.set(this,{})}schema(e,t){return l.get(this)[e]=t,this}build(){const e=l.get(this),t=u.get(this);return new Promise((n,r)=>{const s=[];for(let n in e)if(!t[n]){const r=e[n].key||"_id",a=t[n]=new i.a(n,r);s.push(a.init())}Promise.all(s).then(()=>{const s=[];for(let n in t)if(e[n].index&&e[n].index.length>0){const r=t[n];for(let t in e[n].index)s.push(r.ensureIndex(e[n].index[t]))}s.length>0?Promise.all(s).then(()=>{n()}).catch(e=>r(e)):n()}).catch(e=>r(e))})}close(){}drop(){l.set(this,{}),_db.set(this,null),u.set(this,{}),c.clear()}collection(e){const t=u.get(this);return t[e]&&t[e]instanceof i.a?t[e]:null}}},function(e,t,n){var r=n(17)("wks"),s=n(28),i=n(2).Symbol,a=n(62);e.exports=function(e){return r[e]||(r[e]=a&&i[e]||(a?i:s)("Symbol."+e))}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t,n){"use strict";(function(e){function r({offset:t,condition:n,progress:r},s=((e,t)=>t(null,!0)),i=(()=>{})){let a=t;!function t(){n(a)?e(()=>{s(a,(e,n)=>{e?i(e):n?(a=r(a),t()):i(null)})}):i(null)}()}n.d(t,"a",function(){return r})}).call(this,n(35).setImmediate)},function(e,t,n){"use strict";var r=n(1);const s=1/0,i=(e,t)=>{let n=!0;if(e)for(let s in t){switch(s){case"/and":n=n&&t[s].reduce((t,n)=>t&&i(e,n),!0);break;case"/or":n=n&&t[s].reduce((t,n)=>t||i(e,n),!1);break;default:{const i=t[s];if("object"==typeof i)for(let t in i)switch(t){case">":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]>i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])>0);break;case">=":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]>=i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])>=0);break;case"<":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]<i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])<0);break;case"<=":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]<=i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])<=0);break;case"=":n=n&&e[s]===i[t];break;case"!=":n=n&&e[s]!==i[t];break;case"/in":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[s])>=0;break;case"/nin":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[s])<0;break;case"/like":n=n&&"string"==typeof i[t]&&"string"==typeof e[s]&&e[s].indexOf(i[t])>=0;break;case"/regex":n=n&&i[t]instanceof RegExp&&i[t].test(e[s]);break;case"/where":n=n&&i[t](e[s]);break;default:n=n&&Object(r.b)(e[s],i)}else n=n&&e[s]===i}}if(!n)break}else n=!1;return n};class a{static and(...e){return e.length>0?new a({"/and":e}):new a({})}static or(...e){return e.length>0?new a({"/or":e}):new a({})}static get Order(){return{ASC:1,DESC:-1}}constructor(e){this.condition=e,this.offset=0,this.limit=s,this.index=null,this.desc=!1}match(e){return i(e,this.condition)}}t.a=a},function(e,t,n){var r=n(13),s=n(14),i=n(26);e.exports=r?function(e,t,n){return s.f(e,t,i(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t,n){var r=n(5);e.exports=function(e){if(!r(e))throw TypeError(String(e)+" is not an object");return e}},function(e,t,n){"use strict";n.d(t,"a",function(){return c});const r=64,s=200,i=128,a=32;let o=null;class c{constructor(e={}){return o||(o=this),this.batchSize=r,this.batchInterval=s,this.cachedBlockLimit=i,this.cachedBlockFlush=a,this.encryption={encrypt:(e,t)=>t(null,e),decrypt:(e,t)=>t(null,e)},"number"==typeof e.batchSize&&e.batchSize>1&&(this.batchSize=e.batchSize),"number"==typeof e.batchInterval&&e.batchInterval>10&&(this.batchInterval=e.batchInterval),"number"==typeof e.cachedBlockLimit&&e.cachedBlockLimit>0&&(this.cachedBlockLimit=e.cachedBlockLimit),"number"==typeof e.cachedBlockFlush&&e.cachedBlockFlush<this.cachedBlockLimit&&(this.cachedBlockFlush=e.cachedBlockFlush),e.encryption&&e.encryption.hasOwnProperty("encrypt")&&e.encryption.hasOwnProperty("decrypt")&&"function"==typeof e.encryption.encrypt&&"function"==typeof e.encryption.decrypt&&(this.encryption=e.encryption),o}static getInstance(){return o}}},function(e,t,n){e.exports=!n(10)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t,n){var r=n(13),s=n(37),i=n(11),a=n(39),o=Object.defineProperty;t.f=r?o:function(e,t,n){if(i(e),t=a(t,!0),i(n),s)try{return o(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported");return"value"in n&&(e[t]=n.value),e}},function(e,t,n){var r=n(2),s=n(17),i=n(9),a=n(6),o=n(25),c=n(40),l=n(18),u=l.get,h=l.enforce,d=String(c).split("toString");s("inspectSource",function(e){return c.call(e)}),(e.exports=function(e,t,n,s){var c=!!s&&!!s.unsafe,l=!!s&&!!s.enumerable,u=!!s&&!!s.noTargetGet;"function"==typeof n&&("string"!=typeof t||a(n,"name")||i(n,"name",t),h(n).source=d.join("string"==typeof t?t:"")),e!==r?(c?!u&&e[t]&&(l=!0):delete e[t],l?e[t]=n:i(e,t,n)):l?e[t]=n:o(t,n)})(Function.prototype,"toString",function(){return"function"==typeof this&&u(this).source||c.call(this)})},function(e,t){e.exports={}},function(e,t,n){var r=n(2),s=n(25),i=n(27),a=r["__core-js_shared__"]||s("__core-js_shared__",{});(e.exports=function(e,t){return a[e]||(a[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.1.2",mode:i?"pure":"global",copyright:"Â© 2019 Denis Pushkarev (zloirock.ru)"})},function(e,t,n){var r,s,i,a=n(41),o=n(5),c=n(9),l=n(6),u=n(29),h=n(19),d=n(2).WeakMap;if(a){var f=new d,p=f.get,g=f.has,m=f.set;r=function(e,t){return m.call(f,e,t),t},s=function(e){return p.call(f,e)||{}},i=function(e){return g.call(f,e)}}else{var y=u("state");h[y]=!0,r=function(e,t){return c(e,y,t),t},s=function(e){return l(e,y)?e[y]:{}},i=function(e){return l(e,y)}}e.exports={set:r,get:s,has:i,enforce:function(e){return i(e)?s(e):r(e,{})},getterFor:function(e){return function(t){var n;if(!o(t)||(n=s(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return n}}}},function(e,t){e.exports={}},function(e,t,n){var r=n(47),s=n(49);e.exports=function(e){return r(s(e))}},function(e,t,n){"use strict";var r=n(3),s=n(12);class i{constructor(e){this.blockKey=e,this.data=[]}static createKey(e,t=0){return`${e.toLowerCase()}-blk-${t}`}get count(){return this.data.length}get(e){const t=this.indexOf(e);return t>=0?this.data[t].value:null}indexOf(e){for(let t in this.data)if(this.data[t].key===e)return parseInt(t);return-1}add(e,t){const n=this.indexOf(e);n<0?this.data.push({key:e,value:t}):this.data[n]={key:e,value:t}}remove(e){const t=this.indexOf(e);return t>=0&&(this.data.splice(t,1),!0)}static buildFromSerializedData(e,t){const n=new i(e);try{return n.data=JSON.parse(t),n}catch(e){return null}}getSerializedData(){return JSON.stringify(this.data)}}const a=1e4,o=200;class c{constructor(){this.locked=!1,this.lockedAt=0}lock(e){this.locked?setTimeout(()=>{(new Date).getTime()-this.lockedAt>a&&this.unlock(),this.lock(e)},o):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(()=>this.unlock()))}unlock(){this.locked=!1,this.lockedAt=0}}const l="adb-trns-";class u{constructor(e,t={}){const n=s.a.getInstance();this.name=e,this.initialized=!1,this.queue={},this.batchInterval=t.batchInterval||n.batchInterval,this.batchUpdateTimer=null,this.transactionMutex=new c,this.transactionState=u.State.IDLE,this.transactionCount=0,this.encryption=n.encryption,t.encryption&&t.encryption.hasOwnProperty("encrypt")&&t.encryption.hasOwnProperty("decrypt")&&"function"==typeof t.encryption.encrypt&&"function"==typeof t.encryption.decrypt&&(this.encryption=t.encryption)}static get Action(){return{SET:"set",REMOVE:"remove"}}static get State(){return{IDLE:"idle",RUNNING:"running"}}init(e=(()=>{})){this.initialized?e(null):(this.initialized=!0,0===Object.keys(this.queue).length?r.a.Storage.getItem(l+this.name,(t,n)=>{n?this.encryption.decrypt(n,(t,n)=>{t||(this.queue=JSON.parse(n)),e(t)}):e(null)}):e(null))}flush(){this.transactionMutex.lock(e=>{r.a.Storage.setItem(l+this.name,JSON.stringify(this.queue),t=>{if(t)throw e(),t;{const t=[];for(let e in this.queue){const n=this.queue[e];switch(n.action){case u.Action.SET:t.push(new Promise((t,s)=>{this.encryption.encrypt(JSON.stringify(n.data),(n,i)=>{n?s(n):r.a.Storage.setItem(e,i).then(t).catch(s)})}));break;case u.Action.REMOVE:t.push(r.a.Storage.removeItem(e))}}this.batchUpdateTimer=null,Promise.all(t).then(()=>{this.queue={},r.a.Storage.removeItem(l+this.name,()=>{e()})}).catch(t=>{throw e(),t})}})})}startTransaction(){this.transactionState=u.State.RUNNING,this.transactionCount++}endTransaction(){this.transactionState===u.State.RUNNING&&(this.transactionCount--,0===this.transactionCount&&(this.flush(),this.transactionState=u.State.IDLE))}addJob(e,t,n){this.queue[t]={action:e,data:n},this.transactionState===u.State.IDLE&&(this.batchUpdateTimer||(this.batchUpdateTimer=setTimeout(()=>{this.transactionState===u.State.IDLE&&this.flush(),this.batchUpdateTimer=null},this.batchInterval)))}}n.d(t,"a",function(){return d});const h="adb-info-";class d{constructor(e,t={}){const n=s.a.getInstance();this.cachedBlockLimit=t.cachedBlockLimit||n.cachedBlockLimit,this.cachedBlockFlush=t.cachedBlockFlush||n.cachedBlockFlush,this.cacheMutex=new c,this.encryption=n.encryption,t.encryption&&t.encryption.hasOwnProperty("encrypt")&&t.encryption.hasOwnProperty("decrypt")&&"function"==typeof t.encryption.encrypt&&"function"==typeof t.encryption.decrypt&&(this.encryption=t.encryption),this.batchSize=t.batchSize||n.batchSize,this.batchQueue=t.sharedBatchQueue||new u(e,t),this.transaction=null,this.name=e,this.info={},this.blockCache={},this.blockCacheCursor=0,this.currentBlock=null}_findBlockKey(e){return this.info.blockMap[e]}_getBlockFromCache(e){return this.blockCache[e]?this.blockCache[e].block:null}_putBlockToCache(e){this.blockCache[e.blockKey]={seq:this.blockCacheCursor++,block:e};const t=Object.keys(this.blockCache);if(t.length>=this.cachedBlockLimit){t.sort((e,t)=>this.blockCache[e].seq-this.blockCache[t].seq);for(let e in t)this._removeBlockFromCache(t[e])}}_removeBlockFromCache(e){this.blockCache.hasOwnProperty(e)&&delete this.blockCache[e]}_getBlock(e,t){const n=this._getBlockFromCache(e);n?t(null,n):r.a.Storage.getItem(e).then(n=>{n?this.encryption.decrypt(n,(n,r)=>{if(n)t(n);else{const n=i.buildFromSerializedData(e,r);this._putBlockToCache(n),t(null,n)}}):t(null)}).catch(e=>t(e))}_assignNewBlock(e){this.info.cursor++;const t=i.createKey(this.name,this.info.cursor),n=new i(t);this._putBlockToCache(n),this.currentBlock=n,e&&e.key&&(n.add(e.key,e.value),this.info.blockMap[e.key]=t,this.info.count++),this.batchQueue.addJob(u.Action.SET,n.blockKey,n.data),this.batchQueue.addJob(u.Action.SET,h+this.name,this.info)}init(e=(()=>{})){this.batchQueue.init(t=>{t?e(t):r.a.Storage.getItem(h+this.name,(t,n)=>{t?e(t):n?this.encryption.decrypt(n,(t,n)=>{if(t)e(t);else{this.info=JSON.parse(n);const t=i.createKey(this.name,this.info.cursor);this._getBlock(t,(n,r)=>{n||(this.currentBlock=r||new i(t)),e(n,this.info,!1)})}}):(this.info={blockMap:{},cursor:0,count:0},this.info.cursor=-1,this._assignNewBlock(),e(null,this.info,!0))})})}get keys(){return Object.keys(this.info.blockMap)}get count(){return this.info.count}startTransaction(){this.batchQueue.startTransaction()}endTransaction(){this.batchQueue.endTransaction()}getItem(e,t=(()=>{})){const n=this._findBlockKey(e);n?this._getBlock(n,(n,r)=>{!n&&r?t(null,r.get(e)):t(n||new Error("Broken integrity - data not found."))}):t(null,null)}setItem(e,t,n=(()=>{})){const r=this._findBlockKey(e);if(r)this._getBlock(r,(r,s)=>{!r&&s?(s.add(e,t),this.batchQueue.addJob(u.Action.SET,s.blockKey,s.data),n(null)):n(r||new Error("Broken integrity - data not found."))});else{const r=this.currentBlock;r&&r.count<this.batchSize?(r.add(e,t),this.batchQueue.addJob(u.Action.SET,r.blockKey,r.data),this.info.count++,this.info.blockMap[e]=r.blockKey,this.batchQueue.addJob(u.Action.SET,h+this.name,this.info)):this._assignNewBlock({key:e,value:t}),n(null)}}removeItem(e,t=(()=>{})){const n=this._findBlockKey(e);n?this._getBlock(n,(r,s)=>{if(r)t(r);else if(s){s.remove(e)&&(this.info.blockMap.hasOwnProperty(e)&&delete this.info.blockMap[e],this.info.count--),s.data.length>0?this.batchQueue.addJob(u.Action.SET,n,s.data):(this._removeBlockFromCache(n),this.batchQueue.addJob(u.Action.REMOVE,n)),this.batchQueue.addJob(u.Action.SET,h+this.name,this.info),t(null)}else t(new Error("Failed to remove item - data not found."))}):t(new Error("Failed to remove item - data not found."))}clear(e=(()=>{})){for(let e=0;e<=this.info.cursor;e++)this.batchQueue.addJob(u.Action.REMOVE,i.createKey(this.name,e));this.blockCacheCursor=0,this.blockCache={},this.info={blockMap:{},cursor:-1,count:0},this._assignNewBlock(),e(null)}drop(e=(()=>{})){this.clear(()=>{this.batchQueue.addJob(u.Action.REMOVE,h+this.name),e(null)})}}},function(e,t,n){"use strict";n.d(t,"a",function(){return o});var r=n(21),s=n(7),i=n(1);const a="idx-";class o{constructor({collection:e,columns:t={},options:n={}}){this.collection=e,this.columns=t,this.key=o.createKey(this.columns);for(let e in this.columns)this.columns[e]=1;this.store=new r.a(e.name+"-index-"+this.key,n),this.table=[]}static createKey(e){return Object.keys(e).map(t=>`${t}_${e[t]}`).join("__")}get columnNames(){return Object.keys(this.columns)}columnValues(e){return this.columnNames.map(t=>e?e[t]:null)}compareColumnValues(e,t,n=!0){const r=this.columnNames;for(let s=0;s<r.length;s++){const a=r[s],o=this.columns[a],c=Object(i.a)(e[s],t[s],n);if(0!==c)return o*c}return 0}init(e=(()=>{})){this.store.init((t,n,r)=>{t?e(t):r?this.save(e):this.store.getItem(`${a}${this.key}`,(t,n)=>{n&&(this.table=n),e(t)})})}each(e,t=null,n=1){const r=n>0;let i=r?0:this.table.length-1;if(t&&this.table.length>0){const e={start:0,end:this.table.length};let n=i;for(;e.start<e.end;){const s=this.compareColumnValues(this.table[n].key,t,r);if(0===s)break;s>0?e.end=n-1:e.start=n+1,n=parseInt((e.start+e.end)/2)}i=n}let a=!0;Object(s.a)({offset:i,condition:e=>r?e<this.table.length:e>=0,progress:e=>r?e+1:e-1},(t,n)=>{const i=this.table[t];if(i){const t=i.key,o=i.value;Object(s.a)({offset:r?0:o.length-1,condition:e=>r?e<o.length:e>=0,progress:e=>r?e+1:e-1},(n,r)=>{e({key:t,value:o[n]},(e,t)=>{r(e,a=e||t)})},e=>n(e,a))}else n(null,!1)},()=>{e(null,()=>{})})}put(e,t){let n=!1;const r=this.columnValues(t);Object(s.a)({offset:0,condition:e=>e<this.table.length,progress:e=>e+1},(t,s)=>{const i=this.table[t];if(i){const a=this.compareColumnValues(i.key,r);a>0?(this.table.splice(t,0,{key:r,value:[e]}),n=!0,this.save(e=>s(e,!1))):0===a?i.value.indexOf(e)<0?(i.value.push(e),n=!0,this.save(e=>s(e,!1))):s(null,!1):s(null,!0)}else s(null,!1)},()=>{n||(this.table.push({key:r,value:[e]}),this.save())})}update(e,t,n){const r=this.columnValues(t),s=this.columnValues(n);0!==this.compareColumnValues(r,s)&&(this.remove(e,t),this.put(e,n))}remove(e,t){const n=this.columnValues(t);Object(s.a)({offset:0,condition:e=>e<this.table.length,progress:e=>e+1},(t,r)=>{const s=this.table[t];if(s){if(0===this.compareColumnValues(s.key,n)){const n=s.value.indexOf(e);n>=0?(s.value.splice(n,1),0===s.value.length&&this.table.splice(t,1),this.save(e=>r(e,!1))):r(null,!1)}else r(null,!0)}else r(null,!1)},()=>{})}save(e=(()=>{})){this.store.setItem(`${a}${this.key}`,this.table,e)}clear(){this.table=[],this.store.clear()}drop(){this.table=[],this.store.drop()}}},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t,n){var r=n(2),s=n(9);e.exports=function(e,t){try{s(r,e,t)}catch(n){r[e]=t}return t}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t){e.exports=!1},function(e,t){var n=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+r).toString(36))}},function(e,t,n){var r=n(17)("keys"),s=n(28);e.exports=function(e){return r[e]||(r[e]=s(e))}},function(e,t,n){var r=n(28)("meta"),s=n(64),i=n(19),a=n(5),o=n(6),c=n(14).f,l=0,u=Object.isExtensible||function(){return!0},h=function(e){c(e,r,{value:{objectID:"O"+ ++l,weakData:{}}})},d=e.exports={REQUIRED:!1,fastKey:function(e,t){if(!a(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!o(e,r)){if(!u(e))return"F";if(!t)return"E";h(e)}return e[r].objectID},getWeakData:function(e,t){if(!o(e,r)){if(!u(e))return!0;if(!t)return!1;h(e)}return e[r].weakData},onFreeze:function(e){return s&&d.REQUIRED&&u(e)&&!o(e,r)&&h(e),e}};i[r]=!0},function(e,t,n){var r=n(45),s=Math.min;e.exports=function(e){return e>0?s(r(e),9007199254740991):0}},function(e,t){e.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]},function(e,t,n){var r=n(14).f,s=n(6),i=n(4)("toStringTag");e.exports=function(e,t,n){e&&!s(e=n?e:e.prototype,i)&&r(e,i,{configurable:!0,value:t})}},function(e,t,n){"use strict";(function(e){var r=n(21),s=n(1),i=n(22),a=n(8),o=n(7),c=n(0),l=n.n(c);const u=new l.a,h=new l.a;t.a=class{constructor(e,t){this.name=e,this.pk=t,u.set(this,new r.a(e)),h.set(this,[])}init(e){const t=u.get(this);return Object(s.c)(e=>{t.init(t=>{e(t)})},e)}_findProperIndexer(e){if(e.index){const t=h.get(this);for(let n=0;n<t.length;n++)if(Object(s.b)(t[n].columns,e.index))return t[n]}return null}_addItemToIndex(e,t){const n=h.get(this);for(let r=0;r<n.length;r++)n[r].put(e,t)}_updateItemToIndex(e,t,n){const r=h.get(this);for(let s=0;s<r.length;s++)r[s].update(e,t,n)}_removeItemFromIndex(e,t){const n=h.get(this);for(let r=0;r<n.length;r++)n[r].remove(e,t)}ensureIndex(e,t){const n=u.get(this),r=h.get(this),a=i.a.createKey(e);return Object(s.c)(t=>{for(let e=0;e<r.length;e++)if(a===r[e].key)return void t(null);const s=new i.a({collection:this,columns:e,options:{sharedBatchQueue:n.batchQueue}});s.init((e,i,a)=>{if(e)t(e);else if(r.push(s),a){const e=n.keys;let r=0;for(let i=0;i<e.length;i++){const a=e[i];n.getItem(a,(n,i)=>{!n&&i?s.put(a,i,()=>{++r===e.length&&t(null)}):++r===e.length&&t(null)})}}else t(null)})},t)}removeIndex(e,t){const n=h.get(this),r=i.a.createKey(e);return Object(s.c)(e=>{for(let t=0;t<n.length;t++)if(r===n[t].key)return void n[t].drop(r=>{r||n.splice(t,1),e(r)});e(null)},t)}findById(e,t){const n=u.get(this);return Object(s.c)(t=>{e?("string"!=typeof e&&(e=JSON.stringify(e)),n.getItem(e,(e,n)=>{t(e,n)})):t(new Error("Invalid type: 'id' should not be empty."))},t)}findOne(e,t){return e.limit=1,this.find(e,(e,n)=>{t(e,n.length>0?n[0]:null)})}find(t,n){const r=u.get(this);return Object(s.c)(n=>{if(t instanceof a.a){const s=[],i=this._findProperIndexer(t);if(i){const e=[];for(let n=0;n<i.columnNames.length;n++){const r=i.columnNames[n];if(!t.condition[r])break;if("object"==typeof t.condition[r]){const n=Object.keys(t.condition[r]),s=["="],i=n.filter(e=>s.includes(e));if(!(i.length>0))break;{const s=n.indexOf(i[0]);e.push(t.condition[r][n[s]])}}else{if("function"==typeof t.condition[r]||void 0===t.condition[r]||Array.isArray(t.condition[r]))break;e.push(t.condition[r])}}let o=t.offset||0;i.each((e,i)=>{e?r.getItem(e.value,(e,n)=>{e?i(e):(t.match(n)&&(o<=0?s.push(n):o--),i(null,s.length<t.limit))}):n(null,s)},e.length>0?e:null,t.desc?a.a.Order.DESC:a.a.Order.ASC)}else{const i=!t.desc,a=r.keys;Object(o.a)({offset:t.offset<a.length?i?t.offset:a.length-t.offset-1:i?a.length:0,condition:e=>i?s.length<t.limit&&e<a.length:s.length<t.limit&&e>=0,progress:e=>i?e+1:e-1},(n,i)=>{r.getItem(a[n],(n,r)=>{n?i(n):(t.match(r)&&s.push(r),e(()=>i(null,!0)))})},e=>{n(e,s)})}}else n(new Error("Invalid type: 'query' should be Query type."))},n)}count(t,n){const r=u.get(this);return Object(s.c)(n=>{if(!t||t instanceof a.a)if(t){const s=r.keys;let i=0;Object(o.a)({offset:0,condition:e=>e<s.length,progress:e=>e+1},(n,a)=>{r.getItem(s[n],(n,r)=>{n?a(n):(t.match(r)&&i++,e(()=>a(null,!0)))})},e=>{n(e,i)})}else n(null,r.count);else n(new Error("Invalid type: 'query' should be Query type."))},n)}insert(e,t){const n=u.get(this);return n.startTransaction(),Object(s.c)(t=>{if(Array.isArray(e)){const n=[];for(let t=0;t<e.length;t++)e[t]&&"object"==typeof e[t]&&n.push(this.insert(e[t]));e.length===n.length?Promise.all(n).then(()=>t(null,e)).catch(e=>t(e)):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"==typeof e)if(e[this.pk]){const r=`${e[this.pk]}`;n.getItem(r,(s,i)=>{s?t(s):i?t(new Error("Duplicated item: item already exists.")):(this._addItemToIndex(r,e),n.setItem(r,e,n=>{t(n,e)}))})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},t,()=>n.endTransaction())}upsert(e,t){const n=u.get(this);return n.startTransaction(),Object(s.c)(t=>{if(Array.isArray(e)){const n=[];for(let t=0;t<e.length;t++)e[t]&&"object"==typeof e[t]&&n.push(this.upsert(e[t]));e.length===n.length?Promise.all(n).then(()=>t(null,e)).catch(e=>t(e)):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"==typeof e)if(e[this.pk]){const r=`${e[this.pk]}`;n.getItem(r,(s,i)=>{s?t(s):(i?this._updateItemToIndex(r,i,e):this._addItemToIndex(r,e),n.setItem(r,e,n=>{t(n,e)}))})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},t,()=>n.endTransaction())}update(e,t){const n=u.get(this);return n.startTransaction(),Object(s.c)(t=>{if(Array.isArray(e)){const n=[];for(let t=0;t<e.length;t++)e[t]&&"object"==typeof e[t]&&n.push(this.update(e[t]));e.length===n.length?Promise.all(n).then(()=>t(null,e)).catch(e=>t(e)):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"==typeof e)if(e[this.pk]){const r=`${e[this.pk]}`;n.getItem(r,(s,i)=>{s?t(s):i?(this._updateItemToIndex(r,i,e),n.setItem(r,e,n=>{t(n,e)})):t(null)})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},t,()=>n.endTransaction())}updateIf(t,n,r){const i=u.get(this);return i.startTransaction(),Object(s.c)(r=>{if(t instanceof a.a){const a=[],c=i.keys;Object(o.a)({offset:0,condition:e=>e<c.length,progress:e=>e+1},(r,o)=>{i.getItem(c[r],(r,c)=>{if(r)o(r);else if(c&&t.match(c)){const t=JSON.parse(JSON.stringify(c));let r=!1;for(let e in n){const t=n[e];Object(s.b)(c[e],t)||(r=!0,c[e]=t)}if(r){const n=`${c[this.pk]}`;this._updateItemToIndex(n,t,c),i.setItem(n,c,t=>{t?o(t):(a.push(c),e(()=>o(null,!0)))})}else e(()=>o(null,!0))}else e(()=>o(null,!0))})},e=>{r(e,a)})}else r(new Error("Invalid type: 'query' should be Query type."))},r,()=>i.endTransaction())}remove(e,t){const n=u.get(this);return n.startTransaction(),Object(s.c)(t=>{e?(e=`${e}`,n.getItem(e,(r,s)=>{r?t(r):s?(this._removeItemFromIndex(e,s),n.removeItem(e,e=>{t(e)})):t(null)})):t(new Error("Invalid type: 'id' should be string type."))},t,()=>n.endTransaction())}removeIf(t,n){const r=u.get(this);return r.startTransaction(),Object(s.c)(n=>{if(t instanceof a.a){const s=[],i=r.keys;Object(o.a)({offset:0,condition:e=>e<i.length,progress:e=>e+1},(n,a)=>{r.getItem(i[n],(n,i)=>{if(n)a(n);else if(i&&t.match(i)){const t=`${i[this.pk]}`;this._removeItemFromIndex(t,i),r.removeItem(t,t=>{t?a(t):(s.push(i),e(()=>a(null,!0)))})}else e(()=>a(null,!0))})},e=>{n(e,s)})}else n(new Error("Invalid type: 'query' should be Query type."))},n,()=>r.endTransaction())}clear(e){const t=h.get(this),n=u.get(this);return n.startTransaction(),Object(s.c)(e=>{for(let e=0;e<t.length;e++)t[e].clear();n.clear(t=>{e(t)})},e,()=>n.endTransaction())}}}).call(this,n(35).setImmediate)},function(e,t,n){(function(e){var r=void 0!==e&&e||"undefined"!=typeof self&&self||window,s=Function.prototype.apply;function i(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new i(s.call(setTimeout,r,arguments),clearTimeout)},t.setInterval=function(){return new i(s.call(setInterval,r,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},i.prototype.unref=i.prototype.ref=function(){},i.prototype.close=function(){this._clearFn.call(r,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},n(58),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(23))},function(e,t,n){var r=n(24),s=n(4)("toStringTag"),i="Arguments"==r(function(){return arguments}());e.exports=function(e){var t,n,a;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),s))?n:i?r(t):"Object"==(a=r(t))&&"function"==typeof t.callee?"Arguments":a}},function(e,t,n){var r=n(13),s=n(10),i=n(38);e.exports=!r&&!s(function(){return 7!=Object.defineProperty(i("div"),"a",{get:function(){return 7}}).a})},function(e,t,n){var r=n(5),s=n(2).document,i=r(s)&&r(s.createElement);e.exports=function(e){return i?s.createElement(e):{}}},function(e,t,n){var r=n(5);e.exports=function(e,t){if(!r(e))return e;var n,s;if(t&&"function"==typeof(n=e.toString)&&!r(s=n.call(e)))return s;if("function"==typeof(n=e.valueOf)&&!r(s=n.call(e)))return s;if(!t&&"function"==typeof(n=e.toString)&&!r(s=n.call(e)))return s;throw TypeError("Can't convert object to primitive value")}},function(e,t,n){e.exports=n(17)("native-function-to-string",Function.toString)},function(e,t,n){var r=n(40),s=n(2).WeakMap;e.exports="function"==typeof s&&/native code/.test(r.call(s))},function(e,t,n){var r=n(15);e.exports=function(e,t,n){for(var s in t)r(e,s,t[s],n);return e}},function(e,t){e.exports=function(e,t,n){if(!(e instanceof t))throw TypeError("Incorrect "+(n?n+" ":"")+"invocation");return e}},function(e,t,n){var r=n(11),s=n(66),i=n(31),a=n(46),o=n(68),c=n(69),l={};(e.exports=function(e,t,n,u,h){var d,f,p,g,m,y=a(t,n,u?2:1);if(h)d=e;else{if("function"!=typeof(f=o(e)))throw TypeError("Target is not iterable");if(s(f)){for(p=0,g=i(e.length);g>p;p++)if((u?y(r(m=e[p])[0],m[1]):y(e[p]))===l)return l;return}d=f.call(e)}for(;!(m=d.next()).done;)if(c(d,y,m.value,u)===l)return l}).BREAK=l},function(e,t){var n=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:n)(e)}},function(e,t,n){var r=n(67);e.exports=function(e,t,n){if(r(e),void 0===t)return e;switch(n){case 0:return function(){return e.call(t)};case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,s){return e.call(t,n,r,s)}}return function(){return e.apply(t,arguments)}}},function(e,t,n){var r=n(10),s=n(24),i="".split;e.exports=r(function(){return!Object("z").propertyIsEnumerable(0)})?function(e){return"String"==s(e)?i.call(e,""):Object(e)}:Object},function(e,t,n){var r=n(49);e.exports=function(e){return Object(r(e))}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on "+e);return e}},function(e,t,n){var r=n(10),s=/#|\.prototype\./,i=function(e,t){var n=o[a(e)];return n==l||n!=c&&("function"==typeof t?r(t):!!t)},a=i.normalize=function(e){return String(e).replace(s,".").toLowerCase()},o=i.data={},c=i.NATIVE="N",l=i.POLYFILL="P";e.exports=i},function(e,t,n){var r=n(2),s=n(52).f,i=n(9),a=n(15),o=n(25),c=n(75),l=n(50);e.exports=function(e,t){var n,u,h,d,f,p=e.target,g=e.global,m=e.stat;if(n=g?r:m?r[p]||o(p,{}):(r[p]||{}).prototype)for(u in t){if(d=t[u],h=e.noTargetGet?(f=s(n,u))&&f.value:n[u],!l(g?u:p+(m?".":"#")+u,e.forced)&&void 0!==h){if(typeof d==typeof h)continue;c(d,h)}(e.sham||h&&h.sham)&&i(d,"sham",!0),a(n,u,d,e)}}},function(e,t,n){var r=n(13),s=n(74),i=n(26),a=n(20),o=n(39),c=n(6),l=n(37),u=Object.getOwnPropertyDescriptor;t.f=r?u:function(e,t){if(e=a(e),t=o(t,!0),l)try{return u(e,t)}catch(e){}if(c(e,t))return i(!s.f.call(e,t),e[t])}},function(e,t,n){var r=n(6),s=n(20),i=n(78)(!1),a=n(19);e.exports=function(e,t){var n,o=s(e),c=0,l=[];for(n in o)!r(a,n)&&r(o,n)&&l.push(n);for(;t.length>c;)r(o,n=t[c++])&&(~i(l,n)||l.push(n));return l}},function(e,t,n){var r=n(83);e.exports=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,n={};try{(e=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(n,[]),t=n instanceof Array}catch(e){}return function(n,s){return r(n,s),t?e.call(n,s):n.__proto__=s,n}}():void 0)},function(e,t,n){var r=n(11),s=n(88),i=n(32),a=n(19),o=n(90),c=n(38),l=n(29)("IE_PROTO"),u=function(){},h=function(){var e,t=c("iframe"),n=i.length;for(t.style.display="none",o.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),h=e.F;n--;)delete h.prototype[i[n]];return h()};e.exports=Object.create||function(e,t){var n;return null!==e?(u.prototype=r(e),n=new u,u.prototype=null,n[l]=e):n=h(),void 0===t?n:s(n,t)},a[l]=!0},function(e,t,n){"use strict";var r,s,i,a=n(57),o=n(9),c=n(6),l=n(27),u=n(4)("iterator"),h=!1;[].keys&&("next"in(i=[].keys())?(s=a(a(i)))!==Object.prototype&&(r=s):h=!0),null==r&&(r={}),l||c(r,u)||o(r,u,function(){return this}),e.exports={IteratorPrototype:r,BUGGY_SAFARI_ITERATORS:h}},function(e,t,n){var r=n(6),s=n(48),i=n(29)("IE_PROTO"),a=n(93),o=Object.prototype;e.exports=a?Object.getPrototypeOf:function(e){return e=s(e),r(e,i)?e[i]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?o:null}},function(e,t,n){(function(e,t){!function(e,n){"use strict";if(!e.setImmediate){var r,s,i,a,o,c=1,l={},u=!1,h=e.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(e);d=d&&d.setTimeout?d:e,"[object process]"==={}.toString.call(e.process)?r=function(e){t.nextTick(function(){p(e)})}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?e.MessageChannel?((i=new MessageChannel).port1.onmessage=function(e){p(e.data)},r=function(e){i.port2.postMessage(e)}):h&&"onreadystatechange"in h.createElement("script")?(s=h.documentElement,r=function(e){var t=h.createElement("script");t.onreadystatechange=function(){p(e),t.onreadystatechange=null,s.removeChild(t),t=null},s.appendChild(t)}):r=function(e){setTimeout(p,0,e)}:(a="setImmediate$"+Math.random()+"$",o=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(a)&&p(+t.data.slice(a.length))},e.addEventListener?e.addEventListener("message",o,!1):e.attachEvent("onmessage",o),r=function(t){e.postMessage(a+t,"*")}),d.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var s={callback:e,args:t};return l[c]=s,r(c),c++},d.clearImmediate=f}function f(e){delete l[e]}function p(e){if(u)setTimeout(p,0,e);else{var t=l[e];if(t){u=!0;try{!function(e){var t=e.callback,r=e.args;switch(r.length){case 0:t();break;case 1:t(r[0]);break;case 2:t(r[0],r[1]);break;case 3:t(r[0],r[1],r[2]);break;default:t.apply(n,r)}}(t)}finally{f(e),u=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(23),n(59))},function(e,t){var n,r,s=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function o(e){if(n===setTimeout)return setTimeout(e,0);if((n===i||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:i}catch(e){n=i}try{r="function"==typeof clearTimeout?clearTimeout:a}catch(e){r=a}}();var c,l=[],u=!1,h=-1;function d(){u&&c&&(u=!1,c.length?l=c.concat(l):h=-1,l.length&&f())}function f(){if(!u){var e=o(d);u=!0;for(var t=l.length;t;){for(c=l,l=[];++h<t;)c&&c[h].run();h=-1,t=l.length}c=null,u=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===a||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function g(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new p(e,t)),1!==l.length||u||o(f)},p.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=g,s.addListener=g,s.once=g,s.off=g,s.removeListener=g,s.removeAllListeners=g,s.emit=g,s.prependListener=g,s.prependOnceListener=g,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},function(e,t,n){var r=n(61),s=Object.prototype;r!==s.toString&&n(15)(s,"toString",r,{unsafe:!0})},function(e,t,n){"use strict";var r=n(36),s={};s[n(4)("toStringTag")]="z",e.exports="[object z]"!==String(s)?function(){return"[object "+r(this)+"]"}:s.toString},function(e,t,n){var r=n(10);e.exports=!!Object.getOwnPropertySymbols&&!r(function(){return!String(Symbol())})},function(e,t,n){"use strict";var r,s=n(2),i=n(42),a=n(30),o=n(65),c=n(5),l=n(18).enforce,u=n(41),h=!s.ActiveXObject&&"ActiveXObject"in s,d=Object.isExtensible,f=function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},p=e.exports=n(73)("WeakMap",f,o,!0,!0);if(u&&h){r=o.getConstructor(f,"WeakMap",!0),a.REQUIRED=!0;var g=p.prototype,m=g.delete,y=g.has,b=g.get,I=g.set;i(g,{delete:function(e){if(c(e)&&!d(e)){var t=l(this);return t.frozen||(t.frozen=new r),m.call(this,e)||t.frozen.delete(e)}return m.call(this,e)},has:function(e){if(c(e)&&!d(e)){var t=l(this);return t.frozen||(t.frozen=new r),y.call(this,e)||t.frozen.has(e)}return y.call(this,e)},get:function(e){if(c(e)&&!d(e)){var t=l(this);return t.frozen||(t.frozen=new r),y.call(this,e)?b.call(this,e):t.frozen.get(e)}return b.call(this,e)},set:function(e,t){if(c(e)&&!d(e)){var n=l(this);n.frozen||(n.frozen=new r),y.call(this,e)?I.call(this,e,t):n.frozen.set(e,t)}else I.call(this,e,t);return this}})}},function(e,t,n){e.exports=!n(10)(function(){return Object.isExtensible(Object.preventExtensions({}))})},function(e,t,n){"use strict";var r=n(42),s=n(30).getWeakData,i=n(11),a=n(5),o=n(43),c=n(44),l=n(70),u=n(6),h=n(18),d=h.set,f=h.getterFor,p=l(5),g=l(6),m=0,y=function(e){return e.frozen||(e.frozen=new b)},b=function(){this.entries=[]},I=function(e,t){return p(e.entries,function(e){return e[0]===t})};b.prototype={get:function(e){var t=I(this,e);if(t)return t[1]},has:function(e){return!!I(this,e)},set:function(e,t){var n=I(this,e);n?n[1]=t:this.entries.push([e,t])},delete:function(e){var t=g(this.entries,function(t){return t[0]===e});return~t&&this.entries.splice(t,1),!!~t}},e.exports={getConstructor:function(e,t,n,l){var h=e(function(e,r){o(e,h,t),d(e,{type:t,id:m++,frozen:void 0}),null!=r&&c(r,e[l],e,n)}),p=f(t),g=function(e,t,n){var r=p(e),a=s(i(t),!0);return!0===a?y(r).set(t,n):a[r.id]=n,e};return r(h.prototype,{delete:function(e){var t=p(this);if(!a(e))return!1;var n=s(e);return!0===n?y(t).delete(e):n&&u(n,t.id)&&delete n[t.id]},has:function(e){var t=p(this);if(!a(e))return!1;var n=s(e);return!0===n?y(t).has(e):n&&u(n,t.id)}}),r(h.prototype,n?{get:function(e){var t=p(this);if(a(e)){var n=s(e);return!0===n?y(t).get(e):n?n[t.id]:void 0}},set:function(e,t){return g(this,e,t)}}:{add:function(e){return g(this,e,!0)}}),h}}},function(e,t,n){var r=n(16),s=n(4)("iterator"),i=Array.prototype;e.exports=function(e){return void 0!==e&&(r.Array===e||i[s]===e)}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e}},function(e,t,n){var r=n(36),s=n(4)("iterator"),i=n(16);e.exports=function(e){if(null!=e)return e[s]||e["@@iterator"]||i[r(e)]}},function(e,t,n){var r=n(11);e.exports=function(e,t,n,s){try{return s?t(r(n)[0],n[1]):t(n)}catch(t){var i=e.return;throw void 0!==i&&r(i.call(e)),t}}},function(e,t,n){var r=n(46),s=n(47),i=n(48),a=n(31),o=n(71);e.exports=function(e,t){var n=1==e,c=2==e,l=3==e,u=4==e,h=6==e,d=5==e||h,f=t||o;return function(t,o,p){for(var g,m,y=i(t),b=s(y),I=r(o,p,3),v=a(b.length),w=0,C=n?f(t,v):c?f(t,0):void 0;v>w;w++)if((d||w in b)&&(m=I(g=b[w],w,y),e))if(n)C[w]=m;else if(m)switch(e){case 3:return!0;case 5:return g;case 6:return w;case 2:C.push(g)}else if(u)return!1;return h?-1:l||u?u:C}}},function(e,t,n){var r=n(5),s=n(72),i=n(4)("species");e.exports=function(e,t){var n;return s(e)&&("function"!=typeof(n=e.constructor)||n!==Array&&!s(n.prototype)?r(n)&&null===(n=n[i])&&(n=void 0):n=void 0),new(void 0===n?Array:n)(0===t?0:t)}},function(e,t,n){var r=n(24);e.exports=Array.isArray||function(e){return"Array"==r(e)}},function(e,t,n){"use strict";var r=n(2),s=n(50),i=n(51),a=n(15),o=n(30),c=n(44),l=n(43),u=n(5),h=n(10),d=n(81),f=n(33),p=n(82);e.exports=function(e,t,n,g,m){var y=r[e],b=y&&y.prototype,I=y,v=g?"set":"add",w={},C=function(e){var t=b[e];a(b,e,"add"==e?function(e){return t.call(this,0===e?0:e),this}:"delete"==e?function(e){return!(m&&!u(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return m&&!u(e)?void 0:t.call(this,0===e?0:e)}:"has"==e?function(e){return!(m&&!u(e))&&t.call(this,0===e?0:e)}:function(e,n){return t.call(this,0===e?0:e,n),this})};if(s(e,"function"!=typeof y||!(m||b.forEach&&!h(function(){(new y).entries().next()}))))I=n.getConstructor(t,e,g,v),o.REQUIRED=!0;else if(s(e,!0)){var k=new I,E=k[v](m?{}:-0,1)!=k,A=h(function(){k.has(1)}),S=d(function(e){new y(e)}),T=!m&&h(function(){for(var e=new y,t=5;t--;)e[v](t,t);return!e.has(-0)});S||((I=t(function(t,n){l(t,I,e);var r=p(new y,t,I);return null!=n&&c(n,r[v],r,g),r})).prototype=b,b.constructor=I),(A||T)&&(C("delete"),C("has"),g&&C("get")),(T||E)&&C(v),m&&b.clear&&delete b.clear}return w[e]=I,i({global:!0,forced:I!=y},w),f(I,e),m||n.setStrong(I,e,g),I}},function(e,t,n){"use strict";var r={}.propertyIsEnumerable,s=Object.getOwnPropertyDescriptor,i=s&&!r.call({1:2},1);t.f=i?function(e){var t=s(this,e);return!!t&&t.enumerable}:r},function(e,t,n){var r=n(6),s=n(76),i=n(52),a=n(14);e.exports=function(e,t){for(var n=s(t),o=a.f,c=i.f,l=0;l<n.length;l++){var u=n[l];r(e,u)||o(e,u,c(t,u))}}},function(e,t,n){var r=n(77),s=n(80),i=n(11),a=n(2).Reflect;e.exports=a&&a.ownKeys||function(e){var t=r.f(i(e)),n=s.f;return n?t.concat(n(e)):t}},function(e,t,n){var r=n(53),s=n(32).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return r(e,s)}},function(e,t,n){var r=n(20),s=n(31),i=n(79);e.exports=function(e){return function(t,n,a){var o,c=r(t),l=s(c.length),u=i(a,l);if(e&&n!=n){for(;l>u;)if((o=c[u++])!=o)return!0}else for(;l>u;u++)if((e||u in c)&&c[u]===n)return e||u||0;return!e&&-1}}},function(e,t,n){var r=n(45),s=Math.max,i=Math.min;e.exports=function(e,t){var n=r(e);return n<0?s(n+t,0):i(n,t)}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,n){var r=n(4)("iterator"),s=!1;try{var i=0,a={next:function(){return{done:!!i++}},return:function(){s=!0}};a[r]=function(){return this},Array.from(a,function(){throw 2})}catch(e){}e.exports=function(e,t){if(!t&&!s)return!1;var n=!1;try{var i={};i[r]=function(){return{next:function(){return{done:n=!0}}}},e(i)}catch(e){}return n}},function(e,t,n){var r=n(5),s=n(54);e.exports=function(e,t,n){var i,a=t.constructor;return a!==n&&"function"==typeof a&&(i=a.prototype)!==n.prototype&&r(i)&&s&&s(e,i),e}},function(e,t,n){var r=n(5),s=n(11);e.exports=function(e,t){if(s(e),!r(t)&&null!==t)throw TypeError("Can't set "+String(t)+" as a prototype")}},function(e,t,n){var r=n(85),s=n(86),i=n(2),a=n(9),o=n(4),c=o("iterator"),l=o("toStringTag"),u=s.values;for(var h in r){var d=i[h],f=d&&d.prototype;if(f){if(f[c]!==u)try{a(f,c,u)}catch(e){f[c]=u}if(f[l]||a(f,l,h),r[h])for(var p in s)if(f[p]!==s[p])try{a(f,p,s[p])}catch(e){f[p]=s[p]}}}},function(e,t){e.exports={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0}},function(e,t,n){"use strict";var r=n(20),s=n(87),i=n(16),a=n(18),o=n(91),c=a.set,l=a.getterFor("Array Iterator");e.exports=o(Array,"Array",function(e,t){c(this,{type:"Array Iterator",target:r(e),index:0,kind:t})},function(){var e=l(this),t=e.target,n=e.kind,r=e.index++;return!t||r>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==n?{value:r,done:!1}:"values"==n?{value:t[r],done:!1}:{value:[r,t[r]],done:!1}},"values"),i.Arguments=i.Array,s("keys"),s("values"),s("entries")},function(e,t,n){var r=n(4)("unscopables"),s=n(55),i=n(9),a=Array.prototype;null==a[r]&&i(a,r,s(null)),e.exports=function(e){a[r][e]=!0}},function(e,t,n){var r=n(13),s=n(14),i=n(11),a=n(89);e.exports=r?Object.defineProperties:function(e,t){i(e);for(var n,r=a(t),o=r.length,c=0;o>c;)s.f(e,n=r[c++],t[n]);return e}},function(e,t,n){var r=n(53),s=n(32);e.exports=Object.keys||function(e){return r(e,s)}},function(e,t,n){var r=n(2).document;e.exports=r&&r.documentElement},function(e,t,n){"use strict";var r=n(51),s=n(92),i=n(57),a=n(54),o=n(33),c=n(9),l=n(15),u=n(27),h=n(4)("iterator"),d=n(16),f=n(56),p=f.IteratorPrototype,g=f.BUGGY_SAFARI_ITERATORS,m=function(){return this};e.exports=function(e,t,n,f,y,b,I){s(n,t,f);var v,w,C,k=function(e){if(e===y&&O)return O;if(!g&&e in S)return S[e];switch(e){case"keys":case"values":case"entries":return function(){return new n(this,e)}}return function(){return new n(this)}},E=t+" Iterator",A=!1,S=e.prototype,T=S[h]||S["@@iterator"]||y&&S[y],O=!g&&T||k(y),x="Array"==t&&S.entries||T;if(x&&(v=i(x.call(new e)),p!==Object.prototype&&v.next&&(u||i(v)===p||(a?a(v,p):"function"!=typeof v[h]&&c(v,h,m)),o(v,E,!0,!0),u&&(d[E]=m))),"values"==y&&T&&"values"!==T.name&&(A=!0,O=function(){return T.call(this)}),u&&!I||S[h]===O||c(S,h,O),d[t]=O,y)if(w={values:k("values"),keys:b?O:k("keys"),entries:k("entries")},I)for(C in w)!g&&!A&&C in S||l(S,C,w[C]);else r({target:t,proto:!0,forced:g||A},w);return w}},function(e,t,n){"use strict";var r=n(56).IteratorPrototype,s=n(55),i=n(26),a=n(33),o=n(16),c=function(){return this};e.exports=function(e,t,n){var l=t+" Iterator";return e.prototype=s(r,{next:i(1,n)}),a(e,l,!1,!0),o[l]=c,e}},function(e,t,n){e.exports=!n(10)(function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})},function(e,t,n){e.exports=n(2)},function(e,t,n){"use strict";n.r(t);var r=n(3);const s=(e,t)=>{const n=typeof e,r=typeof t;return!e||!t||"object"!==n||n!==r||e instanceof Date?e instanceof Date?e.getTime()===t.getTime():"function"===n&&"function"===r||e===t:Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>s(e[n],t[n]))},i=e=>{let t=null;return e&&(Array.isArray(e)?t=e.join("_"):"object"==typeof e?t=Object.keys(e).join("_"):"string"==typeof e&&(t=e)),t},a=(e,t,n)=>{if(!t)return new Promise((t,r)=>{e((e,s)=>{n&&"function"==typeof n&&n(),e?r(e):t(s)})});e(t)};var o=n(0),c=n.n(o);const l=new c.a;var u=class{constructor(e,t,n){this.name=t,this.keyPath=n,l.set(this,e)}findById(e,t){const n=l.get(this);return a(t=>{const r=n.transaction(this.name,"readonly").objectStore(this.name).get(e);r.onsuccess=(()=>t(null,r.result||null)),r.onerror=(()=>t(r.error))},t)}find(e,t){const n=l.get(this);return a(t=>{if(e instanceof I.Query){const r=i(e.index),s=[],a=n.transaction(this.name,"readonly").objectStore(this.name),o=r?a.index(r).openCursor(null,e.desc?"prev":"next"):a.openCursor();let c=e.offset;o.onsuccess=(n=>{const r=n.target.result;if(r)if(!c||c<0){const n=r.value;e.match(n)?(s.push(n),s.length<e.limit?r.continue():t(null,s)):r.continue()}else c--,r.continue();else t(null,s)}),o.onerror=(()=>{t(o.error)})}else t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},t)}count(e,t){const n=l.get(this);return a(t=>{if(!e||e instanceof I.Query){const r=n.transaction(this.name,"readonly").objectStore(this.name);if(e){let n=0;const s=r.openCursor();s.onsuccess=(()=>{const r=event.target.result;r?(e.match(r.value)&&n++,r.continue()):t(null,n)}),s.onerror=(()=>{t(s.error)})}else{const e=r.count();e.onsuccess=(()=>t(null,e.result)),e.onerror=(()=>t(e.error))}}else t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},t)}insert(e,t){const n=l.get(this);return a(t=>{const r=n.transaction(this.name,"readwrite").objectStore(this.name);if(Array.isArray(e)){const n=[];for(let s in e){const i=e[s],a=r.add(i);a.onsuccess=(()=>{n.push(i),n.length===e.length&&t(null,n)}),a.onerror=(()=>{t(a.error)})}}else if(e&&"object"==typeof e){const n=r.add(e);n.onsuccess=(()=>t(null,e)),n.onerror=(()=>t(n.error))}else t(new Error("Invalid type: 'item' should be an object or an object array."))},t)}upsert(e,t){const n=l.get(this);return a(t=>{const r=n.transaction(this.name,"readwrite").objectStore(this.name);if(e&&"object"==typeof e){const n=r.get(e[this.keyPath]);n.onsuccess=(()=>{if(n.result){const n=r.put(e);n.onsuccess=(()=>t(null,e)),n.onerror=(()=>t(n.error))}else{const n=r.add(e);n.onsuccess=(()=>t(null,e)),n.onerror=(()=>t(n.error))}}),n.onerror=(()=>{t(n.error)})}else t(new Error("Invalid type: 'item' should be an object or an object array."))},t)}update(e,t){const n=l.get(this);return a(t=>{const r=n.transaction(this.name,"readwrite").objectStore(this.name).put(e);r.onsuccess=(()=>t(null,e)),r.onerror=(()=>t(r.error))},t)}updateIf(e,t,n){const r=l.get(this);return a(n=>{if(e instanceof I.Query){const i=[],a=r.transaction(this.name,"readwrite").objectStore(this.name),o=a.openCursor();o.onsuccess=(r=>{const o=r.target.result;if(o){const r=o.value;if(e.match(r)){let e=!1;for(let n in t){const i=t[n];s(r[n],i)||(e=!0,r[n]=i)}if(e){const e=a.put(r);e.onsuccess=(()=>{i.push(r),o.continue()}),e.onerror=(()=>{n(e.error)})}else o.continue()}else o.continue()}else n(null,i)}),o.onerror=(()=>{n(o.error)})}else n(new Error("Invalid type: 'query' should be LocalDB.Query type."))},n)}remove(e,t){const n=l.get(this);return a(t=>{const r=n.transaction(this.name,"readwrite").objectStore(this.name).delete(e);r.onsuccess=(()=>t(null)),r.onerror=(()=>t(r.error))},t)}removeIf(e,t){const n=l.get(this);return a(t=>{if(e instanceof I.Query){const r=[],s=n.transaction(this.name,"readwrite").objectStore(this.name),i=s.openCursor();i.onsuccess=(n=>{const i=n.target.result;if(i){const n=i.value;if(e.match(n)){const e=s.delete(n[this.keyPath]);e.onsuccess=(()=>{r.push(n),i.continue()}),e.onerror=(()=>{t(e.error)})}else i.continue()}else t(null,r)}),i.onerror=(()=>{t(i.error)})}else t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},t)}clear(e){const t=l.get(this);return a(e=>{const n=t.transaction(this.name,"readwrite").objectStore(this.name).clear();n.onsuccess=(()=>e(null)),n.onerror=(()=>e(n.error))},e)}};const h=1/0,d=(e,t)=>{let n=!0;for(let r in t){switch(r){case"/and":n=n&&t[r].reduce((t,n)=>t&&d(e,n),!0);break;case"/or":n=n&&t[r].reduce((t,n)=>t||d(e,n),!1);break;default:{const i=t[r];if("object"==typeof i)for(let t in i)switch(t){case">":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]>i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])>0);break;case">=":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]>=i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])>=0);break;case"<":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]<i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])<0);break;case"<=":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]<=i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])<=0);break;case"=":n=n&&e[r]===i[t];break;case"!=":n=n&&e[r]!==i[t];break;case"/in":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[r])>=0;break;case"/nin":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[r])<0;break;case"/like":n=n&&"string"==typeof i[t]&&"string"==typeof e[r]&&e[r].indexOf(i[t])>=0;break;case"/regex":n=n&&i[t]instanceof RegExp&&i[t].test(e[r]);break;case"/where":n=n&&i[t](e[r]);break;default:n=n&&s(e[r],i)}else n=n&&e[r]===i}}if(!n)break}return n};class f{static and(...e){return e.length>0?new f({"/and":e}):new f({})}static or(...e){return e.length>0?new f({"/or":e}):new f({})}static get Order(){return{ASC:1,DESC:-1}}constructor(e){this.condition=e,this.offset=0,this.limit=h,this.index=null,this.desc=!1}match(e){return d(e,this.condition)}}var p=f;const g=new c.a,m=new c.a,y=new c.a,b=window?window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB:null;class I{static get Query(){return p}constructor(e,t){if(!b)throw new Error("IndexedDB is not supported in this environment. Check if you're in web browser which supports IndexedDB.");this.name=e,this.version=t,g.set(this,{}),m.set(this,null),y.set(this,{})}schema(e,t={}){return g.get(this)[e]=t,this}build(){const e=g.get(this),t=y.get(this);return new Promise((n,r)=>{const s=b.open(this.name,this.version);s.onerror=(e=>{r(new Error(`IndexedDB is not available: ${e.target.errorCode}`))}),s.onupgradeneeded=(n=>{const r=n.target.result,s=n.target.transaction,a=s.objectStoreNames;for(let n in e){const a=e[n].key||"id";let o=null;try{o=s.objectStore(n)}catch(e){"NotFoundError"===e.name&&(o=r.createObjectStore(n,{keyPath:a}))}if(o){const s=o.indexNames,c=new u(r,n,a);if(e[n].index&&e[n].index.length>0)for(let t in e[n].index){const r=i(e[n].index[t]);if(r){let i=!1;for(let e in s)if(s[e]===r){i=!0;break}i||o.createIndex(r,Object.keys(e[n].index[t]),{unique:!1})}}const l=[];if(e[n].index)for(let t in e[n].index){const r=i(e[n].index[t]);r&&l.push(r)}for(let e=0;e<s.length;e++)l.indexOf(s[e])<0&&o.deleteIndex(s[e]);t[n]=c}}for(let t=0;t<a.length;t++)Object.keys(e).indexOf(a.item(t))<0&&r.deleteObjectStore(a.item(t));m.set(this,r)}),s.onsuccess=(r=>{const s=r.target.result;for(let n in e)if(!t[n]){const r=e[n].key||"id";t[n]=new u(s,n,r)}m.set(this,s),n()})})}close(){const e=m.get(this);e&&(e.close(),m.set(this,null))}drop(){b.deleteDatabase(this.name)}collection(e){const t=y.get(this);return t[e]&&t[e]instanceof u?t[e]:null}}let v=null,w=!1;class C{static init(){v||(v=window?window.localStorage:null)}static useReactNative(e){v=e,w=!0}static getKeys(){return w?v.getAllKeys():new Promise(e=>{const t=[];for(let e in v)t.push(e);e(t)})}static get(e){return w?v.getItem(e):new Promise(t=>{const n=v.getItem(e);t(void 0!==n?n:null)})}static set(e,t){return w?v.setItem(e,t):new Promise(n=>{v.setItem(e,t),n()})}static remove(e){return w?v.removeItem(e):new Promise(t=>{v.removeItem(e),t()})}static clear(){return w?v.clear():new Promise(e=>{v.clear(),e()})}}const k=!1,E=[];class A{static put(e,...t){k&&(0===E.length||E.indexOf(e)>=0)&&console.log(`[${e}]`,...t)}static call(...e){A.put("CALL",...e)}static cache(...e){A.put("CACHE",...e)}static sync(...e){A.put("SYNC",...e)}static event(...e){A.put("EVENT",...e)}static view(...e){A.put("VIEW",...e)}static warning(...e){A.put("WARNING",...e)}static error(...e){A.put("ERROR",...e)}static message(...e){A.put("MESSAGE",...e)}}class S extends Error{constructor(e,t){super(e),this.name="SyncManagerException",this.code=t||0}static create(e=S.Type.ERROR_UNKNOWN){return new S(e.message,e.code)}static get Type(){return{ERROR_UNKNOWN:{code:81e4,message:"Unknown error occurred."},ERROR_DATABASE_IO:{code:810001,message:"Database I/O operation failed."},ERROR_SETUP_MISSING:{code:810100,message:"SendBirdSyncManager.setup() is not called."},ERROR_SENDBIRD_MISSING:{code:810101,message:"SendBird instance should be set before init()."},ERROR_DUPLICATED_FETCH:{code:810200,message:"Fetch is in progress."},ERROR_DUPLICATED_CHANGELOG_SYNC:{code:810210,message:"Sync is in progress."},ERROR_INVALID_PARAMETER:{code:810300,message:"Invalid parameter."}}}static throw(e){if(A.error(e),e instanceof S)throw e}}const T=function(e,t){const n=e.collection("GroupChannel"),r=(e,t)=>{const r=Qe.getInstance();r.currentUserId?(e.ownerUserId=r.currentUserId,e.lastMessageUpdatedAt=e.lastMessage?e.lastMessage.createdAt:e.createdAt,A.cache("upsert channel","url="+e.url,"name="+e.name,"createdAt="+e.createdAt,"lastMessageUpdatedAt="+e.lastMessageUpdatedAt),n.upsert(e.serialize(),t)):t(S.create(S.Type.ERROR_SETUP_MISSING))},s=e=>{if(e){const n=t.GroupChannel.buildFromSerializedData(e);return n.lastMessageUpdatedAt=n.lastMessage?n.lastMessage.createdAt:n.createdAt,n}return null};return this.query=((e,t,r)=>{const i=Qe.getInstance();if(i.currentUserId){e.ownerUserId=i.currentUserId;const a=new Qe.LocalDB.Query(e);t&&(a.offset=t.offset||0,a.limit=t.limit||20,a.index=t.index,a.desc=t.desc),n.find(a,(e,t)=>{if(e)r(e);else{const e=[];for(let n=0;n<t.length;n++){const r=s(t[n]);e.push(r)}r(null,e)}})}else r(S.create(S.Type.ERROR_SETUP_MISSING))}),this.insert=((e,t)=>{this.getItem(e.url,(n,s)=>{n?t(n):s?t(null,e):r(e,n=>{n?t(n):t(null,e)})})}),this.upsert=((e,t)=>{r(e,(e,n)=>{e?t(e):t(null,s(n))})}),this.remove=((t,r)=>{((t,r)=>{const s=Qe.getInstance();s.currentUserId?(A.cache("remove channel",t.url),n.remove(t.url,(n,i)=>{if(n)r(n);else{const n=new Qe.LocalDB.Query({ownerUserId:s.currentUserId,channelUrl:t.url});e.collection("MessageChunk").removeIf(n,t=>{t?r(t):e.collection("Message").removeIf(n,e=>{e?r(e):r(null,i)})})}})):r(S.create(S.Type.ERROR_SETUP_MISSING))})(t,(e,t)=>{e?r(e):r(null,s(t))})}),this.getItem=((e,t)=>{n.findById(e,(e,n)=>{e?t(e):t(null,s(n))})}),this.clear=(t=>(t=>{A.cache("clear channel"),n.clear(n=>{n?t(n):e.collection("MessageChunk").clear(n=>{n?t(n):e.collection("Message").clear(t)})})})(t)),this};let O={};const x=function(e,t){const n=e.collection("GroupChannelListQuery"),r=(e,t)=>{e.filterKey=this.createFilterKey(e);const r=Qe.getInstance();if(r.currentUserId){A.cache("upsert channel list query",e.filterKey),e.ownerUserId=r.currentUserId,e.updatedAt=(new Date).getTime(),e.savepoint||(e.savepoint="");const i=e.serialize();n.upsert(i,(n,r)=>{if(n)t(n);else{if(O[e.filterKey])for(let t in e)O[e.filterKey].hasOwnProperty(t)&&(O[e.filterKey][t]=e[t]);else O[e.filterKey]=e;t(null,s(r))}})}else t(S.create(S.Type.ERROR_SETUP_MISSING))},s=e=>{if(e){const n=t.GroupChannelListQuery.buildFromSerializedData(e);return n.filterKey=e.filterKey,n.ownerUserId=e.currentUserId,n.updatedAt=e.updatedAt,n.savepoint=e.savepoint,n}return null};return this.createFilterKey=(e=>{const t=[];return t.push(`order=${e.order}`),t.push(`includeEmpty=${e.includeEmpty}`),t.push(`customTypesFilter=${e.customTypesFilter.sort().join(",")}`),t.join("&")}),this.upsert=((e,t)=>{r(e,(e,n)=>{e?t(e):t(null,s(n))})}),this.remove=((e,t)=>{((e,t)=>{Qe.getInstance().currentUserId?(A.cache("remove channel list query",e.filterKey),n.remove(e.filterKey,(n,r)=>{n?t(n):(O[e.filterKey]&&delete O[e.filterKey],t(null,r))})):t(S.create(S.Type.ERROR_SETUP_MISSING))})(e,(e,n)=>{e?t(e):t(null,s(n))})}),this.getItem=((e,t)=>{O[e]?t(null,O[e]):n.findById(e,(e,n)=>{e?t(e):t(null,s(n))})}),this.clear=(e=>(e=>{A.cache("clear channel list query"),O={},n.clear(t=>e(t))})(e)),this};function M(e,t){const n=F.getInstance().sb;let r=!0;if(e.isGroupChannel()&&!e.isSuper){if(!t.includeEmpty&&!e.lastMessage)return!1;if(t.nicknameContainsFilter){let n=!1;for(let r in e.members)if(e.members[r].nickname.indexOf(t.nicknameContainsFilter)>=0){n=!0;break}if(!n)return!1}if(t.userIdsFilter.length>0){let n=!1;const r=e.members.map(e=>e.userId),s=t.userIdsFilterExactMatch,i=t.queryType;if(s?n=r.length===t.userIdsFilter.length&&t.userIdsFilter.every(e=>r.indexOf(e)>=0):"AND"===i?n=t.userIdsFilter.every(e=>r.indexOf(e)>=0):"OR"===i&&(n=t.userIdsFilter.reduce((e,t)=>e=e||r.indexOf(t)>=0,!1)),!n)return!1}}if(t.channelNameContainsFilter&&(r=r&&e.name.indexOf(t.channelNameContainsFilter)>=0),t.channelUrlsFilter.length>0&&(r=r&&t.channelUrlsFilter.indexOf(e.url)>=0),t.memberStateFilter!==n.GroupChannel.memberStateFilter.ALL)switch(t.memberStateFilter){case n.GroupChannel.memberStateFilter.JOINED:r=r&&e.myMemberState===n.GroupChannel.memberStateFilter.JOINED;break;case n.GroupChannel.memberStateFilter.INVITED:case n.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case n.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:r=r&&e.myMemberState===n.GroupChannel.memberStateFilter.INVITED}if(t.customTypesFilter.length>0&&(r=r&&t.customTypesFilter.indexOf(e.customType)>=0),t.customTypeStartsWithFilter&&(r=r&&e.customType.startsWith(t.customTypeStartsWithFilter)),t.superChannelFilter!==n.GroupChannel.superChannelFilter.ALL)switch(t.superChannelFilter){case n.GroupChannel.superChannelFilter.SUPER:r=r&&e.isSuper;break;case n.GroupChannel.superChannelFilter.NONSUPER:r=r&&!e.isSuper}if(t.publicChannelFilter!==n.GroupChannel.publicChannelFilter.ALL)switch(t.publicChannelFilter){case n.GroupChannel.publicChannelFilter.PUBLIC:r=r&&e.isPublic;break;case n.GroupChannel.publicChannelFilter.PRIVATE:r=r&&!e.isPublic}if(t.unreadChannelFilter!=n.GroupChannel.UnreadChannelFilter.ALL)switch(t.unreadChannelFilter){case n.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:r=r&&e.unreadMessageCount>0}return r}const U=function(){let e=[];return this.addCollection=((t,n)=>{e.indexOf(t)<0&&e.push({controller:t,view:n})}),this.removeCollection=(t=>{const n=e.map(e=>e.controller).indexOf(t);n>=0&&(e[n].controller._pause(),e.splice(n,1))}),this.clearCollection=(()=>{for(let t in e)e[t].controller._pause();e=[]}),this.pause=(()=>{for(let t in e)e[t].controller._pause()}),this.resume=(()=>{for(let t in e)e[t].controller._resume()}),this.upsert=((t,n,r={})=>{for(let s in e){const i=e[s];if(i.controller!==n){const e=[];for(let n in t){const r=t[n];M(r,i.controller.query)&&e.push(r)}e.length>0&&(r.isEventChannel=!0,i.view.addViewItems(e,r))}}}),this.update=((t,n,r={})=>{for(let s in e){const i=e[s];if(i.controller!==n){const e=[];for(let n in t){const r=t[n];M(r,i.controller.query)&&i.view.channels.map(e=>e.url).indexOf(r.url)>=0&&e.push(r)}e.length>0&&(r.isEventChannel=!0,i.view.addViewItems(e,r))}}}),this.remove=((t,n)=>{for(let r in e){const s=e[r];if(s.controller!==n){const e=[];for(let n in t){const r=t[n];s.view.channels.map(e=>e.url).indexOf(r.url)>=0&&e.push(r)}e.length>0&&s.view.removeViewItems(e)}}}),this.hide=((t,n,r={})=>{const s=F.getInstance().sb;for(let i in e){const a=e[i];if(a.controller!==n){const e=[];for(let n in t){const r=t[n];M(r,a.controller.query)&&e.push(r)}if(e.length>0)switch(a.controller.query.hiddenChannelFilter){case s.GroupChannel.HiddenChannelFilter.UNHIDDEN:a.view.removeViewItems(e);break;case s.GroupChannel.HiddenChannelFilter.HIDDEN:case s.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case s.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:r.isEventChannel=!0,a.view.addViewItems(e,r)}}}}),this.unhide=((t,n,r={})=>{const s=F.getInstance().sb;for(let i in e){const a=e[i];if(a.controller!==n){const e=[];for(let n in t){const r=t[n];M(r,a.controller.query)&&e.push(r)}if(e.length>0)switch(a.controller.query.hiddenChannelFilter){case s.GroupChannel.HiddenChannelFilter.UNHIDDEN:r.isEventChannel=!0,a.view.addViewItems(e,r);break;case s.GroupChannel.HiddenChannelFilter.HIDDEN:case s.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case s.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:a.view.removeViewItems(e)}}}}),this.clear=(()=>{for(let t in e){e[t].view.clearViewItem()}}),this},_="channel-changeLog-token",D="syncManager_channelManager_channelHandler_"+(new Date).getTime(),R=100;let N=null;class F{constructor({sendBird:e,db:t}){if(!N){A.call("ChannelManager()"),N=this;const n=this.sb=e,r=Qe.getInstance();this.channelContainer=new T(t,n),this.queryContainer=new x(t,n),this.broadcast=new U,this.isFetchingChangeLog=!1,this.channelSyncByFilter={},this.changeLogSync=null;const s=new n.ChannelHandler;Object.keys(s).forEach(e=>{s[e]=((...t)=>{switch(e){case"onChannelChanged":{const r=t[0];A.event(e,r.url),N.channelContainer.getItem(r.url,(e,t)=>{e?S.throw(e):N.channelContainer.upsert(r,(e,s)=>{e?S.throw(e):t?t.hiddenState!==n.GroupChannel.HiddenState.UNHIDDEN&&r.hiddenState===n.GroupChannel.HiddenState.UNHIDDEN?N.broadcast.unhide([s]):N.broadcast.update([s]):N.broadcast.upsert([s])})});break}case"onUserMuted":case"onUserUnmuted":case"onUserUnbanned":case"onChannelFrozen":case"onChannelUnfrozen":case"onMetaDataCreated":case"onMetaDataUpdated":case"onMetaDataDeleted":case"onMetaCountersCreated":case"onMetaCountersUpdated":case"onMetaCountersDeleted":A.event(e,t[0].url),N.channelContainer.upsert(t[0],(e,t)=>{e?S.throw(e):N.broadcast.update([t])});break;case"onUserReceivedInvitation":case"onUserJoined":A.event(e,t[0].url),N.channelContainer.upsert(t[0],(e,n)=>{if(e)S.throw(e);else{t[1].userId===r.currentUserId?N.broadcast.upsert([n]):N.broadcast.update([n])}});break;case"onReadReceiptUpdated":N.channelContainer.upsert(t[0],e=>{e&&S.throw(e)});break;case"onMessageReceived":t[0].lastMessage&&t[0].lastMessage.messageId!==t[1].messageId||N.channelContainer.upsert(t[0],(e,t)=>{e?S.throw(e):N.broadcast.upsert([t])});break;case"onChannelHidden":{A.event(e,t[0].url);const n=t[0];N.channelContainer.upsert(n,e=>{e?S.throw(e):N.broadcast.hide([n])});break}case"onUserLeft":case"onUserBanned":{A.event(e,t[0].url);const n=t[0];t[1].userId===r.currentUserId?N.channelContainer.remove(n,e=>{e?S.throw(e):N.broadcast.remove([n])}):N.channelContainer.upsert(n,(e,t)=>{e?S.throw(e):N.broadcast.update([t])});break}case"onUserDeclinedInvitation":{A.event(e,t[0].url);const n=t[0];t[2].userId===r.currentUserId?N.channelContainer.remove(n,e=>{e?S.throw(e):N.broadcast.remove([n])}):N.channelContainer.upsert(n,(e,t)=>{e?S.throw(e):N.broadcast.update([t])});break}case"onChannelDeleted":A.event(e,t[0]),N.channelContainer.getItem(t[0],(e,t)=>{e?S.throw(e):t&&N.channelContainer.remove(t,e=>{e?S.throw(e):N.broadcast.remove([t])})})}})}),n.addChannelHandler(D,s)}return N}static getInstance(){return N}static clear(){N&&N.sb&&(A.message("ChannelManager is cleared"),N.channelSyncByFilter={},N.changeLogSync=null,N.broadcast.clearCollection(),N.sb.removeChannelHandler(D),N=null)}syncChangeLog(e,t){if(this.isFetchingChangeLog)t(S.create(S.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLog=!0,A.call("channel syncChangeLog()");const n=`${_}`;C.get(n).then(r=>{let s="getMyGroupChannelChangeLogsByToken";const i=[];i.push([]),i.push(!0),r?(s="getMyGroupChannelChangeLogsByToken",i.unshift(r)):(s="getMyGroupChannelChangeLogsByTimestamp",i.unshift((new Date).getTime()-R)),A.call(s),this.sb[s](...i,(r,s)=>{if(this.sb.getErrorFirstCallback()){const e=r;r=s,s=e}if(s)this.isFetchingChangeLog=!1;else{A.sync("updated",r.updatedChannels&&r.updatedChannels.length>0?"\n"+r.updatedChannels.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"):[]),A.sync("deleted",r.deletedChannelUrls);const s=[];r.updatedChannels.forEach(e=>{s.push(new Promise((t,n)=>{N.channelContainer.getItem(e.url,(r,s)=>{r?n(r):N.channelContainer.upsert(e,(e,r)=>{if(e)n(e);else{const e=!s||!s.isEqual(r),n=(!s||s.hiddenState===this.sb.GroupChannel.HiddenState.UNHIDDEN)&&r.hiddenState!==this.sb.GroupChannel.HiddenState.UNHIDDEN,i=(!s||s.hiddenState!==this.sb.GroupChannel.HiddenState.UNHIDDEN)&&r.hiddenState===this.sb.GroupChannel.HiddenState.UNHIDDEN;let a=e?"update":"noop";n?a="hide":i&&(a="unhide"),t({action:a,channel:r})}})})}))}),r.deletedChannelUrls.forEach(e=>{s.push(new Promise((t,n)=>{N.channelContainer.getItem(e,(e,r)=>{e?n(e):r&&N.channelContainer.remove(r,e=>{if(e)n(e);else{t({action:"remove",channel:r})}})})}))}),Promise.all(s).then(s=>{const i=[],a=[],o=[],c=[];for(let e=0;e<s.length;e++)switch(s[e].action){case"update":i.push(s[e].channel);break;case"remove":a.push(s[e].channel);break;case"hide":o.push(s[e].channel);break;case"unhide":c.push(s[e].channel)}i.length>0&&N.broadcast.upsert(i,null,{isChangeLogChannel:!0}),a.length>0&&N.broadcast.remove(a),o.length>0&&N.broadcast.hide(o,null,{isChangeLogChannel:!0}),c.length>0&&N.broadcast.unhide(c,null,{isChangeLogChannel:!0}),C.set(n,r.token).then(()=>{r.hasMore?this.syncChangeLog(e,t):(this.isFetchingChangeLog=!1,t())}).catch(e=>{this.isFetchingChangeLog=!1,t(e)})}).catch(e=>t(e))}})}).catch(e=>{this.isFetchingChangeLog=!1,t(e)})}}start(){N.broadcast.resume()}stop(){N.broadcast.pause()}clearCache(e){N.channelSyncByFilter={},N.changeLogSync=null,N.channelContainer.clear(()=>{N.queryContainer.clear(()=>{C.getKeys().then(t=>{const n=[];t.forEach(e=>{e.startsWith(_)&&n.push(C.remove(e))}),Promise.all(n).then(()=>e()).catch(t=>{A.error(t),e(t)})}).catch(t=>e(t))})})}reset(e){N?(N.broadcast.clear(),N.clearCache(e)):e(null)}}const L=function(e,t){const n=e.collection("Message"),r=(e,t)=>{const r=Qe.getInstance();e.messageId?r.currentUserId?(e.hasOwnProperty("isVisible")||(e.isVisible=!0),e.hasOwnProperty("isDeleted")||(e.isDeleted=!1),e.ownerUserId=r.currentUserId,A.cache("upsert message",e.messageId,e.createdAt,"owner="+e.ownerUserId,"visible="+e.isVisible,"deleted="+e.isDeleted),n.findById(e.messageId,(r,s)=>{r?t(r):s?s.isDeleted?t(null,s):(e.isVisible=e.isVisible||s.isVisible,n.upsert(e.serialize(),(e,n)=>{e?t(e):t(null,n)})):n.upsert(e.serialize(),(e,n)=>{e?t(e):t(null,n)})})):t(S.create(S.Type.ERROR_SETUP_MISSING)):t(null,e)},s=e=>{let n=null;return e&&("user"===e.messageType?n=t.UserMessage.buildFromSerializedData(e):"file"===e.messageType?n=t.FileMessage.buildFromSerializedData(e):"admin"===e.messageType&&(n=t.AdminMessage.buildFromSerializedData(e))),n};return this.query=((e,t,r)=>{e.isVisible=!0,e.isDeleted=!1;const i=Qe.getInstance();if(i.currentUserId){e.ownerUserId=i.currentUserId;const a=new Qe.LocalDB.Query(e);t&&(a.offset=t.offset||0,a.limit=t.limit||50,a.desc=t.desc),a.index={ownerUserId:Qe.LocalDB.Query.Order.ASC,channelUrl:Qe.LocalDB.Query.Order.ASC,createdAt:Qe.LocalDB.Query.Order.DESC},n.find(a,(e,t)=>{if(e)r(e);else{const e=[];for(let n=0;n<t.length;n++){const r=s(t[n]);e.push(r)}r(null,e)}})}else r(S.create(S.Type.ERROR_SETUP_MISSING))}),this.upsert=((e,t)=>{r(e,(e,n)=>{e?t(e):t(null,s(n))})}),this.remove=((e,t)=>{this.getItem(e,(n,s)=>{const i=Qe.getInstance(),a={messageId:e,serialize:()=>({messageId:e,ownerUserId:s?s.ownerUserId:i.currentUserId,channelUrl:s?s.channelUrl:"",createdAt:s?s.createdAt:0,isVisible:!1,isDeleted:!0})};r(a,n=>{n?t(n):t(null,e)})})}),this.getItemWithVisibility=((e,t)=>{n.findById(e,(e,n)=>{e?t(e):t(null,{item:s(n),isVisible:!!n&&n.isVisible})})}),this.getItem=((e,t)=>{n.findById(e,(e,n)=>{e?t(e):t(null,s(n))})}),this.clear=(e=>(e=>{A.cache("clear messages"),n.clear(t=>e(t))})(e)),this.loadPreviousMessages=((e,t={},n=(new Date).getTime(),r={},s)=>{const i={channelUrl:e,createdAt:{"<=":n}};t.messageType&&(i.messageType=t.messageType),t.customType&&(i.customType=t.customType),t.senderUserIds&&t.senderUserIds.length>0&&(i["sender.userId"]={"/in":t.senderUserIds}),r.desc=!0,this.query(i,r,s)}),this.loadNextMessages=((e,t={},n=0,r={},s)=>{const i={channelUrl:e,createdAt:{">=":n}};t.messageType&&(i.messageType=t.messageType),t.customType&&(i.customType=t.customType),t.senderUserIds&&t.senderUserIds.length>0&&(i["sender.userId"]={"/in":t.senderUserIds}),r.desc=!1,this.query(i,r,s)}),this};function j(e,t=[]){return t.map(e=>e.url).indexOf(e.url)}function B(e,t,n=[]){let r=null,s=(e,t)=>e>t;switch(t.order){case"latest_last_message":r="lastMessageUpdatedAt";break;case"chronological":r="createdAt";break;case"channel_name_alphabetical":r="name",s=((e,t)=>e.localeCompare(t)<0);break;default:r="lastMessageUpdatedAt"}let i=n.length;for(let t=0;t<n.length;t++){const a=n[t];if(e[r]===a[r]&&e.url===a.url){i=t;break}if(s(e[r],a[r])){i=t;break}}return i}function P(e,t=[]){for(let n=0;n<t.length;n++)if(e.isIdentical(t[n]))return n;return-1}function V(e,t=[]){let n=t.length;for(let r=0;r<t.length;r++)if(t[r].createdAt>=e.createdAt){n=r;break}return n}const q=(e,t)=>{const n=typeof e,r=typeof t;return!e||!t||"object"!==n||n!==r||e instanceof Date?e instanceof Date?e.getTime()===t.getTime():"function"===n&&"function"===r||e===t:Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>q(e[n],t[n]))},G=()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})},H=(e,t)=>{if(!t)return new Promise((t,n)=>{e(e=>e?n(e):t())});e(t)};let Q={};const z=function(e){const t=[];for(let n in e)t.push(`${n}=${e[n]}`);return t.join("&")};class K{constructor(e,t){this.chunkId=G(),this.channelUrl=e,this.filterKey=z(t),this.filter=t,this.startAt=(new Date).getTime(),this.endAt=0}static createFromJson(e){const t=new K(e.channelUrl,e.filter);return t.chunkId=e.chunkId,t.startAt=e.startAt,t.endAt=e.endAt,t}static getDefaultFilter(){return{messageTypeFilter:null,customTypeFilter:null,senderUserIdsFilter:[],includeMetaArray:!1}}hasDefaultFilter(){const e=K.getDefaultFilter();return q(this.filter,e)}isOverlap(e){return e.startAt<=this.startAt&&this.startAt<=e.endAt||e.startAt<=this.endAt&&this.endAt<=e.endAt}isSame(e){return e.startAt===this.startAt&&this.endAt===e.endAt}contains(e){return this.startAt<=e&&e<=this.endAt}containsMessage(e){return this.contains(e.createdAt)}serialize(){const e=JSON.parse(JSON.stringify(this));return Object.freeze(e)}extendForward(e){this.endAt=Math.max(this.endAt,e)}extendBackward(e){this.startAt=Math.min(this.startAt,e)}extendWithChunk(e){return this.extendForwardWithChunk(e),this.extendBackwardWithChunk(e),this}extendForwardWithChunk(e){return this.extendForward(e.endAt),this}extendBackwardWithChunk(e){return this.extendBackward(e.startAt),this}extendWithMessage(e){return this.extendForwardWithMessage(e),this.extendBackwardWithMessage(e),this}extendForwardWithMessage(e){return this.extendForward(e.createdAt),this}extendBackwardWithMessage(e){return this.extendBackward(e.createdAt),this}}const W=function(e){const t=e.collection("MessageChunk");return this.reload=((e,n)=>t.findById(e.chunkId,n)),this.upsert=((e,n)=>{((e,n)=>{const r=Qe.getInstance();r.currentUserId?(e.ownerUserId=r.currentUserId,Q[e.chunkId]=e,t.upsert(Q[e.chunkId].serialize(),(e,t)=>{e?n(e):n(null,t)})):n(S.create(S.Type.ERROR_SETUP_MISSING))})(e,(e,t)=>{e?n(e):n(null,K.createFromJson(t))})}),this.remove=((e,n)=>{((e,n)=>{Qe.getInstance().currentUserId?(Q[e]&&delete Q[e],t.remove(e,(e,t)=>{e?n(e):n(null,t)})):n(S.create(S.Type.ERROR_SETUP_MISSING))})(e,t=>{t?n(t):n(null,e)})}),this.clear=(e=>(e=>{Q={},t.clear(t=>e(t))})(e)),this.getChunkByTimestamp=((e,n,r,s)=>{const i=Qe.getInstance();if(i.currentUserId){const a=new Qe.LocalDB.Query({ownerUserId:i.currentUserId,channelUrl:e,filterKey:z(n),startAt:{"<=":r},endAt:{">=":r}});a.limit=1,a.index={ownerUserId:Qe.LocalDB.Query.Order.ASC,channelUrl:Qe.LocalDB.Query.Order.ASC,filterKey:Qe.LocalDB.Query.Order.ASC,endAt:Qe.LocalDB.Query.Order.DESC},t.find(a,(n,i)=>{if(n)s(n);else{const n=i.length>0?K.createFromJson(i[0]):null;if(n)if(n.hasDefaultFilter())s(null,n);else{const i=new Qe.LocalDB.Query({channelUrl:e,filterKey:z(K.getDefaultFilter()),startAt:{"<=":r}});i.limit=1,i.index={ownerUserId:Qe.LocalDB.Query.Order.ASC,channelUrl:Qe.LocalDB.Query.Order.ASC,filterKey:Qe.LocalDB.Query.Order.ASC,endAt:Qe.LocalDB.Query.Order.DESC},t.find(i,(e,t)=>{if(e)s(e);else{const e=t.length>0?K.createFromJson(t[0]):null;if(e)if(e.endAt>n.endAt)if(e.isOverlap(n))n.extendWithChunk(e),this.upsert(n,s);else{const t=new K(n.channelUrl,n.filter);t.startAt=e.startAt,t.endAt=e.endAt,this.upsert(t,s)}else s(null,n);else s(null,n)}})}else s(null)}})}else s(S.create(S.Type.ERROR_SETUP_MISSING))}),this.mergePreviousChunkOverlap=((e,n)=>{const r=Qe.getInstance();if(r.currentUserId){const s=new Qe.LocalDB.Query({ownerUserId:r.currentUserId,chunkId:{"!=":e.chunkId},channelUrl:e.channelUrl,filterKey:e.filterKey,endAt:{">=":e.startAt}});s.limit=1/0,t.find(s,(r,s)=>{if(r)n(r);else if(s.length>0){const r=new Qe.LocalDB.Query({chunkId:{"/in":s.map(e=>e.chunkId)}});t.removeIf(r,t=>{if(t)n(t);else{for(let t=0;t<s.length;t++)e.extendWithChunk(s[t]);this.upsert(e,n)}})}else this.upsert(e,n)})}else n(S.create(S.Type.ERROR_SETUP_MISSING))}),this};function $(e,t,n){return n?t.channelUrl===e.url&&((!n.messageType||n.messageType===t.messageType)&&((!n.customType||n.customType===t.customType)&&!(Array.isArray(n.senderUserIds)&&n.senderUserIds.length>0&&t.sender&&n.senderUserIds.indexOf(t.sender.userId)<0))):t.channelUrl===e.url}const J=function(){let e=[];return this.addCollection=((t,n)=>{e.push({controller:t,view:n})}),this.removeCollection=(t=>{const n=e.map(e=>e.controller).indexOf(t);n>=0&&(e[n].controller._pause(),e.splice(n,1))}),this.clearCollection=(()=>{for(let t in e)e[t].controller._pause();e=[]}),this.pause=(()=>{for(let t in e)e[t].controller._pause()}),this.resume=(()=>{for(let t in e)e[t].controller._resume()}),this.upsert=((t,n)=>{for(let r in e){const s=e[r];if(s.controller!==n){const e=[];for(let n in t){const r=t[n];$(s.controller.channel,r,s.controller.filter)&&e.push(r)}e.length>0&&s.view.addViewItems(e,{isEventMessage:!0})}}}),this.update=((t,n)=>{for(let r in e){const s=e[r];if(s.controller!==n){const e=[];for(let n in t){const r=t[n];$(s.controller.channel,r,s.controller.filter)&&s.view.messages.map(e=>e.messageId).indexOf(r.messageId)>=0&&e.push(r)}e.length>0&&s.view.addViewItems(e,{isEventMessage:!0})}}}),this.read=((t,n)=>{for(let r in e){const s=e[r];s.controller!==n&&s.controller.channel.url===t.url&&(s.controller.channel=t,s.view.addViewItems(s.view.messages))}}),this.remove=((t,n)=>{for(let r in e){const s=e[r];s.controller!==n&&s.view.removeViewItems(t)}}),this.clear=(()=>{for(let t in e){e[t].view.clearViewItem()}}),this},Y="last-changeLog-token-",X="syncManager_messageManager_channelHandler_"+(new Date).getTime(),Z=100;let ee=null;class te{constructor({sendBird:e,db:t}){if(!ee){A.call("MessageManager()"),ee=this;const n=this.sb=e;this.messageContainer=new L(t,n),this.chunkContainer=new W(t),this.broadcast=new J,this.isFetchingChangeLogByChannelUrl={};const r=new n.ChannelHandler;Object.keys(r).forEach(e=>{r[e]=((...t)=>{switch(e){case"onMessageReceived":A.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!0,ee.messageContainer.upsert(t[1],(e,t)=>{e?S.throw(e):ee.broadcast.upsert([t])});break;case"onReadReceiptUpdated":{A.event(e,t[0].url);const n=t[0];ee.broadcast.read(n);break}case"onMessageUpdated":A.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!1,ee.messageContainer.upsert(t[1],(e,t)=>{e?S.throw(e):ee.broadcast.update([t])});break;case"onMessageDeleted":{A.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message);const n=parseInt(t[1]);ee.messageContainer.remove(n,(e,t)=>{e?S.throw(e):ee.broadcast.remove([t])});break}}})}),n.addChannelHandler(X,r)}return ee}static getInstance(){return ee}static clear(){ee&&ee.sb&&(A.message("MessageManager is cleared"),ee.broadcast.clearCollection(),ee.sb.removeChannelHandler(X),ee=null)}syncChangeLog(e,t=(()=>{})){if(this.isFetchingChangeLogByChannelUrl[e.url])t(S.create(S.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLogByChannelUrl[e.url]=!0,A.call("message syncChangeLog()",e.url);const n=`${Y}${e.url}`;C.get(n).then(r=>{let s="getMessageChangeLogsByToken";const i=[];r?(s="getMessageChangeLogsByToken",i.unshift(r)):(s="getMessageChangeLogsByTimestamp",i.unshift((new Date).getTime()-Z)),A.call(s),e[s](...i,(r,s)=>{if(this.sb.getErrorFirstCallback()){const e=r;r=s,s=e}s?this.isFetchingChangeLogByChannelUrl[e.url]=!1:(A.sync("updated",r.updatedMessages.map(e=>e.messageId)),A.sync("deleted",r.deletedMessageIds),r.updatedMessages.forEach(e=>{ee.messageContainer.getItemWithVisibility(e.messageId,(t,n)=>{if(!t){const t=n.item;e.isVisible=n.isVisible||!1,ee.messageContainer.upsert(e,(e,n)=>{if(e)S.throw(e);else{(!t||!t.isEqual(n))&&ee.broadcast.update([n])}})}})}),r.deletedMessageIds.forEach(e=>{ee.messageContainer.remove(e,t=>{t?S.throw(t):ee.broadcast.remove([e])})}),C.set(n,r.token).then(()=>{r.hasMore?this.syncChangeLog(e,t):(this.isFetchingChangeLogByChannelUrl[e.url]=!1,t())}).catch(n=>{this.isFetchingChangeLogByChannelUrl[e.url]=!1,t(n)}))})}).catch(n=>{this.isFetchingChangeLogByChannelUrl[e.url]=!1,t(n)})}}start(){ee.broadcast.resume()}stop(){ee.broadcast.pause()}clearCache(e){ee.messageContainer.clear(()=>{ee.chunkContainer.clear(()=>{C.getKeys().then(t=>{const n=[];t.forEach(e=>{e.startsWith(Y)&&n.push(C.remove(e))}),Promise.all(n).then(()=>e()).catch(t=>{A.error(t),e(t)})}).catch(t=>e(t))})})}reset(e){ee?(ee.broadcast.clear(),ee.clearCache(e)):e(null)}}const ne=6e4,re=200;class se{constructor(){this.locked=!1,this.lockedAt=(new Date).getTime()+ne}isLocked(){return this.locked}lock(e){this.locked?setTimeout(()=>{(new Date).getTime()-this.lockedAt<ne&&this.lock(e)},re):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(()=>this.unlock()))}unlock(){this.locked=!1,this.lockedAt=(new Date).getTime()+ne}}const ie=100,ae=500;class oe{constructor(e){this.worker=e,this.state=oe.State.PAUSED,this.isLoading=!1,this.shared=0,this.retry=0,this.retryLimit=3,this.subscribes={}}static get State(){return{RUNNING:"running",PAUSED:"paused",END:"end"}}start(e,t=!1){(t||this.state!==oe.State.END)&&(this.isLoading||(this.isLoading=!0,this.state=oe.State.RUNNING,this.worker(e,(t,n)=>{A.sync("background sync result: err=",t,"res=",n),t?(this.isLoading=!1,this.retry<this.retryLimit?(this.retry++,setTimeout(()=>this.start(e),ae)):this.state=oe.State.PAUSED):(this.retry=0,this.flush(t,n),this.state===oe.State.RUNNING&&(n.hasMore?setTimeout(()=>{this.state===oe.State.RUNNING&&this.start(n.nextTs)},ie):this.state=oe.State.END),this.isLoading=!1)})))}pause(){this.isLoading=!1,this.state=oe.State.PAUSED}end(){this.isLoading=!1,this.state=oe.State.END}flush(e=null,t){A.sync("background sync flush:",Object.keys(this.subscribes).length+" subscribes");for(let n in this.subscribes)this.subscribes[n](e,t);this.subscribes={}}subscribe(e,t){return!this.subscribes[e]&&(this.subscribes[e]=t,!0)}}function ce(){this.onChannelEvent=((e,t)=>{})}function le(){this.onMessageEvent=((e,t)=>{})}const ue={INSERT:"insert",UPDATE:"update",MOVE:"move",REMOVE:"remove",CLEAR:"clear"},he={INSERT:"insert",UPDATE:"update",REMOVE:"remove",CLEAR:"clear"},de="channel-collection-handler",fe=new c.a,pe=new c.a,ge=new c.a,me=new c.a,ye=new c.a,be=e=>{const t=F.getInstance();if(t){const n=e.query,r=n.filterKey;return t.channelSyncByFilter[r]||(t.channelSyncByFilter[r]=new oe((r,s)=>{A.call("channel syncChannel()",n.filterKey,n.hasNext,n._token),n.hasNext?(n.limit=100,n.next((r,i)=>{if(t.sb.getErrorFirstCallback()&&([i,r]=[r,i]),A.sync("channel",i,r&&r.length>0?"\n"+r.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"):""),i)s(i);else{const i=pe.get(e);let a=0,o=null;for(let e=0;e<r.length;e++)t.channelContainer.insert(r[e],e=>{if(o=o||e,++a===r.length)if(o)s(o);else{const e=i.findChannelEdges(r);e.end&&(n.savepoint=e.end+""),t.queryContainer.upsert(n,e=>{e?s(e):s(null,{count:r.length,nextTs:0,hasNext:n.hasNext})})}})}})):s(null,{count:0,nextTs:0,hasNext:!1})})),t.channelSyncByFilter[r]}return null},Ie=e=>{const t=F.getInstance();if(t){if(!t.changeLogSync){const n=e.query;t.changeLogSync=new oe((e,r)=>{t.syncChangeLog(n,e=>{r(e,{count:0,nextTs:0,hasNext:!1})})})}return t.changeLogSync}return null};class ve{constructor(){this.collection=null,this.channels=[],this.mutex=new se,this.viewOffset=null}attachCollection(e){this.collection=e}compareWithChannel(e,t){let n="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":n="createdAt";break;case"channel_name_alphabetical":n="name"}return this.compareWithOffset(e,t[n])}compareWithOffset(e,t){switch(this.collection.query.order){case"latest_last_message":return e.lastMessageUpdatedAt-t;case"chronological":return e.createdAt-t;case"channel_name_alphabetical":return t.localeCompare(e.name);default:return e.lastMessageUpdatedAt-t}}isAbove(e,t){return this.compareWithOffset(e,t)>0}isBelow(e,t){return this.compareWithOffset(e,t)<0}findChannelEdges(e){let t="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":t="createdAt";break;case"channel_name_alphabetical":t="name"}const n={start:null,end:null};for(let r in e)n.start&&!this.isAbove(e[r],n.start)||(n.start=e[r][t]),n.end&&!this.isBelow(e[r],n.end)||(n.end=e[r][t]);return n}refreshViewOffset(){const e=this.findChannelEdges(this.channels);this.viewOffset=e.end}addViewItems(e,t={}){const n=[],r=[],s=[],i=[],a=ye.get(this.collection);this.mutex.lock(o=>{for(let a in e){const o=e[a],c=j(o,this.channels),l=B(o,this.collection.query,this.channels);let u=!1;t.isEventChannel&&(this.viewOffset?this.isBelow(o,this.viewOffset)&&(u=!0):t.isChangeLogEvent||(this.collection.query.hasNext||this.collection.query.savepoint)&&(u=!0));let h=c<0?ue.INSERT:ue.UPDATE;switch(c<0?u||(l<this.channels.length?this.channels.splice(l,0,o):this.channels.push(o)):c!==l?l<this.channels.length?(h=ue.MOVE,this.channels.splice(c,1),l>c?this.channels.splice(l-1,0,o):this.channels.splice(l,0,o)):(h=ue.REMOVE,this.channels.splice(c,1)):this.channels[c]=o,h){case ue.INSERT:u||n.push(o);break;case ue.UPDATE:r.push(o);break;case ue.MOVE:s.push(o);break;case ue.REMOVE:i.push(o)}}if(this.refreshViewOffset(),n.length>0){A.view("channel",ue.INSERT,"\n"+n.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"));for(const e in a)a[e].onChannelEvent(ue.INSERT,n)}if(r.length>0){A.view("channel",ue.UPDATE,"\n"+r.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"));for(const e in a)a[e].onChannelEvent(ue.UPDATE,r)}if(s.length>0){A.view("channel",ue.MOVE,"\n"+s.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"));for(const e in a)a[e].onChannelEvent(ue.MOVE,s)}if(i.length>0){A.view("channel",ue.REMOVE,"\n"+i.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"));for(const e in a)a[e].onChannelEvent(ue.REMOVE,i)}o()})}removeViewItems(e){const t=ye.get(this.collection);this.mutex.lock(n=>{const r=[];for(let t in e){const n=e[t],s=this.channels.map(e=>e.url).indexOf(n.url);s>=0&&(this.channels.splice(s,1),r.push(n))}if(r.length>0){A.view("channel",ue.REMOVE,"\n"+r.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"));for(const e in t)t[e].onChannelEvent(ue.REMOVE,r)}n()})}clearViewItem(){this.channels=[];const e=ye.get(this.collection);this.mutex.lock(t=>{const n=ue.CLEAR;A.view("channel",n);for(const t in e)e[t].onChannelEvent(n);t()})}}class we{constructor(e){const t=new ve,n=F.getInstance();if(!n)return null;this.collectionId=G(),this.sendBird=n.sb,this.type="MyGroupChannelListQuery",this.limit=e.limit,this.query=e,this.query.filterKey=n.queryContainer.createFilterKey(this.query),this._isLoading=!1,t.attachCollection(this),n.broadcast.addCollection(this,t),pe.set(this,t),fe.set(this,n.broadcast),ge.set(this,n.channelContainer),me.set(this,n.queryContainer),ye.set(this,{}),be(this).shared++,Ie(this).shared++,n.queryContainer.getItem(this.query.filterKey,(t,r)=>{t?S.throw(t):(r&&(this.query._token=r._token,this.query.hasNext=r.hasNext,this.query.savepoint=r.savepoint,this.query.updatedAt=r.updatedAt),n.queryContainer.upsert(e,(e,t)=>{e?S.throw(e):(this.query=t,this._resume(),A.message(`channel collection ${this.collectionId} is created.`))}))})}static get CollectionHandler(){return ce}static get Action(){return ue}get channels(){return pe.get(this).channels}_pause(){A.call("channel sync pause",this.collectionId);const e=be(this),t=Ie(this);e&&e.pause(),t&&t.pause()}_resume(){A.call("channel sync resume",this.collectionId);const e=be(this),t=Ie(this);e&&e.start(),t&&t.start()}fetch(e){if(!this._isLoading)return this._isLoading=!0,H(e=>{A.call("fetch()");const t=pe.get(this),n=ge.get(this),r=this.sendBird,s={ownerUserId:Qe.getInstance().currentUserId};if(this.query.includeEmpty||(s.lastMessage={"!=":null}),this.query.nicknameContainsFilter&&(s.members={"/where":e=>{for(let t in e)if(e[t].nickname.indexOf(this.query.nicknameContainsFilter)>=0)return!0;return!1}}),this.query.userIdsFilter.length>0&&(s.members={"/where":e=>{const t=e.map(e=>e.userId);return this.query.userIdsFilterExactMatch?t.length===this.query.userIdsFilter.length&&this.query.userIdsFilter.every(e=>t.indexOf(e)>=0):"AND"===this.query.queryType?this.query.userIdsFilter.every(e=>t.indexOf(e)>=0):"OR"===this.query.queryType&&this.query.userIdsFilter.reduce((e,n)=>e=e||t.indexOf(n)>=0,!1)}}),this.query.channelNameContainsFilter&&(s.name={"/regex":new RegExp(this.query.channelNameContainsFilter)}),this.query.channelUrlsFilter.length>0&&(s.url={"/in":this.query.channelUrlsFilter}),this.query.memberStateFilter!==r.GroupChannel.memberStateFilter.ALL)switch(this.query.memberStateFilter){case r.GroupChannel.memberStateFilter.JOINED:s.myMemberState=r.GroupChannel.memberStateFilter.JOINED;break;case r.GroupChannel.memberStateFilter.INVITED:case r.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case r.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:s.myMemberState={"/in":[r.GroupChannel.memberStateFilter.INVITED,r.GroupChannel.memberStateFilter.INVITED_BY_FRIEND,r.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND]}}if("string"==typeof this.query.customTypeFilter&&this.query.customTypeFilter&&(s.customType=this.query.customTypeFilter),Array.isArray(this.query.customTypesFilter)&&this.query.customTypesFilter.length>0&&(s.customType={"/in":this.query.customTypesFilter}),"string"==typeof this.query.customTypeStartsWithFilter&&this.query.customTypeStartsWithFilter&&(s.customType={"/regex":new RegExp(`^${this.query.customTypeStartsWithFilter}`)}),this.query.superChannelFilter!==r.GroupChannel.superChannelFilter.ALL)switch(this.query.superChannelFilter){case r.GroupChannel.superChannelFilter.SUPER:s.isSuper=!0;break;case r.GroupChannel.superChannelFilter.NONSUPER:s.isSuper=!1}if(this.query.publicChannelFilter!==r.GroupChannel.publicChannelFilter.ALL)switch(this.query.publicChannelFilter){case r.GroupChannel.publicChannelFilter.PUBLIC:s.isPublic=!0;break;case r.GroupChannel.publicChannelFilter.PRIVATE:s.isPublic=!1}if(this.query.unreadChannelFilter!==r.GroupChannel.UnreadChannelFilter.ALL)switch(this.query.unreadChannelFilter){case r.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:s.unreadMessageCount={">":0}}if("all"!=this.query.hiddenChannelFilter)switch(this.query.hiddenChannelFilter){case r.GroupChannel.HiddenChannelFilter.UNHIDDEN:s.hiddenState=r.GroupChannel.HiddenState.UNHIDDEN;break;case r.GroupChannel.HiddenChannelFilter.HIDDEN:s.hiddenState={"/in":[r.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE,r.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE]};break;case r.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:s.hiddenState=r.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE;break;case r.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:s.hiddenState=r.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE}let i=null,a=!0;switch(this.query.order){case"latest_last_message":!this.query.hasNext&&this.query.savepoint&&(s.lastMessageUpdatedAt={">=":parseInt(this.query.savepoint)}),i={ownerUserId:1,lastMessageUpdatedAt:-1};break;case"chronological":!this.query.hasNext&&this.query.savepoint&&(s.createdAt={">=":parseInt(this.query.savepoint)}),i={ownerUserId:1,createdAt:-1};break;case"channel_name_alphabetical":!this.query.hasNext&&this.query.savepoint&&(s.name={"<=":this.query.savepoint}),i={ownerUserId:1,name:1},a=!1;break;default:!this.query.hasNext&&this.query.savepoint&&(s.lastMessageUpdatedAt={">=":parseInt(this.query.savepoint)}),i={ownerUserId:1,lastMessageUpdatedAt:-1}}const o=be(this),c=(e,r)=>{n.query(s,{offset:t.channels.length,limit:e,index:i,desc:a},(n,s)=>{n?(this._isLoading=!1,r(n)):(this._isLoading=!1,s.sort((e,n)=>t.compareWithChannel(e,n)>0),s.length>0&&t.addViewItems(s),s.length<e&&l(e-s.length),r(null,s))})},l=e=>{o.state!==oe.State.END&&(A.sync("subscribe channel",this.collectionId),o.subscribe(this.collectionId,t=>{t?A.error(t):(A.sync("flush channel"),c(e,e=>{e&&A.error(e)}))}))};c(this.limit,(t,n)=>{A.cache("fetch channel",t,n.map(e=>e.url)),e(t)}),o.state===oe.State.PAUSED&&this._resume()},e);A.error("fetch() is loading"),e(S.create(S.Type.ERROR_DUPLICATED_FETCH))}remove(){fe.get(this).removeCollection(this);const e=be(this),t=Ie(this);e&&(e.shared--,0===e.shared&&e.pause()),t&&(t.shared--,0===t.shared&&t.pause())}setCollectionHandler(e){const t=ye.get(this);e instanceof ce&&(t[de]=e)}removeCollectionHandler(){const e=ye.get(this);e[de]&&delete e[de]}}const Ce=new c.a,ke=new c.a,Ee=new c.a,Ae=new c.a,Se=new c.a,Te=new c.a,Oe=new c.a,xe=new c.a,Me="message-collection-handler",Ue=300,_e=50,De=100,Re=100,Ne=50;class Fe{constructor(){this.collection=null,this.messages=[],this.prevTempMessages=[],this.nextTempMessages=[],Ce.set(this,{}),this.currentChunk=null,this.viewRange={start:0,end:0}}attachCollection(e){this.collection=e}addViewItems(e,t={}){const n=xe.get(this.collection),r=Ce.get(this),s=Oe.get(this.collection),i=[],a=[],o=[];for(let n in e){const c=e[n];let l=!0,u=!0;if(t.isEventMessage){const e=s.state===oe.State.END,t=!this.currentChunk||this.currentChunk.endAt<=this.viewRange.end,n=0===this.viewRange.end;l=e&&t||!this.currentChunk||n}const h=this.collection.sendBird.currentUser?this.collection.channel.getReadReceipt(c):r[c.messageId]||0;if(r[c.messageId]||(r[c.messageId]=h),l){const e=P(c,this.messages),t=V(c,this.messages);if(e>=0&&this.messages[e].isEqual(c)&&r[c.messageId]===h)continue;r[c.messageId]=h,c.messageId&&(this.viewRange.start=this.viewRange.start>0?Math.min(this.viewRange.start,c.createdAt):c.createdAt,this.viewRange.end=this.viewRange.end>0?Math.max(this.viewRange.end,c.createdAt):c.createdAt);let n=null;if(e<0)n=he.INSERT,this.messages.splice(t,0,c),u&&this.nextTempMessages.push(c);else if(c.messageId){const r=this.messages[e];if(r.messageId)this.messages[e]=c,n=he.UPDATE;else{this.messages.splice(e,1),o.push(r);const s=e<t?1:0;this.messages.splice(t-s,0,c),n=he.INSERT}}switch(n){case he.INSERT:i.push(c);break;case he.UPDATE:a.push(c)}}}if(o.length>0){A.view("message",he.REMOVE,o.map(e=>e.messageId+" "+e.createdAt));for(const e in n)n[e].onMessageEvent(he.REMOVE,o)}if(i.length>0){A.view("message",he.INSERT,i.map(e=>e.messageId+" "+e.createdAt));for(const e in n)n[e].onMessageEvent(he.INSERT,i)}if(a.length>0){A.view("message",he.UPDATE,a.map(e=>e.messageId+" "+e.createdAt));for(const e in n)n[e].onMessageEvent(he.UPDATE,a)}}removeViewItems(e,t=!1){const n=xe.get(this.collection),r=Ce.get(this),s=[];for(let n in e){const i=e[n];for(let e in this.messages)if(i===this.messages[e].messageId||t&&i===this.messages[e].reqId){"number"==typeof r[i]&&delete r[i];const t=this.messages.splice(e,1);s.push(...t);break}}if(this.viewRange.start=this.messages.length>0?this.messages[0].createdAt:0,this.viewRange.end=this.messages.length>0?this.messages[this.messages.length-1].createdAt:0,s.length>0){A.view("message",he.REMOVE,s.map(e=>e.messageId));for(const e in n)n[e].onMessageEvent(he.REMOVE,s)}}clearPreviewItem(){const e=xe.get(this.collection),t=[];for(let e in this.messages)0===this.messages[e].messageId&&t.push({index:parseInt(e),item:this.messages[e]});for(let e=t.length-1;e>=0;e--){const n=t[e];this.messages.splice(n.index,1)}A.view("message",he.REMOVE,"preview message");for(const n in e)e[n].onMessageEvent(he.REMOVE,t.map(e=>e.item))}clearViewItem(){this.currentChunk=null,this.messages=[],Ce.set(this,{}),this.viewRange.start=0,this.viewRange.end=0;const e=xe.get(this.collection),t=he.CLEAR;A.view("message",t);for(const n in e)e[n].onMessageEvent(t)}}class Le{constructor(e,t,n=(new Date).getTime()){const r=te.getInstance();if(!r)return null;{if(this.collectionId=G(),this.sendBird=r.sb,this.channel=e,this.limit=Ne,this.filter=K.getDefaultFilter(),t&&Object.keys(t).length>0)for(let e in t)this.filter.hasOwnProperty(e)&&(this.filter[e]=t[e]);this.viewpoint=n,this._isLoading={prev:!1,next:!1};const s=new Fe;s.attachCollection(this),Ee.set(this,s),r.broadcast.addCollection(this,s),ke.set(this,r.broadcast),Ae.set(this,r.messageContainer),Se.set(this,r.chunkContainer),xe.set(this,{}),Te.set(this,null),Oe.set(this,null);const i=new se,a=(t,n,a)=>{A.sync("message synchronize() begin",t,n);let o=null,c=0,l=[n];switch(t){case"prev":o="getPreviousMessagesByTimestamp",c=De,l.push(!0),l.push(De);break;case"next":o="getNextMessagesByTimestamp",c=Re,l.push(!0),l.push(Re);break;case"prevnext":o="getPreviousAndNextMessagesByTimestamp",c=2*_e,l.push(_e),l.push(_e)}l.push(!1),l.push(this.filter.messageType||""),l.push(this.filter.customType||""),l.push(this.filter.senderUserIds||[]),l.push(this.filter.includeMetaArray||!1),e[o](...l,(e,o)=>{r.sb.getErrorFirstCallback()&&([o,e]=[e,o]),o?(this._pause(),a(o)):(A.sync("message synchronize() end",t,n,e.map(e=>e.messageId)),i.lock(n=>{const i=[],o={startAt:1/0,endAt:0};if(e.length>0){for(let t in e)e[t].isVisible=!0,i.push(new Promise((n,s)=>{r.messageContainer.upsert(e[t],e=>e?s(e):n())})),o.startAt=Math.min(o.startAt,e[t].createdAt),o.endAt=Math.max(o.endAt,e[t].createdAt);s.currentChunk&&s.currentChunk.isOverlap(o)||(s.currentChunk=new K(this.channel.url,this.filter),A.message("chunk is created",s.currentChunk.startAt,s.currentChunk.endAt));const l=s.currentChunk;l.extendWithChunk(o),A.message("currentChunk is extended",l.startAt,l.endAt),r.chunkContainer.mergePreviousChunkOverlap(l,r=>{r?(n(),a(r)):(A.message("currentChunk merged previous chunks",l.startAt,l.endAt),Promise.all(i).then(()=>{n(),a(null,{count:e.length,nextTs:"prev"===t?l.startAt:l.endAt,hasMore:e.length>=c})}).catch(e=>{n(),a(e)}))})}else n(),a(null,{count:0,nextTs:0,hasMore:!1})}))})},o=new oe((e,t)=>a("prev",e,t));o.shared++,Te.set(this,o);const c=new oe((e,t)=>a("next",e,t));o.shared++,Oe.set(this,c),r.chunkContainer.getChunkByTimestamp(this.channel.url,this.filter,this.viewpoint,(e,t)=>{e||(t&&(s.currentChunk=t),s.currentChunk?this._resume():a("prevnext",this.viewpoint,(e,t)=>{e||setTimeout(()=>{o.flush(e,t),c.flush(e,t),t.count<_e?(o.end(),c.end()):this._resume()},Ue)}),A.message(`message collection ${this.collectionId} is created.`))})}}static get CollectionHandler(){return le}static get Action(){return he}static create(e,t,n,r){"function"==typeof n&&(r=n,n=(new Date).getTime());const s=F.getInstance();return H(r=>{s.channelContainer.getItem(e,(s,i)=>{if(s)r(s);else if(i)r(null,new Le(i,t,n));else{const s=F.getInstance();s.sb.GroupChannel.getChannel(e,(e,i)=>{s.sb.getErrorFirstCallback()&&([i,e]=[e,i]),i?r(i):r(null,new Le(e,t,n))})}})},r)}get messages(){return Ee.get(this).messages}_pause(){A.call("message sync pause",this.collectionId);const e=Ee.get(this),t=Te.get(this),n=Oe.get(this);t&&t.pause(),n&&n.pause(),e.currentChunk=null}_resume(){A.call("message sync resume",this.collectionId),te.getInstance().syncChangeLog(this.channel,()=>{const e=Ee.get(this),t=Te.get(this),n=Oe.get(this);if(t){const n=e.currentChunk?e.currentChunk.startAt:this.viewpoint;t.start(n)}if(n){const t=e.currentChunk?e.currentChunk.endAt:this.viewpoint;n.start(t,!0)}})}fetch(e,t){const n=Ee.get(this),r=Ae.get(this),s=Se.get(this);return this._isLoading[e]?H(e=>e(S.create(S.Type.ERROR_DUPLICATED_FETCH)),t):(this._isLoading[e]=!0,H(t=>{A.call("fetch()",e);let i=null,a=this.viewpoint,o=this.limit,c=!1,l=a,u=null,h=null;switch(e){case"prev":i=Te.get(this),n.viewRange.start>0&&(a=n.viewRange.start),n.currentChunk&&(l=Math.max(n.currentChunk.startAt,a)),u=n.prevTempMessages,h=r.loadPreviousMessages,c=!0;break;case"next":i=Oe.get(this),n.viewRange.end>0&&(a=n.viewRange.end),n.currentChunk&&(l=Math.min(n.currentChunk.endAt,a)),u=n.nextTempMessages,h=r.loadNextMessages;break;default:return void t(S.create(S.Type.ERROR_INVALID_PARAMETER))}const d=(t,r)=>{A.message("waiting for synchronization..."),h(this.channel.url,this.filter,t,{limit:o,desc:c},(t,s)=>{t?(this._isLoading[e]=!1,r(t)):(A.cache("temp message",e,s.map(e=>e.messageId)),u.push(...s),n.addViewItems(s),this._isLoading[e]=!1,r(null))});const a=l;A.sync("subscribe message",this.collectionId,e,t),i.subscribe(this.collectionId,r=>{r?A.error(r):(A.sync("flush message",e,t),s.getChunkByTimestamp(this.channel.url,this.filter,t,(t,r)=>{if(!t)if(r&&(n.currentChunk=r),n.currentChunk){const t=n.currentChunk;h(this.channel.url,this.filter,a,{limit:o,desc:c},(r,s)=>{if(r)A.error(r);else{A.cache("flush message",e,a,s.map(e=>e.messageId)),n.clearPreviewItem();const r=[],i=[];for(let e in s)if(t.containsMessage(s[e])){const t=n.messages.map(e=>e.messageId).indexOf(s[e].messageId);(t<0||!n.messages[t].isEqual(s[e]))&&r.push(s[e])}for(let e in u)n.messages.map(e=>e.messageId).indexOf(u[e].messageId)<0&&i.push(u[e]);for(;u.length>0;)u.pop();i.length>0&&n.removeViewItems(i.map(e=>e.messageId)),r.length>0&&n.addViewItems(r)}})}else A.error(t)}))})};s.getChunkByTimestamp(this.channel.url,this.filter,a,(r,s)=>{if(r)this._isLoading[e]=!1,t(r);else if(s&&(n.currentChunk=s),n.currentChunk){const r=n.currentChunk;A.message("chunk is selected",r),h(this.channel.url,this.filter,a,{limit:o,desc:c},(s,i)=>{if(s)this._isLoading[e]=!1,t(s);else{const s=[],c=[];A.cache("fetch message",e,a,i.map(e=>e.messageId));let l=!1;for(let e in i)if(r.containsMessage(i[e])){l=!0;const t=n.messages.map(e=>e.messageId).indexOf(i[e].messageId);(t<0||!n.messages[t].isEqual(i[e]))&&s.push(i[e])}if(!l){for(let e in u)n.messages.map(e=>e.messageId).indexOf(u[e].messageId)<0&&c.push(u[e]);for(;u.length>0;)u.pop()}s.length>0&&n.addViewItems(s),c.length>0&&n.removeViewItems(c.map(e=>e.me)),i.length<o?(o-=i.length,d(a,t)):(this._isLoading[e]=!1,t(null))}})}else d(a,t)}),i.state===oe.State.PAUSED&&this._resume()},t))}resetViewpointTimestamp(e=(new Date).getTime()){if("number"==typeof e&&e>=0){A.call("resetViewpointTimestamp()",e);const t=Ee.get(this);t.viewRange.start<=e&&e<=t.viewRange.end?t.currentChunk&&!t.currentChunk.contains(e)&&(t.currentChunk=null):(t.currentChunk=null,t.clearViewItem()),this.viewpoint=e,this._resume()}else A.error("resetViewpointTimestamp()","ts should be number type and greater than or equal to 0."),S.throw(S.create(S.Type.ERROR_INVALID_PARAMETER))}remove(){const e=Ee.get(this);ke.get(this).removeCollection(this),e.currentChunk=null;const t=Te.get(this),n=Oe.get(this);t&&(t.shared--,0===t.shared&&t.pause()),n&&(n.shared--,0===n.shared&&n.pause())}appendMessage(e){if(e){A.call("appendMessage()",e.messageId);const t=Qe.getInstance(),n=Ee.get(this);if(e.sender&&e.sender.userId===t.currentUserId)if(e.messageId){const t=ke.get(this),n=Ae.get(this);e.isVisible=!0,n.upsert(e,(e,n)=>{e||t.upsert([n])});const r=F.getInstance();r.channelContainer.getItem(e.channelUrl,(t,n)=>{t?S.throw(t):n&&(!n.lastMessage||n.lastMessage.createdAt<=e.createdAt)&&(n.lastMessage=e,r.channelContainer.upsert(n,(e,t)=>{e?S.throw(e):r.broadcast.upsert([t])}))})}else n.addViewItems([e],{isEventMessage:!0})}else A.error("appendMessage()",`Message is expected but ${e} is given.`),S.throw(S.create(S.Type.ERROR_INVALID_PARAMETER))}updateMessage(e){if(e){A.call("updateMessage()",e.messageId);const t=Qe.getInstance(),n=Ee.get(this);if(e.sender&&e.sender.userId===t.currentUserId)if(e.messageId){const t=ke.get(this),n=Ae.get(this);e.isVisible=!0,n.upsert(e,(e,n)=>{e||t.update([n])});const r=F.getInstance();r.channelContainer.getItem(e.channelUrl,(t,n)=>{t?S.throw(t):n&&n.lastMessage&&n.lastMessage.messageId===e.messageId&&(n.lastMessage=e,r.channelContainer.upsert(n,(e,t)=>{e?S.throw(e):r.broadcast.update([t])}))})}else n.addViewItems([e])}else A.error("updateMessage()",`Message is expected but ${e} is given.`),S.throw(S.create(S.Type.ERROR_INVALID_PARAMETER))}deleteMessage(e){if(e){A.call("deleteMessage()",e.messageId);const t=Qe.getInstance(),n=Ee.get(this);e.sender&&e.sender.userId===t.currentUserId&&(e.messageId||n.removeViewItems([e.reqId],!0))}else A.error("deleteMessage()",`Message is expected but ${e} is given.`),S.throw(S.create(S.Type.ERROR_INVALID_PARAMETER))}setCollectionHandler(e){const t=xe.get(this);e instanceof le&&(t[Me]=e)}removeCollectionHandler(){const e=xe.get(this);e[Me]&&delete e[Me]}}n.d(t,"default",function(){return Qe});let je=null,Be=null,Pe=null,Ve=I,qe=null,Ge=null,He=null;class Qe{constructor(){return Be||(Be=this),Be}static get sendBird(){return je}static set sendBird(e){je=e}static get LocalDB(){return Ve}static setup(e,t){return A.call("init()"),H(t=>{if(C.init(),je)if(Be=new Qe,je.currentUser&&e!==je.currentUser.userId&&(A.warning("Different user ID: clear cache"),Be.clearCache()),Pe=e,F.clear(),Ge=null,te.clear(),He=null,qe)A.cache("Database is open"),Ge=new F({sendBird:je,db:qe}),He=new te({sendBird:je,db:qe}),Qe.ChannelCollection=we,Qe.MessageCollection=Le,t(null);else{const e=new Ve("sbsync.db",3);e.schema("GroupChannel",{key:"url",index:[{ownerUserId:Ve.Query.Order.ASC,lastMessageUpdatedAt:Ve.Query.Order.DESC},{ownerUserId:Ve.Query.Order.ASC,createdAt:Ve.Query.Order.DESC},{ownerUserId:Ve.Query.Order.ASC,name:Ve.Query.Order.ASC}]}).schema("GroupChannelListQuery",{key:"filterKey",index:[{ownerUserId:Ve.Query.Order.ASC,updatedAt:Ve.Query.Order.DESC}]}).schema("MessageChunk",{key:"chunkId",index:[{ownerUserId:Ve.Query.Order.ASC,channelUrl:Ve.Query.Order.ASC,filterKey:Ve.Query.Order.ASC,endAt:Ve.Query.Order.DESC}]}).schema("Message",{key:"messageId",index:[{ownerUserId:Ve.Query.Order.ASC,channelUrl:Ve.Query.Order.ASC,createdAt:Ve.Query.Order.DESC}]}).build().then(()=>{A.cache("Database is created"),Ge=new F({sendBird:je,db:e}),He=new te({sendBird:je,db:e}),qe=e,Qe.ChannelCollection=we,Qe.MessageCollection=Le,t(null)}).catch(e=>t(e))}else t(S.create(S.Type.ERROR_SETUP_MISSING))},t)}static getInstance(){return Be}static useReactNative(e){C.useReactNative(e),r.a.Storage=e,Ve=r.a}get currentUserId(){return je&&je.currentUser?je.currentUser.userId:Pe}resumeSync(){A.call("resumeSync()"),Ge&&Ge.start(),He&&He.start()}pauseSync(){A.call("pauseSync()"),Ge&&Ge.stop(),He&&He.stop()}clearCache(e){return A.call("clearCache()"),H(e=>{const t=[];Ge&&t.push(new Promise((e,t)=>{Ge.reset(n=>n?t(n):e())})),He&&t.push(new Promise((e,t)=>{He.reset(n=>n?t(n):e())})),t.length>0?Promise.all(t).then(()=>e(null)).catch(t=>e(t)):e(null)},e)}reset(e){return A.call("reset()"),H(e=>{this.clearCache(t=>{t||(F.clear(()=>{Ge=null}),te.clear(()=>{He=null})),e(t)})},e)}}}]).default});