!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.SendBirdSyncManager=t():e.SendBirdSyncManager=t()}(window,function(){return function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=95)}([function(e,t,n){n(60),n(63),n(84);var s=n(94);e.exports=s.WeakMap},function(e,t,n){"use strict";function s(e,t){const n=typeof e,r=typeof t;return!e||!t||"object"!==n||n!==r||e instanceof Date?e instanceof Date?e.getTime()===t.getTime():"function"===n&&"function"===r||e===t:Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>s(e[n],t[n]))}function r(e){return null!=e}function i(e,t,n=!1){if(r(e)){if(!r(t))return n?-1:1;if(typeof e==typeof t&&e!==t){const n=typeof e;if("boolean"===n)return e?1:-1;if("number"===n)return e>t?1:-1;if("string"===n)return e.localeCompare(t);if(e instanceof Date&&t instanceof Date&&e.getTime()!==t.getTime())return e.getTime()>t.getTime()?1:-1}}else if(r(t))return n?1:-1;return 0}function a(e,t,n){if(!t)return new Promise((t,s)=>{e((e,r)=>{n&&"function"==typeof n&&n(),e?s(e):t(r)})});e((e,s)=>{n&&"function"==typeof n&&n(),t(e,s)})}n.d(t,"b",function(){return s}),n.d(t,"a",function(){return i}),n.d(t,"c",function(){return a})},function(e,t,n){(function(t){var n="object",s=function(e){return e&&e.Math==Math&&e};e.exports=s(typeof globalThis==n&&globalThis)||s(typeof window==n&&window)||s(typeof self==n&&self)||s(typeof t==n&&t)||Function("return this")()}).call(this,n(23))},function(e,t,n){"use strict";n.d(t,"a",function(){return h});var s=n(12),r=n(8),i=n(34),a=n(0),o=n.n(a);let c=null;const l=new o.a,u=new o.a;class h{static get Query(){return r.a}static get Storage(){return c}static set Storage(e){c=e}constructor(e,t={}){this.name=e,this.config=new s.a(t),l.set(this,{}),u.set(this,{})}schema(e,t){return l.get(this)[e]=t,this}build(){const e=l.get(this),t=u.get(this);return new Promise((n,s)=>{const r=[];for(let n in e)if(!t[n]){const s=e[n].key||"_id",a=t[n]=new i.a(n,s);r.push(a.init())}Promise.all(r).then(()=>{const r=[];for(let n in t)if(e[n].index&&e[n].index.length>0){const s=t[n];for(let t in e[n].index)r.push(s.ensureIndex(e[n].index[t]))}r.length>0?Promise.all(r).then(()=>{n()}).catch(e=>s(e)):n()}).catch(e=>s(e))})}close(){}drop(){l.set(this,{}),_db.set(this,null),u.set(this,{}),c.clear()}collection(e){const t=u.get(this);return t[e]&&t[e]instanceof i.a?t[e]:null}}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,n){var s=n(2),r=n(17),i=n(28),a=n(62),o=s.Symbol,c=r("wks");e.exports=function(e){return c[e]||(c[e]=a&&o[e]||(a?o:i)("Symbol."+e))}},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t,n){"use strict";(function(e){function s({offset:t,condition:n,progress:s},r=((e,t)=>t(null,!0)),i=(()=>{})){let a=t;!function t(){n(a)?e(()=>{r(a,(e,n)=>{e?i(e):n?(a=s(a),t()):i(null)})}):i(null)}()}n.d(t,"a",function(){return s})}).call(this,n(35).setImmediate)},function(e,t,n){"use strict";var s=n(1);const r=1/0,i=(e,t)=>{let n=!0;if(e)for(let r in t){switch(r){case"/and":n=n&&t[r].reduce((t,n)=>t&&i(e,n),!0);break;case"/or":n=n&&t[r].reduce((t,n)=>t||i(e,n),!1);break;default:{const i=t[r];if("object"==typeof i)for(let t in i)switch(t){case">":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]>i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])>0);break;case">=":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]>=i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])>=0);break;case"<":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]<i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])<0);break;case"<=":n="number"==typeof e[r]&&"number"==typeof i[t]?n&&e[r]<=i[t]:"string"==typeof e[r]&&"string"==typeof i[t]&&(n&&e[r].localeCompare(i[t])<=0);break;case"=":n=n&&e[r]===i[t];break;case"!=":n=n&&e[r]!==i[t];break;case"/in":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[r])>=0;break;case"/nin":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[r])<0;break;case"/like":n=n&&"string"==typeof i[t]&&"string"==typeof e[r]&&e[r].indexOf(i[t])>=0;break;case"/nlike":n=n&&"string"==typeof i[t]&&"string"==typeof e[r]&&e[r].indexOf(i[t])<0;break;case"/regex":n=n&&i[t]instanceof RegExp&&i[t].test(e[r]);break;case"/where":n=n&&i[t](e[r]);break;default:n=n&&Object(s.b)(e[r],i)}else n=n&&e[r]===i}}if(!n)break}else n=!1;return n};class a{static and(...e){return e.length>0?new a({"/and":e}):new a({})}static or(...e){return e.length>0?new a({"/or":e}):new a({})}static get Order(){return{ASC:1,DESC:-1}}constructor(e){this.condition=e,this.offset=0,this.limit=r,this.index=null,this.desc=!1}match(e){return i(e,this.condition)}}t.a=a},function(e,t,n){var s=n(14),r=n(15),i=n(25);e.exports=s?function(e,t,n){return r.f(e,t,i(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t,n){var s=n(4);e.exports=function(e){if(!s(e))throw TypeError(String(e)+" is not an object");return e}},function(e,t,n){"use strict";n.d(t,"a",function(){return c});const s=64,r=200,i=128,a=32;let o=null;class c{constructor(e={}){return o||(o=this),this.batchSize=s,this.batchInterval=r,this.cachedBlockLimit=i,this.cachedBlockFlush=a,this.encryption={encrypt:(e,t)=>t(null,e),decrypt:(e,t)=>t(null,e)},"number"==typeof e.batchSize&&e.batchSize>1&&(this.batchSize=e.batchSize),"number"==typeof e.batchInterval&&e.batchInterval>10&&(this.batchInterval=e.batchInterval),"number"==typeof e.cachedBlockLimit&&e.cachedBlockLimit>0&&(this.cachedBlockLimit=e.cachedBlockLimit),"number"==typeof e.cachedBlockFlush&&e.cachedBlockFlush<this.cachedBlockLimit&&(this.cachedBlockFlush=e.cachedBlockFlush),e.encryption&&e.encryption.hasOwnProperty("encrypt")&&e.encryption.hasOwnProperty("decrypt")&&"function"==typeof e.encryption.encrypt&&"function"==typeof e.encryption.decrypt&&(this.encryption=e.encryption),o}static getInstance(){return o}}},function(e,t,n){var s=n(2),r=n(17),i=n(9),a=n(6),o=n(24),c=n(39),l=n(18),u=l.get,h=l.enforce,d=String(c).split("toString");r("inspectSource",function(e){return c.call(e)}),(e.exports=function(e,t,n,r){var c=!!r&&!!r.unsafe,l=!!r&&!!r.enumerable,u=!!r&&!!r.noTargetGet;"function"==typeof n&&("string"!=typeof t||a(n,"name")||i(n,"name",t),h(n).source=d.join("string"==typeof t?t:"")),e!==s?(c?!u&&e[t]&&(l=!0):delete e[t],l?e[t]=n:i(e,t,n)):l?e[t]=n:o(t,n)})(Function.prototype,"toString",function(){return"function"==typeof this&&u(this).source||c.call(this)})},function(e,t,n){var s=n(10);e.exports=!s(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t,n){var s=n(14),r=n(36),i=n(11),a=n(38),o=Object.defineProperty;t.f=s?o:function(e,t,n){if(i(e),t=a(t,!0),i(n),r)try{return o(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported");return"value"in n&&(e[t]=n.value),e}},function(e,t){e.exports={}},function(e,t,n){var s=n(2),r=n(24),i=n(26),a=s["__core-js_shared__"]||r("__core-js_shared__",{});(e.exports=function(e,t){return a[e]||(a[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.1.3",mode:i?"pure":"global",copyright:"Â© 2019 Denis Pushkarev (zloirock.ru)"})},function(e,t,n){var s,r,i,a=n(40),o=n(2),c=n(4),l=n(9),u=n(6),h=n(27),d=n(19),f=o.WeakMap;if(a){var g=new f,p=g.get,m=g.has,y=g.set;s=function(e,t){return y.call(g,e,t),t},r=function(e){return p.call(g,e)||{}},i=function(e){return m.call(g,e)}}else{var I=h("state");d[I]=!0,s=function(e,t){return l(e,I,t),t},r=function(e){return u(e,I)?e[I]:{}},i=function(e){return u(e,I)}}e.exports={set:s,get:r,has:i,enforce:function(e){return i(e)?r(e):s(e,{})},getterFor:function(e){return function(t){var n;if(!c(t)||(n=r(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return n}}}},function(e,t){e.exports={}},function(e,t,n){var s=n(45),r=n(46);e.exports=function(e){return s(r(e))}},function(e,t,n){"use strict";var s=n(3),r=n(12);class i{constructor(e){this.blockKey=e,this.data=[]}static createKey(e,t=0){return`${e.toLowerCase()}-blk-${t}`}get count(){return this.data.length}get(e){const t=this.indexOf(e);return t>=0?this.data[t].value:null}indexOf(e){for(let t in this.data)if(this.data[t].key===e)return parseInt(t);return-1}add(e,t){const n=this.indexOf(e);n<0?this.data.push({key:e,value:t}):this.data[n]={key:e,value:t}}remove(e){const t=this.indexOf(e);return t>=0&&(this.data.splice(t,1),!0)}static buildFromSerializedData(e,t){const n=new i(e);try{return n.data=JSON.parse(t),n}catch(e){return null}}getSerializedData(){return JSON.stringify(this.data)}}const a=1e4,o=200;class c{constructor(){this.locked=!1,this.lockedAt=0}lock(e){this.locked?setTimeout(()=>{(new Date).getTime()-this.lockedAt>a&&this.unlock(),this.lock(e)},o):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(()=>this.unlock()))}unlock(){this.locked=!1,this.lockedAt=0}}const l="adb-trns-";class u{constructor(e,t={}){const n=r.a.getInstance();this.name=e,this.initialized=!1,this.queue={},this.batchInterval=t.batchInterval||n.batchInterval,this.batchUpdateTimer=null,this.transactionMutex=new c,this.transactionState=u.State.IDLE,this.transactionCount=0,this.encryption=n.encryption,t.encryption&&t.encryption.hasOwnProperty("encrypt")&&t.encryption.hasOwnProperty("decrypt")&&"function"==typeof t.encryption.encrypt&&"function"==typeof t.encryption.decrypt&&(this.encryption=t.encryption)}static get Action(){return{SET:"set",REMOVE:"remove"}}static get State(){return{IDLE:"idle",RUNNING:"running"}}init(e=(()=>{})){this.initialized?e(null):(this.initialized=!0,0===Object.keys(this.queue).length?s.a.Storage.getItem(l+this.name,(t,n)=>{n?this.encryption.decrypt(n,(t,n)=>{t||(this.queue=JSON.parse(n)),e(t)}):e(null)}):e(null))}flush(){this.transactionMutex.lock(e=>{s.a.Storage.setItem(l+this.name,JSON.stringify(this.queue),t=>{if(t)throw e(),t;{const t=[];for(let e in this.queue){const n=this.queue[e];switch(n.action){case u.Action.SET:t.push(new Promise((t,r)=>{this.encryption.encrypt(JSON.stringify(n.data),(n,i)=>{n?r(n):s.a.Storage.setItem(e,i).then(t).catch(r)})}));break;case u.Action.REMOVE:t.push(s.a.Storage.removeItem(e))}}this.batchUpdateTimer=null,Promise.all(t).then(()=>{this.queue={},s.a.Storage.removeItem(l+this.name,()=>{e()})}).catch(t=>{throw e(),t})}})})}startTransaction(){this.transactionState=u.State.RUNNING,this.transactionCount++}endTransaction(){this.transactionState===u.State.RUNNING&&(this.transactionCount--,0===this.transactionCount&&(this.flush(),this.transactionState=u.State.IDLE))}addJob(e,t,n){this.queue[t]={action:e,data:n},this.transactionState===u.State.IDLE&&(this.batchUpdateTimer||(this.batchUpdateTimer=setTimeout(()=>{this.transactionState===u.State.IDLE&&this.flush(),this.batchUpdateTimer=null},this.batchInterval)))}}n.d(t,"a",function(){return d});const h="adb-info-";class d{constructor(e,t={}){const n=r.a.getInstance();this.cachedBlockLimit=t.cachedBlockLimit||n.cachedBlockLimit,this.cachedBlockFlush=t.cachedBlockFlush||n.cachedBlockFlush,this.cacheMutex=new c,this.encryption=n.encryption,t.encryption&&t.encryption.hasOwnProperty("encrypt")&&t.encryption.hasOwnProperty("decrypt")&&"function"==typeof t.encryption.encrypt&&"function"==typeof t.encryption.decrypt&&(this.encryption=t.encryption),this.batchSize=t.batchSize||n.batchSize,this.batchQueue=t.sharedBatchQueue||new u(e,t),this.transaction=null,this.name=e,this.info={},this.blockCache={},this.blockCacheCursor=0,this.currentBlock=null}_findBlockKey(e){return this.info.blockMap[e]}_getBlockFromCache(e){return this.blockCache[e]?this.blockCache[e].block:null}_putBlockToCache(e){this.blockCache[e.blockKey]={seq:this.blockCacheCursor++,block:e};const t=Object.keys(this.blockCache);if(t.length>=this.cachedBlockLimit){t.sort((e,t)=>this.blockCache[e].seq-this.blockCache[t].seq);for(let e in t)this._removeBlockFromCache(t[e])}}_removeBlockFromCache(e){this.blockCache.hasOwnProperty(e)&&delete this.blockCache[e]}_getBlock(e,t){const n=this._getBlockFromCache(e);n?t(null,n):s.a.Storage.getItem(e).then(n=>{n?this.encryption.decrypt(n,(n,s)=>{if(n)t(n);else{const n=i.buildFromSerializedData(e,s);this._putBlockToCache(n),t(null,n)}}):t(null)}).catch(e=>t(e))}_assignNewBlock(e){this.info.cursor++;const t=i.createKey(this.name,this.info.cursor),n=new i(t);this._putBlockToCache(n),this.currentBlock=n,e&&e.key&&(n.add(e.key,e.value),this.info.blockMap[e.key]=t,this.info.count++),this.batchQueue.addJob(u.Action.SET,n.blockKey,n.data),this.batchQueue.addJob(u.Action.SET,h+this.name,this.info)}init(e=(()=>{})){this.batchQueue.init(t=>{t?e(t):s.a.Storage.getItem(h+this.name,(t,n)=>{t?e(t):n?this.encryption.decrypt(n,(t,n)=>{if(t)e(t);else{this.info=JSON.parse(n);const t=i.createKey(this.name,this.info.cursor);this._getBlock(t,(n,s)=>{n||(this.currentBlock=s||new i(t)),e(n,this.info,!1)})}}):(this.info={blockMap:{},cursor:0,count:0},this.info.cursor=-1,this._assignNewBlock(),e(null,this.info,!0))})})}get keys(){return Object.keys(this.info.blockMap)}get count(){return this.info.count}startTransaction(){this.batchQueue.startTransaction()}endTransaction(){this.batchQueue.endTransaction()}getItem(e,t=(()=>{})){const n=this._findBlockKey(e);n?this._getBlock(n,(n,s)=>{!n&&s?t(null,s.get(e)):t(n||new Error("Broken integrity - data not found."))}):t(null,null)}setItem(e,t,n=(()=>{})){const s=this._findBlockKey(e);if(s)this._getBlock(s,(s,r)=>{!s&&r?(r.add(e,t),this.batchQueue.addJob(u.Action.SET,r.blockKey,r.data),n(null)):n(s||new Error("Broken integrity - data not found."))});else{const s=this.currentBlock;s&&s.count<this.batchSize?(s.add(e,t),this.batchQueue.addJob(u.Action.SET,s.blockKey,s.data),this.info.count++,this.info.blockMap[e]=s.blockKey,this.batchQueue.addJob(u.Action.SET,h+this.name,this.info)):this._assignNewBlock({key:e,value:t}),n(null)}}removeItem(e,t=(()=>{})){const n=this._findBlockKey(e);n?this._getBlock(n,(s,r)=>{if(s)t(s);else if(r){r.remove(e)&&(this.info.blockMap.hasOwnProperty(e)&&delete this.info.blockMap[e],this.info.count--),r.data.length>0?this.batchQueue.addJob(u.Action.SET,n,r.data):(this._removeBlockFromCache(n),this.batchQueue.addJob(u.Action.REMOVE,n)),this.batchQueue.addJob(u.Action.SET,h+this.name,this.info),t(null)}else t(new Error("Failed to remove item - data not found."))}):t(new Error("Failed to remove item - data not found."))}clear(e=(()=>{})){for(let e=0;e<=this.info.cursor;e++)this.batchQueue.addJob(u.Action.REMOVE,i.createKey(this.name,e));this.blockCacheCursor=0,this.blockCache={},this.info={blockMap:{},cursor:-1,count:0},this._assignNewBlock(),e(null)}drop(e=(()=>{})){this.clear(()=>{this.batchQueue.addJob(u.Action.REMOVE,h+this.name),e(null)})}}},function(e,t,n){"use strict";n.d(t,"a",function(){return o});var s=n(21),r=n(7),i=n(1);const a="idx-";class o{constructor({collection:e,columns:t={},options:n={}}){this.collection=e,this.columns=t,this.key=o.createKey(this.columns);for(let e in this.columns)this.columns[e]=1;this.store=new s.a(e.name+"-index-"+this.key,n),this.table=[]}static createKey(e){return Object.keys(e).map(t=>`${t}_${e[t]}`).join("__")}get columnNames(){return Object.keys(this.columns)}columnValues(e){return this.columnNames.map(t=>e?e[t]:null)}compareColumnValues(e,t,n=!0){const s=this.columnNames;for(let r=0;r<s.length;r++){const a=s[r],o=this.columns[a],c=Object(i.a)(e[r],t[r],n);if(0!==c)return o*c}return 0}init(e=(()=>{})){this.store.init((t,n,s)=>{t?e(t):s?this.save(e):this.store.getItem(`${a}${this.key}`,(t,n)=>{n&&(this.table=n),e(t)})})}each(e,t=null,n=1){const s=n>0;let i=s?0:this.table.length-1;if(t&&this.table.length>0){const e={start:0,end:this.table.length};let n=i;for(;e.start<e.end;){const r=this.compareColumnValues(this.table[n].key,t,s);if(0===r)break;r>0?e.end=n-1:e.start=n+1,n=parseInt((e.start+e.end)/2)}i=n}let a=!0;Object(r.a)({offset:i,condition:e=>s?e<this.table.length:e>=0,progress:e=>s?e+1:e-1},(t,n)=>{const i=this.table[t];if(i){const t=i.key,o=i.value;Object(r.a)({offset:s?0:o.length-1,condition:e=>s?e<o.length:e>=0,progress:e=>s?e+1:e-1},(n,s)=>{e({key:t,value:o[n]},(e,t)=>{s(e,a=e||t)})},e=>n(e,a))}else n(null,!1)},()=>{e(null,()=>{})})}put(e,t){let n=!1;const s=this.columnValues(t);Object(r.a)({offset:0,condition:e=>e<this.table.length,progress:e=>e+1},(t,r)=>{const i=this.table[t];if(i){const a=this.compareColumnValues(i.key,s);a>0?(this.table.splice(t,0,{key:s,value:[e]}),n=!0,this.save(e=>r(e,!1))):0===a?i.value.indexOf(e)<0?(i.value.push(e),n=!0,this.save(e=>r(e,!1))):r(null,!1):r(null,!0)}else r(null,!1)},()=>{n||(this.table.push({key:s,value:[e]}),this.save())})}update(e,t,n){const s=this.columnValues(t),r=this.columnValues(n);0!==this.compareColumnValues(s,r)&&(this.remove(e,t),this.put(e,n))}remove(e,t){const n=this.columnValues(t);Object(r.a)({offset:0,condition:e=>e<this.table.length,progress:e=>e+1},(t,s)=>{const r=this.table[t];if(r){if(0===this.compareColumnValues(r.key,n)){const n=r.value.indexOf(e);n>=0?(r.value.splice(n,1),0===r.value.length&&this.table.splice(t,1),this.save(e=>s(e,!1))):s(null,!1)}else s(null,!0)}else s(null,!1)},()=>{})}save(e=(()=>{})){this.store.setItem(`${a}${this.key}`,this.table,e)}clear(){this.table=[],this.store.clear()}drop(){this.table=[],this.store.drop()}}},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){var s=n(2),r=n(9);e.exports=function(e,t){try{r(s,e,t)}catch(n){s[e]=t}return t}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t){e.exports=!1},function(e,t,n){var s=n(17),r=n(28),i=s("keys");e.exports=function(e){return i[e]||(i[e]=r(e))}},function(e,t){var n=0,s=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+s).toString(36))}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t,n){var s=n(19),r=n(4),i=n(6),a=n(15).f,o=n(28),c=n(64),l=o("meta"),u=0,h=Object.isExtensible||function(){return!0},d=function(e){a(e,l,{value:{objectID:"O"+ ++u,weakData:{}}})},f=e.exports={REQUIRED:!1,fastKey:function(e,t){if(!r(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!i(e,l)){if(!h(e))return"F";if(!t)return"E";d(e)}return e[l].objectID},getWeakData:function(e,t){if(!i(e,l)){if(!h(e))return!0;if(!t)return!1;d(e)}return e[l].weakData},onFreeze:function(e){return c&&f.REQUIRED&&h(e)&&!i(e,l)&&d(e),e}};s[l]=!0},function(e,t,n){var s=n(48),r=Math.min;e.exports=function(e){return e>0?r(s(e),9007199254740991):0}},function(e,t){e.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]},function(e,t,n){var s=n(15).f,r=n(6),i=n(5)("toStringTag");e.exports=function(e,t,n){e&&!r(e=n?e:e.prototype,i)&&s(e,i,{configurable:!0,value:t})}},function(e,t,n){"use strict";(function(e){var s=n(21),r=n(1),i=n(22),a=n(8),o=n(7),c=n(0),l=n.n(c);const u=new l.a,h=new l.a;t.a=class{constructor(e,t){this.name=e,this.pk=t,u.set(this,new s.a(e)),h.set(this,[])}init(e){const t=u.get(this);return Object(r.c)(e=>{t.init(t=>{e(t)})},e)}_findProperIndexer(e){if(e.index){const t=h.get(this);for(let n=0;n<t.length;n++)if(Object(r.b)(t[n].columns,e.index))return t[n]}return null}_addItemToIndex(e,t){const n=h.get(this);for(let s=0;s<n.length;s++)n[s].put(e,t)}_updateItemToIndex(e,t,n){const s=h.get(this);for(let r=0;r<s.length;r++)s[r].update(e,t,n)}_removeItemFromIndex(e,t){const n=h.get(this);for(let s=0;s<n.length;s++)n[s].remove(e,t)}ensureIndex(e,t){const n=u.get(this),s=h.get(this),a=i.a.createKey(e);return Object(r.c)(t=>{for(let e=0;e<s.length;e++)if(a===s[e].key)return void t(null);const r=new i.a({collection:this,columns:e,options:{sharedBatchQueue:n.batchQueue}});r.init((e,i,a)=>{if(e)t(e);else if(s.push(r),a){const e=n.keys;let s=0;for(let i=0;i<e.length;i++){const a=e[i];n.getItem(a,(n,i)=>{!n&&i?r.put(a,i,()=>{++s===e.length&&t(null)}):++s===e.length&&t(null)})}}else t(null)})},t)}removeIndex(e,t){const n=h.get(this),s=i.a.createKey(e);return Object(r.c)(e=>{for(let t=0;t<n.length;t++)if(s===n[t].key)return void n[t].drop(s=>{s||n.splice(t,1),e(s)});e(null)},t)}findById(e,t){const n=u.get(this);return Object(r.c)(t=>{e?("string"!=typeof e&&(e=JSON.stringify(e)),n.getItem(e,(e,n)=>{t(e,n)})):t(new Error("Invalid type: 'id' should not be empty."))},t)}findOne(e,t){return e.limit=1,this.find(e,(e,n)=>{t(e,n.length>0?n[0]:null)})}find(t,n){const s=u.get(this);return Object(r.c)(n=>{if(t instanceof a.a){const r=[],i=this._findProperIndexer(t);if(i){const e=[];for(let n=0;n<i.columnNames.length;n++){const s=i.columnNames[n];if(!t.condition[s])break;if("object"==typeof t.condition[s]){const n=Object.keys(t.condition[s]),r=["="],i=n.filter(e=>r.includes(e));if(!(i.length>0))break;{const r=n.indexOf(i[0]);e.push(t.condition[s][n[r]])}}else{if("function"==typeof t.condition[s]||void 0===t.condition[s]||Array.isArray(t.condition[s]))break;e.push(t.condition[s])}}let o=t.offset||0;i.each((e,i)=>{e?s.getItem(e.value,(e,n)=>{e?i(e):(t.match(n)&&(o<=0?r.push(n):o--),i(null,r.length<t.limit))}):n(null,r)},e.length>0?e:null,t.desc?a.a.Order.DESC:a.a.Order.ASC)}else{const i=!t.desc,a=s.keys;Object(o.a)({offset:t.offset<a.length?i?t.offset:a.length-t.offset-1:i?a.length:0,condition:e=>i?r.length<t.limit&&e<a.length:r.length<t.limit&&e>=0,progress:e=>i?e+1:e-1},(n,i)=>{s.getItem(a[n],(n,s)=>{n?i(n):(t.match(s)&&r.push(s),e(()=>i(null,!0)))})},e=>{n(e,r)})}}else n(new Error("Invalid type: 'query' should be Query type."))},n)}count(t,n){const s=u.get(this);return Object(r.c)(n=>{if(!t||t instanceof a.a)if(t){const r=s.keys;let i=0;Object(o.a)({offset:0,condition:e=>e<r.length,progress:e=>e+1},(n,a)=>{s.getItem(r[n],(n,s)=>{n?a(n):(t.match(s)&&i++,e(()=>a(null,!0)))})},e=>{n(e,i)})}else n(null,s.count);else n(new Error("Invalid type: 'query' should be Query type."))},n)}insert(e,t){const n=u.get(this);return n.startTransaction(),Object(r.c)(t=>{if(Array.isArray(e)){const n=[];for(let t=0;t<e.length;t++)e[t]&&"object"==typeof e[t]&&n.push(this.insert(e[t]));e.length===n.length?Promise.all(n).then(()=>t(null,e)).catch(e=>t(e)):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"==typeof e)if(e[this.pk]){const s=`${e[this.pk]}`;n.getItem(s,(r,i)=>{r?t(r):i?t(new Error("Duplicated item: item already exists.")):(this._addItemToIndex(s,e),n.setItem(s,e,n=>{t(n,e)}))})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},t,()=>n.endTransaction())}upsert(e,t){const n=u.get(this);return n.startTransaction(),Object(r.c)(t=>{if(Array.isArray(e)){const n=[];for(let t=0;t<e.length;t++)e[t]&&"object"==typeof e[t]&&n.push(this.upsert(e[t]));e.length===n.length?Promise.all(n).then(()=>t(null,e)).catch(e=>t(e)):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"==typeof e)if(e[this.pk]){const s=`${e[this.pk]}`;n.getItem(s,(r,i)=>{r?t(r):(i?this._updateItemToIndex(s,i,e):this._addItemToIndex(s,e),n.setItem(s,e,n=>{t(n,e)}))})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},t,()=>n.endTransaction())}update(e,t){const n=u.get(this);return n.startTransaction(),Object(r.c)(t=>{if(Array.isArray(e)){const n=[];for(let t=0;t<e.length;t++)e[t]&&"object"==typeof e[t]&&n.push(this.update(e[t]));e.length===n.length?Promise.all(n).then(()=>t(null,e)).catch(e=>t(e)):t(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"==typeof e)if(e[this.pk]){const s=`${e[this.pk]}`;n.getItem(s,(r,i)=>{r?t(r):i?(this._updateItemToIndex(s,i,e),n.setItem(s,e,n=>{t(n,e)})):t(null)})}else t(new Error("Invalid key: item should have key."));else t(new Error("Invalid type: 'item' should be an object or an object array."))},t,()=>n.endTransaction())}updateIf(t,n,s){const i=u.get(this);return i.startTransaction(),Object(r.c)(s=>{if(t instanceof a.a){const a=[],c=i.keys;Object(o.a)({offset:0,condition:e=>e<c.length,progress:e=>e+1},(s,o)=>{i.getItem(c[s],(s,c)=>{if(s)o(s);else if(c&&t.match(c)){const t=JSON.parse(JSON.stringify(c));let s=!1;for(let e in n){const t=n[e];Object(r.b)(c[e],t)||(s=!0,c[e]=t)}if(s){const n=`${c[this.pk]}`;this._updateItemToIndex(n,t,c),i.setItem(n,c,t=>{t?o(t):(a.push(c),e(()=>o(null,!0)))})}else e(()=>o(null,!0))}else e(()=>o(null,!0))})},e=>{s(e,a)})}else s(new Error("Invalid type: 'query' should be Query type."))},s,()=>i.endTransaction())}remove(e,t){const n=u.get(this);return n.startTransaction(),Object(r.c)(t=>{e?(e=`${e}`,n.getItem(e,(s,r)=>{s?t(s):r?(this._removeItemFromIndex(e,r),n.removeItem(e,e=>{t(e)})):t(null)})):t(new Error("Invalid type: 'id' should be string type."))},t,()=>n.endTransaction())}removeIf(t,n){const s=u.get(this);return s.startTransaction(),Object(r.c)(n=>{if(t instanceof a.a){const r=[],i=s.keys;Object(o.a)({offset:0,condition:e=>e<i.length,progress:e=>e+1},(n,a)=>{s.getItem(i[n],(n,i)=>{if(n)a(n);else if(i&&t.match(i)){const t=`${i[this.pk]}`;this._removeItemFromIndex(t,i),s.removeItem(t,t=>{t?a(t):(r.push(i),e(()=>a(null,!0)))})}else e(()=>a(null,!0))})},e=>{n(e,r)})}else n(new Error("Invalid type: 'query' should be Query type."))},n,()=>s.endTransaction())}clear(e){const t=h.get(this),n=u.get(this);return n.startTransaction(),Object(r.c)(e=>{for(let e=0;e<t.length;e++)t[e].clear();n.clear(t=>{e(t)})},e,()=>n.endTransaction())}}}).call(this,n(35).setImmediate)},function(e,t,n){(function(e){var s=void 0!==e&&e||"undefined"!=typeof self&&self||window,r=Function.prototype.apply;function i(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new i(r.call(setTimeout,s,arguments),clearTimeout)},t.setInterval=function(){return new i(r.call(setInterval,s,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},i.prototype.unref=i.prototype.ref=function(){},i.prototype.close=function(){this._clearFn.call(s,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},n(58),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(23))},function(e,t,n){var s=n(14),r=n(10),i=n(37);e.exports=!s&&!r(function(){return 7!=Object.defineProperty(i("div"),"a",{get:function(){return 7}}).a})},function(e,t,n){var s=n(2),r=n(4),i=s.document,a=r(i)&&r(i.createElement);e.exports=function(e){return a?i.createElement(e):{}}},function(e,t,n){var s=n(4);e.exports=function(e,t){if(!s(e))return e;var n,r;if(t&&"function"==typeof(n=e.toString)&&!s(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!s(r=n.call(e)))return r;if(!t&&"function"==typeof(n=e.toString)&&!s(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")}},function(e,t,n){var s=n(17);e.exports=s("native-function-to-string",Function.toString)},function(e,t,n){var s=n(2),r=n(39),i=s.WeakMap;e.exports="function"==typeof i&&/native code/.test(r.call(i))},function(e,t,n){var s=n(29),r=n(5)("toStringTag"),i="Arguments"==s(function(){return arguments}());e.exports=function(e){var t,n,a;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),r))?n:i?s(t):"Object"==(a=s(t))&&"function"==typeof t.callee?"Arguments":a}},function(e,t,n){var s=n(13);e.exports=function(e,t,n){for(var r in t)s(e,r,t[r],n);return e}},function(e,t,n){var s=n(2),r=n(44).f,i=n(9),a=n(13),o=n(24),c=n(67),l=n(49);e.exports=function(e,t){var n,u,h,d,f,g=e.target,p=e.global,m=e.stat;if(n=p?s:m?s[g]||o(g,{}):(s[g]||{}).prototype)for(u in t){if(d=t[u],h=e.noTargetGet?(f=r(n,u))&&f.value:n[u],!l(p?u:g+(m?".":"#")+u,e.forced)&&void 0!==h){if(typeof d==typeof h)continue;c(d,h)}(e.sham||h&&h.sham)&&i(d,"sham",!0),a(n,u,d,e)}}},function(e,t,n){var s=n(14),r=n(66),i=n(25),a=n(20),o=n(38),c=n(6),l=n(36),u=Object.getOwnPropertyDescriptor;t.f=s?u:function(e,t){if(e=a(e),t=o(t,!0),l)try{return u(e,t)}catch(e){}if(c(e,t))return i(!r.f.call(e,t),e[t])}},function(e,t,n){var s=n(10),r=n(29),i="".split;e.exports=s(function(){return!Object("z").propertyIsEnumerable(0)})?function(e){return"String"==r(e)?i.call(e,""):Object(e)}:Object},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on "+e);return e}},function(e,t,n){var s=n(6),r=n(20),i=n(70),a=n(19),o=i(!1);e.exports=function(e,t){var n,i=r(e),c=0,l=[];for(n in i)!s(a,n)&&s(i,n)&&l.push(n);for(;t.length>c;)s(i,n=t[c++])&&(~o(l,n)||l.push(n));return l}},function(e,t){var n=Math.ceil,s=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?s:n)(e)}},function(e,t,n){var s=n(10),r=/#|\.prototype\./,i=function(e,t){var n=o[a(e)];return n==l||n!=c&&("function"==typeof t?s(t):!!t)},a=i.normalize=function(e){return String(e).replace(r,".").toLowerCase()},o=i.data={},c=i.NATIVE="N",l=i.POLYFILL="P";e.exports=i},function(e,t,n){var s=n(11),r=n(73),i=n(31),a=n(51),o=n(75),c=n(76),l={};(e.exports=function(e,t,n,u,h){var d,f,g,p,m,y=a(t,n,u?2:1);if(h)d=e;else{if("function"!=typeof(f=o(e)))throw TypeError("Target is not iterable");if(r(f)){for(g=0,p=i(e.length);p>g;g++)if((u?y(s(m=e[g])[0],m[1]):y(e[g]))===l)return l;return}d=f.call(e)}for(;!(m=d.next()).done;)if(c(d,y,m.value,u)===l)return l}).BREAK=l},function(e,t,n){var s=n(74);e.exports=function(e,t,n){if(s(e),void 0===t)return e;switch(n){case 0:return function(){return e.call(t)};case 1:return function(n){return e.call(t,n)};case 2:return function(n,s){return e.call(t,n,s)};case 3:return function(n,s,r){return e.call(t,n,s,r)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e,t,n){if(!(e instanceof t))throw TypeError("Incorrect "+(n?n+" ":"")+"invocation");return e}},function(e,t,n){var s=n(79);e.exports=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,n={};try{(e=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(n,[]),t=n instanceof Array}catch(e){}return function(n,r){return s(n,r),t?e.call(n,r):n.__proto__=r,n}}():void 0)},function(e,t,n){var s=n(46);e.exports=function(e){return Object(s(e))}},function(e,t,n){var s=n(11),r=n(88),i=n(32),a=n(19),o=n(90),c=n(37),l=n(27)("IE_PROTO"),u=function(){},h=function(){var e,t=c("iframe"),n=i.length;for(t.style.display="none",o.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),h=e.F;n--;)delete h.prototype[i[n]];return h()};e.exports=Object.create||function(e,t){var n;return null!==e?(u.prototype=s(e),n=new u,u.prototype=null,n[l]=e):n=h(),void 0===t?n:r(n,t)},a[l]=!0},function(e,t,n){"use strict";var s,r,i,a=n(57),o=n(9),c=n(6),l=n(5),u=n(26),h=l("iterator"),d=!1;[].keys&&("next"in(i=[].keys())?(r=a(a(i)))!==Object.prototype&&(s=r):d=!0),null==s&&(s={}),u||c(s,h)||o(s,h,function(){return this}),e.exports={IteratorPrototype:s,BUGGY_SAFARI_ITERATORS:d}},function(e,t,n){var s=n(6),r=n(54),i=n(27),a=n(93),o=i("IE_PROTO"),c=Object.prototype;e.exports=a?Object.getPrototypeOf:function(e){return e=r(e),s(e,o)?e[o]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?c:null}},function(e,t,n){(function(e,t){!function(e,n){"use strict";if(!e.setImmediate){var s,r,i,a,o,c=1,l={},u=!1,h=e.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(e);d=d&&d.setTimeout?d:e,"[object process]"==={}.toString.call(e.process)?s=function(e){t.nextTick(function(){g(e)})}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?e.MessageChannel?((i=new MessageChannel).port1.onmessage=function(e){g(e.data)},s=function(e){i.port2.postMessage(e)}):h&&"onreadystatechange"in h.createElement("script")?(r=h.documentElement,s=function(e){var t=h.createElement("script");t.onreadystatechange=function(){g(e),t.onreadystatechange=null,r.removeChild(t),t=null},r.appendChild(t)}):s=function(e){setTimeout(g,0,e)}:(a="setImmediate$"+Math.random()+"$",o=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(a)&&g(+t.data.slice(a.length))},e.addEventListener?e.addEventListener("message",o,!1):e.attachEvent("onmessage",o),s=function(t){e.postMessage(a+t,"*")}),d.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var r={callback:e,args:t};return l[c]=r,s(c),c++},d.clearImmediate=f}function f(e){delete l[e]}function g(e){if(u)setTimeout(g,0,e);else{var t=l[e];if(t){u=!0;try{!function(e){var t=e.callback,s=e.args;switch(s.length){case 0:t();break;case 1:t(s[0]);break;case 2:t(s[0],s[1]);break;case 3:t(s[0],s[1],s[2]);break;default:t.apply(n,s)}}(t)}finally{f(e),u=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(23),n(59))},function(e,t){var n,s,r=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function o(e){if(n===setTimeout)return setTimeout(e,0);if((n===i||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:i}catch(e){n=i}try{s="function"==typeof clearTimeout?clearTimeout:a}catch(e){s=a}}();var c,l=[],u=!1,h=-1;function d(){u&&c&&(u=!1,c.length?l=c.concat(l):h=-1,l.length&&f())}function f(){if(!u){var e=o(d);u=!0;for(var t=l.length;t;){for(c=l,l=[];++h<t;)c&&c[h].run();h=-1,t=l.length}c=null,u=!1,function(e){if(s===clearTimeout)return clearTimeout(e);if((s===a||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(e);try{s(e)}catch(t){try{return s.call(null,e)}catch(t){return s.call(this,e)}}}(e)}}function g(e,t){this.fun=e,this.array=t}function p(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new g(e,t)),1!==l.length||u||o(f)},g.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=p,r.addListener=p,r.once=p,r.off=p,r.removeListener=p,r.removeAllListeners=p,r.emit=p,r.prependListener=p,r.prependOnceListener=p,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,n){var s=n(13),r=n(61),i=Object.prototype;r!==i.toString&&s(i,"toString",r,{unsafe:!0})},function(e,t,n){"use strict";var s=n(41),r={};r[n(5)("toStringTag")]="z",e.exports="[object z]"!==String(r)?function(){return"[object "+s(this)+"]"}:r.toString},function(e,t,n){var s=n(10);e.exports=!!Object.getOwnPropertySymbols&&!s(function(){return!String(Symbol())})},function(e,t,n){"use strict";var s,r=n(2),i=n(42),a=n(30),o=n(65),c=n(80),l=n(4),u=n(18).enforce,h=n(40),d=!r.ActiveXObject&&"ActiveXObject"in r,f=Object.isExtensible,g=function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},p=e.exports=o("WeakMap",g,c,!0,!0);if(h&&d){s=c.getConstructor(g,"WeakMap",!0),a.REQUIRED=!0;var m=p.prototype,y=m.delete,I=m.has,b=m.get,v=m.set;i(m,{delete:function(e){if(l(e)&&!f(e)){var t=u(this);return t.frozen||(t.frozen=new s),y.call(this,e)||t.frozen.delete(e)}return y.call(this,e)},has:function(e){if(l(e)&&!f(e)){var t=u(this);return t.frozen||(t.frozen=new s),I.call(this,e)||t.frozen.has(e)}return I.call(this,e)},get:function(e){if(l(e)&&!f(e)){var t=u(this);return t.frozen||(t.frozen=new s),I.call(this,e)?b.call(this,e):t.frozen.get(e)}return b.call(this,e)},set:function(e,t){if(l(e)&&!f(e)){var n=u(this);n.frozen||(n.frozen=new s),I.call(this,e)?v.call(this,e,t):n.frozen.set(e,t)}else v.call(this,e,t);return this}})}},function(e,t,n){var s=n(10);e.exports=!s(function(){return Object.isExtensible(Object.preventExtensions({}))})},function(e,t,n){"use strict";var s=n(43),r=n(2),i=n(49),a=n(13),o=n(30),c=n(50),l=n(52),u=n(4),h=n(10),d=n(77),f=n(33),g=n(78);e.exports=function(e,t,n,p,m){var y=r[e],I=y&&y.prototype,b=y,v=p?"set":"add",E={},C=function(e){var t=I[e];a(I,e,"add"==e?function(e){return t.call(this,0===e?0:e),this}:"delete"==e?function(e){return!(m&&!u(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return m&&!u(e)?void 0:t.call(this,0===e?0:e)}:"has"==e?function(e){return!(m&&!u(e))&&t.call(this,0===e?0:e)}:function(e,n){return t.call(this,0===e?0:e,n),this})};if(i(e,"function"!=typeof y||!(m||I.forEach&&!h(function(){(new y).entries().next()}))))b=n.getConstructor(t,e,p,v),o.REQUIRED=!0;else if(i(e,!0)){var w=new b,M=w[v](m?{}:-0,1)!=w,O=h(function(){w.has(1)}),k=d(function(e){new y(e)}),A=!m&&h(function(){for(var e=new y,t=5;t--;)e[v](t,t);return!e.has(-0)});k||((b=t(function(t,n){l(t,b,e);var s=g(new y,t,b);return null!=n&&c(n,s[v],s,p),s})).prototype=I,I.constructor=b),(O||A)&&(C("delete"),C("has"),p&&C("get")),(A||M)&&C(v),m&&I.clear&&delete I.clear}return E[e]=b,s({global:!0,forced:b!=y},E),f(b,e),m||n.setStrong(b,e,p),b}},function(e,t,n){"use strict";var s={}.propertyIsEnumerable,r=Object.getOwnPropertyDescriptor,i=r&&!s.call({1:2},1);t.f=i?function(e){var t=r(this,e);return!!t&&t.enumerable}:s},function(e,t,n){var s=n(6),r=n(68),i=n(44),a=n(15);e.exports=function(e,t){for(var n=r(t),o=a.f,c=i.f,l=0;l<n.length;l++){var u=n[l];s(e,u)||o(e,u,c(t,u))}}},function(e,t,n){var s=n(2),r=n(69),i=n(72),a=n(11),o=s.Reflect;e.exports=o&&o.ownKeys||function(e){var t=r.f(a(e)),n=i.f;return n?t.concat(n(e)):t}},function(e,t,n){var s=n(47),r=n(32).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return s(e,r)}},function(e,t,n){var s=n(20),r=n(31),i=n(71);e.exports=function(e){return function(t,n,a){var o,c=s(t),l=r(c.length),u=i(a,l);if(e&&n!=n){for(;l>u;)if((o=c[u++])!=o)return!0}else for(;l>u;u++)if((e||u in c)&&c[u]===n)return e||u||0;return!e&&-1}}},function(e,t,n){var s=n(48),r=Math.max,i=Math.min;e.exports=function(e,t){var n=s(e);return n<0?r(n+t,0):i(n,t)}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,n){var s=n(5),r=n(16),i=s("iterator"),a=Array.prototype;e.exports=function(e){return void 0!==e&&(r.Array===e||a[i]===e)}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e}},function(e,t,n){var s=n(41),r=n(16),i=n(5)("iterator");e.exports=function(e){if(null!=e)return e[i]||e["@@iterator"]||r[s(e)]}},function(e,t,n){var s=n(11);e.exports=function(e,t,n,r){try{return r?t(s(n)[0],n[1]):t(n)}catch(t){var i=e.return;throw void 0!==i&&s(i.call(e)),t}}},function(e,t,n){var s=n(5)("iterator"),r=!1;try{var i=0,a={next:function(){return{done:!!i++}},return:function(){r=!0}};a[s]=function(){return this},Array.from(a,function(){throw 2})}catch(e){}e.exports=function(e,t){if(!t&&!r)return!1;var n=!1;try{var i={};i[s]=function(){return{next:function(){return{done:n=!0}}}},e(i)}catch(e){}return n}},function(e,t,n){var s=n(4),r=n(53);e.exports=function(e,t,n){var i,a=t.constructor;return a!==n&&"function"==typeof a&&(i=a.prototype)!==n.prototype&&s(i)&&r&&r(e,i),e}},function(e,t,n){var s=n(4),r=n(11);e.exports=function(e,t){if(r(e),!s(t)&&null!==t)throw TypeError("Can't set "+String(t)+" as a prototype")}},function(e,t,n){"use strict";var s=n(42),r=n(30).getWeakData,i=n(11),a=n(4),o=n(52),c=n(50),l=n(81),u=n(6),h=n(18),d=h.set,f=h.getterFor,g=l(5),p=l(6),m=0,y=function(e){return e.frozen||(e.frozen=new I)},I=function(){this.entries=[]},b=function(e,t){return g(e.entries,function(e){return e[0]===t})};I.prototype={get:function(e){var t=b(this,e);if(t)return t[1]},has:function(e){return!!b(this,e)},set:function(e,t){var n=b(this,e);n?n[1]=t:this.entries.push([e,t])},delete:function(e){var t=p(this.entries,function(t){return t[0]===e});return~t&&this.entries.splice(t,1),!!~t}},e.exports={getConstructor:function(e,t,n,l){var h=e(function(e,s){o(e,h,t),d(e,{type:t,id:m++,frozen:void 0}),null!=s&&c(s,e[l],e,n)}),g=f(t),p=function(e,t,n){var s=g(e),a=r(i(t),!0);return!0===a?y(s).set(t,n):a[s.id]=n,e};return s(h.prototype,{delete:function(e){var t=g(this);if(!a(e))return!1;var n=r(e);return!0===n?y(t).delete(e):n&&u(n,t.id)&&delete n[t.id]},has:function(e){var t=g(this);if(!a(e))return!1;var n=r(e);return!0===n?y(t).has(e):n&&u(n,t.id)}}),s(h.prototype,n?{get:function(e){var t=g(this);if(a(e)){var n=r(e);return!0===n?y(t).get(e):n?n[t.id]:void 0}},set:function(e,t){return p(this,e,t)}}:{add:function(e){return p(this,e,!0)}}),h}}},function(e,t,n){var s=n(51),r=n(45),i=n(54),a=n(31),o=n(82);e.exports=function(e,t){var n=1==e,c=2==e,l=3==e,u=4==e,h=6==e,d=5==e||h,f=t||o;return function(t,o,g){for(var p,m,y=i(t),I=r(y),b=s(o,g,3),v=a(I.length),E=0,C=n?f(t,v):c?f(t,0):void 0;v>E;E++)if((d||E in I)&&(m=b(p=I[E],E,y),e))if(n)C[E]=m;else if(m)switch(e){case 3:return!0;case 5:return p;case 6:return E;case 2:C.push(p)}else if(u)return!1;return h?-1:l||u?u:C}}},function(e,t,n){var s=n(4),r=n(83),i=n(5)("species");e.exports=function(e,t){var n;return r(e)&&("function"!=typeof(n=e.constructor)||n!==Array&&!r(n.prototype)?s(n)&&null===(n=n[i])&&(n=void 0):n=void 0),new(void 0===n?Array:n)(0===t?0:t)}},function(e,t,n){var s=n(29);e.exports=Array.isArray||function(e){return"Array"==s(e)}},function(e,t,n){var s=n(2),r=n(85),i=n(86),a=n(9),o=n(5),c=o("iterator"),l=o("toStringTag"),u=i.values;for(var h in r){var d=s[h],f=d&&d.prototype;if(f){if(f[c]!==u)try{a(f,c,u)}catch(e){f[c]=u}if(f[l]||a(f,l,h),r[h])for(var g in i)if(f[g]!==i[g])try{a(f,g,i[g])}catch(e){f[g]=i[g]}}}},function(e,t){e.exports={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0}},function(e,t,n){"use strict";var s=n(20),r=n(87),i=n(16),a=n(18),o=n(91),c=a.set,l=a.getterFor("Array Iterator");e.exports=o(Array,"Array",function(e,t){c(this,{type:"Array Iterator",target:s(e),index:0,kind:t})},function(){var e=l(this),t=e.target,n=e.kind,s=e.index++;return!t||s>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==n?{value:s,done:!1}:"values"==n?{value:t[s],done:!1}:{value:[s,t[s]],done:!1}},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(e,t,n){var s=n(5),r=n(55),i=n(9),a=s("unscopables"),o=Array.prototype;null==o[a]&&i(o,a,r(null)),e.exports=function(e){o[a][e]=!0}},function(e,t,n){var s=n(14),r=n(15),i=n(11),a=n(89);e.exports=s?Object.defineProperties:function(e,t){i(e);for(var n,s=a(t),o=s.length,c=0;o>c;)r.f(e,n=s[c++],t[n]);return e}},function(e,t,n){var s=n(47),r=n(32);e.exports=Object.keys||function(e){return s(e,r)}},function(e,t,n){var s=n(2).document;e.exports=s&&s.documentElement},function(e,t,n){"use strict";var s=n(43),r=n(92),i=n(57),a=n(53),o=n(33),c=n(9),l=n(13),u=n(5),h=n(26),d=n(16),f=n(56),g=f.IteratorPrototype,p=f.BUGGY_SAFARI_ITERATORS,m=u("iterator"),y=function(){return this};e.exports=function(e,t,n,u,f,I,b){r(n,t,u);var v,E,C,w=function(e){if(e===f&&T)return T;if(!p&&e in k)return k[e];switch(e){case"keys":case"values":case"entries":return function(){return new n(this,e)}}return function(){return new n(this)}},M=t+" Iterator",O=!1,k=e.prototype,A=k[m]||k["@@iterator"]||f&&k[f],T=!p&&A||w(f),S="Array"==t&&k.entries||A;if(S&&(v=i(S.call(new e)),g!==Object.prototype&&v.next&&(h||i(v)===g||(a?a(v,g):"function"!=typeof v[m]&&c(v,m,y)),o(v,M,!0,!0),h&&(d[M]=y))),"values"==f&&A&&"values"!==A.name&&(O=!0,T=function(){return A.call(this)}),h&&!b||k[m]===T||c(k,m,T),d[t]=T,f)if(E={values:w("values"),keys:I?T:w("keys"),entries:w("entries")},b)for(C in E)!p&&!O&&C in k||l(k,C,E[C]);else s({target:t,proto:!0,forced:p||O},E);return E}},function(e,t,n){"use strict";var s=n(56).IteratorPrototype,r=n(55),i=n(25),a=n(33),o=n(16),c=function(){return this};e.exports=function(e,t,n){var l=t+" Iterator";return e.prototype=r(s,{next:i(1,n)}),a(e,l,!1,!0),o[l]=c,e}},function(e,t,n){var s=n(10);e.exports=!s(function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})},function(e,t,n){e.exports=n(2)},function(e,t,n){"use strict";n.r(t);var s=n(3);const r=(e,t)=>{const n=typeof e,s=typeof t;return!e||!t||"object"!==n||n!==s||e instanceof Date?e instanceof Date?e.getTime()===t.getTime():"function"===n&&"function"===s||e===t:Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>r(e[n],t[n]))},i=e=>{let t=null;return e&&(Array.isArray(e)?t=e.join("_"):"object"==typeof e?t=Object.keys(e).join("_"):"string"==typeof e&&(t=e)),t},a=(e,t,n)=>{if(!t)return new Promise((t,s)=>{e((e,r)=>{n&&"function"==typeof n&&n(),e?s(e):t(r)})});e(t)};var o=n(0),c=n.n(o);const l=new c.a;var u=class{constructor(e,t,n){this.name=t,this.keyPath=n,l.set(this,e)}findById(e,t){const n=l.get(this);return a(t=>{const s=n.transaction(this.name,"readonly").objectStore(this.name).get(e);s.onsuccess=()=>t(null,s.result||null),s.onerror=()=>t(s.error)},t)}find(e,t){const n=l.get(this);return a(t=>{if(e instanceof b.Query){const s=i(e.index),r=[],a=n.transaction(this.name,"readonly").objectStore(this.name),o=s?a.index(s).openCursor(null,e.desc?"prev":"next"):a.openCursor();let c=e.offset;o.onsuccess=n=>{const s=n.target.result;if(s)if(!c||c<0){const n=s.value;e.match(n)?(r.push(n),r.length<e.limit?s.continue():t(null,r)):s.continue()}else c--,s.continue();else t(null,r)},o.onerror=()=>{t(o.error)}}else t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},t)}count(e,t){const n=l.get(this);return a(t=>{if(!e||e instanceof b.Query){const s=n.transaction(this.name,"readonly").objectStore(this.name);if(e){let n=0;const r=s.openCursor();r.onsuccess=()=>{const s=event.target.result;s?(e.match(s.value)&&n++,s.continue()):t(null,n)},r.onerror=()=>{t(r.error)}}else{const e=s.count();e.onsuccess=()=>t(null,e.result),e.onerror=()=>t(e.error)}}else t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},t)}insert(e,t){const n=l.get(this);return a(t=>{const s=n.transaction(this.name,"readwrite").objectStore(this.name);if(Array.isArray(e)){const n=[];for(let r in e){const i=e[r],a=s.add(i);a.onsuccess=()=>{n.push(i),n.length===e.length&&t(null,n)},a.onerror=()=>{t(a.error)}}}else if(e&&"object"==typeof e){const n=s.add(e);n.onsuccess=()=>t(null,e),n.onerror=()=>t(n.error)}else t(new Error("Invalid type: 'item' should be an object or an object array."))},t)}upsert(e,t){const n=l.get(this);return a(t=>{const s=n.transaction(this.name,"readwrite").objectStore(this.name);if(e&&"object"==typeof e){const n=s.get(e[this.keyPath]);n.onsuccess=()=>{if(n.result){const n=s.put(e);n.onsuccess=()=>t(null,e),n.onerror=()=>t(n.error)}else{const n=s.add(e);n.onsuccess=()=>t(null,e),n.onerror=()=>t(n.error)}},n.onerror=()=>{t(n.error)}}else t(new Error("Invalid type: 'item' should be an object or an object array."))},t)}update(e,t){const n=l.get(this);return a(t=>{const s=n.transaction(this.name,"readwrite").objectStore(this.name).put(e);s.onsuccess=()=>t(null,e),s.onerror=()=>t(s.error)},t)}updateIf(e,t,n){const s=l.get(this);return a(n=>{if(e instanceof b.Query){const i=[],a=s.transaction(this.name,"readwrite").objectStore(this.name),o=a.openCursor();o.onsuccess=s=>{const o=s.target.result;if(o){const s=o.value;if(e.match(s)){let e=!1;for(let n in t){const i=t[n];r(s[n],i)||(e=!0,s[n]=i)}if(e){const e=a.put(s);e.onsuccess=()=>{i.push(s),o.continue()},e.onerror=()=>{n(e.error)}}else o.continue()}else o.continue()}else n(null,i)},o.onerror=()=>{n(o.error)}}else n(new Error("Invalid type: 'query' should be LocalDB.Query type."))},n)}remove(e,t){const n=l.get(this);return a(t=>{const s=n.transaction(this.name,"readwrite").objectStore(this.name).delete(e);s.onsuccess=()=>t(null),s.onerror=()=>t(s.error)},t)}removeIf(e,t){const n=l.get(this);return a(t=>{if(e instanceof b.Query){const s=[],r=n.transaction(this.name,"readwrite").objectStore(this.name),i=r.openCursor();i.onsuccess=n=>{const i=n.target.result;if(i){const n=i.value;if(e.match(n)){const e=r.delete(n[this.keyPath]);e.onsuccess=()=>{s.push(n),i.continue()},e.onerror=()=>{t(e.error)}}else i.continue()}else t(null,s)},i.onerror=()=>{t(i.error)}}else t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},t)}clear(e){const t=l.get(this);return a(e=>{const n=t.transaction(this.name,"readwrite").objectStore(this.name).clear();n.onsuccess=()=>e(null),n.onerror=()=>e(n.error)},e)}};const h=1/0,d=(e,t)=>{let n=!0;for(let s in t){switch(s){case"/and":n=n&&t[s].reduce((t,n)=>t&&d(e,n),!0);break;case"/or":n=n&&t[s].reduce((t,n)=>t||d(e,n),!1);break;default:{const i=t[s];if("object"==typeof i)for(let t in i)switch(t){case">":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]>i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])>0);break;case">=":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]>=i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])>=0);break;case"<":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]<i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])<0);break;case"<=":n="number"==typeof e[s]&&"number"==typeof i[t]?n&&e[s]<=i[t]:"string"==typeof e[s]&&"string"==typeof i[t]&&(n&&e[s].localeCompare(i[t])<=0);break;case"=":n=n&&e[s]===i[t];break;case"!=":n=n&&e[s]!==i[t];break;case"/in":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[s])>=0;break;case"/nin":n=n&&Array.isArray(i[t])&&i[t].indexOf(e[s])<0;break;case"/like":n=n&&"string"==typeof i[t]&&"string"==typeof e[s]&&e[s].indexOf(i[t])>=0;break;case"/nlike":n=n&&"string"==typeof i[t]&&"string"==typeof e[s]&&e[s].indexOf(i[t])<0;break;case"/regex":n=n&&i[t]instanceof RegExp&&i[t].test(e[s]);break;case"/where":n=n&&i[t](e[s]);break;default:n=n&&r(e[s],i)}else n=n&&e[s]===i}}if(!n)break}return n};class f{static and(...e){return e.length>0?new f({"/and":e}):new f({})}static or(...e){return e.length>0?new f({"/or":e}):new f({})}static get Order(){return{ASC:1,DESC:-1}}constructor(e){this.condition=e,this.offset=0,this.limit=h,this.index=null,this.desc=!1}match(e){return d(e,this.condition)}}var g=f;const p=new c.a,m=new c.a,y=new c.a,I=window?window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB:null;class b{static get Query(){return g}constructor(e,t){if(!I)throw new Error("IndexedDB is not supported in this environment. Check if you're in web browser which supports IndexedDB.");this.name=e,this.version=t,p.set(this,{}),m.set(this,null),y.set(this,{})}schema(e,t={}){return p.get(this)[e]=t,this}build(){const e=p.get(this),t=y.get(this);return new Promise((n,s)=>{const r=I.open(this.name,this.version);r.onerror=e=>{s(new Error(`IndexedDB is not available: ${e.target.errorCode}`))},r.onupgradeneeded=n=>{const s=n.target.result,r=n.target.transaction,a=r.objectStoreNames;for(let n in e){const a=e[n].key||"id";let o=null;try{o=r.objectStore(n)}catch(e){"NotFoundError"===e.name&&(o=s.createObjectStore(n,{keyPath:a}))}if(o){const r=o.indexNames,c=new u(s,n,a);if(e[n].index&&e[n].index.length>0)for(let t in e[n].index){const s=i(e[n].index[t]);if(s){let i=!1;for(let e in r)if(r[e]===s){i=!0;break}i||o.createIndex(s,Object.keys(e[n].index[t]),{unique:!1})}}const l=[];if(e[n].index)for(let t in e[n].index){const s=i(e[n].index[t]);s&&l.push(s)}for(let e=0;e<r.length;e++)l.indexOf(r[e])<0&&o.deleteIndex(r[e]);t[n]=c}}for(let t=0;t<a.length;t++)Object.keys(e).indexOf(a.item(t))<0&&s.deleteObjectStore(a.item(t));m.set(this,s)},r.onsuccess=s=>{const r=s.target.result;for(let n in e)if(!t[n]){const s=e[n].key||"id";t[n]=new u(r,n,s)}m.set(this,r),n()}})}close(){const e=m.get(this);e&&(e.close(),m.set(this,null))}drop(){I.deleteDatabase(this.name)}collection(e){const t=y.get(this);return t[e]&&t[e]instanceof u?t[e]:null}}let v=null,E=!1;class C{static init(){v||(v=window?window.localStorage:null)}static useReactNative(e){v=e,E=!0}static getKeys(){return E?v.getAllKeys():new Promise(e=>{const t=[];for(let e in v)t.push(e);e(t)})}static get(e){return E?v.getItem(e):new Promise(t=>{const n=v.getItem(e);t(void 0!==n?n:null)})}static set(e,t){return E?v.setItem(e,t):new Promise(n=>{v.setItem(e,t),n()})}static remove(e){return E?v.removeItem(e):new Promise(t=>{v.removeItem(e),t()})}static clear(){return E?v.clear():new Promise(e=>{v.clear(),e()})}}const w={NONE:0,ERROR:1};let M=w.NONE,O="";class k{static set level(e){const t=Object.values(w);t.push(98765),t.indexOf(e)>-1&&(M=e)}static get level(){return M}static set prefix(e){"string"==typeof e&&(O=e)}static _permit(e,t,...n){if(M>=e){let s="";switch(e){case 1:s="error";break;case 2:s="warning";break;case 3:case 98765:s="log";break;default:s=""}if(console&&console[s]){const e=`${O} ${t||""} `;"string"==typeof n[0]?(n[0]=e+n[0],console[s](...n)):console[s](e,...n)}}}static error(...e){k._permit(w.ERROR,"[ERROR]",...e)}static warning(...e){k._permit(2,"[WARNING]",...e)}static call(...e){k._permit(3,"[CALL]",...e)}static event(...e){k._permit(3,"[EVENT]",...e)}static view(...e){k._permit(3,"[VIEW]",...e)}static message(...e){k._permit(3,"[MESSAGE]",...e)}static info(...e){k._permit(3,"[INFO]",...e)}static cache(...e){k._permit(98765,"[CACHE]",...e)}static sync(...e){k._permit(98765,"[SYNC]",...e)}}class A extends Error{constructor(e,t){super(e),this.name="SyncManagerException",this.code=t||0}static create(e=A.Type.ERROR_UNKNOWN){return new A(e.message,e.code)}static get Type(){return{ERROR_UNKNOWN:{code:81e4,message:"Unknown error occurred."},ERROR_DATABASE_IO:{code:810001,message:"Database I/O operation failed."},ERROR_SETUP_MISSING:{code:810100,message:"SendBirdSyncManager.setup() is not called."},ERROR_SENDBIRD_MISSING:{code:810101,message:"SendBird instance should be set before init()."},ERROR_DUPLICATED_FETCH:{code:810200,message:"Fetch is in progress."},ERROR_DUPLICATED_CHANGELOG_SYNC:{code:810210,message:"Sync is in progress."},ERROR_INVALID_PARAMETER:{code:810300,message:"Invalid parameter."}}}static throw(e){k.error(e)}}const T=function(e,t){const n=e.collection("GroupChannel"),s=(e,t)=>{const s=Ye.getInstance();s.currentUserId?(e.ownerUserId=s.currentUserId,e.lastMessageUpdatedAt=e.lastMessage?e.lastMessage.createdAt:e.createdAt,k.cache("upsert channel","url="+e.url,"name="+e.name,"createdAt="+e.createdAt,"lastMessageUpdatedAt="+e.lastMessageUpdatedAt),n.upsert(e.serialize(),t)):t(A.create(A.Type.ERROR_SETUP_MISSING))},r=e=>{if(e){const n=t.GroupChannel.buildFromSerializedData(e);return n.lastMessageUpdatedAt=n.lastMessage?n.lastMessage.createdAt:n.createdAt,n}return null};return this.query=(e,t,s)=>{const i=Ye.getInstance();if(i.currentUserId){e.ownerUserId=i.currentUserId;const a=new Ye.LocalDB.Query(e);t&&(a.offset=t.offset||0,a.limit=t.limit||20,a.index=t.index,a.desc=t.desc),n.find(a,(e,t)=>{if(e)s(e);else{const e=[];for(let n=0;n<t.length;n++){const s=r(t[n]);e.push(s)}s(null,e)}})}else s(A.create(A.Type.ERROR_SETUP_MISSING))},this.insert=(e,t)=>{this.getItem(e.url,(n,r)=>{n?t(n):r?t(null,e):s(e,n=>{n?t(n):t(null,e)})})},this.upsert=(e,t)=>{s(e,(e,n)=>{e?t(e):t(null,r(n))})},this.remove=(t,s)=>{((t,s)=>{const r=Ye.getInstance();r.currentUserId?(k.cache("remove channel",t.url),n.remove(t.url,(n,i)=>{if(n)s(n);else{const n=new Ye.LocalDB.Query({ownerUserId:r.currentUserId,channelUrl:t.url});e.collection("MessageChunk").removeIf(n,t=>{t?s(t):e.collection("Message").removeIf(n,e=>{e?s(e):s(null,i)})})}})):s(A.create(A.Type.ERROR_SETUP_MISSING))})(t,(e,t)=>{e?s(e):s(null,r(t))})},this.getItem=(e,t)=>{n.findById(e,(e,n)=>{e?t(e):t(null,r(n))})},this.clear=t=>(t=>{k.cache("clear channel"),n.clear(n=>{n?t(n):e.collection("MessageChunk").clear(n=>{n?t(n):e.collection("Message").clear(t)})})})(t),this};let S={};const _=function(e,t){const n=e.collection("GroupChannelListQuery"),s=(e,t)=>{e.filterKey=this.createFilterKey(e);const s=Ye.getInstance();if(s.currentUserId){k.cache("upsert channel list query",e.filterKey),e.ownerUserId=s.currentUserId,e.updatedAt=(new Date).getTime(),e.savepoint||(e.savepoint="");const i=e.serialize();n.upsert(i,(n,s)=>{if(n)t(n);else{if(S[e.filterKey])for(let t in e)S[e.filterKey].hasOwnProperty(t)&&(S[e.filterKey][t]=e[t]);else S[e.filterKey]=e;t(null,r(s))}})}else t(A.create(A.Type.ERROR_SETUP_MISSING))},r=e=>{if(e){const n=t.GroupChannelListQuery.buildFromSerializedData(e);return n.filterKey=e.filterKey,n.ownerUserId=e.currentUserId,n.updatedAt=e.updatedAt,n.savepoint=e.savepoint,n}return null};return this.createFilterKey=e=>{const t=[];return t.push(`order=${e.order}`),t.push(`includeEmpty=${e.includeEmpty}`),t.push(`customTypesFilter=${e.customTypesFilter.sort().join(",")}`),t.join("&")},this.upsert=(e,t)=>{s(e,(e,n)=>{e?t(e):t(null,r(n))})},this.remove=(e,t)=>{((e,t)=>{Ye.getInstance().currentUserId?(k.cache("remove channel list query",e.filterKey),n.remove(e.filterKey,(n,s)=>{n?t(n):(S[e.filterKey]&&delete S[e.filterKey],t(null,s))})):t(A.create(A.Type.ERROR_SETUP_MISSING))})(e,(e,n)=>{e?t(e):t(null,r(n))})},this.getItem=(e,t)=>{S[e]?t(null,S[e]):n.findById(e,(e,n)=>{e?t(e):t(null,r(n))})},this.clear=e=>(e=>{k.cache("clear channel list query"),S={},n.clear(t=>e(t))})(e),this};function x(e,t){const n=L.getInstance().sb;let s=!0;if(e.isGroupChannel()&&!e.isSuper){if(!t.includeEmpty&&!e.lastMessage)return!1;if(t.nicknameContainsFilter){let n=!1;for(let s in e.members)if(e.members[s].nickname.indexOf(t.nicknameContainsFilter)>=0){n=!0;break}if(!n)return!1}if(t.userIdsFilter.length>0){let n=!1;const s=e.members.map(e=>e.userId),r=t.userIdsFilterExactMatch,i=t.queryType;if(r?n=s.length===t.userIdsFilter.length&&t.userIdsFilter.every(e=>s.indexOf(e)>=0):"AND"===i?n=t.userIdsFilter.every(e=>s.indexOf(e)>=0):"OR"===i&&(n=t.userIdsFilter.reduce((e,t)=>e=e||s.indexOf(t)>=0,!1)),!n)return!1}}if(t.channelNameContainsFilter&&(s=s&&e.name.indexOf(t.channelNameContainsFilter)>=0),t.channelUrlsFilter.length>0&&(s=s&&t.channelUrlsFilter.indexOf(e.url)>=0),t.memberStateFilter!==n.GroupChannel.memberStateFilter.ALL)switch(t.memberStateFilter){case n.GroupChannel.memberStateFilter.JOINED:s=s&&e.myMemberState===n.GroupChannel.memberStateFilter.JOINED;break;case n.GroupChannel.memberStateFilter.INVITED:case n.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case n.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:s=s&&e.myMemberState===n.GroupChannel.memberStateFilter.INVITED}if(t.customTypesFilter.length>0&&(s=s&&t.customTypesFilter.indexOf(e.customType)>=0),t.customTypeStartsWithFilter&&(s=s&&e.customType.startsWith(t.customTypeStartsWithFilter)),t.superChannelFilter!==n.GroupChannel.superChannelFilter.ALL)switch(t.superChannelFilter){case n.GroupChannel.superChannelFilter.SUPER:s=s&&e.isSuper;break;case n.GroupChannel.superChannelFilter.NONSUPER:s=s&&!e.isSuper}if(t.publicChannelFilter!==n.GroupChannel.publicChannelFilter.ALL)switch(t.publicChannelFilter){case n.GroupChannel.publicChannelFilter.PUBLIC:s=s&&e.isPublic;break;case n.GroupChannel.publicChannelFilter.PRIVATE:s=s&&!e.isPublic}if(t.unreadChannelFilter!=n.GroupChannel.UnreadChannelFilter.ALL)switch(t.unreadChannelFilter){case n.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:s=s&&e.unreadMessageCount>0}return s}const R=function(){let e=[];return this.addCollection=(t,n)=>{e.indexOf(t)<0&&e.push({controller:t,view:n})},this.removeCollection=t=>{const n=e.map(e=>e.controller).indexOf(t);n>=0&&(e[n].controller._pause(),e.splice(n,1))},this.clearCollection=()=>{for(let t in e)e[t].controller._pause();e=[]},this.pause=()=>{for(let t in e)e[t].controller._pause()},this.resume=()=>{for(let t in e)e[t].controller._resume()},this.upsert=(t,n,s={})=>{if(t.length>0)for(let r in e){const i=e[r];if(i.controller!==n){const e=[];for(let n in t){const s=t[n];x(s,i.controller.query)&&e.push(s)}e.length>0&&(s.isEventChannel=!0,i.view.addViewItems(e,s))}}},this.update=(t,n,s={})=>{if(t.length>0)for(let r in e){const i=e[r];if(i.controller!==n){const e=[];for(let n in t){const s=t[n];x(s,i.controller.query)&&i.view.channels.map(e=>e.url).indexOf(s.url)>=0&&e.push(s)}e.length>0&&(s.isEventChannel=!0,i.view.addViewItems(e,s))}}},this.remove=(t,n)=>{if(t.length>0)for(let s in e){const r=e[s];if(r.controller!==n){const e=[];for(let n in t){const s=t[n];r.view.channels.map(e=>e.url).indexOf(s.url)>=0&&e.push(s)}e.length>0&&r.view.removeViewItems(e)}}},this.hide=(t,n,s={})=>{if(t.length>0){const r=L.getInstance().sb;for(let i in e){const a=e[i];if(a.controller!==n){const e=[];for(let n in t){const s=t[n];x(s,a.controller.query)&&e.push(s)}if(e.length>0)switch(a.controller.query.hiddenChannelFilter){case r.GroupChannel.HiddenChannelFilter.UNHIDDEN:a.view.removeViewItems(e);break;case r.GroupChannel.HiddenChannelFilter.HIDDEN:case r.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case r.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:s.isEventChannel=!0,a.view.addViewItems(e,s)}}}}},this.unhide=(t,n,s={})=>{if(t.length>0){const r=L.getInstance().sb;for(let i in e){const a=e[i];if(a.controller!==n){const e=[];for(let n in t){const s=t[n];x(s,a.controller.query)&&e.push(s)}if(e.length>0)switch(a.controller.query.hiddenChannelFilter){case r.GroupChannel.HiddenChannelFilter.UNHIDDEN:s.isEventChannel=!0,a.view.addViewItems(e,s);break;case r.GroupChannel.HiddenChannelFilter.HIDDEN:case r.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case r.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:a.view.removeViewItems(e)}}}}},this.clear=()=>{for(let t in e){e[t].view.clearViewItem()}},this},U="channel-changeLog-token",D="syncManager_channelManager_channelHandler_"+(new Date).getTime(),N=100;let F=null;class L{constructor({sendBird:e,db:t}){if(!F){k.call("ChannelManager()"),F=this;const n=this.sb=e,s=Ye.getInstance();this.channelContainer=new T(t,n),this.queryContainer=new _(t,n),this.broadcast=new R,this.isFetchingChangeLog=!1,this.channelSyncByFilter={},this.changeLogSync=null;const r=new n.ChannelHandler;Object.keys(r).forEach(e=>{r[e]=(...t)=>{switch(e){case"onChannelChanged":{const s=t[0];k.event(e,s.url),F.channelContainer.getItem(s.url,(e,t)=>{e?A.throw(e):F.channelContainer.upsert(s,(e,r)=>{e?A.throw(e):t?t.hiddenState!==n.GroupChannel.HiddenState.UNHIDDEN&&s.hiddenState===n.GroupChannel.HiddenState.UNHIDDEN?F.broadcast.unhide([r]):F.broadcast.update([r]):F.broadcast.upsert([r])})});break}case"onUserMuted":case"onUserUnmuted":case"onUserUnbanned":case"onChannelFrozen":case"onChannelUnfrozen":case"onMetaDataCreated":case"onMetaDataUpdated":case"onMetaDataDeleted":case"onMetaCountersCreated":case"onMetaCountersUpdated":case"onMetaCountersDeleted":k.event(e,t[0].url),F.channelContainer.upsert(t[0],(e,t)=>{e?A.throw(e):F.broadcast.update([t])});break;case"onUserReceivedInvitation":case"onUserJoined":k.event(e,t[0].url),F.channelContainer.upsert(t[0],(e,n)=>{if(e)A.throw(e);else{t[1].userId===s.currentUserId?F.broadcast.upsert([n]):F.broadcast.update([n])}});break;case"onReadReceiptUpdated":F.channelContainer.upsert(t[0],e=>{e&&A.throw(e)});break;case"onMessageReceived":t[0].lastMessage&&t[0].lastMessage.messageId!==t[1].messageId||F.channelContainer.upsert(t[0],(e,t)=>{e?A.throw(e):F.broadcast.upsert([t])});break;case"onChannelHidden":{k.event(e,t[0].url);const n=t[0];F.channelContainer.upsert(n,e=>{e?A.throw(e):F.broadcast.hide([n])});break}case"onUserLeft":case"onUserBanned":{k.event(e,t[0].url);const n=t[0];t[1].userId===s.currentUserId?F.channelContainer.remove(n,e=>{e?A.throw(e):F.broadcast.remove([n])}):F.channelContainer.upsert(n,(e,t)=>{e?A.throw(e):F.broadcast.update([t])});break}case"onUserDeclinedInvitation":{k.event(e,t[0].url);const n=t[0];t[2].userId===s.currentUserId?F.channelContainer.remove(n,e=>{e?A.throw(e):F.broadcast.remove([n])}):F.channelContainer.upsert(n,(e,t)=>{e?A.throw(e):F.broadcast.update([t])});break}case"onChannelDeleted":k.event(e,t[0]),F.channelContainer.getItem(t[0],(e,t)=>{e?A.throw(e):t&&F.channelContainer.remove(t,e=>{e?A.throw(e):F.broadcast.remove([t])})})}}}),n.addChannelHandler(D,r)}return F}static getInstance(){return F}static clear(){F&&F.sb&&(k.message("ChannelManager is cleared"),F.channelSyncByFilter={},F.changeLogSync=null,F.broadcast.clearCollection(),F.sb.removeChannelHandler(D),F=null)}syncChangeLog(e,t){if(this.isFetchingChangeLog)t(A.create(A.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLog=!0,k.call("channel syncChangeLog()");const n=`${U}`;C.get(n).then(s=>{let r="getMyGroupChannelChangeLogsByToken";const i=[];i.push([]),i.push(!0),s?(r="getMyGroupChannelChangeLogsByToken",i.unshift(s)):(r="getMyGroupChannelChangeLogsByTimestamp",i.unshift((new Date).getTime()-N)),k.call(r),this.sb[r](...i,(s,r)=>{if(this.sb.getErrorFirstCallback()){const e=s;s=r,r=e}if(r)this.isFetchingChangeLog=!1;else{k.sync("updated",s.updatedChannels&&s.updatedChannels.length>0?"\n"+s.updatedChannels.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"):[]),k.sync("deleted",s.deletedChannelUrls);const r=[];s.updatedChannels.forEach(e=>{r.push(new Promise((t,n)=>{F.channelContainer.getItem(e.url,(s,r)=>{s?n(s):F.channelContainer.upsert(e,(e,s)=>{if(e)n(e);else{const e=!r||!r.isEqual(s),n=(!r||r.hiddenState===this.sb.GroupChannel.HiddenState.UNHIDDEN)&&s.hiddenState!==this.sb.GroupChannel.HiddenState.UNHIDDEN,i=(!r||r.hiddenState!==this.sb.GroupChannel.HiddenState.UNHIDDEN)&&s.hiddenState===this.sb.GroupChannel.HiddenState.UNHIDDEN;let a=e?"update":"noop";n?a="hide":i&&(a="unhide"),t({action:a,channel:s})}})})}))}),s.deletedChannelUrls.forEach(e=>{r.push(new Promise((t,n)=>{F.channelContainer.getItem(e,(e,s)=>{e?n(e):s&&F.channelContainer.remove(s,e=>{if(e)n(e);else{t({action:"remove",channel:s})}})})}))}),Promise.all(r).then(r=>{const i=[],a=[],o=[],c=[];for(let e=0;e<r.length;e++)switch(r[e].action){case"update":i.push(r[e].channel);break;case"remove":a.push(r[e].channel);break;case"hide":o.push(r[e].channel);break;case"unhide":c.push(r[e].channel)}i.length>0&&F.broadcast.upsert(i,null,{isChangeLogChannel:!0}),a.length>0&&F.broadcast.remove(a),o.length>0&&F.broadcast.hide(o,null,{isChangeLogChannel:!0}),c.length>0&&F.broadcast.unhide(c,null,{isChangeLogChannel:!0}),C.set(n,s.token).then(()=>{s.hasMore?this.syncChangeLog(e,t):(this.isFetchingChangeLog=!1,t())}).catch(e=>{this.isFetchingChangeLog=!1,t(e)})}).catch(e=>t(e))}})}).catch(e=>{this.isFetchingChangeLog=!1,t(e)})}}start(){F.broadcast.resume()}stop(){F.broadcast.pause()}clearCache(e){F.channelSyncByFilter={},F.changeLogSync=null,F.channelContainer.clear(()=>{F.queryContainer.clear(()=>{C.getKeys().then(t=>{const n=[];t.forEach(e=>{e.startsWith(U)&&n.push(C.remove(e))}),Promise.all(n).then(()=>e()).catch(t=>{k.error(t),e(t)})}).catch(t=>e(t))})})}reset(e){F?(F.broadcast.clear(),F.clearCache(e)):e(null)}}function P(e,t=[]){return t.map(e=>e.url).indexOf(e.url)}function q(e,t,n=[]){let s=null,r=(e,t)=>e>t;switch(t.order){case"latest_last_message":s="lastMessageUpdatedAt";break;case"chronological":s="createdAt";break;case"channel_name_alphabetical":s="name",r=(e,t)=>e.localeCompare(t)<0;break;default:s="lastMessageUpdatedAt"}let i=P(e,n);i<0&&(i=n.length);for(let t=0;t<n.length;t++){const a=n[t];if(e[s]===a[s]&&e.url===a.url){i=t;break}if(r(e[s],a[s])){i=t;break}}return i}function j(e,t=[]){for(let n=0;n<t.length;n++)if(e.isIdentical(t[n]))return n;return-1}function B(e,t=[]){let n=t.length;for(let s=0;s<t.length;s++)if(t[s].createdAt>=e.createdAt){n=s;break}return n}const V=(e,t)=>{const n=typeof e,s=typeof t;return!e||!t||"object"!==n||n!==s||e instanceof Date?e instanceof Date?e.getTime()===t.getTime():"function"===n&&"function"===s||e===t:Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>V(e[n],t[n]))},G=()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})},Q=(e,t)=>{if(!t)return new Promise((t,n)=>{e(e=>e?n(e):t())});e(t)},H="unsent";function K(e){return`${H}-${e}`}function $(e){if(e)if(e.requestState&&"succeeded"!==e.requestState){if(!e.reqId)throw A.throw(A.create(A.Type.ERROR_INVALID_PARAMETER));e.messageId=K(e.reqId)}else e.messageId=`${e.messageId}`}const z=function(e,t){const n=e.collection("Message"),s=(e,t)=>{const s=Ye.getInstance(),i=e.isDeleted?e:r(e.serialize());$(i),i.messageId?s.currentUserId?(i.hasOwnProperty("isVisible")||(i.isVisible=!0),i.hasOwnProperty("isDeleted")||(i.isDeleted=!1),i.ownerUserId=s.currentUserId,k.cache("upsert message",i.messageId,i.createdAt,"owner="+i.ownerUserId,"visible="+i.isVisible,"deleted="+i.isDeleted),n.findById(i.messageId,(e,s)=>{e?t(e):s?s.isDeleted?t(null,s):(i.isVisible=i.isVisible||s.isVisible,n.upsert(i.serialize(),(e,n)=>{e?t(e):t(null,n)})):n.upsert(i.serialize(),(e,n)=>{e?t(e):t(null,n)})})):t(A.create(A.Type.ERROR_SETUP_MISSING)):t(null,e)},r=e=>{let n=null;return e&&("user"===e.messageType?n=t.UserMessage.buildFromSerializedData(e):"file"===e.messageType?n=t.FileMessage.buildFromSerializedData(e):"admin"===e.messageType&&(n=t.AdminMessage.buildFromSerializedData(e))),n&&function(e){e&&(e.requestState&&"succeeded"!==e.requestState?e.messageId=0:e.messageId=parseInt(e.messageId))}(n),n},i=(e,t)=>(t.messageType&&(e.messageType=t.messageType),t.customType&&(e.customType=t.customType),t.senderUserIdsFilter&&t.senderUserIdsFilter.length>0&&(e["sender.userId"]={"/in":t.senderUserIdsFilter}),e);return this.query=(e,t,s)=>{e.isVisible=!0,e.isDeleted=!1;const i=Ye.getInstance();if(i.currentUserId){e.ownerUserId=i.currentUserId;const a=new Ye.LocalDB.Query(e);t&&(a.offset=t.offset||0,a.limit=t.limit||50,a.desc=t.desc),a.index={ownerUserId:Ye.LocalDB.Query.Order.ASC,channelUrl:Ye.LocalDB.Query.Order.ASC,createdAt:Ye.LocalDB.Query.Order.DESC},n.find(a,(e,t)=>{if(e)s(e);else{const e=[];for(let n=0;n<t.length;n++){const s=r(t[n]);e.push(s)}s(null,e)}})}else s(A.create(A.Type.ERROR_SETUP_MISSING))},this.find=(e,t)=>{n.find(e,t)},this.count=(e,t)=>{n.count(e,t)},this.upsert=(e,t)=>{e?s(e,(e,n)=>{e?t(e):t(null,r(n))}):t(null)},this.remove=(e,t)=>{this.getItem(e,(n,r)=>{const i=Ye.getInstance(),a={messageId:e,isDeleted:!0,serialize:()=>({messageId:`${e}`,ownerUserId:r?r.ownerUserId:i.currentUserId,channelUrl:r?r.channelUrl:"",createdAt:r?r.createdAt:0,requestState:r?r.requestState:"succeeded",isVisible:!1,isDeleted:!0})};s(a,n=>{n?t(n):t(null,e)})})},this.removeUnsent=(e,t)=>{const s=K(e);this.getItem(s,(e,s)=>{e?t(e):s?((e,t)=>{Ye.getInstance().currentUserId?(k.cache("remove message",e.messageId),$(e),n.remove(e.messageId,t)):t(A.create(A.Type.ERROR_SETUP_MISSING))})(s,t):t(null)})},this.removeExpiredMessages=(e,t)=>{const s=(new Date).getTime()-864e5*e,r=new b.Query({ownerUserId:Ye.getInstance().currentUserId,requestState:"failed",createdAt:{"<":s}});r.limit=Number.MAX_SAFE_INTEGER,r.index={ownerUserId:Ye.LocalDB.Query.Order.ASC,createdAt:Ye.LocalDB.Query.Order.ASC},n.removeIf(r,t)},this.getItemWithVisibility=(e,t)=>{n.findById(e,(e,n)=>{e?t(e):t(null,{item:r(n),isVisible:!!n&&n.isVisible})})},this.getItem=(e,t)=>{n.findById(e,(e,n)=>{e?t(e):t(null,r(n))})},this.clear=e=>(e=>{k.cache("clear messages"),n.clear(t=>e(t))})(e),this.loadPreviousSucceededMessages=(e,t={},n=(new Date).getTime(),s={},r)=>{const a={channelUrl:e,requestState:{"!=":"failed"},createdAt:{"<=":n}};i(a,t),s.desc=!0,this.query(a,s,r)},this.loadNextSucceededMessages=(e,t={},n=0,s={},r)=>{const a={channelUrl:e,requestState:{"!=":"failed"},createdAt:{">=":n}};i(a,t),s.desc=!1,this.query(a,s,r)},this.loadFailedMessages=(e,t={},n={},s)=>{const r={channelUrl:e,requestState:"failed"};i(r,t),n.limit=Number.MAX_SAFE_INTEGER,n.desc=!0,this.query(r,n,s)},this.loadOldestFailedMessages=e=>{const t={requestState:"failed"};i(t,{});const n={limit:Number.MAX_SAFE_INTEGER,desc:!1};this.query(t,n,e)},this};let W={};const J=function(e){const t=[];for(let n in e)t.push(`${n}=${e[n]}`);return t.join("&")};class Y{constructor(e,t){this.chunkId=G(),this.channelUrl=e,this.filterKey=J(t),this.filter=t,this.startAt=(new Date).getTime(),this.endAt=0}static createFromJson(e){const t=new Y(e.channelUrl,e.filter);return t.chunkId=e.chunkId,t.startAt=e.startAt,t.endAt=e.endAt,t}static getDefaultFilter(){return{messageTypeFilter:null,customTypeFilter:null,senderUserIdsFilter:[],includeMetaArray:!1}}static get MessageTypeFilterRealValue(){return["","user","file","admin"]}hasDefaultFilter(){const e=Y.getDefaultFilter();return V(this.filter,e)}isOverlap(e){return e.startAt<=this.startAt&&this.startAt<=e.endAt||e.startAt<=this.endAt&&this.endAt<=e.endAt}isSame(e){return e.startAt===this.startAt&&this.endAt===e.endAt}contains(e){return this.startAt<=e&&e<=this.endAt}containsMessage(e){return this.contains(e.createdAt)}serialize(){const e=JSON.parse(JSON.stringify(this));return Object.freeze(e)}extendForward(e){this.endAt=Math.max(this.endAt,e)}extendBackward(e){this.startAt=Math.min(this.startAt,e)}extendWithChunk(e){return this.extendForwardWithChunk(e),this.extendBackwardWithChunk(e),this}extendForwardWithChunk(e){return this.extendForward(e.endAt),this}extendBackwardWithChunk(e){return this.extendBackward(e.startAt),this}extendWithMessage(e){return this.extendForwardWithMessage(e),this.extendBackwardWithMessage(e),this}extendForwardWithMessage(e){return this.extendForward(e.createdAt),this}extendBackwardWithMessage(e){return this.extendBackward(e.createdAt),this}}const X=function(e){const t=e.collection("MessageChunk");return this.reload=(e,n)=>t.findById(e.chunkId,n),this.upsert=(e,n)=>{((e,n)=>{const s=Ye.getInstance();s.currentUserId?(e.ownerUserId=s.currentUserId,W[e.chunkId]=e,t.upsert(W[e.chunkId].serialize(),(e,t)=>{e?n(e):n(null,t)})):n(A.create(A.Type.ERROR_SETUP_MISSING))})(e,(e,t)=>{e?n(e):n(null,Y.createFromJson(t))})},this.remove=(e,n)=>{((e,n)=>{Ye.getInstance().currentUserId?(W[e]&&delete W[e],t.remove(e,(e,t)=>{e?n(e):n(null,t)})):n(A.create(A.Type.ERROR_SETUP_MISSING))})(e,t=>{t?n(t):n(null,e)})},this.clear=e=>(e=>{W={},t.clear(t=>e(t))})(e),this.getChunkByTimestamp=(e,n,s,r)=>{const i=Ye.getInstance();if(i.currentUserId){const a=new Ye.LocalDB.Query({ownerUserId:i.currentUserId,channelUrl:e,filterKey:J(n),startAt:{"<=":s},endAt:{">=":s}});a.limit=1,a.index={ownerUserId:Ye.LocalDB.Query.Order.ASC,channelUrl:Ye.LocalDB.Query.Order.ASC,filterKey:Ye.LocalDB.Query.Order.ASC,endAt:Ye.LocalDB.Query.Order.DESC},t.find(a,(n,i)=>{if(n)r(n);else{const n=i.length>0?Y.createFromJson(i[0]):null;if(n)if(n.hasDefaultFilter())r(null,n);else{const i=new Ye.LocalDB.Query({channelUrl:e,filterKey:J(Y.getDefaultFilter()),startAt:{"<=":s}});i.limit=1,i.index={ownerUserId:Ye.LocalDB.Query.Order.ASC,channelUrl:Ye.LocalDB.Query.Order.ASC,filterKey:Ye.LocalDB.Query.Order.ASC,endAt:Ye.LocalDB.Query.Order.DESC},t.find(i,(e,t)=>{if(e)r(e);else{const e=t.length>0?Y.createFromJson(t[0]):null;if(e)if(e.endAt>n.endAt)if(e.isOverlap(n))n.extendWithChunk(e),this.upsert(n,r);else{const t=new Y(n.channelUrl,n.filter);t.startAt=e.startAt,t.endAt=e.endAt,this.upsert(t,r)}else r(null,n);else r(null,n)}})}else r(null)}})}else r(A.create(A.Type.ERROR_SETUP_MISSING))},this.mergePreviousChunkOverlap=(e,n)=>{const s=Ye.getInstance();if(s.currentUserId){const r=new Ye.LocalDB.Query({ownerUserId:s.currentUserId,chunkId:{"!=":e.chunkId},channelUrl:e.channelUrl,filterKey:e.filterKey,endAt:{">=":e.startAt}});r.limit=1/0,t.find(r,(s,r)=>{if(s)n(s);else if(r.length>0){const s=new Ye.LocalDB.Query({chunkId:{"/in":r.map(e=>e.chunkId)}});t.removeIf(s,t=>{if(t)n(t);else{for(let t=0;t<r.length;t++)e.extendWithChunk(r[t]);this.upsert(e,n)}})}else this.upsert(e,n)})}else n(A.create(A.Type.ERROR_SETUP_MISSING))},this};function Z(e,t,n){return n?t.channelUrl===e.url&&((!n.messageType||n.messageType===t.messageType)&&((!n.customType||n.customType===t.customType)&&!(Array.isArray(n.senderUserIdsFilter)&&n.senderUserIdsFilter.length>0&&t.sender&&n.senderUserIdsFilter.indexOf(t.sender.userId)<0))):t.channelUrl===e.url}const ee=function(){let e=[];return this.addCollection=(t,n)=>{e.push({controller:t,view:n})},this.removeCollection=t=>{const n=e.map(e=>e.controller).indexOf(t);n>=0&&(e[n].controller._pause(),e.splice(n,1))},this.clearCollection=()=>{for(let t in e)e[t].controller._pause();e=[]},this.pause=()=>{for(let t in e)e[t].controller._pause()},this.resume=()=>{for(let t in e)e[t].controller._resume()},this.upsert=(t,n)=>{if(t.length>0)for(let s in e){const r=e[s];if(r.controller!==n){const e=[];for(let n in t){const s=t[n];Z(r.controller.channel,s,r.controller.filter)&&e.push(s)}e.length>0&&r.view.addViewItems(e,{isEventMessage:!0,direction:"next"})}}},this.update=(t,n)=>{if(t.length>0)for(let s in e){const r=e[s];if(r.controller!==n){const e=[];for(let n in t){const s=t[n];Z(r.controller.channel,s,r.controller.filter)&&r.view.messages.map(e=>e.messageId).indexOf(s.messageId)>=0&&e.push(s)}e.length>0&&r.view.addViewItems(e,{isEventMessage:!0,direction:"next"})}}},this.read=(t,n)=>{for(let s in e){const r=e[s];r.controller!==n&&r.controller.channel.url===t.url&&(r.controller.channel=t,r.view.addViewItems(r.view.messages))}},this.remove=(t,n,s={})=>{if(t.length>0)for(let r in e){const i=e[r];i.controller!==n&&i.view.removeViewItems(t,s)}},this.clear=()=>{for(let t in e){e[t].view.clearViewItem()}},this};function te(){this.onChannelEvent=(e,t)=>{}}function ne(){this.onPendingMessageEvent=(e,t)=>{},this.onFailedMessageEvent=(e,t,n)=>{},this.onSucceededMessageEvent=(e,t)=>{},this.onNewMessage=e=>{},this.onMessageEvent=(e,t)=>{}}const se={INSERT:"insert",UPDATE:"update",MOVE:"move",REMOVE:"remove",CLEAR:"clear"},re={INSERT:"insert",UPDATE:"update",REMOVE:"remove",CLEAR:"clear"},ie={NONE:"none",UPDATE_RESEND_FAILED:"update_resend_failed",REMOVE_RESEND_SUCCEEDED:"remove_resend_succeeded",REMOVE_RETENTION_EXPIRED:"remove_retention_expired",REMOVE_EXCEEDED_MAX_COUNT:"remove_exceeded_max_count",REMOVE_MANUAL_ACTION:"remove_manual_action",REMOVE_UNKNOWN:"remove_unknown"};class ae{constructor({channelUrl:e}){this._resendingTimer=null;let t=!1;Object.defineProperty(this,"_isRunning",{get:()=>t,set:e=>{t=e,this._toggleResendingInterval()}}),this._clear(),this.collectionReferenceCount=1,this._channelUrl=e}_clear(){this._retryCount=0,this._delayTime=0,this._isRunning=!1,this.manualMessages=[],this.automaticMessages=[],clearTimeout(this._resendingTimer),this._resendingTimer=null}_appendMessagesWithOrder(e,t={}){const n=t.hasOwnProperty("isAutomatic")?t.isAutomatic:Ye.syncManagerOptions.messageResendPolicy===Ye.Options.MessageResendPolicy.AUTOMATIC;e.forEach(e=>{const t=n?this.automaticMessages.length:this.manualMessages.length;let s=t;for(let r=0;r<t;r++){const t=n?this.automaticMessages[r]:this.manualMessages[r];if(e.createdAt<t.createdAt){s=r;break}}n?this.automaticMessages.splice(s,0,e):this.manualMessages.splice(s,0,e)})}appendMessages(e){const t=0===this.automaticMessages.length,n=Ye.syncManagerOptions.messageResendPolicy===Ye.Options.MessageResendPolicy.AUTOMATIC,s=e.length;let r=[],i=!1;for(let t=0;t<s;t++){const s=e[t];i=!1;let a=[];n&&(a=this.automaticMessages),(i=[...a,...this.manualMessages].filter(e=>e.reqId===s.reqId).length>0)||r.push(s)}this._appendMessagesWithOrder(r),t&&this.automaticMessages.length>0&&this._resendUserMessage()}removeMessages(e){const t=Ye.syncManagerOptions.messageResendPolicy===Ye.Options.MessageResendPolicy.AUTOMATIC,n=e.length;let s=!1;for(let r=0;r<n;r++){const n=e[r];s=!1,t&&(this.automaticMessages=this.automaticMessages.filter(e=>e.reqId!==n.reqId||(s=!0,!1))),s||(this.manualMessages=this.manualMessages.filter(e=>e.reqId!==n.reqId))}}_resendUserMessage(){this._retryCount++;const e=this.automaticMessages[0];if(Ye.syncManagerOptions.automaticMessageResendRetryCount!==Ye.Options.INFINITY&&this._retryCount>Ye.syncManagerOptions.automaticMessageResendRetryCount)return this._appendMessagesWithOrder(this.automaticMessages,{isAutomatic:!1}),this.automaticMessages=[],ue.getInstance().upsertMessages(this._channelUrl,this.manualMessages),void this._clear();this._resendingTimer=setTimeout(()=>{if(e&&this._isRunning){const t=pe.getInstance(),n=t.sb,s=n.getErrorFirstCallback();n.GroupChannel.getChannel(this._channelUrl,(n,r)=>{if(s){const e=r;r=n,n=e}r?(this._increaseDelayTime(),this._resendUserMessage()):n.resendUserMessage(e,(n,r)=>{if(s){const e=r;r=n,n=e}if(r){if(800110===r.code){const t={reason:ie.REMOVE_UNKNOWN};ue.getInstance().removeMessages(this._channelUrl,[e],t),this.removeMessages([e])}else this._increaseDelayTime();this._resendUserMessage()}else{this.automaticMessages.shift(),this._retryCount=0,this._delayTime=0;const s={reason:ie.REMOVE_RESEND_SUCCEEDED};ue.getInstance().removeMessages(this._channelUrl,[e],s),t.messageContainer.upsert(n,(e,n)=>{e||t.broadcast.upsert([n]),this._resendUserMessage()})}})})}else this._retryCount=0,this._delayTime=0},this._delayTime)}_increaseDelayTime(){this._delayTime=1e4===this._delayTime?this._delayTime:this._delayTime+2e3}_toggleResendingInterval(){this._isRunning?this._resendUserMessage():(clearTimeout(this._resendingTimer),this._resendingTimer=null,this._retryCount=0,this._delayTime=0)}resumeResending(){this._retryCount=0,this._delayTime=0,this._isRunning=!0}pauseResending(){this._isRunning=!1}increaseCount(){++this.collectionReferenceCount}decreaseCount(){--this.collectionReferenceCount,0===this.collectionReferenceCount&&this._clear()}}const oe=432e5;class ce{constructor({msec:e=0,isEternal:t=!0,timeoutFn:n=(()=>{})}){this.time=e,this.isEternal=t,this.timeoutFn=n,this.checker=null}reset(){this.stop(),this.time=0,this.timeoutFn=()=>{}}start(){if(null===this.checker){const e=(new Date).getTime();this.checker=setTimeout(()=>{(new Date).getTime()-e>=this.time&&(this.isEternal?this.start():this.stop(),this.timeoutFn&&"function"==typeof this.timeoutFn&&this.timeoutFn())},oe)}}stop(){clearTimeout(this.checker),this.checker=null}}let le=null;class ue{constructor(){if(le)return le;this.queueMap={},this.expirationTimer=new ce({msec:864e5*Ye.syncManagerOptions.failedMessageRetentionDays,isEternal:!0,timeoutFn:this.removeExpiredMessages}),this.oldestFailedMessageTs=0,le=this}getMessages(e){return this.queueMap[e]?this.queueMap[e].messages:[]}loadFailedMessages(e,t,n){pe.getInstance().messageContainer.loadFailedMessages(e,{},{},(s,r)=>{let i=r;if(!s){k.cache("fetch failed message",r.map(e=>e.reqId));const n=this.queueMap[e];n&&(n.appendMessages(r),n.resumeResending()),i=r.filter(e=>{let n=!0,s=!0,r=!0;if(t.messageTypeFilter&&(n=e.messageType===Y.MessageTypeFilterRealValue[t.messageTypeFilter]),t.customTypeFilter&&(s=e.customType===t.customTypeFilter),t.senderUserIdsFilter&&Array.isArray(t.senderUserIdsFilter)&&t.senderUserIdsFilter.length>0&&(r=e.sender&&t.senderUserIdsFilter.indexOf(e.sender.userId)>-1),n&&s&&r)return e})}n(s,i)})}removeExpiredMessages(e){this.expirationTimer.stop();const t=Math.floor(((new Date).getTime()-this.oldestFailedMessageTs)/864e5);if(0!==this.oldestFailedMessageTs&&t<Ye.syncManagerOptions.failedMessageRetentionDays)return this.expirationTimer.start(),void(e&&e());const n=pe.getInstance(),s=Ye.syncManagerOptions.failedMessageRetentionDays;n.messageContainer.removeExpiredMessages(s,(t,s)=>{if(t)return k.error("Fail remove expired failedMessage by failedMessageRetentionDays:",t),this.expirationTimer.start(),void(e&&e());let r={};s.forEach(e=>{const t=e.channelUrl;r[t]&&Array.isArray(r[t])||(r[t]=[]),r[t].push(e)}),Object.keys(r).forEach(e=>{const t=r[e].map(e=>e.reqId),s={isRequestId:!0,reason:ie.REMOVE_RETENTION_EXPIRED};n.broadcast.remove(t,{},s),this.queueMap.hasOwnProperty(e)&&this.queueMap[e].removeMessages(r[e])}),n.messageContainer.loadOldestFailedMessages((t,n)=>{t?(k.error("Fail get oldestFailedMessage from DB: ",t),this.oldestFailedMessageTs=0):this.oldestFailedMessageTs=n.length>0?n[0].createdAt:(new Date).getTime(),this.expirationTimer.start(),e&&e()})})}removeExceedingMaxCount(e){const t=pe.getInstance(),n=new b.Query({ownerUserId:Ye.getInstance().currentUserId,channelUrl:e,requestState:"failed"});n.limit=Number.MAX_SAFE_INTEGER,n.index={ownerUserId:Ye.LocalDB.Query.Order.ASC,createdAt:Ye.LocalDB.Query.Order.ASC},t.messageContainer.count(n,(e,s)=>{if(e)return void k.error("Get count about failedMessage by maxFailedMessageCountPerChannel:",e);const r=Ye.syncManagerOptions.maxFailedMessageCountPerChannel;s>r&&(n.limit=s-r,t.messageContainer.find(n,(e,n)=>{const s={isRequestId:!0,reason:ie.REMOVE_EXCEEDED_MAX_COUNT};n.forEach(e=>{const n=e.reqId;t.messageContainer.removeUnsent(n,r=>{r&&k.error("Fail remove count failedMessage by maxFailedMessageCountPerChannel:",r),t.broadcast.remove([n],{},s),this.queueMap[e.channelUrl].removeMessages([e])})})}))})}upsertMessages(e,t){const n=pe.getInstance(),s=this.queueMap[e];t.forEach(t=>{n.messageContainer.upsert(t,(r,i)=>{r||n.broadcast.upsert([i]),s&&s.appendMessages([t]),this.removeExceedingMaxCount(e)})})}removeMessages(e,t,n){const s=pe.getInstance(),r=this.queueMap[e];t.forEach(e=>{e.reqId&&s.messageContainer.removeUnsent(e.reqId,t=>{t?k.error("deleteMessage()",`Failed to delete message from cache: ${e}`):(n.isRequestId=!0,s.broadcast.remove([e.reqId],{},n),r&&r.removeMessages([e]))})})}resume(){this.removeExpiredMessages(()=>{this.resumeAllQueues()})}pause(){this.pauseAllQueues(),this.expirationTimer.stop()}resumeAllQueues(){Object.keys(this.queueMap).forEach(e=>{const t=this.queueMap[e];t&&t.resumeResending()})}pauseAllQueues(){Object.keys(this.queueMap).forEach(e=>{const t=this.queueMap[e];t&&t.pauseResending()})}createQueue(e){const t=this.queueMap[e];t?t.increaseCount():this.queueMap[e]=new ae({channelUrl:e}),this.queueMap[e].resumeResending()}removeQueue(e){const t=this.queueMap[e];t&&(t.decreaseCount(),0===t.collectionReferenceCount&&delete this.queueMap[e])}static getInstance(){return new ue}}const he="last-changeLog-token-",de="syncManager_messageManager_channelHandler_"+(new Date).getTime(),fe=100;let ge=null;class pe{constructor({sendBird:e,db:t}){if(!ge){k.call("MessageManager()"),ge=this,this.sb=e;const n=this.sb;this.messageContainer=new z(t,n),this.chunkContainer=new X(t),this.broadcast=new ee,this.isFetchingChangeLogByChannelUrl={};const s=new n.ChannelHandler;Object.keys(s).forEach(e=>{s[e]=(...t)=>{switch(e){case"onMessageReceived":k.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!0,ge.messageContainer.upsert(t[1],(e,t)=>{e?A.throw(e):ge.broadcast.upsert([t])});break;case"onReadReceiptUpdated":{k.event(e,t[0].url);const n=t[0];ge.broadcast.read(n);break}case"onMessageUpdated":k.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!1,ge.messageContainer.upsert(t[1],(e,t)=>{e?A.throw(e):ge.broadcast.update([t])});break;case"onMessageDeleted":{k.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message);const n=parseInt(t[1]);ge.messageContainer.remove(n,(e,t)=>{e?A.throw(e):ge.broadcast.remove([t])});break}}}}),n.addChannelHandler(de,s)}return ge}static getInstance(){return ge}static clear(){ge&&ge.sb&&(k.message("MessageManager is cleared"),ge.broadcast.clearCollection(),ge.sb.removeChannelHandler(de),ge=null)}syncChangeLog(e,t=(()=>{})){if(this.isFetchingChangeLogByChannelUrl[e.url])t(A.create(A.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLogByChannelUrl[e.url]=!0,k.call("message syncChangeLog()",e.url);const n=`${he}${e.url}`;C.get(n).then(s=>{let r="getMessageChangeLogsByToken";const i=[];s?(r="getMessageChangeLogsByToken",i.unshift(s)):(r="getMessageChangeLogsByTimestamp",i.unshift((new Date).getTime()-fe)),k.call(r),e[r](...i,(s,r)=>{if(this.sb.getErrorFirstCallback()){const e=s;s=r,r=e}r?this.isFetchingChangeLogByChannelUrl[e.url]=!1:(k.sync("updated",s.updatedMessages.map(e=>e.messageId)),k.sync("deleted",s.deletedMessageIds),s.updatedMessages.forEach(e=>{ge.messageContainer.getItemWithVisibility(e.messageId,(t,n)=>{if(!t){const t=n.item;e.isVisible=n.isVisible||!1,ge.messageContainer.upsert(e,(e,n)=>{if(e)A.throw(e);else{(!t||!t.isEqual(n))&&ge.broadcast.update([n])}})}})}),s.deletedMessageIds.forEach(e=>{ge.messageContainer.remove(e,t=>{t?A.throw(t):ge.broadcast.remove([e])})}),C.set(n,s.token).then(()=>{s.hasMore?this.syncChangeLog(e,t):(this.isFetchingChangeLogByChannelUrl[e.url]=!1,t())}).catch(n=>{this.isFetchingChangeLogByChannelUrl[e.url]=!1,t(n)}))})}).catch(n=>{this.isFetchingChangeLogByChannelUrl[e.url]=!1,t(n)})}}start(){ge.broadcast.resume(),ue.getInstance().resume()}stop(){ge.broadcast.pause(),ue.getInstance().pause()}clearCache(e){ge.messageContainer.clear(()=>{ge.chunkContainer.clear(()=>{C.getKeys().then(t=>{const n=[];t.forEach(e=>{e.startsWith(he)&&n.push(C.remove(e))}),Promise.all(n).then(()=>e()).catch(t=>{k.error(t),e(t)})}).catch(t=>e(t))})})}reset(e){ge?(ge.broadcast.clear(),ge.clearCache(e)):e(null)}}const me=6e4,ye=200;class Ie{constructor(){this.locked=!1,this.lockedAt=(new Date).getTime()+me}isLocked(){return this.locked}lock(e){this.locked?setTimeout(()=>{(new Date).getTime()-this.lockedAt<me&&this.lock(e)},ye):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(()=>this.unlock()))}unlock(){this.locked=!1,this.lockedAt=(new Date).getTime()+me}}const be=100,ve=500;class Ee{constructor(e){this.worker=e,this.state=Ee.State.PAUSED,this.isLoading=!1,this.shared=0,this.retry=0,this.retryLimit=3,this.subscribes={}}static get State(){return{RUNNING:"running",PAUSED:"paused",END:"end"}}get isRunning(){return this.state===Ee.State.RUNNING}start(e,t=!1){(t||this.state!==Ee.State.END)&&(this.isLoading||(this.isLoading=!0,this.state=Ee.State.RUNNING,this.worker(e,(t,n)=>{k.sync("background sync result: err=",t,"res=",n),this.isRunning&&(t?this.retry<this.retryLimit?(this.retry++,setTimeout(()=>this.start(e),ve)):this.state=Ee.State.PAUSED:(this.retry=0,this.flush(t,n),n.hasMore?setTimeout(()=>{this.isRunning&&this.start(n.nextTs)},be):this.state=Ee.State.END)),this.isLoading=!1})))}pause(){this.isLoading=!1,this.state=Ee.State.PAUSED}end(){this.isLoading=!1,this.state=Ee.State.END}flush(e=null,t){k.sync(`background sync flush: ${Object.keys(this.subscribes).length} subscribes`);for(let n in this.subscribes)this.subscribes[n](e,t);this.subscribes={}}subscribe(e,t){return!this.subscribes[e]&&(this.subscribes[e]=t,!0)}unsubscribeAll(){this.subscribes={}}}const Ce="channel-collection-handler",we=new c.a,Me=new c.a,Oe=e=>{const t=L.getInstance();if(t){const n=e.query,s=n.filterKey;return t.channelSyncByFilter[s]||(t.channelSyncByFilter[s]=new Ee((s,r)=>{k.call("channel syncChannel()",n.filterKey,n.hasNext,n._token),n.hasNext?(n.limit=100,n.next((s,i)=>{if(t.sb.getErrorFirstCallback()&&([i,s]=[s,i]),k.sync("channel",i,s&&s.length>0?"\n"+s.map(e=>"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt).join("\n"):""),i)r(i);else{const i=we.get(e);let a=0,o=null;for(let e=0;e<s.length;e++)t.channelContainer.insert(s[e],e=>{if(o=o||e,++a===s.length)if(o)r(o);else{const e=i.findChannelEdges(s);e.end&&(n.savepoint=e.end+""),t.queryContainer.upsert(n,e=>{e?r(e):r(null,{count:s.length,nextTs:0,hasNext:n.hasNext})})}})}})):r(null,{count:0,nextTs:0,hasNext:!1})})),t.channelSyncByFilter[s]}return null},ke=e=>{const t=L.getInstance();if(t){if(!t.changeLogSync){const n=e.query;t.changeLogSync=new Ee((e,s)=>{t.syncChangeLog(n,e=>{s(e,{count:0,nextTs:0,hasNext:!1})})})}return t.changeLogSync}return null};class Ae{constructor(){this.collection=null,this.channels=[],this.mutex=new Ie,this.viewOffset=null}attachCollection(e){this.collection=e}compareWithChannel(e,t){let n="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":n="createdAt";break;case"channel_name_alphabetical":n="name"}return this.compareWithOffset(e,t[n])}compareWithOffset(e,t){switch(this.collection.query.order){case"latest_last_message":return e.lastMessageUpdatedAt-t;case"chronological":return e.createdAt-t;case"channel_name_alphabetical":return t.localeCompare(e.name);default:return e.lastMessageUpdatedAt-t}}isAbove(e,t){return this.compareWithOffset(e,t)>0}isBelow(e,t){return this.compareWithOffset(e,t)<0}findChannelEdges(e){let t="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":t="createdAt";break;case"channel_name_alphabetical":t="name"}const n={start:null,end:null};for(let s in e)n.start&&!this.isAbove(e[s],n.start)||(n.start=e[s][t]),n.end&&!this.isBelow(e[s],n.end)||(n.end=e[s][t]);return n}refreshViewOffset(){const e=this.findChannelEdges(this.channels);this.viewOffset=e.end}addViewItems(e,t={}){const n=[],s=[],r=[],i=[],a=Me.get(this.collection);this.mutex.lock(o=>{for(let a in e){const o=e[a],c=P(o,this.channels),l=q(o,this.collection.query,this.channels);let u=!1;t.isEventChannel&&(this.viewOffset?this.isBelow(o,this.viewOffset)&&(u=!0):t.isChangeLogEvent||(this.collection.query.hasNext||this.collection.query.savepoint)&&(u=!0));let h=c<0?se.INSERT:se.UPDATE;switch(c<0?u||(l<this.channels.length?this.channels.splice(l,0,o):this.channels.push(o)):c!==l?l<this.channels.length?(h=se.MOVE,this.channels.splice(c,1),l>c?this.channels.splice(l-1,0,o):this.channels.splice(l,0,o)):(h=se.REMOVE,this.channels.splice(c,1)):this.channels[c]=o,h){case se.INSERT:u||n.push(o);break;case se.UPDATE:s.push(o);break;case se.MOVE:r.push(o);break;case se.REMOVE:i.push(o)}}if(this.refreshViewOffset(),n.length>0){k.view("channel",se.INSERT,"\n"+n.map(e=>`\turl=${e.url} name=${e.name} createdAt=${e.createdAt} lastMessageUpdatedAt=${e.lastMessageUpdatedAt}`).join("\n"));for(const e in a)a[e].onChannelEvent(se.INSERT,n)}if(s.length>0){k.view("channel",se.UPDATE,"\n"+s.map(e=>`\turl=${e.url} name=${e.name} createdAt=${e.createdAt} lastMessageUpdatedAt=${e.lastMessageUpdatedAt}`).join("\n"));for(const e in a)a[e].onChannelEvent(se.UPDATE,s)}if(r.length>0){k.view("channel",se.MOVE,"\n"+r.map(e=>`\turl=${e.url} name=${e.name} createdAt=${e.createdAt} lastMessageUpdatedAt=${e.lastMessageUpdatedAt}`).join("\n"));for(const e in a)a[e].onChannelEvent(se.MOVE,r)}if(i.length>0){k.view("channel",se.REMOVE,"\n"+i.map(e=>`\turl=${e.url} name=${e.name} createdAt=${e.createdAt} lastMessageUpdatedAt=${e.lastMessageUpdatedAt}`).join("\n"));for(const e in a)a[e].onChannelEvent(se.REMOVE,i)}o()})}removeViewItems(e){const t=Me.get(this.collection);this.mutex.lock(n=>{const s=[];for(let t in e){const n=e[t],r=this.channels.map(e=>e.url).indexOf(n.url);r>=0&&(this.channels.splice(r,1),s.push(n))}if(s.length>0){k.view("channel",se.REMOVE,"\n"+s.map(e=>`\turl=${e.url} name=${e.name} createdAt=${e.createdAt} lastMessageUpdatedAt=${e.lastMessageUpdatedAt}`).join("\n"));for(const e in t)t[e].onChannelEvent(se.REMOVE,s)}n()})}clearViewItem(){this.channels=[];const e=Me.get(this.collection);this.mutex.lock(t=>{const n=se.CLEAR;k.view("channel",n);for(const t in e)e[t].onChannelEvent(n);t()})}}class Te{constructor(e){const t=new Ae,n=L.getInstance();if(!n)return null;this.collectionId=G(),this.sendBird=n.sb,this.type="MyGroupChannelListQuery",this.limit=e.limit,this.query=e,this.query.filterKey=n.queryContainer.createFilterKey(this.query),this._isLoading=!1,t.attachCollection(this),n.broadcast.addCollection(this,t),we.set(this,t),Me.set(this,{}),Oe(this).shared++,ke(this).shared++,n.queryContainer.getItem(this.query.filterKey,(t,s)=>{t?A.throw(t):(s&&(this.query._token=s._token,this.query.hasNext=s.hasNext,this.query.savepoint=s.savepoint,this.query.updatedAt=s.updatedAt),n.queryContainer.upsert(e,(e,t)=>{e?A.throw(e):(this.query=t,this._resume(),k.message(`channel collection ${this.collectionId} is created.`))}))})}static get CollectionHandler(){return te}static get Action(){return se}get channels(){return we.get(this).channels}_pause(){k.call("channel sync pause",this.collectionId);const e=Oe(this),t=ke(this);e&&e.pause(),t&&t.pause()}_resume(){k.call("channel sync resume",this.collectionId);const e=Oe(this),t=ke(this);e&&e.start(),t&&t.start()}fetch(e){if(!this._isLoading)return this._isLoading=!0,Q(e=>{k.call("fetch()");const t=we.get(this),n=this.sendBird,s=Ye.getInstance(),r=L.getInstance(),i={ownerUserId:s.currentUserId};if(this.query.includeEmpty||(i.lastMessage={"!=":null}),this.query.nicknameContainsFilter&&(i.members={"/where":e=>{for(let t in e)if(e[t].nickname.indexOf(this.query.nicknameContainsFilter)>=0)return!0;return!1}}),this.query.userIdsFilter.length>0&&(i.members={"/where":e=>{const t=e.map(e=>e.userId);return this.query.userIdsFilterExactMatch?t.length===this.query.userIdsFilter.length&&this.query.userIdsFilter.every(e=>t.indexOf(e)>=0):"AND"===this.query.queryType?this.query.userIdsFilter.every(e=>t.indexOf(e)>=0):"OR"===this.query.queryType&&this.query.userIdsFilter.reduce((e,n)=>e=e||t.indexOf(n)>=0,!1)}}),this.query.channelNameContainsFilter&&(i.name={"/regex":new RegExp(this.query.channelNameContainsFilter)}),this.query.channelUrlsFilter.length>0&&(i.url={"/in":this.query.channelUrlsFilter}),this.query.memberStateFilter!==n.GroupChannel.memberStateFilter.ALL)switch(this.query.memberStateFilter){case n.GroupChannel.memberStateFilter.JOINED:i.myMemberState=n.GroupChannel.memberStateFilter.JOINED;break;case n.GroupChannel.memberStateFilter.INVITED:case n.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case n.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:i.myMemberState={"/in":[n.GroupChannel.memberStateFilter.INVITED,n.GroupChannel.memberStateFilter.INVITED_BY_FRIEND,n.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND]}}if("string"==typeof this.query.customTypeFilter&&this.query.customTypeFilter&&(i.customType=this.query.customTypeFilter),Array.isArray(this.query.customTypesFilter)&&this.query.customTypesFilter.length>0&&(i.customType={"/in":this.query.customTypesFilter}),"string"==typeof this.query.customTypeStartsWithFilter&&this.query.customTypeStartsWithFilter&&(i.customType={"/regex":new RegExp(`^${this.query.customTypeStartsWithFilter}`)}),this.query.superChannelFilter!==n.GroupChannel.superChannelFilter.ALL)switch(this.query.superChannelFilter){case n.GroupChannel.superChannelFilter.SUPER:i.isSuper=!0;break;case n.GroupChannel.superChannelFilter.NONSUPER:i.isSuper=!1}if(this.query.publicChannelFilter!==n.GroupChannel.publicChannelFilter.ALL)switch(this.query.publicChannelFilter){case n.GroupChannel.publicChannelFilter.PUBLIC:i.isPublic=!0;break;case n.GroupChannel.publicChannelFilter.PRIVATE:i.isPublic=!1}if(this.query.unreadChannelFilter!==n.GroupChannel.UnreadChannelFilter.ALL)switch(this.query.unreadChannelFilter){case n.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:i.unreadMessageCount={">":0}}if("all"!=this.query.hiddenChannelFilter)switch(this.query.hiddenChannelFilter){case n.GroupChannel.HiddenChannelFilter.UNHIDDEN:i.hiddenState=n.GroupChannel.HiddenState.UNHIDDEN;break;case n.GroupChannel.HiddenChannelFilter.HIDDEN:i.hiddenState={"/in":[n.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE,n.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE]};break;case n.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:i.hiddenState=n.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE;break;case n.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:i.hiddenState=n.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE}let a=null,o=!0;switch(this.query.order){case"latest_last_message":!this.query.hasNext&&this.query.savepoint&&(i.lastMessageUpdatedAt={">=":parseInt(this.query.savepoint)}),a={ownerUserId:1,lastMessageUpdatedAt:-1};break;case"chronological":!this.query.hasNext&&this.query.savepoint&&(i.createdAt={">=":parseInt(this.query.savepoint)}),a={ownerUserId:1,createdAt:-1};break;case"channel_name_alphabetical":!this.query.hasNext&&this.query.savepoint&&(i.name={"<=":this.query.savepoint}),a={ownerUserId:1,name:1},o=!1;break;default:!this.query.hasNext&&this.query.savepoint&&(i.lastMessageUpdatedAt={">=":parseInt(this.query.savepoint)}),a={ownerUserId:1,lastMessageUpdatedAt:-1}}const c=Oe(this),l=(e,n)=>{r.channelContainer.query(i,{offset:t.channels.length,limit:e,index:a,desc:o},(s,r)=>{s?(this._isLoading=!1,n(s)):(this._isLoading=!1,r.sort((e,n)=>t.compareWithChannel(e,n)>0),r.length>0&&t.addViewItems(r),r.length<e&&u(e-r.length),n(null,r))})},u=e=>{c.state!==Ee.State.END&&(k.sync("subscribe channel",this.collectionId),c.subscribe(this.collectionId,t=>{t?k.error(t):(k.sync("flush channel"),l(e,e=>{e&&k.error(e)}))}))};l(this.limit,(t,n)=>{k.cache("fetch channel",t,n.map(e=>e.url)),e(t)}),c.state===Ee.State.PAUSED&&this._resume()},e);k.error("fetch() is loading"),e(A.create(A.Type.ERROR_DUPLICATED_FETCH))}remove(){L.getInstance().broadcast.removeCollection(this);const e=Oe(this),t=ke(this);e&&(e.shared--,0===e.shared&&e.pause()),t&&(t.shared--,0===t.shared&&t.pause())}setCollectionHandler(e){const t=Me.get(this);e instanceof te&&(t[Ce]=e)}removeCollectionHandler(){const e=Me.get(this);e[Ce]&&delete e[Ce]}}const Se=new c.a,_e=new c.a,xe=new c.a,Re=new c.a,Ue=new c.a,De="message-collection-handler",Ne=300,Fe=50,Le=100,Pe=100,qe=50;class je{constructor(){this.collection=null,this.messages=[],this.prevTempMessages=[],this.nextTempMessages=[],this.unsentMessages=[],Se.set(this,{}),this.currentChunk=null,this.viewRange={start:0,end:0}}attachCollection(e){this.collection=e}addViewItems(e,t={}){const n=Ue.get(this.collection),s=Se.get(this),r=Re.get(this.collection),i=[],a=[],o=[],c=[],l=[],u=[],h=[],d=[],f=[];for(let n in e){const g=e[n];if(g.messageId){let e=!0,n=!1;if(t.isEventMessage){const t=r.state===Ee.State.END,s=!this.currentChunk||this.currentChunk.endAt<=this.viewRange.end,i=0===this.viewRange.end;n=!0,e=t&&s||!this.currentChunk||i}const l=this.collection.sendBird.currentUser?this.collection.channel.getReadReceipt(g):s[g.messageId]||0;if(s[g.messageId]||(s[g.messageId]=l),e){const e=j(g,this.messages),t=B(g,this.messages);if(e>=0&&this.messages[e].isEqual(g)&&s[g.messageId]===l)continue;if(s[g.messageId]=l,this.viewRange.start=this.viewRange.start>0?Math.min(this.viewRange.start,g.createdAt):g.createdAt,this.viewRange.end=this.viewRange.end>0?Math.max(this.viewRange.end,g.createdAt):g.createdAt,e<0){const e=j(g,this.unsentMessages);if(e>=0){const t=this.unsentMessages[e],n=!t.isUserMessage()||"pending"===t.requestState;this.unsentMessages.splice(e,1),n?u.push(t):f.push(t)}this.messages.splice(t,0,g),n&&this.nextTempMessages.push(g),i.push(g)}else this.messages[e]=g,a.push(g)}else c.push(g);const h=this.messages.length;let d=[];if(h>Ye.syncManagerOptions.messageCollectionCapacity){if("next"===t.direction){const e=h-Ye.syncManagerOptions.messageCollectionCapacity;d=this.messages.splice(0,e)}else d=this.messages.splice(Ye.syncManagerOptions.messageCollectionCapacity);o.push(...d)}}else{const e=!g.isUserMessage()||"pending"===g.requestState,t=j(g,this.unsentMessages);if(t<0){j(g,this.messages)<0&&(e?l.push(g):h.push(g),this.unsentMessages.push(g))}else{const n=this.unsentMessages[t];n.isUserMessage()?"pending"===n.requestState?e||(u.push(n),h.push(g),this.unsentMessages[t]=g):(d.push(g),this.unsentMessages[t]=g):this.unsentMessages[t]=g}}}if(o.length>0){k.view("message",re.REMOVE,o.map(e=>e.messageId+" "+e.createdAt));for(const e in n)n[e].onSucceededMessageEvent(o,re.REMOVE),n[e].onMessageEvent(re.REMOVE,o)}if(i.length>0){k.view("message",re.INSERT,i.map(e=>e.messageId+" "+e.createdAt));for(const e in n)n[e].onSucceededMessageEvent(i,re.INSERT),n[e].onMessageEvent(re.INSERT,i)}if(a.length>0){k.view("message",re.UPDATE,a.map(e=>e.messageId+" "+e.createdAt));for(const e in n)n[e].onSucceededMessageEvent(a,re.UPDATE),n[e].onMessageEvent(re.UPDATE,a)}if(u.length>0){k.view("pending message",re.REMOVE,u.map(e=>e.reqId+" "+e.createdAt));for(const e in n)n[e].onPendingMessageEvent(u,re.REMOVE),n[e].onMessageEvent(re.REMOVE,u)}if(l.length>0){k.view("pending message",re.INSERT,l.map(e=>e.reqId+" "+e.createdAt));for(const e in n)n[e].onPendingMessageEvent(l,re.INSERT),n[e].onMessageEvent(re.INSERT,l)}if(f.length>0){k.view("failed message",re.REMOVE,f.map(e=>e.reqId+" "+e.createdAt));const e=ie.REMOVE_RESEND_SUCCEEDED;for(const t in n)n[t].onFailedMessageEvent(f,re.REMOVE,e)}if(d.length>0){k.view("failed message",re.UPDATE,d.map(e=>e.reqId+" "+e.createdAt));const e=ie.UPDATE_RESEND_FAILED;for(const t in n)n[t].onFailedMessageEvent(d,re.UPDATE,e)}if(h.length>0){k.view("failed message",re.INSERT,h.map(e=>e.reqId+" "+e.createdAt));const e=ie.NONE;for(const t in n)n[t].onFailedMessageEvent(h,re.INSERT,e)}if(c.length>0)for(let e=0;e<c.length;e++){const t=c[e];k.view("new message",t.messageId);for(const e in n)n[e].onNewMessage(t)}}removeViewItems(e,t={isRequestId:!1}){const n=!!t.hasOwnProperty("isRequestId")&&t.isRequestId,s=Ue.get(this.collection);if(n){const n=[],r=[];for(let t=0;t<e.length;t++){const s=e[t];for(let e=0;e<this.unsentMessages.length;e++)if(s===this.unsentMessages[e].reqId){const t=this.unsentMessages[e];if(t.isUserMessage())switch(t.requestState){case"pending":n.push(t);break;case"failed":r.push(t)}else t.isFileMessage()&&n.push(t);this.unsentMessages.splice(e,1);break}}if(n.length>0){k.view("pending message",re.REMOVE,n.map(e=>e.reqId));for(const e in s)s[e].onPendingMessageEvent(n,re.REMOVE),s[e].onMessageEvent(re.REMOVE,n)}if(r.length>0){k.view("failed message",re.REMOVE,r.map(e=>e.reqId));const e=t.hasOwnProperty("reason")?t.reason:ie.REMOVE_UNKNOWN;for(const t in s)s[t].onFailedMessageEvent(r,re.REMOVE,e)}}else{const t=Se.get(this),n=[];for(let s=0;s<e.length;s++){const r=e[s];for(let e=0;e<this.messages.length;e++)if(r===this.messages[e].messageId){"number"==typeof t[r]&&delete t[r];const s=this.messages.splice(e,1);n.push(...s);break}}if(this.viewRange.start=this.messages.length>0?this.messages[0].createdAt:0,this.viewRange.end=this.messages.length>0?this.messages[this.messages.length-1].createdAt:0,n.length>0){k.view("message",re.REMOVE,n.map(e=>e.messageId));for(const e in s)s[e].onSucceededMessageEvent(n,re.REMOVE),s[e].onMessageEvent(re.REMOVE,n)}}}clearUnsentMessages(){const e=this.unsentMessages,t=Ue.get(this.collection);this.unsentMessages=[],k.view("message",re.REMOVE,"unsent messages");for(const n in t){t[n].onPendingMessageEvent([],re.CLEAR);const s=ie.NONE;t[n].onFailedMessageEvent([],re.CLEAR,s),t[n].onMessageEvent(re.REMOVE,e)}}clearViewItem(){this.currentChunk=null,this.messages=[],Se.set(this,{}),this.viewRange.start=0,this.viewRange.end=0;const e=Ue.get(this.collection);k.view("message",re.CLEAR);for(const t in e)e[t].onSucceededMessageEvent([],re.CLEAR),e[t].onMessageEvent(re.CLEAR)}}class Be{constructor(e,t={},n=(new Date).getTime()){const s=pe.getInstance();if(!s)return null;{if(this.collectionId=G(),this.sendBird=s.sb,this.channel=e,this.limit=qe,this.filter=Y.getDefaultFilter(),t&&"object"==typeof t&&Object.keys(t).length>0)for(let e in t)this.filter.hasOwnProperty(e)&&(this.filter[e]=t[e]);this.viewpoint=n,this._isLoading={prev:!1,next:!1},ue.getInstance().createQueue(this.channel.url);const r=new je;r.attachCollection(this),_e.set(this,r),xe.set(this,null),Re.set(this,null),Ue.set(this,{}),s.broadcast.addCollection(this,r);const i=new Ie,a=(t,n,a)=>{k.sync("message synchronize() begin",t,n);let o=null,c=0,l=[n];switch(t){case"prev":o="getPreviousMessagesByTimestamp",c=Le,l.push(!0),l.push(Le);break;case"next":o="getNextMessagesByTimestamp",c=Pe,l.push(!0),l.push(Pe);break;case"prevnext":o="getPreviousAndNextMessagesByTimestamp",c=2*Fe,l.push(Fe),l.push(Fe)}l.push(!1),l.push(this.filter.messageType||""),l.push(this.filter.customType||""),l.push(this.filter.senderUserIdsFilter||[]),l.push(this.filter.includeMetaArray||!1),e[o](...l,(e,o)=>{s.sb.getErrorFirstCallback()&&([o,e]=[e,o]),o?(this._pause(),a(o)):(k.sync("message synchronize() end",t,n,e.map(e=>e.messageId)),i.lock(n=>{const i=[],o={startAt:1/0,endAt:0};if(e.length>0){for(let t in e)e[t].isVisible=!0,i.push(new Promise((n,r)=>{s.messageContainer.upsert(e[t],e=>e?r(e):n())})),o.startAt=Math.min(o.startAt,e[t].createdAt),o.endAt=Math.max(o.endAt,e[t].createdAt);r.currentChunk&&r.currentChunk.isOverlap(o)||(r.currentChunk=new Y(this.channel.url,this.filter),k.message("chunk is created",r.currentChunk.startAt,r.currentChunk.endAt));const l=r.currentChunk;l.extendWithChunk(o),k.message("currentChunk is extended",l.startAt,l.endAt),s.chunkContainer.mergePreviousChunkOverlap(l,s=>{s?(n(),a(s)):(k.message("currentChunk merged previous chunks",l.startAt,l.endAt),Promise.all(i).then(()=>{n(),a(null,{count:e.length,nextTs:"prev"===t?l.startAt:l.endAt,hasMore:e.length>=c})}).catch(e=>{n(),a(e)}))})}else n(),a(null,{count:0,nextTs:0,hasMore:!1})}))})},o=new Ee((e,t)=>a("prev",e,t));o.shared++,xe.set(this,o);const c=new Ee((e,t)=>a("next",e,t));c.shared++,Re.set(this,c),s.chunkContainer.getChunkByTimestamp(this.channel.url,this.filter,this.viewpoint,(e,t)=>{e||(t&&(r.currentChunk=t),r.currentChunk?this._resume():a("prevnext",this.viewpoint,(e,t)=>{e||setTimeout(()=>{o.flush(e,t),c.flush(e,t),t.count<Fe?(o.end(),c.end()):this._resume()},Ne)}),k.message(`message collection ${this.collectionId} is created.`))}),Object.defineProperty(this,"messageCount",{get:()=>{try{return r.messages.length}catch(e){return 0}}})}}static get CollectionHandler(){return ne}static get Action(){return re}static get FailedMessageEventActionReason(){return ie}static create(e,t,n,s){"function"==typeof n&&(s=n,n=(new Date).getTime());const r=L.getInstance();return Q(s=>{r.channelContainer.getItem(e,(r,i)=>{if(r)s(r);else if(i)s(null,new Be(i,t,n));else{const r=L.getInstance();r.sb.GroupChannel.getChannel(e,(e,i)=>{r.sb.getErrorFirstCallback()&&([i,e]=[e,i]),i?s(i):s(null,new Be(e,t,n))})}})},s)}get messages(){return this.succeededMessages}get succeededMessages(){return _e.get(this).messages}get unsentMessages(){return _e.get(this).unsentMessages}_pause(){k.call("message sync pause",this.collectionId);const e=_e.get(this),t=xe.get(this),n=Re.get(this);t&&t.pause(),n&&n.pause(),e.currentChunk=null}_resume(){k.call("message sync resume",this.collectionId);const e=pe.getInstance(),t=xe.get(this),n=Re.get(this);t&&t.isRunning&&(t.pause(),t.unsubscribeAll()),n&&n.isRunning&&(n.pause(),n.unsubscribeAll()),e.syncChangeLog(this.channel,()=>{const e=_e.get(this);if(t){const n=e.currentChunk?e.currentChunk.startAt:this.viewpoint;t.start(n)}if(n){const t=e.currentChunk?e.currentChunk.endAt:this.viewpoint;n.start(t,!0)}})}fetch(e,t){return this.fetchSucceededMessages(e,t)}fetchSucceededMessages(e,t){const n=pe.getInstance(),s=_e.get(this);return this._isLoading[e]?Q(e=>e(A.create(A.Type.ERROR_DUPLICATED_FETCH)),t):(this._isLoading[e]=!0,Q(t=>{k.call("fetchSucceededMessages()",e);let r=null,i=this.viewpoint,a=this.limit,o=!1,c=i,l=null,u=null;switch(e){case"prev":r=xe.get(this),s.viewRange.start>0&&(i=s.viewRange.start),s.currentChunk&&(c=Math.max(s.currentChunk.startAt,i)),l=s.prevTempMessages,u=n.messageContainer.loadPreviousSucceededMessages,o=!0;break;case"next":r=Re.get(this),s.viewRange.end>0&&(i=s.viewRange.end),s.currentChunk&&(c=Math.min(s.currentChunk.endAt,i)),l=s.nextTempMessages,u=n.messageContainer.loadNextSucceededMessages;break;default:return void t(A.create(A.Type.ERROR_INVALID_PARAMETER))}const h=(t,i)=>{k.message("waiting for synchronization..."),u(this.channel.url,this.filter,t,{limit:a,desc:o},(t,n)=>{t?(this._isLoading[e]=!1,i(t)):(k.cache("temp message",e,n.map(e=>e.messageId)),l.push(...n),s.addViewItems(n,{direction:e}),this._isLoading[e]=!1,i(null))});const h=c;k.sync("subscribe message",this.collectionId,e,t),r.subscribe(this.collectionId,r=>{r?k.error(r):(k.sync("flush message",e,t),n.chunkContainer.getChunkByTimestamp(this.channel.url,this.filter,t,(t,n)=>{if(!t)if(n&&(s.currentChunk=n),s.currentChunk){const t=s.currentChunk;u(this.channel.url,this.filter,h,{limit:a,desc:o},(n,r)=>{if(n)k.error(n);else{k.cache("flush message",e,h,r.map(e=>e.messageId));const n=[],i=[];for(let e in r)if(t.containsMessage(r[e])){const t=s.messages.map(e=>e.messageId).indexOf(r[e].messageId);(t<0||!s.messages[t].isEqual(r[e]))&&n.push(r[e])}for(let e in l)s.messages.map(e=>e.messageId).indexOf(l[e].messageId)<0&&i.push(l[e]);for(;l.length>0;)l.pop();i.length>0&&s.removeViewItems(i.map(e=>e.messageId)),n.length>0&&s.addViewItems(n,{direction:e})}})}else k.error(t)}))})};n.chunkContainer.getChunkByTimestamp(this.channel.url,this.filter,i,(n,r)=>{if(n)this._isLoading[e]=!1,t(n);else if(r&&(s.currentChunk=r),s.currentChunk){const n=s.currentChunk;k.message("chunk is selected",n),u(this.channel.url,this.filter,i,{limit:a,desc:o},(r,o)=>{if(r)this._isLoading[e]=!1,t(r);else{const r=[],c=[];k.cache("fetch message",e,i,o.map(e=>e.messageId));let u=!1;for(let e in o)if(n.containsMessage(o[e])){u=!0;const t=s.messages.map(e=>e.messageId).indexOf(o[e].messageId);(t<0||!s.messages[t].isEqual(o[e]))&&r.push(o[e])}if(!u){for(let e in l)s.messages.map(e=>e.messageId).indexOf(l[e].messageId)<0&&c.push(l[e]);for(;l.length>0;)l.pop()}r.length>0&&s.addViewItems(r,{direction:e}),c.length>0&&s.removeViewItems(c.map(e=>e.messageId)),o.length<a?(a-=o.length,h(i,t)):(this._isLoading[e]=!1,t(null))}})}else h(i,t)}),r.state===Ee.State.PAUSED&&this._resume()},t))}fetchFailedMessages(e){return Q(e=>{k.call("fetchFailedMessages()"),ue.getInstance().loadFailedMessages(this.channel.url,this.filter,(t,n)=>{if(!t){k.cache("fetch failed message",n.map(e=>e.reqId)),_e.get(this).addViewItems(n)}e(t)})},e)}resetViewpointTimestamp(e=(new Date).getTime()){if("number"==typeof e&&e>=0){k.call("resetViewpointTimestamp()",e);const t=_e.get(this);t.viewRange.start<=e&&e<=t.viewRange.end?t.currentChunk&&!t.currentChunk.contains(e)&&(t.currentChunk=null):(t.currentChunk=null,t.clearViewItem()),this.viewpoint=e,this._resume()}else k.error("resetViewpointTimestamp()","ts should be number type and greater than or equal to 0."),A.throw(A.create(A.Type.ERROR_INVALID_PARAMETER))}remove(){ue.getInstance().removeQueue(this.channel.url),pe.getInstance().broadcast.removeCollection(this),_e.get(this).currentChunk=null;const e=xe.get(this),t=Re.get(this);e&&(e.shared--,0===e.shared&&e.pause()),t&&(t.shared--,0===t.shared&&t.pause())}handleSendMessageResponse(e,t){if(k.call("handleSendMessageResponse()",e,t),e)if(t){switch(Ye.syncManagerOptions.messageResendPolicy){case Ye.Options.MessageResendPolicy.NONE:this.deleteMessage(t);break;case Ye.Options.MessageResendPolicy.MANUAL:case Ye.Options.MessageResendPolicy.AUTOMATIC:if(t.isUserMessage()&&800110!==e.code)this.appendMessage(t);else{const e={reason:ie.REMOVE_UNKNOWN};this.deleteMessage(t,e)}break;default:this.deleteMessage(t)}}else this.deleteMessage(t),k.error(e);else{const e=_e.get(this),n={reason:ie.REMOVE_RESEND_SUCCEEDED};for(let s in e.unsentMessages)if(e.unsentMessages[s].isIdentical(t)){this.deleteMessage(e.unsentMessages[s],n);break}this.appendMessage(t)}}hasMessage(e){if(e){const t=_e.get(this);for(let n=0;n<t.succeededMessages.length;n++)if(t.succeededMessages[n].isIdentical(e))return!0}return!1}appendMessage(e){if(e){k.call("appendMessage()",e.messageId);const t=Ye.getInstance(),n=pe.getInstance(),s=_e.get(this);if(e.messageId)if(e.sender&&e.sender.userId===t.currentUserId){e.isVisible=!0,n.messageContainer.upsert(e,(e,t)=>{e||n.broadcast.upsert([t])});const t=L.getInstance();t.channelContainer.getItem(e.channelUrl,(n,s)=>{n?A.throw(n):s&&(!s.lastMessage||s.lastMessage.createdAt<=e.createdAt)&&(s.lastMessage=e,t.channelContainer.upsert(s,(e,n)=>{e?A.throw(e):t.broadcast.upsert([n])}))})}else k.warning("Cannot append message sent by other member.");else{const t=Ye.syncManagerOptions;"failed"===e.requestState&&t.messageResendPolicy!==Ye.Options.MessageResendPolicy.NONE?ue.getInstance().upsertMessages(this.channel.url,[e]):s.addViewItems([e])}}else k.error("appendMessage()",`Message is expected but ${e} is given.`),A.throw(A.create(A.Type.ERROR_INVALID_PARAMETER))}updateMessage(e){if(e){k.call("updateMessage()",e.messageId);const t=Ye.getInstance(),n=pe.getInstance(),s=_e.get(this);if(e.sender&&e.sender.userId===t.currentUserId)if(e.messageId){e.isVisible=!0,n.messageContainer.upsert(e,(e,t)=>{e||n.broadcast.update([t])});const t=L.getInstance();t.channelContainer.getItem(e.channelUrl,(n,s)=>{n?A.throw(n):s&&s.lastMessage&&s.lastMessage.messageId===e.messageId&&(s.lastMessage=e,t.channelContainer.upsert(s,(e,n)=>{e?A.throw(e):t.broadcast.update([n])}))})}else s.addViewItems([e])}else k.error("updateMessage()",`Message is expected but ${e} is given.`),A.throw(A.create(A.Type.ERROR_INVALID_PARAMETER))}deleteMessage(e,t={}){if(e){k.call("deleteMessage()",e.messageId);const n=Ye.getInstance(),s=_e.get(this);if(e.sender&&e.sender.userId===n.currentUserId)if(e.messageId);else if(e.isUserMessage()){for(let n=0;n<s.unsentMessages.length;n++)if(s.unsentMessages[n].isIdentical(e)){switch(e.requestState){case"pending":s.removeViewItems([e.reqId],!0);break;case"failed":ue.getInstance().removeMessages(this.channel.url,[e],t)}break}}else s.removeViewItems([e.reqId],!0)}else k.error("deleteMessage()",`Message is expected but ${e} is given.`),A.throw(A.create(A.Type.ERROR_INVALID_PARAMETER))}setCollectionHandler(e){const t=Ue.get(this);e instanceof ne&&(t[De]=e)}removeCollectionHandler(){const e=Ue.get(this);e[De]&&delete e[De]}}n.d(t,"default",function(){return Ye});const Ve="[SyncManager]";let Ge=null,Qe=null,He=null,Ke=b,$e=null,ze=null,We=null,Je=null;class Ye{constructor(){return Qe||(Qe=this),Qe}static get sendBird(){return Ge}static set sendBird(e){Ge=e}static get LocalDB(){return Ke}static setup(...e){k.call("init()"),Je=new Ye.Options;const t=e[0];let n=e[1];return n&&"function"!=typeof n&&(n instanceof Ye.Options?(Je=n,n=e[2]):k.error("Type of the second parameter is not valid: ",e[1])),k.prefix=Ve,Q(e=>{if(C.init(),Ge)if(Qe=new Ye,Ge.currentUser&&t!==Ge.currentUser.userId&&(k.warning("Different user ID: clear cache"),Qe.clearCache()),He=t,L.clear(),ze=null,pe.clear(),We=null,$e)k.cache("Database is open"),ze=new L({sendBird:Ge,db:$e}),We=new pe({sendBird:Ge,db:$e}),Ye.ChannelCollection=Te,Ye.MessageCollection=Be,ue.getInstance().removeExpiredMessages(()=>{e(null)});else{const t=new Ke("sbsync.db",4);t.schema("GroupChannel",{key:"url",index:[{ownerUserId:Ke.Query.Order.ASC,lastMessageUpdatedAt:Ke.Query.Order.DESC},{ownerUserId:Ke.Query.Order.ASC,createdAt:Ke.Query.Order.DESC},{ownerUserId:Ke.Query.Order.ASC,name:Ke.Query.Order.ASC}]}).schema("GroupChannelListQuery",{key:"filterKey",index:[{ownerUserId:Ke.Query.Order.ASC,updatedAt:Ke.Query.Order.DESC}]}).schema("MessageChunk",{key:"chunkId",index:[{ownerUserId:Ke.Query.Order.ASC,channelUrl:Ke.Query.Order.ASC,filterKey:Ke.Query.Order.ASC,endAt:Ke.Query.Order.DESC}]}).schema("Message",{key:"messageId",index:[{ownerUserId:Ke.Query.Order.ASC,channelUrl:Ke.Query.Order.ASC,createdAt:Ke.Query.Order.DESC},{ownerUserId:Ke.Query.Order.ASC,createdAt:Ke.Query.Order.ASC}]}).build().then(()=>{k.cache("Database is created"),ze=new L({sendBird:Ge,db:t}),We=new pe({sendBird:Ge,db:t}),$e=t,Ye.ChannelCollection=Te,Ye.MessageCollection=Be,ue.getInstance().removeExpiredMessages(()=>{e(null)})}).catch(t=>e(t))}else e(A.create(A.Type.ERROR_SETUP_MISSING))},n)}static useReactNative(e){C.useReactNative(e),s.a.Storage=e,Ke=s.a}get currentUserId(){return Ge&&Ge.currentUser?Ge.currentUser.userId:He}static get syncManagerOptions(){return Je||new Ye.Options}static get LogLevel(){return w}static set loggerLevel(e){k.level=e}static get loggerLevel(){return k.level}static getInstance(){return Qe}resumeSync(){k.call("resumeSync()"),ze&&ze.start(),We&&We.start()}pauseSync(){k.call("pauseSync()"),ze&&ze.stop(),We&&We.stop()}clearCache(e){return k.call("clearCache()"),Q(e=>{const t=[];ze&&t.push(new Promise((e,t)=>{ze.reset(n=>n?t(n):e())})),We&&t.push(new Promise((e,t)=>{We.reset(n=>n?t(n):e())})),t.length>0?Promise.all(t).then(()=>e(null)).catch(t=>e(t)):e(null)},e)}reset(e){return k.call("reset()"),Q(e=>{this.clearCache(t=>{t||(L.clear(()=>{ze=null}),pe.clear(()=>{We=null})),e(t)})},e)}}Ye.Options=class{constructor(){let e=1e3;Object.defineProperty(this,"messageCollectionCapacity",{get:()=>e,set:t=>{"number"==typeof t&&t>=(Object.values(w).indexOf(k.level)>-1?200:0)&&t<=Number.MAX_SAFE_INTEGER&&(e=t)}});let t=Ye.Options.MessageResendPolicy.NONE;Object.defineProperty(this,"messageResendPolicy",{get:()=>t,set:e=>{Object.values(Ye.Options.MessageResendPolicy).indexOf(e)>-1&&(t=e)}});let n=Ye.Options.INFINITY;Object.defineProperty(this,"automaticMessageResendRetryCount",{get:()=>n,set:e=>{"number"==typeof e&&(e>0&&e<=Number.MAX_SAFE_INTEGER||e===Ye.Options.INFINITY)&&(n=e)}});let s=20;Object.defineProperty(this,"maxFailedMessageCountPerChannel",{get:()=>s,set:e=>{"number"==typeof e&&e>0&&e<=Number.MAX_SAFE_INTEGER&&(s=e)}});let r=7;Object.defineProperty(this,"failedMessageRetentionDays",{get:()=>r,set:e=>{"number"==typeof e&&(e>(Object.values(w).indexOf(k.level)>-1?0:-2)&&e<=Number.MAX_SAFE_INTEGER||e===Ye.Options.INFINITY)&&(r=e)}})}},Ye.Options.MessageResendPolicy={NONE:"none",MANUAL:"manual",AUTOMATIC:"automatic"},Ye.Options.INFINITY=Number.MAX_SAFE_INTEGER}]).default});