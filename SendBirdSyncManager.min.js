!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.SendBirdSyncManager=n():e.SendBirdSyncManager=n()}(window,function(){return function(e){var n={};function t(r){if(n[r])return n[r].exports;var a=n[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,t),a.l=!0,a.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var a in e)t.d(r,a,function(n){return e[n]}.bind(null,a));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=2)}([function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e)}return r(e,null,[{key:"put",value:function(e){}},{key:"call",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["CALL"].concat(t))}},{key:"cache",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["CACHE"].concat(t))}},{key:"sync",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["SYNC"].concat(t))}},{key:"event",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["EVENT"].concat(t))}},{key:"view",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["VIEW"].concat(t))}},{key:"warning",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["WARNING"].concat(t))}},{key:"error",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["ERROR"].concat(t))}},{key:"message",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["MESSAGE"].concat(t))}}]),e}();n.default=a},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r,a=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),i=t(0),s=(r=i)&&r.__esModule?r:{default:r};var u=function(e){function n(e,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,n);var r=function(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return r.name="SyncManagerException",r.code=t||0,r}return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}(n,Error),a(n,null,[{key:"create",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.Type.ERROR_UNKNOWN;return new n(e.message,e.code)}},{key:"throw",value:function(e){if(s.default.error(e),e instanceof n)throw e}},{key:"Type",get:function(){return{ERROR_UNKNOWN:{code:81e4,message:"Unknown error occured."},ERROR_DATABASE_IO:{code:810001,message:"Database I/O operation failed."},ERROR_SETUP_MISSING:{code:810100,message:"SendBirdSyncManager.setup() is not called."},ERROR_SENDBIRD_MISSING:{code:810101,message:"SendBird instance should be set before init()."},ERROR_DUPLICATED_FETCH:{code:810200,message:"Fetch is in progress."},ERROR_DUPLICATED_CHANGELOG_SYNC:{code:810210,message:"Sync is in progress."},ERROR_INVALID_PARAMETER:{code:810300,message:"Invalid parameter."}}}}]),n}();n.default=u},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=f(t(3)),i=f(t(4)),s=f(t(7)),u=t(18),o=t(19),c=f(t(0)),l=f(t(1));function f(e){return e&&e.__esModule?e:{default:e}}var d=null,h=null,v=null,g=null,m=null,p=null,y=function(){function e(){return function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),h||(h=this),h}return r(e,[{key:"resumeSync",value:function(){c.default.call("resumeSync()"),m&&m.start(),p&&p.start()}},{key:"pauseSync",value:function(){c.default.call("pauseSync()"),m&&m.stop(),p&&p.stop()}},{key:"clearCache",value:function(){c.default.call("clearCache()"),m&&m.reset(),p&&p.reset()}},{key:"reset",value:function(){c.default.call("reset()"),this.clearCache(),i.default.clear(),m=null,s.default.clear(),p=null}},{key:"currentUserId",get:function(){return d&&d.currentUser?d.currentUser.userId:v}}],[{key:"setup",value:function(n,t){if(c.default.call("init()"),d)if(h=new e,d.currentUser&&n!==d.currentUser.userId&&(c.default.warning("Different user ID: clear cache"),h.clearCache()),v=n,i.default.clear(),m=null,s.default.clear(),p=null,g)c.default.cache("Database is open"),m=new i.default({sendBird:d,db:g}),p=new s.default({sendBird:d,db:g}),t();else{var r=new a.default("sbsync.db",1);r.schema("GroupChannel",{key:"url",index:[["ownerUserId","lastMessageUpdatedAt"],["ownerUserId","createdAt"],["ownerUserId","name"]]}).schema("MessageChunk",{key:"chunkId",index:[["ownerUserId","channelUrl","filterKey","endAt"]]}).schema("Message",{key:"messageId",index:[["ownerUserId","channelUrl","createdAt"]]}).build().then(function(){c.default.cache("Database is created"),m=new i.default({sendBird:d,db:r}),p=new s.default({sendBird:d,db:r}),g=r,e.ChannelCollection=u.ChannelCollection,e.MessageCollection=o.MessageCollection,t()})}else t(l.default.create(l.default.Type.ERROR_SETUP_MISSING))}},{key:"getInstance",value:function(){return h}},{key:"sendBird",get:function(){return d},set:function(e){d=e}},{key:"LocalDB",get:function(){return a.default}}]),e}();n.default=y},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=s(t(11)),i=s(t(12));function s(e){return e&&e.__esModule?e:{default:e}}var u=new WeakMap,o=new WeakMap,c=new WeakMap,l=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,f=function(){function e(n,t){if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),!l)throw new Error("IndexedDB is not supported in this environment. Check if you're in web browser which supports IndexedDB.");this.name=n,this.version=t,u.set(this,{}),o.set(this,null),c.set(this,{})}return r(e,null,[{key:"Query",get:function(){return i.default}}]),r(e,[{key:"schema",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=u.get(this);return t[e]=n,this}},{key:"build",value:function(){var e=this,n=u.get(this),t=c.get(this);return new Promise(function(r,i){var s=l.open(e.name,e.version);s.onerror=function(e){i(new Error("IndexedDB is not available: "+e.target.errorCode))},s.onupgradeneeded=function(r){var i=r.target.result,s=r.target.transaction,u=s.objectStoreNames;for(var c in n){var l=n[c].key||"id",f=null;try{f=s.objectStore(c)}catch(e){"NotFoundError"===e.name&&(f=i.createObjectStore(c,{keyPath:l}))}if(f){var d=f.indexNames,h=new a.default(i,c,l);if(n[c].index&&n[c].index.length>0)for(var v in n[c].index){var g=null;if("string"==typeof n[c].index[v]?g=n[c].index[v]:Array.isArray(n[c].index[v])&&(g=n[c].index[v].join("_")),g){var m=!1;for(var p in d)if(d[p]===g){m=!0;break}m||f.createIndex(g,n[c].index[v],{unique:!1})}}var y=[];if(n[c].index)for(var b in n[c].index){var C=null;"string"==typeof n[c].index[b]?C=n[c].index[b]:Array.isArray(n[c].index[b])&&(C=n[c].index[b].join("_")),C&&y.push(C)}for(var I=0;I<d.length;I++)y.indexOf(d[I])<0&&f.deleteIndex(d[I]);t[c]=h}}for(var k=0;k<u.length;k++)Object.keys(n).indexOf(u.item(k))<0&&i.deleteObjectStore(u.item(k));o.set(e,i)},s.onsuccess=function(i){var s=i.target.result;for(var u in n)if(!t[u]){var c=n[u].key||"id";t[u]=new a.default(s,u,c)}o.set(e,s),r()}})}},{key:"close",value:function(){var e=o.get(this);e&&(e.close(),o.set(this,null))}},{key:"drop",value:function(){l.deleteDatabase(this.name)}},{key:"collection",value:function(e){var n=c.get(this);return n[e]&&n[e]instanceof a.default?n[e]:null}}]),e}();n.default=f},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=t(13),i=t(14),s=c(t(2)),u=c(t(1)),o=c(t(0));function c(e){return e&&e.__esModule?e:{default:e}}var l="syncManager_channelManager_channelHandler_"+(new Date).getTime(),f=null,d=function(){function e(n){var t=n.sendBird,r=n.db;if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),!f){o.default.call("ChannelManager()"),f=this;var c=this.sb=t,d=s.default.getInstance();this.channelContainer=new a.ChannelContainer(r,c),this.broadcast=new i.ChannelBroadcast;var h=new c.ChannelHandler;Object.keys(h).forEach(function(e){h[e]=function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];switch(e){case"onUserMuted":case"onUserUnmuted":case"onUserUnbanned":case"onChannelChanged":case"onChannelFrozen":case"onChannelUnfrozen":case"onMetaDataCreated":case"onMetaDataUpdated":case"onMetaDataDeleted":case"onMetaCountersCreated":case"onMetaCountersUpdated":case"onMetaCountersDeleted":o.default.event(e,t[0].url),f.channelContainer.upsert(t[0]).then(function(e){return f.broadcast.update(e)}).catch(function(e){return u.default.throw(e)});break;case"onUserReceivedInvitation":case"onUserJoined":o.default.event(e,t[0].url),f.channelContainer.upsert(t[0]).then(function(e){t[1].userId===d.currentUserId?f.broadcast.upsert(e):f.broadcast.update(e)}).catch(function(e){return u.default.throw(e)});break;case"onReadReceiptUpdated":f.channelContainer.upsert(t[0]).then(function(){}).catch(function(e){return u.default.throw(e)});break;case"onMessageReceived":t[0].lastMessage&&t[0].lastMessage.messageId!==t[1].messageId||f.channelContainer.upsert(t[0]).then(function(e){return f.broadcast.upsert(e)}).catch(function(e){return u.default.throw(e)});break;case"onChannelHidden":o.default.event(e,t[0].url);var a=t[0];f.channelContainer.remove(a).then(function(){return f.broadcast.remove(a)}).catch(function(e){return u.default.throw(e)});break;case"onUserLeft":case"onUserBanned":o.default.event(e,t[0].url);var i=t[0];t[1].userId===d.currentUserId?f.channelContainer.remove(i).then(function(){return f.broadcast.remove(i)}).catch(function(e){return u.default.throw(e)}):f.channelContainer.upsert(i).then(function(e){return f.broadcast.update(e)}).catch(function(e){return u.default.throw(e)});break;case"onUserDeclinedInvitation":o.default.event(e,t[0].url);var s=t[0];t[2].userId===d.currentUserId?f.channelContainer.remove(s).then(function(){return f.broadcast.remove(s)}).catch(function(e){return u.default.throw(e)}):f.channelContainer.upsert(s).then(function(e){return f.broadcast.update(e)}).catch(function(e){return u.default.throw(e)});break;case"onChannelDeleted":o.default.event(e,t[0]),f.channelContainer.getItem(t[0]).then(function(e){e&&f.channelContainer.remove(e).then(function(){return f.broadcast.remove(e)}).catch(function(e){return u.default.throw(e)})}).catch(function(e){return u.default.throw(e)})}}}),c.addChannelHandler(l,h)}return f}return r(e,[{key:"clearCache",value:function(){this.channelContainer.clear()}},{key:"start",value:function(){this.broadcast.resume()}},{key:"stop",value:function(){this.broadcast.pause()}},{key:"reset",value:function(){this.broadcast.clear(),this.clearCache()}}],[{key:"getInstance",value:function(){return f}},{key:"clear",value:function(){f&&f.sb&&(o.default.message("ChannelManager is cleared"),f.broadcast.clearCollection(),f.sb.removeChannelHandler(l),f=null)}}]),e}();n.default=d},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.getChannelIndex=function(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]).map(function(e){return e.url}).indexOf(e.url)},n.findChannelIndex=function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=null,a=!1,i=t.length;switch(n.order){case"latest_last_message":r="lastMessageUpdatedAt",a=!0;break;case"chronological":r="createdAt",a=!0;break;case"channel_name_alphabetical":r="name";break;default:r="lastMessageUpdatedAt",a=!0}for(var s=0;s<t.length;s++){var u=t[s];if(e.url===u.url){i=s;break}if(a&&e[r]>u[r]||!a&&e[r]<u[r]){i=s;break}}return i},n.getMessageIndex=function(e){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],t=0;t<n.length;t++)if(e.isIdentical(n[t]))return t;return-1},n.findMessageIndex=function(e){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],t=n.length,r=0;r<n.length;r++)if(n[r].createdAt>=e.createdAt){t=r;break}return t};n.deepEqual=function e(n,t){var a=void 0===n?"undefined":r(n),i=void 0===t?"undefined":r(t);return!n||!t||"object"!==a||a!==i||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===a&&"function"===i||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(r){return e(n[r],t[r])})},n.createUUID=function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?t:3&t|8).toString(16)})}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.deepEqual=function e(n,t){var a=void 0===n?"undefined":r(n),i=void 0===t?"undefined":r(t);return!n||!t||"object"!==a||a!==i||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===a&&"function"===i||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(r){return e(n[r],t[r])})}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=t(15),i=t(8),s=t(16),u=t(17),o=l(t(1)),c=l(t(0));function l(e){return e&&e.__esModule?e:{default:e}}var f="syncManager_messageManager_channelHandler_"+(new Date).getTime(),d=null,h=function(){function e(n){var t=n.sendBird,r=n.db;if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),!d){c.default.call("MessageManager()"),d=this;var s=this.sb=t;this.messageContainer=new a.MessageContainer(r,s),this.chunkContainer=new i.MessageChunkContainer(r),this.broadcast=new u.MessageBroadcast,this.isFetchingChangeLogByChannelUrl={};var l=new s.ChannelHandler;Object.keys(l).forEach(function(e){l[e]=function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];switch(e){case"onMessageReceived":c.default.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!0,d.messageContainer.upsert(t[1]).then(function(e){return d.broadcast.upsert(e)}).catch(function(e){return o.default.throw(e)});break;case"onReadReceiptUpdated":c.default.event(e,t[0].url);var a=t[0];d.broadcast.read(a);break;case"onMessageUpdated":c.default.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!1,d.messageContainer.upsert(t[1]).then(function(e){return d.broadcast.update(e)}).catch(function(e){return o.default.throw(e)});break;case"onMessageDeleted":c.default.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message);var i=parseInt(t[1]);d.messageContainer.remove(i).then(function(){return d.broadcast.remove(i)}).catch(function(e){return o.default.throw(e)})}}}),s.addChannelHandler(f,l)}return d}return r(e,[{key:"syncChangeLog",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};if(this.isFetchingChangeLogByChannelUrl[e.url])t(o.default.create(o.default.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLogByChannelUrl[e.url]=!0,c.default.call("syncChangeLog()",e.url);var r="last-changeLog-token-"+e.url;s.UserPreference.get(r).then(function(a){if(a)c.default.call("getMessageChangeLogsByToken"),e.getMessageChangeLogsByToken(a,function(a,i){if(n.sb.getErrorFirstCallback()){var u=a;a=i,i=u}i?n.isFetchingChangeLogByChannelUrl[e.url]=!1:(c.default.sync("updated",a.updatedMessages.map(function(e){return e.messageId})),c.default.sync("deleted",a.deletedMessageIds),a.updatedMessages.forEach(function(e){d.messageContainer.getItemWithVisibility(e.messageId).then(function(n){var t=n.item;e.isVisible=n.isVisible||!1,d.messageContainer.upsert(e).then(function(e){(!t||!t.isEqual(e))&&d.broadcast.update(e)}).catch(function(e){return o.default.throw(e)})})}),a.deletedMessageIds.forEach(function(e){d.messageContainer.remove(e).then(function(){return d.broadcast.remove(e)}).catch(function(e){return o.default.throw(e)})}),s.UserPreference.set(r,a.token).then(function(){a.hasMore?n.syncChangeLog(e,t):(n.isFetchingChangeLogByChannelUrl[e.url]=!1,t())}).catch(function(r){n.isFetchingChangeLogByChannelUrl[e.url]=!1,t(r)}))});else{c.default.call("getMessageChangeLogsByTimestamp");var i=(new Date).getTime()-15e3;e.getMessageChangeLogsByTimestamp(i,function(a,i){if(n.sb.getErrorFirstCallback()){var u=a;a=i,i=u}i?n.isFetchingChangeLogByChannelUrl[e.url]=!1:(c.default.sync("updated",a.updatedMessages.map(function(e){return e.messageId})),c.default.sync("deleted",a.deletedMessageIds),a.updatedMessages.forEach(function(e){d.messageContainer.getItemWithVisibility(e.messageId).then(function(n){var t=n.item;e.isVisible=n.isVisible||!1,d.messageContainer.upsert(e).then(function(e){(!t||!t.isEqual(e))&&d.broadcast.update(e)}).catch(function(e){return o.default.throw(e)})})}),a.deletedMessageIds.forEach(function(e){d.messageContainer.remove(e).then(function(){return d.broadcast.remove(e)}).catch(function(e){return o.default.throw(e)})}),s.UserPreference.set(r,a.token).then(function(){a.hasMore?n.syncChangeLog(e,t):(n.isFetchingChangeLogByChannelUrl[e.url]=!1,t())}).catch(function(r){n.isFetchingChangeLogByChannelUrl[e.url]=!1,t(r)}))})}}).catch(function(r){n.isFetchingChangeLogByChannelUrl[e.url]=!1,t(r)})}}},{key:"start",value:function(){d.broadcast.resume()}},{key:"stop",value:function(){d.broadcast.pause()}},{key:"clearCache",value:function(){d.messageContainer.clear(),d.chunkContainer.clear(),s.UserPreference.keys.forEach(function(e){e.startsWith("last-changeLog-token-")&&s.UserPreference.remove(e).then(function(){}).catch(function(){})})}},{key:"reset",value:function(){d.broadcast.clear(),this.clearCache()}}],[{key:"getInstance",value:function(){return d}},{key:"clear",value:function(){d&&d.sb&&(c.default.message("MessageManager is cleared"),d.broadcast.clearCollection(),d.sb.removeChannelHandler(f),d=null)}}]),e}();n.default=h},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.MessageChunkContainer=n.MessageChunk=void 0;var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=o(t(3)),i=o(t(2)),s=o(t(1)),u=t(5);function o(e){return e&&e.__esModule?e:{default:e}}var c={},l=function(e){var n=[];for(var t in e)n.push(t+"="+e[t]);return n.join("&")},f=n.MessageChunk=function(){function e(n,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.chunkId=(0,u.createUUID)(),this.channelUrl=n,this.filterKey=l(t),this.filter=t,this.startAt=(new Date).getTime(),this.endAt=0}return r(e,[{key:"hasDefaultFilter",value:function(){var n=e.getDefaultFilter();return(0,u.deepEqual)(this.filter,n)}},{key:"isOverlap",value:function(e){return e.startAt<=this.startAt&&this.startAt<=e.endAt||e.startAt<=this.endAt&&this.endAt<=e.endAt}},{key:"isSame",value:function(e){return e.startAt===this.startAt&&this.endAt===e.endAt}},{key:"contains",value:function(e){return this.startAt<=e&&e<=this.endAt}},{key:"containsMessage",value:function(e){return this.contains(e.createdAt)}},{key:"serialize",value:function(){var e=JSON.parse(JSON.stringify(this));return Object.freeze(e)}},{key:"extendForward",value:function(e){this.endAt=Math.max(this.endAt,e)}},{key:"extendBackward",value:function(e){this.startAt=Math.min(this.startAt,e)}},{key:"extendWithChunk",value:function(e){return this.extendForwardWithChunk(e),this.extendBackwardWithChunk(e),this}},{key:"extendForwardWithChunk",value:function(e){return this.extendForward(e.endAt),this}},{key:"extendBackwardWithChunk",value:function(e){return this.extendBackward(e.startAt),this}},{key:"extendWithMessage",value:function(e){return this.extendForwardWithMessage(e),this.extendBackwardWithMessage(e),this}},{key:"extendForwardWithMessage",value:function(e){return this.extendForward(e.createdAt),this}},{key:"extendBackwardWithMessage",value:function(e){return this.extendBackward(e.createdAt),this}}],[{key:"createFromJson",value:function(n){var t=new e(n.channelUrl,n.filter);return t.chunkId=n.chunkId,t.startAt=n.startAt,t.endAt=n.endAt,t}},{key:"getDefaultFilter",value:function(){return{messageTypeFilter:null,customTypeFilter:null,senderUserIdsFilter:[],includeMetaArray:!1}}}]),e}();n.MessageChunkContainer=function(e){var n=this,t=e.collection("MessageChunk");return this.reload=function(e){return t.findById(e.chunkId)},this.upsert=function(e){return new Promise(function(n,r){(function(e){return new Promise(function(n,r){var a=i.default.getInstance();a.currentUserId?(e.ownerUserId=a.currentUserId,c[e.chunkId]=e,t.upsert(c[e.chunkId].serialize()).then(n).catch(r)):r(s.default.create(s.default.Type.ERROR_SETUP_MISSING))})})(e).then(function(e){return n(f.createFromJson(e))}).catch(r)})},this.remove=function(e){return new Promise(function(n,r){(function(e){return new Promise(function(n,r){i.default.getInstance().currentUserId?(c[e]&&delete c[e],t.remove(e).then(n).catch(r)):r(s.default.create(s.default.Type.ERROR_SETUP_MISSING))})})(e).then(function(){return n(e)}).catch(r)})},this.clear=function(){return c={},t.clear()},this.getChunkByTimestamp=function(e,r,u){return new Promise(function(o,c){var d=i.default.getInstance();if(d.currentUserId){var h=new a.default.Query({ownerUserId:d.currentUserId,channelUrl:e,filterKey:l(r),startAt:{"<=":u},endAt:{">=":u}});h.limit=1,h.orderBy=["ownerUserId","channelUrl","filterKey","endAt"],h.desc=!0,t.find(h).then(function(r){var i=r.length>0?f.createFromJson(r[0]):null;if(i)if(i.hasDefaultFilter())o(i);else{var s=new a.default.Query({channelUrl:e,filterKey:l(f.getDefaultFilter()),startAt:{"<=":u}});s.limit=1,s.orderBy=["ownerUserId","channelUrl","filterKey","endAt"],s.desc=!0,t.find(s).then(function(e){var t=e.length>0?f.createFromJson(e[0]):null;if(t)if(t.endAt>i.endAt)if(t.isOverlap(i))i.extendWithChunk(t),n.upsert(i).then(o).catch(c);else{var r=new f(i.channelUrl,i.filter);r.startAt=t.startAt,r.endAt=t.endAt,n.upsert(r).then(o).catch(c)}else o(i);else o(i)}).catch(c)}else o(null)}).catch(c)}else c(s.default.create(s.default.Type.ERROR_SETUP_MISSING))})},this.mergePreviousChunkOverlap=function(e){return new Promise(function(r,u){var o=i.default.getInstance();if(o.currentUserId){var c=new a.default.Query({ownerUserId:o.currentUserId,chunkId:{"!=":e.chunkId},channelUrl:e.channelUrl,filterKey:e.filterKey,endAt:{">=":e.startAt}});c.limit=1/0,t.find(c).then(function(i){if(i.length>0){var s=new a.default.Query({chunkId:{"/in":i.map(function(e){return e.chunkId})}});t.removeIf(s).then(function(){for(var t in i)e.extendWithChunk(i[t]);n.upsert(e).then(r).catch(u)}).catch(u)}else n.upsert(e).then(r).catch(u)}).catch(u)}else u(s.default.create(s.default.Type.ERROR_SETUP_MISSING))})},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=6e4,i=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.locked=!1,this.lockedAt=(new Date).getTime()+a}return r(e,[{key:"isLocked",value:function(){return this.locked}},{key:"lock",value:function(e){var n=this;this.locked?setTimeout(function(){(new Date).getTime()-n.lockedAt<a&&n.lock(e)},200):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(function(){return n.unlock()}))}},{key:"unlock",value:function(){this.locked=!1,this.lockedAt=(new Date).getTime()+a}}]),e}();n.default=i},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.ChannelCollectionHandler=function(){this.onChannelEvent=function(e,n){}},n.MessageCollectionHandler=function(){this.onMessageEvent=function(e,n){}},n.ChannelEventAction={INSERT:"insert",UPDATE:"update",MOVE:"move",REMOVE:"remove",CLEAR:"clear"},n.MessageEventAction={INSERT:"insert",UPDATE:"update",REMOVE:"remove",CLEAR:"clear"}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r,a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),s=t(3),u=(r=s)&&r.__esModule?r:{default:r},o=t(6);var c=new WeakMap,l=function(){function e(n,t,r){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=t,this.keyPath=r,c.set(this,n)}return i(e,[{key:"findById",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){var i=t.transaction(n.name,"readonly").objectStore(n.name).get(e);i.onsuccess=function(){r(i.result||null)},i.onerror=function(){a(i.error)}})}},{key:"find",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){if(e instanceof u.default.Query){var i=null;"string"==typeof e.orderBy?i=e.orderBy:Array.isArray(e.orderBy)&&(i=e.orderBy.join("_"));var s=[],o=t.transaction(n.name,"readonly").objectStore(n.name),c=i?o.index(i).openCursor(null,e.desc?"prev":"next"):o.openCursor(),l=e.offset;c.onsuccess=function(n){var t=n.target.result;if(t)if(!l||l<0){var a=t.value;e.match(a)?(s.push(a),s.length<e.limit?t.continue():r(s)):t.continue()}else l--,t.continue();else r(s)},c.onerror=function(){a(c.error)}}else a(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"count",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){if(!e||e instanceof u.default.Query){var i=t.transaction(n.name,"readonly").objectStore(n.name);if(e){var s=0,o=i.openCursor();o.onsuccess=function(){var n=event.target.result;n?(e.match(n.value)&&s++,n.continue()):r(s)},o.onerror=function(){a(o.error)}}else{var c=i.count();c.onsuccess=function(){r(c.result)},c.onerror=function(){a(c.error)}}}else a(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"insert",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,i){var s=t.transaction(n.name,"readwrite").objectStore(n.name);if(Array.isArray(e))!function(){var n=[],t=function(t){var a=e[t],u=s.add(a);u.onsuccess=function(){n.push(a),n.length===e.length&&r(n)},u.onerror=function(){i(u.error)}};for(var a in e)t(a)}();else if(e&&"object"===(void 0===e?"undefined":a(e))){var u=s.add(e);u.onsuccess=function(){r(e)},u.onerror=function(){i(u.error)}}else i(new Error("Invalid type: 'item' should be an object or an object array."))})}},{key:"upsert",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,i){var s=t.transaction(n.name,"readwrite").objectStore(n.name);if(e&&"object"===(void 0===e?"undefined":a(e))){var u=s.get(e[n.keyPath]);u.onsuccess=function(){if(u.result){var n=s.put(e);n.onsuccess=function(){return r(e)},n.onerror=function(){return i(n.error)}}else{var t=s.add(e);t.onsuccess=function(){return r(e)},t.onerror=function(){return i(t.error)}}},u.onerror=function(){i(u.error)}}else i(new Error("Invalid type: 'item' should be an object or an object array."))})}},{key:"update",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){var i=t.transaction(n.name,"readwrite").objectStore(n.name).put(e);i.onsuccess=function(){r(e)},i.onerror=function(){a(i.error)}})}},{key:"updateIf",value:function(e,n){var t=this,r=c.get(this);return new Promise(function(a,i){if(e instanceof u.default.Query){var s=[],c=r.transaction(t.name,"readwrite").objectStore(t.name),l=c.openCursor();l.onsuccess=function(t){var r=t.target.result;if(r){var u=r.value;if(e.match(u)){var l=!1;for(var f in n){var d=n[f];(0,o.deepEqual)(u[f],d)||(l=!0,u[f]=d)}if(l){var h=c.put(u);h.onsuccess=function(){s.push(u),r.continue()},h.onerror=function(){i(h.error)}}else r.continue()}else r.continue()}else a(s)},l.onerror=function(){i(l.error)}}else i(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"remove",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){var i=t.transaction(n.name,"readwrite").objectStore(n.name).delete(e);i.onsuccess=function(){r()},i.onerror=function(){a(i.error)}})}},{key:"removeIf",value:function(e){var n=this,t=c.get(this);return new Promise(function(r,a){if(e instanceof u.default.Query){var i=[],s=t.transaction(n.name,"readwrite").objectStore(n.name),o=s.openCursor();o.onsuccess=function(t){var u=t.target.result;if(u){var o=u.value;if(e.match(o)){var c=s.delete(o[n.keyPath]);c.onsuccess=function(){i.push(o),u.continue()},c.onerror=function(){a(c.error)}}else u.continue()}else r(i)},o.onerror=function(){a(o.error)}}else a(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"clear",value:function(){var e=this,n=c.get(this);return new Promise(function(t,r){var a=n.transaction(e.name,"readwrite").objectStore(e.name).clear();a.onsuccess=function(){t()},a.onerror=function(){r(a.error)}})}}]),e}();n.default=l},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=t(6);var s=1/0,u=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.condition=n,this.offset=0,this.limit=s,this.orderBy=null,this.desc=!1}return r(e,null,[{key:"and",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];return t.length>0?new e({"/and":t}):new e({})}},{key:"or",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];return t.length>0?new e({"/or":t}):new e({})}}]),r(e,[{key:"match",value:function(e){return function e(n,t){var r=!0;for(var s in t){switch(s){case"/and":r=r&&t[s].reduce(function(t,r){return t&&e(n,r)},!0);break;case"/or":r=r&&t[s].reduce(function(t,r){return t||e(n,r)},!1);break;default:var u=t[s];if("object"===(void 0===u?"undefined":a(u)))for(var o in u)switch(o){case">":r=r&&n[s]>u[o];break;case">=":r=r&&n[s]>=u[o];break;case"<":r=r&&n[s]<u[o];break;case"<=":r=r&&n[s]<=u[o];break;case"=":r=r&&n[s]===u[o];break;case"!=":r=r&&n[s]!==u[o];break;case"/in":r=r&&Array.isArray(u[o])&&u[o].indexOf(n[s])>=0;break;case"/nin":r=r&&Array.isArray(u[o])&&u[o].indexOf(n[s])<0;break;case"/like":r=r&&"string"==typeof u[o]&&"string"==typeof n[s]&&n[s].indexOf(u[o])>=0;break;case"/regex":r=r&&u[o]instanceof RegExp&&u[o].test(n[s]);break;case"/where":r=r&&u[o](n[s]);break;default:r=r&&(0,i.deepEqual)(n[s],u)}else r=r&&n[s]===u}if(!r)break}return r}(e,this.condition)}}]),e}();n.default=u},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelContainer=void 0;var r=u(t(3)),a=u(t(2)),i=u(t(1)),s=u(t(0));function u(e){return e&&e.__esModule?e:{default:e}}var o={};n.ChannelContainer=function(e,n){var t=e.collection("GroupChannel"),u=function(e){if(e){var t=n.GroupChannel.buildFromSerializedData(e);return t.lastMessageUpdatedAt=t.lastMessage?t.lastMessage.createdAt:t.createdAt,t}return null};return this.query=function(e,n){return new Promise(function(s,c){var l=a.default.getInstance();if(l.currentUserId){e.ownerUserId=l.currentUserId;var f=new r.default.Query(e);n&&(f.offset=n.offset||0,f.limit=n.limit||20,f.orderBy=["ownerUserId",n.orderBy||"lastMessageUpdatedAt"],f.desc=!n.hasOwnProperty("desc")||n.desc),t.find(f).then(function(e){var n=[];for(var t in e){var r=u(e[t]);n.push(r),o[r.url]=r}s(n)}).catch(c)}else c(i.default.create(i.default.Type.ERROR_SETUP_MISSING))})},this.upsert=function(e){return new Promise(function(n,r){(function(e){return new Promise(function(n,r){var u=a.default.getInstance();if(u.currentUserId){var c=e.lastMessage?e.lastMessage.createdAt:e.createdAt;s.default.cache("upsert channel",e.url,e.lastMessageUpdatedAt),o[e.url]?o[e.url].lastMessageUpdatedAt<=c?(e.ownerUserId=u.currentUserId,e.lastMessageUpdatedAt=c,o[e.url]=e,t.upsert(o[e.url].serialize()).then(n).catch(r)):n(o[e.url]):(e.ownerUserId=u.currentUserId,e.lastMessageUpdatedAt=c,o[e.url]=e,t.upsert(o[e.url].serialize()).then(n).catch(r))}else r(i.default.create(i.default.Type.ERROR_SETUP_MISSING))})})(e).then(function(e){return n(u(e))}).catch(r)})},this.remove=function(n){return new Promise(function(c,l){(function(n){return new Promise(function(u,c){var l=a.default.getInstance();l.currentUserId?(o[n.url]&&delete o[n.url],s.default.cache("remove channel",n.url),t.remove(n.url).then(function(t){var a=new r.default.Query({ownerUserId:l.currentUserId,channelUrl:n.url});e.collection("MessageChunk").removeIf(a).then(function(){e.collection("Message").removeIf(a).then(function(){u(t)}).catch(c)}).catch(c)}).catch(c)):c(i.default.create(i.default.Type.ERROR_SETUP_MISSING))})})(n).then(function(e){return c(u(e))}).catch(l)})},this.getItem=function(e){return new Promise(function(n,r){t.findById(e).then(function(e){return n(u(e))}).catch(r)})},this.clear=function(){return new Promise(function(n,r){s.default.cache("clear channel"),o={},t.clear().then(function(){e.collection("MessageChunk").clear().then(function(){e.collection("Message").clear().then(n).catch(r)}).catch(r)}).catch(r)})},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelBroadcast=void 0;var r,a=t(4),i=(r=a)&&r.__esModule?r:{default:r};function s(e,n){var t=i.default.getInstance().sb,r=!0;if(e.isGroupChannel()&&!e.isSuper){if(!n.includeEmpty&&!e.lastMessage)return!1;if(n.nicknameContainsFilter){var a=!1;for(var s in e.members)if(e.members[s].nickname.indexOf(n.nicknameContainsFilter)>=0){a=!0;break}if(!a)return!1}if(n.userIdsFilter.length>0){var u=!1,o=e.members.map(function(e){return e.userId}),c=n.userIdsFilterExactMatch,l=n.queryType;if(c?u=o.length===n.userIdsFilter.length&&n.userIdsFilter.every(function(e){return o.indexOf(e)>=0}):"AND"===l?u=n.userIdsFilter.every(function(e){return o.indexOf(e)>=0}):"OR"===l&&(u=n.userIdsFilter.reduce(function(e,n){return e||o.indexOf(n)>=0},!1)),!u)return!1}}if(n.channelNameContainsFilter&&(r=r&&e.name.indexOf(n.channelNameContainsFilter)>=0),n.channelUrlsFilter.length>0&&(r=r&&n.channelUrlsFilter.indexOf(e.url)>=0),n.memberStateFilter!==t.GroupChannel.memberStateFilter.ALL)switch(n.memberStateFilter){case t.GroupChannel.memberStateFilter.JOINED:r=r&&e.myMemberState===t.GroupChannel.memberStateFilter.JOINED;break;case t.GroupChannel.memberStateFilter.INVITED:case t.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case t.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:r=r&&e.myMemberState===t.GroupChannel.memberStateFilter.INVITED}if(n.customTypesFilter.length>0&&(r=r&&n.customTypesFilter.indexOf(e.customType)>=0),n.customTypeStartsWithFilter&&(r=r&&e.customType.startsWith(n.customTypeStartsWithFilter)),n.superChannelFilter!==t.GroupChannel.superChannelFilter.ALL)switch(n.superChannelFilter){case t.GroupChannel.superChannelFilter.SUPER:r=r&&e.isSuper;break;case t.GroupChannel.superChannelFilter.NONSUPER:r=r&&!e.isSuper}if(n.publicChannelFilter!==t.GroupChannel.publicChannelFilter.ALL)switch(n.publicChannelFilter){case t.GroupChannel.publicChannelFilter.PUBLIC:r=r&&e.isPublic;break;case t.GroupChannel.publicChannelFilter.PRIVATE:r=r&&!e.isPublic}if(n.unreadChannelFilter!=t.GroupChannel.UnreadChannelFilter.ALL)switch(n.unreadChannelFilter){case t.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:r=r&&e.unreadMessageCount>0}if("all"!=n.hiddenChannelFilter)switch(n.hiddenChannelFilter){case t.GroupChannel.HiddenChannelFilter.UNHIDDEN:r=r&&e.hiddenState===t.GroupChannel.HiddenState.UNHIDDEN;break;case t.GroupChannel.HiddenChannelFilter.HIDDEN:r=r&&(e.hiddenState===t.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE||e.hiddenState===t.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE);break;case t.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:r=r&&e.hiddenState===t.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE;break;case t.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:r=r&&e.hiddenState===t.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE}return r}n.ChannelBroadcast=function(){var e=[];return this.addCollection=function(n,t){e.indexOf(n)<0&&e.push({controller:n,view:t})},this.removeCollection=function(n){var t=e.map(function(e){return e.controller}).indexOf(n);t>=0&&(e[t].controller._pause(),e.splice(t,1))},this.clearCollection=function(){for(var n in e)e[n].controller._pause();e=[]},this.pause=function(){for(var n in e)e[n].controller._pause()},this.resume=function(){for(var n in e)e[n].controller._resume()},this.upsert=function(n,t){for(var r in e){var a=e[r];a.controller!==t&&s(n,a.controller.query)&&a.view.addViewItem(n)}},this.update=function(n,t){for(var r in e){var a=e[r];a.controller!==t&&s(n,a.controller.query)&&a.view.channels.map(function(e){return e.url}).indexOf(n.url)>=0&&a.view.addViewItem(n)}},this.remove=function(n,t){for(var r in e){var a=e[r];a.controller!==t&&a.view.removeViewItem(n)}},this.clear=function(){for(var n in e){e[n].view.clearViewItem()}},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.MessageContainer=void 0;var r=u(t(3)),a=u(t(2)),i=u(t(1)),s=u(t(0));function u(e){return e&&e.__esModule?e:{default:e}}var o={};n.MessageContainer=function(e,n){var t=this,u=e.collection("Message"),c=function(e){return new Promise(function(n,t){var r=a.default.getInstance();e.messageId?r.currentUserId?(e.hasOwnProperty("isVisible")||(e.isVisible=!0),e.hasOwnProperty("isDeleted")||(e.isDeleted=!1),e.ownerUserId=r.currentUserId,s.default.cache("upsert message",e.messageId,e.createdAt,"owner="+e.ownerUserId,"visible="+e.isVisible,"deleted="+e.isDeleted),u.findById(e.messageId).then(function(r){r?r.isDeleted?n(r):(e.isVisible=e.isVisible||r.isVisible,e.isDeleted?o[e.messageId]&&delete o[e.messageId]:o[e.messageId]=e,u.upsert(e.serialize()).then(n).catch(t)):u.upsert(e.serialize()).then(n).catch(t)}).catch(function(e){return t(e)})):t(i.default.create(i.default.Type.ERROR_SETUP_MISSING)):n(e)})},l=function(e){var t=null;return e&&("user"===e.messageType?t=n.UserMessage.buildFromSerializedData(e):"file"===e.messageType?t=n.FileMessage.buildFromSerializedData(e):"admin"===e.messageType&&(t=n.AdminMessage.buildFromSerializedData(e))),t};return this.query=function(e,n){return e.isVisible=!0,e.isDeleted=!1,new Promise(function(t,s){var c=a.default.getInstance();if(c.currentUserId){e.ownerUserId=c.currentUserId;var f=new r.default.Query(e);n&&(f.offset=n.offset||0,f.limit=n.limit||1/0,f.orderBy=["ownerUserId","channelUrl",n.orderBy||"createdAt"],f.desc=!n.hasOwnProperty("desc")||n.desc),u.find(f).then(function(e){var n=[];for(var r in e){var a=l(e[r]);n.push(a),o[a.messageId]=a}t(n)}).catch(s)}else s(i.default.create(i.default.Type.ERROR_SETUP_MISSING))})},this.upsert=function(e){return new Promise(function(n,t){c(e).then(function(e){return n(l(e))}).catch(t)})},this.remove=function(e){var n={messageId:e,isVisible:!1,isDeleted:!0,serialize:function(){return{messageId:e,isVisible:!1,isDeleted:!0}}};return new Promise(function(t,r){c(n).then(function(){return t(e)}).catch(r)})},this.getItemWithVisibility=function(e){return new Promise(function(n,t){u.findById(e).then(function(e){return n({item:l(e),isVisible:!!e&&e.isVisible})}).catch(t)})},this.getItem=function(e){return new Promise(function(n,t){u.findById(e).then(function(e){return n(l(e))}).catch(t)})},this.clear=function(){return o={},s.default.cache("clear messages"),u.clear()},this.loadChunkMessages=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={channelUrl:e.channelUrl,createdAt:{">=":e.startAt,"<=":e.endAt}};return e.filter.messageType&&(r.messageType=e.filter.messageType),e.filter.customType&&(r.customType=e.filter.customType),e.filter.senderUserIds&&e.filter.senderUserIds.length>0&&(r["sender.userId"]={"/in":e.filter.senderUserIds}),t.query(r,n)},this.loadRangeMessages=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2],a=arguments[3],i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(r>a){var s=r;r=a,a=s}var u={channelUrl:e,createdAt:{">=":r,"<=":a}};return n.messageType&&(u.messageType=n.messageType),n.customType&&(u.customType=n.customType),n.senderUserIds&&n.senderUserIds.length>0&&(u["sender.userId"]={"/in":n.senderUserIds}),t.query(u,i)},this.loadPreviousMessages=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(new Date).getTime(),a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i={channelUrl:e,createdAt:{"<=":r}};return n.messageType&&(i.messageType=n.messageType),n.customType&&(i.customType=n.customType),n.senderUserIds&&n.senderUserIds.length>0&&(i["sender.userId"]={"/in":n.senderUserIds}),a.desc=!0,t.query(i,a)},this.loadNextMessages=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i={channelUrl:e,createdAt:{">=":r}};return n.messageType&&(i.messageType=n.messageType),n.customType&&(i.customType=n.customType),n.senderUserIds&&n.senderUserIds.length>0&&(i["sender.userId"]={"/in":n.senderUserIds}),a.desc=!1,t.query(i,a)},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=window.localStorage;n.UserPreference=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e)}return r(e,null,[{key:"get",value:function(e){return new Promise(function(n){var t=a.getItem(e);n(void 0!==t?t:null)})}},{key:"set",value:function(e,n){return new Promise(function(t){a.setItem(e,n),t()})}},{key:"remove",value:function(e){return new Promise(function(n){a.removeItem(e),n()})}},{key:"clear",value:function(){return new Promise(function(e){a.clear(),e()})}},{key:"keys",get:function(){var e=[];for(var n in a)e.push(n);return e}}]),e}()},function(e,n,t){"use strict";function r(e,n,t){return t?n.channelUrl===e.url&&((!t.messageType||t.messageType===n.messageType)&&((!t.customType||t.customType===n.customType)&&!(Array.isArray(t.senderUserIds)&&t.senderUserIds.length>0&&n.sender&&t.senderUserIds.indexOf(n.sender.userId)<0))):n.channelUrl===e.url}Object.defineProperty(n,"__esModule",{value:!0});n.MessageBroadcast=function(){var e=[];return this.addCollection=function(n,t){e.push({controller:n,view:t})},this.removeCollection=function(n){var t=e.map(function(e){return e.controller}).indexOf(n);t>=0&&(e[t].controller._pause(),e.splice(t,1))},this.clearCollection=function(){for(var n in e)e[n].controller._pause();e=[]},this.pause=function(){for(var n in e)e[n].controller._pause()},this.resume=function(){for(var n in e)e[n].controller._resume()},this.upsert=function(n,t){for(var a in e){var i=e[a];i.controller!==t&&r(i.controller.channel,n,i.controller.filter)&&i.view.addViewItem(n,{isEventMessage:!0})}},this.update=function(n,t){for(var a in e){var i=e[a];i.controller!==t&&r(i.controller.channel,n,i.controller.filter)&&i.view.messages.map(function(e){return e.messageId}).indexOf(n.messageId)>=0&&i.view.addViewItem(n)}},this.read=function(n,t){for(var r in e){var a=e[r];if(a.controller!==t&&a.controller.channel.url===n.url)for(var i in a.controller.channel=n,a.view.messages)a.view.addViewItem(a.view.messages[i])}},this.remove=function(n,t){for(var r in e){var a=e[r];a.controller!==t&&a.view.removeViewItem(n)}},this.clear=function(){for(var n in e){e[n].view.clearViewItem()}},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelCollection=n.ChannelCollectionViewAdapter=void 0;var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=c(t(9)),i=c(t(4)),s=t(10),u=t(5),o=c(t(0));function c(e){return e&&e.__esModule?e:{default:e}}function l(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var f=new WeakMap,d=new WeakMap,h=new WeakMap,v=new WeakMap,g=n.ChannelCollectionViewAdapter=function(){function e(){l(this,e),this.collection=null,this.channels=[],this.mutex=new a.default}return r(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"addViewItem",value:function(e){var n=this,t=v.get(this.collection);this.mutex.lock(function(r){var a=(0,u.getChannelIndex)(e,n.channels),i=(0,u.findChannelIndex)(e,n.collection.query,n.channels),c=a<0?s.ChannelEventAction.INSERT:s.ChannelEventAction.UPDATE;for(var l in a<0?i<n.channels.length?n.channels.splice(i,0,e):n.channels.push(e):a!==i?(c=s.ChannelEventAction.MOVE,n.channels.splice(a,1),i>a?n.channels.splice(i-1,0,e):n.channels.splice(i,0,e)):n.channels[a]=e,o.default.view("channel",c,e.url,e.lastMessageUpdatedAt),t)t[l].onChannelEvent(c,e);r()})}},{key:"removeViewItem",value:function(e){var n=this,t=v.get(this.collection);this.mutex.lock(function(r){for(var a in n.channels)if(e.url===n.channels[a].url){n.channels.splice(a,1);var i=s.ChannelEventAction.REMOVE;for(var u in o.default.view("channel",i,e.url,e.lastMessageUpdatedAt),t)t[u].onChannelEvent(i,e);break}r()})}},{key:"clearViewItem",value:function(){this.channels=[];var e=v.get(this.collection),n=s.ChannelEventAction.CLEAR;for(var t in o.default.view("channel",n),e)e[t].onChannelEvent(n)}}]),e}();n.ChannelCollection=function(){function e(n){l(this,e);var t=new g,r=i.default.getInstance();if(!r)return null;this.sendBird=r.sb,this.type="MyGroupChannelListQuery",this.query=n,this.isSynced=!1,this.isLoading=!1,t.attachCollection(this),r.broadcast.addCollection(this,t),d.set(this,t),f.set(this,r.broadcast),h.set(this,r.channelContainer),v.set(this,{})}return r(e,[{key:"_pause",value:function(){this.isSynced=!1,this.isLoading=!1}},{key:"_resume",value:function(){var e=this.query;switch(this.type){case"MyGroupChannelListQuery":this.query=new this.sendBird.GroupChannel.createMyGroupChannelListQuery;break;case"PublicGroupChannelListQuery":this.query=new this.sendBird.GroupChannel.createPublicGroupChannelListQuery}for(var n in e)"function"!=typeof e[n]&&(this.query[n]=e[n]);this.fetch()}},{key:"_fetchFromCache",value:function(e){var n=this;if(this.isSynced&&0!==this.channels.length)e(null,[]);else{var t=h.get(this),r=this.sendBird,a={};if(this.query.nicknameContainsFilter&&(a.members={"/where":function(e){for(var t in e)if(e[t].nickname.indexOf(n.query.nicknameContainsFilter)>=0)return!0;return!1}}),this.query.userIdsFilter.length>0&&(a.members={"/where":function(e){var t=e.map(function(e){return e.userId});return n.query.userIdsFilterExactMatch?t.length===n.query.userIdsFilter.length&&n.query.userIdsFilter.every(function(e){return t.indexOf(e)>=0}):"AND"===n.query.queryType?n.query.userIdsFilter.every(function(e){return t.indexOf(e)>=0}):"OR"===n.query.queryType&&n.query.userIdsFilter.reduce(function(e,n){return e||t.indexOf(n)>=0},!1)}}),this.query.channelNameContainsFilter&&(a.name={"/regex":new RegExp(this.query.channelNameContainsFilter)}),this.query.channelUrlsFilter.length>0&&(a.url={"/in":this.query.channelUrlsFilter}),this.query.memberStateFilter!==r.GroupChannel.memberStateFilter.ALL)switch(this.query.memberStateFilter){case r.GroupChannel.memberStateFilter.JOINED:a.myMemberState=r.GroupChannel.memberStateFilter.JOINED;break;case r.GroupChannel.memberStateFilter.INVITED:case r.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case r.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:a.myMemberState={"/in":[r.GroupChannel.memberStateFilter.INVITED,r.GroupChannel.memberStateFilter.INVITED_BY_FRIEND,r.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND]}}if("string"==typeof this.query.customTypeFilter&&this.query.customTypeFilter&&(a.customType=this.query.customTypeFilter),Array.isArray(this.query.customTypesFilter)&&this.query.customTypesFilter.length>0&&(a.customType={"/in":this.query.customTypesFilter}),"string"==typeof this.query.customTypeStartsWithFilter&&this.query.customTypeStartsWithFilter&&(a.customType={"/regex":new RegExp("^"+this.query.customTypeStartsWithFilter)}),this.query.superChannelFilter!==r.GroupChannel.superChannelFilter.ALL)switch(this.query.superChannelFilter){case r.GroupChannel.superChannelFilter.SUPER:a.isSuper=!0;break;case r.GroupChannel.superChannelFilter.NONSUPER:a.isSuper=!1}if(this.query.publicChannelFilter!==r.GroupChannel.publicChannelFilter.ALL)switch(this.query.publicChannelFilter){case r.GroupChannel.publicChannelFilter.PUBLIC:a.isPublic=!0;break;case r.GroupChannel.publicChannelFilter.PRIVATE:a.isPublic=!1}if(this.query.unreadChannelFilter!==r.GroupChannel.UnreadChannelFilter.ALL)switch(this.query.unreadChannelFilter){case r.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:a.unreadMessageCount={">":0}}if("all"!=this.query.hiddenChannelFilter)switch(this.query.hiddenChannelFilter){case r.GroupChannel.HiddenChannelFilter.UNHIDDEN:a.hiddenState=r.GroupChannel.HiddenState.UNHIDDEN;break;case r.GroupChannel.HiddenChannelFilter.HIDDEN:a.hiddenState={"/in":[r.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE,r.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE]};break;case r.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:a.hiddenState=r.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE;break;case r.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:a.hiddenState=r.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE}var i=null,s=!1;switch(this.query.order){case"latest_last_message":i="lastMessageUpdatedAt",s=!0;break;case"chronological":i="createdAt",s=!0;break;case"channel_name_alphabetical":i="name";break;default:i="lastMessageUpdatedAt",s=!0}t.query(a,{orderBy:i,desc:s,offset:this.channels.length,limit:this.query.limit}).then(function(n){return e(null,n)}).catch(function(n){return e(n)})}}},{key:"fetch",value:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};o.default.call("fetch()");var t=d.get(this);this.isLoading?n(null):(this.isLoading=!0,this._fetchFromCache(function(r,a){if(o.default.cache("channel",r,a?a.map(function(e){return e.url}):[]),a)for(var i in a){var u=t.channels.map(function(e){return e.url}).indexOf(a[i].url);(u<0||!t.channels[u].isEqual(a[i]))&&t.addViewItem(a[i])}if(e.query.hasNext){var c=e.sendBird;e.query.next(function(r,a){if(c.getErrorFirstCallback()){var i=r;r=a,a=i}if(o.default.sync("channel",a,r?r.map(function(e){return e.url}):[]),Array.isArray(r)){var u=f.get(e),l=h.get(e),d=[];r.forEach(function(n){d.push(new Promise(function(r,a){l.getItem(n.url).then(function(i){var s=t.channels.map(function(e){return e.url}).indexOf(n.url)>=0;l.upsert(n).then(function(n){var a=!i||!i.isEqual(n);a&&u.update(n,e),s&&!a||t.addViewItem(n),r()}).catch(a)}).catch(a)}))}),Promise.all(d).then(function(){if(!e.isSynced){var a=v.get(e);t.mutex.lock(function(e){var n=r.map(function(e){return e.url});for(var i in t.channels)if(n.indexOf(t.channels[i].url)<0){var u=s.ChannelEventAction.REMOVE;for(var o in a)a[o].onChannelEvent(u,t.channels[i])}e()}),e.isSynced=!0}e.isLoading=!1,n(null)}).catch(function(t){e.isLoading=!1,n(t)})}else e.isLoading=!1,n(a)})}else e.isLoading=!1,n(null)}))}},{key:"remove",value:function(){f.get(this).removeCollection(this)}},{key:"setCollectionHandler",value:function(e){var n=v.get(this);e instanceof s.ChannelCollectionHandler&&(n["channel-collection-handler"]=e)}},{key:"removeCollectionHandler",value:function(){var e=v.get(this);e["channel-collection-handler"]&&delete e["channel-collection-handler"]}},{key:"channels",get:function(){return d.get(this).channels}}],[{key:"CollectionHandler",get:function(){return s.ChannelCollectionHandler}},{key:"Action",get:function(){return s.ChannelEventAction}}]),e}()},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.MessageCollection=n.MessageCollectionViewAdapter=void 0;var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=h(t(2)),i=h(t(7)),s=t(20),u=t(8),o=t(10),c=h(t(9)),l=h(t(1)),f=h(t(0)),d=t(5);function h(e){return e&&e.__esModule?e:{default:e}}function v(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var g=new WeakMap,m=new WeakMap,p=new WeakMap,y=new WeakMap,b=new WeakMap,C=new WeakMap,I=new WeakMap,k=new WeakMap,w=50,E=100,M=100,A=50,_=n.MessageCollectionViewAdapter=function(){function e(){v(this,e),this.collection=null,this.messages=[],this.prevTempMessages=[],this.nextTempMessages=[],g.set(this,{}),this.currentChunk=null,this.viewRange={start:0,end:0}}return r(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"addViewItem",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=k.get(this.collection),r=g.get(this),a=I.get(this.collection),i=!0,u=!1;if(n.isEventMessage){var c=a.state===s.BackgroundSync.State.END||a.state===s.BackgroundSync.State.PAUSED,l=!this.currentChunk||this.currentChunk.endAt<=this.viewRange.end,h=0===this.viewRange.end;u=(i=c&&l||h)&&h||0===e.messageId}var v=this.collection.sendBird.currentUser?this.collection.channel.getReadReceipt(e):r[e.messageId]||0;if(r[e.messageId]||(r[e.messageId]=v),i){var m=(0,d.getMessageIndex)(e,this.messages),p=(0,d.findMessageIndex)(e,this.messages);if(m>=0&&this.messages[m].isEqual(e)&&r[e.messageId]===v)return;r[e.messageId]=v,e.messageId&&(this.viewRange.start=this.viewRange.start>0?Math.min(this.viewRange.start,e.createdAt):e.createdAt,this.viewRange.end=this.viewRange.end>0?Math.max(this.viewRange.end,e.createdAt):e.createdAt);var y=null;if(m<0)y=o.MessageEventAction.INSERT,this.messages.splice(p,0,e),u&&this.nextTempMessages.push(e);else if(e.messageId){var b=this.messages[m];if(b.messageId)this.messages[m]=e,y=o.MessageEventAction.UPDATE;else{for(var C in this.messages.splice(m,1),f.default.view("message","remove",b.messageId,b.createdAt),t)t[C].onMessageEvent("remove",b);var w=m<p?1:0;this.messages.splice(p-w,0,e),y=o.MessageEventAction.INSERT}}if(y)for(var E in f.default.view("message",y,e.messageId,e.createdAt),t)t[E].onMessageEvent(y,e)}}},{key:"removeViewItem",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,t=k.get(this.collection),r=g.get(this);for(var a in this.messages)if(e===this.messages[a].messageId||n===this.messages[a].reqId){"number"==typeof r[e]&&delete r[e];var i=this.messages.splice(a,1),s=o.MessageEventAction.REMOVE;for(var u in f.default.view("message",s,i.map(function(e){return e.messageId})),t)t[u].onMessageEvent(s,i.length>0?i[0]:{messageId:e});break}this.viewRange.start=this.messages.length>0?this.messages[0].createdAt:0,this.viewRange.end=this.messages.length>0?this.messages[this.messages.length-1].createdAt:0}},{key:"clearPreviewItem",value:function(){var e=k.get(this.collection),n=[];for(var t in this.messages)0===this.messages[t].messageId&&n.push({index:parseInt(t),item:this.messages[t]});for(var r=n.length-1;r>=0;r--){var a=n[r],i=o.MessageEventAction.REMOVE;for(var s in f.default.view("message",i,"preview message"),e)e[s].onMessageEvent(i,a.item);this.messages.splice(a.index,1)}}},{key:"clearViewItem",value:function(){this.currentChunk=null,this.messages=[],g.set(this,{}),this.viewRange.start=0,this.viewRange.end=0;var e=k.get(this.collection),n=o.MessageEventAction.CLEAR;for(var t in f.default.view("message",n),e)e[t].onMessageEvent(n)}}]),e}();n.MessageCollection=function(){function e(n,t){var r=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(new Date).getTime();v(this,e);var o=i.default.getInstance();if(!o)return null;if(this.sendBird=o.sb,this.channel=n,this.limit=A,this.filter=u.MessageChunk.getDefaultFilter(),t&&Object.keys(t).length>0)for(var l in t)this.filter.hasOwnProperty(l)&&(this.filter[l]=t[l]);this.viewpoint=a,this._isLoading={prev:!1,next:!1};var d=new _;d.attachCollection(this),p.set(this,d),o.broadcast.addCollection(this,d),m.set(this,o.broadcast),y.set(this,o.messageContainer),b.set(this,o.chunkContainer),k.set(this,{}),C.set(this,null),I.set(this,null);var h=new c.default,g=function(e,t,a){f.default.sync("message synchronize() begin",e,t);var i=null,s=0,c=[t];switch(e){case"prev":i="getPreviousMessagesByTimestamp",s=E,c.push(!0),c.push(E);break;case"next":i="getNextMessagesByTimestamp",s=M,c.push(!0),c.push(M);break;case"prevnext":i="getPreviousAndNextMessagesByTimestamp",s=2*w,c.push(w),c.push(w)}c.push(!1),c.push(r.filter.messageType||""),c.push(r.filter.customType||""),c.push(r.filter.senderUserIds||[]),c.push(r.filter.includeMetaArray||!1),n[i].apply(n,c.concat([function(n,i){i?(r._pause(),a(i)):(f.default.sync("message synchronize() end",e,t,n.map(function(e){return e.messageId})),h.lock(function(t){var i=[],c={startAt:1/0,endAt:0};if(n.length>0){for(var l in n)n[l].isVisible=!0,i.push(o.messageContainer.upsert(n[l])),c.startAt=Math.min(c.startAt,n[l].createdAt),c.endAt=Math.max(c.endAt,n[l].createdAt);d.currentChunk&&d.currentChunk.isOverlap(c)||(d.currentChunk=new u.MessageChunk(r.channel.url,r.filter),f.default.message("chunk is created",d.currentChunk)),d.currentChunk.extendWithChunk(c),f.default.message("currentChunk is extended",d.currentChunk),o.chunkContainer.mergePreviousChunkOverlap(d.currentChunk).then(function(){f.default.message("currentChunk merged previous chunks",d.currentChunk),Promise.all(i).then(function(){t(),a(null,{count:n.length,nextTs:"prev"===e?d.currentChunk.startAt:d.currentChunk.endAt,hasMore:n.length>=s})}).catch(function(e){t(),a(e)})}).catch(function(e){t(),a(e)})}else t(),a(null,{count:0,nextTs:0,hasMore:!1})}))}]))},U=new s.BackgroundSync(function(e,n){return g("prev",e,n)});C.set(this,U);var S=new s.BackgroundSync(function(e,n){return g("next",e,n)});I.set(this,S),o.chunkContainer.getChunkByTimestamp(this.channel.url,this.filter,this.viewpoint).then(function(e){e&&(d.currentChunk=e),d.currentChunk?r._resume():g("prevnext",r.viewpoint,function(e,n){U.flush(e,n),S.flush(e,n),r._resume()})}).catch(function(){})}return r(e,[{key:"_pause",value:function(){var e=p.get(this),n=C.get(this),t=I.get(this);n&&n.pause(),t&&t.pause(),e.currentChunk=null}},{key:"_resume",value:function(){var e=this;i.default.getInstance().syncChangeLog(this.channel,function(){var n=p.get(e),t=C.get(e),r=I.get(e);if(t){var a=n.currentChunk?n.currentChunk.startAt:e.viewpoint;t.start(a)}if(r){var i=n.currentChunk?n.currentChunk.endAt:e.viewpoint;r.start(i)}})}},{key:"fetch",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},r=p.get(this),a=y.get(this),i=b.get(this);if(this._isLoading[e])f.default.error("fetch() is loading"),t(l.default.create(l.default.Type.ERROR_DUPLICATED_FETCH));else{this._isLoading[e]=!0,f.default.call("fetch()",e);var u=null,o=this.viewpoint,c=this.limit,d=!1,h=o,v=null,g=null;switch(e){case"prev":u=C.get(this),r.viewRange.start>0&&(o=r.viewRange.start),r.currentChunk&&(h=Math.max(r.currentChunk.startAt,o)),v=r.prevTempMessages,g=a.loadPreviousMessages,d=!0;break;case"next":u=I.get(this),r.viewRange.end>0&&(o=r.viewRange.end),r.currentChunk&&(h=Math.min(r.currentChunk.endAt,o)),v=r.nextTempMessages,g=a.loadNextMessages;break;default:return void t(l.default.create(l.default.Type.ERROR_INVALID_PARAMETER))}var m=function(t,a){f.default.message("waiting for synchronization..."),g(n.channel.url,n.filter,t,{limit:c,desc:d}).then(function(t){for(var i in f.default.cache("temp message",e,t.map(function(e){return e.messageId})),t)v.push(t[i]),r.addViewItem(t[i]);n._isLoading[e]=!1,a(null)}).catch(function(t){n._isLoading[e]=!1,a(t)});var s=h;f.default.sync("subscribe message",e,t),u.subscribe(function(a){a?f.default.error(a):(f.default.sync("flush message",e,t),i.getChunkByTimestamp(n.channel.url,n.filter,t).then(function(t){t&&(r.currentChunk=t),r.currentChunk&&g(n.channel.url,n.filter,s,{limit:c,desc:d}).then(function(n){f.default.cache("flush message",e,s,n.map(function(e){return e.messageId})),r.clearPreviewItem();var t=!1;for(var a in n)if(r.currentChunk.containsMessage(n[a])){t=!0;var i=r.messages.map(function(e){return e.messageId}).indexOf(n[a].messageId);(i<0||!r.messages[i].isEqual(n[a]))&&r.addViewItem(n[a])}if(!t){for(var u in v)r.messages.map(function(e){return e.messageId}).indexOf(v[u].messageId)<0&&r.removeViewItem(v[u].messageId);for(;v.length>0;)v.pop()}}).catch(function(e){return f.default.error(e)})}).catch(function(e){return f.default.error(e)}))})};i.getChunkByTimestamp(this.channel.url,this.filter,o).then(function(a){a&&(r.currentChunk=a),r.currentChunk?(f.default.message("chunk is selected",r.currentChunk),g(n.channel.url,n.filter,o,{limit:c,desc:d}).then(function(a){f.default.cache("fetch message",e,o,a.map(function(e){return e.messageId}));var i=!1;for(var s in a)if(r.currentChunk.containsMessage(a[s])){i=!0;var u=r.messages.map(function(e){return e.messageId}).indexOf(a[s].messageId);(u<0||!r.messages[u].isEqual(a[s]))&&r.addViewItem(a[s])}if(!i){for(var l in v)r.messages.map(function(e){return e.messageId}).indexOf(v[l].messageId)<0&&r.removeViewItem(v[l].messageId);for(;v.length>0;)v.pop()}a.length<c?(c-=a.length,m(o,t)):(n._isLoading[e]=!1,t(null))}).catch(function(r){n._isLoading[e]=!1,t(r)})):m(o,t)}).catch(function(r){n._isLoading[e]=!1,t(r)}),u.state===s.BackgroundSync.State.PAUSED&&this._resume()}}},{key:"resetViewpointTimestamp",value:function(e){f.default.call("resetViewpointTimestamp()",e);var n=p.get(this);n.viewRange.start<=e&&e<=n.viewRange.end?n.currentChunk&&!n.currentChunk.contains(e)&&(n.currentChunk=null):(n.currentChunk=null,n.clearViewItem()),this.viewpoint=e,this._resume()}},{key:"remove",value:function(){p.get(this).currentChunk=null,m.get(this).removeCollection(this)}},{key:"appendMessage",value:function(e){f.default.call("appendMessage()",e.messageId);var n=a.default.getInstance(),t=p.get(this);if(e.sender&&e.sender.userId===n.currentUserId)if(e.messageId){var r=m.get(this),i=y.get(this);e.isVisible=!0,i.upsert(e).then(function(e){return r.upsert(e)})}else t.addViewItem(e,{isEventMessage:!0})}},{key:"updateMessage",value:function(e){f.default.call("updateMessage()",e.messageId);var n=a.default.getInstance(),t=p.get(this);if(e.sender&&e.sender.userId===n.currentUserId)if(e.messageId){var r=m.get(this),i=y.get(this);e.isVisible=!0,i.upsert(e).then(function(e){return r.update(e)})}else t.addViewItem(e)}},{key:"deleteMessage",value:function(e){f.default.call("deleteMessage()",e.messageId);var n=a.default.getInstance(),t=p.get(this);e.sender&&e.sender.userId===n.currentUserId&&(e.messageId||t.removeViewItem(e.messageId,e.reqId))}},{key:"setCollectionHandler",value:function(e){var n=k.get(this);e instanceof o.MessageCollectionHandler&&(n["message-collection-handler"]=e)}},{key:"removeCollectionHandler",value:function(){var e=k.get(this);e["message-collection-handler"]&&delete e["message-collection-handler"]}},{key:"messages",get:function(){return p.get(this).messages}}],[{key:"CollectionHandler",get:function(){return o.MessageCollectionHandler}},{key:"Action",get:function(){return o.MessageEventAction}}]),e}()},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.BackgroundSync=void 0;var r,a=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),i=t(0),s=(r=i)&&r.__esModule?r:{default:r};n.BackgroundSync=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.worker=n,this.state=e.State.PAUSED,this.isLoading=!1,this.subscribes=[]}return a(e,[{key:"start",value:function(n){var t=this;this.isLoading||(this.isLoading=!0,this.state=e.State.RUNNING,this.worker(n,function(n,r){s.default.sync("background sync result: err=",n,"res=",r),n?(t.isLoading=!1,t.state=e.State.PAUSED):(t.isLoading=!1,t.flush(n,r),t.state===e.State.RUNNING&&(r.hasMore?t.start(r.nextTs):t.state=e.State.END))}))}},{key:"pause",value:function(){this.isLoading=!1,this.state=e.State.PAUSED}},{key:"flush",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments[1];for(s.default.sync("background sync flush:",this.subscribes.length+" subscribes");this.subscribes.length>0;){this.subscribes.pop()(e,n)}}},{key:"subscribe",value:function(e){0===this.subscribes.length&&this.subscribes.push(e)}}],[{key:"State",get:function(){return{RUNNING:"running",PAUSED:"paused",END:"end"}}}]),e}()}]).default});