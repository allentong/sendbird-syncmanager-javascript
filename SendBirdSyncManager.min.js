!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.SendBirdSyncManager=n():e.SendBirdSyncManager=n()}(window,function(){return function(e){var n={};function t(r){if(n[r])return n[r].exports;var a=n[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,t),a.l=!0,a.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var a in e)t.d(r,a,function(n){return e[n]}.bind(null,a));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=2)}([function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e)}return r(e,null,[{key:"put",value:function(e){}},{key:"call",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["CALL"].concat(t))}},{key:"cache",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["CACHE"].concat(t))}},{key:"sync",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["SYNC"].concat(t))}},{key:"event",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["EVENT"].concat(t))}},{key:"view",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["VIEW"].concat(t))}},{key:"warning",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["WARNING"].concat(t))}},{key:"error",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["ERROR"].concat(t))}},{key:"message",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];e.put.apply(e,["MESSAGE"].concat(t))}}]),e}();n.default=a},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r,a=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),i=t(0),o=(r=i)&&r.__esModule?r:{default:r};var u=function(e){function n(e,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,n);var r=function(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return r.name="SyncManagerException",r.code=t||0,r}return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}(n,Error),a(n,null,[{key:"create",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.Type.ERROR_UNKNOWN;return new n(e.message,e.code)}},{key:"throw",value:function(e){if(o.default.error(e),e instanceof n)throw e}},{key:"Type",get:function(){return{ERROR_UNKNOWN:{code:81e4,message:"Unknown error occurred."},ERROR_DATABASE_IO:{code:810001,message:"Database I/O operation failed."},ERROR_SETUP_MISSING:{code:810100,message:"SendBirdSyncManager.setup() is not called."},ERROR_SENDBIRD_MISSING:{code:810101,message:"SendBird instance should be set before init()."},ERROR_DUPLICATED_FETCH:{code:810200,message:"Fetch is in progress."},ERROR_DUPLICATED_CHANGELOG_SYNC:{code:810210,message:"Sync is in progress."},ERROR_INVALID_PARAMETER:{code:810300,message:"Invalid parameter."}}}}]),n}();n.default=u},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=v(t(5)),i=v(t(16)),o=v(t(9)),u=v(t(3)),s=v(t(17)),l=t(35),c=t(36),f=v(t(1)),d=v(t(0)),h=t(4);function v(e){return e&&e.__esModule?e:{default:e}}var y=null,p=null,g=null,m=i.default,b=null,k=null,C=null,I=function(){function e(){return function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),p||(p=this),p}return r(e,[{key:"resumeSync",value:function(){d.default.call("resumeSync()"),k&&k.start(),C&&C.start()}},{key:"pauseSync",value:function(){d.default.call("pauseSync()"),k&&k.stop(),C&&C.stop()}},{key:"clearCache",value:function(e){return d.default.call("clearCache()"),(0,h.promisify)(function(e){var n=[];k&&n.push(new Promise(function(e,n){k.reset(function(t){return t?n(t):e()})})),C&&n.push(new Promise(function(e,n){C.reset(function(t){return t?n(t):e()})})),n.length>0?Promise.all(n).then(function(){return e(null)}).catch(function(n){return e(n)}):e(null)},e)}},{key:"reset",value:function(e){var n=this;return d.default.call("reset()"),(0,h.promisify)(function(e){n.clearCache(function(n){n||(u.default.clear(function(){k=null}),s.default.clear(function(){C=null})),e(n)})},e)}},{key:"currentUserId",get:function(){return y&&y.currentUser?y.currentUser.userId:g}}],[{key:"setup",value:function(n,t){return d.default.call("init()"),(0,h.promisify)(function(t){if(o.default.init(),y)if(p=new e,y.currentUser&&n!==y.currentUser.userId&&(d.default.warning("Different user ID: clear cache"),p.clearCache()),g=n,u.default.clear(),k=null,s.default.clear(),C=null,b)d.default.cache("Database is open"),k=new u.default({sendBird:y,db:b}),C=new s.default({sendBird:y,db:b}),e.ChannelCollection=l.ChannelCollection,e.MessageCollection=c.MessageCollection,t(null);else{var r=new m("sbsync.db",3);r.schema("GroupChannel",{key:"url",index:[{ownerUserId:m.Query.Order.ASC,lastMessageUpdatedAt:m.Query.Order.DESC},{ownerUserId:m.Query.Order.ASC,createdAt:m.Query.Order.DESC},{ownerUserId:m.Query.Order.ASC,name:m.Query.Order.ASC}]}).schema("GroupChannelListQuery",{key:"filterKey",index:[{ownerUserId:m.Query.Order.ASC,updatedAt:m.Query.Order.DESC}]}).schema("MessageChunk",{key:"chunkId",index:[{ownerUserId:m.Query.Order.ASC,channelUrl:m.Query.Order.ASC,filterKey:m.Query.Order.ASC,endAt:m.Query.Order.DESC}]}).schema("Message",{key:"messageId",index:[{ownerUserId:m.Query.Order.ASC,channelUrl:m.Query.Order.ASC,createdAt:m.Query.Order.DESC}]}).build().then(function(){d.default.cache("Database is created"),k=new u.default({sendBird:y,db:r}),C=new s.default({sendBird:y,db:r}),b=r,e.ChannelCollection=l.ChannelCollection,e.MessageCollection=c.MessageCollection,t(null)}).catch(function(e){return t(e)})}else t(f.default.create(f.default.Type.ERROR_SETUP_MISSING))},t)}},{key:"getInstance",value:function(){return p}},{key:"useReactNative",value:function(e){o.default.useReactNative(e),a.default.Storage=e,m=a.default}},{key:"sendBird",get:function(){return y},set:function(e){y=e}},{key:"LocalDB",get:function(){return m}}]),e}();n.default=I},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=t(30),i=t(31),o=t(32),u=f(t(2)),s=f(t(9)),l=f(t(1)),c=f(t(0));function f(e){return e&&e.__esModule?e:{default:e}}var d="syncManager_channelManager_channelHandler_"+(new Date).getTime(),h=null,v=function(){function e(n){var t=n.sendBird,r=n.db;if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),!h){c.default.call("ChannelManager()"),h=this;var s=this.sb=t,f=u.default.getInstance();this.channelContainer=new a.ChannelContainer(r,s),this.queryContainer=new i.ChannelListQueryContainer(r,s),this.broadcast=new o.ChannelBroadcast,this.isFetchingChangeLog=!1,this.channelSyncByFilter={},this.changeLogSync=null;var v=new s.ChannelHandler;Object.keys(v).forEach(function(e){v[e]=function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];switch(e){case"onChannelChanged":var a=t[0];c.default.event(e,a.url),h.channelContainer.getItem(a.url,function(e,n){e?l.default.throw(e):h.channelContainer.upsert(a,function(e,t){e?l.default.throw(e):n?n.hiddenState!==s.GroupChannel.HiddenState.UNHIDDEN&&a.hiddenState===s.GroupChannel.HiddenState.UNHIDDEN?h.broadcast.unhide([t]):h.broadcast.update([t]):h.broadcast.upsert([t])})});break;case"onUserMuted":case"onUserUnmuted":case"onUserUnbanned":case"onChannelFrozen":case"onChannelUnfrozen":case"onMetaDataCreated":case"onMetaDataUpdated":case"onMetaDataDeleted":case"onMetaCountersCreated":case"onMetaCountersUpdated":case"onMetaCountersDeleted":c.default.event(e,t[0].url),h.channelContainer.upsert(t[0],function(e,n){e?l.default.throw(e):h.broadcast.update([n])});break;case"onUserReceivedInvitation":case"onUserJoined":c.default.event(e,t[0].url),h.channelContainer.upsert(t[0],function(e,n){e?l.default.throw(e):t[1].userId===f.currentUserId?h.broadcast.upsert([n]):h.broadcast.update([n])});break;case"onReadReceiptUpdated":h.channelContainer.upsert(t[0],function(e){e&&l.default.throw(e)});break;case"onMessageReceived":t[0].lastMessage&&t[0].lastMessage.messageId!==t[1].messageId||h.channelContainer.upsert(t[0],function(e,n){e?l.default.throw(e):h.broadcast.upsert([n])});break;case"onChannelHidden":c.default.event(e,t[0].url);var i=t[0];h.channelContainer.upsert(i,function(e){e?l.default.throw(e):h.broadcast.hide([i])});break;case"onUserLeft":case"onUserBanned":c.default.event(e,t[0].url);var o=t[0];t[1].userId===f.currentUserId?h.channelContainer.remove(o,function(e){e?l.default.throw(e):h.broadcast.remove([o])}):h.channelContainer.upsert(o,function(e,n){e?l.default.throw(e):h.broadcast.update([n])});break;case"onUserDeclinedInvitation":c.default.event(e,t[0].url);var u=t[0];t[2].userId===f.currentUserId?h.channelContainer.remove(u,function(e){e?l.default.throw(e):h.broadcast.remove([u])}):h.channelContainer.upsert(u,function(e,n){e?l.default.throw(e):h.broadcast.update([n])});break;case"onChannelDeleted":c.default.event(e,t[0]),h.channelContainer.getItem(t[0],function(e,n){e?l.default.throw(e):n&&h.channelContainer.remove(n,function(e){e?l.default.throw(e):h.broadcast.remove([n])})})}}}),s.addChannelHandler(d,v)}return h}return r(e,[{key:"syncChangeLog",value:function(e,n){var t=this;if(this.isFetchingChangeLog)n(l.default.create(l.default.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLog=!0,c.default.call("channel syncChangeLog()");s.default.get("channel-changeLog-token").then(function(r){var a,i="getMyGroupChannelChangeLogsByToken",o=[];o.push([]),o.push(!0),r?(i="getMyGroupChannelChangeLogsByToken",o.unshift(r)):(i="getMyGroupChannelChangeLogsByTimestamp",o.unshift((new Date).getTime()-100)),c.default.call(i),(a=t.sb)[i].apply(a,o.concat([function(r,a){if(t.sb.getErrorFirstCallback()){var i=r;r=a,a=i}if(a)t.isFetchingChangeLog=!1;else{c.default.sync("updated",r.updatedChannels&&r.updatedChannels.length>0?"\n"+r.updatedChannels.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n"):[]),c.default.sync("deleted",r.deletedChannelUrls);var o=[];r.updatedChannels.forEach(function(e){o.push(new Promise(function(n,r){h.channelContainer.getItem(e.url,function(a,i){a?r(a):h.channelContainer.upsert(e,function(e,a){if(e)r(e);else{var o=!i||!i.isEqual(a),u=(!i||i.hiddenState===t.sb.GroupChannel.HiddenState.UNHIDDEN)&&a.hiddenState!==t.sb.GroupChannel.HiddenState.UNHIDDEN,s=(!i||i.hiddenState!==t.sb.GroupChannel.HiddenState.UNHIDDEN)&&a.hiddenState===t.sb.GroupChannel.HiddenState.UNHIDDEN,l=o?"update":"noop";u?l="hide":s&&(l="unhide"),n({action:l,channel:a})}})})}))}),r.deletedChannelUrls.forEach(function(e){o.push(new Promise(function(n,t){h.channelContainer.getItem(e,function(e,r){e?t(e):r&&h.channelContainer.remove(r,function(e){if(e)t(e);else{n({action:"remove",channel:r})}})})}))}),Promise.all(o).then(function(a){for(var i=[],o=[],u=[],l=[],c=0;c<a.length;c++)switch(a[c].action){case"update":i.push(a[c].channel);break;case"remove":o.push(a[c].channel);break;case"hide":u.push(a[c].channel);break;case"unhide":l.push(a[c].channel)}i.length>0&&h.broadcast.upsert(i,null,{isChangeLogChannel:!0}),o.length>0&&h.broadcast.remove(o),u.length>0&&h.broadcast.hide(u,null,{isChangeLogChannel:!0}),l.length>0&&h.broadcast.unhide(l,null,{isChangeLogChannel:!0}),s.default.set("channel-changeLog-token",r.token).then(function(){r.hasMore?t.syncChangeLog(e,n):(t.isFetchingChangeLog=!1,n())}).catch(function(e){t.isFetchingChangeLog=!1,n(e)})}).catch(function(e){return n(e)})}}]))}).catch(function(e){t.isFetchingChangeLog=!1,n(e)})}}},{key:"start",value:function(){h.broadcast.resume()}},{key:"stop",value:function(){h.broadcast.pause()}},{key:"clearCache",value:function(e){h.channelSyncByFilter={},h.changeLogSync=null,h.channelContainer.clear(function(){h.queryContainer.clear(function(){s.default.getKeys().then(function(n){var t=[];n.forEach(function(e){e.startsWith("channel-changeLog-token")&&t.push(s.default.remove(e))}),Promise.all(t).then(function(){return e()}).catch(function(n){c.default.error(n),e(n)})}).catch(function(n){return e(n)})})})}},{key:"reset",value:function(e){h?(h.broadcast.clear(),h.clearCache(e)):e(null)}}],[{key:"getInstance",value:function(){return h}},{key:"clear",value:function(){h&&h.sb&&(c.default.message("ChannelManager is cleared"),h.channelSyncByFilter={},h.changeLogSync=null,h.broadcast.clearCollection(),h.sb.removeChannelHandler(d),h=null)}}]),e}();n.default=v},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.getChannelIndex=function(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]).map(function(e){return e.url}).indexOf(e.url)},n.findChannelIndex=function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=null,a=function(e,n){return e>n};switch(n.order){case"latest_last_message":r="lastMessageUpdatedAt";break;case"chronological":r="createdAt";break;case"channel_name_alphabetical":r="name",a=function(e,n){return e.localeCompare(n)<0};break;default:r="lastMessageUpdatedAt"}for(var i=t.length,o=0;o<t.length;o++){var u=t[o];if(e[r]===u[r]&&e.url===u.url){i=o;break}if(a(e[r],u[r])){i=o;break}}return i},n.getMessageIndex=function(e){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],t=0;t<n.length;t++)if(e.isIdentical(n[t]))return t;return-1},n.findMessageIndex=function(e){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],t=n.length,r=0;r<n.length;r++)if(n[r].createdAt>=e.createdAt){t=r;break}return t};n.deepEqual=function e(n,t){var a=void 0===n?"undefined":r(n),i=void 0===t?"undefined":r(t);return!n||!t||"object"!==a||a!==i||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===a&&"function"===i||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(r){return e(n[r],t[r])})},n.createUUID=function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?t:3&t|8).toString(16)})},n.promisify=function(e,n){if(!n)return new Promise(function(n,t){e(function(e){return e?t(e):n()})});e(n)}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=u(t(6)),i=u(t(10)),o=u(t(22));function u(e){return e&&e.__esModule?e:{default:e}}var s=null,l=new WeakMap,c=new WeakMap,f=function(){function e(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=n,this.config=new a.default(t),l.set(this,{}),c.set(this,{})}return r(e,null,[{key:"Query",get:function(){return i.default}},{key:"Storage",get:function(){return s},set:function(e){s=e}}]),r(e,[{key:"schema",value:function(e,n){var t=l.get(this);return t[e]=n,this}},{key:"build",value:function(){var e=l.get(this),n=c.get(this);return new Promise(function(t,r){var a=[];for(var i in e)if(!n[i]){var u=e[i].key||"_id",s=n[i]=new o.default(i,u);a.push(s.init())}Promise.all(a).then(function(){var a=[];for(var i in n)if(e[i].index&&e[i].index.length>0){var o=n[i];for(var u in e[i].index)a.push(o.ensureIndex(e[i].index[u]))}a.length>0?Promise.all(a).then(function(){t()}).catch(function(e){return r(e)}):t()}).catch(function(e){return r(e)})})}},{key:"close",value:function(){}},{key:"drop",value:function(){l.set(this,{}),_db.set(this,null),c.set(this,{}),s.clear()}},{key:"collection",value:function(e){var n=c.get(this);return n[e]&&n[e]instanceof o.default?n[e]:null}}]),e}();n.default=f},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=64,i=200,o=128,u=32,s=null,l=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),s||(s=this),this.batchSize=a,this.batchInterval=i,this.cachedBlockLimit=o,this.cachedBlockFlush=u,this.encryption={encrypt:function(e,n){return n(null,e)},decrypt:function(e,n){return n(null,e)}},"number"==typeof n.batchSize&&n.batchSize>1&&(this.batchSize=n.batchSize),"number"==typeof n.batchInterval&&n.batchInterval>10&&(this.batchInterval=n.batchInterval),"number"==typeof n.cachedBlockLimit&&n.cachedBlockLimit>0&&(this.cachedBlockLimit=n.cachedBlockLimit),"number"==typeof n.cachedBlockFlush&&n.cachedBlockFlush<this.cachedBlockLimit&&(this.cachedBlockFlush=n.cachedBlockFlush),n.encryption&&n.encryption.hasOwnProperty("encrypt")&&n.encryption.hasOwnProperty("decrypt")&&"function"==typeof n.encryption.encrypt&&"function"==typeof n.encryption.decrypt&&(this.encryption=n.encryption),s}return r(e,null,[{key:"getInstance",value:function(){return s}}]),e}();n.default=l},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function a(e){return null!=e}n.deepEqual=function e(n,t){var a=void 0===n?"undefined":r(n),i=void 0===t?"undefined":r(t);return!n||!t||"object"!==a||a!==i||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===a&&"function"===i||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(r){return e(n[r],t[r])})},n.isDefined=a,n.isNone=function(e){return!a(e)},n.compare=function(e,n){var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(a(e)){if(!a(n))return t?-1:1;if((void 0===e?"undefined":r(e))===(void 0===n?"undefined":r(n))&&e!==n){var i=void 0===e?"undefined":r(e);if("boolean"===i)return e?1:-1;if("number"===i)return e>n?1:-1;if("string"===i)return e.localeCompare(n);if(e instanceof Date&&n instanceof Date&&e.getTime()!==n.getTime())return e.getTime()>n.getTime()?1:-1}}else if(a(n))return t?1:-1;return 0},n.promisify=function(e,n,t){if(!n)return new Promise(function(n,r){e(function(e,a){t&&"function"==typeof t&&t(),e?r(e):n(a)})});e(function(e,r){t&&"function"==typeof t&&t(),n(e,r)})}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.deepEqual=function e(n,t){var a=void 0===n?"undefined":r(n),i=void 0===t?"undefined":r(t);return!n||!t||"object"!==a||a!==i||n instanceof Date?n instanceof Date?n.getTime()===t.getTime():"function"===a&&"function"===i||n===t:Object.keys(n).length===Object.keys(t).length&&Object.keys(n).every(function(r){return e(n[r],t[r])})},n.createIndexName=function(e){var n=null;return e&&(Array.isArray(e)?n=e.join("_"):"object"===(void 0===e?"undefined":r(e))?n=Object.keys(e).join("_"):"string"==typeof e&&(n=e)),n},n.promisify=function(e,n,t){if(!n)return new Promise(function(n,r){e(function(e,a){t&&"function"==typeof t&&t(),e?r(e):n(a)})});e(n)}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=null,i=!1,o=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e)}return r(e,null,[{key:"init",value:function(){a||(a=window?window.localStorage:null)}},{key:"useReactNative",value:function(e){a=e,i=!0}},{key:"getKeys",value:function(){return i?a.getAllKeys():new Promise(function(e){var n=[];for(var t in a)n.push(t);e(n)})}},{key:"get",value:function(e){return i?a.getItem(e):new Promise(function(n){var t=a.getItem(e);n(void 0!==t?t:null)})}},{key:"set",value:function(e,n){return i?a.setItem(e,n):new Promise(function(t){a.setItem(e,n),t()})}},{key:"remove",value:function(e){return i?a.removeItem(e):new Promise(function(n){a.removeItem(e),n()})}},{key:"clear",value:function(){return i?a.clear():new Promise(function(e){a.clear(),e()})}}]),e}();n.default=o},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=t(7);var o=1/0,u=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.condition=n,this.offset=0,this.limit=o,this.index=null,this.desc=!1}return r(e,null,[{key:"and",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];return t.length>0?new e({"/and":t}):new e({})}},{key:"or",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];return t.length>0?new e({"/or":t}):new e({})}},{key:"Order",get:function(){return{ASC:1,DESC:-1}}}]),r(e,[{key:"match",value:function(e){return function e(n,t){var r=!0;if(n)for(var o in t){switch(o){case"/and":r=r&&t[o].reduce(function(t,r){return t&&e(n,r)},!0);break;case"/or":r=r&&t[o].reduce(function(t,r){return t||e(n,r)},!1);break;default:var u=t[o];if("object"===(void 0===u?"undefined":a(u)))for(var s in u)switch(s){case">":r="number"==typeof n[o]&&"number"==typeof u[s]?r&&n[o]>u[s]:"string"==typeof n[o]&&"string"==typeof u[s]&&r&&n[o].localeCompare(u[s])>0;break;case">=":r="number"==typeof n[o]&&"number"==typeof u[s]?r&&n[o]>=u[s]:"string"==typeof n[o]&&"string"==typeof u[s]&&r&&n[o].localeCompare(u[s])>=0;break;case"<":r="number"==typeof n[o]&&"number"==typeof u[s]?r&&n[o]<u[s]:"string"==typeof n[o]&&"string"==typeof u[s]&&r&&n[o].localeCompare(u[s])<0;break;case"<=":r="number"==typeof n[o]&&"number"==typeof u[s]?r&&n[o]<=u[s]:"string"==typeof n[o]&&"string"==typeof u[s]&&r&&n[o].localeCompare(u[s])<=0;break;case"=":r=r&&n[o]===u[s];break;case"!=":r=r&&n[o]!==u[s];break;case"/in":r=r&&Array.isArray(u[s])&&u[s].indexOf(n[o])>=0;break;case"/nin":r=r&&Array.isArray(u[s])&&u[s].indexOf(n[o])<0;break;case"/like":r=r&&"string"==typeof u[s]&&"string"==typeof n[o]&&n[o].indexOf(u[s])>=0;break;case"/regex":r=r&&u[s]instanceof RegExp&&u[s].test(n[o]);break;case"/where":r=r&&u[s](n[o]);break;default:r=r&&(0,i.deepEqual)(n[o],u)}else r=r&&n[o]===u}if(!r)break}else r=!1;return r}(e,this.condition)}}]),e}();n.default=u},function(e,n,t){(function(e){var r=void 0!==e&&e||"undefined"!=typeof self&&self||window,a=Function.prototype.apply;function i(e,n){this._id=e,this._clearFn=n}n.setTimeout=function(){return new i(a.call(setTimeout,r,arguments),clearTimeout)},n.setInterval=function(){return new i(a.call(setInterval,r,arguments),clearInterval)},n.clearTimeout=n.clearInterval=function(e){e&&e.close()},i.prototype.unref=i.prototype.ref=function(){},i.prototype.close=function(){this._clearFn.call(r,this._id)},n.enroll=function(e,n){clearTimeout(e._idleTimeoutId),e._idleTimeout=n},n.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},n._unrefActive=n.active=function(e){clearTimeout(e._idleTimeoutId);var n=e._idleTimeout;n>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},n))},t(23),n.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,n.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,t(12))},function(e,n){var t;t=function(){return this}();try{t=t||new Function("return this")()}catch(e){"object"==typeof window&&(t=window)}e.exports=t},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=l(t(5)),i=l(t(6)),o=l(t(25)),u=l(t(14)),s=l(t(26));function l(e){return e&&e.__esModule?e:{default:e}}var c=function(){function e(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e);var r=i.default.getInstance();this.cachedBlockLimit=t.cachedBlockLimit||r.cachedBlockLimit,this.cachedBlockFlush=t.cachedBlockFlush||r.cachedBlockFlush,this.cacheMutex=new u.default,this.encryption=r.encryption,t.encryption&&t.encryption.hasOwnProperty("encrypt")&&t.encryption.hasOwnProperty("decrypt")&&"function"==typeof t.encryption.encrypt&&"function"==typeof t.encryption.decrypt&&(this.encryption=t.encryption),this.batchSize=t.batchSize||r.batchSize,this.batchQueue=t.sharedBatchQueue||new s.default(n,t),this.transaction=null,this.name=n,this.info={},this.blockCache={},this.blockCacheCursor=0,this.currentBlock=null}return r(e,[{key:"_findBlockKey",value:function(e){return this.info.blockMap[e]}},{key:"_getBlockFromCache",value:function(e){return this.blockCache[e]?this.blockCache[e].block:null}},{key:"_putBlockToCache",value:function(e){var n=this;this.blockCache[e.blockKey]={seq:this.blockCacheCursor++,block:e};var t=Object.keys(this.blockCache);if(t.length>=this.cachedBlockLimit)for(var r in t.sort(function(e,t){return n.blockCache[e].seq-n.blockCache[t].seq}),t)this._removeBlockFromCache(t[r])}},{key:"_removeBlockFromCache",value:function(e){this.blockCache.hasOwnProperty(e)&&delete this.blockCache[e]}},{key:"_getBlock",value:function(e,n){var t=this,r=this._getBlockFromCache(e);r?n(null,r):a.default.Storage.getItem(e).then(function(r){r?t.encryption.decrypt(r,function(r,a){if(r)n(r);else{var i=o.default.buildFromSerializedData(e,a);t._putBlockToCache(i),n(null,i)}}):n(null)}).catch(function(e){return n(e)})}},{key:"_assignNewBlock",value:function(e){this.info.cursor++;var n=o.default.createKey(this.name,this.info.cursor),t=new o.default(n);this._putBlockToCache(t),this.currentBlock=t,e&&e.key&&(t.add(e.key,e.value),this.info.blockMap[e.key]=n,this.info.count++),this.batchQueue.addJob(s.default.Action.SET,t.blockKey,t.data),this.batchQueue.addJob(s.default.Action.SET,"adb-info-"+this.name,this.info)}},{key:"init",value:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};this.batchQueue.init(function(t){t?n(t):a.default.Storage.getItem("adb-info-"+e.name,function(t,r){t?n(t):r?e.encryption.decrypt(r,function(t,r){if(t)n(t);else{e.info=JSON.parse(r);var a=o.default.createKey(e.name,e.info.cursor);e._getBlock(a,function(t,r){t||(e.currentBlock=r||new o.default(a)),n(t,e.info,!1)})}}):(e.info={blockMap:{},cursor:0,count:0},e.info.cursor=-1,e._assignNewBlock(),n(null,e.info,!0))})})}},{key:"startTransaction",value:function(){this.batchQueue.startTransaction()}},{key:"endTransaction",value:function(){this.batchQueue.endTransaction()}},{key:"getItem",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},t=this._findBlockKey(e);t?this._getBlock(t,function(t,r){!t&&r?n(null,r.get(e)):n(t||new Error("Broken integrity - data not found."))}):n(null,null)}},{key:"setItem",value:function(e,n){var t=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},a=this._findBlockKey(e);if(a)this._getBlock(a,function(a,i){!a&&i?(i.add(e,n),t.batchQueue.addJob(s.default.Action.SET,i.blockKey,i.data),r(null)):r(a||new Error("Broken integrity - data not found."))});else{var i=this.currentBlock;i&&i.count<this.batchSize?(i.add(e,n),this.batchQueue.addJob(s.default.Action.SET,i.blockKey,i.data),this.info.count++,this.info.blockMap[e]=i.blockKey,this.batchQueue.addJob(s.default.Action.SET,"adb-info-"+this.name,this.info)):this._assignNewBlock({key:e,value:n}),r(null)}}},{key:"removeItem",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},r=this._findBlockKey(e);r?this._getBlock(r,function(a,i){a?t(a):i?(i.remove(e)&&(n.info.blockMap.hasOwnProperty(e)&&delete n.info.blockMap[e],n.info.count--),i.data.length>0?n.batchQueue.addJob(s.default.Action.SET,r,i.data):(n._removeBlockFromCache(r),n.batchQueue.addJob(s.default.Action.REMOVE,r)),n.batchQueue.addJob(s.default.Action.SET,"adb-info-"+n.name,n.info),t(null)):t(new Error("Failed to remove item - data not found."))}):t(new Error("Failed to remove item - data not found."))}},{key:"clear",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},n=0;n<=this.info.cursor;n++)this.batchQueue.addJob(s.default.Action.REMOVE,o.default.createKey(this.name,n));this.blockCacheCursor=0,this.blockCache={},this.info={blockMap:{},cursor:-1,count:0},this._assignNewBlock(),e(null)}},{key:"drop",value:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};this.clear(function(){e.batchQueue.addJob(s.default.Action.REMOVE,"adb-info-"+e.name),n(null)})}},{key:"keys",get:function(){return Object.keys(this.info.blockMap)}},{key:"count",get:function(){return this.info.count}}]),e}();n.default=c},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.locked=!1,this.lockedAt=0}return r(e,[{key:"lock",value:function(e){var n=this;this.locked?setTimeout(function(){(new Date).getTime()-n.lockedAt>1e4&&n.unlock(),n.lock(e)},200):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(function(){return n.unlock()}))}},{key:"unlock",value:function(){this.locked=!1,this.lockedAt=0}}]),e}();n.default=a},function(e,n,t){"use strict";(function(e){Object.defineProperty(n,"__esModule",{value:!0}),n.forAsync=function(n){var t=n.offset,r=n.condition,a=n.progress,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(e,n){return n(null,!0)},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},u=t;!function n(){r(u)?e(function(){i(u,function(e,t){e?o(e):t?(u=a(u),n()):o(null)})}):o(null)}()}}).call(this,t(11).setImmediate)},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=u(t(28)),i=u(t(29)),o=t(8);function u(e){return e&&e.__esModule?e:{default:e}}var s=new WeakMap,l=new WeakMap,c=new WeakMap,f=window?window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB:null,d=function(){function e(n,t){if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),!f)throw new Error("IndexedDB is not supported in this environment. Check if you're in web browser which supports IndexedDB.");this.name=n,this.version=t,s.set(this,{}),l.set(this,null),c.set(this,{})}return r(e,null,[{key:"Query",get:function(){return i.default}}]),r(e,[{key:"schema",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=s.get(this);return t[e]=n,this}},{key:"build",value:function(){var e=this,n=s.get(this),t=c.get(this);return new Promise(function(r,i){var u=f.open(e.name,e.version);u.onerror=function(e){i(new Error("IndexedDB is not available: "+e.target.errorCode))},u.onupgradeneeded=function(r){var i=r.target.result,u=r.target.transaction,s=u.objectStoreNames;for(var c in n){var f=n[c].key||"id",d=null;try{d=u.objectStore(c)}catch(e){"NotFoundError"===e.name&&(d=i.createObjectStore(c,{keyPath:f}))}if(d){var h=d.indexNames,v=new a.default(i,c,f);if(n[c].index&&n[c].index.length>0)for(var y in n[c].index){var p=(0,o.createIndexName)(n[c].index[y]);if(p){var g=!1;for(var m in h)if(h[m]===p){g=!0;break}g||d.createIndex(p,Object.keys(n[c].index[y]),{unique:!1})}}var b=[];if(n[c].index)for(var k in n[c].index){var C=(0,o.createIndexName)(n[c].index[k]);C&&b.push(C)}for(var I=0;I<h.length;I++)b.indexOf(h[I])<0&&d.deleteIndex(h[I]);t[c]=v}}for(var w=0;w<s.length;w++)Object.keys(n).indexOf(s.item(w))<0&&i.deleteObjectStore(s.item(w));l.set(e,i)},u.onsuccess=function(i){var o=i.target.result;for(var u in n)if(!t[u]){var s=n[u].key||"id";t[u]=new a.default(o,u,s)}l.set(e,o),r()}})}},{key:"close",value:function(){var e=l.get(this);e&&(e.close(),l.set(this,null))}},{key:"drop",value:function(){f.deleteDatabase(this.name)}},{key:"collection",value:function(e){var n=c.get(this);return n[e]&&n[e]instanceof a.default?n[e]:null}}]),e}();n.default=d},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=t(33),i=t(18),o=t(34),u=c(t(9)),s=c(t(1)),l=c(t(0));function c(e){return e&&e.__esModule?e:{default:e}}var f="syncManager_messageManager_channelHandler_"+(new Date).getTime(),d=null,h=function(){function e(n){var t=n.sendBird,r=n.db;if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),!d){l.default.call("MessageManager()"),d=this;var u=this.sb=t;this.messageContainer=new a.MessageContainer(r,u),this.chunkContainer=new i.MessageChunkContainer(r),this.broadcast=new o.MessageBroadcast,this.isFetchingChangeLogByChannelUrl={};var c=new u.ChannelHandler;Object.keys(c).forEach(function(e){c[e]=function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];switch(e){case"onMessageReceived":l.default.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!0,d.messageContainer.upsert(t[1],function(e,n){e?s.default.throw(e):d.broadcast.upsert([n])});break;case"onReadReceiptUpdated":l.default.event(e,t[0].url);var a=t[0];d.broadcast.read(a);break;case"onMessageUpdated":l.default.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message),t[1].isVisible=!1,d.messageContainer.upsert(t[1],function(e,n){e?s.default.throw(e):d.broadcast.update([n])});break;case"onMessageDeleted":l.default.event(e,t[0].url,t[1].messageId,t[1].createdAt,t[1].message);var i=parseInt(t[1]);d.messageContainer.remove(i,function(e,n){e?s.default.throw(e):d.broadcast.remove([n])})}}}),u.addChannelHandler(f,c)}return d}return r(e,[{key:"syncChangeLog",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};if(this.isFetchingChangeLogByChannelUrl[e.url])t(s.default.create(s.default.Type.ERROR_DUPLICATED_CHANGELOG_SYNC));else{this.isFetchingChangeLogByChannelUrl[e.url]=!0,l.default.call("message syncChangeLog()",e.url);var r="last-changeLog-token-"+e.url;u.default.get(r).then(function(a){var i="getMessageChangeLogsByToken",o=[];a?(i="getMessageChangeLogsByToken",o.unshift(a)):(i="getMessageChangeLogsByTimestamp",o.unshift((new Date).getTime()-100)),l.default.call(i),e[i].apply(e,o.concat([function(a,i){if(n.sb.getErrorFirstCallback()){var o=a;a=i,i=o}i?n.isFetchingChangeLogByChannelUrl[e.url]=!1:(l.default.sync("updated",a.updatedMessages.map(function(e){return e.messageId})),l.default.sync("deleted",a.deletedMessageIds),a.updatedMessages.forEach(function(e){d.messageContainer.getItemWithVisibility(e.messageId,function(n,t){if(!n){var r=t.item;e.isVisible=t.isVisible||!1,d.messageContainer.upsert(e,function(e,n){e?s.default.throw(e):(!r||!r.isEqual(n))&&d.broadcast.update([n])})}})}),a.deletedMessageIds.forEach(function(e){d.messageContainer.remove(e,function(n){n?s.default.throw(n):d.broadcast.remove([e])})}),u.default.set(r,a.token).then(function(){a.hasMore?n.syncChangeLog(e,t):(n.isFetchingChangeLogByChannelUrl[e.url]=!1,t())}).catch(function(r){n.isFetchingChangeLogByChannelUrl[e.url]=!1,t(r)}))}]))}).catch(function(r){n.isFetchingChangeLogByChannelUrl[e.url]=!1,t(r)})}}},{key:"start",value:function(){d.broadcast.resume()}},{key:"stop",value:function(){d.broadcast.pause()}},{key:"clearCache",value:function(e){d.messageContainer.clear(function(){d.chunkContainer.clear(function(){u.default.getKeys().then(function(n){var t=[];n.forEach(function(e){e.startsWith("last-changeLog-token-")&&t.push(u.default.remove(e))}),Promise.all(t).then(function(){return e()}).catch(function(n){l.default.error(n),e(n)})}).catch(function(n){return e(n)})})})}},{key:"reset",value:function(e){d?(d.broadcast.clear(),d.clearCache(e)):e(null)}}],[{key:"getInstance",value:function(){return d}},{key:"clear",value:function(){d&&d.sb&&(l.default.message("MessageManager is cleared"),d.broadcast.clearCollection(),d.sb.removeChannelHandler(f),d=null)}}]),e}();n.default=h},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.MessageChunkContainer=n.MessageChunk=void 0;var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=u(t(2)),i=u(t(1)),o=t(4);function u(e){return e&&e.__esModule?e:{default:e}}var s={},l=function(e){var n=[];for(var t in e)n.push(t+"="+e[t]);return n.join("&")},c=n.MessageChunk=function(){function e(n,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.chunkId=(0,o.createUUID)(),this.channelUrl=n,this.filterKey=l(t),this.filter=t,this.startAt=(new Date).getTime(),this.endAt=0}return r(e,[{key:"hasDefaultFilter",value:function(){var n=e.getDefaultFilter();return(0,o.deepEqual)(this.filter,n)}},{key:"isOverlap",value:function(e){return e.startAt<=this.startAt&&this.startAt<=e.endAt||e.startAt<=this.endAt&&this.endAt<=e.endAt}},{key:"isSame",value:function(e){return e.startAt===this.startAt&&this.endAt===e.endAt}},{key:"contains",value:function(e){return this.startAt<=e&&e<=this.endAt}},{key:"containsMessage",value:function(e){return this.contains(e.createdAt)}},{key:"serialize",value:function(){var e=JSON.parse(JSON.stringify(this));return Object.freeze(e)}},{key:"extendForward",value:function(e){this.endAt=Math.max(this.endAt,e)}},{key:"extendBackward",value:function(e){this.startAt=Math.min(this.startAt,e)}},{key:"extendWithChunk",value:function(e){return this.extendForwardWithChunk(e),this.extendBackwardWithChunk(e),this}},{key:"extendForwardWithChunk",value:function(e){return this.extendForward(e.endAt),this}},{key:"extendBackwardWithChunk",value:function(e){return this.extendBackward(e.startAt),this}},{key:"extendWithMessage",value:function(e){return this.extendForwardWithMessage(e),this.extendBackwardWithMessage(e),this}},{key:"extendForwardWithMessage",value:function(e){return this.extendForward(e.createdAt),this}},{key:"extendBackwardWithMessage",value:function(e){return this.extendBackward(e.createdAt),this}}],[{key:"createFromJson",value:function(n){var t=new e(n.channelUrl,n.filter);return t.chunkId=n.chunkId,t.startAt=n.startAt,t.endAt=n.endAt,t}},{key:"getDefaultFilter",value:function(){return{messageTypeFilter:null,customTypeFilter:null,senderUserIdsFilter:[],includeMetaArray:!1}}}]),e}();n.MessageChunkContainer=function(e){var n=this,t=e.collection("MessageChunk");return this.reload=function(e,n){return t.findById(e.chunkId,n)},this.upsert=function(e,n){!function(e,n){var r=a.default.getInstance();r.currentUserId?(e.ownerUserId=r.currentUserId,s[e.chunkId]=e,t.upsert(s[e.chunkId].serialize(),function(e,t){e?n(e):n(null,t)})):n(i.default.create(i.default.Type.ERROR_SETUP_MISSING))}(e,function(e,t){e?n(e):n(null,c.createFromJson(t))})},this.remove=function(e,n){!function(e,n){a.default.getInstance().currentUserId?(s[e]&&delete s[e],t.remove(e,function(e,t){e?n(e):n(null,t)})):n(i.default.create(i.default.Type.ERROR_SETUP_MISSING))}(e,function(t){t?n(t):n(null,e)})},this.clear=function(e){return function(e){s={},t.clear(function(n){return e(n)})}(e)},this.getChunkByTimestamp=function(e,r,o,u){var s=a.default.getInstance();if(s.currentUserId){var f=new a.default.LocalDB.Query({ownerUserId:s.currentUserId,channelUrl:e,filterKey:l(r),startAt:{"<=":o},endAt:{">=":o}});f.limit=1,f.index={ownerUserId:a.default.LocalDB.Query.Order.ASC,channelUrl:a.default.LocalDB.Query.Order.ASC,filterKey:a.default.LocalDB.Query.Order.ASC,endAt:a.default.LocalDB.Query.Order.DESC},t.find(f,function(r,i){if(r)u(r);else{var s=i.length>0?c.createFromJson(i[0]):null;if(s)if(s.hasDefaultFilter())u(null,s);else{var f=new a.default.LocalDB.Query({channelUrl:e,filterKey:l(c.getDefaultFilter()),startAt:{"<=":o}});f.limit=1,f.index={ownerUserId:a.default.LocalDB.Query.Order.ASC,channelUrl:a.default.LocalDB.Query.Order.ASC,filterKey:a.default.LocalDB.Query.Order.ASC,endAt:a.default.LocalDB.Query.Order.DESC},t.find(f,function(e,t){if(e)u(e);else{var r=t.length>0?c.createFromJson(t[0]):null;if(r)if(r.endAt>s.endAt)if(r.isOverlap(s))s.extendWithChunk(r),n.upsert(s,u);else{var a=new c(s.channelUrl,s.filter);a.startAt=r.startAt,a.endAt=r.endAt,n.upsert(a,u)}else u(null,s);else u(null,s)}})}else u(null)}})}else u(i.default.create(i.default.Type.ERROR_SETUP_MISSING))},this.mergePreviousChunkOverlap=function(e,r){var o=a.default.getInstance();if(o.currentUserId){var u=new a.default.LocalDB.Query({ownerUserId:o.currentUserId,chunkId:{"!=":e.chunkId},channelUrl:e.channelUrl,filterKey:e.filterKey,endAt:{">=":e.startAt}});u.limit=1/0,t.find(u,function(i,o){if(i)r(i);else if(o.length>0){var u=new a.default.LocalDB.Query({chunkId:{"/in":o.map(function(e){return e.chunkId})}});t.removeIf(u,function(t){if(t)r(t);else{for(var a=0;a<o.length;a++)e.extendWithChunk(o[a]);n.upsert(e,r)}})}else n.upsert(e,r)})}else r(i.default.create(i.default.Type.ERROR_SETUP_MISSING))},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=6e4,i=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.locked=!1,this.lockedAt=(new Date).getTime()+a}return r(e,[{key:"isLocked",value:function(){return this.locked}},{key:"lock",value:function(e){var n=this;this.locked?setTimeout(function(){(new Date).getTime()-n.lockedAt<a&&n.lock(e)},200):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(function(){return n.unlock()}))}},{key:"unlock",value:function(){this.locked=!1,this.lockedAt=(new Date).getTime()+a}}]),e}();n.default=i},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.BackgroundSync=void 0;var r,a=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),i=t(0),o=(r=i)&&r.__esModule?r:{default:r};n.BackgroundSync=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.worker=n,this.state=e.State.PAUSED,this.isLoading=!1,this.shared=0,this.retry=0,this.retryLimit=3,this.subscribes={}}return a(e,[{key:"start",value:function(n){var t=this;(arguments.length>1&&void 0!==arguments[1]&&arguments[1]||this.state!==e.State.END)&&(this.isLoading||(this.isLoading=!0,this.state=e.State.RUNNING,this.worker(n,function(r,a){o.default.sync("background sync result: err=",r,"res=",a),r?(t.isLoading=!1,t.retry<t.retryLimit?(t.retry++,setTimeout(function(){return t.start(n)},500)):t.state=e.State.PAUSED):(t.retry=0,t.isLoading=!1,t.flush(r,a),t.state===e.State.RUNNING&&(a.hasMore?setTimeout(function(){return t.start(a.nextTs)},100):t.state=e.State.END))})))}},{key:"pause",value:function(){this.isLoading=!1,this.state=e.State.PAUSED}},{key:"end",value:function(){this.isLoading=!1,this.state=e.State.END}},{key:"flush",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments[1];for(var t in o.default.sync("background sync flush:",Object.keys(this.subscribes).length+" subscribes"),this.subscribes)this.subscribes[t](e,n);this.subscribes={}}},{key:"subscribe",value:function(e,n){return!this.subscribes[e]&&(this.subscribes[e]=n,!0)}}],[{key:"State",get:function(){return{RUNNING:"running",PAUSED:"paused",END:"end"}}}]),e}()},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.ChannelCollectionHandler=function(){this.onChannelEvent=function(e,n){}},n.MessageCollectionHandler=function(){this.onMessageEvent=function(e,n){}},n.ChannelEventAction={INSERT:"insert",UPDATE:"update",MOVE:"move",REMOVE:"remove",CLEAR:"clear"},n.MessageEventAction={INSERT:"insert",UPDATE:"update",REMOVE:"remove",CLEAR:"clear"}},function(e,n,t){"use strict";(function(e){Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),i=c(t(13)),o=t(7),u=c(t(27)),s=c(t(10)),l=t(15);function c(e){return e&&e.__esModule?e:{default:e}}var f=new WeakMap,d=new WeakMap,h=function(){function n(e,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,n),this.name=e,this.pk=t,f.set(this,new i.default(e)),d.set(this,[])}return a(n,[{key:"init",value:function(e){var n=f.get(this);return(0,o.promisify)(function(e){n.init(function(n){e(n)})},e)}},{key:"_findProperIndexer",value:function(e){if(e.index)for(var n=d.get(this),t=0;t<n.length;t++)if((0,o.deepEqual)(n[t].columns,e.index))return n[t];return null}},{key:"_addItemToIndex",value:function(e,n){for(var t=d.get(this),r=0;r<t.length;r++)t[r].put(e,n)}},{key:"_updateItemToIndex",value:function(e,n,t){for(var r=d.get(this),a=0;a<r.length;a++)r[a].update(e,n,t)}},{key:"_removeItemFromIndex",value:function(e,n){for(var t=d.get(this),r=0;r<t.length;r++)t[r].remove(e,n)}},{key:"ensureIndex",value:function(e,n){var t=this,r=f.get(this),a=d.get(this),i=u.default.createKey(e);return(0,o.promisify)(function(n){for(var o=0;o<a.length;o++)if(i===a[o].key)return void n(null);var s=new u.default({collection:t,columns:e,options:{sharedBatchQueue:r.batchQueue}});s.init(function(e,t,i){e?n(e):(a.push(s),i?function(){for(var e=r.keys,t=0,a=function(a){var i=e[a];r.getItem(i,function(r,a){!r&&a?s.put(i,a,function(){++t===e.length&&n(null)}):++t===e.length&&n(null)})},i=0;i<e.length;i++)a(i)}():n(null))})},n)}},{key:"removeIndex",value:function(e,n){var t=d.get(this),a=u.default.createKey(e);return(0,o.promisify)(function(e){for(var n=function(n){if(a===t[n].key)return t[n].drop(function(r){r||t.splice(n,1),e(r)}),{v:void 0}},i=0;i<t.length;i++){var o=n(i);if("object"===(void 0===o?"undefined":r(o)))return o.v}e(null)},n)}},{key:"findById",value:function(e,n){var t=f.get(this);return(0,o.promisify)(function(n){e?t.getItem(e,function(e,t){n(e,t)}):n(new Error("Invalid type: 'id' should not be empty."))},n)}},{key:"findOne",value:function(e,n){return e.limit=1,this.find(e,function(e,t){n(e,t.length>0?t[0]:null)})}},{key:"find",value:function(n,t){var a=this,i=f.get(this);return(0,o.promisify)(function(t){if(n instanceof s.default){var o=[],u=a._findProperIndexer(n);if(u){for(var c=[],f=0;f<u.columnNames.length;f++){var d=u.columnNames[f];if(!n.condition[d])break;if("object"===r(n.condition[d])){if("break"===function(){var e=Object.keys(n.condition[d]),t=["="],r=e.filter(function(e){return t.includes(e)});if(!(r.length>0))return"break";var a=e.indexOf(r[0]);c.push(n.condition[d][e[a]])}())break}else{if("function"==typeof n.condition[d]||void 0===n.condition[d]||Array.isArray(n.condition[d]))break;c.push(n.condition[d])}}u.each(function(e,r){e?i.getItem(e.value,function(e,t){e?r(e):(n.match(t)&&o.push(t),r(null,o.length<n.limit))}):t(null,o)},c.length>0?c:null,n.desc?s.default.Order.DESC:s.default.Order.ASC)}else{var h=!n.desc,v=i.keys;(0,l.forAsync)({offset:n.offset<v.length?h?n.offset:v.length-n.offset-1:h?v.length:0,condition:function(e){return h?o.length<n.limit&&e<v.length:o.length<n.limit&&e>=0},progress:function(e){return h?e+1:e-1}},function(t,r){i.getItem(v[t],function(t,a){t?r(t):(n.match(a)&&o.push(a),e(function(){return r(null,!0)}))})},function(e){t(e,o)})}}else t(new Error("Invalid type: 'query' should be Query type."))},t)}},{key:"count",value:function(n,t){var r=f.get(this);return(0,o.promisify)(function(t){if(!n||n instanceof s.default)if(n){var a=r.keys,i=0;(0,l.forAsync)({offset:0,condition:function(e){return e<a.length},progress:function(e){return e+1}},function(t,o){r.getItem(a[t],function(t,r){t?o(t):(n.match(r)&&i++,e(function(){return o(null,!0)}))})},function(e){t(e,i)})}else t(null,r.count);else t(new Error("Invalid type: 'query' should be Query type."))},t)}},{key:"insert",value:function(e,n){var t=this,a=f.get(this);return a.startTransaction(),(0,o.promisify)(function(n){if(Array.isArray(e)){for(var i=[],o=0;o<e.length;o++)e[o]&&"object"===r(e[o])&&i.push(t.insert(e[o]));e.length===i.length?Promise.all(i).then(function(){return n(null,e)}).catch(function(e){return n(e)}):n(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"===(void 0===e?"undefined":r(e)))if(e[t.pk]){var u=""+e[t.pk];a.getItem(u,function(r,i){r?n(r):i?n(new Error("Duplicated item: item already exists.")):(t._addItemToIndex(u,e),a.setItem(u,e,function(t){n(t,e)}))})}else n(new Error("Invalid key: item should have key."));else n(new Error("Invalid type: 'item' should be an object or an object array."))},n,function(){return a.endTransaction()})}},{key:"upsert",value:function(e,n){var t=this,a=f.get(this);return a.startTransaction(),(0,o.promisify)(function(n){if(Array.isArray(e)){for(var i=[],o=0;o<e.length;o++)e[o]&&"object"===r(e[o])&&i.push(t.upsert(e[o]));e.length===i.length?Promise.all(i).then(function(){return n(null,e)}).catch(function(e){return n(e)}):n(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"===(void 0===e?"undefined":r(e)))if(e[t.pk]){var u=""+e[t.pk];a.getItem(u,function(r,i){r?n(r):(i?t._updateItemToIndex(u,i,e):t._addItemToIndex(u,e),a.setItem(u,e,function(t){n(t,e)}))})}else n(new Error("Invalid key: item should have key."));else n(new Error("Invalid type: 'item' should be an object or an object array."))},n,function(){return a.endTransaction()})}},{key:"update",value:function(e,n){var t=this,a=f.get(this);return a.startTransaction(),(0,o.promisify)(function(n){if(Array.isArray(e)){for(var i=[],o=0;o<e.length;o++)e[o]&&"object"===r(e[o])&&i.push(t.update(e[o]));e.length===i.length?Promise.all(i).then(function(){return n(null,e)}).catch(function(e){return n(e)}):n(new Error("Invalid type: 'item' should hold objects if it's an array."))}else if(e&&"object"===(void 0===e?"undefined":r(e)))if(e[t.pk]){var u=""+e[t.pk];a.getItem(u,function(r,i){r?n(r):i?(t._updateItemToIndex(u,i,e),a.setItem(u,e,function(t){n(t,e)})):n(null)})}else n(new Error("Invalid key: item should have key."));else n(new Error("Invalid type: 'item' should be an object or an object array."))},n,function(){return a.endTransaction()})}},{key:"updateIf",value:function(n,t,r){var a=this,i=f.get(this);return i.startTransaction(),(0,o.promisify)(function(r){if(n instanceof s.default){var u=[],c=i.keys;(0,l.forAsync)({offset:0,condition:function(e){return e<c.length},progress:function(e){return e+1}},function(r,s){i.getItem(c[r],function(r,l){if(r)s(r);else if(l&&n.match(l)){var c=JSON.parse(JSON.stringify(l)),f=!1;for(var d in t){var h=t[d];(0,o.deepEqual)(l[d],h)||(f=!0,l[d]=h)}if(f){var v=""+l[a.pk];a._updateItemToIndex(v,c,l),i.setItem(v,l,function(n){n?s(n):(u.push(l),e(function(){return s(null,!0)}))})}else e(function(){return s(null,!0)})}else e(function(){return s(null,!0)})})},function(e){r(e,u)})}else r(new Error("Invalid type: 'query' should be Query type."))},r,function(){return i.endTransaction()})}},{key:"remove",value:function(e,n){var t=this,r=f.get(this);return r.startTransaction(),(0,o.promisify)(function(n){e?(e=""+e,r.getItem(e,function(a,i){a?n(a):i?(t._removeItemFromIndex(e,i),r.removeItem(e,function(e){n(e)})):n(null)})):n(new Error("Invalid type: 'id' should be string type."))},n,function(){return r.endTransaction()})}},{key:"removeIf",value:function(n,t){var r=this,a=f.get(this);return a.startTransaction(),(0,o.promisify)(function(t){if(n instanceof s.default){var i=[],o=a.keys;(0,l.forAsync)({offset:0,condition:function(e){return e<o.length},progress:function(e){return e+1}},function(t,u){a.getItem(o[t],function(t,o){if(t)u(t);else if(o&&n.match(o)){var s=""+o[r.pk];r._removeItemFromIndex(s,o),a.removeItem(s,function(n){n?u(n):(i.push(o),e(function(){return u(null,!0)}))})}else e(function(){return u(null,!0)})})},function(e){t(e,i)})}else t(new Error("Invalid type: 'query' should be Query type."))},t,function(){return a.endTransaction()})}},{key:"clear",value:function(e){var n=d.get(this),t=f.get(this);return t.startTransaction(),(0,o.promisify)(function(e){for(var r=0;r<n.length;r++)n[r].clear();t.clear(function(n){e(n)})},e,function(){return t.endTransaction()})}}]),n}();n.default=h}).call(this,t(11).setImmediate)},function(e,n,t){(function(e,n){!function(e,t){"use strict";if(!e.setImmediate){var r,a,i,o,u,s=1,l={},c=!1,f=e.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(e);d=d&&d.setTimeout?d:e,"[object process]"==={}.toString.call(e.process)?r=function(e){n.nextTick(function(){v(e)})}:!function(){if(e.postMessage&&!e.importScripts){var n=!0,t=e.onmessage;return e.onmessage=function(){n=!1},e.postMessage("","*"),e.onmessage=t,n}}()?e.MessageChannel?((i=new MessageChannel).port1.onmessage=function(e){v(e.data)},r=function(e){i.port2.postMessage(e)}):f&&"onreadystatechange"in f.createElement("script")?(a=f.documentElement,r=function(e){var n=f.createElement("script");n.onreadystatechange=function(){v(e),n.onreadystatechange=null,a.removeChild(n),n=null},a.appendChild(n)}):r=function(e){setTimeout(v,0,e)}:(o="setImmediate$"+Math.random()+"$",u=function(n){n.source===e&&"string"==typeof n.data&&0===n.data.indexOf(o)&&v(+n.data.slice(o.length))},e.addEventListener?e.addEventListener("message",u,!1):e.attachEvent("onmessage",u),r=function(n){e.postMessage(o+n,"*")}),d.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var n=new Array(arguments.length-1),t=0;t<n.length;t++)n[t]=arguments[t+1];var a={callback:e,args:n};return l[s]=a,r(s),s++},d.clearImmediate=h}function h(e){delete l[e]}function v(e){if(c)setTimeout(v,0,e);else{var n=l[e];if(n){c=!0;try{!function(e){var n=e.callback,r=e.args;switch(r.length){case 0:n();break;case 1:n(r[0]);break;case 2:n(r[0],r[1]);break;case 3:n(r[0],r[1],r[2]);break;default:n.apply(t,r)}}(n)}finally{h(e),c=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,t(12),t(24))},function(e,n){var t,r,a=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function u(e){if(t===setTimeout)return setTimeout(e,0);if((t===i||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:i}catch(e){t=i}try{r="function"==typeof clearTimeout?clearTimeout:o}catch(e){r=o}}();var s,l=[],c=!1,f=-1;function d(){c&&s&&(c=!1,s.length?l=s.concat(l):f=-1,l.length&&h())}function h(){if(!c){var e=u(d);c=!0;for(var n=l.length;n;){for(s=l,l=[];++f<n;)s&&s[f].run();f=-1,n=l.length}s=null,c=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===o||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(n){try{return r.call(null,e)}catch(n){return r.call(this,e)}}}(e)}}function v(e,n){this.fun=e,this.array=n}function y(){}a.nextTick=function(e){var n=new Array(arguments.length-1);if(arguments.length>1)for(var t=1;t<arguments.length;t++)n[t-1]=arguments[t];l.push(new v(e,n)),1!==l.length||c||u(h)},v.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=y,a.addListener=y,a.once=y,a.off=y,a.removeListener=y,a.removeAllListeners=y,a.emit=y,a.prependListener=y,a.prependOnceListener=y,a.listeners=function(e){return[]},a.binding=function(e){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw new Error("process.chdir is not supported")},a.umask=function(){return 0}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}();var a=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.blockKey=n,this.data=[]}return r(e,[{key:"get",value:function(e){var n=this.indexOf(e);return n>=0?this.data[n].value:null}},{key:"indexOf",value:function(e){for(var n in this.data)if(this.data[n].key===e)return parseInt(n);return-1}},{key:"add",value:function(e,n){var t=this.indexOf(e);t<0?this.data.push({key:e,value:n}):this.data[t]={key:e,value:n}}},{key:"remove",value:function(e){var n=this.indexOf(e);return n>=0&&(this.data.splice(n,1),!0)}},{key:"getSerializedData",value:function(){return JSON.stringify(this.data)}},{key:"count",get:function(){return this.data.length}}],[{key:"createKey",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e.toLowerCase()+"-blk-"+n}},{key:"buildFromSerializedData",value:function(n,t){var r=new e(n);try{return r.data=JSON.parse(t),r}catch(e){return null}}}]),e}();n.default=a},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=u(t(5)),i=u(t(6)),o=u(t(14));function u(e){return e&&e.__esModule?e:{default:e}}var s=function(){function e(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e);var r=i.default.getInstance();this.name=n,this.initialized=!1,this.queue={},this.batchInterval=t.batchInterval||r.batchInterval,this.batchUpdateTimer=null,this.transactionMutex=new o.default,this.transactionState=e.State.IDLE,this.transactionCount=0,this.encryption=r.encryption,t.encryption&&t.encryption.hasOwnProperty("encrypt")&&t.encryption.hasOwnProperty("decrypt")&&"function"==typeof t.encryption.encrypt&&"function"==typeof t.encryption.decrypt&&(this.encryption=t.encryption)}return r(e,[{key:"init",value:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};this.initialized?n(null):(this.initialized=!0,0===Object.keys(this.queue).length?a.default.Storage.getItem("adb-trns-"+this.name,function(t,r){r?e.encryption.decrypt(r,function(t,r){t||(e.queue=JSON.parse(r)),n(t)}):n(null)}):n(null))}},{key:"flush",value:function(){var n=this;this.transactionMutex.lock(function(t){a.default.Storage.setItem("adb-trns-"+n.name,JSON.stringify(n.queue),function(r){if(r)throw t(),r;var i=[],o=function(t){var r=n.queue[t];switch(r.action){case e.Action.SET:i.push(new Promise(function(e,i){n.encryption.encrypt(JSON.stringify(r.data),function(n,r){n?i(n):a.default.Storage.setItem(t,r).then(e).catch(i)})}));break;case e.Action.REMOVE:i.push(a.default.Storage.removeItem(t))}};for(var u in n.queue)o(u);n.batchUpdateTimer=null,Promise.all(i).then(function(){n.queue={},a.default.Storage.removeItem("adb-trns-"+n.name,function(){t()})}).catch(function(e){throw t(),e})})})}},{key:"startTransaction",value:function(){this.transactionState=e.State.RUNNING,this.transactionCount++}},{key:"endTransaction",value:function(){this.transactionState===e.State.RUNNING&&(this.transactionCount--,0===this.transactionCount&&(this.flush(),this.transactionState=e.State.IDLE))}},{key:"addJob",value:function(n,t,r){var a=this;this.queue[t]={action:n,data:r},this.transactionState===e.State.IDLE&&(this.batchUpdateTimer||(this.batchUpdateTimer=setTimeout(function(){a.transactionState===e.State.IDLE&&a.flush(),a.batchUpdateTimer=null},this.batchInterval)))}}],[{key:"Action",get:function(){return{SET:"set",REMOVE:"remove"}}},{key:"State",get:function(){return{IDLE:"idle",RUNNING:"running"}}}]),e}();n.default=s},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r,a=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),i=t(13),o=(r=i)&&r.__esModule?r:{default:r},u=t(15),s=t(7);var l=function(){function e(n){var t=n.collection,r=n.columns,a=void 0===r?{}:r,i=n.options,u=void 0===i?{}:i;for(var s in function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.collection=t,this.columns=a,this.key=e.createKey(this.columns),this.columns)this.columns[s]=1;this.store=new o.default(t.name+"-index-"+this.key,u),this.table=[]}return a(e,[{key:"columnValues",value:function(e){return this.columnNames.map(function(n){return e?e[n]:null})}},{key:"compareColumnValues",value:function(e,n){for(var t=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=this.columnNames,a=0;a<r.length;a++){var i=r[a],o=this.columns[i],u=(0,s.compare)(e[a],n[a],t);if(0!==u)return o*u}return 0}},{key:"init",value:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};this.store.init(function(t,r,a){t?n(t):a?e.save(n):e.store.getItem("idx-"+e.key,function(t,r){r&&(e.table=r),n(t)})})}},{key:"each",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:1)>0,a=r?0:this.table.length-1;if(t&&this.table.length>0){for(var i={start:0,end:this.table.length},o=a;i.start<i.end;){var s=this.compareColumnValues(this.table[o].key,t,r);if(0===s)break;s>0?i.end=o-1:i.start=o+1,o=parseInt((i.start+i.end)/2)}a=o}var l=!0;(0,u.forAsync)({offset:a,condition:function(e){return r?e<n.table.length:e>=0},progress:function(e){return r?e+1:e-1}},function(t,a){var i=n.table[t];if(i){var o=i.key,s=i.value;(0,u.forAsync)({offset:r?0:s.length-1,condition:function(e){return r?e<s.length:e>=0},progress:function(e){return r?e+1:e-1}},function(n,t){e({key:o,value:s[n]},function(e,n){t(e,l=e||n)})},function(e){return a(e,l)})}else a(null,!1)},function(){e(null,function(){})})}},{key:"put",value:function(e,n){var t=this,r=!1,a=this.columnValues(n);(0,u.forAsync)({offset:0,condition:function(e){return e<t.table.length},progress:function(e){return e+1}},function(n,i){var o=t.table[n];if(o){var u=t.compareColumnValues(o.key,a);u>0?(t.table.splice(n,0,{key:a,value:[e]}),r=!0,t.save(function(e){return i(e,!1)})):0===u?o.value.indexOf(e)<0?(o.value.push(e),r=!0,t.save(function(e){return i(e,!1)})):i(null,!1):i(null,!0)}else i(null,!1)},function(){r||(t.table.push({key:a,value:[e]}),t.save())})}},{key:"update",value:function(e,n,t){var r=this.columnValues(n),a=this.columnValues(t);0!==this.compareColumnValues(r,a)&&(this.remove(e,n),this.put(e,t))}},{key:"remove",value:function(e,n){var t=this,r=this.columnValues(n);(0,u.forAsync)({offset:0,condition:function(e){return e<t.table.length},progress:function(e){return e+1}},function(n,a){var i=t.table[n];if(i)if(0===t.compareColumnValues(i.key,r)){var o=i.value.indexOf(e);o>=0?(i.value.splice(o,1),0===i.value.length&&t.table.splice(n,1),t.save(function(e){return a(e,!1)})):a(null,!1)}else a(null,!0);else a(null,!1)},function(){})}},{key:"save",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};this.store.setItem("idx-"+this.key,this.table,e)}},{key:"clear",value:function(){this.table=[],this.store.clear()}},{key:"drop",value:function(){this.table=[],this.store.drop()}},{key:"columnNames",get:function(){return Object.keys(this.columns)}}],[{key:"createKey",value:function(e){return Object.keys(e).map(function(n){return n+"_"+e[n]}).join("__")}}]),e}();n.default=l},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r,a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),o=t(16),u=(r=o)&&r.__esModule?r:{default:r},s=t(8);var l=new WeakMap,c=function(){function e(n,t,r){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=t,this.keyPath=r,l.set(this,n)}return i(e,[{key:"findById",value:function(e,n){var t=this,r=l.get(this);return(0,s.promisify)(function(n){var a=r.transaction(t.name,"readonly").objectStore(t.name).get(e);a.onsuccess=function(){return n(null,a.result||null)},a.onerror=function(){return n(a.error)}},n)}},{key:"find",value:function(e,n){var t=this,r=l.get(this);return(0,s.promisify)(function(n){if(e instanceof u.default.Query){var a=(0,s.createIndexName)(e.index),i=[],o=r.transaction(t.name,"readonly").objectStore(t.name),l=a?o.index(a).openCursor(null,e.desc?"prev":"next"):o.openCursor(),c=e.offset;l.onsuccess=function(t){var r=t.target.result;if(r)if(!c||c<0){var a=r.value;e.match(a)?(i.push(a),i.length<e.limit?r.continue():n(null,i)):r.continue()}else c--,r.continue();else n(null,i)},l.onerror=function(){n(l.error)}}else n(new Error("Invalid type: 'query' should be LocalDB.Query type."))},n)}},{key:"count",value:function(e,n){var t=this,r=l.get(this);return(0,s.promisify)(function(n){if(!e||e instanceof u.default.Query){var a=r.transaction(t.name,"readonly").objectStore(t.name);if(e){var i=0,o=a.openCursor();o.onsuccess=function(){var t=event.target.result;t?(e.match(t.value)&&i++,t.continue()):n(null,i)},o.onerror=function(){n(o.error)}}else{var s=a.count();s.onsuccess=function(){return n(null,s.result)},s.onerror=function(){return n(s.error)}}}else n(new Error("Invalid type: 'query' should be LocalDB.Query type."))},n)}},{key:"insert",value:function(e,n){var t=this,r=l.get(this);return(0,s.promisify)(function(n){var i=r.transaction(t.name,"readwrite").objectStore(t.name);if(Array.isArray(e))!function(){var t=[],r=function(r){var a=e[r],o=i.add(a);o.onsuccess=function(){t.push(a),t.length===e.length&&n(null,t)},o.onerror=function(){n(o.error)}};for(var a in e)r(a)}();else if(e&&"object"===(void 0===e?"undefined":a(e))){var o=i.add(e);o.onsuccess=function(){return n(null,e)},o.onerror=function(){return n(o.error)}}else n(new Error("Invalid type: 'item' should be an object or an object array."))},n)}},{key:"upsert",value:function(e,n){var t=this,r=l.get(this);return(0,s.promisify)(function(n){var i=r.transaction(t.name,"readwrite").objectStore(t.name);if(e&&"object"===(void 0===e?"undefined":a(e))){var o=i.get(e[t.keyPath]);o.onsuccess=function(){if(o.result){var t=i.put(e);t.onsuccess=function(){return n(null,e)},t.onerror=function(){return n(t.error)}}else{var r=i.add(e);r.onsuccess=function(){return n(null,e)},r.onerror=function(){return n(r.error)}}},o.onerror=function(){n(o.error)}}else n(new Error("Invalid type: 'item' should be an object or an object array."))},n)}},{key:"update",value:function(e,n){var t=this,r=l.get(this);return(0,s.promisify)(function(n){var a=r.transaction(t.name,"readwrite").objectStore(t.name).put(e);a.onsuccess=function(){return n(null,e)},a.onerror=function(){return n(a.error)}},n)}},{key:"updateIf",value:function(e,n,t){var r=this,a=l.get(this);return(0,s.promisify)(function(t){if(e instanceof u.default.Query){var i=[],o=a.transaction(r.name,"readwrite").objectStore(r.name),l=o.openCursor();l.onsuccess=function(r){var a=r.target.result;if(a){var u=a.value;if(e.match(u)){var l=!1;for(var c in n){var f=n[c];(0,s.deepEqual)(u[c],f)||(l=!0,u[c]=f)}if(l){var d=o.put(u);d.onsuccess=function(){i.push(u),a.continue()},d.onerror=function(){t(d.error)}}else a.continue()}else a.continue()}else t(null,i)},l.onerror=function(){t(l.error)}}else t(new Error("Invalid type: 'query' should be LocalDB.Query type."))},t)}},{key:"remove",value:function(e,n){var t=this,r=l.get(this);return(0,s.promisify)(function(n){var a=r.transaction(t.name,"readwrite").objectStore(t.name).delete(e);a.onsuccess=function(){return n(null)},a.onerror=function(){return n(a.error)}},n)}},{key:"removeIf",value:function(e,n){var t=this,r=l.get(this);return(0,s.promisify)(function(n){if(e instanceof u.default.Query){var a=[],i=r.transaction(t.name,"readwrite").objectStore(t.name),o=i.openCursor();o.onsuccess=function(r){var o=r.target.result;if(o){var u=o.value;if(e.match(u)){var s=i.delete(u[t.keyPath]);s.onsuccess=function(){a.push(u),o.continue()},s.onerror=function(){n(s.error)}}else o.continue()}else n(null,a)},o.onerror=function(){n(o.error)}}else n(new Error("Invalid type: 'query' should be LocalDB.Query type."))},n)}},{key:"clear",value:function(e){var n=this,t=l.get(this);return(0,s.promisify)(function(e){var r=t.transaction(n.name,"readwrite").objectStore(n.name).clear();r.onsuccess=function(){return e(null)},r.onerror=function(){return e(r.error)}},e)}}]),e}();n.default=c},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=t(8);var o=1/0,u=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.condition=n,this.offset=0,this.limit=o,this.index=null,this.desc=!1}return r(e,null,[{key:"and",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];return t.length>0?new e({"/and":t}):new e({})}},{key:"or",value:function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];return t.length>0?new e({"/or":t}):new e({})}},{key:"Order",get:function(){return{ASC:1,DESC:-1}}}]),r(e,[{key:"match",value:function(e){return function e(n,t){var r=!0;for(var o in t){switch(o){case"/and":r=r&&t[o].reduce(function(t,r){return t&&e(n,r)},!0);break;case"/or":r=r&&t[o].reduce(function(t,r){return t||e(n,r)},!1);break;default:var u=t[o];if("object"===(void 0===u?"undefined":a(u)))for(var s in u)switch(s){case">":r="number"==typeof n[o]&&"number"==typeof u[s]?r&&n[o]>u[s]:"string"==typeof n[o]&&"string"==typeof u[s]&&r&&n[o].localeCompare(u[s])>0;break;case">=":r="number"==typeof n[o]&&"number"==typeof u[s]?r&&n[o]>=u[s]:"string"==typeof n[o]&&"string"==typeof u[s]&&r&&n[o].localeCompare(u[s])>=0;break;case"<":r="number"==typeof n[o]&&"number"==typeof u[s]?r&&n[o]<u[s]:"string"==typeof n[o]&&"string"==typeof u[s]&&r&&n[o].localeCompare(u[s])<0;break;case"<=":r="number"==typeof n[o]&&"number"==typeof u[s]?r&&n[o]<=u[s]:"string"==typeof n[o]&&"string"==typeof u[s]&&r&&n[o].localeCompare(u[s])<=0;break;case"=":r=r&&n[o]===u[s];break;case"!=":r=r&&n[o]!==u[s];break;case"/in":r=r&&Array.isArray(u[s])&&u[s].indexOf(n[o])>=0;break;case"/nin":r=r&&Array.isArray(u[s])&&u[s].indexOf(n[o])<0;break;case"/like":r=r&&"string"==typeof u[s]&&"string"==typeof n[o]&&n[o].indexOf(u[s])>=0;break;case"/regex":r=r&&u[s]instanceof RegExp&&u[s].test(n[o]);break;case"/where":r=r&&u[s](n[o]);break;default:r=r&&(0,i.deepEqual)(n[o],u)}else r=r&&n[o]===u}if(!r)break}return r}(e,this.condition)}}]),e}();n.default=u},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelContainer=void 0;var r=o(t(2)),a=o(t(1)),i=o(t(0));function o(e){return e&&e.__esModule?e:{default:e}}n.ChannelContainer=function(e,n){var t=this,o=e.collection("GroupChannel"),u=function(e,n){var t=r.default.getInstance();t.currentUserId?(e.ownerUserId=t.currentUserId,e.lastMessageUpdatedAt=e.lastMessage?e.lastMessage.createdAt:e.createdAt,i.default.cache("upsert channel","url="+e.url,"name="+e.name,"createdAt="+e.createdAt,"lastMessageUpdatedAt="+e.lastMessageUpdatedAt),o.upsert(e.serialize(),n)):n(a.default.create(a.default.Type.ERROR_SETUP_MISSING))},s=function(e){if(e){var t=n.GroupChannel.buildFromSerializedData(e);return t.lastMessageUpdatedAt=t.lastMessage?t.lastMessage.createdAt:t.createdAt,t}return null};return this.query=function(e,n,t){var i=r.default.getInstance();if(i.currentUserId){e.ownerUserId=i.currentUserId;var u=new r.default.LocalDB.Query(e);n&&(u.offset=n.offset||0,u.limit=n.limit||20,u.index=n.index,u.desc=n.desc),o.find(u,function(e,n){if(e)t(e);else{for(var r=[],a=0;a<n.length;a++){var i=s(n[a]);r.push(i)}t(null,r)}})}else t(a.default.create(a.default.Type.ERROR_SETUP_MISSING))},this.insert=function(e,n){t.getItem(e.url,function(t,r){t?n(t):r?n(null,e):u(e,function(t){t?n(t):n(null,e)})})},this.upsert=function(e,n){u(e,function(e,t){e?n(e):n(null,s(t))})},this.remove=function(n,t){!function(n,t){var u=r.default.getInstance();u.currentUserId?(i.default.cache("remove channel",n.url),o.remove(n.url,function(a,i){if(a)t(a);else{var o=new r.default.LocalDB.Query({ownerUserId:u.currentUserId,channelUrl:n.url});e.collection("MessageChunk").removeIf(o,function(n){n?t(n):e.collection("Message").removeIf(o,function(e){e?t(e):t(null,i)})})}})):t(a.default.create(a.default.Type.ERROR_SETUP_MISSING))}(n,function(e,n){e?t(e):t(null,s(n))})},this.getItem=function(e,n){o.findById(e,function(e,t){e?n(e):n(null,s(t))})},this.clear=function(n){return function(n){i.default.cache("clear channel"),o.clear(function(t){t?n(t):e.collection("MessageChunk").clear(function(t){t?n(t):e.collection("Message").clear(n)})})}(n)},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelListQueryContainer=void 0;var r=o(t(2)),a=o(t(1)),i=o(t(0));function o(e){return e&&e.__esModule?e:{default:e}}var u={};n.ChannelListQueryContainer=function(e,n){var t=this,o=e.collection("GroupChannelListQuery"),s=function(e){if(e){var t=n.GroupChannelListQuery.buildFromSerializedData(e);return t.filterKey=e.filterKey,t.ownerUserId=e.currentUserId,t.updatedAt=e.updatedAt,t.savepoint=e.savepoint,t}return null};return this.createFilterKey=function(e){var n=[];return n.push("order="+e.order),n.push("includeEmpty="+e.includeEmpty),n.push("customTypesFilter="+e.customTypesFilter.sort().join(",")),n.join("&")},this.upsert=function(e,n){!function(e,n){e.filterKey=t.createFilterKey(e);var l=r.default.getInstance();if(l.currentUserId){i.default.cache("upsert channel list query",e.filterKey),e.ownerUserId=l.currentUserId,e.updatedAt=(new Date).getTime(),e.savepoint||(e.savepoint="");var c=e.serialize();o.upsert(c,function(t,r){if(t)n(t);else{if(u[e.filterKey])for(var a in e)u[e.filterKey].hasOwnProperty(a)&&(u[e.filterKey][a]=e[a]);else u[e.filterKey]=e;n(null,s(r))}})}else n(a.default.create(a.default.Type.ERROR_SETUP_MISSING))}(e,function(e,t){e?n(e):n(null,s(t))})},this.remove=function(e,n){!function(e,n){r.default.getInstance().currentUserId?(i.default.cache("remove channel list query",e.filterKey),o.remove(e.filterKey,function(t,r){t?n(t):(u[e.filterKey]&&delete u[e.filterKey],n(null,r))})):n(a.default.create(a.default.Type.ERROR_SETUP_MISSING))}(e,function(e,t){e?n(e):n(null,s(t))})},this.getItem=function(e,n){u[e]?n(null,u[e]):o.findById(e,function(e,t){e?n(e):n(null,s(t))})},this.clear=function(e){return function(e){i.default.cache("clear channel list query"),u={},o.clear(function(n){return e(n)})}(e)},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelBroadcast=void 0;var r,a=t(3),i=(r=a)&&r.__esModule?r:{default:r};function o(e,n){var t=i.default.getInstance().sb,r=!0;if(e.isGroupChannel()&&!e.isSuper){if(!n.includeEmpty&&!e.lastMessage)return!1;if(n.nicknameContainsFilter){var a=!1;for(var o in e.members)if(e.members[o].nickname.indexOf(n.nicknameContainsFilter)>=0){a=!0;break}if(!a)return!1}if(n.userIdsFilter.length>0){var u=!1,s=e.members.map(function(e){return e.userId}),l=n.userIdsFilterExactMatch,c=n.queryType;if(l?u=s.length===n.userIdsFilter.length&&n.userIdsFilter.every(function(e){return s.indexOf(e)>=0}):"AND"===c?u=n.userIdsFilter.every(function(e){return s.indexOf(e)>=0}):"OR"===c&&(u=n.userIdsFilter.reduce(function(e,n){return e||s.indexOf(n)>=0},!1)),!u)return!1}}if(n.channelNameContainsFilter&&(r=r&&e.name.indexOf(n.channelNameContainsFilter)>=0),n.channelUrlsFilter.length>0&&(r=r&&n.channelUrlsFilter.indexOf(e.url)>=0),n.memberStateFilter!==t.GroupChannel.memberStateFilter.ALL)switch(n.memberStateFilter){case t.GroupChannel.memberStateFilter.JOINED:r=r&&e.myMemberState===t.GroupChannel.memberStateFilter.JOINED;break;case t.GroupChannel.memberStateFilter.INVITED:case t.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case t.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:r=r&&e.myMemberState===t.GroupChannel.memberStateFilter.INVITED}if(n.customTypesFilter.length>0&&(r=r&&n.customTypesFilter.indexOf(e.customType)>=0),n.customTypeStartsWithFilter&&(r=r&&e.customType.startsWith(n.customTypeStartsWithFilter)),n.superChannelFilter!==t.GroupChannel.superChannelFilter.ALL)switch(n.superChannelFilter){case t.GroupChannel.superChannelFilter.SUPER:r=r&&e.isSuper;break;case t.GroupChannel.superChannelFilter.NONSUPER:r=r&&!e.isSuper}if(n.publicChannelFilter!==t.GroupChannel.publicChannelFilter.ALL)switch(n.publicChannelFilter){case t.GroupChannel.publicChannelFilter.PUBLIC:r=r&&e.isPublic;break;case t.GroupChannel.publicChannelFilter.PRIVATE:r=r&&!e.isPublic}if(n.unreadChannelFilter!=t.GroupChannel.UnreadChannelFilter.ALL)switch(n.unreadChannelFilter){case t.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:r=r&&e.unreadMessageCount>0}return r}n.ChannelBroadcast=function(){var e=[];return this.addCollection=function(n,t){e.indexOf(n)<0&&e.push({controller:n,view:t})},this.removeCollection=function(n){var t=e.map(function(e){return e.controller}).indexOf(n);t>=0&&(e[t].controller._pause(),e.splice(t,1))},this.clearCollection=function(){for(var n in e)e[n].controller._pause();e=[]},this.pause=function(){for(var n in e)e[n].controller._pause()},this.resume=function(){for(var n in e)e[n].controller._resume()},this.upsert=function(n,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};for(var a in e){var i=e[a];if(i.controller!==t){var u=[];for(var s in n){var l=n[s];o(l,i.controller.query)&&u.push(l)}u.length>0&&(r.isEventChannel=!0,i.view.addViewItems(u,r))}}},this.update=function(n,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};for(var a in e){var i=e[a];if(i.controller!==t){var u=[];for(var s in n){var l=n[s];o(l,i.controller.query)&&i.view.channels.map(function(e){return e.url}).indexOf(l.url)>=0&&u.push(l)}u.length>0&&(r.isEventChannel=!0,i.view.addViewItems(u,r))}}},this.remove=function(n,t){for(var r in e){var a=e[r];if(a.controller!==t){var i=[];for(var o in n){var u=n[o];a.view.channels.map(function(e){return e.url}).indexOf(u.url)>=0&&i.push(u)}i.length>0&&a.view.removeViewItems(i)}}},this.hide=function(n,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=i.default.getInstance().sb;for(var u in e){var s=e[u];if(s.controller!==t){var l=[];for(var c in n){var f=n[c];o(f,s.controller.query)&&l.push(f)}if(l.length>0)switch(s.controller.query.hiddenChannelFilter){case a.GroupChannel.HiddenChannelFilter.UNHIDDEN:s.view.removeViewItems(l);break;case a.GroupChannel.HiddenChannelFilter.HIDDEN:case a.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case a.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:r.isEventChannel=!0,s.view.addViewItems(l,r)}}}},this.unhide=function(n,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=i.default.getInstance().sb;for(var u in e){var s=e[u];if(s.controller!==t){var l=[];for(var c in n){var f=n[c];o(f,s.controller.query)&&l.push(f)}if(l.length>0)switch(s.controller.query.hiddenChannelFilter){case a.GroupChannel.HiddenChannelFilter.UNHIDDEN:r.isEventChannel=!0,s.view.addViewItems(l,r);break;case a.GroupChannel.HiddenChannelFilter.HIDDEN:case a.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:case a.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:s.view.removeViewItems(l)}}}},this.clear=function(){for(var n in e){e[n].view.clearViewItem()}},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.MessageContainer=void 0;var r=o(t(2)),a=o(t(1)),i=o(t(0));function o(e){return e&&e.__esModule?e:{default:e}}n.MessageContainer=function(e,n){var t=this,o=e.collection("Message"),u=function(e,n){var t=r.default.getInstance();e.messageId?t.currentUserId?(e.hasOwnProperty("isVisible")||(e.isVisible=!0),e.hasOwnProperty("isDeleted")||(e.isDeleted=!1),e.ownerUserId=t.currentUserId,i.default.cache("upsert message",e.messageId,e.createdAt,"owner="+e.ownerUserId,"visible="+e.isVisible,"deleted="+e.isDeleted),o.findById(e.messageId,function(t,r){t?n(t):r?r.isDeleted?resolve(r):(e.isVisible=e.isVisible||r.isVisible,o.upsert(e.serialize(),function(e,t){e?n(e):n(null,t)})):o.upsert(e.serialize(),function(e,t){e?n(e):n(null,t)})})):n(a.default.create(a.default.Type.ERROR_SETUP_MISSING)):n(null,e)},s=function(e){var t=null;return e&&("user"===e.messageType?t=n.UserMessage.buildFromSerializedData(e):"file"===e.messageType?t=n.FileMessage.buildFromSerializedData(e):"admin"===e.messageType&&(t=n.AdminMessage.buildFromSerializedData(e))),t};return this.query=function(e,n,t){e.isVisible=!0,e.isDeleted=!1;var i=r.default.getInstance();if(i.currentUserId){e.ownerUserId=i.currentUserId;var u=new r.default.LocalDB.Query(e);n&&(u.offset=n.offset||0,u.limit=n.limit||50,u.desc=n.desc),u.index={ownerUserId:r.default.LocalDB.Query.Order.ASC,channelUrl:r.default.LocalDB.Query.Order.ASC,createdAt:r.default.LocalDB.Query.Order.DESC},o.find(u,function(e,n){if(e)t(e);else{for(var r=[],a=0;a<n.length;a++){var i=s(n[a]);r.push(i)}t(null,r)}})}else t(a.default.create(a.default.Type.ERROR_SETUP_MISSING))},this.upsert=function(e,n){u(e,function(e,t){e?n(e):n(null,s(t))})},this.remove=function(e,n){t.getItem(e,function(t,a){var i=r.default.getInstance().sendBird,o={serialize:function(){return{messageId:e,ownerUserId:a?a.ownerUserId:i.currentUser.userId,channelUrl:a?a.channelUrl:"",createdAt:a?a.createdAt:0,isVisible:!1,isDeleted:!0}}};u(o,function(t){t?n(t):n(null,e)})})},this.getItemWithVisibility=function(e,n){o.findById(e,function(e,t){e?n(e):n(null,{item:s(t),isVisible:!!t&&t.isVisible})})},this.getItem=function(e,n){o.findById(e,function(e,t){e?n(e):n(null,s(t))})},this.clear=function(e){return function(e){i.default.cache("clear messages"),o.clear(function(n){return e(n)})}(e)},this.loadPreviousMessages=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(new Date).getTime(),a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=arguments[4],o={channelUrl:e,createdAt:{"<=":r}};n.messageType&&(o.messageType=n.messageType),n.customType&&(o.customType=n.customType),n.senderUserIds&&n.senderUserIds.length>0&&(o["sender.userId"]={"/in":n.senderUserIds}),a.desc=!0,t.query(o,a,i)},this.loadNextMessages=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=arguments[4],o={channelUrl:e,createdAt:{">=":r}};n.messageType&&(o.messageType=n.messageType),n.customType&&(o.customType=n.customType),n.senderUserIds&&n.senderUserIds.length>0&&(o["sender.userId"]={"/in":n.senderUserIds}),a.desc=!1,t.query(o,a,i)},this}},function(e,n,t){"use strict";function r(e,n,t){return t?n.channelUrl===e.url&&((!t.messageType||t.messageType===n.messageType)&&((!t.customType||t.customType===n.customType)&&!(Array.isArray(t.senderUserIds)&&t.senderUserIds.length>0&&n.sender&&t.senderUserIds.indexOf(n.sender.userId)<0))):n.channelUrl===e.url}Object.defineProperty(n,"__esModule",{value:!0});n.MessageBroadcast=function(){var e=[];return this.addCollection=function(n,t){e.push({controller:n,view:t})},this.removeCollection=function(n){var t=e.map(function(e){return e.controller}).indexOf(n);t>=0&&(e[t].controller._pause(),e.splice(t,1))},this.clearCollection=function(){for(var n in e)e[n].controller._pause();e=[]},this.pause=function(){for(var n in e)e[n].controller._pause()},this.resume=function(){for(var n in e)e[n].controller._resume()},this.upsert=function(n,t){for(var a in e){var i=e[a];if(i.controller!==t){var o=[];for(var u in n){var s=n[u];r(i.controller.channel,s,i.controller.filter)&&o.push(s)}o.length>0&&i.view.addViewItems(o,{isEventMessage:!0})}}},this.update=function(n,t){for(var a in e){var i=e[a];if(i.controller!==t){var o=[];for(var u in n){var s=n[u];r(i.controller.channel,s,i.controller.filter)&&i.view.messages.map(function(e){return e.messageId}).indexOf(s.messageId)>=0&&o.push(s)}o.length>0&&i.view.addViewItems(o,{isEventMessage:!0})}}},this.read=function(n,t){for(var r in e){var a=e[r];a.controller!==t&&a.controller.channel.url===n.url&&(a.controller.channel=n,a.view.addViewItems(a.view.messages))}},this.remove=function(n,t){for(var r in e){var a=e[r];a.controller!==t&&a.view.removeViewItems(n)}},this.clear=function(){for(var n in e){e[n].view.clearViewItem()}},this}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ChannelCollection=n.ChannelCollectionViewAdapter=void 0;var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=d(t(19)),i=d(t(3)),o=t(20),u=t(21),s=t(4),l=d(t(1)),c=d(t(0)),f=d(t(2));function d(e){return e&&e.__esModule?e:{default:e}}function h(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var v=new WeakMap,y=new WeakMap,p=new WeakMap,g=new WeakMap,m=new WeakMap,b=function(e){var n=i.default.getInstance();if(n){var t=e.query,r=t.filterKey;return n.channelSyncByFilter[r]||(n.channelSyncByFilter[r]=new o.BackgroundSync(function(r,a){c.default.call("channel syncChannel()",t.filterKey,t.hasNext,t._token),t.hasNext?(t.limit=100,t.next(function(r,i){c.default.sync("channel",i,r&&r.length>0?"\n"+r.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n"):""),i?a(i):function(){for(var i=y.get(e),o=0,u=null,s=0;s<r.length;s++)n.channelContainer.insert(r[s],function(e){if(u=u||e,++o===r.length)if(u)a(u);else{var s=i.findChannelEdges(r);s.end&&(t.savepoint=s.end+""),n.queryContainer.upsert(t,function(e){e?a(e):a(null,{count:r.length,nextTs:0,hasNext:t.hasNext})})}})}()})):a(null,{count:0,nextTs:0,hasNext:!1})})),n.channelSyncByFilter[r]}return null},k=function(e){var n=i.default.getInstance();if(n){if(!n.changeLogSync){var t=e.query;n.changeLogSync=new o.BackgroundSync(function(e,r){n.syncChangeLog(t,function(e){r(e,{count:0,nextTs:0,hasNext:!1})})})}return n.changeLogSync}return null},C=n.ChannelCollectionViewAdapter=function(){function e(){h(this,e),this.collection=null,this.channels=[],this.mutex=new a.default,this.viewOffset=null}return r(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"compareWithChannel",value:function(e,n){var t="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":t="createdAt";break;case"channel_name_alphabetical":t="name"}return this.compareWithOffset(e,n[t])}},{key:"compareWithOffset",value:function(e,n){switch(this.collection.query.order){case"latest_last_message":return e.lastMessageUpdatedAt-n;case"chronological":return e.createdAt-n;case"channel_name_alphabetical":return n.localeCompare(e.name);default:return e.lastMessageUpdatedAt-n}}},{key:"isAbove",value:function(e,n){return this.compareWithOffset(e,n)>0}},{key:"isBelow",value:function(e,n){return this.compareWithOffset(e,n)<0}},{key:"findChannelEdges",value:function(e){var n="lastMessageUpdatedAt";switch(this.collection.query.order){case"chronological":n="createdAt";break;case"channel_name_alphabetical":n="name"}var t={start:null,end:null};for(var r in e)t.start&&!this.isAbove(e[r],t.start)||(t.start=e[r][n]),t.end&&!this.isBelow(e[r],t.end)||(t.end=e[r][n]);return t}},{key:"refreshViewOffset",value:function(){var e=this.findChannelEdges(this.channels);this.viewOffset=e.end}},{key:"addViewItems",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=[],a=[],i=[],o=[],l=m.get(this.collection);this.mutex.lock(function(f){for(var d in e){var h=e[d],v=(0,s.getChannelIndex)(h,n.channels),y=(0,s.findChannelIndex)(h,n.collection.query,n.channels),p=!1;t.isEventChannel&&(n.viewOffset?n.isBelow(h,n.viewOffset)&&(p=!0):t.isChangeLogEvent||(n.collection.query.hasNext||n.collection.query.savepoint)&&(p=!0));var g=v<0?u.ChannelEventAction.INSERT:u.ChannelEventAction.UPDATE;switch(v<0?p||(y<n.channels.length?n.channels.splice(y,0,h):n.channels.push(h)):v!==y?y<n.channels.length?(g=u.ChannelEventAction.MOVE,n.channels.splice(v,1),y>v?n.channels.splice(y-1,0,h):n.channels.splice(y,0,h)):(g=u.ChannelEventAction.REMOVE,n.channels.splice(v,1)):n.channels[v]=h,g){case u.ChannelEventAction.INSERT:p||r.push(h);break;case u.ChannelEventAction.UPDATE:a.push(h);break;case u.ChannelEventAction.MOVE:i.push(h);break;case u.ChannelEventAction.REMOVE:o.push(h)}}if(n.refreshViewOffset(),r.length>0)for(var m in c.default.view("channel",u.ChannelEventAction.INSERT,"\n"+r.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n")),l)l[m].onChannelEvent(u.ChannelEventAction.INSERT,r);if(a.length>0)for(var b in c.default.view("channel",u.ChannelEventAction.UPDATE,"\n"+a.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n")),l)l[b].onChannelEvent(u.ChannelEventAction.UPDATE,a);if(i.length>0)for(var k in c.default.view("channel",u.ChannelEventAction.MOVE,"\n"+i.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n")),l)l[k].onChannelEvent(u.ChannelEventAction.MOVE,i);if(o.length>0)for(var C in c.default.view("channel",u.ChannelEventAction.REMOVE,"\n"+o.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n")),l)l[C].onChannelEvent(u.ChannelEventAction.REMOVE,o);f()})}},{key:"removeViewItems",value:function(e){var n=this,t=m.get(this.collection);this.mutex.lock(function(r){var a=[];for(var i in e){var o=e[i],s=n.channels.map(function(e){return e.url}).indexOf(o.url);s>=0&&(n.channels.splice(s,1),a.push(o))}if(a.length>0)for(var l in c.default.view("channel",u.ChannelEventAction.REMOVE,"\n"+a.map(function(e){return"\turl="+e.url+" name="+e.name+" createdAt="+e.createdAt+" lastMessageUpdatedAt="+e.lastMessageUpdatedAt}).join("\n")),t)t[l].onChannelEvent(u.ChannelEventAction.REMOVE,a);r()})}},{key:"clearViewItem",value:function(){this.channels=[];var e=m.get(this.collection);this.mutex.lock(function(n){var t=u.ChannelEventAction.CLEAR;for(var r in c.default.view("channel",t),e)e[r].onChannelEvent(t);n()})}}]),e}();n.ChannelCollection=function(){function e(n){var t=this;h(this,e);var r=new C,a=i.default.getInstance();if(!a)return null;this.collectionId=(0,s.createUUID)(),this.sendBird=a.sb,this.type="MyGroupChannelListQuery",this.limit=n.limit,this.query=n,this.query.filterKey=a.queryContainer.createFilterKey(this.query),this._isLoading=!1,r.attachCollection(this),a.broadcast.addCollection(this,r),y.set(this,r),v.set(this,a.broadcast),p.set(this,a.channelContainer),g.set(this,a.queryContainer),m.set(this,{}),b(this).shared++,k(this).shared++,a.queryContainer.getItem(this.query.filterKey,function(e,r){e?l.default.throw(e):(r&&(t.query._token=r._token,t.query.hasNext=r.hasNext,t.query.savepoint=r.savepoint,t.query.updatedAt=r.updatedAt),a.queryContainer.upsert(n,function(e,n){e?l.default.throw(e):(t.query=n,t._resume(),c.default.message("channel collection "+t.collectionId+" is created."))}))})}return r(e,[{key:"_pause",value:function(){c.default.call("channel sync pause",this.collectionId);var e=b(this),n=k(this);e&&e.pause(),n&&n.pause()}},{key:"_resume",value:function(){c.default.call("channel sync resume",this.collectionId);var e=b(this),n=k(this);e&&e.start(),n&&n.start()}},{key:"fetch",value:function(e){var n=this;if(!this._isLoading)return this._isLoading=!0,(0,s.promisify)(function(e){c.default.call("fetch()");var t=y.get(n),r=p.get(n),a=n.sendBird,i={ownerUserId:f.default.getInstance().currentUserId};if(n.query.includeEmpty||(i.lastMessage={"!=":null}),n.query.nicknameContainsFilter&&(i.members={"/where":function(e){for(var t in e)if(e[t].nickname.indexOf(n.query.nicknameContainsFilter)>=0)return!0;return!1}}),n.query.userIdsFilter.length>0&&(i.members={"/where":function(e){var t=e.map(function(e){return e.userId});return n.query.userIdsFilterExactMatch?t.length===n.query.userIdsFilter.length&&n.query.userIdsFilter.every(function(e){return t.indexOf(e)>=0}):"AND"===n.query.queryType?n.query.userIdsFilter.every(function(e){return t.indexOf(e)>=0}):"OR"===n.query.queryType&&n.query.userIdsFilter.reduce(function(e,n){return e||t.indexOf(n)>=0},!1)}}),n.query.channelNameContainsFilter&&(i.name={"/regex":new RegExp(n.query.channelNameContainsFilter)}),n.query.channelUrlsFilter.length>0&&(i.url={"/in":n.query.channelUrlsFilter}),n.query.memberStateFilter!==a.GroupChannel.memberStateFilter.ALL)switch(n.query.memberStateFilter){case a.GroupChannel.memberStateFilter.JOINED:i.myMemberState=a.GroupChannel.memberStateFilter.JOINED;break;case a.GroupChannel.memberStateFilter.INVITED:case a.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case a.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:i.myMemberState={"/in":[a.GroupChannel.memberStateFilter.INVITED,a.GroupChannel.memberStateFilter.INVITED_BY_FRIEND,a.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND]}}if("string"==typeof n.query.customTypeFilter&&n.query.customTypeFilter&&(i.customType=n.query.customTypeFilter),Array.isArray(n.query.customTypesFilter)&&n.query.customTypesFilter.length>0&&(i.customType={"/in":n.query.customTypesFilter}),"string"==typeof n.query.customTypeStartsWithFilter&&n.query.customTypeStartsWithFilter&&(i.customType={"/regex":new RegExp("^"+n.query.customTypeStartsWithFilter)}),n.query.superChannelFilter!==a.GroupChannel.superChannelFilter.ALL)switch(n.query.superChannelFilter){case a.GroupChannel.superChannelFilter.SUPER:i.isSuper=!0;break;case a.GroupChannel.superChannelFilter.NONSUPER:i.isSuper=!1}if(n.query.publicChannelFilter!==a.GroupChannel.publicChannelFilter.ALL)switch(n.query.publicChannelFilter){case a.GroupChannel.publicChannelFilter.PUBLIC:i.isPublic=!0;break;case a.GroupChannel.publicChannelFilter.PRIVATE:i.isPublic=!1}if(n.query.unreadChannelFilter!==a.GroupChannel.UnreadChannelFilter.ALL)switch(n.query.unreadChannelFilter){case a.GroupChannel.UnreadChannelFilter.UNREAD_MESSAGE:i.unreadMessageCount={">":0}}if("all"!=n.query.hiddenChannelFilter)switch(n.query.hiddenChannelFilter){case a.GroupChannel.HiddenChannelFilter.UNHIDDEN:i.hiddenState=a.GroupChannel.HiddenState.UNHIDDEN;break;case a.GroupChannel.HiddenChannelFilter.HIDDEN:i.hiddenState={"/in":[a.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE,a.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE]};break;case a.GroupChannel.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:i.hiddenState=a.GroupChannel.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE;break;case a.GroupChannel.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:i.hiddenState=a.GroupChannel.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE}var u=null,s=!0;switch(n.query.order){case"latest_last_message":!n.query.hasNext&&n.query.savepoint&&(i.lastMessageUpdatedAt={">=":parseInt(n.query.savepoint)}),u={ownerUserId:1,lastMessageUpdatedAt:-1};break;case"chronological":!n.query.hasNext&&n.query.savepoint&&(i.createdAt={">=":parseInt(n.query.savepoint)}),u={ownerUserId:1,createdAt:-1};break;case"channel_name_alphabetical":!n.query.hasNext&&n.query.savepoint&&(i.name={"<=":n.query.savepoint}),u={ownerUserId:1,name:1},s=!1;break;default:!n.query.hasNext&&n.query.savepoint&&(i.lastMessageUpdatedAt={">=":parseInt(n.query.savepoint)}),u={ownerUserId:1,lastMessageUpdatedAt:-1}}var l=b(n),d=function(e,a){r.query(i,{offset:t.channels.length,limit:e,index:u,desc:s},function(r,i){r?(n._isLoading=!1,a(r)):(n._isLoading=!1,i.sort(function(e,n){return t.compareWithChannel(e,n)>0}),i.length>0&&t.addViewItems(i),i.length<e&&h(e-i.length),a(null,i))})},h=function(e){l.state!==o.BackgroundSync.State.END&&(c.default.sync("subscribe channel",n.collectionId),l.subscribe(n.collectionId,function(n){n?c.default.error(n):(c.default.sync("flush channel"),d(e,function(e){e&&c.default.error(e)}))}))};d(n.limit,function(n,t){c.default.cache("fetch channel",n,t.map(function(e){return e.url})),e(n)}),l.state===o.BackgroundSync.State.PAUSED&&n._resume()},e);c.default.error("fetch() is loading"),e(l.default.create(l.default.Type.ERROR_DUPLICATED_FETCH))}},{key:"remove",value:function(){v.get(this).removeCollection(this);var e=b(this),n=k(this);e&&(e.shared--,0===e.shared&&e.pause()),n&&(n.shared--,0===n.shared&&n.pause())}},{key:"setCollectionHandler",value:function(e){var n=m.get(this);e instanceof u.ChannelCollectionHandler&&(n["channel-collection-handler"]=e)}},{key:"removeCollectionHandler",value:function(){var e=m.get(this);e["channel-collection-handler"]&&delete e["channel-collection-handler"]}},{key:"channels",get:function(){return y.get(this).channels}}],[{key:"CollectionHandler",get:function(){return u.ChannelCollectionHandler}},{key:"Action",get:function(){return u.ChannelEventAction}}]),e}()},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.MessageCollection=n.MessageCollectionViewAdapter=void 0;var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),a=v(t(2)),i=v(t(3)),o=v(t(17)),u=t(20),s=t(18),l=t(21),c=v(t(19)),f=v(t(1)),d=v(t(0)),h=t(4);function v(e){return e&&e.__esModule?e:{default:e}}function y(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)}function p(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var g=new WeakMap,m=new WeakMap,b=new WeakMap,k=new WeakMap,C=new WeakMap,I=new WeakMap,w=new WeakMap,E=new WeakMap,A=300,M=50,S=100,_=100,T=50,O=n.MessageCollectionViewAdapter=function(){function e(){p(this,e),this.collection=null,this.messages=[],this.prevTempMessages=[],this.nextTempMessages=[],g.set(this,{}),this.currentChunk=null,this.viewRange={start:0,end:0}}return r(e,[{key:"attachCollection",value:function(e){this.collection=e}},{key:"addViewItems",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=E.get(this.collection),r=g.get(this),a=w.get(this.collection),i=[],o=[],s=[];for(var c in e){var f=e[c],v=!0;if(n.isEventMessage){var y=a.state===u.BackgroundSync.State.END,p=!this.currentChunk||this.currentChunk.endAt<=this.viewRange.end,m=0===this.viewRange.end;v=y&&p||!this.currentChunk||m}var b=this.collection.sendBird.currentUser?this.collection.channel.getReadReceipt(f):r[f.messageId]||0;if(r[f.messageId]||(r[f.messageId]=b),v){var k=(0,h.getMessageIndex)(f,this.messages),C=(0,h.findMessageIndex)(f,this.messages);if(k>=0&&this.messages[k].isEqual(f)&&r[f.messageId]===b)continue;r[f.messageId]=b,f.messageId&&(this.viewRange.start=this.viewRange.start>0?Math.min(this.viewRange.start,f.createdAt):f.createdAt,this.viewRange.end=this.viewRange.end>0?Math.max(this.viewRange.end,f.createdAt):f.createdAt);var I=null;if(k<0)I=l.MessageEventAction.INSERT,this.messages.splice(C,0,f),this.nextTempMessages.push(f);else if(f.messageId){var A=this.messages[k];if(A.messageId)this.messages[k]=f,I=l.MessageEventAction.UPDATE;else{this.messages.splice(k,1),s.push(A);var M=k<C?1:0;this.messages.splice(C-M,0,f),I=l.MessageEventAction.INSERT}}switch(I){case l.MessageEventAction.INSERT:i.push(f);break;case l.MessageEventAction.UPDATE:o.push(f)}}}if(s.length>0)for(var S in d.default.view("message",l.MessageEventAction.REMOVE,s.map(function(e){return e.messageId+" "+e.createdAt})),t)t[S].onMessageEvent(l.MessageEventAction.REMOVE,s);if(i.length>0)for(var _ in d.default.view("message",l.MessageEventAction.INSERT,i.map(function(e){return e.messageId+" "+e.createdAt})),t)t[_].onMessageEvent(l.MessageEventAction.INSERT,i);if(o.length>0)for(var T in d.default.view("message",l.MessageEventAction.UPDATE,o.map(function(e){return e.messageId+" "+e.createdAt})),t)t[T].onMessageEvent(l.MessageEventAction.UPDATE,o)}},{key:"removeViewItems",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=E.get(this.collection),r=g.get(this),a=[];for(var i in e){var o=e[i];for(var u in this.messages)if(o===this.messages[u].messageId||n&&o===this.messages[u].reqId){"number"==typeof r[o]&&delete r[o];var s=this.messages.splice(u,1);a.push.apply(a,y(s));break}}if(this.viewRange.start=this.messages.length>0?this.messages[0].createdAt:0,this.viewRange.end=this.messages.length>0?this.messages[this.messages.length-1].createdAt:0,a.length>0)for(var c in d.default.view("message",l.MessageEventAction.REMOVE,a.map(function(e){return e.messageId})),t)t[c].onMessageEvent(l.MessageEventAction.REMOVE,a)}},{key:"clearPreviewItem",value:function(){var e=E.get(this.collection),n=[];for(var t in this.messages)0===this.messages[t].messageId&&n.push({index:parseInt(t),item:this.messages[t]});for(var r=n.length-1;r>=0;r--){var a=n[r];this.messages.splice(a.index,1)}for(var i in d.default.view("message",l.MessageEventAction.REMOVE,"preview message"),e)e[i].onMessageEvent(l.MessageEventAction.REMOVE,n.map(function(e){return e.item}))}},{key:"clearViewItem",value:function(){this.currentChunk=null,this.messages=[],g.set(this,{}),this.viewRange.start=0,this.viewRange.end=0;var e=E.get(this.collection),n=l.MessageEventAction.CLEAR;for(var t in d.default.view("message",n),e)e[t].onMessageEvent(n)}}]),e}();n.MessageCollection=function(){function e(n,t){var r=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(new Date).getTime();p(this,e);var i=o.default.getInstance();if(!i)return null;if(this.collectionId=(0,h.createUUID)(),this.sendBird=i.sb,this.channel=n,this.limit=T,this.filter=s.MessageChunk.getDefaultFilter(),t&&Object.keys(t).length>0)for(var l in t)this.filter.hasOwnProperty(l)&&(this.filter[l]=t[l]);this.viewpoint=a,this._isLoading={prev:!1,next:!1};var f=new O;f.attachCollection(this),b.set(this,f),i.broadcast.addCollection(this,f),m.set(this,i.broadcast),k.set(this,i.messageContainer),C.set(this,i.chunkContainer),E.set(this,{}),I.set(this,null),w.set(this,null);var v=new c.default,y=function(e,t,a){d.default.sync("message synchronize() begin",e,t);var o=null,u=0,l=[t];switch(e){case"prev":o="getPreviousMessagesByTimestamp",u=S,l.push(!0),l.push(S);break;case"next":o="getNextMessagesByTimestamp",u=_,l.push(!0),l.push(_);break;case"prevnext":o="getPreviousAndNextMessagesByTimestamp",u=2*M,l.push(M),l.push(M)}l.push(!1),l.push(r.filter.messageType||""),l.push(r.filter.customType||""),l.push(r.filter.senderUserIds||[]),l.push(r.filter.includeMetaArray||!1),n[o].apply(n,l.concat([function(n,o){o?(r._pause(),a(o)):(d.default.sync("message synchronize() end",e,t,n.map(function(e){return e.messageId})),v.lock(function(t){var o=[],l={startAt:1/0,endAt:0};if(n.length>0){var c=function(e){n[e].isVisible=!0,o.push(new Promise(function(t,r){i.messageContainer.upsert(n[e],function(e){return e?r(e):t()})})),l.startAt=Math.min(l.startAt,n[e].createdAt),l.endAt=Math.max(l.endAt,n[e].createdAt)};for(var h in n)c(h);f.currentChunk&&f.currentChunk.isOverlap(l)||(f.currentChunk=new s.MessageChunk(r.channel.url,r.filter),d.default.message("chunk is created",f.currentChunk.startAt,f.currentChunk.endAt)),f.currentChunk.extendWithChunk(l),d.default.message("currentChunk is extended",f.currentChunk.startAt,f.currentChunk.endAt),i.chunkContainer.mergePreviousChunkOverlap(f.currentChunk,function(r){r?(t(),a(r)):(d.default.message("currentChunk merged previous chunks",f.currentChunk.startAt,f.currentChunk.endAt),Promise.all(o).then(function(){t(),a(null,{count:n.length,nextTs:"prev"===e?f.currentChunk.startAt:f.currentChunk.endAt,hasMore:n.length>=u})}).catch(function(e){t(),a(e)}))})}else t(),a(null,{count:0,nextTs:0,hasMore:!1})}))}]))},g=new u.BackgroundSync(function(e,n){return y("prev",e,n)});g.shared++,I.set(this,g);var U=new u.BackgroundSync(function(e,n){return y("next",e,n)});g.shared++,w.set(this,U),i.chunkContainer.getChunkByTimestamp(this.channel.url,this.filter,this.viewpoint,function(e,n){e||(n&&(f.currentChunk=n),f.currentChunk?r._resume():y("prevnext",r.viewpoint,function(e,n){e||setTimeout(function(){g.flush(e,n),U.flush(e,n),n.count<M?(g.end(),U.end()):r._resume()},A)}),d.default.message("message collection "+r.collectionId+" is created."))})}return r(e,[{key:"_pause",value:function(){d.default.call("message sync pause",this.collectionId);var e=b.get(this),n=I.get(this),t=w.get(this);n&&n.pause(),t&&t.pause(),e.currentChunk=null}},{key:"_resume",value:function(){var e=this;d.default.call("message sync resume",this.collectionId),o.default.getInstance().syncChangeLog(this.channel,function(){var n=b.get(e),t=I.get(e),r=w.get(e);if(t){var a=n.currentChunk?n.currentChunk.startAt:e.viewpoint;t.start(a)}if(r){var i=n.currentChunk?n.currentChunk.endAt:e.viewpoint;r.start(i,!0)}})}},{key:"fetch",value:function(e,n){var t=this,r=b.get(this),a=k.get(this),i=C.get(this);return this._isLoading[e]?(0,h.promisify)(function(e){return e(f.default.create(f.default.Type.ERROR_DUPLICATED_FETCH))},n):(this._isLoading[e]=!0,(0,h.promisify)(function(n){d.default.call("fetch()",e);var o=null,s=t.viewpoint,l=t.limit,c=!1,h=s,v=null,p=null;switch(e){case"prev":o=I.get(t),r.viewRange.start>0&&(s=r.viewRange.start),r.currentChunk&&(h=Math.max(r.currentChunk.startAt,s)),v=r.prevTempMessages,p=a.loadPreviousMessages,c=!0;break;case"next":o=w.get(t),r.viewRange.end>0&&(s=r.viewRange.end),r.currentChunk&&(h=Math.min(r.currentChunk.endAt,s)),v=r.nextTempMessages,p=a.loadNextMessages;break;default:return void n(f.default.create(f.default.Type.ERROR_INVALID_PARAMETER))}var g=function(n,a){d.default.message("waiting for synchronization..."),p(t.channel.url,t.filter,n,{limit:l,desc:c},function(n,i){var o;n?(t._isLoading[e]=!1,a(n)):(d.default.cache("temp message",e,i.map(function(e){return e.messageId})),(o=v).push.apply(o,y(i)),r.addViewItems(i),t._isLoading[e]=!1,a(null))});var u=h;d.default.sync("subscribe message",t.collectionId,e,n),o.subscribe(t.collectionId,function(a){a?d.default.error(a):(d.default.sync("flush message",e,n),i.getChunkByTimestamp(t.channel.url,t.filter,n,function(n,a){n||(a&&(r.currentChunk=a),r.currentChunk?p(t.channel.url,t.filter,u,{limit:l,desc:c},function(n,t){if(n)d.default.error(n);else{d.default.cache("flush message",e,u,t.map(function(e){return e.messageId})),r.clearPreviewItem();var a=[],i=[];for(var o in t)if(r.currentChunk.containsMessage(t[o])){var s=r.messages.map(function(e){return e.messageId}).indexOf(t[o].messageId);(s<0||!r.messages[s].isEqual(t[o]))&&a.push(t[o])}for(var l in v)r.messages.map(function(e){return e.messageId}).indexOf(v[l].messageId)<0&&i.push(v[l]);for(;v.length>0;)v.pop();i.length>0&&r.removeViewItems(i.map(function(e){return e.messageId})),a.length>0&&r.addViewItems(a)}}):d.default.error(n))}))})};i.getChunkByTimestamp(t.channel.url,t.filter,s,function(a,i){a?(t._isLoading[e]=!1,n(a)):(i&&(r.currentChunk=i),r.currentChunk?(d.default.message("chunk is selected",r.currentChunk),p(t.channel.url,t.filter,s,{limit:l,desc:c},function(a,i){if(a)t._isLoading[e]=!1,n(a);else{var o=[],u=[];d.default.cache("fetch message",e,s,i.map(function(e){return e.messageId}));var c=!1;for(var f in i)if(r.currentChunk.containsMessage(i[f])){c=!0;var h=r.messages.map(function(e){return e.messageId}).indexOf(i[f].messageId);(h<0||!r.messages[h].isEqual(i[f]))&&o.push(i[f])}if(!c){for(var y in v)r.messages.map(function(e){return e.messageId}).indexOf(v[y].messageId)<0&&u.push(v[y]);for(;v.length>0;)v.pop()}o.length>0&&r.addViewItems(o),u.length>0&&r.removeViewItems(u.map(function(e){return e.me})),i.length<l?(l-=i.length,g(s,n)):(t._isLoading[e]=!1,n(null))}})):g(s,n))}),o.state===u.BackgroundSync.State.PAUSED&&t._resume()},n))}},{key:"resetViewpointTimestamp",value:function(e){d.default.call("resetViewpointTimestamp()",e);var n=b.get(this);n.viewRange.start<=e&&e<=n.viewRange.end?n.currentChunk&&!n.currentChunk.contains(e)&&(n.currentChunk=null):(n.currentChunk=null,n.clearViewItem()),this.viewpoint=e,this._resume()}},{key:"remove",value:function(){var e=b.get(this);m.get(this).removeCollection(this),e.currentChunk=null;var n=I.get(this),t=w.get(this);n&&(n.shared--,0===n.shared&&n.pause()),t&&(t.shared--,0===t.shared&&t.pause())}},{key:"appendMessage",value:function(e){d.default.call("appendMessage()",e.messageId);var n=a.default.getInstance(),t=b.get(this);if(e.sender&&e.sender.userId===n.currentUserId)if(e.messageId){var r=m.get(this),o=k.get(this);e.isVisible=!0,o.upsert(e,function(e,n){e||r.upsert([n])});var u=i.default.getInstance();u.channelContainer.getItem(e.channelUrl,function(n,t){n?f.default.throw(n):t&&(!t.lastMessage||t.lastMessage.createdAt<=e.createdAt)&&(t.lastMessage=e,u.channelContainer.upsert(t,function(e,n){e?f.default.throw(e):u.broadcast.upsert([n])}))})}else t.addViewItems([e],{isEventMessage:!0})}},{key:"updateMessage",value:function(e){d.default.call("updateMessage()",e.messageId);var n=a.default.getInstance(),t=b.get(this);if(e.sender&&e.sender.userId===n.currentUserId)if(e.messageId){var r=m.get(this),o=k.get(this);e.isVisible=!0,o.upsert(e,function(e,n){e||r.update([n])});var u=i.default.getInstance();u.channelContainer.getItem(e.channelUrl,function(n,t){n?f.default.throw(n):t&&t.lastMessage&&t.lastMessage.messageId===e.messageId&&(t.lastMessage=e,u.channelContainer.upsert(t,function(e,n){e?f.default.throw(e):u.broadcast.update([n])}))})}else t.addViewItems([e])}},{key:"deleteMessage",value:function(e){d.default.call("deleteMessage()",e.messageId);var n=a.default.getInstance(),t=b.get(this);e.sender&&e.sender.userId===n.currentUserId&&(e.messageId||t.removeViewItems([e.reqId],!0))}},{key:"setCollectionHandler",value:function(e){var n=E.get(this);e instanceof l.MessageCollectionHandler&&(n["message-collection-handler"]=e)}},{key:"removeCollectionHandler",value:function(){var e=E.get(this);e["message-collection-handler"]&&delete e["message-collection-handler"]}},{key:"messages",get:function(){return b.get(this).messages}}],[{key:"CollectionHandler",get:function(){return l.MessageCollectionHandler}},{key:"Action",get:function(){return l.MessageEventAction}}]),e}()}]).default});